{"file_contents":{"replit.md":{"content":"# Estate Management System\n\n## Overview\nThe Estate Management System is a comprehensive web application for managing residential estates. Its primary purpose is to streamline resident billing and levy collection, implement QR code-based visitor access control, enhance security management, and provide real-time notifications. The system supports three user roles: residents, estate administrators, and security personnel, offering role-specific dashboards and functionalities. The project aims to deliver a robust, scalable solution for modern estate management, improving efficiency, security, and resident satisfaction.\n\n## User Preferences\nPreferred communication style: Simple, everyday language.\n\n## System Architecture\n\n### Frontend\n- **Framework**: React with TypeScript, using Vite.\n- **UI**: Shadcn UI (Radix UI base) with Material Design principles and Tailwind UI patterns.\n- **Styling**: Tailwind CSS with custom design tokens, supporting light/dark themes.\n- **State Management**: TanStack Query for server state.\n- **Routing**: Wouter for client-side routing with role-based protection.\n- **Forms**: React Hook Form with Zod validation.\n\n### Backend\n- **Framework**: Express.js with Node.js and TypeScript.\n- **Authentication**: Replit's OpenID Connect (OIDC) with Passport.js; sessions in PostgreSQL.\n- **API**: RESTful, role-based authorization, organized by user role.\n- **Session Management**: Express-session with PostgreSQL store and secure, HTTP-only cookies.\n- **Business Logic**: Delinquency checking, balance tracking, access code generation, financial reporting.\n- **Request Body Limits**: Configured to 10MB to support large receipt image uploads.\n\n### Data Storage\n- **Database**: PostgreSQL via Neon's serverless driver.\n- **ORM**: Drizzle ORM for type-safe queries.\n- **Schema**: Comprehensive, covering users, residents, bills, payments, visitors, notifications, access logs, announcements, sessions, and a full double-entry accounting system.\n- **Migrations**: Drizzle Kit.\n\n### Authentication & Authorization\n- **Provider**: Replit Auth (OpenID Connect).\n- **User Roles**: Four-tier system (resident, admin, security, accountant) enforced at route and API levels.\n- **Signup Flow**: Self-service resident registration via Replit Auth.\n- **User Invite System**: Token-based invite links for onboarding new users with predefined roles.\n\n### System Features\n- **Account Status Workflow**: Financial analysis tool for administrators with resident filtering by ID.\n- **Accounting System**: Modified cash-based double-entry bookkeeping with configurable Chart of Accounts, Transaction Templates, and Journal Entry system, and financial reports. Tailored for Magodo Residents Association - South East Zone.\n- **Budget & Planning System**: Comprehensive budget planning and tracking with automated consumption tracking.\n- **Automated Service Charge Billing**: Automatically generates bills upon resident registration and via daily scheduled checks.\n- **Invoice Email Delivery System**: Professional email notifications sent automatically when bills are generated, using personalized HTML templates.\n- **Invoice PDF Generation**: Professional PDF invoice generator using pdfkit with Nigerian Naira formatting.\n- **Reports Center**: Comprehensive reporting system for administrators including Operational, Financial, and Accounting categories.\n- **CSV Export**: Comprehensive CSV download functionality across all 13 reports (8 dialog-based reports, 2 backend-generated reports, and 3 accounting statement pages) with proper currency formatting, date formatting, and empty data handling.\n- **Vendor Management System**: Interface for managing approved vendors.\n- **Expense Request Enhancements**: Includes receipt upload functionality and expense classification.\n- **Accounts Payable Workflow**: Manages approved expenses with payment status tracking and WHT management.\n- **Accounts Receivable Workflow**: Manages outstanding resident bills with automatic invoice numbering and payment application.\n\n## External Dependencies\n\n- **Payment Processing**: Stripe (`@stripe/stripe-js`, `@stripe/react-stripe-js`).\n- **Email Delivery**: Resend (`resend`).\n- **QR Code Generation**: `qrcode` npm package.\n- **Database**: Neon serverless PostgreSQL (`@neondatabase/serverless`).\n- **Session Storage**: `connect-pg-simple`.\n- **UI Components**: Radix UI primitives (`@radix-ui/*`).\n- **Fonts**: Google Fonts (Inter family).","size_bytes":4438},"client/src/hooks/use-mobile.tsx":{"content":"import * as React from \"react\"\n\nconst MOBILE_BREAKPOINT = 768\n\nexport function useIsMobile() {\n  const [isMobile, setIsMobile] = React.useState<boolean | undefined>(undefined)\n\n  React.useEffect(() => {\n    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`)\n    const onChange = () => {\n      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    }\n    mql.addEventListener(\"change\", onChange)\n    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    return () => mql.removeEventListener(\"change\", onChange)\n  }, [])\n\n  return !!isMobile\n}\n","size_bytes":565},"client/src/hooks/useAuth.ts":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport type { User } from \"@shared/schema\";\n\nexport function useAuth() {\n  const { data: user, isLoading } = useQuery<User>({\n    queryKey: [\"/api/auth/user\"],\n    retry: false,\n  });\n\n  return {\n    user,\n    isLoading,\n    isAuthenticated: !!user,\n  };\n}\n","size_bytes":307},"client/src/components/qr-code-display.tsx":{"content":"import { useEffect, useRef, useState } from \"react\";\nimport QRCodeLib from \"qrcode\";\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { Download } from \"lucide-react\";\nimport type { Visitor } from \"@shared/schema\";\n\ninterface QRCodeDisplayProps {\n  visitor: Visitor;\n  open: boolean;\n  onClose: () => void;\n}\n\nexport default function QRCodeDisplay({ visitor, open, onClose }: QRCodeDisplayProps) {\n  const canvasRef = useRef<HTMLCanvasElement>(null);\n  const [timeRemaining, setTimeRemaining] = useState(\"\");\n\n  useEffect(() => {\n    if (canvasRef.current && open) {\n      QRCodeLib.toCanvas(\n        canvasRef.current,\n        visitor.accessCode,\n        {\n          width: 300,\n          margin: 2,\n          color: {\n            dark: \"#000000\",\n            light: \"#ffffff\",\n          },\n        },\n        (error) => {\n          if (error) console.error(error);\n        }\n      );\n    }\n  }, [visitor.accessCode, open]);\n\n  useEffect(() => {\n    if (!open) return;\n\n    const updateTimer = () => {\n      const now = new Date();\n      const expiry = new Date(visitor.validUntil);\n      const diff = expiry.getTime() - now.getTime();\n\n      if (diff <= 0) {\n        setTimeRemaining(\"Expired\");\n        return;\n      }\n\n      const days = Math.floor(diff / (1000 * 60 * 60 * 24));\n      const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));\n      const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));\n\n      if (days > 0) {\n        setTimeRemaining(`${days}d ${hours}h remaining`);\n      } else if (hours > 0) {\n        setTimeRemaining(`${hours}h ${minutes}m remaining`);\n      } else {\n        setTimeRemaining(`${minutes}m remaining`);\n      }\n    };\n\n    updateTimer();\n    const interval = setInterval(updateTimer, 60000); // Update every minute\n\n    return () => clearInterval(interval);\n  }, [visitor.validUntil, open]);\n\n  const handleDownload = () => {\n    if (canvasRef.current) {\n      const url = canvasRef.current.toDataURL(\"image/png\");\n      const link = document.createElement(\"a\");\n      link.download = `visitor-${visitor.visitorName.replace(/\\s+/g, \"-\")}.png`;\n      link.href = url;\n      link.click();\n    }\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={onClose}>\n      <DialogContent className=\"sm:max-w-[500px]\">\n        <DialogHeader>\n          <DialogTitle>Visitor Access Code</DialogTitle>\n          <DialogDescription>\n            Show this QR code to security at the gate\n          </DialogDescription>\n        </DialogHeader>\n        <div className=\"space-y-6\">\n          {/* Visitor Details */}\n          <div className=\"p-4 rounded-lg bg-muted\">\n            <div className=\"grid grid-cols-2 gap-3 text-sm\">\n              <div>\n                <p className=\"text-muted-foreground\">Visitor Name</p>\n                <p className=\"font-medium\">{visitor.visitorName}</p>\n              </div>\n              {visitor.visitorPhone && (\n                <div>\n                  <p className=\"text-muted-foreground\">Phone</p>\n                  <p className=\"font-medium\">{visitor.visitorPhone}</p>\n                </div>\n              )}\n              <div>\n                <p className=\"text-muted-foreground\">Valid From</p>\n                <p className=\"font-medium\">{new Date(visitor.validFrom).toLocaleString()}</p>\n              </div>\n              <div>\n                <p className=\"text-muted-foreground\">Valid Until</p>\n                <p className=\"font-medium\">{new Date(visitor.validUntil).toLocaleString()}</p>\n              </div>\n              {visitor.purpose && (\n                <div className=\"col-span-2\">\n                  <p className=\"text-muted-foreground\">Purpose</p>\n                  <p className=\"font-medium\">{visitor.purpose}</p>\n                </div>\n              )}\n            </div>\n          </div>\n\n          {/* QR Code */}\n          <div className=\"flex flex-col items-center space-y-4\">\n            <div className=\"p-4 bg-white rounded-lg\">\n              <canvas ref={canvasRef} data-testid=\"qr-code-canvas\" />\n            </div>\n            <div className=\"text-center\">\n              <p className=\"text-sm font-medium text-muted-foreground\">Access Code</p>\n              <p className=\"text-lg font-mono font-semibold\" data-testid=\"text-access-code\">\n                {visitor.accessCode}\n              </p>\n              <p className=\"text-sm text-muted-foreground mt-1\">{timeRemaining}</p>\n            </div>\n          </div>\n\n          {/* Actions */}\n          <div className=\"flex gap-2\">\n            <Button className=\"flex-1\" variant=\"outline\" onClick={handleDownload} data-testid=\"button-download-qr\">\n              <Download className=\"h-4 w-4 mr-2\" />\n              Download\n            </Button>\n            <Button className=\"flex-1\" onClick={onClose}>\n              Close\n            </Button>\n          </div>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","size_bytes":5012},"client/src/components/ui/sheet.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SheetPrimitive from \"@radix-ui/react-dialog\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Sheet = SheetPrimitive.Root\n\nconst SheetTrigger = SheetPrimitive.Trigger\n\nconst SheetClose = SheetPrimitive.Close\n\nconst SheetPortal = SheetPrimitive.Portal\n\nconst SheetOverlay = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nSheetOverlay.displayName = SheetPrimitive.Overlay.displayName\n\nconst sheetVariants = cva(\n  \"fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500\",\n  {\n    variants: {\n      side: {\n        top: \"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top\",\n        bottom:\n          \"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom\",\n        left: \"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm\",\n        right:\n          \"inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm\",\n      },\n    },\n    defaultVariants: {\n      side: \"right\",\n    },\n  }\n)\n\ninterface SheetContentProps\n  extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,\n    VariantProps<typeof sheetVariants> {}\n\nconst SheetContent = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Content>,\n  SheetContentProps\n>(({ side = \"right\", className, children, ...props }, ref) => (\n  <SheetPortal>\n    <SheetOverlay />\n    <SheetPrimitive.Content\n      ref={ref}\n      className={cn(sheetVariants({ side }), className)}\n      {...props}\n    >\n      {children}\n      <SheetPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </SheetPrimitive.Close>\n    </SheetPrimitive.Content>\n  </SheetPortal>\n))\nSheetContent.displayName = SheetPrimitive.Content.displayName\n\nconst SheetHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetHeader.displayName = \"SheetHeader\"\n\nconst SheetFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetFooter.displayName = \"SheetFooter\"\n\nconst SheetTitle = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold text-foreground\", className)}\n    {...props}\n  />\n))\nSheetTitle.displayName = SheetPrimitive.Title.displayName\n\nconst SheetDescription = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nSheetDescription.displayName = SheetPrimitive.Description.displayName\n\nexport {\n  Sheet,\n  SheetPortal,\n  SheetOverlay,\n  SheetTrigger,\n  SheetClose,\n  SheetContent,\n  SheetHeader,\n  SheetFooter,\n  SheetTitle,\n  SheetDescription,\n}\n","size_bytes":4281},"client/src/pages/admin/announcements.tsx":{"content":"import { useEffect } from \"react\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { FileText, Megaphone } from \"lucide-react\";\n\nexport default function AdminAnnouncements() {\n  const { toast } = useToast();\n  const { isAuthenticated, isLoading, user } = useAuth();\n\n  useEffect(() => {\n    if (!isLoading && (!isAuthenticated || user?.role !== \"admin\")) {\n      toast({\n        title: \"Unauthorized\",\n        description: \"Admin access required\",\n        variant: \"destructive\",\n      });\n      setTimeout(() => {\n        window.location.href = \"/\";\n      }, 500);\n      return;\n    }\n  }, [isAuthenticated, isLoading, user, toast]);\n\n  if (isLoading || !isAuthenticated || user?.role !== \"admin\") {\n    return (\n      <div className=\"flex h-screen items-center justify-center\">\n        <div className=\"animate-spin w-8 h-8 border-4 border-primary border-t-transparent rounded-full\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <div>\n        <h1 className=\"text-3xl font-semibold\">Announcements</h1>\n        <p className=\"text-muted-foreground mt-1\">Communicate with all residents</p>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Megaphone className=\"h-6 w-6\" />\n            Estate Announcements\n          </CardTitle>\n          <CardDescription>Send important updates to all residents</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"text-center py-12\">\n            <FileText className=\"h-16 w-16 mx-auto mb-4 text-muted-foreground opacity-50\" />\n            <p className=\"text-lg font-medium mb-2\">Announcement System</p>\n            <p className=\"text-muted-foreground mb-6\">\n              Broadcast messages, maintenance notices, and important updates\n            </p>\n            <Button disabled data-testid=\"button-create-announcement\">\n              Coming Soon\n            </Button>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":2205},"client/src/components/ui/toggle.tsx":{"content":"import * as React from \"react\"\nimport * as TogglePrimitive from \"@radix-ui/react-toggle\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst toggleVariants = cva(\n  \"inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 gap-2\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-transparent\",\n        outline:\n          \"border border-input bg-transparent hover:bg-accent hover:text-accent-foreground\",\n      },\n      size: {\n        default: \"h-10 px-3 min-w-10\",\n        sm: \"h-9 px-2.5 min-w-9\",\n        lg: \"h-11 px-5 min-w-11\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nconst Toggle = React.forwardRef<\n  React.ElementRef<typeof TogglePrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof TogglePrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, ...props }, ref) => (\n  <TogglePrimitive.Root\n    ref={ref}\n    className={cn(toggleVariants({ variant, size, className }))}\n    {...props}\n  />\n))\n\nToggle.displayName = TogglePrimitive.Root.displayName\n\nexport { Toggle, toggleVariants }\n","size_bytes":1527},"client/src/pages/notifications.tsx":{"content":"import { useEffect } from \"react\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Bell, Receipt, DollarSign, FileText, QrCode, Check } from \"lucide-react\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { isUnauthorizedError } from \"@/lib/authUtils\";\nimport type { Notification } from \"@shared/schema\";\n\nexport default function Notifications() {\n  const { toast } = useToast();\n  const { isAuthenticated, isLoading } = useAuth();\n\n  useEffect(() => {\n    if (!isLoading && !isAuthenticated) {\n      toast({\n        title: \"Unauthorized\",\n        description: \"You are logged out. Logging in again...\",\n        variant: \"destructive\",\n      });\n      setTimeout(() => {\n        window.location.href = \"/api/login\";\n      }, 500);\n      return;\n    }\n  }, [isAuthenticated, isLoading, toast]);\n\n  const { data: notifications = [] } = useQuery<Notification[]>({\n    queryKey: [\"/api/notifications\"],\n    enabled: isAuthenticated,\n  });\n\n  const markAsReadMutation = useMutation({\n    mutationFn: async (id: string) => {\n      await apiRequest(\"PATCH\", `/api/notifications/${id}/read`, {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/notifications\"] });\n    },\n    onError: (error: Error) => {\n      if (isUnauthorizedError(error)) {\n        toast({\n          title: \"Unauthorized\",\n          description: \"You are logged out. Logging in again...\",\n          variant: \"destructive\",\n        });\n        setTimeout(() => {\n          window.location.href = \"/api/login\";\n        }, 500);\n        return;\n      }\n      toast({\n        title: \"Error\",\n        description: \"Failed to mark notification as read\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const markAllAsReadMutation = useMutation({\n    mutationFn: async () => {\n      await apiRequest(\"PATCH\", \"/api/notifications/read-all\", {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/notifications\"] });\n      toast({\n        title: \"Success\",\n        description: \"All notifications marked as read\",\n      });\n    },\n    onError: (error: Error) => {\n      if (isUnauthorizedError(error)) {\n        toast({\n          title: \"Unauthorized\",\n          description: \"You are logged out. Logging in again...\",\n          variant: \"destructive\",\n        });\n        setTimeout(() => {\n          window.location.href = \"/api/login\";\n        }, 500);\n        return;\n      }\n      toast({\n        title: \"Error\",\n        description: \"Failed to mark all as read\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  if (isLoading || !isAuthenticated) {\n    return (\n      <div className=\"flex h-screen items-center justify-center\">\n        <div className=\"animate-spin w-8 h-8 border-4 border-primary border-t-transparent rounded-full\" />\n      </div>\n    );\n  }\n\n  const getNotificationIcon = (type: string) => {\n    const icons = {\n      bill: Receipt,\n      payment: DollarSign,\n      announcement: FileText,\n      visitor: QrCode,\n      system: Bell,\n    };\n    return icons[type as keyof typeof icons] || Bell;\n  };\n\n  const unreadCount = notifications.filter(n => !n.isRead).length;\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-semibold\">Notifications</h1>\n          <p className=\"text-muted-foreground mt-1\">\n            {unreadCount > 0 ? `${unreadCount} unread message${unreadCount !== 1 ? 's' : ''}` : \"All caught up!\"}\n          </p>\n        </div>\n        {unreadCount > 0 && (\n          <Button\n            onClick={() => markAllAsReadMutation.mutate()}\n            disabled={markAllAsReadMutation.isPending}\n            data-testid=\"button-mark-all-read\"\n          >\n            <Check className=\"h-4 w-4 mr-2\" />\n            Mark All Read\n          </Button>\n        )}\n      </div>\n\n      {/* Notifications List */}\n      <Card>\n        <CardHeader>\n          <CardTitle>All Notifications</CardTitle>\n        </CardHeader>\n        <CardContent>\n          {notifications.length === 0 ? (\n            <div className=\"text-center py-12 text-muted-foreground\">\n              <Bell className=\"h-16 w-16 mx-auto mb-4 opacity-50\" />\n              <p className=\"text-lg\">No notifications</p>\n              <p className=\"text-sm mt-1\">You're all caught up!</p>\n            </div>\n          ) : (\n            <div className=\"space-y-2\">\n              {notifications.map((notification) => {\n                const Icon = getNotificationIcon(notification.type);\n                return (\n                  <div\n                    key={notification.id}\n                    className={`flex items-start gap-4 p-4 rounded-lg border transition-colors ${\n                      !notification.isRead \n                        ? \"bg-accent/30 border-accent\" \n                        : \"hover-elevate\"\n                    }`}\n                    data-testid={`notification-${notification.id}`}\n                  >\n                    <div className={`p-2 rounded-lg ${\n                      !notification.isRead ? \"bg-primary/10\" : \"bg-muted\"\n                    }`}>\n                      <Icon className={`h-5 w-5 ${\n                        !notification.isRead ? \"text-primary\" : \"text-muted-foreground\"\n                      }`} />\n                    </div>\n                    <div className=\"flex-1 min-w-0\">\n                      <div className=\"flex items-start justify-between gap-2\">\n                        <div className=\"flex-1\">\n                          <h4 className=\"font-medium mb-1\">{notification.title}</h4>\n                          <p className=\"text-sm text-muted-foreground\">{notification.message}</p>\n                          <p className=\"text-xs text-muted-foreground mt-2\">\n                            {new Date(notification.createdAt!).toLocaleString()}\n                          </p>\n                        </div>\n                        <div className=\"flex items-center gap-2\">\n                          {!notification.isRead && (\n                            <>\n                              <Badge variant=\"secondary\" className=\"bg-primary/20\">New</Badge>\n                              <Button\n                                size=\"sm\"\n                                variant=\"ghost\"\n                                onClick={() => markAsReadMutation.mutate(notification.id)}\n                                disabled={markAsReadMutation.isPending}\n                                data-testid={`button-mark-read-${notification.id}`}\n                              >\n                                <Check className=\"h-4 w-4\" />\n                              </Button>\n                            </>\n                          )}\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n                );\n              })}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":7279},"client/src/components/ui/breadcrumb.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Breadcrumb = React.forwardRef<\n  HTMLElement,\n  React.ComponentPropsWithoutRef<\"nav\"> & {\n    separator?: React.ReactNode\n  }\n>(({ ...props }, ref) => <nav ref={ref} aria-label=\"breadcrumb\" {...props} />)\nBreadcrumb.displayName = \"Breadcrumb\"\n\nconst BreadcrumbList = React.forwardRef<\n  HTMLOListElement,\n  React.ComponentPropsWithoutRef<\"ol\">\n>(({ className, ...props }, ref) => (\n  <ol\n    ref={ref}\n    className={cn(\n      \"flex flex-wrap items-center gap-1.5 break-words text-sm text-muted-foreground sm:gap-2.5\",\n      className\n    )}\n    {...props}\n  />\n))\nBreadcrumbList.displayName = \"BreadcrumbList\"\n\nconst BreadcrumbItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentPropsWithoutRef<\"li\">\n>(({ className, ...props }, ref) => (\n  <li\n    ref={ref}\n    className={cn(\"inline-flex items-center gap-1.5\", className)}\n    {...props}\n  />\n))\nBreadcrumbItem.displayName = \"BreadcrumbItem\"\n\nconst BreadcrumbLink = React.forwardRef<\n  HTMLAnchorElement,\n  React.ComponentPropsWithoutRef<\"a\"> & {\n    asChild?: boolean\n  }\n>(({ asChild, className, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      ref={ref}\n      className={cn(\"transition-colors hover:text-foreground\", className)}\n      {...props}\n    />\n  )\n})\nBreadcrumbLink.displayName = \"BreadcrumbLink\"\n\nconst BreadcrumbPage = React.forwardRef<\n  HTMLSpanElement,\n  React.ComponentPropsWithoutRef<\"span\">\n>(({ className, ...props }, ref) => (\n  <span\n    ref={ref}\n    role=\"link\"\n    aria-disabled=\"true\"\n    aria-current=\"page\"\n    className={cn(\"font-normal text-foreground\", className)}\n    {...props}\n  />\n))\nBreadcrumbPage.displayName = \"BreadcrumbPage\"\n\nconst BreadcrumbSeparator = ({\n  children,\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) => (\n  <li\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"[&>svg]:w-3.5 [&>svg]:h-3.5\", className)}\n    {...props}\n  >\n    {children ?? <ChevronRight />}\n  </li>\n)\nBreadcrumbSeparator.displayName = \"BreadcrumbSeparator\"\n\nconst BreadcrumbEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More</span>\n  </span>\n)\nBreadcrumbEllipsis.displayName = \"BreadcrumbElipssis\"\n\nexport {\n  Breadcrumb,\n  BreadcrumbList,\n  BreadcrumbItem,\n  BreadcrumbLink,\n  BreadcrumbPage,\n  BreadcrumbSeparator,\n  BreadcrumbEllipsis,\n}\n","size_bytes":2712},"client/src/components/ui/tabs.tsx":{"content":"import * as React from \"react\"\nimport * as TabsPrimitive from \"@radix-ui/react-tabs\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Tabs = TabsPrimitive.Root\n\nconst TabsList = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.List\n    ref={ref}\n    className={cn(\n      \"inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsList.displayName = TabsPrimitive.List.displayName\n\nconst TabsTrigger = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsTrigger.displayName = TabsPrimitive.Trigger.displayName\n\nconst TabsContent = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsContent.displayName = TabsPrimitive.Content.displayName\n\nexport { Tabs, TabsList, TabsTrigger, TabsContent }\n","size_bytes":1883},"client/src/components/ui/tooltip.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as TooltipPrimitive from \"@radix-ui/react-tooltip\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst TooltipProvider = TooltipPrimitive.Provider\n\nconst Tooltip = TooltipPrimitive.Root\n\nconst TooltipTrigger = TooltipPrimitive.Trigger\n\nconst TooltipContent = React.forwardRef<\n  React.ElementRef<typeof TooltipPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <TooltipPrimitive.Content\n    ref={ref}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-tooltip-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nTooltipContent.displayName = TooltipPrimitive.Content.displayName\n\nexport { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }\n","size_bytes":1209},"client/src/components/ui/switch.tsx":{"content":"import * as React from \"react\"\nimport * as SwitchPrimitives from \"@radix-ui/react-switch\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Switch = React.forwardRef<\n  React.ElementRef<typeof SwitchPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>\n>(({ className, ...props }, ref) => (\n  <SwitchPrimitives.Root\n    className={cn(\n      \"peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  >\n    <SwitchPrimitives.Thumb\n      className={cn(\n        \"pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0\"\n      )}\n    />\n  </SwitchPrimitives.Root>\n))\nSwitch.displayName = SwitchPrimitives.Root.displayName\n\nexport { Switch }\n","size_bytes":1139},"client/src/components/ui/calendar.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight } from \"lucide-react\"\nimport { DayPicker } from \"react-day-picker\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nexport type CalendarProps = React.ComponentProps<typeof DayPicker>\n\nfunction Calendar({\n  className,\n  classNames,\n  showOutsideDays = true,\n  ...props\n}: CalendarProps) {\n  return (\n    <DayPicker\n      showOutsideDays={showOutsideDays}\n      className={cn(\"p-3\", className)}\n      classNames={{\n        months: \"flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0\",\n        month: \"space-y-4\",\n        caption: \"flex justify-center pt-1 relative items-center\",\n        caption_label: \"text-sm font-medium\",\n        nav: \"space-x-1 flex items-center\",\n        nav_button: cn(\n          buttonVariants({ variant: \"outline\" }),\n          \"h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100\"\n        ),\n        nav_button_previous: \"absolute left-1\",\n        nav_button_next: \"absolute right-1\",\n        table: \"w-full border-collapse space-y-1\",\n        head_row: \"flex\",\n        head_cell:\n          \"text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]\",\n        row: \"flex w-full mt-2\",\n        cell: \"h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20\",\n        day: cn(\n          buttonVariants({ variant: \"ghost\" }),\n          \"h-9 w-9 p-0 font-normal aria-selected:opacity-100\"\n        ),\n        day_range_end: \"day-range-end\",\n        day_selected:\n          \"bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground\",\n        day_today: \"bg-accent text-accent-foreground\",\n        day_outside:\n          \"day-outside text-muted-foreground aria-selected:bg-accent/50 aria-selected:text-muted-foreground\",\n        day_disabled: \"text-muted-foreground opacity-50\",\n        day_range_middle:\n          \"aria-selected:bg-accent aria-selected:text-accent-foreground\",\n        day_hidden: \"invisible\",\n        ...classNames,\n      }}\n      components={{\n        IconLeft: ({ className, ...props }) => (\n          <ChevronLeft className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n        IconRight: ({ className, ...props }) => (\n          <ChevronRight className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n      }}\n      {...props}\n    />\n  )\n}\nCalendar.displayName = \"Calendar\"\n\nexport { Calendar }\n","size_bytes":2695},"client/src/lib/queryClient.ts":{"content":"import { QueryClient, QueryFunction } from \"@tanstack/react-query\";\n\nasync function throwIfResNotOk(res: Response) {\n  if (!res.ok) {\n    const text = (await res.text()) || res.statusText;\n    throw new Error(`${res.status}: ${text}`);\n  }\n}\n\nexport async function apiRequest(\n  method: string,\n  url: string,\n  data?: unknown | undefined,\n): Promise<Response> {\n  const res = await fetch(url, {\n    method,\n    headers: data ? { \"Content-Type\": \"application/json\" } : {},\n    body: data ? JSON.stringify(data) : undefined,\n    credentials: \"include\",\n  });\n\n  await throwIfResNotOk(res);\n  return res;\n}\n\nfunction buildRequestUrl(queryKey: readonly unknown[]): string {\n  // Handle legacy single-string keys (e.g., ['/api/resource'] or ['/api/resource?param=value'])\n  if (queryKey.length === 1 && typeof queryKey[0] === 'string') {\n    return queryKey[0];\n  }\n\n  // Fallback to legacy join(\"/\") behavior if all segments are strings with no objects\n  const hasObject = queryKey.some(seg => typeof seg === 'object' && seg !== null);\n  if (!hasObject && queryKey.every(seg => typeof seg === 'string' || typeof seg === 'number' || typeof seg === 'boolean')) {\n    return queryKey.join(\"/\") as string;\n  }\n\n  // Collect segments for the path\n  const pathSegments: string[] = [];\n  let params: Record<string, any> | null = null;\n\n  for (let i = 0; i < queryKey.length; i++) {\n    const segment = queryKey[i];\n    \n    if (typeof segment === 'object' && segment !== null) {\n      // Only the last segment can be an object (for query parameters)\n      if (i === queryKey.length - 1) {\n        params = segment as Record<string, any>;\n      } else {\n        throw new Error(\n          `Query key objects must be the final segment. Found object at index ${i} in query key of length ${queryKey.length}`\n        );\n      }\n    } else if (segment !== null && segment !== undefined) {\n      // For the first segment, keep it verbatim if it starts with '/'\n      if (i === 0 && typeof segment === 'string' && segment.startsWith('/')) {\n        pathSegments.push(segment);\n      } else {\n        // For other segments, trim leading slashes and percent-encode\n        const stringSegment = String(segment).replace(/^\\/+/, '');\n        if (stringSegment) {\n          pathSegments.push(encodeURIComponent(stringSegment));\n        }\n      }\n    }\n  }\n\n  // Join path segments\n  let url = pathSegments.join('/');\n  // Add leading slash if not present\n  if (!url.startsWith('/')) {\n    url = '/' + url;\n  }\n\n  // Append query parameters if present\n  if (params) {\n    const searchParams = new URLSearchParams();\n    // Flatten and coerce all values to strings\n    Object.entries(params).forEach(([key, value]) => {\n      if (value !== null && value !== undefined) {\n        // Convert all values to strings (dates become ISO strings, primitives to String())\n        searchParams.append(key, String(value));\n      }\n    });\n    const queryString = searchParams.toString();\n    if (queryString) {\n      url += '?' + queryString;\n    }\n  }\n\n  return url;\n}\n\ntype UnauthorizedBehavior = \"returnNull\" | \"throw\";\nexport const getQueryFn: <T>(options: {\n  on401: UnauthorizedBehavior;\n}) => QueryFunction<T> =\n  ({ on401: unauthorizedBehavior }) =>\n  async ({ queryKey }) => {\n    const url = buildRequestUrl(queryKey);\n    const res = await fetch(url, {\n      credentials: \"include\",\n    });\n\n    if (unauthorizedBehavior === \"returnNull\" && res.status === 401) {\n      return null;\n    }\n\n    await throwIfResNotOk(res);\n    return await res.json();\n  };\n\nexport const queryClient = new QueryClient({\n  defaultOptions: {\n    queries: {\n      queryFn: getQueryFn({ on401: \"throw\" }),\n      refetchInterval: false,\n      refetchOnWindowFocus: false,\n      staleTime: Infinity,\n      retry: false,\n    },\n    mutations: {\n      retry: false,\n    },\n  },\n});\n","size_bytes":3830},"client/src/pages/home.tsx":{"content":"import { useEffect } from \"react\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\nimport { Receipt, QrCode, Bell, AlertCircle, CheckCircle, Clock, Plus, ShoppingCart, ExternalLink } from \"lucide-react\";\nimport { Link } from \"wouter\";\nimport { formatNaira } from \"@/lib/currency\";\nimport type { Resident, Bill, Visitor, Notification } from \"@shared/schema\";\nimport yoduLogo from \"@assets/yodu-logo.jpg\";\n\nexport default function Home() {\n  const { toast } = useToast();\n  const { isAuthenticated, isLoading, user } = useAuth();\n\n  useEffect(() => {\n    if (!isLoading && !isAuthenticated) {\n      toast({\n        title: \"Unauthorized\",\n        description: \"You are logged out. Logging in again...\",\n        variant: \"destructive\",\n      });\n      setTimeout(() => {\n        window.location.href = \"/api/login\";\n      }, 500);\n      return;\n    }\n  }, [isAuthenticated, isLoading, toast]);\n\n  const { data: resident } = useQuery<Resident>({\n    queryKey: [\"/api/resident/profile\"],\n    enabled: isAuthenticated,\n  });\n\n  const { data: recentBills = [] } = useQuery<Bill[]>({\n    queryKey: [\"/api/resident/bills/recent\"],\n    enabled: isAuthenticated,\n  });\n\n  const { data: activeVisitors = [] } = useQuery<Visitor[]>({\n    queryKey: [\"/api/resident/visitors/active\"],\n    enabled: isAuthenticated,\n  });\n\n  const { data: notifications = [] } = useQuery<Notification[]>({\n    queryKey: [\"/api/notifications\"],\n    enabled: isAuthenticated,\n  });\n\n  if (isLoading || !isAuthenticated) {\n    return (\n      <div className=\"flex h-screen items-center justify-center\">\n        <div className=\"animate-spin w-8 h-8 border-4 border-primary border-t-transparent rounded-full\" />\n      </div>\n    );\n  }\n\n  const getStatusBadge = (status: string) => {\n    const variants = {\n      active: { variant: \"default\" as const, icon: CheckCircle, className: \"bg-green-500 hover:bg-green-600\" },\n      inactive: { variant: \"secondary\" as const, icon: Clock, className: \"\" },\n      delinquent: { variant: \"destructive\" as const, icon: AlertCircle, className: \"\" },\n    };\n    const config = variants[status as keyof typeof variants] || variants.active;\n    const Icon = config.icon;\n    \n    return (\n      <Badge variant={config.variant} className={config.className}>\n        <Icon className=\"h-3 w-3 mr-1\" />\n        {status}\n      </Badge>\n    );\n  };\n\n  const getPaymentStatusBadge = (status: string) => {\n    const variants = {\n      paid: { variant: \"default\" as const, icon: CheckCircle, className: \"bg-green-500 hover:bg-green-600\" },\n      pending: { variant: \"secondary\" as const, icon: Clock, className: \"bg-yellow-500 hover:bg-yellow-600\" },\n      overdue: { variant: \"destructive\" as const, icon: AlertCircle, className: \"\" },\n    };\n    const config = variants[status as keyof typeof variants] || variants.pending;\n    const Icon = config.icon;\n    \n    return (\n      <Badge variant={config.variant} className={config.className}>\n        <Icon className=\"h-3 w-3 mr-1\" />\n        {status}\n      </Badge>\n    );\n  };\n\n  const unreadCount = notifications.filter(n => !n.isRead).length;\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Welcome Card */}\n      <Card>\n        <CardHeader>\n          <div className=\"flex items-center justify-between flex-wrap gap-4\">\n            <div className=\"flex items-center gap-4\">\n              <Avatar className=\"h-16 w-16\">\n                <AvatarImage src={user?.profileImageUrl || undefined} />\n                <AvatarFallback className=\"bg-primary text-primary-foreground text-lg\">\n                  {user?.firstName?.[0]}{user?.lastName?.[0]}\n                </AvatarFallback>\n              </Avatar>\n              <div>\n                <CardTitle className=\"text-2xl\">\n                  Welcome back, {user?.firstName}!\n                </CardTitle>\n                <CardDescription className=\"flex items-center gap-2 mt-1\">\n                  <span data-testid=\"text-unit-number\">Unit {resident?.unitNumber || \"—\"}</span>\n                  <span>•</span>\n                  {resident && getStatusBadge(resident.accountStatus)}\n                </CardDescription>\n              </div>\n            </div>\n            {resident && parseFloat(resident.totalBalance) > 0 && (\n              <div className=\"text-right\">\n                <p className=\"text-sm text-muted-foreground\">Outstanding Balance</p>\n                <p className=\"text-3xl font-semibold text-destructive\" data-testid=\"text-balance\">\n                  {formatNaira(resident.totalBalance)}\n                </p>\n                <Button className=\"mt-2\" data-testid=\"button-pay-now\">\n                  <Receipt className=\"h-4 w-4 mr-2\" />\n                  Pay Now\n                </Button>\n              </div>\n            )}\n          </div>\n        </CardHeader>\n      </Card>\n\n      {/* Quick Stats */}\n      <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Recent Bills</CardTitle>\n            <Receipt className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-semibold\" data-testid=\"text-bills-count\">{recentBills.length}</div>\n            <p className=\"text-xs text-muted-foreground\">Last 30 days</p>\n            <Link href=\"/bills\">\n              <Button variant=\"link\" className=\"px-0 mt-2\" data-testid=\"link-view-all-bills\">\n                View all bills →\n              </Button>\n            </Link>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Active Visitors</CardTitle>\n            <QrCode className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-semibold\" data-testid=\"text-visitors-count\">{activeVisitors.length}</div>\n            <p className=\"text-xs text-muted-foreground\">Pre-approved access</p>\n            <Link href=\"/visitors\">\n              <Button variant=\"link\" className=\"px-0 mt-2\" data-testid=\"link-manage-visitors\">\n                Manage visitors →\n              </Button>\n            </Link>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Notifications</CardTitle>\n            <Bell className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-semibold\" data-testid=\"text-notifications-count\">{unreadCount}</div>\n            <p className=\"text-xs text-muted-foreground\">Unread messages</p>\n            <Link href=\"/notifications\">\n              <Button variant=\"link\" className=\"px-0 mt-2\" data-testid=\"link-view-notifications\">\n                View notifications →\n              </Button>\n            </Link>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Yodu Shopping App Placeholder */}\n      <Card className=\"overflow-hidden bg-gradient-to-r from-orange-50 to-red-50 dark:from-orange-950/20 dark:to-red-950/20 border-orange-200 dark:border-orange-800\" data-testid=\"card-yodu-shopping\">\n        <CardContent className=\"p-0\">\n          <div className=\"flex items-center gap-6 p-6\">\n            <div className=\"flex-shrink-0\">\n              <img \n                src={yoduLogo} \n                alt=\"Yodu Shopping\" \n                className=\"h-24 w-24 rounded-lg object-cover shadow-md\"\n                data-testid=\"img-yodu-logo\"\n              />\n            </div>\n            <div className=\"flex-1\">\n              <div className=\"flex items-center gap-2 mb-2\">\n                <ShoppingCart className=\"h-5 w-5 text-orange-600 dark:text-orange-400\" />\n                <h3 className=\"text-xl font-bold text-orange-900 dark:text-orange-100\" data-testid=\"text-yodu-title\">\n                  Yodu Shopping\n                </h3>\n              </div>\n              <p className=\"text-base text-gray-700 dark:text-gray-300 mb-4\">\n                Buy your Grocery & Home supplies at unbeatable prices!\n              </p>\n              <Button \n                className=\"bg-orange-600 hover:bg-orange-700 text-white\"\n                onClick={() => {\n                  // TODO: Integrate with Yodu API\n                  // For now, show a placeholder message\n                  toast({\n                    title: \"Coming Soon!\",\n                    description: \"Yodu shopping integration will be available soon. Stay tuned!\",\n                  });\n                }}\n                data-testid=\"button-yodu-shop\"\n              >\n                <ShoppingCart className=\"h-4 w-4 mr-2\" />\n                Click here to start!\n                <ExternalLink className=\"h-4 w-4 ml-2\" />\n              </Button>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Recent Bills */}\n      <Card>\n        <CardHeader>\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <CardTitle>Recent Bills</CardTitle>\n              <CardDescription>Your latest levy statements</CardDescription>\n            </div>\n            <Link href=\"/visitors\">\n              <Button data-testid=\"button-add-visitor\">\n                <Plus className=\"h-4 w-4 mr-2\" />\n                Pre-approve Visitor\n              </Button>\n            </Link>\n          </div>\n        </CardHeader>\n        <CardContent>\n          {recentBills.length === 0 ? (\n            <div className=\"text-center py-8 text-muted-foreground\">\n              <Receipt className=\"h-12 w-12 mx-auto mb-3 opacity-50\" />\n              <p>No recent bills</p>\n            </div>\n          ) : (\n            <div className=\"space-y-4\">\n              {recentBills.slice(0, 5).map((bill) => (\n                <div\n                  key={bill.id}\n                  className=\"flex items-center justify-between p-4 rounded-lg border hover-elevate\"\n                  data-testid={`bill-${bill.id}`}\n                >\n                  <div className=\"flex-1\">\n                    <h4 className=\"font-medium\">{bill.description}</h4>\n                    <p className=\"text-sm text-muted-foreground\">\n                      Due {new Date(bill.dueDate).toLocaleDateString()}\n                    </p>\n                  </div>\n                  <div className=\"flex items-center gap-4\">\n                    <div className=\"text-right\">\n                      <p className=\"text-lg font-semibold\">{formatNaira(bill.amount)}</p>\n                      {getPaymentStatusBadge(bill.status)}\n                    </div>\n                    {bill.status !== \"paid\" && (\n                      <Button size=\"sm\" data-testid={`button-pay-${bill.id}`}>\n                        Pay\n                      </Button>\n                    )}\n                  </div>\n                </div>\n              ))}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":11513},"tailwind.config.ts":{"content":"import type { Config } from \"tailwindcss\";\n\nexport default {\n  darkMode: [\"class\"],\n  content: [\"./client/index.html\", \"./client/src/**/*.{js,jsx,ts,tsx}\"],\n  theme: {\n    extend: {\n      borderRadius: {\n        lg: \".5625rem\", /* 9px */\n        md: \".375rem\", /* 6px */\n        sm: \".1875rem\", /* 3px */\n      },\n      colors: {\n        // Flat / base colors (regular buttons)\n        background: \"hsl(var(--background) / <alpha-value>)\",\n        foreground: \"hsl(var(--foreground) / <alpha-value>)\",\n        border: \"hsl(var(--border) / <alpha-value>)\",\n        input: \"hsl(var(--input) / <alpha-value>)\",\n        card: {\n          DEFAULT: \"hsl(var(--card) / <alpha-value>)\",\n          foreground: \"hsl(var(--card-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--card-border) / <alpha-value>)\",\n        },\n        popover: {\n          DEFAULT: \"hsl(var(--popover) / <alpha-value>)\",\n          foreground: \"hsl(var(--popover-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--popover-border) / <alpha-value>)\",\n        },\n        primary: {\n          DEFAULT: \"hsl(var(--primary) / <alpha-value>)\",\n          foreground: \"hsl(var(--primary-foreground) / <alpha-value>)\",\n          border: \"var(--primary-border)\",\n        },\n        secondary: {\n          DEFAULT: \"hsl(var(--secondary) / <alpha-value>)\",\n          foreground: \"hsl(var(--secondary-foreground) / <alpha-value>)\",\n          border: \"var(--secondary-border)\",\n        },\n        muted: {\n          DEFAULT: \"hsl(var(--muted) / <alpha-value>)\",\n          foreground: \"hsl(var(--muted-foreground) / <alpha-value>)\",\n          border: \"var(--muted-border)\",\n        },\n        accent: {\n          DEFAULT: \"hsl(var(--accent) / <alpha-value>)\",\n          foreground: \"hsl(var(--accent-foreground) / <alpha-value>)\",\n          border: \"var(--accent-border)\",\n        },\n        destructive: {\n          DEFAULT: \"hsl(var(--destructive) / <alpha-value>)\",\n          foreground: \"hsl(var(--destructive-foreground) / <alpha-value>)\",\n          border: \"var(--destructive-border)\",\n        },\n        ring: \"hsl(var(--ring) / <alpha-value>)\",\n        chart: {\n          \"1\": \"hsl(var(--chart-1) / <alpha-value>)\",\n          \"2\": \"hsl(var(--chart-2) / <alpha-value>)\",\n          \"3\": \"hsl(var(--chart-3) / <alpha-value>)\",\n          \"4\": \"hsl(var(--chart-4) / <alpha-value>)\",\n          \"5\": \"hsl(var(--chart-5) / <alpha-value>)\",\n        },\n        sidebar: {\n          ring: \"hsl(var(--sidebar-ring) / <alpha-value>)\",\n          DEFAULT: \"hsl(var(--sidebar) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--sidebar-border) / <alpha-value>)\",\n        },\n        \"sidebar-primary\": {\n          DEFAULT: \"hsl(var(--sidebar-primary) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-primary-foreground) / <alpha-value>)\",\n          border: \"var(--sidebar-primary-border)\",\n        },\n        \"sidebar-accent\": {\n          DEFAULT: \"hsl(var(--sidebar-accent) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-accent-foreground) / <alpha-value>)\",\n          border: \"var(--sidebar-accent-border)\"\n        },\n        status: {\n          online: \"rgb(34 197 94)\",\n          away: \"rgb(245 158 11)\",\n          busy: \"rgb(239 68 68)\",\n          offline: \"rgb(156 163 175)\",\n        },\n      },\n      fontFamily: {\n        sans: [\"Inter\", \"system-ui\", \"sans-serif\"],\n        serif: [\"var(--font-serif)\"],\n        mono: [\"var(--font-mono)\"],\n      },\n      keyframes: {\n        \"accordion-down\": {\n          from: { height: \"0\" },\n          to: { height: \"var(--radix-accordion-content-height)\" },\n        },\n        \"accordion-up\": {\n          from: { height: \"var(--radix-accordion-content-height)\" },\n          to: { height: \"0\" },\n        },\n      },\n      animation: {\n        \"accordion-down\": \"accordion-down 0.2s ease-out\",\n        \"accordion-up\": \"accordion-up 0.2s ease-out\",\n      },\n    },\n  },\n  plugins: [require(\"tailwindcss-animate\"), require(\"@tailwindcss/typography\")],\n} satisfies Config;\n","size_bytes":4066},"client/src/pages/landing.tsx":{"content":"import { Building2, Shield, Receipt, QrCode, CheckCircle, TrendingUp } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport estateImage from \"@assets/Real-Estate-2_1763014188361.jpg\";\n\nexport default function Landing() {\n  return (\n    <div className=\"min-h-screen bg-white\">\n      {/* Header */}\n      <header className=\"border-b bg-white\">\n        <div className=\"container mx-auto px-6 md:px-12\">\n          <div className=\"flex h-16 items-center justify-between\">\n            <div className=\"flex items-center gap-3\">\n              <div className=\"flex h-10 w-10 items-center justify-center rounded-lg bg-primary\">\n                <Building2 className=\"h-6 w-6 text-primary-foreground\" />\n              </div>\n              <span className=\"text-xl font-semibold text-gray-900\">Magodo Estate Management System</span>\n            </div>\n            <Button asChild data-testid=\"button-login\" className=\"min-h-9\">\n              <a href=\"/api/login\">Sign In</a>\n            </Button>\n          </div>\n        </div>\n      </header>\n\n      {/* Hero Section - Split Layout */}\n      <div className=\"container mx-auto px-6 md:px-12\">\n        <div className=\"grid lg:grid-cols-5 gap-12 lg:gap-16 items-center py-12 lg:py-20 min-h-[calc(100vh-4rem)]\">\n          {/* Left Side - Content (40%) */}\n          <div className=\"space-y-8 lg:col-span-2\">\n            {/* Badge */}\n            <Badge className=\"bg-green-500 hover:bg-green-600 text-white\">\n              <Shield className=\"h-3 w-3 mr-1\" />\n              Secure & Compliant\n            </Badge>\n\n            {/* Headline */}\n            <h1 className=\"text-4xl md:text-5xl lg:text-6xl font-bold text-gray-900 leading-tight\">\n              Comprehensive{\" \"}\n              <span className=\"text-green-600\">Estate Management</span>{\" \"}\n              Platform\n            </h1>\n\n            {/* Description */}\n            <p className=\"text-lg text-gray-600 leading-relaxed max-w-xl\">\n              Streamline resident billing, visitor access control, and security operations for your gated estate. \n              Automated compliance, real-time notifications, and comprehensive reporting—all in one platform.\n            </p>\n            \n            {/* Signup Info */}\n            <div className=\"bg-green-50 border border-green-200 rounded-lg p-4 max-w-xl\">\n              <p className=\"text-sm text-gray-700\">\n                <span className=\"font-semibold text-green-700\">New residents:</span> Click \"Get Started\" to create your account. \n                You'll be guided through a quick signup to access your unit's billing, visitor management, and more.\n              </p>\n            </div>\n\n            {/* Role Selection Cards */}\n            <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4 max-w-2xl\">\n              <Card className=\"hover-elevate border-2 border-primary/20 bg-white cursor-pointer transition-all hover:border-primary\" data-testid=\"card-signin-admin\">\n                <CardHeader className=\"p-6\">\n                  <div className=\"flex h-12 w-12 items-center justify-center rounded-lg bg-primary/10 mb-3\">\n                    <Shield className=\"h-6 w-6 text-primary\" />\n                  </div>\n                  <CardTitle className=\"text-lg mb-2\">Sign in as Admin</CardTitle>\n                  <CardDescription className=\"text-sm mb-4\">\n                    Access administrative dashboard, resident management, billing controls, and system settings.\n                  </CardDescription>\n                  <Button \n                    size=\"lg\" \n                    className=\"w-full min-h-11\" \n                    asChild \n                    data-testid=\"button-signin-admin\"\n                  >\n                    <a href=\"/api/login?role=admin\">\n                      <Shield className=\"h-4 w-4 mr-2\" />\n                      Admin Login\n                    </a>\n                  </Button>\n                </CardHeader>\n              </Card>\n\n              <Card className=\"hover-elevate border-2 border-green-500/20 bg-white cursor-pointer transition-all hover:border-green-500\" data-testid=\"card-signin-resident\">\n                <CardHeader className=\"p-6\">\n                  <div className=\"flex h-12 w-12 items-center justify-center rounded-lg bg-green-500/10 mb-3\">\n                    <Building2 className=\"h-6 w-6 text-green-600\" />\n                  </div>\n                  <CardTitle className=\"text-lg mb-2\">Sign in as Resident</CardTitle>\n                  <CardDescription className=\"text-sm mb-4\">\n                    Access your bills, make payments, manage visitors, and view announcements.\n                  </CardDescription>\n                  <Button \n                    size=\"lg\" \n                    variant=\"secondary\"\n                    className=\"w-full min-h-11 bg-green-600 hover:bg-green-700 text-white\" \n                    asChild \n                    data-testid=\"button-signin-resident\"\n                  >\n                    <a href=\"/api/login?role=resident\">\n                      <Building2 className=\"h-4 w-4 mr-2\" />\n                      Resident Login\n                    </a>\n                  </Button>\n                </CardHeader>\n              </Card>\n            </div>\n            \n            {/* Additional Info */}\n            <p className=\"text-sm text-gray-500 max-w-2xl\">\n              Security personnel can also access the system through the Admin login.\n            </p>\n\n            {/* Quick Feature Cards */}\n            <div className=\"grid grid-cols-1 sm:grid-cols-3 gap-4 pt-4\">\n              <Card className=\"border-2 border-yellow-500 shadow-md bg-gray-100\">\n                <CardHeader className=\"p-4\">\n                  <div className=\"flex h-10 w-10 items-center justify-center rounded-lg bg-green-100 mb-2\">\n                    <Receipt className=\"h-5 w-5 text-green-600\" />\n                  </div>\n                  <CardTitle className=\"text-base\">Automated Billing</CardTitle>\n                </CardHeader>\n              </Card>\n\n              <Card className=\"border-2 border-yellow-500 shadow-md bg-gray-100\">\n                <CardHeader className=\"p-4\">\n                  <div className=\"flex h-10 w-10 items-center justify-center rounded-lg bg-blue-100 mb-2\">\n                    <CheckCircle className=\"h-5 w-5 text-blue-600\" />\n                  </div>\n                  <CardTitle className=\"text-base\">Residents Forums and Communities</CardTitle>\n                </CardHeader>\n              </Card>\n\n              <Card className=\"border-2 border-yellow-500 shadow-md bg-gray-100\">\n                <CardHeader className=\"p-4\">\n                  <div className=\"flex h-10 w-10 items-center justify-center rounded-lg bg-purple-100 mb-2\">\n                    <Shield className=\"h-5 w-5 text-purple-600\" />\n                  </div>\n                  <CardTitle className=\"text-base\">Integrated Security Management</CardTitle>\n                </CardHeader>\n              </Card>\n            </div>\n          </div>\n\n          {/* Right Side - Image (60%) */}\n          <div className=\"relative lg:col-span-3\">\n            <div className=\"relative rounded-2xl overflow-hidden shadow-2xl\">\n              <img\n                src={estateImage}\n                alt=\"Modern gated residential estate\"\n                className=\"w-full h-auto object-cover min-h-[500px]\"\n                data-testid=\"img-estate-hero\"\n              />\n              \n              {/* Image Badge */}\n              <div className=\"absolute bottom-6 left-6 bg-white rounded-lg shadow-lg p-4 flex items-center gap-3\">\n                <div className=\"flex h-10 w-10 items-center justify-center rounded-full bg-green-100\">\n                  <CheckCircle className=\"h-6 w-6 text-green-600\" />\n                </div>\n                <div>\n                  <p className=\"font-semibold text-gray-900\">Smart Access Control</p>\n                  <p className=\"text-sm text-gray-600\">QR Code Verification</p>\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      {/* Detailed Features Section */}\n      <div className=\"bg-gray-50 py-16 lg:py-20\">\n        <div className=\"container mx-auto px-6 md:px-12\">\n          <div className=\"text-center mb-12\">\n            <h2 className=\"text-3xl md:text-4xl font-bold text-gray-900 mb-4\">\n              Everything You Need to Manage Your Estate\n            </h2>\n            <p className=\"text-lg text-gray-600 max-w-2xl mx-auto\">\n              Powerful features designed for residents, administrators, and security personnel\n            </p>\n          </div>\n\n          <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6 lg:gap-8\">\n            <Card className=\"border-0 shadow-lg hover-elevate bg-white\">\n              <CardHeader>\n                <div className=\"flex h-12 w-12 items-center justify-center rounded-lg bg-green-100 mb-4\">\n                  <Receipt className=\"h-6 w-6 text-green-600\" />\n                </div>\n                <CardTitle className=\"text-xl\">Automated Billing</CardTitle>\n                <CardDescription className=\"text-base\">\n                  Real-time VAT and levy calculations that automatically adjust to regulations. \n                  Zero manual work required.\n                </CardDescription>\n              </CardHeader>\n            </Card>\n\n            <Card className=\"border-0 shadow-lg hover-elevate bg-white\">\n              <CardHeader>\n                <div className=\"flex h-12 w-12 items-center justify-center rounded-lg bg-blue-100 mb-4\">\n                  <QrCode className=\"h-6 w-6 text-blue-600\" />\n                </div>\n                <CardTitle className=\"text-xl\">QR Code Access</CardTitle>\n                <CardDescription className=\"text-base\">\n                  Generate and verify visitor passes instantly. Pre-filled forms, automatic validation, \n                  instant confirmation.\n                </CardDescription>\n              </CardHeader>\n            </Card>\n\n            <Card className=\"border-0 shadow-lg hover-elevate bg-white\">\n              <CardHeader>\n                <div className=\"flex h-12 w-12 items-center justify-center rounded-lg bg-purple-100 mb-4\">\n                  <Shield className=\"h-6 w-6 text-purple-600\" />\n                </div>\n                <CardTitle className=\"text-xl\">Security Protection</CardTitle>\n                <CardDescription className=\"text-base\">\n                  Automatic compliance monitoring alerts you before issues arise. Built-in audit trails \n                  and full documentation.\n                </CardDescription>\n              </CardHeader>\n            </Card>\n          </div>\n        </div>\n      </div>\n\n      {/* Additional Features */}\n      <div className=\"container mx-auto px-6 md:px-12 py-16\">\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\n          <Card className=\"hover-elevate\">\n            <CardHeader>\n              <CheckCircle className=\"h-10 w-10 text-green-600 mb-3\" />\n              <CardTitle>Real-time Notifications</CardTitle>\n              <CardDescription>\n                Instant alerts for bills, payments, announcements, and visitor arrivals across multiple channels.\n              </CardDescription>\n            </CardHeader>\n          </Card>\n\n          <Card className=\"hover-elevate\">\n            <CardHeader>\n              <TrendingUp className=\"h-10 w-10 text-blue-600 mb-3\" />\n              <CardTitle>Detailed Analytics</CardTitle>\n              <CardDescription>\n                Comprehensive reports on collections, delinquency rates, visitor traffic, and estate operations.\n              </CardDescription>\n            </CardHeader>\n          </Card>\n\n          <Card className=\"hover-elevate\">\n            <CardHeader>\n              <Building2 className=\"h-10 w-10 text-purple-600 mb-3\" />\n              <CardTitle>Multi-Role System</CardTitle>\n              <CardDescription>\n                Tailored dashboards and permissions for residents, estate administrators, and security personnel.\n              </CardDescription>\n            </CardHeader>\n          </Card>\n        </div>\n      </div>\n\n      {/* CTA Section */}\n      <div className=\"bg-gray-50 border-t\">\n        <div className=\"container mx-auto px-6 md:px-12 py-16\">\n          <div className=\"max-w-3xl mx-auto text-center\">\n            <h2 className=\"text-3xl md:text-4xl font-bold text-gray-900 mb-4\">\n              Ready to Transform Your Estate Management?\n            </h2>\n            <p className=\"text-lg text-gray-600 mb-8\">\n              Join modern residential estates using our platform to streamline operations and improve resident satisfaction.\n            </p>\n            <Button size=\"lg\" className=\"min-h-12 px-8\" asChild>\n              <a href=\"/api/login\">Get Started Today</a>\n            </Button>\n          </div>\n        </div>\n      </div>\n\n      {/* Footer */}\n      <footer className=\"border-t bg-white\">\n        <div className=\"container mx-auto px-6 md:px-12 py-8\">\n          <div className=\"flex flex-col md:flex-row justify-between items-center gap-4\">\n            <div className=\"flex items-center gap-3\">\n              <div className=\"flex h-8 w-8 items-center justify-center rounded-lg bg-primary\">\n                <Building2 className=\"h-5 w-5 text-primary-foreground\" />\n              </div>\n              <span className=\"font-medium text-gray-900\">Magodo Estate Management System</span>\n            </div>\n            <p className=\"text-sm text-gray-600\">\n              © 2024 Magodo Estate Management System. All rights reserved.\n            </p>\n          </div>\n        </div>\n      </footer>\n    </div>\n  );\n}\n","size_bytes":13836},"client/src/components/ui/pagination.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { ButtonProps, buttonVariants } from \"@/components/ui/button\"\n\nconst Pagination = ({ className, ...props }: React.ComponentProps<\"nav\">) => (\n  <nav\n    role=\"navigation\"\n    aria-label=\"pagination\"\n    className={cn(\"mx-auto flex w-full justify-center\", className)}\n    {...props}\n  />\n)\nPagination.displayName = \"Pagination\"\n\nconst PaginationContent = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    className={cn(\"flex flex-row items-center gap-1\", className)}\n    {...props}\n  />\n))\nPaginationContent.displayName = \"PaginationContent\"\n\nconst PaginationItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ className, ...props }, ref) => (\n  <li ref={ref} className={cn(\"\", className)} {...props} />\n))\nPaginationItem.displayName = \"PaginationItem\"\n\ntype PaginationLinkProps = {\n  isActive?: boolean\n} & Pick<ButtonProps, \"size\"> &\n  React.ComponentProps<\"a\">\n\nconst PaginationLink = ({\n  className,\n  isActive,\n  size = \"icon\",\n  ...props\n}: PaginationLinkProps) => (\n  <a\n    aria-current={isActive ? \"page\" : undefined}\n    className={cn(\n      buttonVariants({\n        variant: isActive ? \"outline\" : \"ghost\",\n        size,\n      }),\n      className\n    )}\n    {...props}\n  />\n)\nPaginationLink.displayName = \"PaginationLink\"\n\nconst PaginationPrevious = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to previous page\"\n    size=\"default\"\n    className={cn(\"gap-1 pl-2.5\", className)}\n    {...props}\n  >\n    <ChevronLeft className=\"h-4 w-4\" />\n    <span>Previous</span>\n  </PaginationLink>\n)\nPaginationPrevious.displayName = \"PaginationPrevious\"\n\nconst PaginationNext = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to next page\"\n    size=\"default\"\n    className={cn(\"gap-1 pr-2.5\", className)}\n    {...props}\n  >\n    <span>Next</span>\n    <ChevronRight className=\"h-4 w-4\" />\n  </PaginationLink>\n)\nPaginationNext.displayName = \"PaginationNext\"\n\nconst PaginationEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    aria-hidden\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More pages</span>\n  </span>\n)\nPaginationEllipsis.displayName = \"PaginationEllipsis\"\n\nexport {\n  Pagination,\n  PaginationContent,\n  PaginationEllipsis,\n  PaginationItem,\n  PaginationLink,\n  PaginationNext,\n  PaginationPrevious,\n}\n","size_bytes":2751},"client/src/components/ui/navigation-menu.tsx":{"content":"import * as React from \"react\"\nimport * as NavigationMenuPrimitive from \"@radix-ui/react-navigation-menu\"\nimport { cva } from \"class-variance-authority\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst NavigationMenu = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative z-10 flex max-w-max flex-1 items-center justify-center\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <NavigationMenuViewport />\n  </NavigationMenuPrimitive.Root>\n))\nNavigationMenu.displayName = NavigationMenuPrimitive.Root.displayName\n\nconst NavigationMenuList = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.List\n    ref={ref}\n    className={cn(\n      \"group flex flex-1 list-none items-center justify-center space-x-1\",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuList.displayName = NavigationMenuPrimitive.List.displayName\n\nconst NavigationMenuItem = NavigationMenuPrimitive.Item\n\nconst navigationMenuTriggerStyle = cva(\n  \"group inline-flex h-10 w-max items-center justify-center rounded-md bg-background px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus:outline-none disabled:pointer-events-none disabled:opacity-50 data-[state=open]:text-accent-foreground data-[state=open]:bg-accent/50 data-[state=open]:hover:bg-accent data-[state=open]:focus:bg-accent\"\n)\n\nconst NavigationMenuTrigger = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Trigger\n    ref={ref}\n    className={cn(navigationMenuTriggerStyle(), \"group\", className)}\n    {...props}\n  >\n    {children}{\" \"}\n    <ChevronDown\n      className=\"relative top-[1px] ml-1 h-3 w-3 transition duration-200 group-data-[state=open]:rotate-180\"\n      aria-hidden=\"true\"\n    />\n  </NavigationMenuPrimitive.Trigger>\n))\nNavigationMenuTrigger.displayName = NavigationMenuPrimitive.Trigger.displayName\n\nconst NavigationMenuContent = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"left-0 top-0 w-full data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 md:absolute md:w-auto \",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuContent.displayName = NavigationMenuPrimitive.Content.displayName\n\nconst NavigationMenuLink = NavigationMenuPrimitive.Link\n\nconst NavigationMenuViewport = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Viewport>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Viewport>\n>(({ className, ...props }, ref) => (\n  <div className={cn(\"absolute left-0 top-full flex justify-center\")}>\n    <NavigationMenuPrimitive.Viewport\n      className={cn(\n        \"origin-top-center relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90 md:w-[var(--radix-navigation-menu-viewport-width)]\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  </div>\n))\nNavigationMenuViewport.displayName =\n  NavigationMenuPrimitive.Viewport.displayName\n\nconst NavigationMenuIndicator = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Indicator>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Indicator>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Indicator\n    ref={ref}\n    className={cn(\n      \"top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in\",\n      className\n    )}\n    {...props}\n  >\n    <div className=\"relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm bg-border shadow-md\" />\n  </NavigationMenuPrimitive.Indicator>\n))\nNavigationMenuIndicator.displayName =\n  NavigationMenuPrimitive.Indicator.displayName\n\nexport {\n  navigationMenuTriggerStyle,\n  NavigationMenu,\n  NavigationMenuList,\n  NavigationMenuItem,\n  NavigationMenuContent,\n  NavigationMenuTrigger,\n  NavigationMenuLink,\n  NavigationMenuIndicator,\n  NavigationMenuViewport,\n}\n","size_bytes":5128},"client/src/components/ui/radio-group.tsx":{"content":"import * as React from \"react\"\nimport * as RadioGroupPrimitive from \"@radix-ui/react-radio-group\"\nimport { Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst RadioGroup = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Root\n      className={cn(\"grid gap-2\", className)}\n      {...props}\n      ref={ref}\n    />\n  )\n})\nRadioGroup.displayName = RadioGroupPrimitive.Root.displayName\n\nconst RadioGroupItem = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Item>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        \"aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    >\n      <RadioGroupPrimitive.Indicator className=\"flex items-center justify-center\">\n        <Circle className=\"h-2.5 w-2.5 fill-current text-current\" />\n      </RadioGroupPrimitive.Indicator>\n    </RadioGroupPrimitive.Item>\n  )\n})\nRadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName\n\nexport { RadioGroup, RadioGroupItem }\n","size_bytes":1467},"client/src/components/ui/collapsible.tsx":{"content":"\"use client\"\n\nimport * as CollapsiblePrimitive from \"@radix-ui/react-collapsible\"\n\nconst Collapsible = CollapsiblePrimitive.Root\n\nconst CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger\n\nconst CollapsibleContent = CollapsiblePrimitive.CollapsibleContent\n\nexport { Collapsible, CollapsibleTrigger, CollapsibleContent }\n","size_bytes":329},"client/src/components/theme-provider.tsx":{"content":"import { createContext, useContext, useEffect, useState } from \"react\";\n\ntype Theme = \"dark\" | \"light\" | \"system\";\n\ntype ThemeProviderProps = {\n  children: React.ReactNode;\n  defaultTheme?: Theme;\n  storageKey?: string;\n};\n\ntype ThemeProviderState = {\n  theme: Theme;\n  setTheme: (theme: Theme) => void;\n};\n\nconst initialState: ThemeProviderState = {\n  theme: \"system\",\n  setTheme: () => null,\n};\n\nconst ThemeProviderContext = createContext<ThemeProviderState>(initialState);\n\nexport function ThemeProvider({\n  children,\n  defaultTheme = \"system\",\n  storageKey = \"vite-ui-theme\",\n  ...props\n}: ThemeProviderProps) {\n  const [theme, setTheme] = useState<Theme>(\n    () => (localStorage.getItem(storageKey) as Theme) || defaultTheme\n  );\n\n  useEffect(() => {\n    const root = window.document.documentElement;\n    root.classList.remove(\"light\", \"dark\");\n\n    if (theme === \"system\") {\n      const systemTheme = window.matchMedia(\"(prefers-color-scheme: dark)\")\n        .matches\n        ? \"dark\"\n        : \"light\";\n      root.classList.add(systemTheme);\n      return;\n    }\n\n    root.classList.add(theme);\n  }, [theme]);\n\n  const value = {\n    theme,\n    setTheme: (theme: Theme) => {\n      localStorage.setItem(storageKey, theme);\n      setTheme(theme);\n    },\n  };\n\n  return (\n    <ThemeProviderContext.Provider {...props} value={value}>\n      {children}\n    </ThemeProviderContext.Provider>\n  );\n}\n\nexport const useTheme = () => {\n  const context = useContext(ThemeProviderContext);\n\n  if (context === undefined)\n    throw new Error(\"useTheme must be used within a ThemeProvider\");\n\n  return context;\n};\n","size_bytes":1603},"client/src/components/app-sidebar.tsx":{"content":"import { \n  Home, \n  Users, \n  Receipt, \n  Bell, \n  QrCode, \n  FileText, \n  Shield, \n  LogOut,\n  Building2,\n  DollarSign,\n  Activity,\n  BarChart3,\n  BookOpen,\n  LayoutList,\n  Calculator,\n  TrendingUp,\n  Scale,\n  Package,\n  CheckSquare,\n  FileBarChart,\n  ShoppingCart,\n  ClipboardCheck,\n  Calendar,\n  Upload,\n  UserCog\n} from \"lucide-react\";\nimport {\n  Sidebar,\n  SidebarContent,\n  SidebarGroup,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarMenu,\n  SidebarMenuButton,\n  SidebarMenuItem,\n  SidebarHeader,\n  SidebarFooter,\n} from \"@/components/ui/sidebar\";\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { Link, useLocation } from \"wouter\";\n\nexport function AppSidebar() {\n  const { user } = useAuth();\n  const [location] = useLocation();\n\n  const residentItems = [\n    { title: \"Dashboard\", url: \"/\", icon: Home },\n    { title: \"My Bills\", url: \"/bills\", icon: Receipt },\n    { title: \"My Expenses\", url: \"/expenses\", icon: ShoppingCart },\n    { title: \"Visitors\", url: \"/visitors\", icon: QrCode },\n    { title: \"Notifications\", url: \"/notifications\", icon: Bell },\n  ];\n\n  const adminItems = [\n    { title: \"Dashboard\", url: \"/admin\", icon: Home },\n    { title: \"Registered Residents\", url: \"/admin/residents/list\", icon: Users },\n    { title: \"User Management\", url: \"/admin/user-management\", icon: UserCog },\n    { title: \"Collections\", url: \"/admin/collections\", icon: Receipt },\n    { title: \"Automated Billing\", url: \"/admin/billing/automated\", icon: Calendar },\n    { title: \"Residents account status\", url: \"/admin/account-status\", icon: BarChart3 },\n    { title: \"Announcements\", url: \"/admin/announcements\", icon: FileText },\n    { title: \"Reports Center\", url: \"/admin/reports-center\", icon: Activity },\n  ];\n\n  const securityItems = [\n    { title: \"Dashboard\", url: \"/security\", icon: Home },\n    { title: \"Scan QR Code\", url: \"/security/scan\", icon: QrCode },\n    { title: \"Access Log\", url: \"/security/logs\", icon: Shield },\n  ];\n\n  const accountantAccountingItems = [\n    { title: \"Dashboard\", url: \"/accountant\", icon: Home },\n    { title: \"Chart of Accounts\", url: \"/accountant/accounts\", icon: BookOpen },\n    { title: \"Transaction Templates\", url: \"/accountant/templates\", icon: LayoutList },\n    { title: \"Journal Entries\", url: \"/accountant/entries\", icon: FileText },\n    { title: \"Trial Balance\", url: \"/accountant/trial-balance\", icon: Calculator },\n    { title: \"Income Statement\", url: \"/accountant/income-statement\", icon: TrendingUp },\n    { title: \"Balance Sheet\", url: \"/accountant/balance-sheet\", icon: Scale },\n  ];\n\n  const accountantVendorItems = [\n    { title: \"Vendor Registration\", url: \"/accountant/vendors/register\", icon: Package },\n    { title: \"Vendor Approval\", url: \"/accountant/vendors/approval\", icon: CheckSquare },\n    { title: \"Vendor Management\", url: \"/accountant/vendors/management\", icon: Users },\n  ];\n\n  const accountantExpenseItems = [\n    { title: \"Expense Request\", url: \"/accountant/expenses/request\", icon: ShoppingCart },\n    { title: \"Expense Approval\", url: \"/accountant/expenses/approval\", icon: ClipboardCheck },\n    { title: \"Accounts Payable\", url: \"/accountant/accounts-payable\", icon: DollarSign },\n    { title: \"Accounts Receivable\", url: \"/accountant/accounts-receivable\", icon: Receipt },\n    { title: \"Upload Bank Statement\", url: \"/accountant/bank-statements/upload\", icon: Upload },\n  ];\n\n  const accountantBudgetItems = [\n    { title: \"Budget & Planning\", url: \"/accountant/budget-planning\", icon: TrendingUp },\n  ];\n\n  const menuItems = user?.role === \"admin\" ? adminItems : \n                    user?.role === \"security\" ? securityItems : \n                    residentItems;\n\n  const getInitials = () => {\n    if (user?.firstName && user?.lastName) {\n      return `${user.firstName[0]}${user.lastName[0]}`.toUpperCase();\n    }\n    return user?.email?.[0]?.toUpperCase() || \"U\";\n  };\n\n  return (\n    <Sidebar data-testid=\"sidebar-main\">\n      <SidebarHeader className=\"p-6\">\n        <div className=\"flex items-center gap-3\">\n          <div className=\"flex h-10 w-10 items-center justify-center rounded-lg bg-primary\">\n            <Building2 className=\"h-6 w-6 text-primary-foreground\" />\n          </div>\n          <div>\n            <h2 className=\"text-lg font-semibold\">Magodo Estate</h2>\n            <p className=\"text-xs text-muted-foreground\">Management System</p>\n          </div>\n        </div>\n      </SidebarHeader>\n      \n      <SidebarContent>\n        {user?.role === \"admin\" ? (\n          <>\n            <SidebarGroup>\n              <SidebarGroupLabel>Administration</SidebarGroupLabel>\n              <SidebarGroupContent>\n                <SidebarMenu>\n                  {adminItems.map((item) => (\n                    <SidebarMenuItem key={item.title}>\n                      <SidebarMenuButton asChild isActive={location === item.url}>\n                        <Link href={item.url} data-testid={`link-${item.title.toLowerCase().replace(/\\s+/g, '-')}`}>\n                          <item.icon className=\"h-4 w-4\" />\n                          <span>{item.title}</span>\n                        </Link>\n                      </SidebarMenuButton>\n                    </SidebarMenuItem>\n                  ))}\n                </SidebarMenu>\n              </SidebarGroupContent>\n            </SidebarGroup>\n\n            <SidebarGroup>\n              <SidebarGroupLabel>Accounting Centre</SidebarGroupLabel>\n              <SidebarGroupContent>\n                <SidebarMenu>\n                  {accountantAccountingItems.map((item) => (\n                    <SidebarMenuItem key={item.title}>\n                      <SidebarMenuButton asChild isActive={location === item.url}>\n                        <Link href={item.url} data-testid={`link-${item.title.toLowerCase().replace(/\\s+/g, '-')}`}>\n                          <item.icon className=\"h-4 w-4\" />\n                          <span>{item.title}</span>\n                        </Link>\n                      </SidebarMenuButton>\n                    </SidebarMenuItem>\n                  ))}\n                </SidebarMenu>\n              </SidebarGroupContent>\n            </SidebarGroup>\n\n            <SidebarGroup>\n              <SidebarGroupLabel>Vendors</SidebarGroupLabel>\n              <SidebarGroupContent>\n                <SidebarMenu>\n                  {accountantVendorItems.map((item) => (\n                    <SidebarMenuItem key={item.title}>\n                      <SidebarMenuButton asChild isActive={location === item.url}>\n                        <Link href={item.url} data-testid={`link-${item.title.toLowerCase().replace(/\\s+/g, '-')}`}>\n                          <item.icon className=\"h-4 w-4\" />\n                          <span>{item.title}</span>\n                        </Link>\n                      </SidebarMenuButton>\n                    </SidebarMenuItem>\n                  ))}\n                </SidebarMenu>\n              </SidebarGroupContent>\n            </SidebarGroup>\n\n            <SidebarGroup>\n              <SidebarGroupLabel>Expense</SidebarGroupLabel>\n              <SidebarGroupContent>\n                <SidebarMenu>\n                  {accountantExpenseItems.map((item) => (\n                    <SidebarMenuItem key={item.title}>\n                      <SidebarMenuButton asChild isActive={location === item.url}>\n                        <Link href={item.url} data-testid={`link-${item.title.toLowerCase().replace(/\\s+/g, '-')}`}>\n                          <item.icon className=\"h-4 w-4\" />\n                          <span>{item.title}</span>\n                        </Link>\n                      </SidebarMenuButton>\n                    </SidebarMenuItem>\n                  ))}\n                </SidebarMenu>\n              </SidebarGroupContent>\n            </SidebarGroup>\n\n            <SidebarGroup>\n              <SidebarGroupLabel>Budget</SidebarGroupLabel>\n              <SidebarGroupContent>\n                <SidebarMenu>\n                  {accountantBudgetItems.map((item) => (\n                    <SidebarMenuItem key={item.title}>\n                      <SidebarMenuButton asChild isActive={location === item.url}>\n                        <Link href={item.url} data-testid={`link-${item.title.toLowerCase().replace(/\\s+/g, '-')}`}>\n                          <item.icon className=\"h-4 w-4\" />\n                          <span>{item.title}</span>\n                        </Link>\n                      </SidebarMenuButton>\n                    </SidebarMenuItem>\n                  ))}\n                </SidebarMenu>\n              </SidebarGroupContent>\n            </SidebarGroup>\n          </>\n        ) : user?.role === \"accountant\" ? (\n          <>\n            <SidebarGroup>\n              <SidebarGroupLabel>Accounting Centre</SidebarGroupLabel>\n              <SidebarGroupContent>\n                <SidebarMenu>\n                  {accountantAccountingItems.map((item) => (\n                    <SidebarMenuItem key={item.title}>\n                      <SidebarMenuButton asChild isActive={location === item.url}>\n                        <Link href={item.url} data-testid={`link-${item.title.toLowerCase().replace(/\\s+/g, '-')}`}>\n                          <item.icon className=\"h-4 w-4\" />\n                          <span>{item.title}</span>\n                        </Link>\n                      </SidebarMenuButton>\n                    </SidebarMenuItem>\n                  ))}\n                </SidebarMenu>\n              </SidebarGroupContent>\n            </SidebarGroup>\n\n            <SidebarGroup>\n              <SidebarGroupLabel>Vendors</SidebarGroupLabel>\n              <SidebarGroupContent>\n                <SidebarMenu>\n                  {accountantVendorItems.map((item) => (\n                    <SidebarMenuItem key={item.title}>\n                      <SidebarMenuButton asChild isActive={location === item.url}>\n                        <Link href={item.url} data-testid={`link-${item.title.toLowerCase().replace(/\\s+/g, '-')}`}>\n                          <item.icon className=\"h-4 w-4\" />\n                          <span>{item.title}</span>\n                        </Link>\n                      </SidebarMenuButton>\n                    </SidebarMenuItem>\n                  ))}\n                </SidebarMenu>\n              </SidebarGroupContent>\n            </SidebarGroup>\n\n            <SidebarGroup>\n              <SidebarGroupLabel>Expense</SidebarGroupLabel>\n              <SidebarGroupContent>\n                <SidebarMenu>\n                  {accountantExpenseItems.map((item) => (\n                    <SidebarMenuItem key={item.title}>\n                      <SidebarMenuButton asChild isActive={location === item.url}>\n                        <Link href={item.url} data-testid={`link-${item.title.toLowerCase().replace(/\\s+/g, '-')}`}>\n                          <item.icon className=\"h-4 w-4\" />\n                          <span>{item.title}</span>\n                        </Link>\n                      </SidebarMenuButton>\n                    </SidebarMenuItem>\n                  ))}\n                </SidebarMenu>\n              </SidebarGroupContent>\n            </SidebarGroup>\n\n            <SidebarGroup>\n              <SidebarGroupLabel>Budget</SidebarGroupLabel>\n              <SidebarGroupContent>\n                <SidebarMenu>\n                  {accountantBudgetItems.map((item) => (\n                    <SidebarMenuItem key={item.title}>\n                      <SidebarMenuButton asChild isActive={location === item.url}>\n                        <Link href={item.url} data-testid={`link-${item.title.toLowerCase().replace(/\\s+/g, '-')}`}>\n                          <item.icon className=\"h-4 w-4\" />\n                          <span>{item.title}</span>\n                        </Link>\n                      </SidebarMenuButton>\n                    </SidebarMenuItem>\n                  ))}\n                </SidebarMenu>\n              </SidebarGroupContent>\n            </SidebarGroup>\n          </>\n        ) : user?.role === \"security\" ? (\n          <SidebarGroup>\n            <SidebarGroupLabel>Security</SidebarGroupLabel>\n            <SidebarGroupContent>\n              <SidebarMenu>\n                {securityItems.map((item) => (\n                  <SidebarMenuItem key={item.title}>\n                    <SidebarMenuButton asChild isActive={location === item.url}>\n                      <Link href={item.url} data-testid={`link-${item.title.toLowerCase().replace(/\\s+/g, '-')}`}>\n                        <item.icon className=\"h-4 w-4\" />\n                        <span>{item.title}</span>\n                      </Link>\n                    </SidebarMenuButton>\n                  </SidebarMenuItem>\n                ))}\n              </SidebarMenu>\n            </SidebarGroupContent>\n          </SidebarGroup>\n        ) : (\n          <SidebarGroup>\n            <SidebarGroupLabel>My Account</SidebarGroupLabel>\n            <SidebarGroupContent>\n              <SidebarMenu>\n                {residentItems.map((item) => (\n                  <SidebarMenuItem key={item.title}>\n                    <SidebarMenuButton asChild isActive={location === item.url}>\n                      <Link href={item.url} data-testid={`link-${item.title.toLowerCase().replace(/\\s+/g, '-')}`}>\n                        <item.icon className=\"h-4 w-4\" />\n                        <span>{item.title}</span>\n                      </Link>\n                    </SidebarMenuButton>\n                  </SidebarMenuItem>\n                ))}\n              </SidebarMenu>\n            </SidebarGroupContent>\n          </SidebarGroup>\n        )}\n      </SidebarContent>\n\n      <SidebarFooter className=\"p-4\">\n        <div className=\"flex items-center gap-3 rounded-lg p-3 hover-elevate\">\n          <Avatar className=\"h-9 w-9\" data-testid=\"avatar-user\">\n            <AvatarImage src={user?.profileImageUrl || undefined} alt={user?.firstName || \"User\"} />\n            <AvatarFallback className=\"bg-primary text-primary-foreground text-xs\">\n              {getInitials()}\n            </AvatarFallback>\n          </Avatar>\n          <div className=\"flex-1 min-w-0\">\n            <p className=\"text-sm font-medium truncate\" data-testid=\"text-user-name\">\n              {user?.firstName && user?.lastName \n                ? `${user.firstName} ${user.lastName}` \n                : user?.email}\n            </p>\n            <p className=\"text-xs text-muted-foreground capitalize\">{user?.role}</p>\n          </div>\n          <a href=\"/api/logout\" data-testid=\"button-logout\">\n            <LogOut className=\"h-4 w-4 text-muted-foreground hover:text-foreground\" />\n          </a>\n        </div>\n      </SidebarFooter>\n    </Sidebar>\n  );\n}\n","size_bytes":14660},"client/src/components/ui/input.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Input = React.forwardRef<HTMLInputElement, React.ComponentProps<\"input\">>(\n  ({ className, type, ...props }, ref) => {\n    // h-9 to match icon buttons and default buttons.\n    return (\n      <input\n        type={type}\n        className={cn(\n          \"flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n          className\n        )}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nInput.displayName = \"Input\"\n\nexport { Input }\n","size_bytes":844},"postcss.config.js":{"content":"export default {\n  plugins: {\n    tailwindcss: {},\n    autoprefixer: {},\n  },\n}\n","size_bytes":80},"client/src/lib/utils.ts":{"content":"import { clsx, type ClassValue } from \"clsx\"\nimport { twMerge } from \"tailwind-merge\"\n\nexport function cn(...inputs: ClassValue[]) {\n  return twMerge(clsx(inputs))\n}\n","size_bytes":166},"server/vite.ts":{"content":"import express, { type Express } from \"express\";\nimport fs from \"fs\";\nimport path from \"path\";\nimport { createServer as createViteServer, createLogger } from \"vite\";\nimport { type Server } from \"http\";\nimport viteConfig from \"../vite.config\";\nimport { nanoid } from \"nanoid\";\n\nconst viteLogger = createLogger();\n\nexport function log(message: string, source = \"express\") {\n  const formattedTime = new Date().toLocaleTimeString(\"en-US\", {\n    hour: \"numeric\",\n    minute: \"2-digit\",\n    second: \"2-digit\",\n    hour12: true,\n  });\n\n  console.log(`${formattedTime} [${source}] ${message}`);\n}\n\nexport async function setupVite(app: Express, server: Server) {\n  const serverOptions = {\n    middlewareMode: true,\n    hmr: { server },\n    allowedHosts: true as const,\n  };\n\n  const vite = await createViteServer({\n    ...viteConfig,\n    configFile: false,\n    customLogger: {\n      ...viteLogger,\n      error: (msg, options) => {\n        viteLogger.error(msg, options);\n        process.exit(1);\n      },\n    },\n    server: serverOptions,\n    appType: \"custom\",\n  });\n\n  app.use(vite.middlewares);\n  app.use(\"*\", async (req, res, next) => {\n    const url = req.originalUrl;\n\n    try {\n      const clientTemplate = path.resolve(\n        import.meta.dirname,\n        \"..\",\n        \"client\",\n        \"index.html\",\n      );\n\n      // always reload the index.html file from disk incase it changes\n      let template = await fs.promises.readFile(clientTemplate, \"utf-8\");\n      template = template.replace(\n        `src=\"/src/main.tsx\"`,\n        `src=\"/src/main.tsx?v=${nanoid()}\"`,\n      );\n      const page = await vite.transformIndexHtml(url, template);\n      res.status(200).set({ \"Content-Type\": \"text/html\" }).end(page);\n    } catch (e) {\n      vite.ssrFixStacktrace(e as Error);\n      next(e);\n    }\n  });\n}\n\nexport function serveStatic(app: Express) {\n  const distPath = path.resolve(import.meta.dirname, \"public\");\n\n  if (!fs.existsSync(distPath)) {\n    throw new Error(\n      `Could not find the build directory: ${distPath}, make sure to build the client first`,\n    );\n  }\n\n  app.use(express.static(distPath));\n\n  // fall through to index.html if the file doesn't exist\n  app.use(\"*\", (_req, res) => {\n    res.sendFile(path.resolve(distPath, \"index.html\"));\n  });\n}\n","size_bytes":2263},"client/src/components/ui/form.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport {\n  Controller,\n  FormProvider,\n  useFormContext,\n  type ControllerProps,\n  type FieldPath,\n  type FieldValues,\n} from \"react-hook-form\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Label } from \"@/components/ui/label\"\n\nconst Form = FormProvider\n\ntype FormFieldContextValue<\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n> = {\n  name: TName\n}\n\nconst FormFieldContext = React.createContext<FormFieldContextValue>(\n  {} as FormFieldContextValue\n)\n\nconst FormField = <\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n>({\n  ...props\n}: ControllerProps<TFieldValues, TName>) => {\n  return (\n    <FormFieldContext.Provider value={{ name: props.name }}>\n      <Controller {...props} />\n    </FormFieldContext.Provider>\n  )\n}\n\nconst useFormField = () => {\n  const fieldContext = React.useContext(FormFieldContext)\n  const itemContext = React.useContext(FormItemContext)\n  const { getFieldState, formState } = useFormContext()\n\n  const fieldState = getFieldState(fieldContext.name, formState)\n\n  if (!fieldContext) {\n    throw new Error(\"useFormField should be used within <FormField>\")\n  }\n\n  const { id } = itemContext\n\n  return {\n    id,\n    name: fieldContext.name,\n    formItemId: `${id}-form-item`,\n    formDescriptionId: `${id}-form-item-description`,\n    formMessageId: `${id}-form-item-message`,\n    ...fieldState,\n  }\n}\n\ntype FormItemContextValue = {\n  id: string\n}\n\nconst FormItemContext = React.createContext<FormItemContextValue>(\n  {} as FormItemContextValue\n)\n\nconst FormItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const id = React.useId()\n\n  return (\n    <FormItemContext.Provider value={{ id }}>\n      <div ref={ref} className={cn(\"space-y-2\", className)} {...props} />\n    </FormItemContext.Provider>\n  )\n})\nFormItem.displayName = \"FormItem\"\n\nconst FormLabel = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  const { error, formItemId } = useFormField()\n\n  return (\n    <Label\n      ref={ref}\n      className={cn(error && \"text-destructive\", className)}\n      htmlFor={formItemId}\n      {...props}\n    />\n  )\n})\nFormLabel.displayName = \"FormLabel\"\n\nconst FormControl = React.forwardRef<\n  React.ElementRef<typeof Slot>,\n  React.ComponentPropsWithoutRef<typeof Slot>\n>(({ ...props }, ref) => {\n  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()\n\n  return (\n    <Slot\n      ref={ref}\n      id={formItemId}\n      aria-describedby={\n        !error\n          ? `${formDescriptionId}`\n          : `${formDescriptionId} ${formMessageId}`\n      }\n      aria-invalid={!!error}\n      {...props}\n    />\n  )\n})\nFormControl.displayName = \"FormControl\"\n\nconst FormDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => {\n  const { formDescriptionId } = useFormField()\n\n  return (\n    <p\n      ref={ref}\n      id={formDescriptionId}\n      className={cn(\"text-sm text-muted-foreground\", className)}\n      {...props}\n    />\n  )\n})\nFormDescription.displayName = \"FormDescription\"\n\nconst FormMessage = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, children, ...props }, ref) => {\n  const { error, formMessageId } = useFormField()\n  const body = error ? String(error?.message ?? \"\") : children\n\n  if (!body) {\n    return null\n  }\n\n  return (\n    <p\n      ref={ref}\n      id={formMessageId}\n      className={cn(\"text-sm font-medium text-destructive\", className)}\n      {...props}\n    >\n      {body}\n    </p>\n  )\n})\nFormMessage.displayName = \"FormMessage\"\n\nexport {\n  useFormField,\n  Form,\n  FormItem,\n  FormLabel,\n  FormControl,\n  FormDescription,\n  FormMessage,\n  FormField,\n}\n","size_bytes":4120},"server/index.ts":{"content":"import express, { type Request, Response, NextFunction } from \"express\";\nimport { registerRoutes } from \"./routes\";\nimport { setupVite, serveStatic, log } from \"./vite\";\nimport { storage } from \"./storage\";\n\nconst app = express();\n\ndeclare module 'http' {\n  interface IncomingMessage {\n    rawBody: unknown\n  }\n}\napp.use(express.json({\n  limit: '10mb', // Increased limit to support large receipt image uploads\n  verify: (req, _res, buf) => {\n    req.rawBody = buf;\n  }\n}));\napp.use(express.urlencoded({ extended: false, limit: '10mb' }));\n\napp.use((req, res, next) => {\n  const start = Date.now();\n  const path = req.path;\n  let capturedJsonResponse: Record<string, any> | undefined = undefined;\n\n  const originalResJson = res.json;\n  res.json = function (bodyJson, ...args) {\n    capturedJsonResponse = bodyJson;\n    return originalResJson.apply(res, [bodyJson, ...args]);\n  };\n\n  res.on(\"finish\", () => {\n    const duration = Date.now() - start;\n    if (path.startsWith(\"/api\")) {\n      let logLine = `${req.method} ${path} ${res.statusCode} in ${duration}ms`;\n      if (capturedJsonResponse) {\n        logLine += ` :: ${JSON.stringify(capturedJsonResponse)}`;\n      }\n\n      if (logLine.length > 80) {\n        logLine = logLine.slice(0, 79) + \"…\";\n      }\n\n      log(logLine);\n    }\n  });\n\n  next();\n});\n\n(async () => {\n  const server = await registerRoutes(app);\n\n  app.use((err: any, _req: Request, res: Response, _next: NextFunction) => {\n    const status = err.status || err.statusCode || 500;\n    const message = err.message || \"Internal Server Error\";\n\n    res.status(status).json({ message });\n    throw err;\n  });\n\n  // importantly only setup vite in development and after\n  // setting up all the other routes so the catch-all route\n  // doesn't interfere with the other routes\n  if (app.get(\"env\") === \"development\") {\n    await setupVite(app, server);\n  } else {\n    serveStatic(app);\n  }\n\n  // ALWAYS serve the app on the port specified in the environment variable PORT\n  // Other ports are firewalled. Default to 5000 if not specified.\n  // this serves both the API and the client.\n  // It is the only port that is not firewalled.\n  const port = parseInt(process.env.PORT || '5000', 10);\n  server.listen({\n    port,\n    host: \"0.0.0.0\",\n    reusePort: true,\n  }, () => {\n    log(`serving on port ${port}`);\n    \n    // Start automated billing scheduler\n    startAutomatedBillingScheduler();\n  });\n})();\n\n// Automated billing scheduler - runs daily\nasync function startAutomatedBillingScheduler() {\n  const SYSTEM_USER_ID = 'system-automated-billing';\n  const ONE_DAY_MS = 24 * 60 * 60 * 1000; // 24 hours in milliseconds\n  \n  // Ensure system user exists for automated billing\n  try {\n    await storage.upsertUser({\n      id: SYSTEM_USER_ID,\n      email: 'system@automated-billing.internal',\n      firstName: 'System',\n      lastName: 'Automated Billing',\n      role: 'admin',\n    });\n  } catch (error: any) {\n    console.error('[Automated Billing] Failed to create system user:', error.message);\n  }\n  \n  // Function to run automated billing\n  async function runAutomatedBilling() {\n    try {\n      log('[Automated Billing] Running daily billing check...');\n      const result = await storage.generateAutomatedServiceChargeBills(SYSTEM_USER_ID);\n      log(`[Automated Billing] Completed: ${result.success} bills generated, ${result.failed} failed`);\n      \n      if (result.errors.length > 0) {\n        log(`[Automated Billing] Errors: ${JSON.stringify(result.errors)}`);\n      }\n      \n      // Send invoice emails for newly generated bills\n      if (result.success > 0 && result.generatedBills && result.generatedBills.length > 0) {\n        await storage.sendInvoiceEmailsForBills(result.generatedBills);\n      }\n    } catch (error: any) {\n      console.error('[Automated Billing] Error during daily billing check:', error.message);\n    }\n  }\n  \n  // Run immediately on server start (after 30 second delay to allow DB connections)\n  setTimeout(() => {\n    log('[Automated Billing] Running initial billing check on server start...');\n    runAutomatedBilling();\n  }, 30000);\n  \n  // Schedule to run daily\n  setInterval(() => {\n    runAutomatedBilling();\n  }, ONE_DAY_MS);\n  \n  log('[Automated Billing] Scheduler initialized - will run daily');\n}\n","size_bytes":4265},"client/src/pages/admin-dashboard.tsx":{"content":"import { useEffect } from \"react\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { TrendingUp, TrendingDown, DollarSign, CheckCircle, AlertCircle } from \"lucide-react\";\nimport { Link } from \"wouter\";\nimport { formatNaira } from \"@/lib/currency\";\nimport businessManImg from \"@assets/image_1763300568028.png\";\nimport {\n  BarChart,\n  Bar,\n  XAxis,\n  YAxis,\n  CartesianGrid,\n  Tooltip,\n  Legend,\n  ResponsiveContainer,\n} from \"recharts\";\n\ninterface DashboardStats {\n  totalResidents: number;\n  activeResidents: number;\n  delinquentResidents: number;\n  totalRevenue: number;\n  collectionsThisMonth: number;\n  pendingPayments: number;\n  overdueBills: number;\n  collectionRate: number;\n  activeVisitors: number;\n  totalExpenses: number;\n  paidExpenses: number;\n  approvedExpenses: number;\n  pendingExpenses: number;\n  accountsPayable: number;\n}\n\nexport default function AdminDashboard() {\n  const { toast } = useToast();\n  const { isAuthenticated, isLoading: authLoading, user } = useAuth();\n\n  useEffect(() => {\n    if (!authLoading && (!isAuthenticated || user?.role !== \"admin\")) {\n      toast({\n        title: \"Unauthorized\",\n        description: \"Admin access required\",\n        variant: \"destructive\",\n      });\n      setTimeout(() => {\n        window.location.href = \"/\";\n      }, 500);\n      return;\n    }\n  }, [isAuthenticated, authLoading, user, toast]);\n\n  const { data: stats, isLoading: statsLoading } = useQuery<DashboardStats>({\n    queryKey: [\"/api/admin/stats\"],\n    enabled: isAuthenticated && user?.role === \"admin\",\n  });\n\n  const { data: agingData = [], isLoading: agingLoading } = useQuery<any[]>({\n    queryKey: [\"/api/admin/dashboard/aging-analysis\"],\n    enabled: isAuthenticated && user?.role === \"admin\",\n  });\n\n  const { data: budgetVsExpensesData = [], isLoading: budgetVsExpensesLoading } = useQuery<any[]>({\n    queryKey: [\"/api/admin/dashboard/budget-vs-expenses\"],\n    enabled: isAuthenticated && user?.role === \"admin\",\n  });\n\n  const { data: collectionsExpensesData = [], isLoading: collectionsLoading } = useQuery<any[]>({\n    queryKey: [\"/api/admin/dashboard/collections-expenses\"],\n    enabled: isAuthenticated && user?.role === \"admin\",\n  });\n\n  if (authLoading || !isAuthenticated || user?.role !== \"admin\") {\n    return (\n      <div className=\"flex h-screen items-center justify-center\">\n        <div className=\"animate-spin w-8 h-8 border-4 border-primary border-t-transparent rounded-full\" />\n      </div>\n    );\n  }\n\n  const totalOverdue = agingData.reduce((sum, item) => sum + item.amount, 0);\n  const totalOverdueCount = agingData.reduce((sum, item) => sum + item.inv, 0);\n  \n  const totalBudget = budgetVsExpensesData.reduce((sum, item) => sum + item.budget, 0);\n  const totalActual = budgetVsExpensesData.reduce((sum, item) => sum + item.actual, 0);\n  const budgetVariance = totalBudget - totalActual;\n  \n  const collectionsNet = collectionsExpensesData.reduce((sum, item) => sum + (item.collections - item.expenses), 0);\n  \n  // Use collectionsThisMonth for current month's collections\n  const totalCollections = stats?.collectionsThisMonth || 0;\n  const totalExpenses = stats?.totalExpenses || 0;\n  const paidExpenses = stats?.paidExpenses || 0;\n  const accountsReceivable = stats?.pendingPayments || 0;\n  const arOverdue = stats?.overdueBills || 0;\n  const accountsPayable = stats?.accountsPayable || 0;\n  const apPending = stats?.pendingExpenses || 0;\n  const apApproved = stats?.approvedExpenses || 0;\n  \n  const collectionGoal = 1500000;\n  const currentBalance = accountsReceivable - arOverdue;\n\n  // Calculate performance insights (only if stats are loaded)\n  let goingWell: string[] = [];\n  let improvementAreas: string[] = [];\n\n  if (stats && !statsLoading) {\n    const collectionRate = stats.collectionRate || 0;\n    const overduePercentage = accountsReceivable > 0 ? (arOverdue / accountsReceivable) * 100 : 0;\n    const expensePaymentRate = totalExpenses > 0 ? (paidExpenses / totalExpenses) * 100 : 0;\n    const delinquentPercentage = stats.totalResidents > 0 ? ((stats.delinquentResidents || 0) / stats.totalResidents) * 100 : 0;\n    const budgetUtilization = totalBudget > 0 ? (totalActual / totalBudget) * 100 : 0;\n\n    // What's going well\n    if (collectionRate >= 80) goingWell.push(`Strong collection rate at ${collectionRate}%`);\n    if (overduePercentage < 20) goingWell.push(`Low overdue rate (${overduePercentage.toFixed(1)}%)`);\n    if (totalCollections > 0) goingWell.push(`Collected ${formatNaira(totalCollections)} this month`);\n    if (delinquentPercentage < 10) goingWell.push(`Low delinquency rate (${delinquentPercentage.toFixed(1)}%)`);\n    if (budgetVariance > 0) goingWell.push(`Under budget by ${formatNaira(budgetVariance)}`);\n    if (expensePaymentRate >= 80) goingWell.push(`${expensePaymentRate.toFixed(0)}% of expenses paid on time`);\n    if (stats.activeResidents === stats.totalResidents) goingWell.push(`All ${stats.totalResidents} residents active`);\n    if (collectionsNet > 0) goingWell.push(`Positive cash flow: ${formatNaira(collectionsNet)}`);\n\n    // Improvement areas\n    if (collectionRate < 70) improvementAreas.push(`Collection rate low at ${collectionRate}%`);\n    if (overduePercentage >= 30) improvementAreas.push(`High overdue rate (${overduePercentage.toFixed(1)}%)`);\n    if (arOverdue > 100000) improvementAreas.push(`${formatNaira(arOverdue)} in overdue bills`);\n    if (delinquentPercentage >= 15) improvementAreas.push(`${stats.delinquentResidents} delinquent residents (${delinquentPercentage.toFixed(1)}%)`);\n    if (accountsPayable > 200000) improvementAreas.push(`High accounts payable: ${formatNaira(accountsPayable)}`);\n    if (budgetVariance < 0) improvementAreas.push(`Over budget by ${formatNaira(Math.abs(budgetVariance))}`);\n    if (expensePaymentRate < 60) improvementAreas.push(`Only ${expensePaymentRate.toFixed(0)}% of expenses paid`);\n    if (apPending > 100000) improvementAreas.push(`${formatNaira(apPending)} in pending expense approvals`);\n    if (totalOverdueCount > 5) improvementAreas.push(`${totalOverdueCount} invoices overdue`);\n\n    // Default messages if lists are empty\n    if (goingWell.length === 0) goingWell.push(\"No standout strengths detected – monitor KPIs\");\n    if (improvementAreas.length === 0) improvementAreas.push(\"No critical issues detected\");\n  } else {\n    // Default messages while loading\n    goingWell = [\"Loading performance data...\"];\n    improvementAreas = [\"Loading performance data...\"];\n  }\n\n  return (\n    <div className=\"flex gap-6 p-6\">\n      {/* Left Sidebar - Performance Insights */}\n      <div className=\"w-80 flex-shrink-0 space-y-4\">\n        <div>\n          <h1 className=\"text-2xl font-bold tracking-tight mb-1\" data-testid=\"text-dashboard-title\">\n            Performance Insights\n          </h1>\n          <p className=\"text-xs text-muted-foreground\">\n            AI-powered KPI analysis\n          </p>\n        </div>\n\n        {/* What's Going Well */}\n        <Card className=\"overflow-hidden border-2 shadow-sm\">\n          <div className=\"h-1.5 bg-gradient-to-r from-green-500 to-green-400\" />\n          <CardHeader className=\"pb-3\">\n            <div className=\"flex items-center gap-2\">\n              <CheckCircle className=\"h-5 w-5 text-green-600\" />\n              <CardTitle className=\"text-base\">What's Going Well</CardTitle>\n            </div>\n          </CardHeader>\n          <CardContent>\n            {statsLoading ? (\n              <div className=\"space-y-2\">\n                <Skeleton className=\"h-4 w-full\" />\n                <Skeleton className=\"h-4 w-full\" />\n                <Skeleton className=\"h-4 w-3/4\" />\n              </div>\n            ) : (\n              <ul className=\"space-y-2 text-sm\">\n                {goingWell.map((item, index) => (\n                  <li key={index} className=\"flex items-start gap-2\">\n                    <span className=\"text-green-600 mt-0.5\">•</span>\n                    <span className=\"text-muted-foreground\">{item}</span>\n                  </li>\n                ))}\n              </ul>\n            )}\n          </CardContent>\n        </Card>\n\n        {/* Section Separator */}\n        <div className=\"relative py-2\">\n          <div className=\"absolute inset-0 flex items-center\">\n            <div className=\"w-full border-t border-border\" />\n          </div>\n          <div className=\"relative flex justify-center\">\n            <span className=\"bg-background px-3 text-xs text-muted-foreground\">Performance Analysis</span>\n          </div>\n        </div>\n\n        {/* Improvement Areas */}\n        <Card className=\"overflow-hidden border-2 shadow-sm\">\n          <div className=\"h-1.5 bg-gradient-to-r from-orange-500 to-orange-400\" />\n          <CardHeader className=\"pb-3\">\n            <div className=\"flex items-center gap-2\">\n              <AlertCircle className=\"h-5 w-5 text-orange-600\" />\n              <CardTitle className=\"text-base\">Improvement Areas</CardTitle>\n            </div>\n          </CardHeader>\n          <CardContent>\n            {statsLoading ? (\n              <div className=\"space-y-2\">\n                <Skeleton className=\"h-4 w-full\" />\n                <Skeleton className=\"h-4 w-full\" />\n                <Skeleton className=\"h-4 w-3/4\" />\n              </div>\n            ) : (\n              <ul className=\"space-y-2 text-sm\">\n                {improvementAreas.map((item, index) => (\n                  <li key={index} className=\"flex items-start gap-2\">\n                    <span className=\"text-orange-600 mt-0.5\">•</span>\n                    <span className=\"text-muted-foreground\">{item}</span>\n                  </li>\n                ))}\n              </ul>\n            )}\n          </CardContent>\n        </Card>\n\n        {/* Section Separator */}\n        <div className=\"relative py-2\">\n          <div className=\"absolute inset-0 flex items-center\">\n            <div className=\"w-full border-t border-border\" />\n          </div>\n          <div className=\"relative flex justify-center\">\n            <span className=\"bg-background px-3 text-xs text-muted-foreground\">Partner Solutions</span>\n          </div>\n        </div>\n\n        {/* BizMate-ai Placeholder */}\n        <Card className=\"overflow-hidden border-2 shadow-lg\" data-testid=\"card-bizmate-placeholder\">\n          <div className=\"relative\">\n            <img \n              src={businessManImg} \n              alt=\"Professional Business Executive\" \n              className=\"w-full h-64 object-cover\"\n            />\n            <div className=\"absolute inset-0 bg-gradient-to-t from-black/80 via-black/40 to-transparent flex items-end\">\n              <div className=\"p-6 w-full\">\n                <h3 className=\"text-white text-2xl font-bold mb-1\" data-testid=\"text-bizmate-title\">BizMate-ai</h3>\n                <p className=\"text-white/90 text-base\">Smart Business. Simplified Compliance.</p>\n              </div>\n            </div>\n          </div>\n        </Card>\n      </div>\n\n      {/* Main Dashboard Content */}\n      <div className=\"flex-1 space-y-6\">\n        <div>\n          <h1 className=\"text-2xl font-bold tracking-tight mb-1\">\n            Management Dashboard\n          </h1>\n          <p className=\"text-sm text-muted-foreground\">\n            Real-time overview of estate operations and financial metrics\n          </p>\n        </div>\n      \n      {/* KEY METRICS SECTION */}\n      <div className=\"space-y-3\">\n        <div className=\"flex items-center gap-3\">\n          <div className=\"h-px flex-1 bg-gradient-to-r from-primary/60 to-transparent\" />\n          <h2 className=\"text-sm font-semibold tracking-wide text-muted-foreground uppercase\" data-testid=\"heading-key-metrics\">\n            Key Financial Metrics\n          </h2>\n          <div className=\"h-px flex-1 bg-gradient-to-l from-primary/60 to-transparent\" />\n        </div>\n        \n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n        {/* Collection this month */}\n        <Card className=\"overflow-hidden border-2 hover-elevate transition-all\" data-testid=\"card-collections\">\n          <div className=\"h-1.5 bg-gradient-to-r from-green-500 to-green-400\" />\n          <CardHeader className=\"pb-2\">\n            <div className=\"flex items-start justify-between\">\n              <CardTitle className=\"text-sm font-medium text-muted-foreground\">\n                Collection this month\n              </CardTitle>\n              <TrendingUp className=\"h-5 w-5 text-green-500\" />\n            </div>\n          </CardHeader>\n          <CardContent className=\"space-y-2\">\n            {statsLoading ? (\n              <Skeleton className=\"h-8 w-24\" />\n            ) : (\n              <div className=\"text-2xl font-bold text-green-600\" data-testid=\"text-collections\">\n                {formatNaira(totalCollections)}\n              </div>\n            )}\n            <div className=\"text-xs text-muted-foreground space-y-0.5\">\n              <div>Outstanding: {formatNaira(accountsReceivable)}</div>\n              <div>Total payments received</div>\n            </div>\n            <Link href=\"/admin/collections\" asChild>\n              <a className=\"text-xs text-blue-600 hover:underline cursor-pointer\" data-testid=\"link-collections-report\">\n                View all collections →\n              </a>\n            </Link>\n          </CardContent>\n        </Card>\n\n        {/* Total Expenses */}\n        <Card className=\"overflow-hidden border-2 hover-elevate transition-all\" data-testid=\"card-expenses\">\n          <div className=\"h-1.5 bg-gradient-to-r from-red-500 to-red-400\" />\n          <CardHeader className=\"pb-2\">\n            <div className=\"flex items-start justify-between\">\n              <CardTitle className=\"text-sm font-medium text-muted-foreground\">\n                Total Expenses\n              </CardTitle>\n              <TrendingDown className=\"h-5 w-5 text-red-500\" />\n            </div>\n          </CardHeader>\n          <CardContent className=\"space-y-2\">\n            {statsLoading ? (\n              <Skeleton className=\"h-8 w-24\" />\n            ) : (\n              <div className=\"text-2xl font-bold text-red-600\" data-testid=\"text-expenses\">\n                {formatNaira(totalExpenses)}\n              </div>\n            )}\n            <div className=\"text-xs text-muted-foreground space-y-0.5\">\n              <div>Approved: {formatNaira(totalExpenses)}</div>\n              <div>Paid: {formatNaira(paidExpenses)}</div>\n            </div>\n            <Link href=\"/accountant/accounts-payable\" asChild>\n              <a className=\"text-xs text-blue-600 hover:underline cursor-pointer\" data-testid=\"link-expenses-report\">\n                View Accounts Payable →\n              </a>\n            </Link>\n          </CardContent>\n        </Card>\n\n        {/* Accounts Receivable */}\n        <Card className=\"overflow-hidden border-2 hover-elevate transition-all\" data-testid=\"card-ar\">\n          <div className=\"h-1.5 bg-gradient-to-r from-blue-500 to-blue-400\" />\n          <CardHeader className=\"pb-2\">\n            <div className=\"flex items-start justify-between\">\n              <CardTitle className=\"text-sm font-medium text-muted-foreground\">\n                Accounts Receivable\n              </CardTitle>\n              <DollarSign className=\"h-5 w-5 text-blue-500\" />\n            </div>\n          </CardHeader>\n          <CardContent className=\"space-y-2\">\n            {statsLoading ? (\n              <Skeleton className=\"h-8 w-24\" />\n            ) : (\n              <div className=\"text-2xl font-bold text-blue-600\" data-testid=\"text-ar\">\n                {formatNaira(accountsReceivable)}\n              </div>\n            )}\n            <div className=\"text-xs text-muted-foreground space-y-0.5\">\n              <div>Current: {formatNaira(currentBalance)}</div>\n              <div>Overdue: {formatNaira(arOverdue)}</div>\n            </div>\n            <Link href=\"/admin/reports?type=ar\" asChild>\n              <a className=\"text-xs text-blue-600 hover:underline cursor-pointer\" data-testid=\"link-ar-report\">\n                Click to view PDF report\n              </a>\n            </Link>\n          </CardContent>\n        </Card>\n\n        {/* Accounts Payable */}\n        <Card className=\"overflow-hidden border-2 hover-elevate transition-all\" data-testid=\"card-ap\">\n          <div className=\"h-1.5 bg-gradient-to-r from-orange-500 to-orange-400\" />\n          <CardHeader className=\"pb-2\">\n            <div className=\"flex items-start justify-between\">\n              <CardTitle className=\"text-sm font-medium text-muted-foreground\">\n                Accounts Payable\n              </CardTitle>\n              <DollarSign className=\"h-5 w-5 text-orange-500\" />\n            </div>\n          </CardHeader>\n          <CardContent className=\"space-y-2\">\n            {statsLoading ? (\n              <Skeleton className=\"h-8 w-24\" />\n            ) : (\n              <div className=\"text-2xl font-bold text-orange-600\" data-testid=\"text-ap\">\n                {formatNaira(accountsPayable)}\n              </div>\n            )}\n            <div className=\"text-xs text-muted-foreground space-y-0.5\">\n              <div>Pending: {formatNaira(apPending)}</div>\n              <div>Approved: {formatNaira(apApproved)}</div>\n            </div>\n            <Link href=\"/accountant/accounts-payable\" asChild>\n              <a className=\"text-xs text-blue-600 hover:underline cursor-pointer\" data-testid=\"link-ap-report\">\n                Manage payments →\n              </a>\n            </Link>\n          </CardContent>\n        </Card>\n      </div>\n      </div>\n\n      {/* AGING ANALYSIS SECTION */}\n      <div className=\"space-y-3\">\n        <div className=\"flex items-center gap-3\">\n          <div className=\"h-px flex-1 bg-gradient-to-r from-yellow-500/60 to-transparent\" />\n          <h2 className=\"text-sm font-semibold tracking-wide text-muted-foreground uppercase\" data-testid=\"heading-aging-analysis\">\n            Collections Aging Analysis\n          </h2>\n          <div className=\"h-px flex-1 bg-gradient-to-l from-yellow-500/60 to-transparent\" />\n        </div>\n        \n        <Card className=\"overflow-hidden border-2\" data-testid=\"card-aging\">\n          <div className=\"h-1.5 bg-gradient-to-r from-yellow-500 to-yellow-400\" />\n        <CardHeader>\n          <div className=\"flex items-center justify-between\">\n            <CardTitle className=\"text-base font-semibold\">\n              Aging Analysis - Overdue Collections\n            </CardTitle>\n            <div className=\"text-right\">\n              {agingLoading ? (\n                <Skeleton className=\"h-6 w-24\" />\n              ) : (\n                <>\n                  <div className=\"text-xs text-muted-foreground mb-0.5\">{totalOverdueCount} Overdue</div>\n                  <div className=\"text-xl font-bold text-red-600\" data-testid=\"text-total-overdue\">\n                    {formatNaira(totalOverdue)}\n                  </div>\n                </>\n              )}\n            </div>\n          </div>\n        </CardHeader>\n        <CardContent>\n          {agingLoading ? (\n            <Skeleton className=\"h-24 w-full mb-3\" />\n          ) : (\n            <>\n              <div className=\"h-24 mb-3\">\n                <ResponsiveContainer width=\"100%\" height=\"100%\">\n                  <BarChart data={agingData}>\n                    <CartesianGrid strokeDasharray=\"3 3\" />\n                    <XAxis dataKey=\"name\" tick={{ fontSize: 11 }} />\n                    <YAxis tick={{ fontSize: 11 }} />\n                    <Tooltip formatter={(value) => formatNaira(Number(value))} />\n                    <Bar dataKey=\"amount\" fill=\"#3b82f6\" name=\"Outstanding Amount\" />\n                  </BarChart>\n                </ResponsiveContainer>\n              </div>\n              \n              {/* Aging Breakdown */}\n              <div className=\"grid grid-cols-5 gap-2\">\n                {agingData.map((item) => (\n                  <div\n                    key={item.name}\n                    className=\"border rounded-md p-2 text-center\"\n                    data-testid={`aging-bucket-${item.name.toLowerCase().replace(/\\s+/g, '-')}`}\n                  >\n                    <div className=\"text-xs text-muted-foreground mb-0.5\">{item.name}</div>\n                    <div className=\"text-sm font-bold\">{formatNaira(item.amount)}</div>\n                    <div className=\"text-xs text-muted-foreground\">{item.inv} inv</div>\n                  </div>\n                ))}\n              </div>\n            </>\n          )}\n        </CardContent>\n      </Card>\n      </div>\n\n      {/* PERFORMANCE TRENDS SECTION */}\n      <div className=\"space-y-3\">\n        <div className=\"flex items-center gap-3\">\n          <div className=\"h-px flex-1 bg-gradient-to-r from-purple-500/60 to-transparent\" />\n          <h2 className=\"text-sm font-semibold tracking-wide text-muted-foreground uppercase\" data-testid=\"heading-performance-trends\">\n            Performance Trends & Analytics\n          </h2>\n          <div className=\"h-px flex-1 bg-gradient-to-l from-purple-500/60 to-transparent\" />\n        </div>\n        \n        <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-4\">\n          {/* Budget vs Expenses Month-to-Date */}\n          <Card className=\"overflow-hidden border-2 hover-elevate transition-all\" data-testid=\"card-budget-vs-expenses\">\n            <div className=\"h-1.5 bg-gradient-to-r from-purple-500 to-purple-400\" />\n          <CardHeader>\n            <div className=\"flex items-center justify-between\">\n              <CardTitle className=\"text-base font-semibold\">\n                Budget vs Expenses (Month-to-Date)\n              </CardTitle>\n              <div className=\"text-right\">\n                {budgetVsExpensesLoading ? (\n                  <Skeleton className=\"h-6 w-24\" />\n                ) : (\n                  <div className=\"text-sm font-semibold\">\n                    Variance: {formatNaira(budgetVariance)}\n                  </div>\n                )}\n              </div>\n            </div>\n          </CardHeader>\n          <CardContent>\n            {budgetVsExpensesLoading ? (\n              <Skeleton className=\"h-24 w-full\" />\n            ) : budgetVsExpensesData.length === 0 ? (\n              <div className=\"h-24 flex items-center justify-center text-muted-foreground text-sm\">\n                No active budget for current month\n              </div>\n            ) : (\n              <div className=\"h-24\">\n                <ResponsiveContainer width=\"100%\" height=\"100%\">\n                  <BarChart data={budgetVsExpensesData}>\n                    <CartesianGrid strokeDasharray=\"3 3\" />\n                    <XAxis dataKey=\"account\" angle={-45} textAnchor=\"end\" height={50} tick={{ fontSize: 10 }} />\n                    <YAxis tick={{ fontSize: 11 }} />\n                    <Tooltip formatter={(value) => formatNaira(Number(value))} />\n                    <Legend wrapperStyle={{ fontSize: '11px' }} />\n                    <Bar dataKey=\"budget\" fill=\"#3b82f6\" name=\"Budget\" />\n                    <Bar dataKey=\"actual\" fill=\"#ef4444\" name=\"Actual\" />\n                  </BarChart>\n                </ResponsiveContainer>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n\n          {/* Collections & Expenses */}\n          <Card className=\"overflow-hidden border-2 hover-elevate transition-all\" data-testid=\"card-collections-expenses\">\n            <div className=\"h-1.5 bg-gradient-to-r from-orange-400 to-orange-300\" />\n          <CardHeader>\n            <div className=\"flex items-center justify-between\">\n              <CardTitle className=\"text-base font-semibold\">\n                Collections & Expenses\n              </CardTitle>\n              <div className=\"text-right\">\n                {collectionsLoading ? (\n                  <Skeleton className=\"h-6 w-24\" />\n                ) : (\n                  <div className=\"text-sm font-semibold\">Net: {formatNaira(collectionsNet)}</div>\n                )}\n              </div>\n            </div>\n          </CardHeader>\n          <CardContent>\n            {collectionsLoading ? (\n              <Skeleton className=\"h-24 w-full\" />\n            ) : (\n              <div className=\"h-24\">\n                <ResponsiveContainer width=\"100%\" height=\"100%\">\n                  <BarChart data={collectionsExpensesData}>\n                    <CartesianGrid strokeDasharray=\"3 3\" />\n                    <XAxis dataKey=\"month\" tick={{ fontSize: 11 }} />\n                    <YAxis tick={{ fontSize: 11 }} />\n                    <Tooltip />\n                    <Legend wrapperStyle={{ fontSize: '11px' }} />\n                    <Bar dataKey=\"collections\" fill=\"#f97316\" name=\"Collections\" />\n                    <Bar dataKey=\"expenses\" fill=\"#dc2626\" name=\"Expenses\" />\n                  </BarChart>\n                </ResponsiveContainer>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n        </div>\n      </div>\n      </div>\n    </div>\n  );\n}\n","size_bytes":25079},"drizzle.config.ts":{"content":"import { defineConfig } from \"drizzle-kit\";\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\"DATABASE_URL, ensure the database is provisioned\");\n}\n\nexport default defineConfig({\n  out: \"./migrations\",\n  schema: \"./shared/schema.ts\",\n  dialect: \"postgresql\",\n  dbCredentials: {\n    url: process.env.DATABASE_URL,\n  },\n});\n","size_bytes":325},"client/src/components/ui/table.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Table = React.forwardRef<\n  HTMLTableElement,\n  React.HTMLAttributes<HTMLTableElement>\n>(({ className, ...props }, ref) => (\n  <div className=\"relative w-full overflow-auto\">\n    <table\n      ref={ref}\n      className={cn(\"w-full caption-bottom text-sm\", className)}\n      {...props}\n    />\n  </div>\n))\nTable.displayName = \"Table\"\n\nconst TableHeader = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <thead ref={ref} className={cn(\"[&_tr]:border-b\", className)} {...props} />\n))\nTableHeader.displayName = \"TableHeader\"\n\nconst TableBody = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tbody\n    ref={ref}\n    className={cn(\"[&_tr:last-child]:border-0\", className)}\n    {...props}\n  />\n))\nTableBody.displayName = \"TableBody\"\n\nconst TableFooter = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tfoot\n    ref={ref}\n    className={cn(\n      \"border-t bg-muted/50 font-medium [&>tr]:last:border-b-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableFooter.displayName = \"TableFooter\"\n\nconst TableRow = React.forwardRef<\n  HTMLTableRowElement,\n  React.HTMLAttributes<HTMLTableRowElement>\n>(({ className, ...props }, ref) => (\n  <tr\n    ref={ref}\n    className={cn(\n      \"border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nTableRow.displayName = \"TableRow\"\n\nconst TableHead = React.forwardRef<\n  HTMLTableCellElement,\n  React.ThHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <th\n    ref={ref}\n    className={cn(\n      \"h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableHead.displayName = \"TableHead\"\n\nconst TableCell = React.forwardRef<\n  HTMLTableCellElement,\n  React.TdHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <td\n    ref={ref}\n    className={cn(\"p-4 align-middle [&:has([role=checkbox])]:pr-0\", className)}\n    {...props}\n  />\n))\nTableCell.displayName = \"TableCell\"\n\nconst TableCaption = React.forwardRef<\n  HTMLTableCaptionElement,\n  React.HTMLAttributes<HTMLTableCaptionElement>\n>(({ className, ...props }, ref) => (\n  <caption\n    ref={ref}\n    className={cn(\"mt-4 text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nTableCaption.displayName = \"TableCaption\"\n\nexport {\n  Table,\n  TableHeader,\n  TableBody,\n  TableFooter,\n  TableHead,\n  TableRow,\n  TableCell,\n  TableCaption,\n}\n","size_bytes":2765},"server/storage.ts":{"content":"import {\n  users,\n  residents,\n  bills,\n  payments,\n  visitors,\n  notifications,\n  accessLogs,\n  announcements,\n  accounts,\n  transactionTemplates,\n  journalEntries,\n  journalEntryLines,\n  vendors,\n  expenses,\n  budgets,\n  budgetLines,\n  bankStatements,\n  bankStatementEntries,\n  paymentApplications,\n  subscriptions,\n  invoiceSequences,\n  userInvites,\n  type User,\n  type UpsertUser,\n  type Resident,\n  type InsertResident,\n  type Bill,\n  type InsertBill,\n  type Payment,\n  type InsertPayment,\n  type Visitor,\n  type InsertVisitor,\n  type Notification,\n  type InsertNotification,\n  type AccessLog,\n  type InsertAccessLog,\n  type Announcement,\n  type InsertAnnouncement,\n  type Account,\n  type InsertAccount,\n  type TransactionTemplate,\n  type InsertTransactionTemplate,\n  type JournalEntry,\n  type InsertJournalEntry,\n  type JournalEntryLine,\n  type InsertJournalEntryLine,\n  type Vendor,\n  type InsertVendor,\n  type Expense,\n  type InsertExpense,\n  type Budget,\n  type InsertBudget,\n  type BudgetLine,\n  type InsertBudgetLine,\n  type BankStatement,\n  type InsertBankStatement,\n  type BankStatementEntry,\n  type InsertBankStatementEntry,\n  type PaymentApplication,\n  type InsertPaymentApplication,\n  type Subscription,\n  type InsertSubscription,\n  type InvoiceSequence,\n  type InsertInvoiceSequence,\n  type UserInvite,\n  type InsertUserInvite,\n} from \"@shared/schema\";\nimport { db } from \"./db\";\nimport { eq, desc, and, or, gte, lte, sql, isNotNull } from \"drizzle-orm\";\n\nexport interface IStorage {\n  // User operations (required for Replit Auth)\n  getUser(id: string): Promise<User | undefined>;\n  getAllUsers(): Promise<User[]>;\n  upsertUser(user: UpsertUser): Promise<User>;\n  updateUser(id: string, data: Partial<UpsertUser>): Promise<User>;\n  deactivateUser(id: string, isActive: boolean): Promise<User>;\n  \n  // Resident operations\n  getResident(id: string): Promise<Resident | undefined>;\n  getResidentByUserId(userId: string): Promise<Resident | undefined>;\n  getResidentWithUser(id: string): Promise<any>;\n  getAllResidents(): Promise<any[]>;\n  createResident(resident: InsertResident): Promise<Resident>;\n  updateResident(id: string, data: Partial<InsertResident>): Promise<Resident>;\n  updateResidentBalance(id: string, balance: string): Promise<void>;\n  updateResidentStatus(id: string, status: string): Promise<void>;\n  \n  // Bill operations\n  getBill(id: string): Promise<Bill | undefined>;\n  getBillsByResidentId(residentId: string): Promise<Bill[]>;\n  getRecentBillsByResidentId(residentId: string, limit: number): Promise<Bill[]>;\n  getAllBills(): Promise<Bill[]>;\n  createBill(bill: InsertBill): Promise<Bill>;\n  updateBillStatus(id: string, status: string): Promise<void>;\n  \n  // Automated Billing operations\n  generateBillForResident(residentId: string, createdByUserId: string): Promise<Bill | null>;\n  generateAutomatedServiceChargeBills(createdByUserId: string): Promise<{\n    success: number;\n    failed: number;\n    generatedBills?: Bill[];\n    bills: Bill[];\n    errors: Array<{ residentId: string; unitNumber: string; error: string }>;\n  }>;\n  sendInvoiceEmailsForBills(bills: Bill[]): Promise<{ sent: number; failed: number }>;\n  \n  // Payment operations\n  getPayment(id: string): Promise<Payment | undefined>;\n  getPaymentsByResidentId(residentId: string): Promise<Payment[]>;\n  getPaymentsByBillId(billId: string): Promise<Payment[]>;\n  getAllPayments(): Promise<Payment[]>;\n  createPayment(payment: InsertPayment): Promise<Payment>;\n  \n  // Visitor operations\n  getVisitor(id: string): Promise<Visitor | undefined>;\n  getVisitorByAccessCode(code: string): Promise<Visitor | undefined>;\n  getVisitorsByResidentId(residentId: string): Promise<Visitor[]>;\n  getActiveVisitorsByResidentId(residentId: string): Promise<Visitor[]>;\n  getTodayVisitors(): Promise<Visitor[]>;\n  createVisitor(visitor: InsertVisitor): Promise<Visitor>;\n  updateVisitorStatus(id: string, status: string, usedAt?: Date): Promise<void>;\n  \n  // Notification operations\n  getNotification(id: string): Promise<Notification | undefined>;\n  getNotificationsByUserId(userId: string): Promise<Notification[]>;\n  createNotification(notification: InsertNotification): Promise<Notification>;\n  markNotificationAsRead(id: string): Promise<void>;\n  markAllNotificationsAsRead(userId: string): Promise<void>;\n  \n  // Access Log operations\n  getAccessLog(id: string): Promise<AccessLog | undefined>;\n  getRecentAccessLogs(limit: number): Promise<AccessLog[]>;\n  createAccessLog(log: InsertAccessLog): Promise<AccessLog>;\n  \n  // Announcement operations\n  getAnnouncement(id: string): Promise<Announcement | undefined>;\n  getAllAnnouncements(): Promise<Announcement[]>;\n  createAnnouncement(announcement: InsertAnnouncement): Promise<Announcement>;\n  \n  // Dashboard stats\n  getAdminStats(): Promise<any>;\n  \n  // Accounting operations\n  // Chart of Accounts\n  getAccount(id: string): Promise<Account | undefined>;\n  getAccountByNumber(accountNumber: string): Promise<Account | undefined>;\n  getAllAccounts(): Promise<Account[]>;\n  getAccountsByType(accountType: string): Promise<Account[]>;\n  getActiveAccounts(): Promise<Account[]>;\n  createAccount(account: InsertAccount): Promise<Account>;\n  updateAccount(id: string, data: Partial<InsertAccount>): Promise<Account>;\n  deleteAccount(id: string): Promise<void>;\n  updateAccountBalance(id: string, amount: string, lineType: 'debit' | 'credit'): Promise<void>;\n  \n  // Transaction Templates\n  getTransactionTemplate(id: string): Promise<any>;\n  getTransactionTemplateByType(transactionType: string): Promise<any>;\n  getAllTransactionTemplates(): Promise<any[]>;\n  getActiveTransactionTemplates(): Promise<any[]>;\n  createTransactionTemplate(template: InsertTransactionTemplate): Promise<TransactionTemplate>;\n  updateTransactionTemplate(id: string, data: Partial<InsertTransactionTemplate>): Promise<TransactionTemplate>;\n  deleteTransactionTemplate(id: string): Promise<void>;\n  \n  // Journal Entries\n  getJournalEntry(id: string): Promise<any>;\n  getJournalEntryWithLines(id: string): Promise<any>;\n  getAllJournalEntries(): Promise<any[]>;\n  getJournalEntriesByDateRange(startDate: Date, endDate: Date): Promise<any[]>;\n  getJournalEntriesByReferenceId(referenceId: string): Promise<any[]>;\n  createJournalEntry(entry: InsertJournalEntry, lines: InsertJournalEntryLine[]): Promise<JournalEntry>;\n  voidJournalEntry(id: string): Promise<void>;\n  generateEntryNumber(entryDate: Date): Promise<string>;\n  generateInvoiceNumber(): Promise<string>;\n  \n  // Financial Reports\n  getTrialBalance(asOf: Date): Promise<any>;\n  getIncomeStatement(startDate: Date, endDate: Date): Promise<any>;\n  getBalanceSheet(asOf: Date): Promise<any>;\n  \n  // Vendor operations\n  getVendor(id: string): Promise<Vendor | undefined>;\n  getVendorByTin(tinNumber: string): Promise<Vendor | undefined>;\n  getAllVendors(): Promise<Vendor[]>;\n  getVendorsByStatus(status: string): Promise<Vendor[]>;\n  createVendor(vendor: InsertVendor): Promise<Vendor>;\n  updateVendor(id: string, data: Partial<InsertVendor>): Promise<Vendor>;\n  approveVendor(id: string, approvedBy: string): Promise<Vendor>;\n  rejectVendor(id: string, approvedBy: string, reason: string): Promise<Vendor>;\n  getVendorAccountStatement(vendorId: string, startDate?: Date, endDate?: Date): Promise<any>;\n  getVendorOutstandingBills(): Promise<Record<string, number>>;\n  \n  // Expense operations\n  getExpense(id: string): Promise<any>;\n  getAllExpenses(): Promise<any[]>;\n  getExpensesByStatus(status: string): Promise<any[]>;\n  getExpensesBySubmitter(userId: string): Promise<any[]>;\n  createExpense(expense: InsertExpense): Promise<Expense>;\n  approveExpense(id: string, reviewedBy: string): Promise<Expense>;\n  rejectExpense(id: string, reviewedBy: string, reason: string): Promise<Expense>;\n  \n  // Accounts Payable operations\n  getApprovedExpensesForPayment(): Promise<any[]>;\n  getBankAccounts(): Promise<Account[]>;\n  processExpensePayment(\n    expenseId: string,\n    paidFromAccountId: string,\n    paidBy: string,\n    whtRate: string\n  ): Promise<Expense>;\n  approveExpenseForPaymentLater(id: string, paidBy: string, whtRate: string): Promise<Expense>;\n  \n  // Budget operations\n  getBudget(id: string): Promise<any>;\n  getBudgetWithLines(id: string): Promise<any>;\n  getAllBudgets(): Promise<any[]>;\n  getActiveBudgets(): Promise<any[]>;\n  getBudgetsByFiscalYear(fiscalYear: number): Promise<any[]>;\n  createBudget(budget: InsertBudget, lines: InsertBudgetLine[]): Promise<Budget>;\n  updateBudget(id: string, data: Partial<InsertBudget>): Promise<Budget>;\n  deleteBudget(id: string): Promise<void>;\n  activateBudget(id: string): Promise<Budget>;\n  closeBudget(id: string): Promise<Budget>;\n  updateBudgetConsumption(budgetId: string, accountId: string, amount: string): Promise<void>;\n  getBudgetLineByAccount(budgetId: string, accountId: string): Promise<any>;\n  getActiveBudgetForAccount(accountId: string): Promise<any>;\n  \n  // Accounts Receivable operations\n  getAllAREntries(): Promise<any[]>;\n  getAREntry(billId: string): Promise<any>;\n  applyPaymentToBill(\n    billId: string,\n    amountApplied: string,\n    applicationType: 'bank_statement' | 'manual',\n    paymentDate: Date,\n    appliedBy: string,\n    bankName?: string,\n    accountNumber?: string,\n    bankStatementEntryId?: string,\n    notes?: string\n  ): Promise<void>;\n  \n  // Bank Statement operations\n  createBankStatement(statement: any): Promise<any>;\n  getBankStatement(id: string): Promise<any>;\n  getAllBankStatements(): Promise<any[]>;\n  updateBankStatementStatus(id: string, status: string): Promise<void>;\n  \n  // Bank Statement Entry operations\n  createBankStatementEntry(entry: any): Promise<any>;\n  getBankStatementEntries(statementId: string): Promise<any[]>;\n  getUnreconciledEntries(): Promise<any[]>;\n  updateEntryStatus(id: string, status: string): Promise<void>;\n  \n  // Payment Application operations\n  getPaymentApplicationsByBill(billId: string): Promise<any[]>;\n  getAllPaymentApplications(): Promise<any[]>;\n  \n  // User Invite operations\n  createUserInvite(invite: InsertUserInvite): Promise<UserInvite>;\n  getUserInvite(inviteToken: string): Promise<UserInvite | undefined>;\n  getAcceptedInviteByUserId(userId: string): Promise<UserInvite | undefined>;\n  getAllUserInvites(): Promise<UserInvite[]>;\n  acceptUserInvite(inviteToken: string, userId: string): Promise<void>;\n  expireUserInvite(id: string): Promise<void>;\n}\n\nexport class DatabaseStorage implements IStorage {\n  // User operations\n  async getUser(id: string): Promise<User | undefined> {\n    const [user] = await db.select().from(users).where(eq(users.id, id));\n    return user;\n  }\n\n  async getAllUsers(): Promise<User[]> {\n    const allUsers = await db\n      .select()\n      .from(users)\n      .orderBy(desc(users.createdAt));\n    return allUsers;\n  }\n\n  async upsertUser(userData: UpsertUser): Promise<User> {\n    const [user] = await db\n      .insert(users)\n      .values(userData)\n      .onConflictDoUpdate({\n        target: users.email,\n        set: {\n          ...userData,\n          updatedAt: new Date(),\n        },\n      })\n      .returning();\n    return user;\n  }\n\n  async updateUser(id: string, data: Partial<UpsertUser>): Promise<User> {\n    const [user] = await db\n      .update(users)\n      .set({\n        ...data,\n        updatedAt: new Date(),\n      })\n      .where(eq(users.id, id))\n      .returning();\n    return user;\n  }\n\n  async deactivateUser(id: string, isActive: boolean): Promise<User> {\n    const [user] = await db\n      .update(users)\n      .set({\n        isActive,\n        updatedAt: new Date(),\n      })\n      .where(eq(users.id, id))\n      .returning();\n    return user;\n  }\n\n  // Resident operations\n  async getResident(id: string): Promise<Resident | undefined> {\n    const [resident] = await db.select().from(residents).where(eq(residents.id, id));\n    return resident;\n  }\n\n  async getResidentByUserId(userId: string): Promise<Resident | undefined> {\n    const [resident] = await db.select().from(residents).where(eq(residents.userId, userId));\n    return resident;\n  }\n\n  async getResidentWithUser(id: string): Promise<any> {\n    const [resident] = await db\n      .select()\n      .from(residents)\n      .leftJoin(users, eq(residents.userId, users.id))\n      .where(eq(residents.id, id));\n    return resident;\n  }\n\n  async getAllResidents(): Promise<any[]> {\n    const allResidents = await db\n      .select()\n      .from(residents)\n      .leftJoin(users, eq(residents.userId, users.id))\n      .orderBy(desc(residents.createdAt));\n    return allResidents;\n  }\n\n  async getAllCollections(): Promise<any[]> {\n    const collections = await db\n      .select()\n      .from(paymentApplications)\n      .leftJoin(bills, eq(paymentApplications.billId, bills.id))\n      .leftJoin(residents, eq(bills.residentId, residents.id))\n      .leftJoin(users, eq(residents.userId, users.id))\n      .orderBy(desc(paymentApplications.paymentDate));\n    \n    // Transform the result to match expected structure\n    return collections.map(row => ({\n      id: row.payment_applications.id,\n      billId: row.payment_applications.billId,\n      amountApplied: row.payment_applications.amountApplied,\n      applicationType: row.payment_applications.applicationType,\n      bankName: row.payment_applications.bankName,\n      accountNumber: row.payment_applications.accountNumber,\n      paymentDate: row.payment_applications.paymentDate,\n      appliedBy: row.payment_applications.appliedBy,\n      appliedAt: row.payment_applications.appliedAt,\n      notes: row.payment_applications.notes,\n      bill: row.bills ? {\n        id: row.bills.id,\n        invoiceNumber: row.bills.invoiceNumber,\n        description: row.bills.description,\n        amount: row.bills.amount,\n        resident: row.residents && row.users ? {\n          id: row.residents.id,\n          fullName: `${row.users.firstName || ''} ${row.users.lastName || ''}`.trim(),\n          houseNumber: row.residents.unitNumber,\n        } : null,\n      } : null,\n    }));\n  }\n\n  async getSubscription(): Promise<Subscription | null> {\n    const [subscription] = await db\n      .select()\n      .from(subscriptions)\n      .limit(1);\n    \n    return subscription || null;\n  }\n\n  async updateSubscription(data: { plan: string; billingCycle: string; estateName?: string }, updatedBy: string): Promise<Subscription> {\n    const [existing] = await db\n      .select()\n      .from(subscriptions)\n      .limit(1);\n    \n    // Compute new limits based on plan\n    const planDetails = {\n      'starter': { maxResidents: 50, maxAdmins: 1, maxSecurity: 1, maxAccountants: 0 },\n      'professional': { maxResidents: 200, maxAdmins: 2, maxSecurity: 2, maxAccountants: 1 },\n      'enterprise': { maxResidents: 999999, maxAdmins: 999999, maxSecurity: 999999, maxAccountants: 999999 },\n    }[data.plan];\n\n    const now = new Date();\n    const nextPeriodEnd = new Date();\n    if (data.billingCycle === 'annual') {\n      nextPeriodEnd.setFullYear(nextPeriodEnd.getFullYear() + 1);\n    } else {\n      nextPeriodEnd.setMonth(nextPeriodEnd.getMonth() + 1);\n    }\n\n    if (existing) {\n      // Update existing subscription\n      const [updated] = await db\n        .update(subscriptions)\n        .set({\n          plan: data.plan,\n          billingCycle: data.billingCycle,\n          estateName: data.estateName || existing.estateName,\n          maxResidents: planDetails?.maxResidents || existing.maxResidents,\n          maxAdmins: planDetails?.maxAdmins || existing.maxAdmins,\n          maxSecurity: planDetails?.maxSecurity || existing.maxSecurity,\n          maxAccountants: planDetails?.maxAccountants || existing.maxAccountants,\n          currentPeriodStart: now,\n          currentPeriodEnd: nextPeriodEnd,\n          updatedAt: now,\n        })\n        .where(eq(subscriptions.id, existing.id))\n        .returning();\n      \n      return updated;\n    } else {\n      // Create new subscription\n      const trialEnd = new Date();\n      trialEnd.setDate(trialEnd.getDate() + 30);\n      \n      const [newSubscription] = await db\n        .insert(subscriptions)\n        .values({\n          estateName: data.estateName || 'My Estate',\n          plan: data.plan,\n          status: 'trial',\n          billingCycle: data.billingCycle,\n          currentPeriodStart: now,\n          currentPeriodEnd: trialEnd,\n          trialEndsAt: trialEnd,\n          maxResidents: planDetails?.maxResidents || 50,\n          maxAdmins: planDetails?.maxAdmins || 1,\n          maxSecurity: planDetails?.maxSecurity || 1,\n          maxAccountants: planDetails?.maxAccountants || 0,\n        })\n        .returning();\n      \n      return newSubscription;\n    }\n  }\n\n  async createResident(residentData: InsertResident): Promise<Resident> {\n    const [resident] = await db\n      .insert(residents)\n      .values(residentData)\n      .returning();\n    return resident;\n  }\n\n  async updateResident(id: string, data: Partial<InsertResident>): Promise<Resident> {\n    const [resident] = await db\n      .update(residents)\n      .set({ ...data, updatedAt: new Date() })\n      .where(eq(residents.id, id))\n      .returning();\n    return resident;\n  }\n\n  async updateResidentBalance(id: string, balance: string): Promise<void> {\n    await db\n      .update(residents)\n      .set({ totalBalance: balance, updatedAt: new Date() })\n      .where(eq(residents.id, id));\n  }\n\n  async updateResidentStatus(id: string, status: string): Promise<void> {\n    await db\n      .update(residents)\n      .set({ accountStatus: status as any, updatedAt: new Date() })\n      .where(eq(residents.id, id));\n  }\n\n  // Bill operations\n  async getBill(id: string): Promise<Bill | undefined> {\n    const [bill] = await db.select().from(bills).where(eq(bills.id, id));\n    return bill;\n  }\n\n  async getBillsByResidentId(residentId: string): Promise<Bill[]> {\n    return await db\n      .select()\n      .from(bills)\n      .where(eq(bills.residentId, residentId))\n      .orderBy(desc(bills.dueDate));\n  }\n\n  async getRecentBillsByResidentId(residentId: string, limit: number): Promise<Bill[]> {\n    return await db\n      .select()\n      .from(bills)\n      .where(eq(bills.residentId, residentId))\n      .orderBy(desc(bills.createdAt))\n      .limit(limit);\n  }\n\n  async createBill(billData: InsertBill): Promise<Bill> {\n    // Generate invoice number if not provided\n    // The sequence table with FOR UPDATE locking guarantees uniqueness\n    const invoiceNumber = billData.invoiceNumber || await this.generateInvoiceNumber();\n    \n    const [bill] = await db\n      .insert(bills)\n      .values({\n        ...billData,\n        invoiceNumber,\n      })\n      .returning();\n    return bill;\n  }\n\n  async getAllBills(): Promise<Bill[]> {\n    return await db\n      .select()\n      .from(bills)\n      .orderBy(desc(bills.dueDate));\n  }\n\n  async updateBillStatus(id: string, status: string): Promise<void> {\n    await db\n      .update(bills)\n      .set({ status: status as any, updatedAt: new Date() })\n      .where(eq(bills.id, id));\n  }\n\n  // Automated Billing operations\n  async generateBillForResident(residentId: string, createdByUserId: string): Promise<Bill | null> {\n    try {\n      // Get resident details\n      const resident = await this.getResident(residentId);\n      if (!resident) {\n        console.log(`Resident ${residentId} not found`);\n        return null;\n      }\n\n      // Check eligibility\n      if (resident.accountStatus !== 'active' || \n          !resident.serviceCharge || \n          parseFloat(resident.serviceCharge) <= 0 || \n          !resident.startDate) {\n        console.log(`Resident ${resident.unitNumber} not eligible for billing`);\n        return null;\n      }\n\n      // Get AR account (Accounts Receivable)\n      const arAccount = await this.getAccountByNumber('1100');\n      if (!arAccount) {\n        throw new Error('Accounts Receivable account (1100) not found. Please create it in Chart of Accounts.');\n      }\n\n      // Get Deferred Revenue account (liability account - revenue not yet recognized)\n      const deferredRevenueAccount = await this.getAccountByNumber('2200');\n      if (!deferredRevenueAccount) {\n        throw new Error('Deferred Revenue account (2200) not found. Please create it in Chart of Accounts.');\n      }\n\n      const today = new Date();\n      const startDate = new Date(resident.startDate);\n      const lastBillEndDate = resident.endDate ? new Date(resident.endDate) : null;\n      \n      // Determine billing period start and end\n      let periodStart: Date;\n      let periodEnd: Date;\n      \n      if (!lastBillEndDate || lastBillEndDate < today) {\n        // First bill or previous period ended\n        if (lastBillEndDate) {\n          // Subsequent billing: period starts after last billing end\n          periodStart = new Date(lastBillEndDate);\n          periodStart.setDate(periodStart.getDate() + 1);\n        } else {\n          // First billing: period starts from start date\n          periodStart = new Date(startDate);\n        }\n        \n        // Period end is 12 months from period start\n        periodEnd = new Date(periodStart);\n        periodEnd.setFullYear(periodEnd.getFullYear() + 1);\n        periodEnd.setDate(periodEnd.getDate() - 1); // End on day before next period\n        \n        // Due date is billing date + 7 days\n        const dueDate = new Date(today);\n        dueDate.setDate(dueDate.getDate() + 7);\n        \n        // Create the bill\n        const billData: InsertBill = {\n          residentId: resident.id,\n          billingType: 'Estate Maintenance',\n          description: `Service Charge for ${resident.unitNumber} - Period: ${periodStart.toLocaleDateString()} to ${periodEnd.toLocaleDateString()}`,\n          amount: resident.serviceCharge,\n          totalPaid: \"0.00\",\n          balance: resident.serviceCharge,\n          paymentStatus: 'unpaid',\n          dueDate,\n          status: 'pending',\n          periodStart,\n          periodEnd,\n        };\n        \n        const bill = await this.createBill(billData);\n        \n        // Create journal entry for AR posting with lines\n        const journalEntryData: InsertJournalEntry = {\n          entryDate: today,\n          description: `Service Charge Bill - ${resident.unitNumber} (Bill #${bill.id})`,\n          referenceType: 'bill',\n          referenceId: bill.id,\n          createdBy: createdByUserId,\n          status: 'posted',\n          totalDebit: resident.serviceCharge,\n          totalCredit: resident.serviceCharge,\n        };\n        \n        const journalEntryLines = [\n          {\n            accountId: arAccount.id,\n            lineType: 'debit' as const,\n            amount: resident.serviceCharge,\n            description: `AR - ${resident.unitNumber}`,\n          },\n          {\n            accountId: deferredRevenueAccount.id,\n            lineType: 'credit' as const,\n            amount: resident.serviceCharge,\n            description: `Deferred Revenue - ${resident.unitNumber} (revenue recognized upon payment)`,\n          },\n        ];\n        \n        const journalEntry = await this.createJournalEntry(journalEntryData, journalEntryLines as any);\n        \n        // Link journal entry to bill\n        await db\n          .update(bills)\n          .set({ journalEntryId: journalEntry.id })\n          .where(eq(bills.id, bill.id));\n        \n        // Update resident's end date for next billing cycle\n        await this.updateResident(resident.id, { endDate: periodEnd });\n        \n        // Update resident's total balance\n        const newBalance = (parseFloat(resident.totalBalance || '0') + parseFloat(resident.serviceCharge)).toFixed(2);\n        await this.updateResidentBalance(resident.id, newBalance);\n        \n        // Create notification for resident\n        await this.createNotification({\n          userId: resident.userId,\n          title: 'New Service Charge Bill',\n          message: `A new service charge bill of ₦${parseFloat(resident.serviceCharge).toLocaleString()} has been generated for unit ${resident.unitNumber}. Due date: ${dueDate.toLocaleDateString()}`,\n          type: 'bill',\n        });\n        \n        console.log(`Successfully generated bill for resident ${resident.unitNumber}`);\n        return bill;\n      } else {\n        console.log(`Resident ${resident.unitNumber} has active billing period until ${lastBillEndDate.toLocaleDateString()}`);\n        return null;\n      }\n    } catch (error: any) {\n      console.error(`Error generating bill for resident ${residentId}:`, error.message);\n      throw error;\n    }\n  }\n\n  async generateAutomatedServiceChargeBills(createdByUserId: string): Promise<{\n    success: number;\n    failed: number;\n    bills: Bill[];\n    generatedBills?: Bill[];\n    errors: Array<{ residentId: string; unitNumber: string; error: string }>;\n  }> {\n    const result = {\n      success: 0,\n      failed: 0,\n      bills: [] as Bill[],\n      generatedBills: [] as Bill[],\n      errors: [] as Array<{ residentId: string; unitNumber: string; error: string }>,\n    };\n\n    // Get all active residents with service charge and start date\n    const allResidents = await this.getAllResidents();\n    // Extract resident data from joined result { residents, users }\n    const residentRows = allResidents.map((row: any) => row.residents);\n    const eligibleResidents = residentRows.filter(\n      (r: any) => \n        r.accountStatus === 'active' && \n        r.serviceCharge && \n        parseFloat(r.serviceCharge) > 0 && \n        r.startDate\n    );\n\n    // Get AR account (Accounts Receivable)\n    const arAccount = await this.getAccountByNumber('1100');\n    if (!arAccount) {\n      throw new Error('Accounts Receivable account (1100) not found. Please create it in Chart of Accounts.');\n    }\n\n    // Get Deferred Revenue account (liability account - revenue not yet recognized)\n    const deferredRevenueAccount = await this.getAccountByNumber('2200');\n    if (!deferredRevenueAccount) {\n      throw new Error('Deferred Revenue account (2200) not found. Please create it in Chart of Accounts.');\n    }\n\n    const today = new Date();\n\n    for (const resident of eligibleResidents) {\n      try {\n        const startDate = new Date(resident.startDate);\n        const lastBillEndDate = resident.endDate ? new Date(resident.endDate) : null;\n        \n        // Determine billing period start and end\n        let periodStart: Date;\n        let periodEnd: Date;\n        \n        if (!lastBillEndDate || lastBillEndDate < today) {\n          // First bill or previous period ended\n          if (lastBillEndDate) {\n            // Subsequent billing: period starts after last billing end\n            periodStart = new Date(lastBillEndDate);\n            periodStart.setDate(periodStart.getDate() + 1);\n          } else {\n            // First billing: period starts from start date\n            periodStart = new Date(startDate);\n          }\n          \n          // Period end is 12 months from period start\n          periodEnd = new Date(periodStart);\n          periodEnd.setFullYear(periodEnd.getFullYear() + 1);\n          periodEnd.setDate(periodEnd.getDate() - 1); // End on day before next period\n          \n          // Due date is billing date + 7 days\n          const dueDate = new Date(today);\n          dueDate.setDate(dueDate.getDate() + 7);\n          \n          // Create the bill\n          const billData: InsertBill = {\n            residentId: resident.id,\n            billingType: 'Estate Maintenance',\n            description: `Service Charge for ${resident.unitNumber} - Period: ${periodStart.toLocaleDateString()} to ${periodEnd.toLocaleDateString()}`,\n            amount: resident.serviceCharge,\n            totalPaid: \"0.00\",\n            balance: resident.serviceCharge,\n            paymentStatus: 'unpaid',\n            dueDate,\n            status: 'pending',\n            periodStart,\n            periodEnd,\n          };\n          \n          const bill = await this.createBill(billData);\n          \n          // Create journal entry for AR posting with lines\n          const journalEntryData: InsertJournalEntry = {\n            entryDate: today,\n            description: `Service Charge Bill - ${resident.unitNumber} (Bill #${bill.id})`,\n            referenceType: 'bill',\n            referenceId: bill.id,\n            createdBy: createdByUserId,\n            status: 'posted',\n            totalDebit: resident.serviceCharge,\n            totalCredit: resident.serviceCharge,\n          };\n          \n          const journalEntryLines = [\n            {\n              accountId: arAccount.id,\n              lineType: 'debit' as const,\n              amount: resident.serviceCharge,\n              description: `AR - ${resident.unitNumber}`,\n            },\n            {\n              accountId: deferredRevenueAccount.id,\n              lineType: 'credit' as const,\n              amount: resident.serviceCharge,\n              description: `Deferred Revenue - ${resident.unitNumber} (revenue recognized upon payment)`,\n            },\n          ];\n          \n          const journalEntry = await this.createJournalEntry(journalEntryData, journalEntryLines as any);\n          \n          // Link journal entry to bill\n          await db\n            .update(bills)\n            .set({ journalEntryId: journalEntry.id })\n            .where(eq(bills.id, bill.id));\n          \n          // Update resident's end date for next billing cycle\n          await this.updateResident(resident.id, { endDate: periodEnd });\n          \n          // Update resident's total balance\n          const newBalance = (parseFloat(resident.totalBalance || '0') + parseFloat(resident.serviceCharge)).toFixed(2);\n          await this.updateResidentBalance(resident.id, newBalance);\n          \n          // Create notification for resident\n          await this.createNotification({\n            userId: resident.userId,\n            title: 'New Service Charge Bill',\n            message: `A new service charge bill of ₦${parseFloat(resident.serviceCharge).toLocaleString()} has been generated for unit ${resident.unitNumber}. Due date: ${dueDate.toLocaleDateString()}`,\n            type: 'bill',\n          });\n          \n          result.success++;\n          result.bills.push(bill);\n          result.generatedBills.push(bill);\n        }\n      } catch (error: any) {\n        result.failed++;\n        result.errors.push({\n          residentId: resident.id,\n          unitNumber: resident.unitNumber,\n          error: error.message,\n        });\n      }\n    }\n\n    return result;\n  }\n\n  async sendInvoiceEmailsForBills(billsToEmail: Bill[]): Promise<{ sent: number; failed: number }> {\n    const { sendBulkInvoiceEmails } = await import('./email-service');\n    \n    try {\n      // Get all residents for the bills\n      const residentIdsSet = new Set(billsToEmail.map(b => b.residentId));\n      const residentIds = Array.from(residentIdsSet);\n      const residentsData = await this.getAllResidents();\n      \n      // Create a map of resident ID to resident data with user info\n      const residentsMap = new Map();\n      for (const row of residentsData) {\n        const resident = row.residents;\n        const user = row.users;\n        if (residentIds.includes(resident.id)) {\n          residentsMap.set(resident.id, {\n            ...resident,\n            email: user.email,\n            firstName: user.firstName,\n            lastName: user.lastName,\n          });\n        }\n      }\n      \n      // Send emails\n      console.log(`[Automated Billing] Sending invoice emails for ${billsToEmail.length} bills...`);\n      const result = await sendBulkInvoiceEmails(billsToEmail, residentsMap);\n      console.log(`[Automated Billing] Email sending completed: ${result.sent} sent, ${result.failed} failed`);\n      \n      return result;\n    } catch (error: any) {\n      console.error('[Automated Billing] Error sending invoice emails:', error.message);\n      return { sent: 0, failed: billsToEmail.length };\n    }\n  }\n\n  // Payment operations\n  async getPayment(id: string): Promise<Payment | undefined> {\n    const [payment] = await db.select().from(payments).where(eq(payments.id, id));\n    return payment;\n  }\n\n  async getPaymentsByResidentId(residentId: string): Promise<Payment[]> {\n    return await db\n      .select()\n      .from(payments)\n      .where(eq(payments.residentId, residentId))\n      .orderBy(desc(payments.createdAt));\n  }\n\n  async getPaymentsByBillId(billId: string): Promise<Payment[]> {\n    return await db\n      .select()\n      .from(payments)\n      .where(eq(payments.billId, billId))\n      .orderBy(desc(payments.createdAt));\n  }\n\n  async getAllPayments(): Promise<Payment[]> {\n    return await db\n      .select()\n      .from(payments)\n      .orderBy(desc(payments.createdAt));\n  }\n\n  async createPayment(paymentData: InsertPayment): Promise<Payment> {\n    const [payment] = await db\n      .insert(payments)\n      .values(paymentData)\n      .returning();\n    return payment;\n  }\n\n  // Visitor operations\n  async getVisitor(id: string): Promise<Visitor | undefined> {\n    const [visitor] = await db.select().from(visitors).where(eq(visitors.id, id));\n    return visitor;\n  }\n\n  async getVisitorByAccessCode(code: string): Promise<Visitor | undefined> {\n    const [visitor] = await db.select().from(visitors).where(eq(visitors.accessCode, code));\n    return visitor;\n  }\n\n  async getVisitorsByResidentId(residentId: string): Promise<Visitor[]> {\n    return await db\n      .select()\n      .from(visitors)\n      .where(eq(visitors.residentId, residentId))\n      .orderBy(desc(visitors.createdAt));\n  }\n\n  async getActiveVisitorsByResidentId(residentId: string): Promise<Visitor[]> {\n    const now = new Date();\n    return await db\n      .select()\n      .from(visitors)\n      .where(\n        and(\n          eq(visitors.residentId, residentId),\n          eq(visitors.status, \"approved\"),\n          gte(visitors.validUntil, now)\n        )\n      )\n      .orderBy(desc(visitors.createdAt));\n  }\n\n  async getTodayVisitors(): Promise<Visitor[]> {\n    const today = new Date();\n    today.setHours(0, 0, 0, 0);\n    const tomorrow = new Date(today);\n    tomorrow.setDate(tomorrow.getDate() + 1);\n\n    return await db\n      .select()\n      .from(visitors)\n      .where(\n        and(\n          gte(visitors.validFrom, today),\n          lte(visitors.validFrom, tomorrow)\n        )\n      )\n      .orderBy(desc(visitors.createdAt));\n  }\n\n  async createVisitor(visitorData: InsertVisitor): Promise<Visitor> {\n    const [visitor] = await db\n      .insert(visitors)\n      .values(visitorData)\n      .returning();\n    return visitor;\n  }\n\n  async updateVisitorStatus(id: string, status: string, usedAt?: Date): Promise<void> {\n    await db\n      .update(visitors)\n      .set({ \n        status: status as any,\n        ...(usedAt ? { usedAt } : {})\n      })\n      .where(eq(visitors.id, id));\n  }\n\n  // Notification operations\n  async getNotification(id: string): Promise<Notification | undefined> {\n    const [notification] = await db.select().from(notifications).where(eq(notifications.id, id));\n    return notification;\n  }\n\n  async getNotificationsByUserId(userId: string): Promise<Notification[]> {\n    return await db\n      .select()\n      .from(notifications)\n      .where(eq(notifications.userId, userId))\n      .orderBy(desc(notifications.createdAt));\n  }\n\n  async createNotification(notificationData: InsertNotification): Promise<Notification> {\n    const [notification] = await db\n      .insert(notifications)\n      .values(notificationData)\n      .returning();\n    return notification;\n  }\n\n  async markNotificationAsRead(id: string): Promise<void> {\n    await db\n      .update(notifications)\n      .set({ isRead: true })\n      .where(eq(notifications.id, id));\n  }\n\n  async markAllNotificationsAsRead(userId: string): Promise<void> {\n    await db\n      .update(notifications)\n      .set({ isRead: true })\n      .where(eq(notifications.userId, userId));\n  }\n\n  // Access Log operations\n  async getAccessLog(id: string): Promise<AccessLog | undefined> {\n    const [log] = await db.select().from(accessLogs).where(eq(accessLogs.id, id));\n    return log;\n  }\n\n  async getRecentAccessLogs(limit: number): Promise<AccessLog[]> {\n    return await db\n      .select()\n      .from(accessLogs)\n      .orderBy(desc(accessLogs.createdAt))\n      .limit(limit);\n  }\n\n  async createAccessLog(logData: InsertAccessLog): Promise<AccessLog> {\n    const [log] = await db\n      .insert(accessLogs)\n      .values(logData)\n      .returning();\n    return log;\n  }\n\n  // Announcement operations\n  async getAnnouncement(id: string): Promise<Announcement | undefined> {\n    const [announcement] = await db.select().from(announcements).where(eq(announcements.id, id));\n    return announcement;\n  }\n\n  async getAllAnnouncements(): Promise<Announcement[]> {\n    return await db\n      .select()\n      .from(announcements)\n      .orderBy(desc(announcements.createdAt));\n  }\n\n  async createAnnouncement(announcementData: InsertAnnouncement): Promise<Announcement> {\n    const [announcement] = await db\n      .insert(announcements)\n      .values(announcementData)\n      .returning();\n    return announcement;\n  }\n\n  // Dashboard stats\n  async getAdminStats(): Promise<any> {\n    const allResidents = await db.select().from(residents);\n    const allBills = await db.select().from(bills);\n    const allVisitors = await db.select().from(visitors);\n    const allExpenses = await db.select().from(expenses);\n    const allPaymentApplications = await db.select().from(paymentApplications);\n\n    const totalResidents = allResidents.length;\n    const activeResidents = allResidents.filter(r => r.accountStatus === \"active\").length;\n    const delinquentResidents = allResidents.filter(r => r.accountStatus === \"delinquent\").length;\n\n    const now = new Date();\n    const currentMonth = now.getMonth();\n    const currentYear = now.getFullYear();\n    \n    // AR calculations with overdue tracking (14-day grace period from billing date)\n    const pendingPayments = allBills\n      .filter(b => b.status !== \"paid\")\n      .reduce((sum, b) => sum + parseFloat(b.balance), 0);\n\n    const overdueBills = allBills\n      .filter(b => {\n        if (b.status === \"paid\") return false;\n        // Use createdAt if available, otherwise fallback to dueDate for legacy bills\n        const referenceDate = b.createdAt ? new Date(b.createdAt) : new Date(b.dueDate);\n        const gracePeriodEnd = new Date(referenceDate);\n        if (b.createdAt) {\n          gracePeriodEnd.setDate(gracePeriodEnd.getDate() + 14); // 14-day grace period from billing\n        }\n        return now > gracePeriodEnd;\n      })\n      .reduce((sum, b) => sum + parseFloat(b.balance), 0);\n\n    const totalBilled = allBills.reduce((sum, b) => sum + parseFloat(b.amount), 0);\n    const totalPaid = allBills.reduce((sum, b) => sum + parseFloat(b.totalPaid), 0);\n\n    // Calculate collections this month from payment applications\n    const collectionsThisMonth = allPaymentApplications\n      .filter(pa => {\n        const paymentDate = new Date(pa.paymentDate);\n        return paymentDate.getMonth() === currentMonth && paymentDate.getFullYear() === currentYear;\n      })\n      .reduce((sum, pa) => sum + parseFloat(pa.amountApplied), 0);\n\n    const collectionRate = totalBilled > 0 ? Math.round((totalPaid / totalBilled) * 100) : 0;\n\n    const activeVisitors = allVisitors.filter(\n      v => v.status === \"approved\" && new Date(v.validUntil) > now\n    ).length;\n\n    // Expenses breakdown\n    const approvedExpenses = allExpenses\n      .filter(e => e.status === \"approved\")\n      .reduce((sum, e) => sum + parseFloat(e.expenseAmount), 0);\n    \n    const paidExpenses = allExpenses\n      .filter(e => e.paymentStatus === \"paid\")\n      .reduce((sum, e) => sum + parseFloat(e.expenseAmount), 0);\n    \n    const pendingExpenses = allExpenses\n      .filter(e => e.status === \"pending\")\n      .reduce((sum, e) => sum + parseFloat(e.expenseAmount), 0);\n    \n    const accountsPayable = allExpenses\n      .filter(e => (e.status === \"approved\" || e.status === \"pending\") && e.paymentStatus !== \"paid\")\n      .reduce((sum, e) => sum + parseFloat(e.expenseAmount), 0);\n\n    return {\n      totalResidents,\n      activeResidents,\n      delinquentResidents,\n      totalRevenue: totalPaid,\n      collectionsThisMonth,\n      pendingPayments,\n      overdueBills,\n      collectionRate,\n      activeVisitors,\n      totalExpenses: approvedExpenses,\n      paidExpenses,\n      approvedExpenses,\n      pendingExpenses,\n      accountsPayable,\n    };\n  }\n\n  async getAgingAnalysis(): Promise<any> {\n    const allBills = await db.select().from(bills);\n    const now = new Date();\n\n    const agingBuckets = {\n      current: { amount: 0, count: 0 },\n      \"1-30\": { amount: 0, count: 0 },\n      \"31-60\": { amount: 0, count: 0 },\n      \"61-90\": { amount: 0, count: 0 },\n      \"90+\": { amount: 0, count: 0 },\n    };\n\n    allBills\n      .filter(b => b.status !== \"paid\")\n      .forEach(bill => {\n        // Calculate due date: Use createdAt + 14 days if available, otherwise use dueDate for legacy bills\n        let dueDate: Date;\n        if (bill.createdAt) {\n          const billingDate = new Date(bill.createdAt);\n          dueDate = new Date(billingDate);\n          dueDate.setDate(dueDate.getDate() + 14); // 14-day grace period\n        } else {\n          // Fallback to dueDate for legacy bills without createdAt\n          dueDate = new Date(bill.dueDate);\n        }\n        \n        const daysOverdue = Math.floor((now.getTime() - dueDate.getTime()) / (1000 * 60 * 60 * 24));\n        const amount = parseFloat(bill.balance);\n\n        if (daysOverdue <= 0) {\n          agingBuckets.current.amount += amount;\n          agingBuckets.current.count++;\n        } else if (daysOverdue <= 30) {\n          agingBuckets[\"1-30\"].amount += amount;\n          agingBuckets[\"1-30\"].count++;\n        } else if (daysOverdue <= 60) {\n          agingBuckets[\"31-60\"].amount += amount;\n          agingBuckets[\"31-60\"].count++;\n        } else if (daysOverdue <= 90) {\n          agingBuckets[\"61-90\"].amount += amount;\n          agingBuckets[\"61-90\"].count++;\n        } else {\n          agingBuckets[\"90+\"].amount += amount;\n          agingBuckets[\"90+\"].count++;\n        }\n      });\n\n    return [\n      { name: \"Current\", amount: agingBuckets.current.amount, inv: agingBuckets.current.count },\n      { name: \"1-30 Days\", amount: agingBuckets[\"1-30\"].amount, inv: agingBuckets[\"1-30\"].count },\n      { name: \"31-60 Days\", amount: agingBuckets[\"31-60\"].amount, inv: agingBuckets[\"31-60\"].count },\n      { name: \"61-90 Days\", amount: agingBuckets[\"61-90\"].amount, inv: agingBuckets[\"61-90\"].count },\n      { name: \"90+ Days\", amount: agingBuckets[\"90+\"].amount, inv: agingBuckets[\"90+\"].count },\n    ];\n  }\n\n  async getBudgetVsExpensesMonthToDate(): Promise<any[]> {\n    const now = new Date();\n    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);\n    const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);\n\n    // Find active budget covering current month\n    const [activeBudget] = await db\n      .select()\n      .from(budgets)\n      .where(and(\n        eq(budgets.status, 'active'),\n        lte(budgets.startDate, endOfMonth),\n        gte(budgets.endDate, startOfMonth)\n      ))\n      .limit(1);\n\n    if (!activeBudget) {\n      return [];\n    }\n\n    // Get budget lines for this budget\n    const budgetLinesData = await db\n      .select({\n        accountId: budgetLines.accountId,\n        accountName: accounts.accountName,\n        allocatedAmount: budgetLines.allocatedAmount,\n      })\n      .from(budgetLines)\n      .leftJoin(accounts, eq(budgetLines.accountId, accounts.id))\n      .where(eq(budgetLines.budgetId, activeBudget.id));\n\n    // Get approved expenses for current month with account assignments\n    const monthExpenses = await db\n      .select()\n      .from(expenses)\n      .where(and(\n        eq(expenses.status, 'approved'),\n        gte(expenses.createdAt, startOfMonth),\n        lte(expenses.createdAt, endOfMonth),\n        isNotNull(expenses.accountId)\n      ));\n\n    // Group expenses by account\n    const expensesByAccount: { [accountId: string]: number } = {};\n    monthExpenses.forEach(expense => {\n      if (expense.accountId) {\n        const expenseAmount = parseFloat(expense.expenseAmount);\n        const serviceCharge = expense.serviceCharge ? parseFloat(expense.serviceCharge) : 0;\n        const total = expenseAmount + serviceCharge;\n        \n        if (!expensesByAccount[expense.accountId]) {\n          expensesByAccount[expense.accountId] = 0;\n        }\n        expensesByAccount[expense.accountId] += total;\n      }\n    });\n\n    // Create chart data\n    const chartData = budgetLinesData.map(line => ({\n      account: line.accountName || 'Unknown',\n      budget: Math.round(parseFloat(line.allocatedAmount)),\n      actual: Math.round(expensesByAccount[line.accountId || ''] || 0),\n    }));\n\n    return chartData;\n  }\n\n  async getCollectionsExpensesByMonth(): Promise<any> {\n    // Use payment_applications for actual collection dates\n    const allPaymentApplications = await db.select().from(paymentApplications);\n    const allExpenses = await db.select().from(expenses);\n    const monthlyData: { [key: string]: { collections: number; expenses: number } } = {};\n\n    // Group collections by payment date (not bill creation date)\n    allPaymentApplications.forEach(payment => {\n      const paymentDate = new Date(payment.paymentDate);\n      const monthKey = paymentDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });\n      \n      if (!monthlyData[monthKey]) {\n        monthlyData[monthKey] = { collections: 0, expenses: 0 };\n      }\n      monthlyData[monthKey].collections += parseFloat(payment.amountApplied);\n    });\n\n    // Group expenses by approval/creation date\n    allExpenses\n      .filter(e => e.status === \"approved\")\n      .forEach(expense => {\n        const createdAt = new Date(expense.createdAt!);\n        const monthKey = createdAt.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });\n        \n        if (!monthlyData[monthKey]) {\n          monthlyData[monthKey] = { collections: 0, expenses: 0 };\n        }\n        monthlyData[monthKey].expenses += parseFloat(expense.expenseAmount);\n      });\n\n    const sortedMonths = Object.keys(monthlyData).sort((a, b) => {\n      return new Date(a).getTime() - new Date(b).getTime();\n    });\n\n    return sortedMonths.slice(-8).map(month => ({\n      month: month.split(' ')[0],\n      collections: Math.round(monthlyData[month].collections),\n      expenses: Math.round(monthlyData[month].expenses),\n    }));\n  }\n\n  // ====== ACCOUNTING OPERATIONS ======\n\n  // Chart of Accounts operations\n  async getAccount(id: string): Promise<Account | undefined> {\n    const [account] = await db.select().from(accounts).where(eq(accounts.id, id));\n    return account;\n  }\n\n  async getAccountByNumber(accountNumber: string): Promise<Account | undefined> {\n    const [account] = await db.select().from(accounts).where(eq(accounts.accountNumber, accountNumber));\n    return account;\n  }\n\n  async getAllAccounts(): Promise<Account[]> {\n    return await db\n      .select()\n      .from(accounts)\n      .orderBy(accounts.accountNumber);\n  }\n\n  async getAccountsByType(accountType: string): Promise<Account[]> {\n    return await db\n      .select()\n      .from(accounts)\n      .where(sql`${accounts.accountType} = ${accountType}`)\n      .orderBy(accounts.accountNumber);\n  }\n\n  async getActiveAccounts(): Promise<Account[]> {\n    return await db\n      .select()\n      .from(accounts)\n      .where(eq(accounts.isActive, true))\n      .orderBy(accounts.accountNumber);\n  }\n\n  async createAccount(accountData: InsertAccount): Promise<Account> {\n    const [account] = await db\n      .insert(accounts)\n      .values(accountData)\n      .returning();\n    return account;\n  }\n\n  async updateAccount(id: string, data: Partial<InsertAccount>): Promise<Account> {\n    const [account] = await db\n      .update(accounts)\n      .set({ ...data, updatedAt: new Date() })\n      .where(eq(accounts.id, id))\n      .returning();\n    return account;\n  }\n\n  async deleteAccount(id: string): Promise<void> {\n    // Only delete if not a system account and has no related journal entries\n    await db.delete(accounts).where(\n      and(\n        eq(accounts.id, id),\n        eq(accounts.isSystemAccount, false)\n      )\n    );\n  }\n\n  async updateAccountBalance(id: string, amount: string, lineType: 'debit' | 'credit'): Promise<void> {\n    const account = await this.getAccount(id);\n    if (!account) throw new Error('Account not found');\n\n    const currentBalance = parseFloat(account.balance);\n    const changeAmount = parseFloat(amount);\n    \n    // Determine and normalize the normal balance for this account\n    // Handle null, empty string, and malformed normalBalance values\n    let normalBalance: 'debit' | 'credit';\n    const rawNormalBalance = account.normalBalance?.trim().toLowerCase();\n    \n    if (rawNormalBalance === 'debit' || rawNormalBalance === 'credit') {\n      // Valid normalBalance found\n      normalBalance = rawNormalBalance as 'debit' | 'credit';\n    } else {\n      // Derive normal balance from account type\n      // Assets & Expenses have debit normal balance\n      // Liabilities, Equity & Revenue have credit normal balance\n      if (account.accountType === 'asset' || account.accountType === 'expense') {\n        normalBalance = 'debit';\n      } else if (account.accountType === 'liability' || account.accountType === 'equity' || account.accountType === 'revenue') {\n        normalBalance = 'credit';\n      } else {\n        throw new Error(`Cannot determine normal balance for account ${account.id} with type ${account.accountType}`);\n      }\n    }\n    \n    // Account-type aware balance update:\n    // - Debit increases debit-normal accounts (Asset/Expense)\n    // - Credit increases credit-normal accounts (Liability/Equity/Revenue)\n    let newBalance: number;\n    if (lineType === normalBalance) {\n      // Line type matches normal balance: increase\n      newBalance = currentBalance + changeAmount;\n    } else {\n      // Line type opposite of normal balance: decrease\n      newBalance = currentBalance - changeAmount;\n    }\n\n    await db\n      .update(accounts)\n      .set({ balance: newBalance.toFixed(2), updatedAt: new Date() })\n      .where(eq(accounts.id, id));\n  }\n\n  // Transaction Template operations\n  async getTransactionTemplate(id: string): Promise<any> {\n    const [template] = await db\n      .select()\n      .from(transactionTemplates)\n      .where(eq(transactionTemplates.id, id));\n    \n    if (!template) return undefined;\n\n    // Fetch associated accounts\n    const debitAccount = await this.getAccount(template.debitAccountId);\n    const creditAccount = await this.getAccount(template.creditAccountId);\n\n    return {\n      ...template,\n      debitAccount,\n      creditAccount,\n    };\n  }\n\n  async getTransactionTemplateByType(transactionType: string): Promise<any> {\n    const [template] = await db\n      .select()\n      .from(transactionTemplates)\n      .where(\n        and(\n          eq(transactionTemplates.transactionType, transactionType),\n          eq(transactionTemplates.isActive, true)\n        )\n      );\n    \n    if (!template) return undefined;\n\n    // Fetch associated accounts\n    const debitAccount = await this.getAccount(template.debitAccountId);\n    const creditAccount = await this.getAccount(template.creditAccountId);\n\n    return {\n      ...template,\n      debitAccount,\n      creditAccount,\n    };\n  }\n\n  async getAllTransactionTemplates(): Promise<any[]> {\n    const templates = await db\n      .select()\n      .from(transactionTemplates)\n      .orderBy(transactionTemplates.name);\n\n    // Fetch associated accounts for each template\n    return Promise.all(\n      templates.map(async (template) => {\n        const debitAccount = await this.getAccount(template.debitAccountId);\n        const creditAccount = await this.getAccount(template.creditAccountId);\n        return {\n          ...template,\n          debitAccount,\n          creditAccount,\n        };\n      })\n    );\n  }\n\n  async getActiveTransactionTemplates(): Promise<any[]> {\n    const templates = await db\n      .select()\n      .from(transactionTemplates)\n      .where(eq(transactionTemplates.isActive, true))\n      .orderBy(transactionTemplates.name);\n\n    // Fetch associated accounts for each template\n    return Promise.all(\n      templates.map(async (template) => {\n        const debitAccount = await this.getAccount(template.debitAccountId);\n        const creditAccount = await this.getAccount(template.creditAccountId);\n        return {\n          ...template,\n          debitAccount,\n          creditAccount,\n        };\n      })\n    );\n  }\n\n  async createTransactionTemplate(templateData: InsertTransactionTemplate): Promise<TransactionTemplate> {\n    const [template] = await db\n      .insert(transactionTemplates)\n      .values(templateData)\n      .returning();\n    return template;\n  }\n\n  async updateTransactionTemplate(id: string, data: Partial<InsertTransactionTemplate>): Promise<TransactionTemplate> {\n    const [template] = await db\n      .update(transactionTemplates)\n      .set({ ...data, updatedAt: new Date() })\n      .where(eq(transactionTemplates.id, id))\n      .returning();\n    return template;\n  }\n\n  async deleteTransactionTemplate(id: string): Promise<void> {\n    // Only delete if not a system template\n    await db.delete(transactionTemplates).where(\n      and(\n        eq(transactionTemplates.id, id),\n        eq(transactionTemplates.isSystemTemplate, false)\n      )\n    );\n  }\n\n  // Journal Entry operations\n  async getJournalEntry(id: string): Promise<any> {\n    const [entry] = await db.select().from(journalEntries).where(eq(journalEntries.id, id));\n    return entry;\n  }\n\n  async getJournalEntryWithLines(id: string): Promise<any> {\n    const entry = await this.getJournalEntry(id);\n    if (!entry) return undefined;\n\n    const lines = await db\n      .select()\n      .from(journalEntryLines)\n      .where(eq(journalEntryLines.journalEntryId, id));\n\n    // Fetch account details for each line\n    const linesWithAccounts = await Promise.all(\n      lines.map(async (line) => {\n        const account = await this.getAccount(line.accountId);\n        return {\n          ...line,\n          account,\n        };\n      })\n    );\n\n    // Fetch template if exists\n    let template = null;\n    if (entry.templateId) {\n      template = await this.getTransactionTemplate(entry.templateId);\n    }\n\n    // Fetch creator\n    const creator = await this.getUser(entry.createdBy);\n\n    return {\n      ...entry,\n      lines: linesWithAccounts,\n      template,\n      creator,\n    };\n  }\n\n  async getAllJournalEntries(): Promise<any[]> {\n    const entries = await db\n      .select()\n      .from(journalEntries)\n      .orderBy(desc(journalEntries.entryDate));\n\n    // Fetch creator for each entry\n    return Promise.all(\n      entries.map(async (entry) => {\n        const creator = await this.getUser(entry.createdBy);\n        return {\n          ...entry,\n          creator,\n        };\n      })\n    );\n  }\n\n  async getJournalEntriesByDateRange(startDate: Date, endDate: Date): Promise<any[]> {\n    const entries = await db\n      .select()\n      .from(journalEntries)\n      .where(\n        and(\n          gte(journalEntries.entryDate, startDate),\n          lte(journalEntries.entryDate, endDate)\n        )\n      )\n      .orderBy(desc(journalEntries.entryDate));\n\n    // Fetch creator for each entry\n    return Promise.all(\n      entries.map(async (entry) => {\n        const creator = await this.getUser(entry.createdBy);\n        return {\n          ...entry,\n          creator,\n        };\n      })\n    );\n  }\n\n  async getJournalEntriesByReferenceId(referenceId: string): Promise<any[]> {\n    const entries = await db\n      .select()\n      .from(journalEntries)\n      .where(eq(journalEntries.referenceId, referenceId))\n      .orderBy(desc(journalEntries.createdAt));\n\n    // Fetch creator for each entry\n    return Promise.all(\n      entries.map(async (entry) => {\n        const creator = await this.getUser(entry.createdBy);\n        return {\n          ...entry,\n          creator,\n        };\n      })\n    );\n  }\n\n  async createJournalEntry(entryData: InsertJournalEntry, lines: InsertJournalEntryLine[]): Promise<JournalEntry> {\n    // Validate that we have at least 2 lines (minimum for double-entry)\n    if (!lines || lines.length < 2) {\n      throw new Error('Journal entry must have at least 2 lines (double-entry accounting)');\n    }\n\n    // Generate entry number\n    const entryNumber = await this.generateEntryNumber(entryData.entryDate);\n\n    // Calculate totals from lines\n    const totalDebit = lines\n      .filter(line => line.lineType === 'debit')\n      .reduce((sum, line) => sum + parseFloat(line.amount), 0);\n    \n    const totalCredit = lines\n      .filter(line => line.lineType === 'credit')\n      .reduce((sum, line) => sum + parseFloat(line.amount), 0);\n\n    // Validate that debits equal credits (double-entry accounting principle)\n    const difference = Math.abs(totalDebit - totalCredit);\n    if (difference > 0.01) { // Allow for small rounding errors\n      throw new Error(\n        `Journal entry is unbalanced! Debits (₦${totalDebit.toFixed(2)}) must equal Credits (₦${totalCredit.toFixed(2)}). Difference: ₦${difference.toFixed(2)}`\n      );\n    }\n\n    // Create the journal entry\n    const [entry] = await db\n      .insert(journalEntries)\n      .values({\n        ...entryData,\n        entryNumber,\n        totalDebit: totalDebit.toFixed(2),\n        totalCredit: totalCredit.toFixed(2),\n      })\n      .returning();\n\n    // Create the journal entry lines\n    for (const line of lines) {\n      await db\n        .insert(journalEntryLines)\n        .values({\n          ...line,\n          journalEntryId: entry.id,\n        });\n\n      // Update account balances (account-type aware)\n      await this.updateAccountBalance(line.accountId, line.amount, line.lineType);\n    }\n\n    return entry;\n  }\n\n  async voidJournalEntry(id: string): Promise<void> {\n    // Get the entry with lines\n    const entry = await this.getJournalEntryWithLines(id);\n    if (!entry) throw new Error('Journal entry not found');\n\n    // Reverse account balance changes by applying opposite line type\n    for (const line of entry.lines) {\n      const oppositeLineType = line.lineType === 'debit' ? 'credit' : 'debit';\n      await this.updateAccountBalance(line.accountId, line.amount, oppositeLineType);\n    }\n\n    // Mark entry as void\n    await db\n      .update(journalEntries)\n      .set({ status: 'void', updatedAt: new Date() })\n      .where(eq(journalEntries.id, id));\n  }\n\n  async generateEntryNumber(entryDate: Date): Promise<string> {\n    const dateStr = entryDate.toISOString().split('T')[0].replace(/-/g, '');\n    \n    // Get count of entries for this date\n    const count = await db\n      .select({ count: sql<number>`count(*)` })\n      .from(journalEntries)\n      .where(sql`DATE(entry_date) = DATE(${entryDate})`);\n\n    const sequenceNumber = (count[0]?.count || 0) + 1;\n    const paddedSequence = sequenceNumber.toString().padStart(4, '0');\n\n    return `JE-${dateStr}-${paddedSequence}`;\n  }\n\n  async generateInvoiceNumber(): Promise<string> {\n    const now = new Date();\n    const year = now.getFullYear();\n    const seriesKey = 'invoice';\n    \n    // Use a transaction with atomic upsert to handle both existing and bootstrap cases\n    return await db.transaction(async (tx) => {\n      // Atomically upsert the sequence row: INSERT if missing, UPDATE if exists\n      // This handles the bootstrap case (first invoice of fiscal year) safely\n      const result = await tx.execute(sql`\n        INSERT INTO invoice_sequences (series_key, fiscal_year, last_number, updated_at)\n        VALUES (${seriesKey}, ${year}, 1, NOW())\n        ON CONFLICT (series_key, fiscal_year)\n        DO UPDATE SET \n          last_number = invoice_sequences.last_number + 1,\n          updated_at = NOW()\n        RETURNING last_number\n      `);\n      \n      const nextNumber = (result.rows[0] as any).last_number;\n      const paddedSequence = nextNumber.toString().padStart(4, '0');\n      return `INV-${year}-${paddedSequence}`;\n    });\n  }\n\n  // Financial Reports\n  async getTrialBalance(asOf: Date): Promise<any> {\n    // Get all accounts\n    const allAccounts = await db\n      .select()\n      .from(accounts)\n      .where(eq(accounts.isActive, true))\n      .orderBy(accounts.accountNumber);\n\n    // Get all posted journal entry lines up to the specified date\n    const lines = await db\n      .select({\n        accountId: journalEntryLines.accountId,\n        lineType: journalEntryLines.lineType,\n        amount: journalEntryLines.amount,\n      })\n      .from(journalEntryLines)\n      .innerJoin(journalEntries, eq(journalEntryLines.journalEntryId, journalEntries.id))\n      .where(\n        and(\n          eq(journalEntries.status, 'posted'),\n          sql`${journalEntries.entryDate} <= ${asOf}`\n        )\n      );\n\n    // Calculate balances for each account\n    const accountBalances = new Map();\n    \n    for (const line of lines) {\n      if (!accountBalances.has(line.accountId)) {\n        accountBalances.set(line.accountId, { debit: 0, credit: 0 });\n      }\n      \n      const balance = accountBalances.get(line.accountId);\n      const amount = parseFloat(line.amount);\n      \n      if (line.lineType === 'debit') {\n        balance.debit += amount;\n      } else {\n        balance.credit += amount;\n      }\n    }\n\n    // Build trial balance data\n    // In a proper Trial Balance, we show the NET position of each account\n    // based on its normal balance type\n    const trialBalanceData = allAccounts.map((account) => {\n      const balance = accountBalances.get(account.id) || { debit: 0, credit: 0 };\n      \n      let debitBalance = 0;\n      let creditBalance = 0;\n      \n      // Calculate the net balance\n      const netAmount = balance.debit - balance.credit;\n      \n      // For accounts with normal debit balance (Assets, Expenses):\n      // - Positive net = show in debit column\n      // - Negative net = show in credit column (contra account)\n      if (account.normalBalance === 'debit') {\n        if (netAmount >= 0) {\n          debitBalance = netAmount;\n        } else {\n          creditBalance = Math.abs(netAmount);\n        }\n      } \n      // For accounts with normal credit balance (Liabilities, Equity, Revenue):\n      // - Positive net (more debits) = show in debit column (contra account)\n      // - Negative net = show in credit column\n      else {\n        if (netAmount <= 0) {\n          creditBalance = Math.abs(netAmount);\n        } else {\n          debitBalance = netAmount;\n        }\n      }\n\n      return {\n        accountId: account.id,\n        accountNumber: account.accountNumber,\n        accountName: account.accountName,\n        accountType: account.accountType,\n        normalBalance: account.normalBalance,\n        rawDebit: balance.debit,\n        rawCredit: balance.credit,\n        debitBalance,\n        creditBalance,\n      };\n    }).filter(acc => acc.debitBalance !== 0 || acc.creditBalance !== 0); // Only show accounts with balances\n\n    // Calculate totals\n    const totalDebits = trialBalanceData.reduce((sum, acc) => sum + acc.debitBalance, 0);\n    const totalCredits = trialBalanceData.reduce((sum, acc) => sum + acc.creditBalance, 0);\n\n    return {\n      asOf,\n      accounts: trialBalanceData,\n      totalDebits,\n      totalCredits,\n      balanced: Math.abs(totalDebits - totalCredits) < 0.01,\n    };\n  }\n\n  async getIncomeStatement(startDate: Date, endDate: Date): Promise<any> {\n    // Get revenue and expense accounts\n    const revenueAccounts = await db\n      .select()\n      .from(accounts)\n      .where(and(\n        eq(accounts.accountType, 'revenue'),\n        eq(accounts.isActive, true)\n      ))\n      .orderBy(accounts.accountNumber);\n\n    const expenseAccounts = await db\n      .select()\n      .from(accounts)\n      .where(and(\n        eq(accounts.accountType, 'expense'),\n        eq(accounts.isActive, true)\n      ))\n      .orderBy(accounts.accountNumber);\n\n    // Get journal entry lines for the period\n    const lines = await db\n      .select({\n        accountId: journalEntryLines.accountId,\n        lineType: journalEntryLines.lineType,\n        amount: journalEntryLines.amount,\n      })\n      .from(journalEntryLines)\n      .innerJoin(journalEntries, eq(journalEntryLines.journalEntryId, journalEntries.id))\n      .where(\n        and(\n          eq(journalEntries.status, 'posted'),\n          sql`${journalEntries.entryDate} >= ${startDate}`,\n          sql`${journalEntries.entryDate} <= ${endDate}`\n        )\n      );\n\n    // Calculate balances\n    const accountBalances = new Map();\n    for (const line of lines) {\n      if (!accountBalances.has(line.accountId)) {\n        accountBalances.set(line.accountId, { debit: 0, credit: 0 });\n      }\n      \n      const balance = accountBalances.get(line.accountId);\n      const amount = parseFloat(line.amount);\n      \n      if (line.lineType === 'debit') {\n        balance.debit += amount;\n      } else {\n        balance.credit += amount;\n      }\n    }\n\n    // Build revenue data (credit balance is revenue)\n    const revenues = revenueAccounts.map((account) => {\n      const balance = accountBalances.get(account.id) || { debit: 0, credit: 0 };\n      const amount = balance.credit - balance.debit;\n      \n      return {\n        accountNumber: account.accountNumber,\n        accountName: account.accountName,\n        amount: Math.max(0, amount),\n      };\n    });\n\n    // Build expense data (debit balance is expense)\n    const expenses = expenseAccounts.map((account) => {\n      const balance = accountBalances.get(account.id) || { debit: 0, credit: 0 };\n      const amount = balance.debit - balance.credit;\n      \n      return {\n        accountNumber: account.accountNumber,\n        accountName: account.accountName,\n        amount: Math.max(0, amount),\n      };\n    });\n\n    const totalRevenue = revenues.reduce((sum, r) => sum + r.amount, 0);\n    const totalExpenses = expenses.reduce((sum, e) => sum + e.amount, 0);\n    const netIncome = totalRevenue - totalExpenses;\n\n    return {\n      startDate,\n      endDate,\n      revenues,\n      totalRevenue,\n      expenses,\n      totalExpenses,\n      netIncome,\n    };\n  }\n\n  async getBalanceSheet(asOf: Date): Promise<any> {\n    // Get asset, liability, and equity accounts\n    const assetAccounts = await db\n      .select()\n      .from(accounts)\n      .where(and(\n        eq(accounts.accountType, 'asset'),\n        eq(accounts.isActive, true)\n      ))\n      .orderBy(accounts.accountNumber);\n\n    const liabilityAccounts = await db\n      .select()\n      .from(accounts)\n      .where(and(\n        eq(accounts.accountType, 'liability'),\n        eq(accounts.isActive, true)\n      ))\n      .orderBy(accounts.accountNumber);\n\n    const equityAccounts = await db\n      .select()\n      .from(accounts)\n      .where(and(\n        eq(accounts.accountType, 'equity'),\n        eq(accounts.isActive, true)\n      ))\n      .orderBy(accounts.accountNumber);\n\n    // Get journal entry lines up to date\n    const lines = await db\n      .select({\n        accountId: journalEntryLines.accountId,\n        lineType: journalEntryLines.lineType,\n        amount: journalEntryLines.amount,\n      })\n      .from(journalEntryLines)\n      .innerJoin(journalEntries, eq(journalEntryLines.journalEntryId, journalEntries.id))\n      .where(\n        and(\n          eq(journalEntries.status, 'posted'),\n          sql`${journalEntries.entryDate} <= ${asOf}`\n        )\n      );\n\n    // Calculate balances\n    const accountBalances = new Map();\n    for (const line of lines) {\n      if (!accountBalances.has(line.accountId)) {\n        accountBalances.set(line.accountId, { debit: 0, credit: 0 });\n      }\n      \n      const balance = accountBalances.get(line.accountId);\n      const amount = parseFloat(line.amount);\n      \n      if (line.lineType === 'debit') {\n        balance.debit += amount;\n      } else {\n        balance.credit += amount;\n      }\n    }\n\n    // Build assets (debit balance)\n    const assets = assetAccounts.map((account) => {\n      const balance = accountBalances.get(account.id) || { debit: 0, credit: 0 };\n      const amount = balance.debit - balance.credit;\n      \n      return {\n        accountNumber: account.accountNumber,\n        accountName: account.accountName,\n        category: account.category,\n        amount: Math.max(0, amount),\n      };\n    });\n\n    // Build liabilities (credit balance)\n    const liabilities = liabilityAccounts.map((account) => {\n      const balance = accountBalances.get(account.id) || { debit: 0, credit: 0 };\n      const amount = balance.credit - balance.debit;\n      \n      return {\n        accountNumber: account.accountNumber,\n        accountName: account.accountName,\n        category: account.category,\n        amount: Math.max(0, amount),\n      };\n    });\n\n    // Build equity (credit balance)\n    const equity = equityAccounts.map((account) => {\n      const balance = accountBalances.get(account.id) || { debit: 0, credit: 0 };\n      const amount = balance.credit - balance.debit;\n      \n      return {\n        accountNumber: account.accountNumber,\n        accountName: account.accountName,\n        category: account.category,\n        amount: Math.max(0, amount),\n      };\n    });\n\n    const totalAssets = assets.reduce((sum, a) => sum + a.amount, 0);\n    const totalLiabilities = liabilities.reduce((sum, l) => sum + l.amount, 0);\n    const totalEquity = equity.reduce((sum, e) => sum + e.amount, 0);\n\n    return {\n      asOf,\n      assets,\n      totalAssets,\n      liabilities,\n      totalLiabilities,\n      equity,\n      totalEquity,\n      totalLiabilitiesAndEquity: totalLiabilities + totalEquity,\n    };\n  }\n\n  // Vendor operations\n  async getVendor(id: string): Promise<Vendor | undefined> {\n    const [vendor] = await db.select().from(vendors).where(eq(vendors.id, id));\n    return vendor;\n  }\n\n  async getVendorByTin(tinNumber: string): Promise<Vendor | undefined> {\n    const [vendor] = await db.select().from(vendors).where(eq(vendors.tinNumber, tinNumber));\n    return vendor;\n  }\n\n  async getAllVendors(): Promise<Vendor[]> {\n    const allVendors = await db\n      .select()\n      .from(vendors)\n      .orderBy(desc(vendors.createdAt));\n    return allVendors;\n  }\n\n  async getVendorsByStatus(status: string): Promise<Vendor[]> {\n    const vendorsByStatus = await db\n      .select()\n      .from(vendors)\n      .where(eq(vendors.status, status))\n      .orderBy(desc(vendors.createdAt));\n    return vendorsByStatus;\n  }\n\n  async createVendor(vendorData: InsertVendor): Promise<Vendor> {\n    const [vendor] = await db\n      .insert(vendors)\n      .values(vendorData)\n      .returning();\n    return vendor;\n  }\n\n  async updateVendor(id: string, data: Partial<InsertVendor>): Promise<Vendor> {\n    const [vendor] = await db\n      .update(vendors)\n      .set({ ...data, updatedAt: new Date() })\n      .where(eq(vendors.id, id))\n      .returning();\n    return vendor;\n  }\n\n  async approveVendor(id: string, approvedBy: string): Promise<Vendor> {\n    const [vendor] = await db\n      .update(vendors)\n      .set({\n        status: 'approved',\n        approvedBy,\n        approvedAt: new Date(),\n        rejectionReason: null,\n        updatedAt: new Date(),\n      })\n      .where(eq(vendors.id, id))\n      .returning();\n    return vendor;\n  }\n\n  async rejectVendor(id: string, approvedBy: string, reason: string): Promise<Vendor> {\n    const [vendor] = await db\n      .update(vendors)\n      .set({\n        status: 'rejected',\n        approvedBy,\n        approvedAt: new Date(),\n        rejectionReason: reason,\n        updatedAt: new Date(),\n      })\n      .where(eq(vendors.id, id))\n      .returning();\n    return vendor;\n  }\n\n  async getVendorAccountStatement(\n    vendorId: string, \n    startDate?: Date, \n    endDate?: Date\n  ): Promise<any> {\n    const vendor = await this.getVendor(vendorId);\n    if (!vendor) {\n      throw new Error('Vendor not found');\n    }\n\n    // Build the query conditions\n    const conditions = [eq(journalEntries.status, 'posted')];\n    \n    if (startDate) {\n      conditions.push(sql`${journalEntries.entryDate} >= ${startDate}`);\n    }\n    if (endDate) {\n      conditions.push(sql`${journalEntries.entryDate} <= ${endDate}`);\n    }\n\n    // Get all journal entries that reference this vendor\n    // For now, we'll look for vendor references in the description or reference fields\n    const entries = await db\n      .select({\n        id: journalEntries.id,\n        entryNumber: journalEntries.entryNumber,\n        entryDate: journalEntries.entryDate,\n        description: journalEntries.description,\n        totalDebit: journalEntries.totalDebit,\n        totalCredit: journalEntries.totalCredit,\n        status: journalEntries.status,\n      })\n      .from(journalEntries)\n      .where(and(...conditions))\n      .orderBy(journalEntries.entryDate, journalEntries.entryNumber);\n\n    // Filter entries that contain vendor name or TIN in description\n    const vendorEntries = entries.filter(entry => \n      entry.description.toLowerCase().includes(vendor.name.toLowerCase()) ||\n      entry.description.includes(vendor.tinNumber)\n    );\n\n    // Calculate running balance\n    let runningBalance = 0;\n    const transactions = vendorEntries.map(entry => {\n      const amount = parseFloat(entry.totalDebit) - parseFloat(entry.totalCredit);\n      runningBalance += amount;\n      \n      return {\n        ...entry,\n        amount,\n        runningBalance,\n      };\n    });\n\n    return {\n      vendor,\n      startDate,\n      endDate,\n      transactions,\n      openingBalance: 0, // Can be calculated from entries before startDate\n      closingBalance: runningBalance,\n      totalDebits: transactions.reduce((sum, t) => sum + Math.max(0, t.amount), 0),\n      totalCredits: transactions.reduce((sum, t) => sum + Math.abs(Math.min(0, t.amount)), 0),\n    };\n  }\n\n  async getVendorOutstandingBills(): Promise<Record<string, number>> {\n    // Get all approved expenses for approved vendors only\n    const approvedExpenses = await db\n      .select({\n        vendorId: expenses.vendorId,\n        expenseAmount: expenses.expenseAmount,\n        serviceCharge: expenses.serviceCharge,\n      })\n      .from(expenses)\n      .innerJoin(vendors, eq(expenses.vendorId, vendors.id))\n      .where(and(\n        eq(expenses.status, 'approved'),\n        eq(vendors.status, 'approved')\n      ));\n\n    // Calculate total outstanding per vendor\n    const outstandingByVendor: Record<string, number> = {};\n    \n    for (const expense of approvedExpenses) {\n      if (!expense.vendorId) continue;\n      \n      const expenseAmount = parseFloat(expense.expenseAmount);\n      const serviceCharge = expense.serviceCharge ? parseFloat(expense.serviceCharge) : 0;\n      const totalAmount = expenseAmount + serviceCharge;\n      \n      if (!outstandingByVendor[expense.vendorId]) {\n        outstandingByVendor[expense.vendorId] = 0;\n      }\n      outstandingByVendor[expense.vendorId] += totalAmount;\n    }\n    \n    return outstandingByVendor;\n  }\n\n  // Expense operations\n  async getExpense(id: string): Promise<any> {\n    const [expense] = await db\n      .select({\n        id: expenses.id,\n        vendorId: expenses.vendorId,\n        vendorName: vendors.name,\n        vendorTin: vendors.tinNumber,\n        expenseType: expenses.expenseType,\n        description: expenses.description,\n        expenseAmount: expenses.expenseAmount,\n        serviceCharge: expenses.serviceCharge,\n        receiptPath: expenses.receiptPath,\n        status: expenses.status,\n        submittedBy: expenses.submittedBy,\n        submitterName: sql<string>`CONCAT(${users.firstName}, ' ', ${users.lastName})`,\n        reviewedBy: expenses.reviewedBy,\n        reviewedAt: expenses.reviewedAt,\n        rejectionReason: expenses.rejectionReason,\n        createdAt: expenses.createdAt,\n        updatedAt: expenses.updatedAt,\n      })\n      .from(expenses)\n      .leftJoin(vendors, eq(expenses.vendorId, vendors.id))\n      .leftJoin(users, eq(expenses.submittedBy, users.id))\n      .where(eq(expenses.id, id));\n    return expense;\n  }\n\n  async getAllExpenses(): Promise<any[]> {\n    const allExpenses = await db\n      .select({\n        id: expenses.id,\n        vendorId: expenses.vendorId,\n        vendorName: vendors.name,\n        vendorTin: vendors.tinNumber,\n        expenseType: expenses.expenseType,\n        description: expenses.description,\n        expenseAmount: expenses.expenseAmount,\n        serviceCharge: expenses.serviceCharge,\n        receiptPath: expenses.receiptPath,\n        status: expenses.status,\n        submittedBy: expenses.submittedBy,\n        submitterName: sql<string>`CONCAT(${users.firstName}, ' ', ${users.lastName})`,\n        reviewedBy: expenses.reviewedBy,\n        reviewedAt: expenses.reviewedAt,\n        rejectionReason: expenses.rejectionReason,\n        createdAt: expenses.createdAt,\n        updatedAt: expenses.updatedAt,\n      })\n      .from(expenses)\n      .leftJoin(vendors, eq(expenses.vendorId, vendors.id))\n      .leftJoin(users, eq(expenses.submittedBy, users.id))\n      .orderBy(desc(expenses.createdAt));\n    return allExpenses;\n  }\n\n  async getExpensesByStatus(status: string): Promise<any[]> {\n    const statusExpenses = await db\n      .select({\n        id: expenses.id,\n        vendorId: expenses.vendorId,\n        vendorName: vendors.name,\n        vendorTin: vendors.tinNumber,\n        expenseType: expenses.expenseType,\n        description: expenses.description,\n        expenseAmount: expenses.expenseAmount,\n        serviceCharge: expenses.serviceCharge,\n        receiptPath: expenses.receiptPath,\n        status: expenses.status,\n        submittedBy: expenses.submittedBy,\n        submitterName: sql<string>`CONCAT(${users.firstName}, ' ', ${users.lastName})`,\n        reviewedBy: expenses.reviewedBy,\n        reviewedAt: expenses.reviewedAt,\n        rejectionReason: expenses.rejectionReason,\n        createdAt: expenses.createdAt,\n        updatedAt: expenses.updatedAt,\n      })\n      .from(expenses)\n      .leftJoin(vendors, eq(expenses.vendorId, vendors.id))\n      .leftJoin(users, eq(expenses.submittedBy, users.id))\n      .where(eq(expenses.status, status))\n      .orderBy(desc(expenses.createdAt));\n    return statusExpenses;\n  }\n\n  async getExpensesBySubmitter(userId: string): Promise<any[]> {\n    const userExpenses = await db\n      .select({\n        id: expenses.id,\n        vendorId: expenses.vendorId,\n        vendorName: vendors.name,\n        vendorTin: vendors.tinNumber,\n        expenseType: expenses.expenseType,\n        description: expenses.description,\n        expenseAmount: expenses.expenseAmount,\n        serviceCharge: expenses.serviceCharge,\n        receiptPath: expenses.receiptPath,\n        status: expenses.status,\n        submittedBy: expenses.submittedBy,\n        submitterName: sql<string>`CONCAT(${users.firstName}, ' ', ${users.lastName})`,\n        reviewedBy: expenses.reviewedBy,\n        reviewedAt: expenses.reviewedAt,\n        rejectionReason: expenses.rejectionReason,\n        createdAt: expenses.createdAt,\n        updatedAt: expenses.updatedAt,\n      })\n      .from(expenses)\n      .leftJoin(vendors, eq(expenses.vendorId, vendors.id))\n      .leftJoin(users, eq(expenses.submittedBy, users.id))\n      .where(eq(expenses.submittedBy, userId))\n      .orderBy(desc(expenses.createdAt));\n    return userExpenses;\n  }\n\n  async createExpense(expense: InsertExpense): Promise<Expense> {\n    const [newExpense] = await db\n      .insert(expenses)\n      .values(expense)\n      .returning();\n    return newExpense;\n  }\n\n  async approveExpense(id: string, reviewedBy: string): Promise<Expense> {\n    const [expense] = await db\n      .update(expenses)\n      .set({\n        status: 'approved',\n        reviewedBy,\n        reviewedAt: new Date(),\n        rejectionReason: null,\n        updatedAt: new Date(),\n      })\n      .where(eq(expenses.id, id))\n      .returning();\n    \n    // If expense has an account assigned, update budget consumption\n    if (expense.accountId) {\n      // Use the expense's creation date (when it was incurred) for budget matching\n      // This ensures expenses are charged against the correct budget period\n      const expenseDate = expense.createdAt || new Date();\n      \n      // Calculate total expense amount (expense amount + service charge)\n      const expenseAmount = parseFloat(expense.expenseAmount);\n      const serviceCharge = expense.serviceCharge ? parseFloat(expense.serviceCharge) : 0;\n      const totalAmount = expenseAmount + serviceCharge;\n      \n      // Find active budget covering the expense date\n      // First try to find budget covering the expense creation date\n      let [activeBudget] = await db\n        .select()\n        .from(budgets)\n        .where(and(\n          eq(budgets.status, 'active'),\n          lte(budgets.startDate, expenseDate),\n          gte(budgets.endDate, expenseDate)\n        ))\n        .limit(1);\n      \n      // If no budget covers the expense date, fall back to current active budget\n      // This handles cases where expenses are approved outside their incurred period\n      if (!activeBudget) {\n        const now = new Date();\n        [activeBudget] = await db\n          .select()\n          .from(budgets)\n          .where(and(\n            eq(budgets.status, 'active'),\n            lte(budgets.startDate, now),\n            gte(budgets.endDate, now)\n          ))\n          .limit(1);\n      }\n      \n      // If still no budget found, log warning\n      if (!activeBudget) {\n        console.warn(`[Budget Warning] No active budget found for expense ${expense.id} (Account: ${expense.accountId}, Created: ${expenseDate.toISOString()}). Expense approved but not tracked in budget.`);\n      }\n      \n      if (activeBudget) {\n        // Check if this budget has a line for this account\n        const [budgetLine] = await db\n          .select()\n          .from(budgetLines)\n          .where(\n            and(\n              eq(budgetLines.budgetId, activeBudget.id),\n              eq(budgetLines.accountId, expense.accountId)\n            )\n          );\n        \n        if (budgetLine) {\n          // Update budget line: consumed and remaining amounts\n          const allocated = parseFloat(budgetLine.allocatedAmount);\n          const currentConsumed = parseFloat(budgetLine.consumedAmount);\n          const newConsumed = currentConsumed + totalAmount;\n          const newRemaining = allocated - newConsumed;\n          \n          await db\n            .update(budgetLines)\n            .set({\n              consumedAmount: newConsumed.toFixed(2),\n              remainingAmount: newRemaining.toFixed(2),\n              updatedAt: new Date(),\n            })\n            .where(eq(budgetLines.id, budgetLine.id));\n          \n          // Update budget totals: total consumed and total remaining\n          const budgetTotalAllocated = parseFloat(activeBudget.totalBudgetAmount);\n          const budgetCurrentConsumed = parseFloat(activeBudget.totalConsumedAmount);\n          const budgetNewConsumed = budgetCurrentConsumed + totalAmount;\n          const budgetNewRemaining = budgetTotalAllocated - budgetNewConsumed;\n          \n          await db\n            .update(budgets)\n            .set({\n              totalConsumedAmount: budgetNewConsumed.toFixed(2),\n              totalRemainingAmount: budgetNewRemaining.toFixed(2),\n              updatedAt: new Date(),\n            })\n            .where(eq(budgets.id, activeBudget.id));\n        }\n      }\n    }\n    \n    return expense;\n  }\n\n  async rejectExpense(id: string, reviewedBy: string, reason: string): Promise<Expense> {\n    const [expense] = await db\n      .update(expenses)\n      .set({\n        status: 'rejected',\n        reviewedBy,\n        reviewedAt: new Date(),\n        rejectionReason: reason,\n        updatedAt: new Date(),\n      })\n      .where(eq(expenses.id, id))\n      .returning();\n    return expense;\n  }\n\n  // Accounts Payable operations\n  async getApprovedExpensesForPayment(): Promise<any[]> {\n    const approvedExpenses = await db\n      .select({\n        id: expenses.id,\n        vendorId: expenses.vendorId,\n        vendorName: vendors.name,\n        vendorBankName: vendors.bankName,\n        vendorBankAccountNumber: vendors.bankAccountNumber,\n        vendorBankAccountName: vendors.bankAccountName,\n        accountId: expenses.accountId,\n        accountNumber: accounts.accountNumber,\n        accountName: accounts.accountName,\n        expenseType: expenses.expenseType,\n        description: expenses.description,\n        expenseAmount: expenses.expenseAmount,\n        serviceCharge: expenses.serviceCharge,\n        receiptPath: expenses.receiptPath,\n        status: expenses.status,\n        paymentStatus: expenses.paymentStatus,\n        whtRate: expenses.whtRate,\n        whtAmount: expenses.whtAmount,\n        netPayment: expenses.netPayment,\n        paidDate: expenses.paidDate,\n        paidFromAccountId: expenses.paidFromAccountId,\n        reviewedBy: expenses.reviewedBy,\n        reviewedAt: expenses.reviewedAt,\n        createdAt: expenses.createdAt,\n        submittedBy: expenses.submittedBy,\n        submitterName: sql<string>`CONCAT(${users.firstName}, ' ', ${users.lastName})`,\n      })\n      .from(expenses)\n      .leftJoin(vendors, eq(expenses.vendorId, vendors.id))\n      .leftJoin(accounts, eq(expenses.accountId, accounts.id))\n      .leftJoin(users, eq(expenses.submittedBy, users.id))\n      .where(\n        and(\n          eq(expenses.status, 'approved'),\n          or(\n            eq(expenses.paymentStatus, 'unpaid'),\n            eq(expenses.paymentStatus, 'approved_for_payment')\n          )\n        )\n      )\n      .orderBy(desc(expenses.createdAt));\n    \n    return approvedExpenses;\n  }\n\n  async getBankAccounts(): Promise<Account[]> {\n    const bankAccounts = await db\n      .select()\n      .from(accounts)\n      .where(\n        and(\n          eq(accounts.accountType, 'asset'),\n          eq(accounts.isActive, true),\n          or(\n            eq(accounts.category, 'Cash and Bank'),\n            eq(accounts.category, 'Cash'),\n            eq(accounts.category, 'Bank')\n          )\n        )\n      )\n      .orderBy(accounts.accountNumber);\n    \n    return bankAccounts;\n  }\n\n  async processExpensePayment(\n    expenseId: string,\n    paidFromAccountId: string,\n    paidBy: string,\n    whtRate: string\n  ): Promise<Expense> {\n    // Get the expense details\n    const [expense] = await db\n      .select()\n      .from(expenses)\n      .where(eq(expenses.id, expenseId));\n    \n    if (!expense) {\n      throw new Error('Expense not found');\n    }\n    \n    if (expense.status !== 'approved') {\n      throw new Error('Only approved expenses can be paid');\n    }\n\n    // Get vendor details for notification\n    const [vendor] = await db\n      .select()\n      .from(vendors)\n      .where(eq(vendors.id, expense.vendorId!));\n\n    // Calculate payment amounts\n    const serviceChargeAmount = parseFloat(expense.serviceCharge || '0');\n    const whtRateNum = parseFloat(whtRate);\n    const whtAmount = (serviceChargeAmount * whtRateNum) / 100;\n    const totalAmount = parseFloat(expense.expenseAmount) + serviceChargeAmount;\n    const netPayment = totalAmount - whtAmount;\n\n    // Create journal entry for payment\n    const entryDate = new Date();\n    const entryNumber = await this.generateEntryNumber(entryDate);\n    \n    const journalEntryLines: InsertJournalEntryLine[] = [];\n    \n    // Debit: Accounts Payable (or Expense account if specified)\n    const debitAccountId = expense.accountId || (await this.getAccountByNumber('2200'))?.id;\n    if (debitAccountId) {\n      journalEntryLines.push({\n        accountId: debitAccountId,\n        lineType: 'debit',\n        amount: totalAmount.toFixed(2),\n        description: `Payment to ${vendor?.name || 'vendor'} - ${expense.description}`,\n      });\n    }\n\n    // Credit: Bank Account (net payment)\n    journalEntryLines.push({\n      accountId: paidFromAccountId,\n      lineType: 'credit',\n      amount: netPayment.toFixed(2),\n      description: `Payment to ${vendor?.name || 'vendor'}`,\n    });\n\n    // Credit: WHT Payable (if WHT is deducted)\n    if (whtAmount > 0) {\n      const whtAccount = await this.getAccountByNumber('2300'); // WHT Payable account\n      if (whtAccount) {\n        journalEntryLines.push({\n          accountId: whtAccount.id,\n          lineType: 'credit',\n          amount: whtAmount.toFixed(2),\n          description: `WHT deducted at ${whtRate}%`,\n        });\n      }\n    }\n\n    const journalEntry = await this.createJournalEntry(\n      {\n        entryDate,\n        description: `Payment for Expense: ${expense.description}`,\n        referenceType: 'expense_payment',\n        referenceId: expenseId,\n        createdBy: paidBy,\n        status: 'posted',\n        totalDebit: totalAmount.toFixed(2),\n        totalCredit: totalAmount.toFixed(2),\n      },\n      journalEntryLines as any\n    );\n\n    // Update expense record\n    const [updatedExpense] = await db\n      .update(expenses)\n      .set({\n        paymentStatus: 'paid',\n        paidDate: entryDate,\n        paidFromAccountId,\n        paidBy,\n        whtRate: whtRate,\n        whtAmount: whtAmount.toFixed(2),\n        netPayment: netPayment.toFixed(2),\n        paymentJournalEntryId: journalEntry.id,\n        updatedAt: new Date(),\n      })\n      .where(eq(expenses.id, expenseId))\n      .returning();\n\n    // Send notification to vendor if they have an email\n    if (vendor && vendor.email) {\n      // In a real system, this would send an email\n      // For now, we'll create a notification record if there's a vendor user account\n      // This is a placeholder - adjust based on your notification system\n      console.log(`Payment notification: Vendor ${vendor.name} paid ₦${netPayment.toFixed(2)} (WHT: ₦${whtAmount.toFixed(2)})`);\n    }\n\n    return updatedExpense;\n  }\n\n  async approveExpenseForPaymentLater(id: string, paidBy: string, whtRate: string): Promise<Expense> {\n    // Get the expense to calculate WHT\n    const [expense] = await db\n      .select()\n      .from(expenses)\n      .where(eq(expenses.id, id));\n    \n    if (!expense) {\n      throw new Error('Expense not found');\n    }\n    \n    if (expense.status !== 'approved') {\n      throw new Error('Only approved expenses can be marked for payment');\n    }\n\n    // Calculate WHT amount\n    const serviceChargeAmount = parseFloat(expense.serviceCharge || '0');\n    const whtRateNum = parseFloat(whtRate);\n    const whtAmount = (serviceChargeAmount * whtRateNum) / 100;\n    const totalAmount = parseFloat(expense.expenseAmount) + serviceChargeAmount;\n    const netPayment = totalAmount - whtAmount;\n\n    // Update expense to mark it approved for payment later\n    const [updatedExpense] = await db\n      .update(expenses)\n      .set({\n        paymentStatus: 'approved_for_payment',\n        whtRate: whtRate,\n        whtAmount: whtAmount.toFixed(2),\n        netPayment: netPayment.toFixed(2),\n        updatedAt: new Date(),\n      })\n      .where(eq(expenses.id, id))\n      .returning();\n\n    return updatedExpense;\n  }\n\n  // Budget operations\n  async getBudget(id: string): Promise<any> {\n    const [budget] = await db\n      .select()\n      .from(budgets)\n      .where(eq(budgets.id, id));\n    return budget;\n  }\n\n  async getBudgetWithLines(id: string): Promise<any> {\n    const budget = await this.getBudget(id);\n    if (!budget) return null;\n\n    const lines = await db\n      .select({\n        id: budgetLines.id,\n        budgetId: budgetLines.budgetId,\n        accountId: budgetLines.accountId,\n        accountNumber: accounts.accountNumber,\n        accountName: accounts.accountName,\n        accountType: accounts.accountType,\n        allocatedAmount: budgetLines.allocatedAmount,\n        consumedAmount: budgetLines.consumedAmount,\n        remainingAmount: budgetLines.remainingAmount,\n        notes: budgetLines.notes,\n        createdAt: budgetLines.createdAt,\n        updatedAt: budgetLines.updatedAt,\n      })\n      .from(budgetLines)\n      .leftJoin(accounts, eq(budgetLines.accountId, accounts.id))\n      .where(eq(budgetLines.budgetId, id))\n      .orderBy(accounts.accountNumber);\n\n    return { ...budget, budgetLines: lines };\n  }\n\n  async getAllBudgets(): Promise<any[]> {\n    const allBudgets = await db\n      .select({\n        id: budgets.id,\n        name: budgets.name,\n        description: budgets.description,\n        fiscalYear: budgets.fiscalYear,\n        periodType: budgets.periodType,\n        startDate: budgets.startDate,\n        endDate: budgets.endDate,\n        status: budgets.status,\n        totalBudgetAmount: budgets.totalBudgetAmount,\n        totalConsumedAmount: budgets.totalConsumedAmount,\n        totalRemainingAmount: budgets.totalRemainingAmount,\n        projectedCollections: budgets.projectedCollections,\n        actualCollections: budgets.actualCollections,\n        createdBy: budgets.createdBy,\n        creatorName: sql<string>`CONCAT(${users.firstName}, ' ', ${users.lastName})`,\n        createdAt: budgets.createdAt,\n        updatedAt: budgets.updatedAt,\n      })\n      .from(budgets)\n      .leftJoin(users, eq(budgets.createdBy, users.id))\n      .orderBy(desc(budgets.fiscalYear), desc(budgets.createdAt));\n    return allBudgets;\n  }\n\n  async getActiveBudgets(): Promise<any[]> {\n    const activeBudgets = await db\n      .select()\n      .from(budgets)\n      .where(eq(budgets.status, 'active'))\n      .orderBy(budgets.startDate);\n    return activeBudgets;\n  }\n\n  async getBudgetsByFiscalYear(fiscalYear: number): Promise<any[]> {\n    const yearBudgets = await db\n      .select()\n      .from(budgets)\n      .where(eq(budgets.fiscalYear, fiscalYear))\n      .orderBy(budgets.startDate);\n    return yearBudgets;\n  }\n\n  async createBudget(budgetData: InsertBudget, lines: InsertBudgetLine[]): Promise<Budget> {\n    // Calculate total budget amount from lines\n    const totalBudget = lines.reduce((sum, line) => {\n      return sum + parseFloat(line.allocatedAmount);\n    }, 0);\n\n    // Create budget\n    const [newBudget] = await db\n      .insert(budgets)\n      .values({\n        ...budgetData,\n        totalBudgetAmount: totalBudget.toFixed(2),\n        totalConsumedAmount: '0',\n        totalRemainingAmount: totalBudget.toFixed(2),\n        actualCollections: '0',\n      })\n      .returning();\n\n    // Create budget lines with calculated remaining amounts\n    const lineValues = lines.map(line => ({\n      ...line,\n      budgetId: newBudget.id,\n      consumedAmount: '0',\n      remainingAmount: line.allocatedAmount,\n    }));\n\n    await db.insert(budgetLines).values(lineValues);\n\n    return newBudget;\n  }\n\n  async updateBudget(id: string, data: Partial<InsertBudget>): Promise<Budget> {\n    const [updatedBudget] = await db\n      .update(budgets)\n      .set({\n        ...data,\n        updatedAt: new Date(),\n      })\n      .where(eq(budgets.id, id))\n      .returning();\n    return updatedBudget;\n  }\n\n  async deleteBudget(id: string): Promise<void> {\n    // Delete budget (cascade will delete budget lines)\n    await db.delete(budgets).where(eq(budgets.id, id));\n  }\n\n  async activateBudget(id: string): Promise<Budget> {\n    const [activatedBudget] = await db\n      .update(budgets)\n      .set({\n        status: 'active',\n        updatedAt: new Date(),\n      })\n      .where(eq(budgets.id, id))\n      .returning();\n    return activatedBudget;\n  }\n\n  async closeBudget(id: string): Promise<Budget> {\n    const [closedBudget] = await db\n      .update(budgets)\n      .set({\n        status: 'closed',\n        updatedAt: new Date(),\n      })\n      .where(eq(budgets.id, id))\n      .returning();\n    return closedBudget;\n  }\n\n  async updateBudgetConsumption(budgetId: string, accountId: string, amount: string): Promise<void> {\n    // Get the budget line\n    const [line] = await db\n      .select()\n      .from(budgetLines)\n      .where(and(\n        eq(budgetLines.budgetId, budgetId),\n        eq(budgetLines.accountId, accountId)\n      ));\n\n    if (!line) return;\n\n    // Update consumed and remaining amounts\n    const newConsumed = parseFloat(line.consumedAmount) + parseFloat(amount);\n    const newRemaining = parseFloat(line.allocatedAmount) - newConsumed;\n\n    await db\n      .update(budgetLines)\n      .set({\n        consumedAmount: newConsumed.toFixed(2),\n        remainingAmount: newRemaining.toFixed(2),\n        updatedAt: new Date(),\n      })\n      .where(eq(budgetLines.id, line.id));\n\n    // Update budget totals\n    const [budget] = await db\n      .select()\n      .from(budgets)\n      .where(eq(budgets.id, budgetId));\n\n    if (budget) {\n      const newTotalConsumed = parseFloat(budget.totalConsumedAmount) + parseFloat(amount);\n      const newTotalRemaining = parseFloat(budget.totalBudgetAmount) - newTotalConsumed;\n\n      await db\n        .update(budgets)\n        .set({\n          totalConsumedAmount: newTotalConsumed.toFixed(2),\n          totalRemainingAmount: newTotalRemaining.toFixed(2),\n          updatedAt: new Date(),\n        })\n        .where(eq(budgets.id, budgetId));\n    }\n  }\n\n  async getBudgetLineByAccount(budgetId: string, accountId: string): Promise<any> {\n    const [line] = await db\n      .select()\n      .from(budgetLines)\n      .where(and(\n        eq(budgetLines.budgetId, budgetId),\n        eq(budgetLines.accountId, accountId)\n      ));\n    return line;\n  }\n\n  async getActiveBudgetForAccount(accountId: string): Promise<any> {\n    const now = new Date();\n    const [activeBudget] = await db\n      .select({\n        budgetId: budgets.id,\n        budgetName: budgets.name,\n        budgetStatus: budgets.status,\n        lineId: budgetLines.id,\n        accountId: budgetLines.accountId,\n        allocatedAmount: budgetLines.allocatedAmount,\n        consumedAmount: budgetLines.consumedAmount,\n        remainingAmount: budgetLines.remainingAmount,\n      })\n      .from(budgets)\n      .innerJoin(budgetLines, eq(budgets.id, budgetLines.budgetId))\n      .where(and(\n        eq(budgets.status, 'active'),\n        eq(budgetLines.accountId, accountId),\n        lte(budgets.startDate, now),\n        gte(budgets.endDate, now)\n      ))\n      .limit(1);\n    \n    return activeBudget;\n  }\n\n  // Accounts Receivable operations\n  async getAllAREntries(): Promise<any[]> {\n    const entries = await db\n      .select({\n        id: bills.id,\n        invoiceNumber: bills.invoiceNumber,\n        residentId: bills.residentId,\n        residentName: sql`${residents.userId}`,\n        unitNumber: residents.unitNumber,\n        billingType: bills.billingType,\n        description: bills.description,\n        amount: bills.amount,\n        totalPaid: bills.totalPaid,\n        balance: bills.balance,\n        paymentStatus: bills.paymentStatus,\n        dueDate: bills.dueDate,\n        status: bills.status,\n        periodStart: bills.periodStart,\n        periodEnd: bills.periodEnd,\n        createdAt: bills.createdAt,\n      })\n      .from(bills)\n      .innerJoin(residents, eq(bills.residentId, residents.id))\n      .orderBy(desc(bills.createdAt));\n    \n    // Get user details for each resident\n    const entriesWithUserDetails = await Promise.all(\n      entries.map(async (entry) => {\n        const [user] = await db\n          .select()\n          .from(users)\n          .where(eq(users.id, entry.residentName as string));\n        \n        return {\n          ...entry,\n          residentName: user ? `${user.firstName} ${user.lastName}` : 'Unknown',\n          residentEmail: user?.email,\n        };\n      })\n    );\n    \n    return entriesWithUserDetails;\n  }\n\n  async getAREntry(billId: string): Promise<any> {\n    const [entry] = await db\n      .select({\n        id: bills.id,\n        invoiceNumber: bills.invoiceNumber,\n        residentId: bills.residentId,\n        userId: residents.userId,\n        unitNumber: residents.unitNumber,\n        billingType: bills.billingType,\n        description: bills.description,\n        amount: bills.amount,\n        totalPaid: bills.totalPaid,\n        balance: bills.balance,\n        paymentStatus: bills.paymentStatus,\n        dueDate: bills.dueDate,\n        status: bills.status,\n        periodStart: bills.periodStart,\n        periodEnd: bills.periodEnd,\n        createdAt: bills.createdAt,\n      })\n      .from(bills)\n      .innerJoin(residents, eq(bills.residentId, residents.id))\n      .where(eq(bills.id, billId));\n\n    if (!entry) return null;\n\n    const [user] = await db\n      .select()\n      .from(users)\n      .where(eq(users.id, entry.userId));\n\n    const applications = await this.getPaymentApplicationsByBill(billId);\n\n    return {\n      ...entry,\n      residentName: user ? `${user.firstName} ${user.lastName}` : 'Unknown',\n      residentEmail: user?.email,\n      paymentApplications: applications,\n    };\n  }\n\n  async applyPaymentToBill(\n    billId: string,\n    amountApplied: string,\n    applicationType: 'bank_statement' | 'manual',\n    paymentDate: Date,\n    appliedBy: string,\n    bankName?: string,\n    accountNumber?: string,\n    bankStatementEntryId?: string,\n    notes?: string\n  ): Promise<void> {\n    const bill = await this.getBill(billId);\n    if (!bill) throw new Error('Bill not found');\n\n    const amount = parseFloat(amountApplied);\n    const currentBalance = parseFloat(bill.balance);\n    \n    if (amount > currentBalance) {\n      throw new Error('Payment amount exceeds bill balance');\n    }\n\n    // Create payment application\n    await db.insert(paymentApplications).values({\n      billId,\n      bankStatementEntryId,\n      amountApplied: amountApplied,\n      applicationType,\n      bankName,\n      accountNumber,\n      paymentDate,\n      appliedBy,\n      notes,\n    });\n\n    // Update bill totals\n    const newTotalPaid = parseFloat(bill.totalPaid) + amount;\n    const newBalance = currentBalance - amount;\n    const newPaymentStatus = newBalance === 0 ? 'full_payment' : 'partial_payment';\n    const newStatus = newBalance === 0 ? 'paid' : (newBalance < currentBalance ? 'partial' : bill.status);\n\n    await db\n      .update(bills)\n      .set({\n        totalPaid: newTotalPaid.toFixed(2),\n        balance: newBalance.toFixed(2),\n        paymentStatus: newPaymentStatus,\n        status: newStatus,\n        updatedAt: new Date(),\n      })\n      .where(eq(bills.id, billId));\n\n    // Create GL posting for the payment (Modified Cash-Based Accounting)\n    // This is where revenue recognition happens - when cash is received\n    // DR: Cash/Bank Account\n    // CR: Accounts Receivable (1100) - reduce the receivable\n    // DR: Deferred Revenue (2200) - reduce the liability\n    // CR: Member Dues (4000) - recognize the revenue\n    const arAccount = await this.getAccountByNumber('1100');\n    if (!arAccount) throw new Error('Accounts Receivable account (1100) not found');\n    \n    const deferredRevenueAccount = await this.getAccountByNumber('2200');\n    if (!deferredRevenueAccount) throw new Error('Deferred Revenue account (2200) not found');\n    \n    const memberDuesAccount = await this.getAccountByNumber('4000');\n    if (!memberDuesAccount) throw new Error('Member Dues revenue account (4000) not found');\n\n    const lines: InsertJournalEntryLine[] = [];\n\n    // DR: Cash/Bank (if bank details provided, otherwise generic cash account)\n    if (bankName && accountNumber) {\n      // Try to find the bank account in the chart of accounts\n      const bankAccounts = await db\n        .select()\n        .from(accounts)\n        .where(and(\n          eq(accounts.accountType, 'asset'),\n          eq(accounts.category, 'cash_bank')\n        ));\n      \n      const bankAccount = bankAccounts.find(acc => \n        acc.accountName.toLowerCase().includes(bankName.toLowerCase()) ||\n        acc.description?.toLowerCase().includes(accountNumber)\n      );\n\n      if (bankAccount) {\n        lines.push({\n          journalEntryId: '', // Will be set by createJournalEntry\n          accountId: bankAccount.id,\n          lineType: 'debit',\n          amount: amountApplied,\n          description: `Payment from ${bankName} - ${accountNumber}`,\n        });\n      } else {\n        // Use generic cash account\n        const [cashAccount] = await db\n          .select()\n          .from(accounts)\n          .where(and(\n            eq(accounts.accountType, 'asset'),\n            eq(accounts.category, 'cash_bank')\n          ))\n          .limit(1);\n        \n        if (cashAccount) {\n          lines.push({\n            journalEntryId: '', // Will be set by createJournalEntry\n            accountId: cashAccount.id,\n            lineType: 'debit',\n            amount: amountApplied,\n            description: `Payment from ${bankName} - ${accountNumber}`,\n          });\n        }\n      }\n    } else {\n      // Use generic cash account\n      const [cashAccount] = await db\n        .select()\n        .from(accounts)\n        .where(and(\n          eq(accounts.accountType, 'asset'),\n          eq(accounts.category, 'cash_bank')\n        ))\n        .limit(1);\n      \n      if (cashAccount) {\n        lines.push({\n          journalEntryId: '', // Will be set by createJournalEntry\n          accountId: cashAccount.id,\n          lineType: 'debit',\n          amount: amountApplied,\n          description: 'Payment received',\n        });\n      }\n    }\n\n    // CR: Accounts Receivable - reduce the receivable\n    lines.push({\n      journalEntryId: '', // Will be set by createJournalEntry\n      accountId: arAccount.id,\n      lineType: 'credit',\n      amount: amountApplied,\n      description: `Payment for ${bill.invoiceNumber} - reduce AR`,\n    });\n    \n    // DR: Deferred Revenue - reduce the liability (revenue was deferred at billing)\n    lines.push({\n      journalEntryId: '', // Will be set by createJournalEntry\n      accountId: deferredRevenueAccount.id,\n      lineType: 'debit',\n      amount: amountApplied,\n      description: `Relieve deferred revenue for ${bill.invoiceNumber}`,\n    });\n    \n    // CR: Member Dues Revenue - recognize the revenue NOW (modified cash-based accounting)\n    lines.push({\n      journalEntryId: '', // Will be set by createJournalEntry\n      accountId: memberDuesAccount.id,\n      lineType: 'credit',\n      amount: amountApplied,\n      description: `Revenue recognized for ${bill.invoiceNumber}`,\n    });\n\n    // Create journal entry with lines (automatically posts and updates balances)\n    const journalEntry = await this.createJournalEntry({\n      entryDate: paymentDate,\n      description: `Payment received for ${bill.invoiceNumber} - ${applicationType === 'bank_statement' ? 'Bank Statement' : 'Manual Entry'}`,\n      referenceId: billId,\n      referenceType: 'bill',\n      createdBy: appliedBy,\n      status: 'posted',\n    }, lines);\n\n    // Update payment application with journal entry reference\n    await db\n      .update(paymentApplications)\n      .set({ journalEntryId: journalEntry.id })\n      .where(and(\n        eq(paymentApplications.billId, billId),\n        eq(paymentApplications.appliedAt, sql`(SELECT MAX(applied_at) FROM payment_applications WHERE bill_id = ${billId})`)\n      ));\n  }\n\n  // Bank Statement operations\n  async createBankStatement(statement: any): Promise<any> {\n    const [newStatement] = await db\n      .insert(bankStatements)\n      .values(statement)\n      .returning();\n    return newStatement;\n  }\n\n  async getBankStatement(id: string): Promise<any> {\n    const [statement] = await db\n      .select()\n      .from(bankStatements)\n      .where(eq(bankStatements.id, id));\n    return statement;\n  }\n\n  async getAllBankStatements(): Promise<any[]> {\n    const statements = await db\n      .select()\n      .from(bankStatements)\n      .orderBy(desc(bankStatements.uploadedAt));\n    return statements;\n  }\n\n  async updateBankStatementStatus(id: string, status: string): Promise<void> {\n    await db\n      .update(bankStatements)\n      .set({ status: status as 'pending' | 'processing' | 'completed' | 'error' })\n      .where(eq(bankStatements.id, id));\n  }\n\n  // Bank Statement Entry operations\n  async createBankStatementEntry(entry: any): Promise<any> {\n    const [newEntry] = await db\n      .insert(bankStatementEntries)\n      .values(entry)\n      .returning();\n    return newEntry;\n  }\n\n  async getBankStatementEntries(statementId: string): Promise<any[]> {\n    const entries = await db\n      .select()\n      .from(bankStatementEntries)\n      .where(eq(bankStatementEntries.statementId, statementId))\n      .orderBy(desc(bankStatementEntries.transactionDate));\n    return entries;\n  }\n\n  async getUnreconciledEntries(): Promise<any[]> {\n    const entries = await db\n      .select()\n      .from(bankStatementEntries)\n      .where(or(\n        eq(bankStatementEntries.status, 'unmatched'),\n        eq(bankStatementEntries.status, 'matched')\n      ))\n      .orderBy(desc(bankStatementEntries.transactionDate));\n    return entries;\n  }\n\n  async updateEntryStatus(id: string, status: string): Promise<void> {\n    await db\n      .update(bankStatementEntries)\n      .set({ status: status as 'unmatched' | 'matched' | 'partially_matched' | 'reconciled' })\n      .where(eq(bankStatementEntries.id, id));\n  }\n\n  // Payment Application operations\n  async getPaymentApplicationsByBill(billId: string): Promise<any[]> {\n    const applications = await db\n      .select({\n        id: paymentApplications.id,\n        amountApplied: paymentApplications.amountApplied,\n        applicationType: paymentApplications.applicationType,\n        bankName: paymentApplications.bankName,\n        accountNumber: paymentApplications.accountNumber,\n        paymentDate: paymentApplications.paymentDate,\n        appliedBy: paymentApplications.appliedBy,\n        appliedAt: paymentApplications.appliedAt,\n        journalEntryId: paymentApplications.journalEntryId,\n        notes: paymentApplications.notes,\n        userName: sql`${users.firstName} || ' ' || ${users.lastName}`,\n      })\n      .from(paymentApplications)\n      .innerJoin(users, eq(paymentApplications.appliedBy, users.id))\n      .where(eq(paymentApplications.billId, billId))\n      .orderBy(desc(paymentApplications.appliedAt));\n    \n    return applications;\n  }\n\n  async getAllPaymentApplications(): Promise<any[]> {\n    const applications = await db\n      .select()\n      .from(paymentApplications)\n      .orderBy(desc(paymentApplications.paymentDate));\n    \n    return applications;\n  }\n\n  // User Invite operations\n  async createUserInvite(invite: InsertUserInvite): Promise<UserInvite> {\n    const [createdInvite] = await db\n      .insert(userInvites)\n      .values(invite)\n      .returning();\n    return createdInvite;\n  }\n\n  async getUserInvite(inviteToken: string): Promise<UserInvite | undefined> {\n    const [invite] = await db\n      .select()\n      .from(userInvites)\n      .where(eq(userInvites.inviteToken, inviteToken));\n    return invite;\n  }\n\n  async getAcceptedInviteByUserId(userId: string): Promise<UserInvite | undefined> {\n    const [invite] = await db\n      .select()\n      .from(userInvites)\n      .where(\n        and(\n          eq(userInvites.acceptedByUserId, userId),\n          eq(userInvites.status, 'accepted')\n        )\n      );\n    return invite;\n  }\n\n  async getAllUserInvites(): Promise<UserInvite[]> {\n    const invites = await db\n      .select()\n      .from(userInvites)\n      .orderBy(desc(userInvites.createdAt));\n    return invites;\n  }\n\n  async acceptUserInvite(inviteToken: string, userId: string): Promise<void> {\n    // Only accept if still pending\n    const [invite] = await db\n      .select()\n      .from(userInvites)\n      .where(eq(userInvites.inviteToken, inviteToken));\n    \n    if (!invite || invite.status !== 'pending') {\n      throw new Error('Invite already used or expired');\n    }\n\n    if (new Date() > new Date(invite.expiresAt)) {\n      await this.expireUserInvite(invite.id);\n      throw new Error('Invite has expired');\n    }\n\n    await db\n      .update(userInvites)\n      .set({ \n        status: 'accepted', \n        acceptedAt: new Date(),\n        acceptedByUserId: userId \n      })\n      .where(and(\n        eq(userInvites.inviteToken, inviteToken),\n        eq(userInvites.status, 'pending')\n      ));\n  }\n\n  async expireUserInvite(id: string): Promise<void> {\n    await db\n      .update(userInvites)\n      .set({ status: 'expired' })\n      .where(eq(userInvites.id, id));\n  }\n}\n\nexport const storage = new DatabaseStorage();\n","size_bytes":111952},"client/src/components/ui/dropdown-menu.tsx":{"content":"import * as React from \"react\"\nimport * as DropdownMenuPrimitive from \"@radix-ui/react-dropdown-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst DropdownMenu = DropdownMenuPrimitive.Root\n\nconst DropdownMenuTrigger = DropdownMenuPrimitive.Trigger\n\nconst DropdownMenuGroup = DropdownMenuPrimitive.Group\n\nconst DropdownMenuPortal = DropdownMenuPrimitive.Portal\n\nconst DropdownMenuSub = DropdownMenuPrimitive.Sub\n\nconst DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup\n\nconst DropdownMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto\" />\n  </DropdownMenuPrimitive.SubTrigger>\n))\nDropdownMenuSubTrigger.displayName =\n  DropdownMenuPrimitive.SubTrigger.displayName\n\nconst DropdownMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuSubContent.displayName =\n  DropdownMenuPrimitive.SubContent.displayName\n\nconst DropdownMenuContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <DropdownMenuPrimitive.Portal>\n    <DropdownMenuPrimitive.Content\n      ref={ref}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 max-h-[var(--radix-dropdown-menu-content-available-height)] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </DropdownMenuPrimitive.Portal>\n))\nDropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName\n\nconst DropdownMenuItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName\n\nconst DropdownMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <DropdownMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.CheckboxItem>\n))\nDropdownMenuCheckboxItem.displayName =\n  DropdownMenuPrimitive.CheckboxItem.displayName\n\nconst DropdownMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.RadioItem>\n))\nDropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName\n\nconst DropdownMenuLabel = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName\n\nconst DropdownMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nDropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName\n\nconst DropdownMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\"ml-auto text-xs tracking-widest opacity-60\", className)}\n      {...props}\n    />\n  )\n}\nDropdownMenuShortcut.displayName = \"DropdownMenuShortcut\"\n\nexport {\n  DropdownMenu,\n  DropdownMenuTrigger,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuCheckboxItem,\n  DropdownMenuRadioItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuShortcut,\n  DropdownMenuGroup,\n  DropdownMenuPortal,\n  DropdownMenuSub,\n  DropdownMenuSubContent,\n  DropdownMenuSubTrigger,\n  DropdownMenuRadioGroup,\n}\n","size_bytes":7609},"client/src/components/ui/button.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst buttonVariants = cva(\n  \"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\" +\n  \" hover-elevate active-elevate-2\",\n  {\n    variants: {\n      variant: {\n        default:\n          \"bg-primary text-primary-foreground border border-primary-border\",\n        destructive:\n          \"bg-destructive text-destructive-foreground border border-destructive-border\",\n        outline:\n          // Shows the background color of whatever card / sidebar / accent background it is inside of.\n          // Inherits the current text color.\n          \" border [border-color:var(--button-outline)]  shadow-xs active:shadow-none \",\n        secondary: \"border bg-secondary text-secondary-foreground border border-secondary-border \",\n        // Add a transparent border so that when someone toggles a border on later, it doesn't shift layout/size.\n        ghost: \"border border-transparent\",\n      },\n      // Heights are set as \"min\" heights, because sometimes Ai will place large amount of content\n      // inside buttons. With a min-height they will look appropriate with small amounts of content,\n      // but will expand to fit large amounts of content.\n      size: {\n        default: \"min-h-9 px-4 py-2\",\n        sm: \"min-h-8 rounded-md px-3 text-xs\",\n        lg: \"min-h-10 rounded-md px-8\",\n        icon: \"h-9 w-9\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  },\n)\n\nexport interface ButtonProps\n  extends React.ButtonHTMLAttributes<HTMLButtonElement>,\n    VariantProps<typeof buttonVariants> {\n  asChild?: boolean\n}\n\nconst Button = React.forwardRef<HTMLButtonElement, ButtonProps>(\n  ({ className, variant, size, asChild = false, ...props }, ref) => {\n    const Comp = asChild ? Slot : \"button\"\n    return (\n      <Comp\n        className={cn(buttonVariants({ variant, size, className }))}\n        ref={ref}\n        {...props}\n      />\n    )\n  },\n)\nButton.displayName = \"Button\"\n\nexport { Button, buttonVariants }\n","size_bytes":2359},"client/src/components/ui/hover-card.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as HoverCardPrimitive from \"@radix-ui/react-hover-card\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst HoverCard = HoverCardPrimitive.Root\n\nconst HoverCardTrigger = HoverCardPrimitive.Trigger\n\nconst HoverCardContent = React.forwardRef<\n  React.ElementRef<typeof HoverCardPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof HoverCardPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <HoverCardPrimitive.Content\n    ref={ref}\n    align={align}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 w-64 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-hover-card-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nHoverCardContent.displayName = HoverCardPrimitive.Content.displayName\n\nexport { HoverCard, HoverCardTrigger, HoverCardContent }\n","size_bytes":1251},"client/src/components/ui/carousel.tsx":{"content":"import * as React from \"react\"\nimport useEmblaCarousel, {\n  type UseEmblaCarouselType,\n} from \"embla-carousel-react\"\nimport { ArrowLeft, ArrowRight } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\n\ntype CarouselApi = UseEmblaCarouselType[1]\ntype UseCarouselParameters = Parameters<typeof useEmblaCarousel>\ntype CarouselOptions = UseCarouselParameters[0]\ntype CarouselPlugin = UseCarouselParameters[1]\n\ntype CarouselProps = {\n  opts?: CarouselOptions\n  plugins?: CarouselPlugin\n  orientation?: \"horizontal\" | \"vertical\"\n  setApi?: (api: CarouselApi) => void\n}\n\ntype CarouselContextProps = {\n  carouselRef: ReturnType<typeof useEmblaCarousel>[0]\n  api: ReturnType<typeof useEmblaCarousel>[1]\n  scrollPrev: () => void\n  scrollNext: () => void\n  canScrollPrev: boolean\n  canScrollNext: boolean\n} & CarouselProps\n\nconst CarouselContext = React.createContext<CarouselContextProps | null>(null)\n\nfunction useCarousel() {\n  const context = React.useContext(CarouselContext)\n\n  if (!context) {\n    throw new Error(\"useCarousel must be used within a <Carousel />\")\n  }\n\n  return context\n}\n\nconst Carousel = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & CarouselProps\n>(\n  (\n    {\n      orientation = \"horizontal\",\n      opts,\n      setApi,\n      plugins,\n      className,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const [carouselRef, api] = useEmblaCarousel(\n      {\n        ...opts,\n        axis: orientation === \"horizontal\" ? \"x\" : \"y\",\n      },\n      plugins\n    )\n    const [canScrollPrev, setCanScrollPrev] = React.useState(false)\n    const [canScrollNext, setCanScrollNext] = React.useState(false)\n\n    const onSelect = React.useCallback((api: CarouselApi) => {\n      if (!api) {\n        return\n      }\n\n      setCanScrollPrev(api.canScrollPrev())\n      setCanScrollNext(api.canScrollNext())\n    }, [])\n\n    const scrollPrev = React.useCallback(() => {\n      api?.scrollPrev()\n    }, [api])\n\n    const scrollNext = React.useCallback(() => {\n      api?.scrollNext()\n    }, [api])\n\n    const handleKeyDown = React.useCallback(\n      (event: React.KeyboardEvent<HTMLDivElement>) => {\n        if (event.key === \"ArrowLeft\") {\n          event.preventDefault()\n          scrollPrev()\n        } else if (event.key === \"ArrowRight\") {\n          event.preventDefault()\n          scrollNext()\n        }\n      },\n      [scrollPrev, scrollNext]\n    )\n\n    React.useEffect(() => {\n      if (!api || !setApi) {\n        return\n      }\n\n      setApi(api)\n    }, [api, setApi])\n\n    React.useEffect(() => {\n      if (!api) {\n        return\n      }\n\n      onSelect(api)\n      api.on(\"reInit\", onSelect)\n      api.on(\"select\", onSelect)\n\n      return () => {\n        api?.off(\"select\", onSelect)\n      }\n    }, [api, onSelect])\n\n    return (\n      <CarouselContext.Provider\n        value={{\n          carouselRef,\n          api: api,\n          opts,\n          orientation:\n            orientation || (opts?.axis === \"y\" ? \"vertical\" : \"horizontal\"),\n          scrollPrev,\n          scrollNext,\n          canScrollPrev,\n          canScrollNext,\n        }}\n      >\n        <div\n          ref={ref}\n          onKeyDownCapture={handleKeyDown}\n          className={cn(\"relative\", className)}\n          role=\"region\"\n          aria-roledescription=\"carousel\"\n          {...props}\n        >\n          {children}\n        </div>\n      </CarouselContext.Provider>\n    )\n  }\n)\nCarousel.displayName = \"Carousel\"\n\nconst CarouselContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { carouselRef, orientation } = useCarousel()\n\n  return (\n    <div ref={carouselRef} className=\"overflow-hidden\">\n      <div\n        ref={ref}\n        className={cn(\n          \"flex\",\n          orientation === \"horizontal\" ? \"-ml-4\" : \"-mt-4 flex-col\",\n          className\n        )}\n        {...props}\n      />\n    </div>\n  )\n})\nCarouselContent.displayName = \"CarouselContent\"\n\nconst CarouselItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { orientation } = useCarousel()\n\n  return (\n    <div\n      ref={ref}\n      role=\"group\"\n      aria-roledescription=\"slide\"\n      className={cn(\n        \"min-w-0 shrink-0 grow-0 basis-full\",\n        orientation === \"horizontal\" ? \"pl-4\" : \"pt-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nCarouselItem.displayName = \"CarouselItem\"\n\nconst CarouselPrevious = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollPrev, canScrollPrev } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute  h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-left-12 top-1/2 -translate-y-1/2\"\n          : \"-top-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollPrev}\n      onClick={scrollPrev}\n      {...props}\n    >\n      <ArrowLeft className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Previous slide</span>\n    </Button>\n  )\n})\nCarouselPrevious.displayName = \"CarouselPrevious\"\n\nconst CarouselNext = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollNext, canScrollNext } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-right-12 top-1/2 -translate-y-1/2\"\n          : \"-bottom-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollNext}\n      onClick={scrollNext}\n      {...props}\n    >\n      <ArrowRight className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Next slide</span>\n    </Button>\n  )\n})\nCarouselNext.displayName = \"CarouselNext\"\n\nexport {\n  type CarouselApi,\n  Carousel,\n  CarouselContent,\n  CarouselItem,\n  CarouselPrevious,\n  CarouselNext,\n}\n","size_bytes":6210},"client/src/components/ui/textarea.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Textarea = React.forwardRef<\n  HTMLTextAreaElement,\n  React.ComponentProps<\"textarea\">\n>(({ className, ...props }, ref) => {\n  return (\n    <textarea\n      className={cn(\n        \"flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  )\n})\nTextarea.displayName = \"Textarea\"\n\nexport { Textarea }\n","size_bytes":689},"client/src/components/ui/alert.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst alertVariants = cva(\n  \"relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-background text-foreground\",\n        destructive:\n          \"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Alert = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>\n>(({ className, variant, ...props }, ref) => (\n  <div\n    ref={ref}\n    role=\"alert\"\n    className={cn(alertVariants({ variant }), className)}\n    {...props}\n  />\n))\nAlert.displayName = \"Alert\"\n\nconst AlertTitle = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLHeadingElement>\n>(({ className, ...props }, ref) => (\n  <h5\n    ref={ref}\n    className={cn(\"mb-1 font-medium leading-none tracking-tight\", className)}\n    {...props}\n  />\n))\nAlertTitle.displayName = \"AlertTitle\"\n\nconst AlertDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm [&_p]:leading-relaxed\", className)}\n    {...props}\n  />\n))\nAlertDescription.displayName = \"AlertDescription\"\n\nexport { Alert, AlertTitle, AlertDescription }\n","size_bytes":1584},"client/src/components/ui/popover.tsx":{"content":"import * as React from \"react\"\nimport * as PopoverPrimitive from \"@radix-ui/react-popover\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Popover = PopoverPrimitive.Root\n\nconst PopoverTrigger = PopoverPrimitive.Trigger\n\nconst PopoverContent = React.forwardRef<\n  React.ElementRef<typeof PopoverPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <PopoverPrimitive.Portal>\n    <PopoverPrimitive.Content\n      ref={ref}\n      align={align}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-popover-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </PopoverPrimitive.Portal>\n))\nPopoverContent.displayName = PopoverPrimitive.Content.displayName\n\nexport { Popover, PopoverTrigger, PopoverContent }\n","size_bytes":1280},"client/src/components/ui/checkbox.tsx":{"content":"import * as React from \"react\"\nimport * as CheckboxPrimitive from \"@radix-ui/react-checkbox\"\nimport { Check } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Checkbox = React.forwardRef<\n  React.ElementRef<typeof CheckboxPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <CheckboxPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground\",\n      className\n    )}\n    {...props}\n  >\n    <CheckboxPrimitive.Indicator\n      className={cn(\"flex items-center justify-center text-current\")}\n    >\n      <Check className=\"h-4 w-4\" />\n    </CheckboxPrimitive.Indicator>\n  </CheckboxPrimitive.Root>\n))\nCheckbox.displayName = CheckboxPrimitive.Root.displayName\n\nexport { Checkbox }\n","size_bytes":1056},"client/src/lib/authUtils.ts":{"content":"export function isUnauthorizedError(error: Error): boolean {\n  return /^401: .*Unauthorized/.test(error.message);\n}\n","size_bytes":116},"client/src/components/ui/slider.tsx":{"content":"import * as React from \"react\"\nimport * as SliderPrimitive from \"@radix-ui/react-slider\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Slider = React.forwardRef<\n  React.ElementRef<typeof SliderPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SliderPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <SliderPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative flex w-full touch-none select-none items-center\",\n      className\n    )}\n    {...props}\n  >\n    <SliderPrimitive.Track className=\"relative h-2 w-full grow overflow-hidden rounded-full bg-secondary\">\n      <SliderPrimitive.Range className=\"absolute h-full bg-primary\" />\n    </SliderPrimitive.Track>\n    <SliderPrimitive.Thumb className=\"block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50\" />\n  </SliderPrimitive.Root>\n))\nSlider.displayName = SliderPrimitive.Root.displayName\n\nexport { Slider }\n","size_bytes":1077},"client/src/components/ui/skeleton.tsx":{"content":"import { cn } from \"@/lib/utils\"\n\nfunction Skeleton({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) {\n  return (\n    <div\n      className={cn(\"animate-pulse rounded-md bg-muted\", className)}\n      {...props}\n    />\n  )\n}\n\nexport { Skeleton }\n","size_bytes":261},"client/src/components/ui/scroll-area.tsx":{"content":"import * as React from \"react\"\nimport * as ScrollAreaPrimitive from \"@radix-ui/react-scroll-area\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ScrollArea = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <ScrollAreaPrimitive.Root\n    ref={ref}\n    className={cn(\"relative overflow-hidden\", className)}\n    {...props}\n  >\n    <ScrollAreaPrimitive.Viewport className=\"h-full w-full rounded-[inherit]\">\n      {children}\n    </ScrollAreaPrimitive.Viewport>\n    <ScrollBar />\n    <ScrollAreaPrimitive.Corner />\n  </ScrollAreaPrimitive.Root>\n))\nScrollArea.displayName = ScrollAreaPrimitive.Root.displayName\n\nconst ScrollBar = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>\n>(({ className, orientation = \"vertical\", ...props }, ref) => (\n  <ScrollAreaPrimitive.ScrollAreaScrollbar\n    ref={ref}\n    orientation={orientation}\n    className={cn(\n      \"flex touch-none select-none transition-colors\",\n      orientation === \"vertical\" &&\n        \"h-full w-2.5 border-l border-l-transparent p-[1px]\",\n      orientation === \"horizontal\" &&\n        \"h-2.5 flex-col border-t border-t-transparent p-[1px]\",\n      className\n    )}\n    {...props}\n  >\n    <ScrollAreaPrimitive.ScrollAreaThumb className=\"relative flex-1 rounded-full bg-border\" />\n  </ScrollAreaPrimitive.ScrollAreaScrollbar>\n))\nScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName\n\nexport { ScrollArea, ScrollBar }\n","size_bytes":1642},"client/src/components/ui/toast.tsx":{"content":"import * as React from \"react\"\nimport * as ToastPrimitives from \"@radix-ui/react-toast\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ToastProvider = ToastPrimitives.Provider\n\nconst ToastViewport = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Viewport>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Viewport>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Viewport\n    ref={ref}\n    className={cn(\n      \"fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]\",\n      className\n    )}\n    {...props}\n  />\n))\nToastViewport.displayName = ToastPrimitives.Viewport.displayName\n\nconst toastVariants = cva(\n  \"group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full\",\n  {\n    variants: {\n      variant: {\n        default: \"border bg-background text-foreground\",\n        destructive:\n          \"destructive group border-destructive bg-destructive text-destructive-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Toast = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Root> &\n    VariantProps<typeof toastVariants>\n>(({ className, variant, ...props }, ref) => {\n  return (\n    <ToastPrimitives.Root\n      ref={ref}\n      className={cn(toastVariants({ variant }), className)}\n      {...props}\n    />\n  )\n})\nToast.displayName = ToastPrimitives.Root.displayName\n\nconst ToastAction = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Action>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Action>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Action\n    ref={ref}\n    className={cn(\n      \"inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive\",\n      className\n    )}\n    {...props}\n  />\n))\nToastAction.displayName = ToastPrimitives.Action.displayName\n\nconst ToastClose = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Close>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Close>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Close\n    ref={ref}\n    className={cn(\n      \"absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600\",\n      className\n    )}\n    toast-close=\"\"\n    {...props}\n  >\n    <X className=\"h-4 w-4\" />\n  </ToastPrimitives.Close>\n))\nToastClose.displayName = ToastPrimitives.Close.displayName\n\nconst ToastTitle = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Title>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Title>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Title\n    ref={ref}\n    className={cn(\"text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nToastTitle.displayName = ToastPrimitives.Title.displayName\n\nconst ToastDescription = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Description>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Description>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Description\n    ref={ref}\n    className={cn(\"text-sm opacity-90\", className)}\n    {...props}\n  />\n))\nToastDescription.displayName = ToastPrimitives.Description.displayName\n\ntype ToastProps = React.ComponentPropsWithoutRef<typeof Toast>\n\ntype ToastActionElement = React.ReactElement<typeof ToastAction>\n\nexport {\n  type ToastProps,\n  type ToastActionElement,\n  ToastProvider,\n  ToastViewport,\n  Toast,\n  ToastTitle,\n  ToastDescription,\n  ToastClose,\n  ToastAction,\n}\n","size_bytes":4845},"client/src/pages/not-found.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { AlertCircle } from \"lucide-react\";\n\nexport default function NotFound() {\n  return (\n    <div className=\"min-h-screen w-full flex items-center justify-center bg-gray-50\">\n      <Card className=\"w-full max-w-md mx-4\">\n        <CardContent className=\"pt-6\">\n          <div className=\"flex mb-4 gap-2\">\n            <AlertCircle className=\"h-8 w-8 text-red-500\" />\n            <h1 className=\"text-2xl font-bold text-gray-900\">404 Page Not Found</h1>\n          </div>\n\n          <p className=\"mt-4 text-sm text-gray-600\">\n            Did you forget to add the page to the router?\n          </p>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":711},"client/src/components/ui/label.tsx":{"content":"import * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst labelVariants = cva(\n  \"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70\"\n)\n\nconst Label = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &\n    VariantProps<typeof labelVariants>\n>(({ className, ...props }, ref) => (\n  <LabelPrimitive.Root\n    ref={ref}\n    className={cn(labelVariants(), className)}\n    {...props}\n  />\n))\nLabel.displayName = LabelPrimitive.Root.displayName\n\nexport { Label }\n","size_bytes":710},"server/replitAuth.ts":{"content":"import * as client from \"openid-client\";\nimport { Strategy, type VerifyFunction } from \"openid-client/passport\";\n\nimport passport from \"passport\";\nimport session from \"express-session\";\nimport type { Express, RequestHandler } from \"express\";\nimport memoize from \"memoizee\";\nimport connectPg from \"connect-pg-simple\";\nimport { storage } from \"./storage\";\n\n// Extend session to include intendedRole and inviteToken\ndeclare module \"express-session\" {\n  interface SessionData {\n    intendedRole?: string;\n    inviteToken?: string;\n  }\n}\n\nconst getOidcConfig = memoize(\n  async () => {\n    return await client.discovery(\n      new URL(process.env.ISSUER_URL ?? \"https://replit.com/oidc\"),\n      process.env.REPL_ID!\n    );\n  },\n  { maxAge: 3600 * 1000 }\n);\n\nexport function getSession() {\n  const sessionTtl = 7 * 24 * 60 * 60 * 1000; // 1 week\n  const pgStore = connectPg(session);\n  const sessionStore = new pgStore({\n    conString: process.env.DATABASE_URL,\n    createTableIfMissing: false,\n    ttl: sessionTtl,\n    tableName: \"sessions\",\n  });\n  return session({\n    secret: process.env.SESSION_SECRET!,\n    store: sessionStore,\n    resave: false,\n    saveUninitialized: false,\n    cookie: {\n      httpOnly: true,\n      secure: true,\n      maxAge: sessionTtl,\n    },\n  });\n}\n\nfunction updateUserSession(\n  user: any,\n  tokens: client.TokenEndpointResponse & client.TokenEndpointResponseHelpers\n) {\n  user.claims = tokens.claims();\n  user.access_token = tokens.access_token;\n  user.refresh_token = tokens.refresh_token;\n  user.expires_at = user.claims?.exp;\n}\n\nasync function upsertUser(\n  claims: any,\n) {\n  await storage.upsertUser({\n    id: claims[\"sub\"],\n    email: claims[\"email\"],\n    firstName: claims[\"first_name\"],\n    lastName: claims[\"last_name\"],\n    profileImageUrl: claims[\"profile_image_url\"],\n  });\n}\n\nexport async function setupAuth(app: Express) {\n  app.set(\"trust proxy\", 1);\n  app.use(getSession());\n  app.use(passport.initialize());\n  app.use(passport.session());\n\n  const config = await getOidcConfig();\n\n  const verify: VerifyFunction = async (\n    tokens: client.TokenEndpointResponse & client.TokenEndpointResponseHelpers,\n    verified: passport.AuthenticateCallback\n  ) => {\n    const user = {};\n    updateUserSession(user, tokens);\n    // Note: User creation is handled in the callback to ensure correct role assignment\n    // from invites. We only update session here.\n    verified(null, user);\n  };\n\n  // Keep track of registered strategies\n  const registeredStrategies = new Set<string>();\n\n  // Helper function to ensure strategy exists for a domain\n  const ensureStrategy = (domain: string) => {\n    const strategyName = `replitauth:${domain}`;\n    if (!registeredStrategies.has(strategyName)) {\n      const strategy = new Strategy(\n        {\n          name: strategyName,\n          config,\n          scope: \"openid email profile offline_access\",\n          callbackURL: `https://${domain}/api/callback`,\n        },\n        verify,\n      );\n      passport.use(strategy);\n      registeredStrategies.add(strategyName);\n    }\n  };\n\n  passport.serializeUser((user: Express.User, cb) => cb(null, user));\n  passport.deserializeUser((user: Express.User, cb) => cb(null, user));\n\n  app.get(\"/api/login\", (req, res, next) => {\n    ensureStrategy(req.hostname);\n    \n    // Store intended role preference in session\n    const intendedRole = req.query.role as string;\n    if (intendedRole === 'admin' || intendedRole === 'resident') {\n      req.session.intendedRole = intendedRole;\n    }\n    \n    passport.authenticate(`replitauth:${req.hostname}`, {\n      prompt: \"login consent\",\n      scope: [\"openid\", \"email\", \"profile\", \"offline_access\"],\n    })(req, res, next);\n  });\n\n  app.get(\"/api/callback\", async (req, res, next) => {\n    ensureStrategy(req.hostname);\n    \n    passport.authenticate(`replitauth:${req.hostname}`, {\n      failureRedirect: \"/api/login\",\n    })(req, res, async (err: any) => {\n      if (err) {\n        return next(err);\n      }\n      \n      const user = req.user as any;\n      const userId = user?.claims?.sub;\n      \n      if (!userId) {\n        return next(new Error(\"User ID not found\"));\n      }\n      \n      // Check if there's an invite token in session\n      const inviteToken = req.session.inviteToken;\n      \n      if (inviteToken) {\n        try {\n          // Validate and process the invite\n          const invite = await storage.getUserInvite(inviteToken);\n          \n          if (!invite) {\n            console.error(\"Invite not found:\", inviteToken);\n            delete req.session.inviteToken;\n            return res.redirect(\"/?error=invite_not_found\");\n          }\n          \n          if (invite.status !== 'pending') {\n            console.error(\"Invite already used or expired:\", inviteToken);\n            delete req.session.inviteToken;\n            return res.redirect(\"/?error=invite_used\");\n          }\n          \n          if (new Date() > new Date(invite.expiresAt)) {\n            console.error(\"Invite expired:\", inviteToken);\n            await storage.expireUserInvite(invite.id);\n            delete req.session.inviteToken;\n            return res.redirect(\"/?error=invite_expired\");\n          }\n          \n          // CRITICAL SECURITY CHECK: Verify authenticated email matches invite email\n          const authenticatedEmail = user.claims?.email?.toLowerCase();\n          const inviteEmail = invite.email.toLowerCase();\n          \n          if (!authenticatedEmail || authenticatedEmail !== inviteEmail) {\n            console.error(\"Email mismatch - Authenticated:\", authenticatedEmail, \"Invite:\", inviteEmail);\n            // Expire the invite to prevent reuse\n            await storage.expireUserInvite(invite.id);\n            delete req.session.inviteToken;\n            return res.redirect(\"/?error=invite_email_mismatch\");\n          }\n          \n          // Create/update user with correct role from invite\n          const dbUser = await storage.upsertUser({\n            id: userId,\n            email: user.claims.email,\n            firstName: invite.firstName || user.claims.first_name,\n            lastName: invite.lastName || user.claims.last_name,\n            profileImageUrl: user.claims.profile_image_url,\n            role: invite.role, // Set role from invite\n          });\n          \n          // If invite is for resident, create resident record\n          if (invite.role === 'resident' && invite.unitNumber) {\n            try {\n              await storage.createResident({\n                userId: userId,\n                unitNumber: invite.unitNumber,\n                streetName: null,\n                phoneNumber: null,\n                accountStatus: \"active\",\n                totalBalance: \"0\",\n              });\n            } catch (error: any) {\n              // Ignore duplicate errors - resident may already exist\n              if (!error.message?.includes('duplicate') && !error.message?.includes('unique')) {\n                console.error(\"Error creating resident:\", error);\n              }\n            }\n          }\n          \n          // Accept the invite\n          await storage.acceptUserInvite(inviteToken, userId);\n          \n          // Clean up session\n          delete req.session.inviteToken;\n          \n          // Redirect based on role\n          let redirectPath = \"/\";\n          if (invite.role === 'admin' || invite.role === 'accountant') {\n            redirectPath = \"/admin\";\n          } else if (invite.role === 'security') {\n            redirectPath = \"/security\";\n          }\n          \n          return res.redirect(redirectPath);\n        } catch (error) {\n          console.error(\"Error processing invite:\", error);\n          delete req.session.inviteToken;\n          return res.redirect(\"/?error=invite_processing_failed\");\n        }\n      }\n      \n      // No invite token - create/update user with default resident role\n      // This handles normal login without invites\n      await storage.upsertUser({\n        id: userId,\n        email: user.claims.email,\n        firstName: user.claims.first_name,\n        lastName: user.claims.last_name,\n        profileImageUrl: user.claims.profile_image_url,\n        // Note: role will default to \"resident\" if not explicitly set\n      });\n      \n      // Get the intended role from session\n      const intendedRole = req.session.intendedRole;\n      delete req.session.intendedRole; // Clean up after use\n      \n      // Determine redirect path based on intended role\n      let redirectPath = \"/\";\n      \n      if (intendedRole === 'admin') {\n        redirectPath = \"/admin\";\n      } else if (intendedRole === 'resident') {\n        redirectPath = \"/\";\n      }\n      \n      res.redirect(redirectPath);\n    });\n  });\n\n  app.get(\"/api/logout\", (req, res) => {\n    req.logout(() => {\n      res.redirect(\n        client.buildEndSessionUrl(config, {\n          client_id: process.env.REPL_ID!,\n          post_logout_redirect_uri: `${req.protocol}://${req.hostname}`,\n        }).href\n      );\n    });\n  });\n}\n\n/**\n * Ensures user exists in database by creating/updating from OIDC claims.\n * Recovers role from accepted invites or resident profiles for orphaned sessions.\n */\nasync function ensureUserRecord(userId: string, claims: any): Promise<void> {\n  try {\n    // Check if user already exists\n    const existingUser = await storage.getUser(userId);\n    if (existingUser) {\n      return; // User record exists, nothing to do\n    }\n\n    // User missing from database - attempt role recovery\n    console.log(`[ensureUserRecord] User ${userId} missing from database, attempting recovery...`);\n\n    let recoveredRole: 'resident' | 'admin' | 'security' | 'accountant' | undefined;\n\n    // Strategy 1: Check if they have an accepted invite\n    const acceptedInvite = await storage.getAcceptedInviteByUserId(userId);\n    if (acceptedInvite) {\n      recoveredRole = acceptedInvite.role as 'resident' | 'admin' | 'security' | 'accountant';\n      console.log(`[ensureUserRecord] Recovered role \"${recoveredRole}\" from accepted invite`);\n    }\n\n    // Strategy 2: Check if they have a resident profile\n    if (!recoveredRole) {\n      const resident = await storage.getResidentByUserId(userId);\n      if (resident) {\n        recoveredRole = 'resident';\n        console.log(`[ensureUserRecord] Recovered role \"resident\" from resident profile`);\n      }\n    }\n\n    // Create user with recovered or default role\n    await storage.upsertUser({\n      id: userId,\n      email: claims.email,\n      firstName: claims.first_name,\n      lastName: claims.last_name,\n      profileImageUrl: claims.profile_image_url,\n      role: recoveredRole, // Will default to \"resident\" if undefined\n    });\n\n    console.log(`[ensureUserRecord] Created user ${userId} with role \"${recoveredRole || 'resident'}\"`);\n  } catch (error) {\n    console.error('[ensureUserRecord] Error ensuring user record:', error);\n    throw error;\n  }\n}\n\nexport const isAuthenticated: RequestHandler = async (req, res, next) => {\n  const user = req.user as any;\n\n  if (!req.isAuthenticated() || !user.expires_at) {\n    return res.status(401).json({ message: \"Unauthorized\" });\n  }\n\n  const now = Math.floor(Date.now() / 1000);\n  if (now <= user.expires_at) {\n    // Ensure user record exists in database before continuing\n    try {\n      const userId = user.claims?.sub;\n      if (userId) {\n        await ensureUserRecord(userId, user.claims);\n      }\n    } catch (error) {\n      console.error(\"Error ensuring user record:\", error);\n      return res.status(500).json({ message: \"Internal server error\" });\n    }\n    return next();\n  }\n\n  const refreshToken = user.refresh_token;\n  if (!refreshToken) {\n    res.status(401).json({ message: \"Unauthorized\" });\n    return;\n  }\n\n  try {\n    const config = await getOidcConfig();\n    const tokenResponse = await client.refreshTokenGrant(config, refreshToken);\n    updateUserSession(user, tokenResponse);\n    \n    // Ensure user record exists after token refresh\n    const userId = user.claims?.sub;\n    if (userId) {\n      await ensureUserRecord(userId, user.claims);\n    }\n    \n    return next();\n  } catch (error) {\n    res.status(401).json({ message: \"Unauthorized\" });\n    return;\n  }\n};\n\n// Role-based authorization middleware\nexport const requireRole = (allowedRoles: string[]): RequestHandler => {\n  return async (req: any, res, next) => {\n    try {\n      if (!req.isAuthenticated()) {\n        return res.status(401).json({ message: \"Unauthorized - Please log in\" });\n      }\n\n      const userId = req.user?.claims?.sub;\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized - Invalid user\" });\n      }\n\n      // Ensure user record exists in database (auto-recovers orphaned sessions)\n      await ensureUserRecord(userId, req.user.claims);\n\n      // Get user from database to check role\n      const user = await storage.getUser(userId);\n      if (!user) {\n        return res.status(401).json({ message: \"Unauthorized - User not found\" });\n      }\n\n      // Check if user's role is in the allowed roles list\n      if (!user.role || !allowedRoles.includes(user.role)) {\n        return res.status(403).json({ \n          message: `Access denied - This feature requires ${allowedRoles.join(' or ')} role` \n        });\n      }\n\n      // Attach user to request for convenience\n      req.dbUser = user;\n      next();\n    } catch (error) {\n      console.error(\"Error in requireRole middleware:\", error);\n      return res.status(500).json({ message: \"Internal server error\" });\n    }\n  };\n};\n\n// Convenience middleware for common role combinations\nexport const requireAdmin = requireRole(['admin']);\nexport const requireAdminOrAccountant = requireRole(['admin', 'accountant']);\nexport const requireSecurity = requireRole(['security']);\nexport const requireResident = requireRole(['resident']);\n","size_bytes":13764},"client/src/components/ui/card.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Card = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"shadcn-card rounded-xl border bg-card border-card-border text-card-foreground shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n));\nCard.displayName = \"Card\"\n\nconst CardHeader = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex flex-col space-y-1.5 p-6\", className)}\n    {...props}\n  />\n));\nCardHeader.displayName = \"CardHeader\"\n\nconst CardTitle = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"text-2xl font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nCardTitle.displayName = \"CardTitle\"\n\nconst CardDescription = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n));\nCardDescription.displayName = \"CardDescription\"\n\nconst CardContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"p-6 pt-0\", className)} {...props} />\n))\nCardContent.displayName = \"CardContent\"\n\nconst CardFooter = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex items-center p-6 pt-0\", className)}\n    {...props}\n  />\n))\nCardFooter.displayName = \"CardFooter\"\nexport {\n  Card,\n  CardHeader,\n  CardFooter,\n  CardTitle,\n  CardDescription,\n  CardContent,\n}\n","size_bytes":1904},"client/src/components/ui/menubar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as MenubarPrimitive from \"@radix-ui/react-menubar\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nfunction MenubarMenu({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Menu>) {\n  return <MenubarPrimitive.Menu {...props} />\n}\n\nfunction MenubarGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Group>) {\n  return <MenubarPrimitive.Group {...props} />\n}\n\nfunction MenubarPortal({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Portal>) {\n  return <MenubarPrimitive.Portal {...props} />\n}\n\nfunction MenubarRadioGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.RadioGroup>) {\n  return <MenubarPrimitive.RadioGroup {...props} />\n}\n\nfunction MenubarSub({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Sub>) {\n  return <MenubarPrimitive.Sub data-slot=\"menubar-sub\" {...props} />\n}\n\nconst Menubar = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"flex h-10 items-center space-x-1 rounded-md border bg-background p-1\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubar.displayName = MenubarPrimitive.Root.displayName\n\nconst MenubarTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-3 py-1.5 text-sm font-medium outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarTrigger.displayName = MenubarPrimitive.Trigger.displayName\n\nconst MenubarSubTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <MenubarPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </MenubarPrimitive.SubTrigger>\n))\nMenubarSubTrigger.displayName = MenubarPrimitive.SubTrigger.displayName\n\nconst MenubarSubContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarSubContent.displayName = MenubarPrimitive.SubContent.displayName\n\nconst MenubarContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Content>\n>(\n  (\n    { className, align = \"start\", alignOffset = -4, sideOffset = 8, ...props },\n    ref\n  ) => (\n    <MenubarPrimitive.Portal>\n      <MenubarPrimitive.Content\n        ref={ref}\n        align={align}\n        alignOffset={alignOffset}\n        sideOffset={sideOffset}\n        className={cn(\n          \"z-50 min-w-[12rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n          className\n        )}\n        {...props}\n      />\n    </MenubarPrimitive.Portal>\n  )\n)\nMenubarContent.displayName = MenubarPrimitive.Content.displayName\n\nconst MenubarItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarItem.displayName = MenubarPrimitive.Item.displayName\n\nconst MenubarCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <MenubarPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.CheckboxItem>\n))\nMenubarCheckboxItem.displayName = MenubarPrimitive.CheckboxItem.displayName\n\nconst MenubarRadioItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <MenubarPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.RadioItem>\n))\nMenubarRadioItem.displayName = MenubarPrimitive.RadioItem.displayName\n\nconst MenubarLabel = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarLabel.displayName = MenubarPrimitive.Label.displayName\n\nconst MenubarSeparator = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nMenubarSeparator.displayName = MenubarPrimitive.Separator.displayName\n\nconst MenubarShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nMenubarShortcut.displayname = \"MenubarShortcut\"\n\nexport {\n  Menubar,\n  MenubarMenu,\n  MenubarTrigger,\n  MenubarContent,\n  MenubarItem,\n  MenubarSeparator,\n  MenubarLabel,\n  MenubarCheckboxItem,\n  MenubarRadioGroup,\n  MenubarRadioItem,\n  MenubarPortal,\n  MenubarSubContent,\n  MenubarSubTrigger,\n  MenubarGroup,\n  MenubarSub,\n  MenubarShortcut,\n}\n","size_bytes":8605},"client/src/main.tsx":{"content":"import { createRoot } from \"react-dom/client\";\nimport App from \"./App\";\nimport \"./index.css\";\n\ncreateRoot(document.getElementById(\"root\")!).render(<App />);\n","size_bytes":157},"vite.config.ts":{"content":"import { defineConfig } from \"vite\";\nimport react from \"@vitejs/plugin-react\";\nimport path from \"path\";\nimport runtimeErrorOverlay from \"@replit/vite-plugin-runtime-error-modal\";\n\nexport default defineConfig({\n  plugins: [\n    react(),\n    runtimeErrorOverlay(),\n    ...(process.env.NODE_ENV !== \"production\" &&\n    process.env.REPL_ID !== undefined\n      ? [\n          await import(\"@replit/vite-plugin-cartographer\").then((m) =>\n            m.cartographer(),\n          ),\n          await import(\"@replit/vite-plugin-dev-banner\").then((m) =>\n            m.devBanner(),\n          ),\n        ]\n      : []),\n  ],\n  resolve: {\n    alias: {\n      \"@\": path.resolve(import.meta.dirname, \"client\", \"src\"),\n      \"@shared\": path.resolve(import.meta.dirname, \"shared\"),\n      \"@assets\": path.resolve(import.meta.dirname, \"attached_assets\"),\n    },\n  },\n  root: path.resolve(import.meta.dirname, \"client\"),\n  build: {\n    outDir: path.resolve(import.meta.dirname, \"dist/public\"),\n    emptyOutDir: true,\n  },\n  server: {\n    fs: {\n      strict: true,\n      deny: [\"**/.*\"],\n    },\n  },\n});\n","size_bytes":1080},"shared/schema.ts":{"content":"import { sql } from 'drizzle-orm';\nimport { relations } from 'drizzle-orm';\nimport {\n  index,\n  unique,\n  jsonb,\n  pgTable,\n  timestamp,\n  varchar,\n  text,\n  integer,\n  decimal,\n  boolean,\n} from \"drizzle-orm/pg-core\";\nimport { createInsertSchema } from \"drizzle-zod\";\nimport { z } from \"zod\";\n\n// Session storage table (required for Replit Auth)\nexport const sessions = pgTable(\n  \"sessions\",\n  {\n    sid: varchar(\"sid\").primaryKey(),\n    sess: jsonb(\"sess\").notNull(),\n    expire: timestamp(\"expire\").notNull(),\n  },\n  (table) => [index(\"IDX_session_expire\").on(table.expire)],\n);\n\n// Users table (required for Replit Auth)\nexport const users = pgTable(\"users\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  email: varchar(\"email\").unique(),\n  firstName: varchar(\"first_name\"),\n  lastName: varchar(\"last_name\"),\n  profileImageUrl: varchar(\"profile_image_url\"),\n  role: varchar(\"role\", { enum: [\"resident\", \"admin\", \"security\", \"accountant\"] }).notNull().default(\"resident\"),\n  isActive: boolean(\"is_active\").notNull().default(true),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport type UpsertUser = typeof users.$inferInsert;\nexport type User = typeof users.$inferSelect;\n\n// Residents table - extended profile information for residents\nexport const residents = pgTable(\"residents\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  unitNumber: varchar(\"unit_number\").notNull().unique(),\n  streetName: varchar(\"street_name\"),\n  phoneNumber: varchar(\"phone_number\"),\n  accountStatus: varchar(\"account_status\", { enum: [\"active\", \"inactive\", \"delinquent\"] }).notNull().default(\"active\"),\n  totalBalance: decimal(\"total_balance\", { precision: 10, scale: 2 }).notNull().default(\"0\"),\n  \n  // Comprehensive resident information\n  moveInDate: timestamp(\"move_in_date\"),\n  occupancyType: varchar(\"occupancy_type\", { enum: [\"owner\", \"tenant\"] }).default(\"owner\"),\n  numberOfOccupants: integer(\"number_of_occupants\"),\n  propertySize: varchar(\"property_size\"),\n  bedrooms: integer(\"bedrooms\"),\n  parkingSpaces: integer(\"parking_spaces\").default(0),\n  \n  // Emergency contact information\n  emergencyContactName: varchar(\"emergency_contact_name\"),\n  emergencyContactPhone: varchar(\"emergency_contact_phone\"),\n  emergencyContactRelationship: varchar(\"emergency_contact_relationship\"),\n  \n  // Vehicle information (stored as JSONB array)\n  vehicles: text(\"vehicles\").array(),\n  \n  // Additional information\n  specialNotes: text(\"special_notes\"),\n  \n  // Service charge and subscription period\n  serviceCharge: decimal(\"service_charge\", { precision: 10, scale: 2 }),\n  startDate: timestamp(\"start_date\"),\n  endDate: timestamp(\"end_date\"),\n  \n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const residentsRelations = relations(residents, ({ one, many }) => ({\n  user: one(users, {\n    fields: [residents.userId],\n    references: [users.id],\n  }),\n  bills: many(bills),\n  visitors: many(visitors),\n}));\n\nexport const insertResidentSchema = createInsertSchema(residents).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertResident = z.infer<typeof insertResidentSchema>;\nexport type Resident = typeof residents.$inferSelect;\n\n// Bills table - levy bills issued to residents (Accounts Receivable entries)\nexport const bills = pgTable(\"bills\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  residentId: varchar(\"resident_id\").notNull().references(() => residents.id, { onDelete: \"cascade\" }),\n  billingType: varchar(\"billing_type\").notNull().default(\"Estate Maintenance\"),\n  description: text(\"description\").notNull(),\n  amount: decimal(\"amount\", { precision: 10, scale: 2 }).notNull(),\n  dueDate: timestamp(\"due_date\").notNull(),\n  status: varchar(\"status\", { enum: [\"pending\", \"paid\", \"overdue\", \"partial\"] }).notNull().default(\"pending\"),\n  periodStart: timestamp(\"period_start\").notNull(),\n  periodEnd: timestamp(\"period_end\").notNull(),\n  journalEntryId: varchar(\"journal_entry_id\"),\n  \n  // AR tracking fields\n  invoiceNumber: varchar(\"invoice_number\").unique(),\n  totalPaid: decimal(\"total_paid\", { precision: 10, scale: 2 }).notNull().default(\"0\"),\n  balance: decimal(\"balance\", { precision: 10, scale: 2 }).notNull().default(\"0\"),\n  paymentStatus: varchar(\"payment_status\", { enum: [\"unpaid\", \"partial_payment\", \"full_payment\"] }).notNull().default(\"unpaid\"),\n  \n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const billsRelations = relations(bills, ({ one, many }) => ({\n  resident: one(residents, {\n    fields: [bills.residentId],\n    references: [residents.id],\n  }),\n  payments: many(payments),\n  paymentApplications: many(paymentApplications),\n}));\n\nexport const insertBillSchema = createInsertSchema(bills).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertBill = z.infer<typeof insertBillSchema>;\nexport type Bill = typeof bills.$inferSelect;\n\n// Payments table - payment records for bills\nexport const payments = pgTable(\"payments\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  billId: varchar(\"bill_id\").notNull().references(() => bills.id, { onDelete: \"cascade\" }),\n  residentId: varchar(\"resident_id\").notNull().references(() => residents.id, { onDelete: \"cascade\" }),\n  amount: decimal(\"amount\", { precision: 10, scale: 2 }).notNull(),\n  paymentMethod: varchar(\"payment_method\").notNull().default(\"cash\"),\n  transactionId: varchar(\"transaction_id\"),\n  status: varchar(\"status\", { enum: [\"pending\", \"completed\", \"failed\"] }).notNull().default(\"completed\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const paymentsRelations = relations(payments, ({ one }) => ({\n  bill: one(bills, {\n    fields: [payments.billId],\n    references: [bills.id],\n  }),\n  resident: one(residents, {\n    fields: [payments.residentId],\n    references: [residents.id],\n  }),\n}));\n\nexport const insertPaymentSchema = createInsertSchema(payments).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertPayment = z.infer<typeof insertPaymentSchema>;\nexport type Payment = typeof payments.$inferSelect;\n\n// Visitors table - pre-approved visitors with QR codes\nexport const visitors = pgTable(\"visitors\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  residentId: varchar(\"resident_id\").notNull().references(() => residents.id, { onDelete: \"cascade\" }),\n  visitorName: varchar(\"visitor_name\").notNull(),\n  visitorPhone: varchar(\"visitor_phone\"),\n  purpose: text(\"purpose\"),\n  accessCode: varchar(\"access_code\").notNull().unique(),\n  validFrom: timestamp(\"valid_from\").notNull(),\n  validUntil: timestamp(\"valid_until\").notNull(),\n  status: varchar(\"status\", { enum: [\"pending\", \"approved\", \"used\", \"expired\", \"denied\"] }).notNull().default(\"approved\"),\n  usedAt: timestamp(\"used_at\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const visitorsRelations = relations(visitors, ({ one }) => ({\n  resident: one(residents, {\n    fields: [visitors.residentId],\n    references: [residents.id],\n  }),\n}));\n\nexport const insertVisitorSchema = createInsertSchema(visitors).omit({\n  id: true,\n  createdAt: true,\n  usedAt: true,\n});\n\nexport type InsertVisitor = z.infer<typeof insertVisitorSchema>;\nexport type Visitor = typeof visitors.$inferSelect;\n\n// Notifications table - system notifications for users\nexport const notifications = pgTable(\"notifications\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  title: varchar(\"title\").notNull(),\n  message: text(\"message\").notNull(),\n  type: varchar(\"type\", { enum: [\"bill\", \"payment\", \"announcement\", \"visitor\", \"system\"] }).notNull(),\n  isRead: boolean(\"is_read\").notNull().default(false),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const notificationsRelations = relations(notifications, ({ one }) => ({\n  user: one(users, {\n    fields: [notifications.userId],\n    references: [users.id],\n  }),\n}));\n\nexport const insertNotificationSchema = createInsertSchema(notifications).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertNotification = z.infer<typeof insertNotificationSchema>;\nexport type Notification = typeof notifications.$inferSelect;\n\n// Access Logs table - security access logs for gate entries\nexport const accessLogs = pgTable(\"access_logs\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  visitorId: varchar(\"visitor_id\").references(() => visitors.id, { onDelete: \"set null\" }),\n  residentId: varchar(\"resident_id\").references(() => residents.id, { onDelete: \"set null\" }),\n  securityPersonnelId: varchar(\"security_personnel_id\").references(() => users.id, { onDelete: \"set null\" }),\n  accessType: varchar(\"access_type\", { enum: [\"visitor\", \"resident\", \"manual\"] }).notNull(),\n  name: varchar(\"name\").notNull(),\n  action: varchar(\"action\", { enum: [\"entry\", \"exit\", \"denied\"] }).notNull(),\n  notes: text(\"notes\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const accessLogsRelations = relations(accessLogs, ({ one }) => ({\n  visitor: one(visitors, {\n    fields: [accessLogs.visitorId],\n    references: [visitors.id],\n  }),\n  resident: one(residents, {\n    fields: [accessLogs.residentId],\n    references: [residents.id],\n  }),\n  securityPersonnel: one(users, {\n    fields: [accessLogs.securityPersonnelId],\n    references: [users.id],\n  }),\n}));\n\nexport const insertAccessLogSchema = createInsertSchema(accessLogs).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertAccessLog = z.infer<typeof insertAccessLogSchema>;\nexport type AccessLog = typeof accessLogs.$inferSelect;\n\n// Announcements table - estate-wide announcements from admin\nexport const announcements = pgTable(\"announcements\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  adminId: varchar(\"admin_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  title: varchar(\"title\").notNull(),\n  content: text(\"content\").notNull(),\n  priority: varchar(\"priority\", { enum: [\"low\", \"medium\", \"high\", \"urgent\"] }).notNull().default(\"medium\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const announcementsRelations = relations(announcements, ({ one }) => ({\n  admin: one(users, {\n    fields: [announcements.adminId],\n    references: [users.id],\n  }),\n}));\n\nexport const insertAnnouncementSchema = createInsertSchema(announcements).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertAnnouncement = z.infer<typeof insertAnnouncementSchema>;\nexport type Announcement = typeof announcements.$inferSelect;\n\n// ====== ACCOUNTING SYSTEM TABLES ======\n\n// Chart of Accounts - defines all accounts in the accounting system\nexport const accounts = pgTable(\"accounts\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  accountNumber: varchar(\"account_number\").notNull().unique(),\n  accountName: varchar(\"account_name\").notNull(),\n  accountType: varchar(\"account_type\", { \n    enum: [\"asset\", \"liability\", \"equity\", \"revenue\", \"expense\"] \n  }).notNull(),\n  category: varchar(\"category\"), // e.g., \"Cash and Bank\", \"Receivables\", \"Utilities\", etc.\n  description: text(\"description\"),\n  normalBalance: varchar(\"normal_balance\", { enum: [\"debit\", \"credit\"] }).notNull(),\n  isActive: boolean(\"is_active\").notNull().default(true),\n  isSystemAccount: boolean(\"is_system_account\").notNull().default(false), // Cannot be deleted\n  balance: decimal(\"balance\", { precision: 15, scale: 2 }).notNull().default(\"0\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertAccountSchema = createInsertSchema(accounts).omit({\n  id: true,\n  balance: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertAccount = z.infer<typeof insertAccountSchema>;\nexport type Account = typeof accounts.$inferSelect;\n\n// Transaction Templates - define standard debit-credit pairs for common transactions\nexport const transactionTemplates = pgTable(\"transaction_templates\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: varchar(\"name\").notNull().unique(),\n  description: text(\"description\"),\n  transactionType: varchar(\"transaction_type\").notNull(), // e.g., \"service_charge\", \"payment_received\", \"expense\", etc.\n  debitAccountId: varchar(\"debit_account_id\").notNull().references(() => accounts.id, { onDelete: \"restrict\" }),\n  creditAccountId: varchar(\"credit_account_id\").notNull().references(() => accounts.id, { onDelete: \"restrict\" }),\n  isActive: boolean(\"is_active\").notNull().default(true),\n  isSystemTemplate: boolean(\"is_system_template\").notNull().default(false), // Cannot be deleted\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const transactionTemplatesRelations = relations(transactionTemplates, ({ one }) => ({\n  debitAccount: one(accounts, {\n    fields: [transactionTemplates.debitAccountId],\n    references: [accounts.id],\n    relationName: \"debitAccount\",\n  }),\n  creditAccount: one(accounts, {\n    fields: [transactionTemplates.creditAccountId],\n    references: [accounts.id],\n    relationName: \"creditAccount\",\n  }),\n}));\n\nexport const insertTransactionTemplateSchema = createInsertSchema(transactionTemplates).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertTransactionTemplate = z.infer<typeof insertTransactionTemplateSchema>;\nexport type TransactionTemplate = typeof transactionTemplates.$inferSelect;\n\n// Journal Entries - main accounting transactions\nexport const journalEntries = pgTable(\"journal_entries\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  entryNumber: varchar(\"entry_number\").notNull().unique(), // Auto-generated: JE-YYYYMMDD-XXXX\n  entryDate: timestamp(\"entry_date\").notNull(),\n  description: text(\"description\").notNull(),\n  referenceType: varchar(\"reference_type\"), // e.g., \"bill\", \"payment\", \"manual\"\n  referenceId: varchar(\"reference_id\"), // ID of the bill, payment, etc.\n  templateId: varchar(\"template_id\").references(() => transactionTemplates.id, { onDelete: \"set null\" }),\n  createdBy: varchar(\"created_by\").notNull().references(() => users.id, { onDelete: \"restrict\" }),\n  status: varchar(\"status\", { enum: [\"draft\", \"posted\", \"void\"] }).notNull().default(\"posted\"),\n  totalDebit: decimal(\"total_debit\", { precision: 15, scale: 2 }).notNull(),\n  totalCredit: decimal(\"total_credit\", { precision: 15, scale: 2 }).notNull(),\n  notes: text(\"notes\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const journalEntriesRelations = relations(journalEntries, ({ one, many }) => ({\n  template: one(transactionTemplates, {\n    fields: [journalEntries.templateId],\n    references: [transactionTemplates.id],\n  }),\n  creator: one(users, {\n    fields: [journalEntries.createdBy],\n    references: [users.id],\n  }),\n  lines: many(journalEntryLines),\n}));\n\nexport const insertJournalEntrySchema = createInsertSchema(journalEntries).omit({\n  id: true,\n  entryNumber: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertJournalEntry = z.infer<typeof insertJournalEntrySchema>;\nexport type JournalEntry = typeof journalEntries.$inferSelect;\n\n// Journal Entry Lines - individual debit/credit lines for each journal entry\nexport const journalEntryLines = pgTable(\"journal_entry_lines\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  journalEntryId: varchar(\"journal_entry_id\").notNull().references(() => journalEntries.id, { onDelete: \"cascade\" }),\n  accountId: varchar(\"account_id\").notNull().references(() => accounts.id, { onDelete: \"restrict\" }),\n  lineType: varchar(\"line_type\", { enum: [\"debit\", \"credit\"] }).notNull(),\n  amount: decimal(\"amount\", { precision: 15, scale: 2 }).notNull(),\n  description: text(\"description\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const journalEntryLinesRelations = relations(journalEntryLines, ({ one }) => ({\n  journalEntry: one(journalEntries, {\n    fields: [journalEntryLines.journalEntryId],\n    references: [journalEntries.id],\n  }),\n  account: one(accounts, {\n    fields: [journalEntryLines.accountId],\n    references: [accounts.id],\n  }),\n}));\n\nexport const insertJournalEntryLineSchema = createInsertSchema(journalEntryLines).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertJournalEntryLine = z.infer<typeof insertJournalEntryLineSchema>;\nexport type JournalEntryLine = typeof journalEntryLines.$inferSelect;\n\n// Vendors table - for vendor management and tracking\nexport const vendors = pgTable(\"vendors\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: varchar(\"name\").notNull(),\n  tinNumber: varchar(\"tin_number\").notNull().unique(), // Tax Identification Number\n  email: varchar(\"email\"),\n  phoneNumber: varchar(\"phone_number\"),\n  address: text(\"address\"),\n  contactPerson: varchar(\"contact_person\"),\n  bankName: varchar(\"bank_name\"),\n  bankAccountNumber: varchar(\"bank_account_number\"),\n  bankAccountName: varchar(\"bank_account_name\"),\n  status: varchar(\"status\", { enum: [\"pending\", \"approved\", \"rejected\"] }).notNull().default(\"pending\"),\n  approvedBy: varchar(\"approved_by\").references(() => users.id, { onDelete: \"set null\" }),\n  approvedAt: timestamp(\"approved_at\"),\n  rejectionReason: text(\"rejection_reason\"),\n  notes: text(\"notes\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const vendorsRelations = relations(vendors, ({ one }) => ({\n  approver: one(users, {\n    fields: [vendors.approvedBy],\n    references: [users.id],\n  }),\n}));\n\nexport const insertVendorSchema = createInsertSchema(vendors).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n}).extend({\n  tinNumber: z.string().min(1, \"TIN number is required\"),\n  name: z.string().min(1, \"Vendor name is required\"),\n});\n\nexport type InsertVendor = z.infer<typeof insertVendorSchema>;\nexport type Vendor = typeof vendors.$inferSelect;\n\n// Expenses table\nexport const expenses = pgTable(\"expenses\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  vendorId: varchar(\"vendor_id\").references(() => vendors.id),\n  accountId: varchar(\"account_id\").references(() => accounts.id),\n  expenseType: varchar(\"expense_type\", { enum: [\"Retail Expense\", \"Service Payment\"] }).notNull(),\n  expenseClassification: varchar(\"expense_classification\", { \n    enum: [\n      \"Security & Guards\",\n      \"Cleaning & Janitorial\",\n      \"Waste Management\",\n      \"Diesel / Generator\",\n      \"Electrical Repairs\",\n      \"Plumbing Repairs\",\n      \"Landscaping\",\n      \"General Maintenance\",\n      \"Office/Admin Expenses\"\n    ] \n  }),\n  description: text(\"description\").notNull(),\n  expenseAmount: decimal(\"expense_amount\", { precision: 10, scale: 2 }).notNull(),\n  serviceCharge: decimal(\"service_charge\", { precision: 10, scale: 2 }),\n  receiptPath: text(\"receipt_path\"),\n  status: varchar(\"status\", { enum: [\"pending\", \"approved\", \"rejected\"] }).notNull().default(\"pending\"),\n  submittedBy: varchar(\"submitted_by\").notNull().references(() => users.id),\n  reviewedBy: varchar(\"reviewed_by\").references(() => users.id),\n  reviewedAt: timestamp(\"reviewed_at\"),\n  rejectionReason: text(\"rejection_reason\"),\n  \n  // Payment tracking fields\n  paymentStatus: varchar(\"payment_status\", { enum: [\"unpaid\", \"approved_for_payment\", \"paid\"] }).notNull().default(\"unpaid\"),\n  paidDate: timestamp(\"paid_date\"),\n  paidFromAccountId: varchar(\"paid_from_account_id\").references(() => accounts.id),\n  paidBy: varchar(\"paid_by\").references(() => users.id),\n  whtRate: decimal(\"wht_rate\", { precision: 5, scale: 2 }).default(\"5.00\"), // Default 5%\n  whtAmount: decimal(\"wht_amount\", { precision: 10, scale: 2 }).default(\"0\"),\n  netPayment: decimal(\"net_payment\", { precision: 10, scale: 2 }),\n  paymentJournalEntryId: varchar(\"payment_journal_entry_id\"),\n  \n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const expensesRelations = relations(expenses, ({ one }) => ({\n  vendor: one(vendors, {\n    fields: [expenses.vendorId],\n    references: [vendors.id],\n  }),\n  account: one(accounts, {\n    fields: [expenses.accountId],\n    references: [accounts.id],\n  }),\n  submitter: one(users, {\n    fields: [expenses.submittedBy],\n    references: [users.id],\n  }),\n  reviewer: one(users, {\n    fields: [expenses.reviewedBy],\n    references: [users.id],\n  }),\n  paidFromAccount: one(accounts, {\n    fields: [expenses.paidFromAccountId],\n    references: [accounts.id],\n    relationName: \"paymentAccount\",\n  }),\n  payer: one(users, {\n    fields: [expenses.paidBy],\n    references: [users.id],\n    relationName: \"payer\",\n  }),\n}));\n\nexport const insertExpenseSchema = createInsertSchema(expenses).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n  reviewedAt: true,\n  reviewedBy: true,\n  rejectionReason: true,\n}).extend({\n  expenseType: z.enum([\"Retail Expense\", \"Service Payment\"]),\n  description: z.string().min(1, \"Description is required\"),\n  expenseAmount: z.string().min(1, \"Expense amount is required\"),\n  serviceCharge: z.string().optional(),\n});\n\nexport type InsertExpense = z.infer<typeof insertExpenseSchema>;\nexport type Expense = typeof expenses.$inferSelect;\n\n// WHT Transactions table - tracks Withholding Tax deductions and remittances\nexport const whtTransactions = pgTable(\"wht_transactions\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  expenseId: varchar(\"expense_id\").notNull().references(() => expenses.id, { onDelete: \"restrict\" }),\n  vendorId: varchar(\"vendor_id\").notNull().references(() => vendors.id, { onDelete: \"restrict\" }),\n  whtAmount: decimal(\"wht_amount\", { precision: 10, scale: 2 }).notNull(),\n  whtRate: decimal(\"wht_rate\", { precision: 5, scale: 2 }).notNull(),\n  taxableAmount: decimal(\"taxable_amount\", { precision: 10, scale: 2 }).notNull(), // Usually service charge amount\n  \n  // Deduction tracking\n  deductionDate: timestamp(\"deduction_date\").notNull(),\n  deductionJournalEntryId: varchar(\"deduction_journal_entry_id\").references(() => journalEntries.id),\n  deductedBy: varchar(\"deducted_by\").notNull().references(() => users.id, { onDelete: \"restrict\" }),\n  \n  // Remittance tracking\n  remittanceStatus: varchar(\"remittance_status\", { \n    enum: [\"pending\", \"remitted\", \"void\"] \n  }).notNull().default(\"pending\"),\n  remittanceDate: timestamp(\"remittance_date\"),\n  remittanceJournalEntryId: varchar(\"remittance_journal_entry_id\").references(() => journalEntries.id),\n  remittedBy: varchar(\"remitted_by\").references(() => users.id, { onDelete: \"restrict\" }),\n  remittanceReferenceNumber: varchar(\"remittance_reference_number\"), // Tax authority reference\n  \n  notes: text(\"notes\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const whtTransactionsRelations = relations(whtTransactions, ({ one }) => ({\n  expense: one(expenses, {\n    fields: [whtTransactions.expenseId],\n    references: [expenses.id],\n  }),\n  vendor: one(vendors, {\n    fields: [whtTransactions.vendorId],\n    references: [vendors.id],\n  }),\n  deductionJournalEntry: one(journalEntries, {\n    fields: [whtTransactions.deductionJournalEntryId],\n    references: [journalEntries.id],\n    relationName: \"deductionJournal\",\n  }),\n  remittanceJournalEntry: one(journalEntries, {\n    fields: [whtTransactions.remittanceJournalEntryId],\n    references: [journalEntries.id],\n    relationName: \"remittanceJournal\",\n  }),\n  deductor: one(users, {\n    fields: [whtTransactions.deductedBy],\n    references: [users.id],\n    relationName: \"deductor\",\n  }),\n  remitter: one(users, {\n    fields: [whtTransactions.remittedBy],\n    references: [users.id],\n    relationName: \"remitter\",\n  }),\n}));\n\nexport const insertWhtTransactionSchema = createInsertSchema(whtTransactions).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertWhtTransaction = z.infer<typeof insertWhtTransactionSchema>;\nexport type WhtTransaction = typeof whtTransactions.$inferSelect;\n\n// Invoice Sequences table - for generating sequential invoice numbers safely\nexport const invoiceSequences = pgTable(\"invoice_sequences\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  seriesKey: varchar(\"series_key\").notNull(), // e.g., \"invoice\"\n  fiscalYear: integer(\"fiscal_year\").notNull(),\n  lastNumber: integer(\"last_number\").notNull().default(0),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (table) => ({\n  uniqSeriesYear: unique().on(table.seriesKey, table.fiscalYear),\n}));\n\nexport const insertInvoiceSequenceSchema = createInsertSchema(invoiceSequences).omit({\n  id: true,\n  updatedAt: true,\n});\n\nexport type InsertInvoiceSequence = z.infer<typeof insertInvoiceSequenceSchema>;\nexport type InvoiceSequence = typeof invoiceSequences.$inferSelect;\n\n// Budgets table - for budget planning and tracking\nexport const budgets = pgTable(\"budgets\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: varchar(\"name\").notNull(),\n  description: text(\"description\"),\n  fiscalYear: integer(\"fiscal_year\").notNull(), // e.g., 2025\n  periodType: varchar(\"period_type\", { enum: [\"annual\", \"quarterly\", \"monthly\"] }).notNull(),\n  startDate: timestamp(\"start_date\").notNull(),\n  endDate: timestamp(\"end_date\").notNull(),\n  status: varchar(\"status\", { enum: [\"draft\", \"active\", \"closed\"] }).notNull().default(\"draft\"),\n  totalBudgetAmount: decimal(\"total_budget_amount\", { precision: 15, scale: 2 }).notNull().default(\"0\"),\n  totalConsumedAmount: decimal(\"total_consumed_amount\", { precision: 15, scale: 2 }).notNull().default(\"0\"),\n  totalRemainingAmount: decimal(\"total_remaining_amount\", { precision: 15, scale: 2 }).notNull().default(\"0\"),\n  projectedCollections: decimal(\"projected_collections\", { precision: 15, scale: 2 }), // Collections projection\n  actualCollections: decimal(\"actual_collections\", { precision: 15, scale: 2 }).default(\"0\"),\n  createdBy: varchar(\"created_by\").notNull().references(() => users.id, { onDelete: \"restrict\" }),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const budgetsRelations = relations(budgets, ({ one, many }) => ({\n  creator: one(users, {\n    fields: [budgets.createdBy],\n    references: [users.id],\n  }),\n  budgetLines: many(budgetLines),\n}));\n\nexport const insertBudgetSchema = createInsertSchema(budgets).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n  totalConsumedAmount: true,\n  totalRemainingAmount: true,\n  actualCollections: true,\n});\n\nexport type InsertBudget = z.infer<typeof insertBudgetSchema>;\nexport type Budget = typeof budgets.$inferSelect;\n\n// Budget Lines table - individual account allocations within a budget\nexport const budgetLines = pgTable(\"budget_lines\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  budgetId: varchar(\"budget_id\").notNull().references(() => budgets.id, { onDelete: \"cascade\" }),\n  accountId: varchar(\"account_id\").notNull().references(() => accounts.id, { onDelete: \"restrict\" }),\n  allocatedAmount: decimal(\"allocated_amount\", { precision: 15, scale: 2 }).notNull(),\n  consumedAmount: decimal(\"consumed_amount\", { precision: 15, scale: 2 }).notNull().default(\"0\"),\n  remainingAmount: decimal(\"remaining_amount\", { precision: 15, scale: 2 }).notNull().default(\"0\"),\n  notes: text(\"notes\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const budgetLinesRelations = relations(budgetLines, ({ one }) => ({\n  budget: one(budgets, {\n    fields: [budgetLines.budgetId],\n    references: [budgets.id],\n  }),\n  account: one(accounts, {\n    fields: [budgetLines.accountId],\n    references: [accounts.id],\n  }),\n}));\n\nexport const insertBudgetLineSchema = createInsertSchema(budgetLines).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n  consumedAmount: true,\n  remainingAmount: true,\n});\n\nexport type InsertBudgetLine = z.infer<typeof insertBudgetLineSchema>;\nexport type BudgetLine = typeof budgetLines.$inferSelect;\n\n// Bank Statements table - uploaded bank statements for AR reconciliation\nexport const bankStatements = pgTable(\"bank_statements\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  fileName: varchar(\"file_name\").notNull(),\n  fileData: text(\"file_data\").notNull(), // Base64 encoded file\n  bankName: varchar(\"bank_name\").notNull(),\n  accountNumber: varchar(\"account_number\").notNull(),\n  statementDate: timestamp(\"statement_date\").notNull(),\n  uploadedBy: varchar(\"uploaded_by\").notNull().references(() => users.id, { onDelete: \"restrict\" }),\n  uploadedAt: timestamp(\"uploaded_at\").defaultNow(),\n  totalEntries: integer(\"total_entries\").notNull().default(0),\n  totalAmount: decimal(\"total_amount\", { precision: 15, scale: 2 }).notNull().default(\"0\"),\n  reconciledEntries: integer(\"reconciled_entries\").notNull().default(0),\n  reconciledAmount: decimal(\"reconciled_amount\", { precision: 15, scale: 2 }).notNull().default(\"0\"),\n  status: varchar(\"status\", { enum: [\"pending\", \"processing\", \"completed\", \"error\"] }).notNull().default(\"pending\"),\n});\n\nexport const bankStatementsRelations = relations(bankStatements, ({ one, many }) => ({\n  uploader: one(users, {\n    fields: [bankStatements.uploadedBy],\n    references: [users.id],\n  }),\n  entries: many(bankStatementEntries),\n}));\n\nexport const insertBankStatementSchema = createInsertSchema(bankStatements).omit({\n  id: true,\n  uploadedAt: true,\n  totalEntries: true,\n  totalAmount: true,\n  reconciledEntries: true,\n  reconciledAmount: true,\n});\n\nexport type InsertBankStatement = z.infer<typeof insertBankStatementSchema>;\nexport type BankStatement = typeof bankStatements.$inferSelect;\n\n// Bank Statement Entries table - individual transactions from bank statements\nexport const bankStatementEntries = pgTable(\"bank_statement_entries\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  statementId: varchar(\"statement_id\").notNull().references(() => bankStatements.id, { onDelete: \"cascade\" }),\n  transactionDate: timestamp(\"transaction_date\").notNull(),\n  description: text(\"description\").notNull(),\n  referenceNumber: varchar(\"reference_number\"), // Invoice number or other reference\n  amount: decimal(\"amount\", { precision: 15, scale: 2 }).notNull(),\n  appliedAmount: decimal(\"applied_amount\", { precision: 15, scale: 2 }).notNull().default(\"0\"),\n  remainingAmount: decimal(\"remaining_amount\", { precision: 15, scale: 2 }).notNull().default(\"0\"),\n  status: varchar(\"status\", { enum: [\"unmatched\", \"matched\", \"partially_matched\", \"reconciled\"] }).notNull().default(\"unmatched\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const bankStatementEntriesRelations = relations(bankStatementEntries, ({ one, many }) => ({\n  statement: one(bankStatements, {\n    fields: [bankStatementEntries.statementId],\n    references: [bankStatements.id],\n  }),\n  applications: many(paymentApplications),\n}));\n\nexport const insertBankStatementEntrySchema = createInsertSchema(bankStatementEntries).omit({\n  id: true,\n  createdAt: true,\n  appliedAmount: true,\n  remainingAmount: true,\n});\n\nexport type InsertBankStatementEntry = z.infer<typeof insertBankStatementEntrySchema>;\nexport type BankStatementEntry = typeof bankStatementEntries.$inferSelect;\n\n// Payment Applications table - tracks how bank statement entries are applied to bills\nexport const paymentApplications = pgTable(\"payment_applications\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  billId: varchar(\"bill_id\").notNull().references(() => bills.id, { onDelete: \"cascade\" }),\n  bankStatementEntryId: varchar(\"bank_statement_entry_id\").references(() => bankStatementEntries.id, { onDelete: \"set null\" }),\n  amountApplied: decimal(\"amount_applied\", { precision: 15, scale: 2 }).notNull(),\n  applicationType: varchar(\"application_type\", { enum: [\"bank_statement\", \"manual\"] }).notNull(),\n  bankName: varchar(\"bank_name\"),\n  accountNumber: varchar(\"account_number\"),\n  paymentDate: timestamp(\"payment_date\").notNull(),\n  appliedBy: varchar(\"applied_by\").notNull().references(() => users.id, { onDelete: \"restrict\" }),\n  appliedAt: timestamp(\"applied_at\").defaultNow(),\n  journalEntryId: varchar(\"journal_entry_id\"),\n  notes: text(\"notes\"),\n});\n\nexport const paymentApplicationsRelations = relations(paymentApplications, ({ one }) => ({\n  bill: one(bills, {\n    fields: [paymentApplications.billId],\n    references: [bills.id],\n  }),\n  bankStatementEntry: one(bankStatementEntries, {\n    fields: [paymentApplications.bankStatementEntryId],\n    references: [bankStatementEntries.id],\n  }),\n  applier: one(users, {\n    fields: [paymentApplications.appliedBy],\n    references: [users.id],\n  }),\n}));\n\nexport const insertPaymentApplicationSchema = createInsertSchema(paymentApplications).omit({\n  id: true,\n  appliedAt: true,\n});\n\nexport type InsertPaymentApplication = z.infer<typeof insertPaymentApplicationSchema>;\nexport type PaymentApplication = typeof paymentApplications.$inferSelect;\n\n// Subscriptions table - tracks estate subscription plan and status\nexport const subscriptions = pgTable(\"subscriptions\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  estateName: varchar(\"estate_name\").notNull(),\n  plan: varchar(\"plan\", { enum: [\"starter\", \"professional\", \"enterprise\"] }).notNull().default(\"starter\"),\n  status: varchar(\"status\", { enum: [\"active\", \"inactive\", \"trial\", \"cancelled\"] }).notNull().default(\"trial\"),\n  billingCycle: varchar(\"billing_cycle\", { enum: [\"monthly\", \"annual\"] }).notNull().default(\"monthly\"),\n  currentPeriodStart: timestamp(\"current_period_start\").notNull(),\n  currentPeriodEnd: timestamp(\"current_period_end\").notNull(),\n  trialEndsAt: timestamp(\"trial_ends_at\"),\n  cancelledAt: timestamp(\"cancelled_at\"),\n  maxResidents: integer(\"max_residents\").notNull().default(50),\n  maxAdmins: integer(\"max_admins\").notNull().default(1),\n  maxSecurity: integer(\"max_security\").notNull().default(1),\n  maxAccountants: integer(\"max_accountants\").notNull().default(0),\n  stripeCustomerId: varchar(\"stripe_customer_id\"),\n  stripeSubscriptionId: varchar(\"stripe_subscription_id\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertSubscriptionSchema = createInsertSchema(subscriptions).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertSubscription = z.infer<typeof insertSubscriptionSchema>;\nexport type Subscription = typeof subscriptions.$inferSelect;\n\n// User Invites table - tracks invite links for user onboarding\nexport const userInvites = pgTable(\"user_invites\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  inviteToken: varchar(\"invite_token\").notNull().unique(),\n  email: varchar(\"email\").notNull(),\n  role: varchar(\"role\", { enum: [\"resident\", \"admin\", \"security\", \"accountant\"] }).notNull(),\n  firstName: varchar(\"first_name\"),\n  lastName: varchar(\"last_name\"),\n  unitNumber: varchar(\"unit_number\"), // For residents only\n  createdBy: varchar(\"created_by\").notNull().references(() => users.id, { onDelete: \"restrict\" }),\n  status: varchar(\"status\", { enum: [\"pending\", \"accepted\", \"expired\"] }).notNull().default(\"pending\"),\n  expiresAt: timestamp(\"expires_at\").notNull(),\n  acceptedAt: timestamp(\"accepted_at\"),\n  acceptedByUserId: varchar(\"accepted_by_user_id\").references(() => users.id, { onDelete: \"set null\" }),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => ({\n  uniquePendingInvite: unique().on(table.email, table.status),\n}));\n\nexport const userInvitesRelations = relations(userInvites, ({ one }) => ({\n  creator: one(users, {\n    fields: [userInvites.createdBy],\n    references: [users.id],\n  }),\n}));\n\nexport const insertUserInviteSchema = createInsertSchema(userInvites).omit({\n  id: true,\n  createdAt: true,\n  acceptedAt: true,\n});\n\nexport type InsertUserInvite = z.infer<typeof insertUserInviteSchema>;\nexport type UserInvite = typeof userInvites.$inferSelect;\n","size_bytes":36361},"client/src/pages/admin/reports.tsx":{"content":"import { useEffect } from \"react\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Printer, Download } from \"lucide-react\";\nimport { useLocation } from \"wouter\";\n\ninterface DashboardStats {\n  totalResidents: number;\n  activeResidents: number;\n  delinquentResidents: number;\n  totalRevenue: number;\n  collectionsThisMonth: number;\n  pendingPayments: number;\n  overdueBills: number;\n  collectionRate: number;\n  activeVisitors: number;\n  totalExpenses: number;\n  paidExpenses: number;\n  approvedExpenses: number;\n  pendingExpenses: number;\n  accountsPayable: number;\n}\n\nconst formatNaira = (amount: number) => {\n  return new Intl.NumberFormat('en-NG', {\n    style: 'currency',\n    currency: 'NGN',\n    minimumFractionDigits: 2,\n  }).format(amount);\n};\n\nexport default function AdminReports() {\n  const { toast } = useToast();\n  const { isAuthenticated, isLoading, user } = useAuth();\n  const [location] = useLocation();\n  \n  // Get report type from URL query params\n  const urlParams = new URLSearchParams(window.location.search);\n  const reportType = urlParams.get('type');\n\n  const { data: stats, isLoading: statsLoading } = useQuery<DashboardStats>({\n    queryKey: ['/api/admin/stats'],\n    enabled: isAuthenticated && user?.role === \"admin\",\n  });\n\n  useEffect(() => {\n    if (!isLoading && (!isAuthenticated || user?.role !== \"admin\")) {\n      toast({\n        title: \"Unauthorized\",\n        description: \"Admin access required\",\n        variant: \"destructive\",\n      });\n      setTimeout(() => {\n        window.location.href = \"/\";\n      }, 500);\n      return;\n    }\n  }, [isAuthenticated, isLoading, user, toast]);\n\n  if (isLoading || !isAuthenticated || user?.role !== \"admin\") {\n    return (\n      <div className=\"flex h-screen items-center justify-center\">\n        <div className=\"animate-spin w-8 h-8 border-4 border-primary border-t-transparent rounded-full\" />\n      </div>\n    );\n  }\n\n  const handlePrint = () => {\n    window.print();\n  };\n\n  const renderReport = () => {\n    if (!stats) {\n      return (\n        <div className=\"text-center py-12\">\n          <p>Loading report data...</p>\n        </div>\n      );\n    }\n\n    const totalCollections = stats.totalRevenue || 0;\n    const totalExpenses = stats.totalExpenses || 0;\n    const paidExpenses = stats.paidExpenses || 0;\n    const accountsReceivable = stats.pendingPayments || 0;\n    const arOverdue = stats.overdueBills || 0;\n    const accountsPayable = stats.accountsPayable || 0;\n    const apPending = stats.pendingExpenses || 0;\n    const apApproved = stats.approvedExpenses || 0;\n    const currentBalance = accountsReceivable - arOverdue;\n\n    switch (reportType) {\n      case 'collections':\n        return (\n          <div className=\"space-y-6\">\n            <div className=\"border-b pb-4\">\n              <h1 className=\"text-3xl font-bold\">Collections Report</h1>\n              <p className=\"text-muted-foreground mt-2\">Total Payments Received</p>\n              <p className=\"text-sm text-muted-foreground\">\n                Generated: {new Date().toLocaleDateString('en-NG', { \n                  year: 'numeric', \n                  month: 'long', \n                  day: 'numeric' \n                })}\n              </p>\n            </div>\n\n            <div className=\"grid gap-6\">\n              <Card>\n                <CardHeader>\n                  <CardTitle className=\"text-green-600\">Total Collections</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"text-4xl font-bold text-green-600\">\n                    {formatNaira(totalCollections)}\n                  </div>\n                </CardContent>\n              </Card>\n\n              <Card>\n                <CardHeader>\n                  <CardTitle>Breakdown</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"space-y-3\">\n                    <div className=\"flex justify-between items-center border-b pb-2\">\n                      <span className=\"text-muted-foreground\">Total Residents</span>\n                      <span className=\"font-semibold\">{stats.totalResidents}</span>\n                    </div>\n                    <div className=\"flex justify-between items-center border-b pb-2\">\n                      <span className=\"text-muted-foreground\">Active Residents</span>\n                      <span className=\"font-semibold\">{stats.activeResidents}</span>\n                    </div>\n                    <div className=\"flex justify-between items-center border-b pb-2\">\n                      <span className=\"text-muted-foreground\">Outstanding Balance</span>\n                      <span className=\"font-semibold\">{formatNaira(accountsReceivable)}</span>\n                    </div>\n                    <div className=\"flex justify-between items-center border-b pb-2\">\n                      <span className=\"text-muted-foreground\">Collection Rate</span>\n                      <span className=\"font-semibold\">{stats.collectionRate}%</span>\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n            </div>\n          </div>\n        );\n\n      case 'expenses':\n        return (\n          <div className=\"space-y-6\">\n            <div className=\"border-b pb-4\">\n              <h1 className=\"text-3xl font-bold\">Total Expenses Report</h1>\n              <p className=\"text-muted-foreground mt-2\">Approved Estate Expenses</p>\n              <p className=\"text-sm text-muted-foreground\">\n                Generated: {new Date().toLocaleDateString('en-NG', { \n                  year: 'numeric', \n                  month: 'long', \n                  day: 'numeric' \n                })}\n              </p>\n            </div>\n\n            <div className=\"grid gap-6\">\n              <Card>\n                <CardHeader>\n                  <CardTitle className=\"text-red-600\">Total Expenses</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"text-4xl font-bold text-red-600\">\n                    {formatNaira(totalExpenses)}\n                  </div>\n                </CardContent>\n              </Card>\n\n              <Card>\n                <CardHeader>\n                  <CardTitle>Expense Details</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"space-y-3\">\n                    <div className=\"flex justify-between items-center border-b pb-2\">\n                      <span className=\"text-muted-foreground\">Approved Expenses</span>\n                      <span className=\"font-semibold\">{formatNaira(totalExpenses)}</span>\n                    </div>\n                    <div className=\"flex justify-between items-center border-b pb-2\">\n                      <span className=\"text-muted-foreground\">Paid Expenses</span>\n                      <span className=\"font-semibold\">{formatNaira(paidExpenses)}</span>\n                    </div>\n                    <div className=\"flex justify-between items-center border-b pb-2\">\n                      <span className=\"text-muted-foreground\">Remaining to Pay</span>\n                      <span className=\"font-semibold\">{formatNaira(totalExpenses - paidExpenses)}</span>\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n            </div>\n          </div>\n        );\n\n      case 'ar':\n        return (\n          <div className=\"space-y-6\">\n            <div className=\"border-b pb-4\">\n              <h1 className=\"text-3xl font-bold\">Accounts Receivable Report</h1>\n              <p className=\"text-muted-foreground mt-2\">Outstanding Resident Bills</p>\n              <p className=\"text-sm text-muted-foreground\">\n                Generated: {new Date().toLocaleDateString('en-NG', { \n                  year: 'numeric', \n                  month: 'long', \n                  day: 'numeric' \n                })}\n              </p>\n            </div>\n\n            <div className=\"grid gap-6\">\n              <Card>\n                <CardHeader>\n                  <CardTitle className=\"text-blue-600\">Total Accounts Receivable</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"text-4xl font-bold text-blue-600\">\n                    {formatNaira(accountsReceivable)}\n                  </div>\n                </CardContent>\n              </Card>\n\n              <Card>\n                <CardHeader>\n                  <CardTitle>AR Aging</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"space-y-3\">\n                    <div className=\"flex justify-between items-center border-b pb-2\">\n                      <span className=\"text-muted-foreground\">Current Balance</span>\n                      <span className=\"font-semibold\">{formatNaira(currentBalance)}</span>\n                    </div>\n                    <div className=\"flex justify-between items-center border-b pb-2\">\n                      <span className=\"text-muted-foreground\">Overdue Amount</span>\n                      <span className=\"font-semibold text-red-600\">{formatNaira(arOverdue)}</span>\n                    </div>\n                    <div className=\"flex justify-between items-center border-b pb-2\">\n                      <span className=\"text-muted-foreground\">Total Outstanding</span>\n                      <span className=\"font-semibold\">{formatNaira(accountsReceivable)}</span>\n                    </div>\n                    <div className=\"flex justify-between items-center border-b pb-2\">\n                      <span className=\"text-muted-foreground\">Delinquent Residents</span>\n                      <span className=\"font-semibold\">{stats.delinquentResidents}</span>\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n            </div>\n          </div>\n        );\n\n      case 'ap':\n        return (\n          <div className=\"space-y-6\">\n            <div className=\"border-b pb-4\">\n              <h1 className=\"text-3xl font-bold\">Accounts Payable Report</h1>\n              <p className=\"text-muted-foreground mt-2\">Outstanding Vendor Payments</p>\n              <p className=\"text-sm text-muted-foreground\">\n                Generated: {new Date().toLocaleDateString('en-NG', { \n                  year: 'numeric', \n                  month: 'long', \n                  day: 'numeric' \n                })}\n              </p>\n            </div>\n\n            <div className=\"grid gap-6\">\n              <Card>\n                <CardHeader>\n                  <CardTitle className=\"text-orange-600\">Total Accounts Payable</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"text-4xl font-bold text-orange-600\">\n                    {formatNaira(accountsPayable)}\n                  </div>\n                </CardContent>\n              </Card>\n\n              <Card>\n                <CardHeader>\n                  <CardTitle>Payables Breakdown</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"space-y-3\">\n                    <div className=\"flex justify-between items-center border-b pb-2\">\n                      <span className=\"text-muted-foreground\">Pending Approval</span>\n                      <span className=\"font-semibold\">{formatNaira(apPending)}</span>\n                    </div>\n                    <div className=\"flex justify-between items-center border-b pb-2\">\n                      <span className=\"text-muted-foreground\">Approved (Unpaid)</span>\n                      <span className=\"font-semibold\">{formatNaira(apApproved)}</span>\n                    </div>\n                    <div className=\"flex justify-between items-center border-b pb-2\">\n                      <span className=\"text-muted-foreground\">Total Payable</span>\n                      <span className=\"font-semibold\">{formatNaira(accountsPayable)}</span>\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n            </div>\n          </div>\n        );\n\n      default:\n        return (\n          <div className=\"text-center py-12\">\n            <p className=\"text-lg text-muted-foreground\">Please select a report type from the dashboard.</p>\n          </div>\n        );\n    }\n  };\n\n  return (\n    <div className=\"space-y-6 p-6\">\n      <div className=\"flex items-center justify-between print:hidden\">\n        <div>\n          <h1 className=\"text-3xl font-semibold\">Financial Reports</h1>\n          <p className=\"text-muted-foreground mt-1\">View and print detailed reports</p>\n        </div>\n        {reportType && (\n          <Button onClick={handlePrint} data-testid=\"button-print-report\">\n            <Printer className=\"h-4 w-4 mr-2\" />\n            Print / Save as PDF\n          </Button>\n        )}\n      </div>\n\n      <div className=\"print:p-8\">\n        {statsLoading ? (\n          <div className=\"text-center py-12\">\n            <div className=\"animate-spin w-8 h-8 border-4 border-primary border-t-transparent rounded-full mx-auto\" />\n          </div>\n        ) : (\n          renderReport()\n        )}\n      </div>\n\n      <style>{`\n        @media print {\n          body * {\n            visibility: hidden;\n          }\n          .print\\\\:p-8, .print\\\\:p-8 * {\n            visibility: visible;\n          }\n          .print\\\\:p-8 {\n            position: absolute;\n            left: 0;\n            top: 0;\n            width: 100%;\n          }\n          .print\\\\:hidden {\n            display: none !important;\n          }\n        }\n      `}</style>\n    </div>\n  );\n}\n","size_bytes":13840},"client/src/hooks/use-toast.ts":{"content":"import * as React from \"react\"\n\nimport type {\n  ToastActionElement,\n  ToastProps,\n} from \"@/components/ui/toast\"\n\nconst TOAST_LIMIT = 1\nconst TOAST_REMOVE_DELAY = 1000000\n\ntype ToasterToast = ToastProps & {\n  id: string\n  title?: React.ReactNode\n  description?: React.ReactNode\n  action?: ToastActionElement\n}\n\nconst actionTypes = {\n  ADD_TOAST: \"ADD_TOAST\",\n  UPDATE_TOAST: \"UPDATE_TOAST\",\n  DISMISS_TOAST: \"DISMISS_TOAST\",\n  REMOVE_TOAST: \"REMOVE_TOAST\",\n} as const\n\nlet count = 0\n\nfunction genId() {\n  count = (count + 1) % Number.MAX_SAFE_INTEGER\n  return count.toString()\n}\n\ntype ActionType = typeof actionTypes\n\ntype Action =\n  | {\n      type: ActionType[\"ADD_TOAST\"]\n      toast: ToasterToast\n    }\n  | {\n      type: ActionType[\"UPDATE_TOAST\"]\n      toast: Partial<ToasterToast>\n    }\n  | {\n      type: ActionType[\"DISMISS_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n  | {\n      type: ActionType[\"REMOVE_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n\ninterface State {\n  toasts: ToasterToast[]\n}\n\nconst toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()\n\nconst addToRemoveQueue = (toastId: string) => {\n  if (toastTimeouts.has(toastId)) {\n    return\n  }\n\n  const timeout = setTimeout(() => {\n    toastTimeouts.delete(toastId)\n    dispatch({\n      type: \"REMOVE_TOAST\",\n      toastId: toastId,\n    })\n  }, TOAST_REMOVE_DELAY)\n\n  toastTimeouts.set(toastId, timeout)\n}\n\nexport const reducer = (state: State, action: Action): State => {\n  switch (action.type) {\n    case \"ADD_TOAST\":\n      return {\n        ...state,\n        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),\n      }\n\n    case \"UPDATE_TOAST\":\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === action.toast.id ? { ...t, ...action.toast } : t\n        ),\n      }\n\n    case \"DISMISS_TOAST\": {\n      const { toastId } = action\n\n      // ! Side effects ! - This could be extracted into a dismissToast() action,\n      // but I'll keep it here for simplicity\n      if (toastId) {\n        addToRemoveQueue(toastId)\n      } else {\n        state.toasts.forEach((toast) => {\n          addToRemoveQueue(toast.id)\n        })\n      }\n\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === toastId || toastId === undefined\n            ? {\n                ...t,\n                open: false,\n              }\n            : t\n        ),\n      }\n    }\n    case \"REMOVE_TOAST\":\n      if (action.toastId === undefined) {\n        return {\n          ...state,\n          toasts: [],\n        }\n      }\n      return {\n        ...state,\n        toasts: state.toasts.filter((t) => t.id !== action.toastId),\n      }\n  }\n}\n\nconst listeners: Array<(state: State) => void> = []\n\nlet memoryState: State = { toasts: [] }\n\nfunction dispatch(action: Action) {\n  memoryState = reducer(memoryState, action)\n  listeners.forEach((listener) => {\n    listener(memoryState)\n  })\n}\n\ntype Toast = Omit<ToasterToast, \"id\">\n\nfunction toast({ ...props }: Toast) {\n  const id = genId()\n\n  const update = (props: ToasterToast) =>\n    dispatch({\n      type: \"UPDATE_TOAST\",\n      toast: { ...props, id },\n    })\n  const dismiss = () => dispatch({ type: \"DISMISS_TOAST\", toastId: id })\n\n  dispatch({\n    type: \"ADD_TOAST\",\n    toast: {\n      ...props,\n      id,\n      open: true,\n      onOpenChange: (open) => {\n        if (!open) dismiss()\n      },\n    },\n  })\n\n  return {\n    id: id,\n    dismiss,\n    update,\n  }\n}\n\nfunction useToast() {\n  const [state, setState] = React.useState<State>(memoryState)\n\n  React.useEffect(() => {\n    listeners.push(setState)\n    return () => {\n      const index = listeners.indexOf(setState)\n      if (index > -1) {\n        listeners.splice(index, 1)\n      }\n    }\n  }, [state])\n\n  return {\n    ...state,\n    toast,\n    dismiss: (toastId?: string) => dispatch({ type: \"DISMISS_TOAST\", toastId }),\n  }\n}\n\nexport { useToast, toast }\n","size_bytes":3895},"server/routes.ts":{"content":"import type { Express } from \"express\";\nimport { createServer, type Server } from \"http\";\nimport { storage } from \"./storage\";\nimport { setupAuth, isAuthenticated, requireAdmin, requireAdminOrAccountant, requireSecurity, requireResident } from \"./replitAuth\";\nimport { randomBytes } from \"crypto\";\nimport { z } from \"zod\";\nimport { format } from \"date-fns\";\nimport { \n  insertAccountSchema, \n  insertTransactionTemplateSchema, \n  insertJournalEntrySchema,\n  insertJournalEntryLineSchema,\n  insertVendorSchema,\n  insertExpenseSchema,\n  bankStatementEntries,\n  bills,\n  bankStatements,\n  paymentApplications,\n  accounts,\n  journalEntries,\n  journalEntryLines,\n  type InsertJournalEntryLine\n} from \"@shared/schema\";\nimport { fromZodError } from \"zod-validation-error\";\nimport { db } from \"./db\";\nimport { eq, and, sql } from \"drizzle-orm\";\n\n// Payment validation schemas\nconst payNowSchema = z.object({\n  paidFromAccountId: z.string().min(1, \"Bank account is required\"),\n  whtRate: z.string().refine(\n    (val) => !isNaN(parseFloat(val)) && parseFloat(val) >= 0 && parseFloat(val) <= 100,\n    \"WHT rate must be a number between 0 and 100\"\n  )\n});\n\nconst payLaterSchema = z.object({\n  whtRate: z.string().refine(\n    (val) => !isNaN(parseFloat(val)) && parseFloat(val) >= 0 && parseFloat(val) <= 100,\n    \"WHT rate must be a number between 0 and 100\"\n  )\n});\n\n// Helper to generate unique access codes\nfunction generateAccessCode(): string {\n  return randomBytes(4).toString(\"hex\").toUpperCase();\n}\n\n// Helper to check delinquency and update status\nasync function checkAndUpdateDelinquency(residentId: string) {\n  const bills = await storage.getBillsByResidentId(residentId);\n  const now = new Date();\n  \n  // Check for overdue bills (unpaid bills past due date)\n  const overdueBills = bills.filter(\n    b => b.status !== \"paid\" && new Date(b.dueDate) < now\n  );\n\n  // Calculate total balance (all unpaid bills)\n  const totalBalance = bills\n    .filter(b => b.status !== \"paid\")\n    .reduce((sum, b) => sum + parseFloat(b.amount), 0);\n\n  // Update status based on overdue bills only\n  // Residents are delinquent if they have ANY overdue bills\n  // Residents are active if they have NO overdue bills (future pending bills are OK)\n  if (overdueBills.length > 0) {\n    await storage.updateResidentStatus(residentId, \"delinquent\");\n  } else {\n    await storage.updateResidentStatus(residentId, \"active\");\n  }\n\n  await storage.updateResidentBalance(residentId, totalBalance.toString());\n}\n\nexport async function registerRoutes(app: Express): Promise<Server> {\n  // Setup authentication\n  await setupAuth(app);\n\n  // ========== AUTH ROUTES ==========\n  app.get('/api/auth/user', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      res.json(user);\n    } catch (error) {\n      console.error(\"Error fetching user:\", error);\n      res.status(500).json({ message: \"Failed to fetch user\" });\n    }\n  });\n\n  // Complete signup - Creates resident profile for new users\n  app.post('/api/signup/complete', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n\n      if (!user) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n\n      // SECURITY: Prevent role downgrade for admin/security users\n      if (user.role && user.role !== \"resident\") {\n        return res.status(403).json({ \n          message: \"Admin and Security accounts cannot use self-signup\" \n        });\n      }\n\n      // Check if user already has a resident profile\n      const existingResident = await storage.getResidentByUserId(userId);\n      if (existingResident) {\n        return res.status(400).json({ \n          message: \"You have already completed signup\" \n        });\n      }\n\n      // Security: Only allow resident role during self-signup\n      // Admin and Security accounts must be created by an admin\n      const { unitNumber, phoneNumber, serviceCharge } = req.body;\n\n      if (!unitNumber || !unitNumber.trim()) {\n        return res.status(400).json({ \n          message: \"Unit number is required\" \n        });\n      }\n\n      // Update user role to resident (security measure - lock the role)\n      await storage.upsertUser({\n        id: userId,\n        email: user.email,\n        firstName: user.firstName,\n        lastName: user.lastName,\n        profileImageUrl: user.profileImageUrl,\n        role: \"resident\", // Force resident role for self-signup\n      });\n\n      // Process service charge - convert to decimal string or null\n      const validatedServiceCharge = serviceCharge && parseFloat(serviceCharge) > 0 \n        ? parseFloat(serviceCharge).toFixed(2) \n        : null;\n\n      // Automatically set start date to today for self-signup residents\n      // Convert to Date object for storage (Drizzle handles timestamp conversion)\n      const startDate = new Date();\n\n      // Create resident profile with billing fields\n      const resident = await storage.createResident({\n        userId,\n        unitNumber: unitNumber.trim(),\n        phoneNumber: phoneNumber?.trim() || null,\n        accountStatus: \"active\",\n        totalBalance: \"0\",\n        serviceCharge: validatedServiceCharge,\n        startDate: startDate,\n      });\n\n      // Create welcome notification\n      await storage.createNotification({\n        userId,\n        title: \"Welcome to Estate Management\",\n        message: `Your resident account has been created successfully for Unit ${unitNumber}`,\n        type: \"system\",\n        isRead: false,\n      });\n\n      // Automatically generate first service charge bill if resident is eligible\n      try {\n        const bill = await storage.generateBillForResident(resident.id, userId);\n        if (bill) {\n          console.log(`Auto-generated first service charge bill for resident ${resident.unitNumber}`);\n          \n          // Send invoice email\n          try {\n            await storage.sendInvoiceEmailsForBills([bill]);\n          } catch (emailError: any) {\n            console.error(`Failed to send invoice email for resident ${resident.unitNumber}:`, emailError.message);\n            // Don't fail the signup process if email sending fails\n          }\n        }\n      } catch (error) {\n        console.error(`Failed to auto-generate bill for resident ${resident.unitNumber}:`, error);\n        // Don't fail the signup process if billing fails\n      }\n\n      res.json({ success: true, resident });\n    } catch (error: any) {\n      console.error(\"Error completing signup:\", error);\n      \n      // Handle specific database constraint errors\n      if (error.code === '23505') {\n        if (error.constraint === 'residents_unit_number_unique') {\n          return res.status(400).json({ \n            message: `Unit number \"${req.body.unitNumber}\" is already assigned to another resident. Please use a different unit number.` \n          });\n        }\n        if (error.constraint === 'residents_user_id_unique') {\n          return res.status(400).json({ \n            message: \"You have already completed signup\" \n          });\n        }\n      }\n      \n      res.status(500).json({ message: \"Failed to complete signup\" });\n    }\n  });\n\n  // ========== RESIDENT ROUTES ==========\n  \n  // Get resident profile\n  app.get('/api/resident/profile', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const resident = await storage.getResidentByUserId(userId);\n      \n      if (!resident) {\n        return res.status(404).json({ message: \"Resident profile not found\" });\n      }\n\n      // Update delinquency status\n      await checkAndUpdateDelinquency(resident.id);\n\n      // Fetch updated resident\n      const updatedResident = await storage.getResident(resident.id);\n      res.json(updatedResident);\n    } catch (error) {\n      console.error(\"Error fetching resident profile:\", error);\n      res.status(500).json({ message: \"Failed to fetch profile\" });\n    }\n  });\n\n  // Get resident bills\n  app.get('/api/resident/bills', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const resident = await storage.getResidentByUserId(userId);\n      \n      if (!resident) {\n        return res.status(404).json({ message: \"Resident not found\" });\n      }\n\n      const bills = await storage.getBillsByResidentId(resident.id);\n      res.json(bills);\n    } catch (error) {\n      console.error(\"Error fetching bills:\", error);\n      res.status(500).json({ message: \"Failed to fetch bills\" });\n    }\n  });\n\n  // Get recent bills\n  app.get('/api/resident/bills/recent', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const resident = await storage.getResidentByUserId(userId);\n      \n      if (!resident) {\n        return res.status(404).json({ message: \"Resident not found\" });\n      }\n\n      const bills = await storage.getRecentBillsByResidentId(resident.id, 5);\n      res.json(bills);\n    } catch (error) {\n      console.error(\"Error fetching recent bills:\", error);\n      res.status(500).json({ message: \"Failed to fetch bills\" });\n    }\n  });\n\n  // Generate and download invoice PDF\n  app.get('/api/resident/bills/:billId/pdf', isAuthenticated, async (req: any, res) => {\n    try {\n      const { billId } = req.params;\n      const userId = req.user.claims.sub;\n      \n      // Get resident profile\n      const resident = await storage.getResidentByUserId(userId);\n      if (!resident) {\n        return res.status(404).json({ message: \"Resident not found\" });\n      }\n\n      // Get bill and verify ownership\n      const bill = await storage.getBill(billId);\n      if (!bill) {\n        return res.status(404).json({ message: \"Bill not found\" });\n      }\n\n      if (bill.residentId !== resident.id) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n\n      // Get user information for the invoice\n      const user = await storage.getUser(userId);\n      if (!user) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n\n      // Calculate totals\n      const payments = await storage.getPaymentsByBillId(billId);\n      const totalPaid = payments\n        .filter(p => p.status === \"completed\")\n        .reduce((sum, p) => sum + parseFloat(p.amount), 0);\n      const balance = parseFloat(bill.amount) - totalPaid;\n\n      // Import the PDF generator\n      const { generateInvoicePDF } = await import('./pdf-invoice');\n\n      // Generate PDF\n      const pdfBuffer = await generateInvoicePDF({\n        invoiceNumber: bill.invoiceNumber || `INV-${bill.id.slice(0, 8)}`,\n        invoiceDate: bill.createdAt || new Date(),\n        dueDate: bill.dueDate,\n        residentName: `${user.firstName || ''} ${user.lastName || ''}`.trim() || 'Resident',\n        unitNumber: resident.unitNumber,\n        userId: user.id.slice(0, 8),\n        billingPeriod: `${new Date(bill.periodStart).toLocaleDateString()} - ${new Date(bill.periodEnd).toLocaleDateString()}`,\n        description: bill.description,\n        amount: bill.amount,\n        balance: balance.toFixed(2),\n        totalPaid: totalPaid.toFixed(2)\n      });\n\n      // Set response headers\n      res.setHeader('Content-Type', 'application/pdf');\n      res.setHeader('Content-Disposition', `attachment; filename=\"Invoice-${bill.invoiceNumber || bill.id}.pdf\"`);\n      res.setHeader('Content-Length', pdfBuffer.length);\n\n      // Send PDF\n      res.send(pdfBuffer);\n    } catch (error: any) {\n      console.error(\"Error generating invoice PDF:\", error);\n      res.status(500).json({ message: \"Failed to generate invoice PDF\" });\n    }\n  });\n\n  // Get resident payments\n  app.get('/api/resident/payments', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const resident = await storage.getResidentByUserId(userId);\n      \n      if (!resident) {\n        return res.status(404).json({ message: \"Resident not found\" });\n      }\n\n      const payments = await storage.getPaymentsByResidentId(resident.id);\n      res.json(payments);\n    } catch (error) {\n      console.error(\"Error fetching payments:\", error);\n      res.status(500).json({ message: \"Failed to fetch payments\" });\n    }\n  });\n\n  // Get resident visitors\n  app.get('/api/resident/visitors', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const resident = await storage.getResidentByUserId(userId);\n      \n      if (!resident) {\n        return res.status(404).json({ message: \"Resident not found\" });\n      }\n\n      const visitors = await storage.getVisitorsByResidentId(resident.id);\n      res.json(visitors);\n    } catch (error) {\n      console.error(\"Error fetching visitors:\", error);\n      res.status(500).json({ message: \"Failed to fetch visitors\" });\n    }\n  });\n\n  // Get active visitors\n  app.get('/api/resident/visitors/active', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const resident = await storage.getResidentByUserId(userId);\n      \n      if (!resident) {\n        return res.status(404).json({ message: \"Resident not found\" });\n      }\n\n      const visitors = await storage.getActiveVisitorsByResidentId(resident.id);\n      res.json(visitors);\n    } catch (error) {\n      console.error(\"Error fetching active visitors:\", error);\n      res.status(500).json({ message: \"Failed to fetch visitors\" });\n    }\n  });\n\n  // Create visitor\n  app.post('/api/resident/visitors', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const resident = await storage.getResidentByUserId(userId);\n      \n      if (!resident) {\n        return res.status(404).json({ message: \"Resident not found\" });\n      }\n\n      // Check if account is delinquent\n      if (resident.accountStatus === \"delinquent\") {\n        return res.status(403).json({ \n          message: \"Cannot pre-approve visitors. Please settle your outstanding balance first.\" \n        });\n      }\n\n      const { visitorName, visitorPhone, purpose, validFrom, validUntil } = req.body;\n\n      const visitor = await storage.createVisitor({\n        residentId: resident.id,\n        visitorName,\n        visitorPhone,\n        purpose,\n        accessCode: generateAccessCode(),\n        validFrom: new Date(validFrom),\n        validUntil: new Date(validUntil),\n        status: \"approved\",\n      });\n\n      // Create notification for resident\n      await storage.createNotification({\n        userId,\n        title: \"Visitor Access Created\",\n        message: `QR code generated for ${visitorName}`,\n        type: \"visitor\",\n        isRead: false,\n      });\n\n      res.json(visitor);\n    } catch (error) {\n      console.error(\"Error creating visitor:\", error);\n      res.status(500).json({ message: \"Failed to create visitor access\" });\n    }\n  });\n\n  // ========== ADMIN ROUTES ==========\n  \n  // User Invite Management\n  app.post('/api/admin/user-invites', requireAdmin, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const { email, role, firstName, lastName, unitNumber } = req.body;\n\n      // Expire any existing pending invites for this email\n      const existingInvites = await storage.getAllUserInvites();\n      for (const existing of existingInvites) {\n        if (existing.email === email && existing.status === 'pending') {\n          await storage.expireUserInvite(existing.id);\n        }\n      }\n\n      // Generate unique invite token\n      const inviteToken = randomBytes(32).toString('hex');\n      \n      // Set expiration to 7 days from now\n      const expiresAt = new Date();\n      expiresAt.setDate(expiresAt.getDate() + 7);\n\n      const invite = await storage.createUserInvite({\n        inviteToken,\n        email,\n        role,\n        firstName,\n        lastName,\n        unitNumber,\n        createdBy: userId,\n        status: 'pending',\n        expiresAt,\n        acceptedByUserId: null,\n      });\n\n      // Generate invite link\n      const inviteLink = `${req.protocol}://${req.get('host')}/invite/${inviteToken}`;\n\n      res.json({\n        success: true,\n        invite,\n        inviteLink,\n      });\n    } catch (error) {\n      console.error(\"Error creating user invite:\", error);\n      res.status(500).json({ message: \"Failed to create user invite\" });\n    }\n  });\n\n  app.get('/api/admin/user-invites', requireAdmin, async (req: any, res) => {\n    try {\n      const invites = await storage.getAllUserInvites();\n      res.json(invites);\n    } catch (error) {\n      console.error(\"Error fetching user invites:\", error);\n      res.status(500).json({ message: \"Failed to fetch user invites\" });\n    }\n  });\n\n  app.delete('/api/admin/user-invites/:id', requireAdmin, async (req: any, res) => {\n    try {\n      await storage.expireUserInvite(req.params.id);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error expiring user invite:\", error);\n      res.status(500).json({ message: \"Failed to expire user invite\" });\n    }\n  });\n\n  // Public endpoint to validate invite token\n  app.get('/api/invite/:token', async (req, res) => {\n    try {\n      const invite = await storage.getUserInvite(req.params.token);\n      \n      if (!invite) {\n        return res.status(404).json({ message: \"Invite not found\" });\n      }\n\n      if (invite.status !== 'pending') {\n        return res.status(400).json({ message: \"Invite has already been used or expired\" });\n      }\n\n      if (new Date() > new Date(invite.expiresAt)) {\n        await storage.expireUserInvite(invite.id);\n        return res.status(400).json({ message: \"Invite has expired\" });\n      }\n\n      res.json({\n        email: invite.email,\n        role: invite.role,\n        firstName: invite.firstName,\n        lastName: invite.lastName,\n        unitNumber: invite.unitNumber,\n      });\n    } catch (error) {\n      console.error(\"Error validating invite:\", error);\n      res.status(500).json({ message: \"Failed to validate invite\" });\n    }\n  });\n\n  // User Management Routes\n  app.get('/api/admin/users', requireAdmin, async (req: any, res) => {\n    try {\n      const users = await storage.getAllUsers();\n      res.json(users);\n    } catch (error) {\n      console.error(\"Error fetching users:\", error);\n      res.status(500).json({ message: \"Failed to fetch users\" });\n    }\n  });\n\n  app.patch('/api/admin/users/:id', requireAdmin, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const updateSchema = z.object({\n        firstName: z.string().optional(),\n        lastName: z.string().optional(),\n        role: z.enum(['resident', 'admin', 'security', 'accountant']).optional(),\n      });\n\n      const validatedData = updateSchema.parse(req.body);\n      const user = await storage.updateUser(id, validatedData);\n      \n      res.json(user);\n    } catch (error: any) {\n      console.error(\"Error updating user:\", error);\n      if (error?.name === 'ZodError') {\n        return res.status(400).json({ message: \"Invalid user data\", errors: error.errors });\n      }\n      res.status(500).json({ message: \"Failed to update user\" });\n    }\n  });\n\n  app.patch('/api/admin/users/:id/deactivate', requireAdmin, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const { isActive } = req.body;\n\n      if (typeof isActive !== 'boolean') {\n        return res.status(400).json({ message: \"isActive must be a boolean\" });\n      }\n\n      const user = await storage.deactivateUser(id, isActive);\n      res.json(user);\n    } catch (error) {\n      console.error(\"Error deactivating user:\", error);\n      res.status(500).json({ message: \"Failed to deactivate user\" });\n    }\n  });\n\n  // Store invite token in session before auth redirect\n  app.post('/api/store-invite-token', async (req: any, res) => {\n    try {\n      const { inviteToken } = req.body;\n      \n      if (!inviteToken) {\n        return res.status(400).json({ message: \"Invite token is required\" });\n      }\n\n      // Store token in session\n      req.session.inviteToken = inviteToken;\n      \n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error storing invite token:\", error);\n      res.status(500).json({ message: \"Failed to store invite token\" });\n    }\n  });\n  \n  // Get admin stats\n  app.get('/api/admin/stats', requireAdmin, async (req: any, res) => {\n    try {\n      const stats = await storage.getAdminStats();\n      res.json(stats);\n    } catch (error) {\n      console.error(\"Error fetching admin stats:\", error);\n      res.status(500).json({ message: \"Failed to fetch stats\" });\n    }\n  });\n\n  app.get('/api/admin/dashboard/aging-analysis', requireAdmin, async (req: any, res) => {\n    try {\n      const data = await storage.getAgingAnalysis();\n      res.json(data);\n    } catch (error) {\n      console.error(\"Error fetching aging analysis:\", error);\n      res.status(500).json({ message: \"Failed to fetch aging analysis\" });\n    }\n  });\n\n  app.get('/api/admin/dashboard/budget-vs-expenses', requireAdmin, async (req: any, res) => {\n    try {\n      const data = await storage.getBudgetVsExpensesMonthToDate();\n      res.json(data);\n    } catch (error) {\n      console.error(\"Error fetching budget vs expenses:\", error);\n      res.status(500).json({ message: \"Failed to fetch budget vs expenses\" });\n    }\n  });\n\n  app.get('/api/admin/dashboard/collections-expenses', requireAdmin, async (req: any, res) => {\n    try {\n      const data = await storage.getCollectionsExpensesByMonth();\n      res.json(data);\n    } catch (error) {\n      console.error(\"Error fetching collections vs expenses:\", error);\n      res.status(500).json({ message: \"Failed to fetch collections vs expenses\" });\n    }\n  });\n\n  // Get all residents\n  // Get all collections (payment applications) - admin only\n  app.get('/api/admin/collections', requireAdmin, async (req: any, res) => {\n    try {\n      const collections = await storage.getAllCollections();\n      res.json(collections);\n    } catch (error) {\n      console.error(\"Error fetching collections:\", error);\n      res.status(500).json({ message: \"Failed to fetch collections\" });\n    }\n  });\n\n  // Get current subscription - admin only\n  app.get('/api/admin/subscription', requireAdmin, async (req: any, res) => {\n    try {\n      const subscription = await storage.getSubscription();\n      res.json(subscription);\n    } catch (error) {\n      console.error(\"Error fetching subscription:\", error);\n      res.status(500).json({ message: \"Failed to fetch subscription\" });\n    }\n  });\n\n  // Update subscription - admin only\n  app.post('/api/admin/subscription', requireAdmin, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      \n      // Validate request body\n      const updateSchema = z.object({\n        plan: z.enum(['starter', 'professional', 'enterprise']),\n        billingCycle: z.enum(['monthly', 'annual']),\n        estateName: z.string().optional(),\n      });\n\n      const validatedData = updateSchema.parse(req.body);\n      \n      const subscription = await storage.updateSubscription(validatedData, userId);\n      res.json(subscription);\n    } catch (error: any) {\n      console.error(\"Error updating subscription:\", error);\n      if (error?.name === 'ZodError') {\n        return res.status(400).json({ message: \"Invalid subscription data\", errors: error.errors });\n      }\n      res.status(500).json({ message: \"Failed to update subscription\" });\n    }\n  });\n\n  app.get('/api/admin/residents', requireAdmin, async (req: any, res) => {\n    try {\n      const residents = await storage.getAllResidents();\n      res.json(residents);\n    } catch (error) {\n      console.error(\"Error fetching residents:\", error);\n      res.status(500).json({ message: \"Failed to fetch residents\" });\n    }\n  });\n\n  // Get bills for a specific resident (admin only)\n  app.get('/api/admin/residents/:residentId/bills', requireAdmin, async (req: any, res) => {\n    try {\n\n      const { residentId } = req.params;\n      const bills = await storage.getBillsByResidentId(residentId);\n      res.json(bills);\n    } catch (error) {\n      console.error(\"Error fetching resident bills:\", error);\n      res.status(500).json({ message: \"Failed to fetch bills\" });\n    }\n  });\n\n  // Generate and download invoice PDF for a specific resident's bill (admin only)\n  app.get('/api/admin/residents/:residentId/bills/:billId/pdf', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const { residentId, billId } = req.params;\n      \n      // Get bill and verify it belongs to the specified resident\n      const bill = await storage.getBill(billId);\n      if (!bill) {\n        return res.status(404).json({ message: \"Bill not found\" });\n      }\n\n      if (bill.residentId !== residentId) {\n        return res.status(403).json({ message: \"Bill does not belong to this resident\" });\n      }\n\n      // Get resident information\n      const resident = await storage.getResident(residentId);\n      if (!resident) {\n        return res.status(404).json({ message: \"Resident not found\" });\n      }\n\n      // Get user information\n      const residentUser = await storage.getUser(resident.userId);\n      if (!residentUser) {\n        return res.status(404).json({ message: \"Resident user not found\" });\n      }\n\n      // Calculate totals\n      const payments = await storage.getPaymentsByBillId(billId);\n      const totalPaid = payments\n        .filter(p => p.status === \"completed\")\n        .reduce((sum, p) => sum + parseFloat(p.amount), 0);\n      const balance = parseFloat(bill.amount) - totalPaid;\n\n      // Import the PDF generator\n      const { generateInvoicePDF } = await import('./pdf-invoice');\n\n      // Generate PDF\n      const pdfBuffer = await generateInvoicePDF({\n        invoiceNumber: bill.invoiceNumber || `INV-${bill.id.slice(0, 8)}`,\n        invoiceDate: bill.createdAt || new Date(),\n        dueDate: bill.dueDate,\n        residentName: `${residentUser.firstName || ''} ${residentUser.lastName || ''}`.trim() || 'Resident',\n        unitNumber: resident.unitNumber,\n        userId: residentUser.id.slice(0, 8),\n        billingPeriod: `${new Date(bill.periodStart).toLocaleDateString()} - ${new Date(bill.periodEnd).toLocaleDateString()}`,\n        description: bill.description,\n        amount: bill.amount,\n        balance: balance.toFixed(2),\n        totalPaid: totalPaid.toFixed(2)\n      });\n\n      // Set response headers\n      res.setHeader('Content-Type', 'application/pdf');\n      res.setHeader('Content-Disposition', `attachment; filename=\"Invoice-${bill.invoiceNumber || bill.id}.pdf\"`);\n      res.setHeader('Content-Length', pdfBuffer.length);\n\n      // Send PDF\n      res.send(pdfBuffer);\n    } catch (error: any) {\n      console.error(\"Error generating invoice PDF for admin:\", error);\n      res.status(500).json({ message: \"Failed to generate invoice PDF\" });\n    }\n  });\n\n  // Send invoice email for a specific bill (admin only)\n  app.post('/api/admin/bills/:billId/send-email', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const { billId } = req.params;\n      const bill = await storage.getBill(billId);\n      \n      if (!bill) {\n        return res.status(404).json({ message: \"Bill not found\" });\n      }\n\n      const result = await storage.sendInvoiceEmailsForBills([bill]);\n      \n      if (result.sent > 0) {\n        res.json({ \n          message: \"Invoice email sent successfully\",\n          sent: result.sent,\n          failed: result.failed\n        });\n      } else {\n        res.status(500).json({ \n          message: \"Failed to send invoice email\",\n          sent: result.sent,\n          failed: result.failed\n        });\n      }\n    } catch (error) {\n      console.error(\"Error sending invoice email:\", error);\n      res.status(500).json({ message: \"Failed to send invoice email\" });\n    }\n  });\n\n  // Send invoice emails for multiple bills (admin only)\n  app.post('/api/admin/bills/send-emails', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const { billIds } = req.body;\n      \n      if (!Array.isArray(billIds) || billIds.length === 0) {\n        return res.status(400).json({ message: \"Please provide an array of bill IDs\" });\n      }\n\n      // Fetch all bills\n      const bills = await Promise.all(\n        billIds.map(id => storage.getBill(id))\n      );\n      \n      const validBills = bills.filter(bill => bill !== undefined);\n      \n      if (validBills.length === 0) {\n        return res.status(404).json({ message: \"No valid bills found\" });\n      }\n\n      const result = await storage.sendInvoiceEmailsForBills(validBills);\n      \n      res.json({ \n        message: `Sent ${result.sent} invoice emails successfully`,\n        sent: result.sent,\n        failed: result.failed,\n        total: validBills.length\n      });\n    } catch (error) {\n      console.error(\"Error sending invoice emails:\", error);\n      res.status(500).json({ message: \"Failed to send invoice emails\" });\n    }\n  });\n\n  // Get payments for a specific resident (admin only)\n  app.get('/api/admin/residents/:residentId/payments', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const { residentId } = req.params;\n      const payments = await storage.getPaymentsByResidentId(residentId);\n      res.json(payments);\n    } catch (error) {\n      console.error(\"Error fetching resident payments:\", error);\n      res.status(500).json({ message: \"Failed to fetch payments\" });\n    }\n  });\n\n  // Create resident\n  app.post('/api/admin/residents', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const { \n        email, \n        firstName, \n        lastName, \n        unitNumber,\n        streetName, \n        phoneNumber,\n        moveInDate,\n        occupancyType,\n        numberOfOccupants,\n        propertySize,\n        bedrooms,\n        parkingSpaces,\n        emergencyContactName,\n        emergencyContactPhone,\n        emergencyContactRelationship,\n        vehicles,\n        specialNotes,\n        serviceCharge,\n        startDate,\n      } = req.body;\n\n      // Validate and normalize serviceCharge\n      let validatedServiceCharge: string | null = null;\n      if (serviceCharge !== undefined && serviceCharge !== null && serviceCharge !== \"\") {\n        const numericValue = Number(serviceCharge);\n        if (isNaN(numericValue)) {\n          return res.status(400).json({ \n            message: \"Service charge must be a valid number\" \n          });\n        }\n        validatedServiceCharge = numericValue.toFixed(2);\n      }\n\n      // Parse and validate start date\n      // Note: endDate is system-managed and set automatically when bills are generated\n      let validatedStartDate: Date | null = null;\n      if (startDate !== undefined) {\n        if (startDate && startDate !== \"\") {\n          const parsedStart = new Date(startDate);\n          if (isNaN(parsedStart.getTime())) {\n            return res.status(400).json({ \n              message: \"Start date is invalid\" \n            });\n          }\n          validatedStartDate = parsedStart;\n        } else {\n          validatedStartDate = null;\n        }\n      }\n\n      // Create user account\n      const newUser = await storage.upsertUser({\n        email,\n        firstName,\n        lastName,\n        role: \"resident\",\n      });\n\n      // Process vehicles - convert from textarea string to array\n      const vehicleArray = vehicles \n        ? vehicles.split('\\n').filter((v: string) => v.trim()).map((v: string) => v.trim())\n        : null;\n\n      // Create resident profile with comprehensive data\n      const resident = await storage.createResident({\n        userId: newUser.id,\n        unitNumber,\n        streetName,\n        phoneNumber,\n        accountStatus: \"active\",\n        totalBalance: \"0\",\n        // Comprehensive fields\n        moveInDate: moveInDate ? new Date(moveInDate) : null,\n        occupancyType,\n        numberOfOccupants: numberOfOccupants ? parseInt(numberOfOccupants) : null,\n        propertySize,\n        bedrooms: bedrooms ? parseInt(bedrooms) : null,\n        parkingSpaces: parkingSpaces ? parseInt(parkingSpaces) : 0,\n        emergencyContactName,\n        emergencyContactPhone,\n        emergencyContactRelationship,\n        vehicles: vehicleArray,\n        specialNotes,\n        serviceCharge: validatedServiceCharge,\n        startDate: validatedStartDate,\n        // Note: endDate is NOT set here - it's system-managed by automated billing\n      });\n\n      // Create welcome notification\n      await storage.createNotification({\n        userId: newUser.id,\n        title: \"Welcome to Estate Management\",\n        message: \"Your resident account has been created successfully\",\n        type: \"system\",\n        isRead: false,\n      });\n\n      // Automatically generate first service charge bill if resident is eligible\n      try {\n        const bill = await storage.generateBillForResident(resident.id, userId);\n        if (bill) {\n          console.log(`Auto-generated first service charge bill for resident ${resident.unitNumber}`);\n          \n          // Send invoice email\n          try {\n            const emailResult = await storage.sendInvoiceEmailsForBills([bill]);\n            if (emailResult.failed > 0) {\n              console.error(`⚠️  Invoice email failed for resident ${resident.unitNumber} (Unit ${resident.unitNumber})`);\n              console.error(`    Check the logs above for Resend domain verification requirements.`);\n            }\n          } catch (emailError: any) {\n            console.error(`❌ Failed to send invoice email for resident ${resident.unitNumber}:`, emailError.message);\n            // Don't fail the resident creation process if email sending fails\n          }\n        }\n      } catch (error) {\n        console.error(`Failed to auto-generate bill for resident ${resident.unitNumber}:`, error);\n        // Don't fail the resident creation process if billing fails\n      }\n\n      res.json(resident);\n    } catch (error: any) {\n      console.error(\"Error creating resident:\", error);\n      \n      // Handle specific database constraint errors\n      if (error.code === '23505') {\n        if (error.constraint === 'residents_unit_number_unique') {\n          return res.status(400).json({ \n            message: `Unit number \"${req.body.unitNumber}\" is already assigned to another resident. Please use a different unit number.` \n          });\n        }\n        if (error.constraint === 'users_email_unique') {\n          return res.status(400).json({ \n            message: `Email address \"${req.body.email}\" is already in use. Please use a different email.` \n          });\n        }\n      }\n      \n      res.status(500).json({ message: \"Failed to create resident\" });\n    }\n  });\n\n  // Update resident\n  app.patch('/api/admin/residents/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const { id } = req.params;\n      const { \n        unitNumber,\n        streetName, \n        phoneNumber,\n        moveInDate,\n        occupancyType,\n        numberOfOccupants,\n        propertySize,\n        bedrooms,\n        parkingSpaces,\n        emergencyContactName,\n        emergencyContactPhone,\n        emergencyContactRelationship,\n        vehicles,\n        specialNotes,\n        serviceCharge,\n        startDate,\n      } = req.body;\n\n      // Note: endDate is system-managed and cannot be updated manually\n      // It is automatically set when bills are generated\n\n      // Validate and normalize all fields\n      let validatedServiceCharge: string | null | undefined = undefined;\n      if (serviceCharge !== undefined && serviceCharge !== null && serviceCharge !== \"\") {\n        const numericValue = Number(serviceCharge);\n        if (isNaN(numericValue)) {\n          return res.status(400).json({ \n            message: \"Service charge must be a valid number\" \n          });\n        }\n        validatedServiceCharge = numericValue.toFixed(2);\n      } else if (serviceCharge === null || serviceCharge === \"\") {\n        validatedServiceCharge = null;\n      }\n\n      // Parse and validate start date\n      let validatedStartDate: Date | null | undefined = undefined;\n      if (startDate !== undefined) {\n        if (startDate) {\n          const parsedStart = new Date(startDate);\n          if (isNaN(parsedStart.getTime())) {\n            return res.status(400).json({ \n              message: \"Start date is invalid\" \n            });\n          }\n          validatedStartDate = parsedStart;\n        } else {\n          validatedStartDate = null;\n        }\n      }\n\n      // Normalize numeric fields (explicit checks to handle 0 correctly)\n      let validatedOccupants: number | null | undefined = undefined;\n      if (numberOfOccupants !== undefined) {\n        if (numberOfOccupants !== null && numberOfOccupants !== \"\") {\n          const num = Number(numberOfOccupants);\n          validatedOccupants = isNaN(num) ? null : num;\n        } else {\n          validatedOccupants = null;\n        }\n      }\n\n      let validatedBedrooms: number | null | undefined = undefined;\n      if (bedrooms !== undefined) {\n        if (bedrooms !== null && bedrooms !== \"\") {\n          const num = Number(bedrooms);\n          validatedBedrooms = isNaN(num) ? null : num;\n        } else {\n          validatedBedrooms = null;\n        }\n      }\n\n      let validatedParkingSpaces: number | undefined = undefined;\n      if (parkingSpaces !== undefined) {\n        if (parkingSpaces !== null && parkingSpaces !== \"\") {\n          const num = Number(parkingSpaces);\n          validatedParkingSpaces = isNaN(num) ? 0 : num;\n        } else {\n          validatedParkingSpaces = 0;\n        }\n      }\n\n      let validatedMoveInDate: Date | null | undefined = undefined;\n      if (moveInDate !== undefined) {\n        if (moveInDate !== null && moveInDate !== \"\") {\n          validatedMoveInDate = new Date(moveInDate);\n        } else {\n          validatedMoveInDate = null;\n        }\n      }\n\n      // Process vehicles - convert from textarea string to array\n      const vehicleArray = vehicles !== undefined\n        ? (typeof vehicles === 'string' \n            ? vehicles.split('\\n').filter((v: string) => v.trim()).map((v: string) => v.trim())\n            : vehicles)\n        : undefined;\n\n      // Build update data object using validated values\n      const updateData: any = {};\n      if (unitNumber !== undefined) updateData.unitNumber = unitNumber;\n      if (streetName !== undefined) updateData.streetName = streetName;\n      if (phoneNumber !== undefined) updateData.phoneNumber = phoneNumber;\n      if (validatedMoveInDate !== undefined) updateData.moveInDate = validatedMoveInDate;\n      if (occupancyType !== undefined) updateData.occupancyType = occupancyType;\n      if (validatedOccupants !== undefined) updateData.numberOfOccupants = validatedOccupants;\n      if (propertySize !== undefined) updateData.propertySize = propertySize;\n      if (validatedBedrooms !== undefined) updateData.bedrooms = validatedBedrooms;\n      if (validatedParkingSpaces !== undefined) updateData.parkingSpaces = validatedParkingSpaces;\n      if (emergencyContactName !== undefined) updateData.emergencyContactName = emergencyContactName;\n      if (emergencyContactPhone !== undefined) updateData.emergencyContactPhone = emergencyContactPhone;\n      if (emergencyContactRelationship !== undefined) updateData.emergencyContactRelationship = emergencyContactRelationship;\n      if (vehicleArray !== undefined) updateData.vehicles = vehicleArray;\n      if (specialNotes !== undefined) updateData.specialNotes = specialNotes;\n      if (validatedServiceCharge !== undefined) updateData.serviceCharge = validatedServiceCharge;\n      if (validatedStartDate !== undefined) updateData.startDate = validatedStartDate;\n      // Note: endDate is NOT included - it's system-managed by automated billing\n\n      const resident = await storage.updateResident(id, updateData);\n      res.json(resident);\n    } catch (error: any) {\n      console.error(\"Error updating resident:\", error);\n      \n      if (error.code === '23505' && error.constraint === 'residents_unit_number_unique') {\n        return res.status(400).json({ \n          message: `Unit number \"${req.body.unitNumber}\" is already assigned to another resident.` \n        });\n      }\n      \n      res.status(500).json({ message: \"Failed to update resident\" });\n    }\n  });\n\n  // Toggle resident status\n  app.patch('/api/admin/residents/:id/status', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const { id } = req.params;\n      const { status } = req.body;\n\n      if (!status || !['active', 'inactive', 'deactivated'].includes(status)) {\n        return res.status(400).json({ message: \"Invalid status value\" });\n      }\n\n      await storage.updateResidentStatus(id, status);\n      const resident = await storage.getResident(id);\n      res.json(resident);\n    } catch (error) {\n      console.error(\"Error updating resident status:\", error);\n      res.status(500).json({ message: \"Failed to update resident status\" });\n    }\n  });\n\n  // Get account status with filters\n  app.get('/api/admin/account-status', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const { startDate, endDate, residentId } = req.query;\n\n      // Get all residents, bills, and payments\n      const [residentsData, allBills, allPayments] = await Promise.all([\n        storage.getAllResidents(),\n        storage.getAllBills(),\n        storage.getAllPayments()\n      ]);\n\n      // Apply filters consistently to bills and payments first\n      let filteredBills = allBills;\n      let filteredPayments = allPayments;\n\n      // Filter by resident ID (if specified)\n      if (residentId && typeof residentId === 'string' && residentId.trim() !== '') {\n        // Filter bills and payments to only the selected resident\n        filteredBills = filteredBills.filter(b => b.residentId === residentId);\n        filteredPayments = filteredPayments.filter(p => p.residentId === residentId);\n      }\n\n      // Filter by date range (if specified)\n      if (startDate || endDate) {\n        const start = startDate ? new Date(startDate as string) : null;\n        const end = endDate ? new Date(endDate as string) : null;\n\n        filteredBills = filteredBills.filter(bill => {\n          const billDate = new Date(bill.createdAt);\n          if (start && end) {\n            return billDate >= start && billDate <= end;\n          } else if (start) {\n            return billDate >= start;\n          } else if (end) {\n            return billDate <= end;\n          }\n          return true;\n        });\n\n        filteredPayments = filteredPayments.filter(payment => {\n          const paymentDate = new Date(payment.createdAt);\n          if (start && end) {\n            return paymentDate >= start && paymentDate <= end;\n          } else if (start) {\n            return paymentDate >= start;\n          } else if (end) {\n            return paymentDate <= end;\n          }\n          return true;\n        });\n      }\n\n      // Count unique residents from filtered bills and payments\n      const billResidentIds = new Set(filteredBills.map(b => b.residentId));\n      const paymentResidentIds = new Set(filteredPayments.map(p => p.residentId));\n      const activeResidentIds = new Set([...billResidentIds, ...paymentResidentIds]);\n      const totalResidents = activeResidentIds.size;\n      const totalBilled = filteredBills.reduce((sum, bill) => sum + parseFloat(bill.amount), 0);\n      const totalCollected = filteredPayments.reduce((sum, payment) => sum + parseFloat(payment.amount), 0);\n      const totalOutstanding = totalBilled - totalCollected;\n\n      // Calculate aging analysis (only for overdue bills)\n      const now = new Date();\n      const agingBuckets = {\n        current: 0,           // Not yet due\n        '1-30': 0,           // 1-30 days overdue\n        '31-60': 0,          // 31-60 days overdue\n        '61-90': 0,          // 61-90 days overdue\n        '90+': 0,            // 90+ days overdue\n      };\n\n      filteredBills.forEach(bill => {\n        if (bill.status !== 'paid') {\n          const dueDate = new Date(bill.dueDate);\n          const daysOverdue = Math.floor((now.getTime() - dueDate.getTime()) / (1000 * 60 * 60 * 24));\n          const amount = parseFloat(bill.amount);\n\n          if (daysOverdue < 0) {\n            agingBuckets.current += amount;\n          } else if (daysOverdue <= 30) {\n            agingBuckets['1-30'] += amount;\n          } else if (daysOverdue <= 60) {\n            agingBuckets['31-60'] += amount;\n          } else if (daysOverdue <= 90) {\n            agingBuckets['61-90'] += amount;\n          } else {\n            agingBuckets['90+'] += amount;\n          }\n        }\n      });\n\n      res.json({\n        summary: {\n          totalResidents,\n          totalBilled,\n          totalCollected,\n          totalOutstanding,\n        },\n        aging: agingBuckets,\n      });\n    } catch (error) {\n      console.error(\"Error fetching account status:\", error);\n      res.status(500).json({ message: \"Failed to fetch account status\" });\n    }\n  });\n\n  // ========== REPORTS CENTER ENDPOINTS ==========\n  \n  // Visitor Activity Report\n  app.get('/api/admin/reports/visitor-activity', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const visitors = await storage.getAllVisitors();\n      const residentsData = await storage.getAllResidents();\n      \n      // Count by status\n      const statusCounts = visitors.reduce((acc, v) => {\n        acc[v.status] = (acc[v.status] || 0) + 1;\n        return acc;\n      }, {} as Record<string, number>);\n\n      // Prepare visitor data with resident names\n      const visitorsWithDetails = await Promise.all(\n        visitors.slice(0, 100).map(async (visitor) => {\n          const resident = residentsData.find(r => r.residents.id === visitor.residentId);\n          const residentUser = resident ? await storage.getUser(resident.residents.userId) : null;\n          \n          return {\n            visitorName: visitor.name,\n            residentName: residentUser ? `${residentUser.firstName} ${residentUser.lastName}` : 'Unknown',\n            visitDate: visitor.visitDate,\n            status: visitor.status,\n            accessCode: visitor.accessCode\n          };\n        })\n      );\n\n      res.json({\n        summary: {\n          totalVisitors: visitors.length,\n          approved: statusCounts['approved'] || 0,\n          pending: statusCounts['pending'] || 0,\n          rejected: statusCounts['rejected'] || 0,\n        },\n        visitors: visitorsWithDetails\n      });\n    } catch (error) {\n      console.error(\"Error generating visitor activity report:\", error);\n      res.status(500).json({ message: \"Failed to generate report\" });\n    }\n  });\n\n  // Account Status Report\n  app.get('/api/admin/reports/account-status', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const residentsData = await storage.getAllResidents();\n      const allBills = await storage.getAllBills();\n      const allPayments = await storage.getAllPayments();\n\n      const residentsWithStatus = await Promise.all(\n        residentsData.map(async (item) => {\n          const residentBills = allBills.filter(b => b.residentId === item.residents.id);\n          const residentPayments = allPayments.filter(p => p.residentId === item.residents.id);\n          \n          const totalBilled = residentBills.reduce((sum, b) => sum + parseFloat(b.amount), 0);\n          const totalPaid = residentPayments\n            .filter(p => p.status === \"completed\")\n            .reduce((sum, p) => sum + parseFloat(p.amount), 0);\n          const balance = totalBilled - totalPaid;\n\n          // Count overdue bills (14 days grace period)\n          const now = new Date();\n          const overdueBills = residentBills.filter(bill => {\n            const createdDate = new Date(bill.createdAt);\n            const daysSinceCreated = Math.floor((now.getTime() - createdDate.getTime()) / (1000 * 60 * 60 * 24));\n            return bill.status !== 'paid' && daysSinceCreated > 14;\n          }).length;\n\n          return {\n            name: `${item.users.firstName} ${item.users.lastName}`,\n            unitNumber: item.residents.unitNumber,\n            accountStatus: item.residents.accountStatus,\n            balance: balance.toFixed(2),\n            overdueBills\n          };\n        })\n      );\n\n      const activeCount = residentsWithStatus.filter(r => r.accountStatus === 'active').length;\n      const delinquentCount = residentsWithStatus.filter(r => parseFloat(r.balance) > 0 && r.overdueBills > 0).length;\n\n      res.json({\n        summary: {\n          totalResidents: residentsData.length,\n          active: activeCount,\n          delinquent: delinquentCount\n        },\n        residents: residentsWithStatus\n      });\n    } catch (error) {\n      console.error(\"Error generating account status report:\", error);\n      res.status(500).json({ message: \"Failed to generate report\" });\n    }\n  });\n\n  // Overdue Bills Report\n  app.get('/api/admin/reports/overdue-bills', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const allBills = await storage.getAllBills();\n      const residentsData = await storage.getAllResidents();\n      const now = new Date();\n\n      // Filter overdue bills (14 days grace period from creation date)\n      const overdueBills = allBills.filter(bill => {\n        if (bill.status === 'paid') return false;\n        const createdDate = new Date(bill.createdAt);\n        const daysSinceCreated = Math.floor((now.getTime() - createdDate.getTime()) / (1000 * 60 * 60 * 24));\n        return daysSinceCreated > 14;\n      });\n\n      // Calculate aging buckets\n      let aging_0_30 = 0;\n      let aging_31_60 = 0;\n      let aging_60_plus = 0;\n      let totalOverdue = 0;\n\n      const billsWithDetails = await Promise.all(\n        overdueBills.map(async (bill) => {\n          const resident = residentsData.find(r => r.residents.id === bill.residentId);\n          const createdDate = new Date(bill.createdAt);\n          const daysOverdue = Math.floor((now.getTime() - createdDate.getTime()) / (1000 * 60 * 60 * 24)) - 14;\n          const amount = parseFloat(bill.amount);\n\n          totalOverdue += amount;\n          if (daysOverdue <= 30) {\n            aging_0_30 += amount;\n          } else if (daysOverdue <= 60) {\n            aging_31_60 += amount;\n          } else {\n            aging_60_plus += amount;\n          }\n\n          return {\n            residentName: resident ? `${resident.users.firstName} ${resident.users.lastName}` : 'Unknown',\n            unitNumber: resident?.residents.unitNumber || 'N/A',\n            description: bill.description,\n            amount: bill.amount,\n            dueDate: bill.dueDate,\n            daysOverdue\n          };\n        })\n      );\n\n      res.json({\n        summary: {\n          totalOverdue: totalOverdue.toFixed(2),\n          aging_0_30: aging_0_30.toFixed(2),\n          aging_31_60: aging_31_60.toFixed(2),\n          aging_60_plus: aging_60_plus.toFixed(2)\n        },\n        bills: billsWithDetails\n      });\n    } catch (error) {\n      console.error(\"Error generating overdue bills report:\", error);\n      res.status(500).json({ message: \"Failed to generate report\" });\n    }\n  });\n\n  // Collections Summary Report\n  app.get('/api/admin/reports/collections-summary', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const allPayments = await storage.getAllPayments();\n      const completedPayments = allPayments.filter(p => p.status === 'completed');\n\n      const totalCollections = completedPayments.reduce((sum, p) => sum + parseFloat(p.amount), 0);\n      const paymentCount = completedPayments.length;\n      const averagePayment = paymentCount > 0 ? totalCollections / paymentCount : 0;\n\n      // Group by payment method\n      const byMethod = Object.entries(\n        completedPayments.reduce((acc, p) => {\n          const method = p.paymentMethod || 'unknown';\n          if (!acc[method]) {\n            acc[method] = { total: 0, count: 0 };\n          }\n          acc[method].total += parseFloat(p.amount);\n          acc[method].count += 1;\n          return acc;\n        }, {} as Record<string, { total: number; count: number }>)\n      ).map(([method, data]) => ({\n        paymentMethod: method,\n        total: data.total.toFixed(2),\n        count: data.count,\n        percentage: ((data.total / totalCollections) * 100).toFixed(1)\n      }));\n\n      res.json({\n        summary: {\n          totalCollections: totalCollections.toFixed(2),\n          paymentCount,\n          averagePayment: averagePayment.toFixed(2)\n        },\n        byMethod\n      });\n    } catch (error) {\n      console.error(\"Error generating collections summary report:\", error);\n      res.status(500).json({ message: \"Failed to generate report\" });\n    }\n  });\n\n  // Revenue Analysis Report\n  app.get('/api/admin/reports/revenue-analysis', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const allBills = await storage.getAllBills();\n      const allPayments = await storage.getAllPayments();\n\n      const totalBilled = allBills.reduce((sum, b) => sum + parseFloat(b.amount), 0);\n      const totalCollected = allPayments\n        .filter(p => p.status === 'completed')\n        .reduce((sum, p) => sum + parseFloat(p.amount), 0);\n      const outstanding = totalBilled - totalCollected;\n      const collectionRate = totalBilled > 0 ? ((totalCollected / totalBilled) * 100).toFixed(1) : '0';\n\n      // Group by month for trend analysis\n      const monthlyData = allBills.reduce((acc, bill) => {\n        const month = new Date(bill.createdAt).toLocaleDateString('en-US', { year: 'numeric', month: 'short' });\n        if (!acc[month]) {\n          acc[month] = { billed: 0, collected: 0 };\n        }\n        acc[month].billed += parseFloat(bill.amount);\n        return acc;\n      }, {} as Record<string, { billed: number; collected: number }>);\n\n      // Add payment data to monthly\n      allPayments.filter(p => p.status === 'completed').forEach(payment => {\n        const month = new Date(payment.createdAt).toLocaleDateString('en-US', { year: 'numeric', month: 'short' });\n        if (monthlyData[month]) {\n          monthlyData[month].collected += parseFloat(payment.amount);\n        }\n      });\n\n      const monthly = Object.entries(monthlyData).map(([month, data]) => ({\n        month,\n        billed: data.billed.toFixed(2),\n        collected: data.collected.toFixed(2),\n        collectionRate: data.billed > 0 ? ((data.collected / data.billed) * 100).toFixed(1) : '0'\n      })).slice(-6); // Last 6 months\n\n      res.json({\n        summary: {\n          totalBilled: totalBilled.toFixed(2),\n          totalCollected: totalCollected.toFixed(2),\n          collectionRate,\n          outstanding: outstanding.toFixed(2)\n        },\n        monthly\n      });\n    } catch (error) {\n      console.error(\"Error generating revenue analysis report:\", error);\n      res.status(500).json({ message: \"Failed to generate report\" });\n    }\n  });\n\n  // Accounts Receivable Aging Report\n  app.get('/api/admin/reports/ar-aging', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const allBills = await storage.getAllBills();\n      const allPayments = await storage.getAllPayments();\n      const residentsData = await storage.getAllResidents();\n      const now = new Date();\n\n      // Calculate AR by resident with aging\n      const arByResident = await Promise.all(\n        residentsData.map(async (item) => {\n          const residentBills = allBills.filter(b => b.residentId === item.residents.id && b.status !== 'paid');\n          const residentPayments = allPayments.filter(p => p.residentId === item.residents.id && p.status === 'completed');\n\n          const totalBilled = residentBills.reduce((sum, b) => sum + parseFloat(b.amount), 0);\n          const totalPaid = residentPayments.reduce((sum, p) => sum + parseFloat(p.amount), 0);\n          \n          let current = 0, days_1_30 = 0, days_31_60 = 0, days_60_plus = 0;\n\n          residentBills.forEach(bill => {\n            const dueDate = new Date(bill.dueDate);\n            const daysOverdue = Math.floor((now.getTime() - dueDate.getTime()) / (1000 * 60 * 60 * 24));\n            const amount = parseFloat(bill.amount);\n\n            if (daysOverdue <= 0) {\n              current += amount;\n            } else if (daysOverdue <= 30) {\n              days_1_30 += amount;\n            } else if (daysOverdue <= 60) {\n              days_31_60 += amount;\n            } else {\n              days_60_plus += amount;\n            }\n          });\n\n          return {\n            residentName: `${item.users.firstName} ${item.users.lastName}`,\n            unitNumber: item.residents.unitNumber,\n            current: current.toFixed(2),\n            days_1_30: days_1_30.toFixed(2),\n            days_31_60: days_31_60.toFixed(2),\n            days_60_plus: days_60_plus.toFixed(2),\n            total: (current + days_1_30 + days_31_60 + days_60_plus).toFixed(2)\n          };\n        })\n      );\n\n      // Calculate totals\n      const summary = arByResident.reduce((acc, r) => {\n        acc.totalAR += parseFloat(r.total);\n        acc.current += parseFloat(r.current);\n        acc.days_1_30 += parseFloat(r.days_1_30);\n        acc.days_31_60 += parseFloat(r.days_31_60);\n        acc.days_60_plus += parseFloat(r.days_60_plus);\n        return acc;\n      }, { totalAR: 0, current: 0, days_1_30: 0, days_31_60: 0, days_60_plus: 0 });\n\n      res.json({\n        summary: {\n          totalAR: summary.totalAR.toFixed(2),\n          current: summary.current.toFixed(2),\n          days_1_30: summary.days_1_30.toFixed(2),\n          days_31_60: summary.days_31_60.toFixed(2),\n          days_60_plus: summary.days_60_plus.toFixed(2)\n        },\n        details: arByResident.filter(r => parseFloat(r.total) > 0)\n      });\n    } catch (error) {\n      console.error(\"Error generating AR aging report:\", error);\n      res.status(500).json({ message: \"Failed to generate report\" });\n    }\n  });\n\n  // Budget Performance Report\n  app.get('/api/admin/reports/budget-performance', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const budgets = await storage.getAllBudgets();\n      const expenses = await storage.getAllExpenses();\n\n      // Get active budget\n      const activeBudget = budgets.find(b => b.status === 'active');\n\n      if (!activeBudget) {\n        return res.json({\n          summary: {\n            totalBudget: '0.00',\n            actualSpent: '0.00',\n            variance: '0.00',\n            utilization: '0'\n          },\n          categories: []\n        });\n      }\n\n      // Get budget items\n      const budgetItems = await storage.getBudgetItems(activeBudget.id);\n      \n      // Calculate actual spending by category\n      const approvedExpenses = expenses.filter(e => e.status === 'approved' || e.status === 'paid');\n      \n      const categories = budgetItems.map(item => {\n        const categoryExpenses = approvedExpenses.filter(e => e.accountId === item.accountId);\n        const actualSpent = categoryExpenses.reduce((sum, e) => sum + parseFloat(e.amount), 0);\n        const budgetAmount = parseFloat(item.amount);\n        const variance = budgetAmount - actualSpent;\n        const percentUsed = budgetAmount > 0 ? ((actualSpent / budgetAmount) * 100).toFixed(1) : '0';\n\n        return {\n          name: item.description || `Account ${item.accountId}`,\n          budget: budgetAmount.toFixed(2),\n          actual: actualSpent.toFixed(2),\n          variance: variance.toFixed(2),\n          percentUsed\n        };\n      });\n\n      const totalBudget = budgetItems.reduce((sum, item) => sum + parseFloat(item.amount), 0);\n      const actualSpent = approvedExpenses.reduce((sum, e) => sum + parseFloat(e.amount), 0);\n      const variance = totalBudget - actualSpent;\n      const utilization = totalBudget > 0 ? ((actualSpent / totalBudget) * 100).toFixed(1) : '0';\n\n      res.json({\n        summary: {\n          totalBudget: totalBudget.toFixed(2),\n          actualSpent: actualSpent.toFixed(2),\n          variance: variance.toFixed(2),\n          utilization\n        },\n        categories\n      });\n    } catch (error) {\n      console.error(\"Error generating budget performance report:\", error);\n      res.status(500).json({ message: \"Failed to generate report\" });\n    }\n  });\n\n  // Resident Service Charge Summary Report\n  app.get('/api/admin/reports/resident-service-charge-summary', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const residents = await storage.getAllResidents();\n      const allBills = await storage.getAllBills();\n      const allPayments = await storage.getAllPayments();\n\n      const reportData = await Promise.all(residents.map(async (resident: any) => {\n        // Filter for service charge bills only (billingType: \"Estate Maintenance\") and exclude void/cancelled bills\n        const residentBills = allBills.filter(b => \n          b.residentId === resident.id && \n          (b.billingType === \"Estate Maintenance\" || b.billingType === \"Service Charge\") &&\n          b.status !== 'void' && \n          b.status !== 'cancelled'\n        );\n        const totalServiceCharge = residentBills.reduce((sum, bill) => sum + parseFloat(bill.amount), 0);\n\n        // Calculate payments for these specific service charge bills\n        const billIds = residentBills.map(b => b.id);\n        const residentPayments = allPayments.filter(p => \n          billIds.includes(p.billId) && \n          p.status === 'completed'\n        );\n        const amountPaid = residentPayments.reduce((sum, payment) => sum + parseFloat(payment.amount), 0);\n\n        const outstandingBalance = totalServiceCharge - amountPaid;\n\n        return {\n          resident: resident.user ? `${resident.user.firstName || ''} ${resident.user.lastName || ''}`.trim() : 'N/A',\n          houseNo: resident.unitNumber,\n          phone: resident.phoneNumber || 'N/A',\n          totalServiceCharge: totalServiceCharge.toFixed(2),\n          amountPaid: amountPaid.toFixed(2),\n          outstandingBalance: outstandingBalance.toFixed(2)\n        };\n      }));\n\n      const summary = {\n        totalResidents: residents.length,\n        totalServiceCharge: reportData.reduce((sum, r) => sum + parseFloat(r.totalServiceCharge), 0).toFixed(2),\n        totalAmountPaid: reportData.reduce((sum, r) => sum + parseFloat(r.amountPaid), 0).toFixed(2),\n        totalOutstanding: reportData.reduce((sum, r) => sum + parseFloat(r.outstandingBalance), 0).toFixed(2)\n      };\n\n      res.json({\n        summary,\n        residents: reportData\n      });\n    } catch (error) {\n      console.error(\"Error generating resident service charge summary:\", error);\n      res.status(500).json({ message: \"Failed to generate report\" });\n    }\n  });\n\n  // Expense Report\n  app.get('/api/admin/reports/expense-report', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const { startDate, endDate, vendorId, approvalStatus, paymentStatus } = req.query;\n\n      let expenses = await storage.getAllExpenses();\n      const vendors = await storage.getAllVendors();\n      const accounts = await storage.getAllAccounts();\n\n      if (startDate) {\n        expenses = expenses.filter(e => new Date(e.createdAt) >= new Date(startDate as string));\n      }\n\n      if (endDate) {\n        expenses = expenses.filter(e => new Date(e.createdAt) <= new Date(endDate as string));\n      }\n\n      if (vendorId) {\n        expenses = expenses.filter(e => e.vendorId === vendorId);\n      }\n\n      if (approvalStatus) {\n        expenses = expenses.filter(e => e.status === approvalStatus);\n      }\n\n      if (paymentStatus) {\n        expenses = expenses.filter(e => e.paymentStatus === paymentStatus);\n      }\n\n      const reportData = expenses.map(expense => {\n        const vendor = vendors.find(v => v.id === expense.vendorId);\n        const account = accounts.find(a => a.id === expense.accountId);\n\n        return {\n          id: expense.id,\n          date: format(new Date(expense.createdAt), 'dd-MMM-yyyy'),\n          vendor: vendor?.name || 'N/A',\n          description: expense.description,\n          category: account?.name || 'Uncategorized',\n          amount: parseFloat(expense.amount).toFixed(2),\n          approved: expense.status === 'approved' || expense.status === 'paid' ? 'Yes' : expense.status === 'rejected' ? 'No' : 'Pending',\n          paymentStatus: expense.paymentStatus || 'unpaid'\n        };\n      });\n\n      const summary = {\n        totalExpenses: expenses.length,\n        totalAmount: reportData.reduce((sum, r) => sum + parseFloat(r.amount), 0).toFixed(2),\n        approvedCount: reportData.filter(r => r.approved === 'Yes').length,\n        pendingCount: reportData.filter(r => r.approved === 'Pending').length,\n        rejectedCount: reportData.filter(r => r.approved === 'No').length,\n        paidAmount: reportData.filter(r => r.paymentStatus === 'paid').reduce((sum, r) => sum + parseFloat(r.amount), 0).toFixed(2),\n        unpaidAmount: reportData.filter(r => r.paymentStatus !== 'paid').reduce((sum, r) => sum + parseFloat(r.amount), 0).toFixed(2)\n      };\n\n      res.json({\n        summary,\n        expenses: reportData\n      });\n    } catch (error) {\n      console.error(\"Error generating expense report:\", error);\n      res.status(500).json({ message: \"Failed to generate report\" });\n    }\n  });\n\n  // CSV Export for Resident Service Charge Summary\n  app.get('/api/admin/reports/resident-service-charge-summary/export', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const residents = await storage.getAllResidents();\n      const allBills = await storage.getAllBills();\n      const allPayments = await storage.getAllPayments();\n\n      const csvRows = [\n        'Resident,House No,Phone,Total Service Charge,Amount Paid,Outstanding Balance'\n      ];\n\n      for (const resident of residents) {\n        // Filter for service charge bills only and exclude void/cancelled bills\n        const residentBills = allBills.filter(b => \n          b.residentId === resident.id && \n          (b.billingType === \"Estate Maintenance\" || b.billingType === \"Service Charge\") &&\n          b.status !== 'void' && \n          b.status !== 'cancelled'\n        );\n        const totalServiceCharge = residentBills.reduce((sum, bill) => sum + parseFloat(bill.amount), 0);\n\n        // Calculate payments for these specific service charge bills\n        const billIds = residentBills.map(b => b.id);\n        const residentPayments = allPayments.filter(p => \n          billIds.includes(p.billId) && \n          p.status === 'completed'\n        );\n        const amountPaid = residentPayments.reduce((sum, payment) => sum + parseFloat(payment.amount), 0);\n\n        const outstandingBalance = totalServiceCharge - amountPaid;\n\n        const residentName = resident.user ? `${resident.user.firstName || ''} ${resident.user.lastName || ''}`.trim() : 'N/A';\n\n        csvRows.push(`\"${residentName}\",\"${resident.unitNumber}\",\"${resident.phoneNumber || 'N/A'}\",${totalServiceCharge.toFixed(2)},${amountPaid.toFixed(2)},${outstandingBalance.toFixed(2)}`);\n      }\n\n      const csv = csvRows.join('\\n');\n\n      res.setHeader('Content-Type', 'text/csv');\n      res.setHeader('Content-Disposition', `attachment; filename=resident-service-charge-summary-${format(new Date(), 'yyyy-MM-dd')}.csv`);\n      res.send(csv);\n    } catch (error) {\n      console.error(\"Error exporting resident service charge summary:\", error);\n      res.status(500).json({ message: \"Failed to export report\" });\n    }\n  });\n\n  // CSV Export for Expense Report\n  app.get('/api/admin/reports/expense-report/export', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const { startDate, endDate, vendorId, approvalStatus, paymentStatus } = req.query;\n\n      let expenses = await storage.getAllExpenses();\n      const vendors = await storage.getAllVendors();\n      const accounts = await storage.getAllAccounts();\n\n      if (startDate) {\n        expenses = expenses.filter(e => new Date(e.createdAt) >= new Date(startDate as string));\n      }\n\n      if (endDate) {\n        expenses = expenses.filter(e => new Date(e.createdAt) <= new Date(endDate as string));\n      }\n\n      if (vendorId) {\n        expenses = expenses.filter(e => e.vendorId === vendorId);\n      }\n\n      if (approvalStatus) {\n        expenses = expenses.filter(e => e.status === approvalStatus);\n      }\n\n      if (paymentStatus) {\n        expenses = expenses.filter(e => e.paymentStatus === paymentStatus);\n      }\n\n      const csvRows = [\n        'Date,Vendor,Description,Category,Amount,Approved,Payment Status'\n      ];\n\n      for (const expense of expenses) {\n        const vendor = vendors.find(v => v.id === expense.vendorId);\n        const account = accounts.find(a => a.id === expense.accountId);\n\n        const dateFormatted = format(new Date(expense.createdAt), 'dd-MMM-yyyy');\n        const approved = expense.status === 'approved' || expense.status === 'paid' ? 'Yes' : expense.status === 'rejected' ? 'No' : 'Pending';\n\n        csvRows.push(`\"${dateFormatted}\",\"${vendor?.name || 'N/A'}\",\"${expense.description}\",\"${account?.name || 'Uncategorized'}\",${parseFloat(expense.amount).toFixed(2)},\"${approved}\",\"${expense.paymentStatus || 'unpaid'}\"`);\n      }\n\n      const csv = csvRows.join('\\n');\n\n      res.setHeader('Content-Type', 'text/csv');\n      res.setHeader('Content-Disposition', `attachment; filename=expense-report-${format(new Date(), 'yyyy-MM-dd')}.csv`);\n      res.send(csv);\n    } catch (error) {\n      console.error(\"Error exporting expense report:\", error);\n      res.status(500).json({ message: \"Failed to export report\" });\n    }\n  });\n\n  // Cash Flow Projection & Report\n  app.get('/api/admin/reports/cash-flow', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      // Get cash accounts (typically account number 1000 - Cash – Operating Account)\n      const accounts = await storage.getAllAccounts();\n      const cashAccounts = accounts.filter(a => \n        a.accountType?.toLowerCase() === 'asset' && \n        (a.category?.toLowerCase().includes('cash') || a.category?.toLowerCase().includes('bank'))\n      );\n      const openingBalance = cashAccounts.reduce((sum, acc) => sum + parseFloat(acc.balance || '0'), 0);\n\n      // Get all payment applications (cash inflows)\n      const paymentApplications = await storage.getAllPaymentApplications();\n      const totalInflows = paymentApplications.reduce((sum, pa) => sum + parseFloat(pa.amountApplied), 0);\n\n      // Get paid expenses (cash outflows)\n      const allExpenses = await storage.getAllExpenses();\n      const paidExpenses = allExpenses.filter(e => e.paymentStatus === 'paid');\n      const totalOutflows = paidExpenses.reduce((sum, exp) => sum + parseFloat(exp.netPayment || exp.expenseAmount), 0);\n\n      // Calculate net cash flow and closing balance\n      const netCashFlow = totalInflows - totalOutflows;\n      const closingBalance = openingBalance + netCashFlow;\n\n      // Group by month for trend analysis\n      const monthlyData: Record<string, { inflows: number; outflows: number }> = {};\n      \n      paymentApplications.forEach(pa => {\n        const month = format(new Date(pa.paymentDate), 'MMM yyyy');\n        if (!monthlyData[month]) {\n          monthlyData[month] = { inflows: 0, outflows: 0 };\n        }\n        monthlyData[month].inflows += parseFloat(pa.amountApplied);\n      });\n\n      paidExpenses.forEach(exp => {\n        if (exp.paidDate) {\n          const month = format(new Date(exp.paidDate), 'MMM yyyy');\n          if (!monthlyData[month]) {\n            monthlyData[month] = { inflows: 0, outflows: 0 };\n          }\n          monthlyData[month].outflows += parseFloat(exp.netPayment || exp.expenseAmount);\n        }\n      });\n\n      const monthly = Object.entries(monthlyData)\n        .map(([month, data]) => ({\n          month,\n          inflows: data.inflows,\n          outflows: data.outflows,\n          netCashFlow: data.inflows - data.outflows\n        }))\n        .sort((a, b) => new Date(a.month).getTime() - new Date(b.month).getTime());\n\n      // Get detailed inflows\n      const bills = await storage.getAllBills();\n      const residents = await storage.getAllResidents();\n      const detailedInflows = paymentApplications.map(pa => {\n        const bill = bills.find(b => b.id === pa.billId);\n        const resident = residents.find(r => r.id === bill?.residentId);\n        return {\n          date: pa.paymentDate,\n          description: bill?.description || 'Payment Application',\n          residentName: resident?.user ? `${resident.user.firstName} ${resident.user.lastName}` : 'N/A',\n          unitNumber: resident?.unitNumber || 'N/A',\n          amount: parseFloat(pa.amountApplied),\n          paymentMethod: pa.bankName ? `Bank Transfer (${pa.bankName})` : 'Manual Payment'\n        };\n      });\n\n      // Get detailed outflows\n      const vendors = await storage.getAllVendors();\n      const detailedOutflows = paidExpenses.map(exp => {\n        const vendor = vendors.find(v => v.id === exp.vendorId);\n        const account = accounts.find(a => a.id === exp.accountId);\n        return {\n          date: exp.paidDate,\n          description: exp.description,\n          vendor: vendor?.name || 'N/A',\n          category: account?.accountName || exp.expenseClassification || 'Uncategorized',\n          amount: parseFloat(exp.netPayment || exp.expenseAmount),\n          whtAmount: parseFloat(exp.whtAmount || '0')\n        };\n      });\n\n      res.json({\n        summary: {\n          openingBalance: openingBalance.toFixed(2),\n          totalInflows: totalInflows.toFixed(2),\n          totalOutflows: totalOutflows.toFixed(2),\n          netCashFlow: netCashFlow.toFixed(2),\n          closingBalance: closingBalance.toFixed(2),\n          inflowCount: paymentApplications.length,\n          outflowCount: paidExpenses.length\n        },\n        monthly,\n        detailedInflows: detailedInflows.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime()),\n        detailedOutflows: detailedOutflows.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime())\n      });\n    } catch (error) {\n      console.error(\"Error generating cash flow report:\", error);\n      res.status(500).json({ message: \"Failed to generate cash flow report\" });\n    }\n  });\n\n  // Generate automated service charge bills for all eligible residents\n  app.post('/api/admin/billing/generate-service-charges', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      const result = await storage.generateAutomatedServiceChargeBills(userId);\n      \n      res.json({\n        success: true,\n        message: `Generated ${result.success} bill(s) successfully. ${result.failed} failed.`,\n        ...result,\n      });\n    } catch (error: any) {\n      console.error(\"Error generating automated bills:\", error);\n      res.status(500).json({ \n        success: false,\n        message: error.message || \"Failed to generate automated bills\" \n      });\n    }\n  });\n\n  // ========== SECURITY ROUTES ==========\n  \n  // Get today's visitors\n  app.get('/api/security/visitors/today', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"security\") {\n        return res.status(403).json({ message: \"Security access required\" });\n      }\n\n      const visitors = await storage.getTodayVisitors();\n      res.json(visitors);\n    } catch (error) {\n      console.error(\"Error fetching today's visitors:\", error);\n      res.status(500).json({ message: \"Failed to fetch visitors\" });\n    }\n  });\n\n  // Get recent access logs\n  app.get('/api/security/logs/recent', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"security\") {\n        return res.status(403).json({ message: \"Security access required\" });\n      }\n\n      const logs = await storage.getRecentAccessLogs(50);\n      res.json(logs);\n    } catch (error) {\n      console.error(\"Error fetching access logs:\", error);\n      res.status(500).json({ message: \"Failed to fetch logs\" });\n    }\n  });\n\n  // Verify visitor access code\n  app.post('/api/security/verify', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"security\") {\n        return res.status(403).json({ message: \"Security access required\" });\n      }\n\n      const { accessCode } = req.body;\n      const visitor = await storage.getVisitorByAccessCode(accessCode);\n\n      if (!visitor) {\n        // Log denied access\n        await storage.createAccessLog({\n          securityPersonnelId: userId,\n          accessType: \"visitor\",\n          name: \"Unknown\",\n          action: \"denied\",\n          notes: `Invalid access code: ${accessCode}`,\n        });\n\n        return res.json({ valid: false, reason: \"Invalid access code\" });\n      }\n\n      const now = new Date();\n      \n      // Check if expired\n      if (new Date(visitor.validUntil) < now) {\n        await storage.createAccessLog({\n          visitorId: visitor.id,\n          securityPersonnelId: userId,\n          accessType: \"visitor\",\n          name: visitor.visitorName,\n          action: \"denied\",\n          notes: \"Expired access code\",\n        });\n\n        return res.json({ valid: false, reason: \"Access code expired\" });\n      }\n\n      // Check if already used\n      if (visitor.status === \"used\") {\n        return res.json({ valid: false, reason: \"Access code already used\" });\n      }\n\n      // Check if not yet valid\n      if (new Date(visitor.validFrom) > now) {\n        return res.json({ valid: false, reason: \"Access code not yet valid\" });\n      }\n\n      // Get resident info\n      const resident = await storage.getResident(visitor.residentId);\n\n      // Mark visitor as used\n      await storage.updateVisitorStatus(visitor.id, \"used\", now);\n\n      // Log successful entry\n      await storage.createAccessLog({\n        visitorId: visitor.id,\n        residentId: visitor.residentId,\n        securityPersonnelId: userId,\n        accessType: \"visitor\",\n        name: visitor.visitorName,\n        action: \"entry\",\n        notes: `Visiting Unit ${resident?.unitNumber || \"Unknown\"}`,\n      });\n\n      // Notify resident\n      if (resident) {\n        const residentUser = await storage.getUser(resident.userId);\n        if (residentUser) {\n          await storage.createNotification({\n            userId: residentUser.id,\n            title: \"Visitor Arrived\",\n            message: `${visitor.visitorName} has checked in at the gate`,\n            type: \"visitor\",\n            isRead: false,\n          });\n        }\n      }\n\n      res.json({ \n        valid: true, \n        visitor,\n        unitNumber: resident?.unitNumber \n      });\n    } catch (error) {\n      console.error(\"Error verifying access code:\", error);\n      res.status(500).json({ message: \"Failed to verify access\" });\n    }\n  });\n\n  // ========== ACCOUNTING ROUTES (ACCOUNTANT ROLE) ==========\n\n  // Chart of Accounts endpoints\n  \n  // Get all accounts\n  app.get('/api/accountant/accounts', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"accountant\" && user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Accountant access required\" });\n      }\n\n      const accounts = await storage.getAllAccounts();\n      res.json(accounts);\n    } catch (error) {\n      console.error(\"Error fetching accounts:\", error);\n      res.status(500).json({ message: \"Failed to fetch accounts\" });\n    }\n  });\n\n  // Get account by ID\n  app.get('/api/accountant/accounts/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"accountant\" && user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Accountant access required\" });\n      }\n\n      const { id } = req.params;\n      const account = await storage.getAccount(id);\n      \n      if (!account) {\n        return res.status(404).json({ message: \"Account not found\" });\n      }\n\n      res.json(account);\n    } catch (error) {\n      console.error(\"Error fetching account:\", error);\n      res.status(500).json({ message: \"Failed to fetch account\" });\n    }\n  });\n\n  // Create account\n  app.post('/api/accountant/accounts', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"accountant\" && user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Accountant access required\" });\n      }\n\n      const validation = insertAccountSchema.safeParse(req.body);\n      if (!validation.success) {\n        const error = fromZodError(validation.error);\n        return res.status(400).json({ message: error.message });\n      }\n\n      const account = await storage.createAccount(validation.data);\n      res.json(account);\n    } catch (error: any) {\n      console.error(\"Error creating account:\", error);\n      if (error.code === '23505') {\n        return res.status(400).json({ message: \"Account number already exists\" });\n      }\n      res.status(500).json({ message: \"Failed to create account\" });\n    }\n  });\n\n  // Update account\n  app.patch('/api/accountant/accounts/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"accountant\" && user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Accountant access required\" });\n      }\n\n      const validation = insertAccountSchema.partial().safeParse(req.body);\n      if (!validation.success) {\n        const error = fromZodError(validation.error);\n        return res.status(400).json({ message: error.message });\n      }\n\n      const { id } = req.params;\n      const account = await storage.updateAccount(id, validation.data);\n      res.json(account);\n    } catch (error: any) {\n      console.error(\"Error updating account:\", error);\n      if (error.code === '23505') {\n        return res.status(400).json({ message: \"Account number already exists\" });\n      }\n      res.status(500).json({ message: \"Failed to update account\" });\n    }\n  });\n\n  // Delete account\n  app.delete('/api/accountant/accounts/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"accountant\" && user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Accountant access required\" });\n      }\n\n      const { id } = req.params;\n      await storage.deleteAccount(id);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting account:\", error);\n      res.status(500).json({ message: \"Failed to delete account\" });\n    }\n  });\n\n  // Transaction Template endpoints\n\n  // Get all transaction templates\n  app.get('/api/accountant/templates', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"accountant\" && user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Accountant access required\" });\n      }\n\n      const templates = await storage.getAllTransactionTemplates();\n      res.json(templates);\n    } catch (error) {\n      console.error(\"Error fetching templates:\", error);\n      res.status(500).json({ message: \"Failed to fetch templates\" });\n    }\n  });\n\n  // Get template by ID\n  app.get('/api/accountant/templates/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"accountant\" && user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Accountant access required\" });\n      }\n\n      const { id } = req.params;\n      const template = await storage.getTransactionTemplate(id);\n      \n      if (!template) {\n        return res.status(404).json({ message: \"Template not found\" });\n      }\n\n      res.json(template);\n    } catch (error) {\n      console.error(\"Error fetching template:\", error);\n      res.status(500).json({ message: \"Failed to fetch template\" });\n    }\n  });\n\n  // Create transaction template\n  app.post('/api/accountant/templates', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"accountant\" && user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Accountant access required\" });\n      }\n\n      const validation = insertTransactionTemplateSchema.safeParse(req.body);\n      if (!validation.success) {\n        const error = fromZodError(validation.error);\n        return res.status(400).json({ message: error.message });\n      }\n\n      const template = await storage.createTransactionTemplate(validation.data);\n      res.json(template);\n    } catch (error: any) {\n      console.error(\"Error creating template:\", error);\n      if (error.code === '23505') {\n        return res.status(400).json({ message: \"Template name already exists\" });\n      }\n      res.status(500).json({ message: \"Failed to create template\" });\n    }\n  });\n\n  // Update transaction template\n  app.patch('/api/accountant/templates/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"accountant\" && user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Accountant access required\" });\n      }\n\n      const validation = insertTransactionTemplateSchema.partial().safeParse(req.body);\n      if (!validation.success) {\n        const error = fromZodError(validation.error);\n        return res.status(400).json({ message: error.message });\n      }\n\n      const { id } = req.params;\n      const template = await storage.updateTransactionTemplate(id, validation.data);\n      res.json(template);\n    } catch (error: any) {\n      console.error(\"Error updating template:\", error);\n      if (error.code === '23505') {\n        return res.status(400).json({ message: \"Template name already exists\" });\n      }\n      res.status(500).json({ message: \"Failed to update template\" });\n    }\n  });\n\n  // Delete transaction template\n  app.delete('/api/accountant/templates/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"accountant\" && user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Accountant access required\" });\n      }\n\n      const { id } = req.params;\n      await storage.deleteTransactionTemplate(id);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting template:\", error);\n      res.status(500).json({ message: \"Failed to delete template\" });\n    }\n  });\n\n  // Journal Entry endpoints\n\n  // Get all journal entries\n  app.get('/api/accountant/entries', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"accountant\" && user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Accountant access required\" });\n      }\n\n      const entries = await storage.getAllJournalEntries();\n      res.json(entries);\n    } catch (error) {\n      console.error(\"Error fetching journal entries:\", error);\n      res.status(500).json({ message: \"Failed to fetch journal entries\" });\n    }\n  });\n\n  // Get journal entry by ID with lines\n  app.get('/api/accountant/entries/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"accountant\" && user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Accountant access required\" });\n      }\n\n      const { id } = req.params;\n      const entry = await storage.getJournalEntryWithLines(id);\n      \n      if (!entry) {\n        return res.status(404).json({ message: \"Journal entry not found\" });\n      }\n\n      res.json(entry);\n    } catch (error) {\n      console.error(\"Error fetching journal entry:\", error);\n      res.status(500).json({ message: \"Failed to fetch journal entry\" });\n    }\n  });\n\n  // Create journal entry\n  app.post('/api/accountant/entries', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"accountant\" && user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Accountant access required\" });\n      }\n\n      const { entry, lines } = req.body;\n\n      // Validate entry\n      const entryValidation = insertJournalEntrySchema.safeParse(entry);\n      if (!entryValidation.success) {\n        const error = fromZodError(entryValidation.error);\n        return res.status(400).json({ message: `Entry validation failed: ${error.message}` });\n      }\n\n      // Validate lines\n      if (!Array.isArray(lines) || lines.length === 0) {\n        return res.status(400).json({ message: \"At least one journal entry line is required\" });\n      }\n\n      const validatedLines = [];\n      for (const line of lines) {\n        const lineValidation = insertJournalEntryLineSchema.safeParse(line);\n        if (!lineValidation.success) {\n          const error = fromZodError(lineValidation.error);\n          return res.status(400).json({ message: `Line validation failed: ${error.message}` });\n        }\n        validatedLines.push(lineValidation.data);\n      }\n      \n      // Validate that debits equal credits\n      const totalDebit = validatedLines\n        .filter((l: any) => l.lineType === 'debit')\n        .reduce((sum: number, l: any) => sum + parseFloat(l.amount), 0);\n      \n      const totalCredit = validatedLines\n        .filter((l: any) => l.lineType === 'credit')\n        .reduce((sum: number, l: any) => sum + parseFloat(l.amount), 0);\n\n      if (Math.abs(totalDebit - totalCredit) > 0.01) {\n        return res.status(400).json({ \n          message: \"Debits and credits must be equal\",\n          totalDebit,\n          totalCredit\n        });\n      }\n\n      // Set created by\n      entryValidation.data.createdBy = user.id;\n      entryValidation.data.totalDebit = totalDebit.toFixed(2);\n      entryValidation.data.totalCredit = totalCredit.toFixed(2);\n\n      const journalEntry = await storage.createJournalEntry(entryValidation.data, validatedLines);\n      const fullEntry = await storage.getJournalEntryWithLines(journalEntry.id);\n      res.json(fullEntry);\n    } catch (error) {\n      console.error(\"Error creating journal entry:\", error);\n      res.status(500).json({ message: \"Failed to create journal entry\" });\n    }\n  });\n\n  // Void journal entry\n  app.patch('/api/accountant/entries/:id/void', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"accountant\" && user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Accountant access required\" });\n      }\n\n      const { id } = req.params;\n      await storage.voidJournalEntry(id);\n      const entry = await storage.getJournalEntryWithLines(id);\n      res.json(entry);\n    } catch (error) {\n      console.error(\"Error voiding journal entry:\", error);\n      res.status(500).json({ message: \"Failed to void journal entry\" });\n    }\n  });\n\n  // Reverse a journal entry\n  app.post('/api/accountant/entries/:id/reverse', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"accountant\" && user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Accountant access required\" });\n      }\n\n      const { id } = req.params;\n      \n      // Get the original entry with lines\n      const originalEntry = await storage.getJournalEntryWithLines(id);\n      if (!originalEntry) {\n        return res.status(404).json({ message: \"Journal entry not found\" });\n      }\n\n      if (originalEntry.status !== \"posted\") {\n        return res.status(400).json({ message: \"Only posted entries can be reversed\" });\n      }\n\n      // Check if this entry has already been reversed\n      const existingReversals = await storage.getJournalEntriesByReferenceId(id);\n      if (existingReversals && existingReversals.length > 0) {\n        return res.status(400).json({ \n          message: \"This journal entry has already been reversed\",\n          existingReversals\n        });\n      }\n\n      // Create reversal entry with opposite debits/credits\n      const reversalLines = originalEntry.lines.map((line: any) => ({\n        accountId: line.accountId,\n        lineType: line.lineType === \"debit\" ? \"credit\" : \"debit\",\n        amount: parseFloat(line.amount),\n        description: line.description,\n      }));\n\n      // Recompute totals from the reversal lines\n      const totalDebit = reversalLines\n        .filter((l: any) => l.lineType === \"debit\")\n        .reduce((sum: number, l: any) => sum + l.amount, 0);\n      \n      const totalCredit = reversalLines\n        .filter((l: any) => l.lineType === \"credit\")\n        .reduce((sum: number, l: any) => sum + l.amount, 0);\n\n      const reversalEntry = {\n        entryDate: new Date(),\n        description: `Reversal of ${originalEntry.entryNumber} - ${originalEntry.description}`,\n        referenceType: 'reversal',\n        referenceId: originalEntry.id,\n        createdBy: userId,\n        status: 'posted' as const,\n        totalDebit: totalDebit.toFixed(2),\n        totalCredit: totalCredit.toFixed(2),\n      };\n\n      const newEntry = await storage.createJournalEntry(reversalEntry, reversalLines);\n      const fullEntry = await storage.getJournalEntryWithLines(newEntry.id);\n      \n      res.json(fullEntry);\n    } catch (error: any) {\n      console.error(\"Error reversing journal entry:\", error);\n      res.status(500).json({ message: error.message || \"Failed to reverse journal entry\" });\n    }\n  });\n\n  // ========== FINANCIAL REPORTS ==========\n\n  // Get Trial Balance\n  app.get('/api/accountant/reports/trial-balance', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"accountant\" && user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Accountant access required\" });\n      }\n\n      const asOf = req.query.asOf ? new Date(req.query.asOf as string) : new Date();\n      const trialBalance = await storage.getTrialBalance(asOf);\n      res.json(trialBalance);\n    } catch (error) {\n      console.error(\"Error generating trial balance:\", error);\n      res.status(500).json({ message: \"Failed to generate trial balance\" });\n    }\n  });\n\n  // Get Income Statement\n  app.get('/api/accountant/reports/income-statement', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"accountant\" && user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Accountant access required\" });\n      }\n\n      const startDate = req.query.startDate ? new Date(req.query.startDate as string) : new Date(new Date().getFullYear(), 0, 1);\n      const endDate = req.query.endDate ? new Date(req.query.endDate as string) : new Date();\n      \n      const incomeStatement = await storage.getIncomeStatement(startDate, endDate);\n      res.json(incomeStatement);\n    } catch (error) {\n      console.error(\"Error generating income statement:\", error);\n      res.status(500).json({ message: \"Failed to generate income statement\" });\n    }\n  });\n\n  // Get Balance Sheet\n  app.get('/api/accountant/reports/balance-sheet', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"accountant\" && user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Accountant access required\" });\n      }\n\n      const asOf = req.query.asOf ? new Date(req.query.asOf as string) : new Date();\n      const balanceSheet = await storage.getBalanceSheet(asOf);\n      res.json(balanceSheet);\n    } catch (error) {\n      console.error(\"Error generating balance sheet:\", error);\n      res.status(500).json({ message: \"Failed to generate balance sheet\" });\n    }\n  });\n\n  // ========== VENDOR ROUTES (ACCOUNTANT ROLE) ==========\n  \n  // Get all vendors\n  app.get('/api/accountant/vendors', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"accountant\" && user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Accountant access required\" });\n      }\n\n      const vendors = await storage.getAllVendors();\n      res.json(vendors);\n    } catch (error) {\n      console.error(\"Error fetching vendors:\", error);\n      res.status(500).json({ message: \"Failed to fetch vendors\" });\n    }\n  });\n\n  // Get vendors by status (pending, approved, rejected)\n  app.get('/api/accountant/vendors/status/:status', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"accountant\" && user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Accountant access required\" });\n      }\n\n      const { status } = req.params;\n      const vendors = await storage.getVendorsByStatus(status);\n      res.json(vendors);\n    } catch (error) {\n      console.error(\"Error fetching vendors by status:\", error);\n      res.status(500).json({ message: \"Failed to fetch vendors\" });\n    }\n  });\n\n  // Get single vendor\n  app.get('/api/accountant/vendors/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"accountant\" && user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Accountant access required\" });\n      }\n\n      const { id } = req.params;\n      const vendor = await storage.getVendor(id);\n      \n      if (!vendor) {\n        return res.status(404).json({ message: \"Vendor not found\" });\n      }\n\n      res.json(vendor);\n    } catch (error) {\n      console.error(\"Error fetching vendor:\", error);\n      res.status(500).json({ message: \"Failed to fetch vendor\" });\n    }\n  });\n\n  // Create new vendor\n  app.post('/api/accountant/vendors', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"accountant\" && user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Accountant access required\" });\n      }\n\n      const validation = insertVendorSchema.safeParse(req.body);\n      if (!validation.success) {\n        const error = fromZodError(validation.error);\n        return res.status(400).json({ message: error.message });\n      }\n\n      const vendor = await storage.createVendor(validation.data);\n      res.json(vendor);\n    } catch (error: any) {\n      console.error(\"Error creating vendor:\", error);\n      if (error.code === '23505') {\n        return res.status(400).json({ message: \"TIN number already exists\" });\n      }\n      res.status(500).json({ message: \"Failed to create vendor\" });\n    }\n  });\n\n  // Update vendor\n  app.patch('/api/accountant/vendors/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"accountant\" && user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Accountant access required\" });\n      }\n\n      const { id } = req.params;\n      const vendor = await storage.updateVendor(id, req.body);\n      res.json(vendor);\n    } catch (error) {\n      console.error(\"Error updating vendor:\", error);\n      res.status(500).json({ message: \"Failed to update vendor\" });\n    }\n  });\n\n  // Approve vendor\n  app.post('/api/accountant/vendors/:id/approve', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"accountant\" && user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Accountant access required\" });\n      }\n\n      const { id } = req.params;\n      const vendor = await storage.approveVendor(id, userId);\n      res.json(vendor);\n    } catch (error) {\n      console.error(\"Error approving vendor:\", error);\n      res.status(500).json({ message: \"Failed to approve vendor\" });\n    }\n  });\n\n  // Reject vendor\n  app.post('/api/accountant/vendors/:id/reject', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"accountant\" && user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Accountant access required\" });\n      }\n\n      const { id } = req.params;\n      const { reason } = req.body;\n      \n      if (!reason) {\n        return res.status(400).json({ message: \"Rejection reason is required\" });\n      }\n\n      const vendor = await storage.rejectVendor(id, userId, reason);\n      res.json(vendor);\n    } catch (error) {\n      console.error(\"Error rejecting vendor:\", error);\n      res.status(500).json({ message: \"Failed to reject vendor\" });\n    }\n  });\n\n  // Get vendor account statement\n  app.get('/api/accountant/vendors/:id/statement', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"accountant\" && user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Accountant access required\" });\n      }\n\n      const { id } = req.params;\n      const startDate = req.query.startDate ? new Date(req.query.startDate as string) : undefined;\n      const endDate = req.query.endDate ? new Date(req.query.endDate as string) : undefined;\n\n      const statement = await storage.getVendorAccountStatement(id, startDate, endDate);\n      res.json(statement);\n    } catch (error: any) {\n      console.error(\"Error generating vendor statement:\", error);\n      if (error.message === 'Vendor not found') {\n        return res.status(404).json({ message: error.message });\n      }\n      res.status(500).json({ message: \"Failed to generate vendor statement\" });\n    }\n  });\n\n  // Get outstanding bills for all vendors\n  app.get('/api/accountant/vendors/outstanding-bills', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"accountant\" && user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Accountant access required\" });\n      }\n\n      const outstandingBills = await storage.getVendorOutstandingBills();\n      res.json(outstandingBills);\n    } catch (error) {\n      console.error(\"Error fetching vendor outstanding bills:\", error);\n      res.status(500).json({ message: \"Failed to fetch outstanding bills\" });\n    }\n  });\n\n  // ========== EXPENSE ROUTES ==========\n  \n  // Get all expenses (accountant/admin only)\n  app.get('/api/accountant/expenses', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"accountant\" && user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Accountant access required\" });\n      }\n\n      const expenses = await storage.getAllExpenses();\n      res.json(expenses);\n    } catch (error) {\n      console.error(\"Error fetching expenses:\", error);\n      res.status(500).json({ message: \"Failed to fetch expenses\" });\n    }\n  });\n\n  // Get current user's expenses\n  app.get('/api/expenses/my-expenses', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const expenses = await storage.getExpensesBySubmitter(userId);\n      res.json(expenses);\n    } catch (error) {\n      console.error(\"Error fetching user expenses:\", error);\n      res.status(500).json({ message: \"Failed to fetch your expenses\" });\n    }\n  });\n\n  // Create new expense\n  app.post('/api/expenses', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      \n      const validation = insertExpenseSchema.safeParse({\n        ...req.body,\n        submittedBy: userId,\n      });\n      \n      if (!validation.success) {\n        const error = fromZodError(validation.error);\n        return res.status(400).json({ message: error.message });\n      }\n\n      const expense = await storage.createExpense(validation.data);\n      \n      // Create notification for accountants\n      // TODO: Implement notification system for expense submissions\n      \n      res.json(expense);\n    } catch (error: any) {\n      console.error(\"Error creating expense:\", error);\n      res.status(500).json({ message: \"Failed to create expense\" });\n    }\n  });\n\n  // Approve expense (accountant/admin only)\n  app.post('/api/accountant/expenses/:id/approve', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"accountant\" && user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Accountant access required\" });\n      }\n\n      const { id } = req.params;\n      const expense = await storage.approveExpense(id, userId);\n      res.json(expense);\n    } catch (error) {\n      console.error(\"Error approving expense:\", error);\n      res.status(500).json({ message: \"Failed to approve expense\" });\n    }\n  });\n\n  // Reject expense (accountant/admin only)\n  app.post('/api/accountant/expenses/:id/reject', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"accountant\" && user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Accountant access required\" });\n      }\n\n      const { id } = req.params;\n      const { reason } = req.body;\n      \n      if (!reason) {\n        return res.status(400).json({ message: \"Rejection reason is required\" });\n      }\n\n      const expense = await storage.rejectExpense(id, userId, reason);\n      res.json(expense);\n    } catch (error) {\n      console.error(\"Error rejecting expense:\", error);\n      res.status(500).json({ message: \"Failed to reject expense\" });\n    }\n  });\n\n  // ========== ACCOUNTS PAYABLE ROUTES ==========\n\n  // Get all approved expenses for payment (accountant/admin only)\n  app.get('/api/accountant/accounts-payable', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"accountant\" && user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Accountant access required\" });\n      }\n\n      const expenses = await storage.getApprovedExpensesForPayment();\n      res.json(expenses);\n    } catch (error) {\n      console.error(\"Error fetching accounts payable:\", error);\n      res.status(500).json({ message: \"Failed to fetch accounts payable\" });\n    }\n  });\n\n  // Get bank accounts for payment (accountant/admin only)\n  app.get('/api/accountant/bank-accounts', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"accountant\" && user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Accountant access required\" });\n      }\n\n      const bankAccounts = await storage.getBankAccounts();\n      res.json(bankAccounts);\n    } catch (error) {\n      console.error(\"Error fetching bank accounts:\", error);\n      res.status(500).json({ message: \"Failed to fetch bank accounts\" });\n    }\n  });\n\n  // Process expense payment (accountant/admin only)\n  app.post('/api/accountant/accounts-payable/:id/pay-now', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"accountant\" && user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Accountant access required\" });\n      }\n\n      const { id } = req.params;\n      \n      // Validate request body with Zod\n      const validation = payNowSchema.safeParse(req.body);\n      if (!validation.success) {\n        return res.status(400).json({ \n          message: fromZodError(validation.error).message \n        });\n      }\n      \n      const { paidFromAccountId, whtRate } = validation.data;\n      \n      // Verify bank account exists and is valid\n      const bankAccount = await storage.getAccount(paidFromAccountId);\n      if (!bankAccount) {\n        return res.status(400).json({ message: \"Invalid bank account selected\" });\n      }\n      \n      if (bankAccount.accountType !== 'asset' || \n          !['Cash and Bank', 'Cash', 'Bank'].includes(bankAccount.category || '')) {\n        return res.status(400).json({ message: \"Selected account is not a valid bank account\" });\n      }\n\n      const expense = await storage.processExpensePayment(id, paidFromAccountId, userId, whtRate);\n      res.json(expense);\n    } catch (error: any) {\n      console.error(\"Error processing payment:\", error);\n      res.status(500).json({ message: error.message || \"Failed to process payment\" });\n    }\n  });\n\n  // Approve expense for payment later (accountant/admin only)\n  app.post('/api/accountant/accounts-payable/:id/pay-later', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"accountant\" && user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Accountant access required\" });\n      }\n\n      const { id } = req.params;\n      \n      // Validate request body with Zod\n      const validation = payLaterSchema.safeParse(req.body);\n      if (!validation.success) {\n        return res.status(400).json({ \n          message: fromZodError(validation.error).message \n        });\n      }\n      \n      const { whtRate } = validation.data;\n\n      const expense = await storage.approveExpenseForPaymentLater(id, userId, whtRate);\n      res.json(expense);\n    } catch (error: any) {\n      console.error(\"Error approving for payment later:\", error);\n      res.status(500).json({ message: error.message || \"Failed to approve for payment later\" });\n    }\n  });\n\n  // ========== ACCOUNTS RECEIVABLE ROUTES ==========\n\n  // Get all AR entries (accountant/admin only)\n  app.get('/api/accountant/accounts-receivable', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"accountant\" && user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Accountant access required\" });\n      }\n\n      const entries = await storage.getAllAREntries();\n      res.json(entries);\n    } catch (error) {\n      console.error(\"Error fetching AR entries:\", error);\n      res.status(500).json({ message: \"Failed to fetch AR entries\" });\n    }\n  });\n\n  // Get single AR entry with details (accountant/admin only)\n  app.get('/api/accountant/accounts-receivable/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"accountant\" && user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Accountant access required\" });\n      }\n\n      const { id } = req.params;\n      const entry = await storage.getAREntry(id);\n      \n      if (!entry) {\n        return res.status(404).json({ message: \"AR entry not found\" });\n      }\n      \n      res.json(entry);\n    } catch (error) {\n      console.error(\"Error fetching AR entry:\", error);\n      res.status(500).json({ message: \"Failed to fetch AR entry\" });\n    }\n  });\n\n  // Mark AR entry as paid (manual payment application)\n  app.post('/api/accountant/accounts-receivable/:id/mark-paid', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"accountant\" && user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Accountant access required\" });\n      }\n\n      const { id } = req.params;\n      const { amountApplied, bankName, accountNumber, paymentDate, notes } = req.body;\n\n      // Validate required fields\n      if (!amountApplied || !bankName || !accountNumber || !paymentDate) {\n        return res.status(400).json({ \n          message: \"Missing required fields: amountApplied, bankName, accountNumber, paymentDate\" \n        });\n      }\n\n      await storage.applyPaymentToBill(\n        id,\n        amountApplied,\n        'manual',\n        new Date(paymentDate),\n        userId,\n        bankName,\n        accountNumber,\n        undefined,\n        notes\n      );\n\n      res.json({ message: \"Payment applied successfully\" });\n    } catch (error: any) {\n      console.error(\"Error applying payment:\", error);\n      res.status(500).json({ message: error.message || \"Failed to apply payment\" });\n    }\n  });\n\n  // Upload bank statement\n  app.post('/api/accountant/bank-statements/upload', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"accountant\" && user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Accountant access required\" });\n      }\n\n      const { fileName, fileData, bankName, accountNumber, statementDate, entries } = req.body;\n\n      // Validate required fields\n      if (!fileName || !fileData || !bankName || !accountNumber || !statementDate) {\n        return res.status(400).json({ \n          message: \"Missing required fields: fileName, fileData, bankName, accountNumber, statementDate\" \n        });\n      }\n\n      // Create bank statement\n      const statement = await storage.createBankStatement({\n        fileName,\n        fileData,\n        bankName,\n        accountNumber,\n        statementDate: new Date(statementDate),\n        uploadedBy: userId,\n        totalEntries: entries?.length || 0,\n        totalAmount: entries?.reduce((sum: number, e: any) => sum + parseFloat(e.amount || '0'), 0).toFixed(2) || '0',\n        status: 'processing',\n      });\n\n      // Create notification: reconciliation started\n      await storage.createNotification({\n        userId,\n        title: 'Bank Statement Uploaded',\n        message: `Statement uploaded: ${fileName}. Payment reconciliation started for ${entries?.length || 0} entries.`,\n        type: 'system',\n      });\n\n      // Reconciliation summary\n      const reconciliationSummary = {\n        totalEntries: 0,\n        matched: 0,\n        partiallyMatched: 0,\n        unmatched: 0,\n        totalMatched: '0.00',\n        residualAmounts: [] as any[],\n        details: [] as any[],\n      };\n\n      // Create entries and attempt automatic reconciliation within a transaction\n      if (entries && Array.isArray(entries)) {\n        reconciliationSummary.totalEntries = entries.length;\n\n        for (const entry of entries) {\n          try {\n            // Wrap each entry reconciliation in a transaction for atomicity\n            await db.transaction(async (tx) => {\n              // Create bank statement entry\n              const [createdEntry] = await tx.insert(bankStatementEntries).values({\n                statementId: statement.id,\n                transactionDate: new Date(entry.transactionDate),\n                description: entry.description,\n                referenceNumber: entry.referenceNumber,\n                amount: entry.amount,\n                appliedAmount: '0',\n                remainingAmount: entry.amount,\n                status: 'unmatched',\n              }).returning();\n\n              // Attempt automatic matching by invoice number\n              if (entry.referenceNumber) {\n                console.log(`[Bank Recon] Processing entry with ref: ${entry.referenceNumber}, amount: ${entry.amount}`);\n                \n                // Look for bill with matching invoice number (get FRESH data for accurate balance)\n                const matchingBills = await tx\n                  .select()\n                  .from(bills)\n                  .where(eq(bills.invoiceNumber, entry.referenceNumber));\n\n                console.log(`[Bank Recon] Found ${matchingBills.length} matching bills for ${entry.referenceNumber}`);\n\n                if (matchingBills.length > 0) {\n                  let bill = matchingBills[0];\n                  const entryAmount = parseFloat(entry.amount);\n                  let billBalance = parseFloat(bill.balance);\n\n                  console.log(`[Bank Recon] Bill ${bill.invoiceNumber}: balance=${billBalance}, entry amount=${entryAmount}`);\n\n                  // Determine amount to apply (minimum of entry amount and bill balance)\n                  const amountToApply = Math.min(entryAmount, billBalance);\n\n                  console.log(`[Bank Recon] Amount to apply: ${amountToApply}`);\n\n                  if (amountToApply > 0) {\n                    // INLINE payment application within transaction for atomicity\n                    // Step 1: Create payment application record\n                    await tx.insert(paymentApplications).values({\n                      billId: bill.id,\n                      bankStatementEntryId: createdEntry.id,\n                      amountApplied: amountToApply.toFixed(2),\n                      applicationType: 'bank_statement',\n                      bankName,\n                      accountNumber,\n                      paymentDate: new Date(entry.transactionDate),\n                      appliedBy: userId,\n                      notes: `Auto-reconciled from bank statement: ${fileName}`,\n                    });\n\n                    // Step 2: Update bill totals and status\n                    const newTotalPaid = parseFloat(bill.totalPaid) + amountToApply;\n                    const newBalance = billBalance - amountToApply;\n                    const newPaymentStatus = newBalance === 0 ? 'full_payment' : 'partial_payment';\n                    const newBillStatus = newBalance === 0 ? 'paid' : (newBalance < billBalance ? 'partial' : bill.status);\n\n                    await tx\n                      .update(bills)\n                      .set({\n                        totalPaid: newTotalPaid.toFixed(2),\n                        balance: newBalance.toFixed(2),\n                        paymentStatus: newPaymentStatus,\n                        status: newBillStatus,\n                        updatedAt: new Date(),\n                      })\n                      .where(eq(bills.id, bill.id));\n\n                    // Update local bill state for potential subsequent matches in same batch\n                    bill = {\n                      ...bill,\n                      totalPaid: newTotalPaid.toFixed(2),\n                      balance: newBalance.toFixed(2),\n                      paymentStatus: newPaymentStatus,\n                      status: newBillStatus,\n                    };\n                    billBalance = newBalance;\n\n                    // Step 3: Create GL posting for Modified Cash-Based Accounting\n                    // DR Cash/Bank, CR AR, DR Deferred Revenue, CR Member Dues\n                    const arAccount = await tx\n                      .select()\n                      .from(accounts)\n                      .where(eq(accounts.accountNumber, '1100'))\n                      .limit(1);\n\n                    if (!arAccount || arAccount.length === 0) {\n                      throw new Error('Accounts Receivable account (1100) not found');\n                    }\n                    \n                    const deferredRevenueAccount = await tx\n                      .select()\n                      .from(accounts)\n                      .where(eq(accounts.accountNumber, '2200'))\n                      .limit(1);\n                    \n                    if (!deferredRevenueAccount || deferredRevenueAccount.length === 0) {\n                      throw new Error('Deferred Revenue account (2200) not found');\n                    }\n                    \n                    const memberDuesAccount = await tx\n                      .select()\n                      .from(accounts)\n                      .where(eq(accounts.accountNumber, '4000'))\n                      .limit(1);\n                    \n                    if (!memberDuesAccount || memberDuesAccount.length === 0) {\n                      throw new Error('Member Dues revenue account (4000) not found');\n                    }\n\n                    // Find or use default cash/bank account\n                    const bankAccounts = await tx\n                      .select()\n                      .from(accounts)\n                      .where(and(\n                        eq(accounts.accountType, 'asset'),\n                        eq(accounts.category, 'Cash and Bank')\n                      ));\n\n                    let cashAccountId = bankAccounts[0]?.id;\n                    if (bankName) {\n                      const matchedBank = bankAccounts.find(acc => \n                        acc.accountName.toLowerCase().includes(bankName.toLowerCase())\n                      );\n                      if (matchedBank) cashAccountId = matchedBank.id;\n                    }\n\n                    if (!cashAccountId) {\n                      throw new Error('No cash/bank account found for payment posting');\n                    }\n\n                    // Generate entry number for the journal entry\n                    const entryDate = new Date(entry.transactionDate);\n                    const dateStr = entryDate.toISOString().split('T')[0].replace(/-/g, '');\n                    const entryCount = await tx\n                      .select({ count: sql<number>`count(*)` })\n                      .from(journalEntries)\n                      .where(sql`DATE(entry_date) = DATE(${entryDate})`);\n                    const sequenceNumber = (entryCount[0]?.count || 0) + 1;\n                    const entryNumber = `JE-${dateStr}-${sequenceNumber.toString().padStart(4, '0')}`;\n\n                    // Create journal entry for the payment (4-line entry for modified cash accounting)\n                    const totalAmount = (amountToApply * 2).toFixed(2); // DR Cash + DR Deferred = CR AR + CR Revenue\n                    const [journalEntry] = await tx.insert(journalEntries).values({\n                      entryNumber,\n                      entryDate,\n                      description: `Payment received: ${entry.description}`,\n                      referenceNumber: entry.referenceNumber || undefined,\n                      totalDebit: totalAmount,\n                      totalCredit: totalAmount,\n                      createdBy: userId,\n                    }).returning();\n\n                    // Insert journal entry lines (4-line entry to recognize revenue)\n                    await tx.insert(journalEntryLines).values([\n                      {\n                        journalEntryId: journalEntry.id,\n                        accountId: cashAccountId,\n                        lineType: 'debit',\n                        amount: amountToApply.toFixed(2),\n                        description: `Payment from ${bankName || 'bank'} - ${accountNumber || 'statement'}`,\n                      },\n                      {\n                        journalEntryId: journalEntry.id,\n                        accountId: arAccount[0].id,\n                        lineType: 'credit',\n                        amount: amountToApply.toFixed(2),\n                        description: `Payment for invoice ${bill.invoiceNumber} - reduce AR`,\n                      },\n                      {\n                        journalEntryId: journalEntry.id,\n                        accountId: deferredRevenueAccount[0].id,\n                        lineType: 'debit',\n                        amount: amountToApply.toFixed(2),\n                        description: `Relieve deferred revenue for ${bill.invoiceNumber}`,\n                      },\n                      {\n                        journalEntryId: journalEntry.id,\n                        accountId: memberDuesAccount[0].id,\n                        lineType: 'credit',\n                        amount: amountToApply.toFixed(2),\n                        description: `Revenue recognized for ${bill.invoiceNumber}`,\n                      },\n                    ]);\n\n                    // Step 4: Update entry status and residuals\n                    const newRemaining = entryAmount - amountToApply;\n                    const newStatus = newRemaining === 0 ? 'reconciled' : 'partially_matched';\n\n                    console.log(`[Bank Recon] Updating entry status to: ${newStatus}, applied: ${amountToApply}, remaining: ${newRemaining}`);\n\n                    await tx\n                      .update(bankStatementEntries)\n                      .set({\n                        appliedAmount: amountToApply.toFixed(2),\n                        remainingAmount: newRemaining.toFixed(2),\n                        status: newStatus,\n                      })\n                      .where(eq(bankStatementEntries.id, createdEntry.id));\n\n                    console.log(`[Bank Recon] Entry status updated successfully to: ${newStatus}`);\n\n                    // Step 5: Update summary (AFTER all GL posting succeeds)\n                    if (newStatus === 'reconciled') {\n                      reconciliationSummary.matched++;\n                    } else {\n                      reconciliationSummary.partiallyMatched++;\n                      // Track residual amount for manual review with full context\n                      reconciliationSummary.residualAmounts.push({\n                        entryId: createdEntry.id,\n                        entryRef: entry.referenceNumber,\n                        billId: bill.id,\n                        invoiceNumber: bill.invoiceNumber,\n                        residentId: bill.residentId,\n                        entryAmount: entryAmount,\n                        appliedAmount: amountToApply,\n                        residualAmount: newRemaining,\n                        description: entry.description,\n                      });\n                    }\n                    reconciliationSummary.totalMatched = (parseFloat(reconciliationSummary.totalMatched) + amountToApply).toFixed(2);\n\n                    reconciliationSummary.details.push({\n                      entryRef: entry.referenceNumber,\n                      invoiceNumber: bill.invoiceNumber,\n                      amount: amountToApply,\n                      residual: newRemaining > 0 ? newRemaining : 0,\n                      status: newStatus,\n                    });\n                  } else {\n                    console.log(`[Bank Recon] Amount to apply is 0, marking as unmatched`);\n                    reconciliationSummary.unmatched++;\n                  }\n                } else {\n                  console.log(`[Bank Recon] No matching bills found for ${entry.referenceNumber}`);\n                  reconciliationSummary.unmatched++;\n                }\n              } else {\n                console.log(`[Bank Recon] No reference number provided, marking as unmatched`);\n                reconciliationSummary.unmatched++;\n              }\n            });\n          } catch (matchError) {\n            console.error(`Error matching entry ${entry.referenceNumber}:`, matchError);\n            reconciliationSummary.unmatched++;\n            // Transaction will have rolled back, entry not created\n          }\n        }\n      }\n\n      // Update statement status\n      await db\n        .update(bankStatements)\n        .set({ status: 'completed' })\n        .where(eq(bankStatements.id, statement.id));\n\n      // Create completion notification\n      await storage.createNotification({\n        userId,\n        title: 'Payment Reconciliation Completed',\n        message: `Bank statement reconciliation completed. Matched: ${reconciliationSummary.matched}, Partially Matched: ${reconciliationSummary.partiallyMatched}, Unmatched: ${reconciliationSummary.unmatched}. Total amount reconciled: ₦${parseFloat(reconciliationSummary.totalMatched).toLocaleString('en-NG', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}.`,\n        type: 'payment',\n      });\n\n      res.json({\n        statement,\n        reconciliation: reconciliationSummary,\n      });\n    } catch (error: any) {\n      console.error(\"Error uploading bank statement:\", error);\n      res.status(500).json({ message: error.message || \"Failed to upload bank statement\" });\n    }\n  });\n\n  // Get all bank statements\n  app.get('/api/accountant/bank-statements', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"accountant\" && user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Accountant access required\" });\n      }\n\n      const statements = await storage.getAllBankStatements();\n      res.json(statements);\n    } catch (error) {\n      console.error(\"Error fetching bank statements:\", error);\n      res.status(500).json({ message: \"Failed to fetch bank statements\" });\n    }\n  });\n\n  // Get bank statement entries\n  app.get('/api/accountant/bank-statements/:id/entries', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"accountant\" && user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Accountant access required\" });\n      }\n\n      const { id } = req.params;\n      const entries = await storage.getBankStatementEntries(id);\n      res.json(entries);\n    } catch (error) {\n      console.error(\"Error fetching bank statement entries:\", error);\n      res.status(500).json({ message: \"Failed to fetch bank statement entries\" });\n    }\n  });\n\n  // Reconcile bank statement entry to bill\n  app.post('/api/accountant/bank-statements/reconcile', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"accountant\" && user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Accountant access required\" });\n      }\n\n      const { entryId, billId, amountApplied } = req.body;\n\n      // Validate required fields\n      if (!entryId || !billId || !amountApplied) {\n        return res.status(400).json({ \n          message: \"Missing required fields: entryId, billId, amountApplied\" \n        });\n      }\n\n      // Get the entry to fetch bank details\n      const entries = await storage.getBankStatementEntries('');\n      const entry = entries.find((e: any) => e.id === entryId);\n      \n      if (!entry) {\n        return res.status(404).json({ message: \"Bank statement entry not found\" });\n      }\n\n      // Apply payment to bill\n      await storage.applyPaymentToBill(\n        billId,\n        amountApplied,\n        'bank_statement',\n        entry.transactionDate,\n        userId,\n        entry.bankName,\n        entry.accountNumber,\n        entryId,\n        `Reconciled from bank statement entry: ${entry.description}`\n      );\n\n      // Update entry status and amounts\n      const newApplied = parseFloat(entry.appliedAmount || '0') + parseFloat(amountApplied);\n      const newRemaining = parseFloat(entry.amount) - newApplied;\n      const newStatus = newRemaining === 0 ? 'reconciled' : 'partially_matched';\n\n      await db\n        .update(bankStatementEntries)\n        .set({\n          appliedAmount: newApplied.toFixed(2),\n          remainingAmount: newRemaining.toFixed(2),\n          status: newStatus,\n        })\n        .where(eq(bankStatementEntries.id, entryId));\n\n      res.json({ message: \"Payment reconciled successfully\" });\n    } catch (error: any) {\n      console.error(\"Error reconciling payment:\", error);\n      res.status(500).json({ message: error.message || \"Failed to reconcile payment\" });\n    }\n  });\n\n  // ========== BUDGET ROUTES ==========\n\n  // Get all budgets (accountant/admin only)\n  app.get('/api/accountant/budgets', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"accountant\" && user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Accountant access required\" });\n      }\n\n      const budgets = await storage.getAllBudgets();\n      res.json(budgets);\n    } catch (error) {\n      console.error(\"Error fetching budgets:\", error);\n      res.status(500).json({ message: \"Failed to fetch budgets\" });\n    }\n  });\n\n  // Get active budgets (accountant/admin only)\n  app.get('/api/accountant/budgets/active', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"accountant\" && user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Accountant access required\" });\n      }\n\n      const budgets = await storage.getActiveBudgets();\n      res.json(budgets);\n    } catch (error) {\n      console.error(\"Error fetching active budgets:\", error);\n      res.status(500).json({ message: \"Failed to fetch active budgets\" });\n    }\n  });\n\n  // Get budget by ID with lines (accountant/admin only)\n  app.get('/api/accountant/budgets/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"accountant\" && user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Accountant access required\" });\n      }\n\n      const { id } = req.params;\n      const budget = await storage.getBudgetWithLines(id);\n      \n      if (!budget) {\n        return res.status(404).json({ message: \"Budget not found\" });\n      }\n      \n      res.json(budget);\n    } catch (error) {\n      console.error(\"Error fetching budget:\", error);\n      res.status(500).json({ message: \"Failed to fetch budget\" });\n    }\n  });\n\n  // Create new budget (accountant/admin only)\n  app.post('/api/accountant/budgets', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"accountant\" && user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Accountant access required\" });\n      }\n\n      const { budget, lines } = req.body;\n      \n      if (!budget || !lines || lines.length === 0) {\n        return res.status(400).json({ message: \"Budget data and at least one line item are required\" });\n      }\n\n      // Convert date strings to Date objects and add createdBy\n      const budgetData = {\n        ...budget,\n        startDate: new Date(budget.startDate),\n        endDate: new Date(budget.endDate),\n        createdBy: userId,\n      };\n\n      const newBudget = await storage.createBudget(budgetData, lines);\n      res.json(newBudget);\n    } catch (error) {\n      console.error(\"Error creating budget:\", error);\n      res.status(500).json({ message: \"Failed to create budget\" });\n    }\n  });\n\n  // Update budget (accountant/admin only)\n  app.patch('/api/accountant/budgets/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"accountant\" && user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Accountant access required\" });\n      }\n\n      const { id } = req.params;\n      const updatedBudget = await storage.updateBudget(id, req.body);\n      res.json(updatedBudget);\n    } catch (error) {\n      console.error(\"Error updating budget:\", error);\n      res.status(500).json({ message: \"Failed to update budget\" });\n    }\n  });\n\n  // Delete budget (accountant/admin only)\n  app.delete('/api/accountant/budgets/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"accountant\" && user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Accountant access required\" });\n      }\n\n      const { id } = req.params;\n      await storage.deleteBudget(id);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting budget:\", error);\n      res.status(500).json({ message: \"Failed to delete budget\" });\n    }\n  });\n\n  // Activate budget (accountant/admin only)\n  app.post('/api/accountant/budgets/:id/activate', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"accountant\" && user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Accountant access required\" });\n      }\n\n      const { id } = req.params;\n      const budget = await storage.activateBudget(id);\n      res.json(budget);\n    } catch (error) {\n      console.error(\"Error activating budget:\", error);\n      res.status(500).json({ message: \"Failed to activate budget\" });\n    }\n  });\n\n  // Close budget (accountant/admin only)\n  app.post('/api/accountant/budgets/:id/close', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"accountant\" && user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Accountant access required\" });\n      }\n\n      const { id } = req.params;\n      const budget = await storage.closeBudget(id);\n      res.json(budget);\n    } catch (error) {\n      console.error(\"Error closing budget:\", error);\n      res.status(500).json({ message: \"Failed to close budget\" });\n    }\n  });\n\n  // Get active budget for an account (accountant/admin only)\n  app.get('/api/accountant/budgets/account/:accountId', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await storage.getUser(userId);\n      \n      if (user?.role !== \"accountant\" && user?.role !== \"admin\") {\n        return res.status(403).json({ message: \"Accountant access required\" });\n      }\n\n      const { accountId } = req.params;\n      const budgetLine = await storage.getActiveBudgetForAccount(accountId);\n      res.json(budgetLine);\n    } catch (error) {\n      console.error(\"Error fetching budget for account:\", error);\n      res.status(500).json({ message: \"Failed to fetch budget for account\" });\n    }\n  });\n\n  // ========== NOTIFICATION ROUTES ==========\n  \n  // Get user notifications\n  app.get('/api/notifications', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const notifications = await storage.getNotificationsByUserId(userId);\n      res.json(notifications);\n    } catch (error) {\n      console.error(\"Error fetching notifications:\", error);\n      res.status(500).json({ message: \"Failed to fetch notifications\" });\n    }\n  });\n\n  // Mark notification as read\n  app.patch('/api/notifications/:id/read', isAuthenticated, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      await storage.markNotificationAsRead(id);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error marking notification as read:\", error);\n      res.status(500).json({ message: \"Failed to update notification\" });\n    }\n  });\n\n  // Mark all notifications as read\n  app.patch('/api/notifications/read-all', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      await storage.markAllNotificationsAsRead(userId);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error marking all as read:\", error);\n      res.status(500).json({ message: \"Failed to update notifications\" });\n    }\n  });\n\n  const httpServer = createServer(app);\n  return httpServer;\n}\n","size_bytes":145750},"server/db.ts":{"content":"import { Pool, neonConfig } from '@neondatabase/serverless';\nimport { drizzle } from 'drizzle-orm/neon-serverless';\nimport ws from \"ws\";\nimport * as schema from \"@shared/schema\";\n\nneonConfig.webSocketConstructor = ws;\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\n    \"DATABASE_URL must be set. Did you forget to provision a database?\",\n  );\n}\n\nexport const pool = new Pool({ connectionString: process.env.DATABASE_URL });\nexport const db = drizzle({ client: pool, schema });\n","size_bytes":483},"client/src/pages/security-logs.tsx":{"content":"import { useEffect } from \"react\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Shield, ArrowRight, ArrowLeft, XCircle } from \"lucide-react\";\nimport type { AccessLog } from \"@shared/schema\";\n\nexport default function SecurityLogs() {\n  const { toast } = useToast();\n  const { isAuthenticated, isLoading, user } = useAuth();\n\n  useEffect(() => {\n    if (!isLoading && (!isAuthenticated || user?.role !== \"security\")) {\n      toast({\n        title: \"Unauthorized\",\n        description: \"Security access required\",\n        variant: \"destructive\",\n      });\n      setTimeout(() => {\n        window.location.href = \"/\";\n      }, 500);\n      return;\n    }\n  }, [isAuthenticated, isLoading, user, toast]);\n\n  const { data: logs = [] } = useQuery<AccessLog[]>({\n    queryKey: [\"/api/security/logs/recent\"],\n    enabled: isAuthenticated && user?.role === \"security\",\n  });\n\n  if (isLoading || !isAuthenticated || user?.role !== \"security\") {\n    return (\n      <div className=\"flex h-screen items-center justify-center\">\n        <div className=\"animate-spin w-8 h-8 border-4 border-primary border-t-transparent rounded-full\" />\n      </div>\n    );\n  }\n\n  const getActionBadge = (action: string) => {\n    const variants = {\n      entry: { variant: \"default\" as const, icon: ArrowRight, className: \"bg-green-500 hover:bg-green-600\" },\n      exit: { variant: \"secondary\" as const, icon: ArrowLeft, className: \"\" },\n      denied: { variant: \"destructive\" as const, icon: XCircle, className: \"\" },\n    };\n    const config = variants[action as keyof typeof variants] || variants.entry;\n    const Icon = config.icon;\n    \n    return (\n      <Badge variant={config.variant} className={config.className}>\n        <Icon className=\"h-3 w-3 mr-1\" />\n        {action}\n      </Badge>\n    );\n  };\n\n  const getAccessTypeBadge = (type: string) => {\n    const colors = {\n      visitor: \"bg-blue-500 hover:bg-blue-600\",\n      resident: \"bg-purple-500 hover:bg-purple-600\",\n      manual: \"bg-gray-500 hover:bg-gray-600\",\n    };\n    return (\n      <Badge className={colors[type as keyof typeof colors] || colors.manual}>\n        {type}\n      </Badge>\n    );\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Header */}\n      <div>\n        <h1 className=\"text-3xl font-semibold\">Access Logs</h1>\n        <p className=\"text-muted-foreground mt-1\">Complete gate activity history</p>\n      </div>\n\n      {/* Stats */}\n      <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <div className=\"text-sm font-medium\">Total Entries</div>\n            <ArrowRight className=\"h-4 w-4 text-green-500\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-semibold\" data-testid=\"text-total-entries\">\n              {logs.filter(l => l.action === \"entry\").length}\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <div className=\"text-sm font-medium\">Total Exits</div>\n            <ArrowLeft className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-semibold\" data-testid=\"text-total-exits\">\n              {logs.filter(l => l.action === \"exit\").length}\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <div className=\"text-sm font-medium\">Denied Access</div>\n            <XCircle className=\"h-4 w-4 text-destructive\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-semibold text-destructive\" data-testid=\"text-denied\">\n              {logs.filter(l => l.action === \"denied\").length}\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Logs Table */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Complete Access History</CardTitle>\n          <CardDescription>All gate activity records</CardDescription>\n        </CardHeader>\n        <CardContent>\n          {logs.length === 0 ? (\n            <div className=\"text-center py-12 text-muted-foreground\">\n              <Shield className=\"h-16 w-16 mx-auto mb-4 opacity-50\" />\n              <p className=\"text-lg\">No access logs</p>\n              <p className=\"text-sm mt-1\">Gate activity will appear here</p>\n            </div>\n          ) : (\n            <div className=\"space-y-3\">\n              {logs.map((log) => (\n                <div\n                  key={log.id}\n                  className=\"flex items-center justify-between p-4 rounded-lg border hover-elevate\"\n                  data-testid={`log-${log.id}`}\n                >\n                  <div className=\"flex-1\">\n                    <div className=\"flex items-center gap-3 mb-1\">\n                      <Shield className=\"h-4 w-4 text-muted-foreground\" />\n                      <h4 className=\"font-medium\">{log.name}</h4>\n                      {getAccessTypeBadge(log.accessType)}\n                    </div>\n                    <div className=\"flex items-center gap-4 text-sm text-muted-foreground\">\n                      <span>{new Date(log.createdAt!).toLocaleString()}</span>\n                      {log.notes && (\n                        <>\n                          <span>•</span>\n                          <span>{log.notes}</span>\n                        </>\n                      )}\n                    </div>\n                  </div>\n                  <div>\n                    {getActionBadge(log.action)}\n                  </div>\n                </div>\n              ))}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":6078},"client/src/pages/security-dashboard.tsx":{"content":"import { useEffect, useState } from \"react\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { QrCode, Search, Shield, Activity, CheckCircle, XCircle } from \"lucide-react\";\nimport { Link } from \"wouter\";\nimport type { Visitor, AccessLog } from \"@shared/schema\";\n\nexport default function SecurityDashboard() {\n  const { toast } = useToast();\n  const { isAuthenticated, isLoading, user } = useAuth();\n  const [searchTerm, setSearchTerm] = useState(\"\");\n\n  useEffect(() => {\n    if (!isLoading && (!isAuthenticated || user?.role !== \"security\")) {\n      toast({\n        title: \"Unauthorized\",\n        description: \"Security access required\",\n        variant: \"destructive\",\n      });\n      setTimeout(() => {\n        window.location.href = \"/\";\n      }, 500);\n      return;\n    }\n  }, [isAuthenticated, isLoading, user, toast]);\n\n  const { data: todayVisitors = [] } = useQuery<Visitor[]>({\n    queryKey: [\"/api/security/visitors/today\"],\n    enabled: isAuthenticated && user?.role === \"security\",\n  });\n\n  const { data: recentLogs = [] } = useQuery<AccessLog[]>({\n    queryKey: [\"/api/security/logs/recent\"],\n    enabled: isAuthenticated && user?.role === \"security\",\n  });\n\n  if (isLoading || !isAuthenticated || user?.role !== \"security\") {\n    return (\n      <div className=\"flex h-screen items-center justify-center\">\n        <div className=\"animate-spin w-8 h-8 border-4 border-primary border-t-transparent rounded-full\" />\n      </div>\n    );\n  }\n\n  const filteredVisitors = todayVisitors.filter(v =>\n    v.visitorName.toLowerCase().includes(searchTerm.toLowerCase()) ||\n    v.accessCode.toLowerCase().includes(searchTerm.toLowerCase())\n  );\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-semibold\">Security Dashboard</h1>\n          <p className=\"text-muted-foreground mt-1\">Gate access and visitor management</p>\n        </div>\n        <Link href=\"/security/scan\">\n          <Button size=\"lg\" data-testid=\"button-scan-qr\">\n            <QrCode className=\"h-5 w-5 mr-2\" />\n            Scan QR Code\n          </Button>\n        </Link>\n      </div>\n\n      {/* Quick Stats */}\n      <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Today's Visitors</CardTitle>\n            <QrCode className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-3xl font-semibold\" data-testid=\"text-today-visitors\">\n              {todayVisitors.length}\n            </div>\n            <p className=\"text-xs text-muted-foreground mt-1\">\n              Pre-approved access codes\n            </p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Recent Entries</CardTitle>\n            <Activity className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-3xl font-semibold\" data-testid=\"text-recent-entries\">\n              {recentLogs.filter(l => l.action === \"entry\").length}\n            </div>\n            <p className=\"text-xs text-muted-foreground mt-1\">\n              Last 24 hours\n            </p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Access Logs</CardTitle>\n            <Shield className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-3xl font-semibold\" data-testid=\"text-total-logs\">\n              {recentLogs.length}\n            </div>\n            <p className=\"text-xs text-muted-foreground mt-1\">\n              Recent activity\n            </p>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Visitor Lookup */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Today's Approved Visitors</CardTitle>\n          <CardDescription>Search and verify visitor access codes</CardDescription>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div className=\"relative\">\n            <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n            <Input\n              placeholder=\"Search by name or access code...\"\n              value={searchTerm}\n              onChange={(e) => setSearchTerm(e.target.value)}\n              className=\"pl-10\"\n              data-testid=\"input-search-visitor\"\n            />\n          </div>\n\n          {filteredVisitors.length === 0 ? (\n            <div className=\"text-center py-8 text-muted-foreground\">\n              <QrCode className=\"h-12 w-12 mx-auto mb-3 opacity-50\" />\n              <p>No visitors found</p>\n            </div>\n          ) : (\n            <div className=\"space-y-3\">\n              {filteredVisitors.map((visitor) => (\n                <div\n                  key={visitor.id}\n                  className=\"flex items-center justify-between p-4 rounded-lg border hover-elevate\"\n                  data-testid={`visitor-${visitor.id}`}\n                >\n                  <div className=\"flex-1\">\n                    <h4 className=\"font-medium\">{visitor.visitorName}</h4>\n                    <p className=\"text-sm text-muted-foreground\">\n                      Code: {visitor.accessCode} • Valid until {new Date(visitor.validUntil).toLocaleString()}\n                    </p>\n                  </div>\n                  <div className=\"flex items-center gap-3\">\n                    {visitor.status === \"approved\" ? (\n                      <Badge className=\"bg-green-500 hover:bg-green-600\">\n                        <CheckCircle className=\"h-3 w-3 mr-1\" />\n                        Approved\n                      </Badge>\n                    ) : visitor.status === \"used\" ? (\n                      <Badge variant=\"secondary\">\n                        Used\n                      </Badge>\n                    ) : (\n                      <Badge variant=\"destructive\">\n                        <XCircle className=\"h-3 w-3 mr-1\" />\n                        {visitor.status}\n                      </Badge>\n                    )}\n                  </div>\n                </div>\n              ))}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Recent Access Log */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Recent Access Log</CardTitle>\n          <CardDescription>Latest gate activity</CardDescription>\n        </CardHeader>\n        <CardContent>\n          {recentLogs.length === 0 ? (\n            <div className=\"text-center py-8 text-muted-foreground\">\n              <Shield className=\"h-12 w-12 mx-auto mb-3 opacity-50\" />\n              <p>No recent activity</p>\n            </div>\n          ) : (\n            <div className=\"space-y-3\">\n              {recentLogs.slice(0, 10).map((log) => (\n                <div\n                  key={log.id}\n                  className=\"flex items-center justify-between p-3 rounded-lg border text-sm\"\n                  data-testid={`log-${log.id}`}\n                >\n                  <div className=\"flex-1\">\n                    <p className=\"font-medium\">{log.name}</p>\n                    <p className=\"text-muted-foreground\">\n                      {log.accessType} • {new Date(log.createdAt!).toLocaleString()}\n                    </p>\n                  </div>\n                  <Badge variant={log.action === \"entry\" ? \"default\" : log.action === \"exit\" ? \"secondary\" : \"destructive\"}>\n                    {log.action}\n                  </Badge>\n                </div>\n              ))}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":8340},"client/src/App.tsx":{"content":"import { Switch, Route, useLocation } from \"wouter\";\nimport { queryClient } from \"./lib/queryClient\";\nimport { QueryClientProvider, useQuery } from \"@tanstack/react-query\";\nimport { Toaster } from \"@/components/ui/toaster\";\nimport { TooltipProvider } from \"@/components/ui/tooltip\";\nimport { ThemeProvider } from \"@/components/theme-provider\";\nimport { ThemeToggle } from \"@/components/theme-toggle\";\nimport { SidebarProvider, SidebarTrigger } from \"@/components/ui/sidebar\";\nimport { AppSidebar } from \"@/components/app-sidebar\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useEffect } from \"react\";\nimport NotFound from \"@/pages/not-found\";\nimport Landing from \"@/pages/landing\";\nimport Signup from \"@/pages/signup\";\nimport Home from \"@/pages/home\";\nimport Bills from \"@/pages/bills\";\nimport Visitors from \"@/pages/visitors\";\nimport Notifications from \"@/pages/notifications\";\nimport AdminDashboard from \"@/pages/admin-dashboard\";\nimport AdminResidents from \"@/pages/admin/residents\";\nimport AdminResidentsList from \"@/pages/admin/residents-list\";\nimport AdminBilling from \"@/pages/admin/billing\";\nimport AdminAnnouncements from \"@/pages/admin/announcements\";\nimport AdminReports from \"@/pages/admin/reports\";\nimport AdminCollections from \"@/pages/admin/collections\";\nimport AdminSubscription from \"@/pages/admin/subscription\";\nimport AccountStatus from \"@/pages/admin/account-status\";\nimport AutomatedBilling from \"@/pages/admin/automated-billing\";\nimport ReportsCenter from \"@/pages/admin/reports-center\";\nimport SecurityDashboard from \"@/pages/security-dashboard\";\nimport QRScanner from \"@/pages/qr-scanner\";\nimport SecurityLogs from \"@/pages/security-logs\";\nimport AccountantDashboard from \"@/pages/accountant-dashboard\";\nimport ChartOfAccounts from \"@/pages/accountant/chart-of-accounts\";\nimport TransactionTemplates from \"@/pages/accountant/transaction-templates\";\nimport JournalEntries from \"@/pages/accountant/journal-entries\";\nimport VendorRegistration from \"@/pages/accountant/vendor-registration\";\nimport VendorApproval from \"@/pages/accountant/vendor-approval\";\nimport VendorManagement from \"@/pages/accountant/vendor-management\";\nimport VendorStatement from \"@/pages/accountant/vendor-statement\";\nimport ExpenseRequest from \"@/pages/accountant/expense-request\";\nimport ExpenseApproval from \"@/pages/accountant/expense-approval\";\nimport AccountsPayable from \"@/pages/accountant/accounts-payable\";\nimport AccountsReceivable from \"@/pages/accountant/accounts-receivable\";\nimport BankStatementUpload from \"@/pages/accountant/bank-statement-upload\";\nimport BudgetPlanning from \"@/pages/accountant/budget-planning\";\nimport MyExpenses from \"@/pages/my-expenses\";\nimport TrialBalance from \"@/pages/accountant/trial-balance\";\nimport IncomeStatement from \"@/pages/accountant/income-statement\";\nimport BalanceSheet from \"@/pages/accountant/balance-sheet\";\nimport UserManagement from \"@/pages/admin/user-management\";\nimport InviteLanding from \"@/pages/invite-landing\";\nimport type { Resident } from \"@shared/schema\";\n\nfunction Router() {\n  const { isAuthenticated, isLoading, user } = useAuth();\n\n  if (isLoading || !isAuthenticated) {\n    return (\n      <Switch>\n        <Route path=\"/\" component={Landing} />\n        <Route path=\"/invite/:token\" component={InviteLanding} />\n        <Route component={Landing} />\n      </Switch>\n    );\n  }\n\n  // Role-based routing\n  if (user?.role === \"admin\") {\n    return (\n      <Switch>\n        <Route path=\"/\" component={AdminDashboard} />\n        <Route path=\"/admin\" component={AdminDashboard} />\n        <Route path=\"/admin/residents/list\" component={AdminResidentsList} />\n        <Route path=\"/admin/residents\" component={AdminResidents} />\n        <Route path=\"/admin/billing\" component={AdminBilling} />\n        <Route path=\"/admin/billing/automated\" component={AutomatedBilling} />\n        <Route path=\"/admin/account-status\" component={AccountStatus} />\n        <Route path=\"/admin/announcements\" component={AdminAnnouncements} />\n        <Route path=\"/admin/collections\" component={AdminCollections} />\n        <Route path=\"/admin/subscription\" component={AdminSubscription} />\n        <Route path=\"/admin/reports-center\" component={ReportsCenter} />\n        <Route path=\"/admin/reports\" component={AdminReports} />\n        <Route path=\"/admin/user-management\" component={UserManagement} />\n        {/* Accounting Centre routes */}\n        <Route path=\"/accountant\" component={AccountantDashboard} />\n        <Route path=\"/accountant/accounts\" component={ChartOfAccounts} />\n        <Route path=\"/accountant/templates\" component={TransactionTemplates} />\n        <Route path=\"/accountant/entries\" component={JournalEntries} />\n        <Route path=\"/accountant/trial-balance\" component={TrialBalance} />\n        <Route path=\"/accountant/income-statement\" component={IncomeStatement} />\n        <Route path=\"/accountant/balance-sheet\" component={BalanceSheet} />\n        {/* Vendor routes */}\n        <Route path=\"/accountant/vendors/register\" component={VendorRegistration} />\n        <Route path=\"/accountant/vendors/approval\" component={VendorApproval} />\n        <Route path=\"/accountant/vendors/management\" component={VendorManagement} />\n        <Route path=\"/accountant/vendor-statement\" component={VendorStatement} />\n        {/* Expense routes */}\n        <Route path=\"/accountant/expenses/request\" component={ExpenseRequest} />\n        <Route path=\"/accountant/expenses/approval\" component={ExpenseApproval} />\n        <Route path=\"/accountant/accounts-payable\" component={AccountsPayable} />\n        <Route path=\"/accountant/accounts-receivable\" component={AccountsReceivable} />\n        <Route path=\"/accountant/bank-statements/upload\" component={BankStatementUpload} />\n        <Route path=\"/expenses\" component={MyExpenses} />\n        {/* Budget & Planning */}\n        <Route path=\"/accountant/budget-planning\" component={BudgetPlanning} />\n        {/* Notifications */}\n        <Route path=\"/notifications\" component={Notifications} />\n        <Route component={NotFound} />\n      </Switch>\n    );\n  }\n\n  if (user?.role === \"security\") {\n    return (\n      <Switch>\n        <Route path=\"/\" component={SecurityDashboard} />\n        <Route path=\"/security\" component={SecurityDashboard} />\n        <Route path=\"/security/scan\" component={QRScanner} />\n        <Route path=\"/security/logs\" component={SecurityLogs} />\n        <Route path=\"/notifications\" component={Notifications} />\n        <Route component={NotFound} />\n      </Switch>\n    );\n  }\n\n  if (user?.role === \"accountant\") {\n    return (\n      <Switch>\n        <Route path=\"/\" component={AccountantDashboard} />\n        <Route path=\"/accountant\" component={AccountantDashboard} />\n        <Route path=\"/accountant/accounts\" component={ChartOfAccounts} />\n        <Route path=\"/accountant/templates\" component={TransactionTemplates} />\n        <Route path=\"/accountant/entries\" component={JournalEntries} />\n        <Route path=\"/accountant/vendors/register\" component={VendorRegistration} />\n        <Route path=\"/accountant/vendors/approval\" component={VendorApproval} />\n        <Route path=\"/accountant/vendors/management\" component={VendorManagement} />\n        <Route path=\"/accountant/vendor-statement\" component={VendorStatement} />\n        <Route path=\"/accountant/expenses/request\" component={ExpenseRequest} />\n        <Route path=\"/accountant/expenses/approval\" component={ExpenseApproval} />\n        <Route path=\"/accountant/accounts-payable\" component={AccountsPayable} />\n        <Route path=\"/accountant/accounts-receivable\" component={AccountsReceivable} />\n        <Route path=\"/accountant/bank-statements/upload\" component={BankStatementUpload} />\n        <Route path=\"/expenses\" component={MyExpenses} />\n        <Route path=\"/accountant/budget-planning\" component={BudgetPlanning} />\n        <Route path=\"/accountant/trial-balance\" component={TrialBalance} />\n        <Route path=\"/accountant/income-statement\" component={IncomeStatement} />\n        <Route path=\"/accountant/balance-sheet\" component={BalanceSheet} />\n        <Route path=\"/notifications\" component={Notifications} />\n        <Route component={NotFound} />\n      </Switch>\n    );\n  }\n\n  // Default: Resident routes\n  return (\n    <Switch>\n      <Route path=\"/\" component={Home} />\n      <Route path=\"/bills\" component={Bills} />\n      <Route path=\"/expenses\" component={MyExpenses} />\n      <Route path=\"/visitors\" component={Visitors} />\n      <Route path=\"/notifications\" component={Notifications} />\n      <Route component={NotFound} />\n    </Switch>\n  );\n}\n\nfunction AppContent() {\n  const { isAuthenticated, isLoading, user } = useAuth();\n\n  // Check if resident profile exists (for signup gate)\n  const shouldCheckProfile = isAuthenticated && (user?.role === \"resident\" || !user?.role);\n  \n  const { data: residentProfile, isLoading: profileLoading, isError } = useQuery<Resident>({\n    queryKey: [\"/api/resident/profile\"],\n    enabled: shouldCheckProfile,\n    retry: false,\n    throwOnError: false,\n  });\n\n  // Determine if user needs signup BEFORE rendering protected layout\n  const needsSignup = isAuthenticated && \n    shouldCheckProfile &&\n    !profileLoading && \n    (isError || !residentProfile);\n\n  const sidebarStyle = {\n    \"--sidebar-width\": \"16rem\",\n    \"--sidebar-width-icon\": \"3rem\",\n  };\n\n  // Show landing page for unauthenticated users\n  if (isLoading || !isAuthenticated) {\n    return (\n      <>\n        <Router />\n        <Toaster />\n      </>\n    );\n  }\n\n  // Show loading while checking profile status\n  // This prevents TOCTOU gap where protected layout renders before profile check completes\n  if (profileLoading) {\n    return (\n      <div className=\"flex h-screen items-center justify-center\">\n        <div className=\"animate-spin w-8 h-8 border-4 border-primary border-t-transparent rounded-full\" />\n      </div>\n    );\n  }\n\n  // Show signup page BEFORE rendering protected layout\n  // This prevents TOCTOU gap where protected components render before redirect\n  if (needsSignup) {\n    return (\n      <>\n        <Signup />\n        <Toaster />\n      </>\n    );\n  }\n\n  // Only render protected layout after signup is complete\n  return (\n    <SidebarProvider style={sidebarStyle as React.CSSProperties}>\n      <div className=\"flex h-screen w-full\">\n        <AppSidebar />\n        <div className=\"flex flex-col flex-1 overflow-hidden\">\n          <header className=\"flex items-center justify-between px-6 py-3 border-b bg-background\">\n            <SidebarTrigger data-testid=\"button-sidebar-toggle\" />\n            <ThemeToggle />\n          </header>\n          <main className=\"flex-1 overflow-y-auto bg-background\">\n            <div className=\"container mx-auto px-6 py-8 max-w-7xl\">\n              <Router />\n            </div>\n          </main>\n        </div>\n      </div>\n      <Toaster />\n    </SidebarProvider>\n  );\n}\n\nexport default function App() {\n  return (\n    <QueryClientProvider client={queryClient}>\n      <ThemeProvider defaultTheme=\"light\">\n        <TooltipProvider>\n          <AppContent />\n        </TooltipProvider>\n      </ThemeProvider>\n    </QueryClientProvider>\n  );\n}\n","size_bytes":11138},"client/src/index.css":{"content":"@tailwind base;\n@tailwind components;\n@tailwind utilities;\n\n/* LIGHT MODE */\n:root {\n  --button-outline: rgba(0,0,0, .10);\n  --badge-outline: rgba(0,0,0, .05);\n  --opaque-button-border-intensity: -8;\n  --elevate-1: rgba(0,0,0, .03);\n  --elevate-2: rgba(0,0,0, .08);\n  --background: 0 0% 100%;\n  --foreground: 0 0% 10%;\n  --border: 0 0% 90%;\n  --card: 0 0% 98%;\n  --card-foreground: 0 0% 10%;\n  --card-border: 0 0% 94%;\n  --sidebar: 0 0% 96%;\n  --sidebar-foreground: 0 0% 10%;\n  --sidebar-border: 0 0% 92%;\n  --sidebar-primary: 210 85% 42%;\n  --sidebar-primary-foreground: 210 85% 98%;\n  --sidebar-accent: 210 6% 88%;\n  --sidebar-accent-foreground: 0 0% 10%;\n  --sidebar-ring: 210 85% 42%;\n  --popover: 0 0% 95%;\n  --popover-foreground: 0 0% 10%;\n  --popover-border: 0 0% 90%;\n  --primary: 210 85% 42%;\n  --primary-foreground: 210 85% 98%;\n  --secondary: 210 5% 90%;\n  --secondary-foreground: 210 5% 15%;\n  --muted: 210 4% 92%;\n  --muted-foreground: 210 4% 35%;\n  --accent: 210 8% 93%;\n  --accent-foreground: 210 8% 15%;\n  --destructive: 0 72% 45%;\n  --destructive-foreground: 0 72% 98%;\n  --input: 0 0% 75%;\n  --ring: 210 85% 42%;\n  --chart-1: 210 85% 42%;\n  --chart-2: 160 75% 38%;\n  --chart-3: 280 70% 45%;\n  --chart-4: 30 80% 48%;\n  --chart-5: 340 75% 45%;\n  --font-sans: Open Sans, sans-serif;\n  --font-serif: Georgia, serif;\n  --font-mono: Menlo, monospace;\n  --radius: .5rem;\n  --shadow-2xs: 0px 2px 0px 0px hsl(210 10% 23% / 0.00);\n  --shadow-xs: 0px 2px 0px 0px hsl(210 10% 23% / 0.00);\n  --shadow-sm: 0px 2px 0px 0px hsl(210 10% 23% / 0.00), 0px 1px 2px -1px hsl(210 10% 23% / 0.00);\n  --shadow: 0px 2px 0px 0px hsl(210 10% 23% / 0.00), 0px 1px 2px -1px hsl(210 10% 23% / 0.00);\n  --shadow-md: 0px 2px 0px 0px hsl(210 10% 23% / 0.00), 0px 2px 4px -1px hsl(210 10% 23% / 0.00);\n  --shadow-lg: 0px 2px 0px 0px hsl(210 10% 23% / 0.00), 0px 4px 6px -1px hsl(210 10% 23% / 0.00);\n  --shadow-xl: 0px 2px 0px 0px hsl(210 10% 23% / 0.00), 0px 8px 10px -1px hsl(210 10% 23% / 0.00);\n  --shadow-2xl: 0px 2px 0px 0px hsl(210 10% 23% / 0.00);\n  --tracking-normal: 0em;\n  --spacing: 0.25rem;\n\n/* Fallback for older browsers */\n  --sidebar-primary-border: hsl(var(--sidebar-primary));\n  --sidebar-primary-border: hsl(from hsl(var(--sidebar-primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --sidebar-accent-border: hsl(var(--sidebar-accent));\n  --sidebar-accent-border: hsl(from hsl(var(--sidebar-accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --primary-border: hsl(var(--primary));\n  --primary-border: hsl(from hsl(var(--primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --secondary-border: hsl(var(--secondary));\n  --secondary-border: hsl(from hsl(var(--secondary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --muted-border: hsl(var(--muted));\n  --muted-border: hsl(from hsl(var(--muted)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --accent-border: hsl(var(--accent));\n  --accent-border: hsl(from hsl(var(--accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --destructive-border: hsl(var(--destructive));\n  --destructive-border: hsl(from hsl(var(--destructive)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n}\n\n.dark {\n  --button-outline: rgba(255,255,255, .10);\n  --badge-outline: rgba(255,255,255, .05);\n  --opaque-button-border-intensity: 9;\n  --elevate-1: rgba(255,255,255, .04);\n  --elevate-2: rgba(255,255,255, .09);\n  --background: 0 0% 8%;\n  --foreground: 0 0% 95%;\n  --border: 0 0% 18%;\n  --card: 0 0% 10%;\n  --card-foreground: 0 0% 95%;\n  --card-border: 0 0% 14%;\n  --sidebar: 0 0% 12%;\n  --sidebar-foreground: 0 0% 95%;\n  --sidebar-border: 0 0% 16%;\n  --sidebar-primary: 210 85% 55%;\n  --sidebar-primary-foreground: 210 85% 98%;\n  --sidebar-accent: 210 5% 18%;\n  --sidebar-accent-foreground: 210 5% 95%;\n  --sidebar-ring: 210 85% 55%;\n  --popover: 0 0% 14%;\n  --popover-foreground: 0 0% 95%;\n  --popover-border: 0 0% 18%;\n  --primary: 210 85% 50%;\n  --primary-foreground: 210 85% 98%;\n  --secondary: 210 4% 20%;\n  --secondary-foreground: 210 4% 92%;\n  --muted: 210 3% 22%;\n  --muted-foreground: 210 3% 75%;\n  --accent: 210 6% 18%;\n  --accent-foreground: 210 6% 92%;\n  --destructive: 0 70% 48%;\n  --destructive-foreground: 0 70% 98%;\n  --input: 0 0% 35%;\n  --ring: 210 85% 55%;\n  --chart-1: 210 85% 65%;\n  --chart-2: 160 75% 60%;\n  --chart-3: 280 70% 68%;\n  --chart-4: 30 80% 62%;\n  --chart-5: 340 75% 65%;\n  --shadow-2xs: 0px 2px 0px 0px hsl(210 10% 5% / 0.00);\n  --shadow-xs: 0px 2px 0px 0px hsl(210 10% 5% / 0.00);\n  --shadow-sm: 0px 2px 0px 0px hsl(210 10% 5% / 0.00), 0px 1px 2px -1px hsl(210 10% 5% / 0.00);\n  --shadow: 0px 2px 0px 0px hsl(210 10% 5% / 0.00), 0px 1px 2px -1px hsl(210 10% 5% / 0.00);\n  --shadow-md: 0px 2px 0px 0px hsl(210 10% 5% / 0.00), 0px 2px 4px -1px hsl(210 10% 5% / 0.00);\n  --shadow-lg: 0px 2px 0px 0px hsl(210 10% 5% / 0.00), 0px 4px 6px -1px hsl(210 10% 5% / 0.00);\n  --shadow-xl: 0px 2px 0px 0px hsl(210 10% 5% / 0.00), 0px 8px 10px -1px hsl(210 10% 5% / 0.00);\n  --shadow-2xl: 0px 2px 0px 0px hsl(210 10% 5% / 0.00);\n\n/* Fallback for older browsers */\n  --sidebar-primary-border: hsl(var(--sidebar-primary));\n  --sidebar-primary-border: hsl(from hsl(var(--sidebar-primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --sidebar-accent-border: hsl(var(--sidebar-accent));\n  --sidebar-accent-border: hsl(from hsl(var(--sidebar-accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --primary-border: hsl(var(--primary));\n  --primary-border: hsl(from hsl(var(--primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --secondary-border: hsl(var(--secondary));\n  --secondary-border: hsl(from hsl(var(--secondary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --muted-border: hsl(var(--muted));\n  --muted-border: hsl(from hsl(var(--muted)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --accent-border: hsl(var(--accent));\n  --accent-border: hsl(from hsl(var(--accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --destructive-border: hsl(var(--destructive));\n  --destructive-border: hsl(from hsl(var(--destructive)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n}\n\n@layer base {\n  * {\n    @apply border-border;\n  }\n\n  body {\n    @apply font-sans antialiased bg-background text-foreground;\n  }\n}\n\n/**\n * Using the elevate system.\n * Automatic contrast adjustment.\n *\n * <element className=\"hover-elevate\" />\n * <element className=\"active-elevate-2\" />\n *\n * // Using the tailwind utility when a data attribute is \"on\"\n * <element className=\"toggle-elevate data-[state=on]:toggle-elevated\" />\n * // Or manually controlling the toggle state\n * <element className=\"toggle-elevate toggle-elevated\" />\n *\n * Elevation systems have to handle many states.\n * - not-hovered, vs. hovered vs. active  (three mutually exclusive states)\n * - toggled or not\n * - focused or not (this is not handled with these utilities)\n *\n * Even without handling focused or not, this is six possible combinations that\n * need to be distinguished from eachother visually.\n */\n@layer utilities {\n\n  /* Hide ugly search cancel button in Chrome until we can style it properly */\n  input[type=\"search\"]::-webkit-search-cancel-button {\n    @apply hidden;\n  }\n\n  /* Placeholder styling for contentEditable div */\n  [contenteditable][data-placeholder]:empty::before {\n    content: attr(data-placeholder);\n    color: hsl(var(--muted-foreground));\n    pointer-events: none;\n  }\n\n  /* .no-default-hover-elevate/no-default-active-elevate is an escape hatch so consumers of\n   * buttons/badges can remove the automatic brightness adjustment on interactions\n   * and program their own. */\n  .no-default-hover-elevate {}\n\n  .no-default-active-elevate {}\n\n\n  /**\n   * Toggleable backgrounds go behind the content. Hoverable/active goes on top.\n   * This way they can stack/compound. Both will overlap the parent's borders!\n   * So borders will be automatically adjusted both on toggle, and hover/active,\n   * and they will be compounded.\n   */\n  .toggle-elevate::before,\n  .toggle-elevate-2::before {\n    content: \"\";\n    pointer-events: none;\n    position: absolute;\n    inset: 0px;\n    /*border-radius: inherit;   match rounded corners */\n    border-radius: inherit;\n    z-index: -1;\n    /* sits behind content but above backdrop */\n  }\n\n  .toggle-elevate.toggle-elevated::before {\n    background-color: var(--elevate-2);\n  }\n\n  /* If there's a 1px border, adjust the inset so that it covers that parent's border */\n  .border.toggle-elevate::before {\n    inset: -1px;\n  }\n\n  /* Does not work on elements with overflow:hidden! */\n  .hover-elevate:not(.no-default-hover-elevate),\n  .active-elevate:not(.no-default-active-elevate),\n  .hover-elevate-2:not(.no-default-hover-elevate),\n  .active-elevate-2:not(.no-default-active-elevate) {\n    position: relative;\n    z-index: 0;\n  }\n\n  .hover-elevate:not(.no-default-hover-elevate)::after,\n  .active-elevate:not(.no-default-active-elevate)::after,\n  .hover-elevate-2:not(.no-default-hover-elevate)::after,\n  .active-elevate-2:not(.no-default-active-elevate)::after {\n    content: \"\";\n    pointer-events: none;\n    position: absolute;\n    inset: 0px;\n    /*border-radius: inherit;   match rounded corners */\n    border-radius: inherit;\n    z-index: 999;\n    /* sits in front of content */\n  }\n\n  .hover-elevate:hover:not(.no-default-hover-elevate)::after,\n  .active-elevate:active:not(.no-default-active-elevate)::after {\n    background-color: var(--elevate-1);\n  }\n\n  .hover-elevate-2:hover:not(.no-default-hover-elevate)::after,\n  .active-elevate-2:active:not(.no-default-active-elevate)::after {\n    background-color: var(--elevate-2);\n  }\n\n  /* If there's a 1px border, adjust the inset so that it covers that parent's border */\n  .border.hover-elevate:not(.no-hover-interaction-elevate)::after,\n  .border.active-elevate:not(.no-active-interaction-elevate)::after,\n  .border.hover-elevate-2:not(.no-hover-interaction-elevate)::after,\n  .border.active-elevate-2:not(.no-active-interaction-elevate)::after,\n  .border.hover-elevate:not(.no-hover-interaction-elevate)::after {\n    inset: -1px;\n  }\n}\n","size_bytes":10668},"client/src/components/ui/dialog.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as DialogPrimitive from \"@radix-ui/react-dialog\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Dialog = DialogPrimitive.Root\n\nconst DialogTrigger = DialogPrimitive.Trigger\n\nconst DialogPortal = DialogPrimitive.Portal\n\nconst DialogClose = DialogPrimitive.Close\n\nconst DialogOverlay = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Overlay\n    ref={ref}\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogOverlay.displayName = DialogPrimitive.Overlay.displayName\n\nconst DialogContent = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DialogPortal>\n    <DialogOverlay />\n    <DialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <DialogPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </DialogPrimitive.Close>\n    </DialogPrimitive.Content>\n  </DialogPortal>\n))\nDialogContent.displayName = DialogPrimitive.Content.displayName\n\nconst DialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-1.5 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogHeader.displayName = \"DialogHeader\"\n\nconst DialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogFooter.displayName = \"DialogFooter\"\n\nconst DialogTitle = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogTitle.displayName = DialogPrimitive.Title.displayName\n\nconst DialogDescription = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDialogDescription.displayName = DialogPrimitive.Description.displayName\n\nexport {\n  Dialog,\n  DialogPortal,\n  DialogOverlay,\n  DialogClose,\n  DialogTrigger,\n  DialogContent,\n  DialogHeader,\n  DialogFooter,\n  DialogTitle,\n  DialogDescription,\n}\n","size_bytes":3848},"client/src/components/ui/toaster.tsx":{"content":"import { useToast } from \"@/hooks/use-toast\"\nimport {\n  Toast,\n  ToastClose,\n  ToastDescription,\n  ToastProvider,\n  ToastTitle,\n  ToastViewport,\n} from \"@/components/ui/toast\"\n\nexport function Toaster() {\n  const { toasts } = useToast()\n\n  return (\n    <ToastProvider>\n      {toasts.map(function ({ id, title, description, action, ...props }) {\n        return (\n          <Toast key={id} {...props}>\n            <div className=\"grid gap-1\">\n              {title && <ToastTitle>{title}</ToastTitle>}\n              {description && (\n                <ToastDescription>{description}</ToastDescription>\n              )}\n            </div>\n            {action}\n            <ToastClose />\n          </Toast>\n        )\n      })}\n      <ToastViewport />\n    </ToastProvider>\n  )\n}\n","size_bytes":772},"client/src/components/ui/chart.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as RechartsPrimitive from \"recharts\"\n\nimport { cn } from \"@/lib/utils\"\n\n// Format: { THEME_NAME: CSS_SELECTOR }\nconst THEMES = { light: \"\", dark: \".dark\" } as const\n\nexport type ChartConfig = {\n  [k in string]: {\n    label?: React.ReactNode\n    icon?: React.ComponentType\n  } & (\n    | { color?: string; theme?: never }\n    | { color?: never; theme: Record<keyof typeof THEMES, string> }\n  )\n}\n\ntype ChartContextProps = {\n  config: ChartConfig\n}\n\nconst ChartContext = React.createContext<ChartContextProps | null>(null)\n\nfunction useChart() {\n  const context = React.useContext(ChartContext)\n\n  if (!context) {\n    throw new Error(\"useChart must be used within a <ChartContainer />\")\n  }\n\n  return context\n}\n\nconst ChartContainer = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    config: ChartConfig\n    children: React.ComponentProps<\n      typeof RechartsPrimitive.ResponsiveContainer\n    >[\"children\"]\n  }\n>(({ id, className, children, config, ...props }, ref) => {\n  const uniqueId = React.useId()\n  const chartId = `chart-${id || uniqueId.replace(/:/g, \"\")}`\n\n  return (\n    <ChartContext.Provider value={{ config }}>\n      <div\n        data-chart={chartId}\n        ref={ref}\n        className={cn(\n          \"flex aspect-video justify-center text-xs [&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-none [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-sector]:outline-none [&_.recharts-surface]:outline-none\",\n          className\n        )}\n        {...props}\n      >\n        <ChartStyle id={chartId} config={config} />\n        <RechartsPrimitive.ResponsiveContainer>\n          {children}\n        </RechartsPrimitive.ResponsiveContainer>\n      </div>\n    </ChartContext.Provider>\n  )\n})\nChartContainer.displayName = \"Chart\"\n\nconst ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {\n  const colorConfig = Object.entries(config).filter(\n    ([, config]) => config.theme || config.color\n  )\n\n  if (!colorConfig.length) {\n    return null\n  }\n\n  return (\n    <style\n      dangerouslySetInnerHTML={{\n        __html: Object.entries(THEMES)\n          .map(\n            ([theme, prefix]) => `\n${prefix} [data-chart=${id}] {\n${colorConfig\n  .map(([key, itemConfig]) => {\n    const color =\n      itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||\n      itemConfig.color\n    return color ? `  --color-${key}: ${color};` : null\n  })\n  .join(\"\\n\")}\n}\n`\n          )\n          .join(\"\\n\"),\n      }}\n    />\n  )\n}\n\nconst ChartTooltip = RechartsPrimitive.Tooltip\n\nconst ChartTooltipContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<typeof RechartsPrimitive.Tooltip> &\n    React.ComponentProps<\"div\"> & {\n      hideLabel?: boolean\n      hideIndicator?: boolean\n      indicator?: \"line\" | \"dot\" | \"dashed\"\n      nameKey?: string\n      labelKey?: string\n    }\n>(\n  (\n    {\n      active,\n      payload,\n      className,\n      indicator = \"dot\",\n      hideLabel = false,\n      hideIndicator = false,\n      label,\n      labelFormatter,\n      labelClassName,\n      formatter,\n      color,\n      nameKey,\n      labelKey,\n    },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    const tooltipLabel = React.useMemo(() => {\n      if (hideLabel || !payload?.length) {\n        return null\n      }\n\n      const [item] = payload\n      const key = `${labelKey || item?.dataKey || item?.name || \"value\"}`\n      const itemConfig = getPayloadConfigFromPayload(config, item, key)\n      const value =\n        !labelKey && typeof label === \"string\"\n          ? config[label as keyof typeof config]?.label || label\n          : itemConfig?.label\n\n      if (labelFormatter) {\n        return (\n          <div className={cn(\"font-medium\", labelClassName)}>\n            {labelFormatter(value, payload)}\n          </div>\n        )\n      }\n\n      if (!value) {\n        return null\n      }\n\n      return <div className={cn(\"font-medium\", labelClassName)}>{value}</div>\n    }, [\n      label,\n      labelFormatter,\n      payload,\n      hideLabel,\n      labelClassName,\n      config,\n      labelKey,\n    ])\n\n    if (!active || !payload?.length) {\n      return null\n    }\n\n    const nestLabel = payload.length === 1 && indicator !== \"dot\"\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"grid min-w-[8rem] items-start gap-1.5 rounded-lg border border-border/50 bg-background px-2.5 py-1.5 text-xs shadow-xl\",\n          className\n        )}\n      >\n        {!nestLabel ? tooltipLabel : null}\n        <div className=\"grid gap-1.5\">\n          {payload.map((item, index) => {\n            const key = `${nameKey || item.name || item.dataKey || \"value\"}`\n            const itemConfig = getPayloadConfigFromPayload(config, item, key)\n            const indicatorColor = color || item.payload.fill || item.color\n\n            return (\n              <div\n                key={item.dataKey}\n                className={cn(\n                  \"flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5 [&>svg]:text-muted-foreground\",\n                  indicator === \"dot\" && \"items-center\"\n                )}\n              >\n                {formatter && item?.value !== undefined && item.name ? (\n                  formatter(item.value, item.name, item, index, item.payload)\n                ) : (\n                  <>\n                    {itemConfig?.icon ? (\n                      <itemConfig.icon />\n                    ) : (\n                      !hideIndicator && (\n                        <div\n                          className={cn(\n                            \"shrink-0 rounded-[2px] border-[--color-border] bg-[--color-bg]\",\n                            {\n                              \"h-2.5 w-2.5\": indicator === \"dot\",\n                              \"w-1\": indicator === \"line\",\n                              \"w-0 border-[1.5px] border-dashed bg-transparent\":\n                                indicator === \"dashed\",\n                              \"my-0.5\": nestLabel && indicator === \"dashed\",\n                            }\n                          )}\n                          style={\n                            {\n                              \"--color-bg\": indicatorColor,\n                              \"--color-border\": indicatorColor,\n                            } as React.CSSProperties\n                          }\n                        />\n                      )\n                    )}\n                    <div\n                      className={cn(\n                        \"flex flex-1 justify-between leading-none\",\n                        nestLabel ? \"items-end\" : \"items-center\"\n                      )}\n                    >\n                      <div className=\"grid gap-1.5\">\n                        {nestLabel ? tooltipLabel : null}\n                        <span className=\"text-muted-foreground\">\n                          {itemConfig?.label || item.name}\n                        </span>\n                      </div>\n                      {item.value && (\n                        <span className=\"font-mono font-medium tabular-nums text-foreground\">\n                          {item.value.toLocaleString()}\n                        </span>\n                      )}\n                    </div>\n                  </>\n                )}\n              </div>\n            )\n          })}\n        </div>\n      </div>\n    )\n  }\n)\nChartTooltipContent.displayName = \"ChartTooltip\"\n\nconst ChartLegend = RechartsPrimitive.Legend\n\nconst ChartLegendContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> &\n    Pick<RechartsPrimitive.LegendProps, \"payload\" | \"verticalAlign\"> & {\n      hideIcon?: boolean\n      nameKey?: string\n    }\n>(\n  (\n    { className, hideIcon = false, payload, verticalAlign = \"bottom\", nameKey },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    if (!payload?.length) {\n      return null\n    }\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"flex items-center justify-center gap-4\",\n          verticalAlign === \"top\" ? \"pb-3\" : \"pt-3\",\n          className\n        )}\n      >\n        {payload.map((item) => {\n          const key = `${nameKey || item.dataKey || \"value\"}`\n          const itemConfig = getPayloadConfigFromPayload(config, item, key)\n\n          return (\n            <div\n              key={item.value}\n              className={cn(\n                \"flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3 [&>svg]:text-muted-foreground\"\n              )}\n            >\n              {itemConfig?.icon && !hideIcon ? (\n                <itemConfig.icon />\n              ) : (\n                <div\n                  className=\"h-2 w-2 shrink-0 rounded-[2px]\"\n                  style={{\n                    backgroundColor: item.color,\n                  }}\n                />\n              )}\n              {itemConfig?.label}\n            </div>\n          )\n        })}\n      </div>\n    )\n  }\n)\nChartLegendContent.displayName = \"ChartLegend\"\n\n// Helper to extract item config from a payload.\nfunction getPayloadConfigFromPayload(\n  config: ChartConfig,\n  payload: unknown,\n  key: string\n) {\n  if (typeof payload !== \"object\" || payload === null) {\n    return undefined\n  }\n\n  const payloadPayload =\n    \"payload\" in payload &&\n    typeof payload.payload === \"object\" &&\n    payload.payload !== null\n      ? payload.payload\n      : undefined\n\n  let configLabelKey: string = key\n\n  if (\n    key in payload &&\n    typeof payload[key as keyof typeof payload] === \"string\"\n  ) {\n    configLabelKey = payload[key as keyof typeof payload] as string\n  } else if (\n    payloadPayload &&\n    key in payloadPayload &&\n    typeof payloadPayload[key as keyof typeof payloadPayload] === \"string\"\n  ) {\n    configLabelKey = payloadPayload[\n      key as keyof typeof payloadPayload\n    ] as string\n  }\n\n  return configLabelKey in config\n    ? config[configLabelKey]\n    : config[key as keyof typeof config]\n}\n\nexport {\n  ChartContainer,\n  ChartTooltip,\n  ChartTooltipContent,\n  ChartLegend,\n  ChartLegendContent,\n  ChartStyle,\n}\n","size_bytes":10481},"client/src/components/ui/drawer.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Drawer as DrawerPrimitive } from \"vaul\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Drawer = ({\n  shouldScaleBackground = true,\n  ...props\n}: React.ComponentProps<typeof DrawerPrimitive.Root>) => (\n  <DrawerPrimitive.Root\n    shouldScaleBackground={shouldScaleBackground}\n    {...props}\n  />\n)\nDrawer.displayName = \"Drawer\"\n\nconst DrawerTrigger = DrawerPrimitive.Trigger\n\nconst DrawerPortal = DrawerPrimitive.Portal\n\nconst DrawerClose = DrawerPrimitive.Close\n\nconst DrawerOverlay = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Overlay\n    ref={ref}\n    className={cn(\"fixed inset-0 z-50 bg-black/80\", className)}\n    {...props}\n  />\n))\nDrawerOverlay.displayName = DrawerPrimitive.Overlay.displayName\n\nconst DrawerContent = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DrawerPortal>\n    <DrawerOverlay />\n    <DrawerPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed inset-x-0 bottom-0 z-50 mt-24 flex h-auto flex-col rounded-t-[10px] border bg-background\",\n        className\n      )}\n      {...props}\n    >\n      <div className=\"mx-auto mt-4 h-2 w-[100px] rounded-full bg-muted\" />\n      {children}\n    </DrawerPrimitive.Content>\n  </DrawerPortal>\n))\nDrawerContent.displayName = \"DrawerContent\"\n\nconst DrawerHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"grid gap-1.5 p-4 text-center sm:text-left\", className)}\n    {...props}\n  />\n)\nDrawerHeader.displayName = \"DrawerHeader\"\n\nconst DrawerFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"mt-auto flex flex-col gap-2 p-4\", className)}\n    {...props}\n  />\n)\nDrawerFooter.displayName = \"DrawerFooter\"\n\nconst DrawerTitle = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDrawerTitle.displayName = DrawerPrimitive.Title.displayName\n\nconst DrawerDescription = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDrawerDescription.displayName = DrawerPrimitive.Description.displayName\n\nexport {\n  Drawer,\n  DrawerPortal,\n  DrawerOverlay,\n  DrawerTrigger,\n  DrawerClose,\n  DrawerContent,\n  DrawerHeader,\n  DrawerFooter,\n  DrawerTitle,\n  DrawerDescription,\n}\n","size_bytes":3021},"client/src/pages/bills.tsx":{"content":"import { useEffect, useState } from \"react\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Receipt, Download, CheckCircle, Clock, AlertCircle } from \"lucide-react\";\nimport { formatNaira } from \"@/lib/currency\";\nimport type { Bill, Payment } from \"@shared/schema\";\n\nexport default function Bills() {\n  const { toast } = useToast();\n  const { isAuthenticated, isLoading } = useAuth();\n  const [downloadingBillId, setDownloadingBillId] = useState<string | null>(null);\n\n  useEffect(() => {\n    if (!isLoading && !isAuthenticated) {\n      toast({\n        title: \"Unauthorized\",\n        description: \"You are logged out. Logging in again...\",\n        variant: \"destructive\",\n      });\n      setTimeout(() => {\n        window.location.href = \"/api/login\";\n      }, 500);\n      return;\n    }\n  }, [isAuthenticated, isLoading, toast]);\n\n  const { data: bills = [] } = useQuery<Bill[]>({\n    queryKey: [\"/api/resident/bills\"],\n    enabled: isAuthenticated,\n  });\n\n  const { data: payments = [] } = useQuery<Payment[]>({\n    queryKey: [\"/api/resident/payments\"],\n    enabled: isAuthenticated,\n  });\n\n  if (isLoading || !isAuthenticated) {\n    return (\n      <div className=\"flex h-screen items-center justify-center\">\n        <div className=\"animate-spin w-8 h-8 border-4 border-primary border-t-transparent rounded-full\" />\n      </div>\n    );\n  }\n\n  const getStatusBadge = (status: string) => {\n    const variants = {\n      paid: { variant: \"default\" as const, icon: CheckCircle, className: \"bg-green-500 hover:bg-green-600\" },\n      pending: { variant: \"secondary\" as const, icon: Clock, className: \"bg-yellow-500 hover:bg-yellow-600\" },\n      overdue: { variant: \"destructive\" as const, icon: AlertCircle, className: \"\" },\n    };\n    const config = variants[status as keyof typeof variants] || variants.pending;\n    const Icon = config.icon;\n    \n    return (\n      <Badge variant={config.variant} className={config.className}>\n        <Icon className=\"h-3 w-3 mr-1\" />\n        {status}\n      </Badge>\n    );\n  };\n\n  const handleDownloadInvoice = async (billId: string, invoiceNumber: string) => {\n    try {\n      setDownloadingBillId(billId);\n\n      const response = await fetch(`/api/resident/bills/${billId}/pdf`, {\n        credentials: 'include',\n      });\n\n      if (!response.ok) {\n        throw new Error('Failed to download invoice');\n      }\n\n      const blob = await response.blob();\n      const url = window.URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      a.href = url;\n      a.download = `Invoice-${invoiceNumber || billId}.pdf`;\n      document.body.appendChild(a);\n      a.click();\n      window.URL.revokeObjectURL(url);\n      document.body.removeChild(a);\n\n      toast({\n        title: \"Success\",\n        description: \"Invoice downloaded successfully\",\n      });\n    } catch (error) {\n      console.error(\"Error downloading invoice:\", error);\n      toast({\n        title: \"Error\",\n        description: \"Failed to download invoice. Please try again.\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setDownloadingBillId(null);\n    }\n  };\n\n  const totalPaid = payments\n    .filter(p => p.status === \"completed\")\n    .reduce((sum, p) => sum + parseFloat(p.amount), 0);\n\n  const totalPending = bills\n    .filter(b => b.status !== \"paid\")\n    .reduce((sum, b) => sum + parseFloat(b.amount), 0);\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Header */}\n      <div>\n        <h1 className=\"text-3xl font-semibold\">My Bills</h1>\n        <p className=\"text-muted-foreground mt-1\">View and manage your levy payments</p>\n      </div>\n\n      {/* Summary Cards */}\n      <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Total Paid</CardTitle>\n            <CheckCircle className=\"h-4 w-4 text-green-500\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-semibold text-green-600\" data-testid=\"text-total-paid\">\n              {formatNaira(totalPaid)}\n            </div>\n            <p className=\"text-xs text-muted-foreground mt-1\">All time</p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Pending Balance</CardTitle>\n            <Clock className=\"h-4 w-4 text-yellow-500\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-semibold text-yellow-600\" data-testid=\"text-total-pending\">\n              {formatNaira(totalPending)}\n            </div>\n            <p className=\"text-xs text-muted-foreground mt-1\">Outstanding amount</p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Total Bills</CardTitle>\n            <Receipt className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-semibold\" data-testid=\"text-total-bills\">\n              {bills.length}\n            </div>\n            <p className=\"text-xs text-muted-foreground mt-1\">All statements</p>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Bills List */}\n      <Card>\n        <CardHeader>\n          <CardTitle>All Bills</CardTitle>\n          <CardDescription>Complete billing history</CardDescription>\n        </CardHeader>\n        <CardContent>\n          {bills.length === 0 ? (\n            <div className=\"text-center py-12 text-muted-foreground\">\n              <Receipt className=\"h-16 w-16 mx-auto mb-4 opacity-50\" />\n              <p className=\"text-lg\">No bills yet</p>\n              <p className=\"text-sm mt-1\">Your levy statements will appear here</p>\n            </div>\n          ) : (\n            <div className=\"space-y-4\">\n              {bills.map((bill) => (\n                <div\n                  key={bill.id}\n                  className=\"flex flex-col md:flex-row md:items-center justify-between p-6 rounded-lg border hover-elevate gap-4\"\n                  data-testid={`bill-${bill.id}`}\n                >\n                  <div className=\"flex-1\">\n                    <div className=\"flex items-center gap-3 mb-2\">\n                      <Receipt className=\"h-5 w-5 text-muted-foreground\" />\n                      <h3 className=\"font-semibold text-lg\">{bill.description}</h3>\n                    </div>\n                    <div className=\"grid grid-cols-2 gap-2 text-sm text-muted-foreground\">\n                      <p>\n                        Period: {new Date(bill.periodStart).toLocaleDateString()} - {new Date(bill.periodEnd).toLocaleDateString()}\n                      </p>\n                      <p>Due Date: {new Date(bill.dueDate).toLocaleDateString()}</p>\n                    </div>\n                  </div>\n                  <div className=\"flex flex-col md:flex-row items-start md:items-center gap-4\">\n                    <div className=\"text-right\">\n                      <p className=\"text-2xl font-semibold\">{formatNaira(bill.amount)}</p>\n                      <div className=\"mt-1\">{getStatusBadge(bill.status)}</div>\n                    </div>\n                    <div className=\"flex gap-2\">\n                      <Button \n                        size=\"sm\" \n                        variant=\"outline\" \n                        onClick={() => handleDownloadInvoice(bill.id, bill.invoiceNumber || '')}\n                        disabled={downloadingBillId === bill.id}\n                        data-testid={`button-download-${bill.id}`}\n                      >\n                        <Download className=\"h-4 w-4 mr-1\" />\n                        {downloadingBillId === bill.id ? 'Downloading...' : 'Download'}\n                      </Button>\n                      {bill.status !== \"paid\" && (\n                        <Button size=\"sm\" data-testid={`button-pay-${bill.id}`}>\n                          Pay Now\n                        </Button>\n                      )}\n                    </div>\n                  </div>\n                </div>\n              ))}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Payment History */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Payment History</CardTitle>\n          <CardDescription>Your completed transactions</CardDescription>\n        </CardHeader>\n        <CardContent>\n          {payments.length === 0 ? (\n            <div className=\"text-center py-8 text-muted-foreground\">\n              <p>No payment history</p>\n            </div>\n          ) : (\n            <div className=\"space-y-3\">\n              {payments.map((payment) => (\n                <div\n                  key={payment.id}\n                  className=\"flex items-center justify-between p-4 rounded-lg border\"\n                  data-testid={`payment-${payment.id}`}\n                >\n                  <div className=\"flex-1\">\n                    <p className=\"font-medium\">Payment #{payment.id.slice(0, 8)}</p>\n                    <p className=\"text-sm text-muted-foreground\">\n                      {new Date(payment.createdAt!).toLocaleDateString()} • {payment.paymentMethod}\n                    </p>\n                  </div>\n                  <div className=\"text-right\">\n                    <p className=\"font-semibold\">{formatNaira(payment.amount)}</p>\n                    <Badge variant={payment.status === \"completed\" ? \"default\" : \"secondary\"} className=\"mt-1\">\n                      {payment.status}\n                    </Badge>\n                  </div>\n                </div>\n              ))}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":10144},"client/src/components/ui/separator.tsx":{"content":"import * as React from \"react\"\nimport * as SeparatorPrimitive from \"@radix-ui/react-separator\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Separator = React.forwardRef<\n  React.ElementRef<typeof SeparatorPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>\n>(\n  (\n    { className, orientation = \"horizontal\", decorative = true, ...props },\n    ref\n  ) => (\n    <SeparatorPrimitive.Root\n      ref={ref}\n      decorative={decorative}\n      orientation={orientation}\n      className={cn(\n        \"shrink-0 bg-border\",\n        orientation === \"horizontal\" ? \"h-[1px] w-full\" : \"h-full w-[1px]\",\n        className\n      )}\n      {...props}\n    />\n  )\n)\nSeparator.displayName = SeparatorPrimitive.Root.displayName\n\nexport { Separator }\n","size_bytes":756},"client/src/components/ui/alert-dialog.tsx":{"content":"import * as React from \"react\"\nimport * as AlertDialogPrimitive from \"@radix-ui/react-alert-dialog\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nconst AlertDialog = AlertDialogPrimitive.Root\n\nconst AlertDialogTrigger = AlertDialogPrimitive.Trigger\n\nconst AlertDialogPortal = AlertDialogPrimitive.Portal\n\nconst AlertDialogOverlay = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nAlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName\n\nconst AlertDialogContent = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPortal>\n    <AlertDialogOverlay />\n    <AlertDialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    />\n  </AlertDialogPortal>\n))\nAlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName\n\nconst AlertDialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogHeader.displayName = \"AlertDialogHeader\"\n\nconst AlertDialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogFooter.displayName = \"AlertDialogFooter\"\n\nconst AlertDialogTitle = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold\", className)}\n    {...props}\n  />\n))\nAlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName\n\nconst AlertDialogDescription = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nAlertDialogDescription.displayName =\n  AlertDialogPrimitive.Description.displayName\n\nconst AlertDialogAction = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Action>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Action>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Action\n    ref={ref}\n    className={cn(buttonVariants(), className)}\n    {...props}\n  />\n))\nAlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName\n\nconst AlertDialogCancel = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Cancel>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Cancel>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Cancel\n    ref={ref}\n    className={cn(\n      buttonVariants({ variant: \"outline\" }),\n      \"mt-2 sm:mt-0\",\n      className\n    )}\n    {...props}\n  />\n))\nAlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName\n\nexport {\n  AlertDialog,\n  AlertDialogPortal,\n  AlertDialogOverlay,\n  AlertDialogTrigger,\n  AlertDialogContent,\n  AlertDialogHeader,\n  AlertDialogFooter,\n  AlertDialogTitle,\n  AlertDialogDescription,\n  AlertDialogAction,\n  AlertDialogCancel,\n}\n","size_bytes":4420},"client/src/components/theme-toggle.tsx":{"content":"import { Moon, Sun } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { useTheme } from \"@/components/theme-provider\";\n\nexport function ThemeToggle() {\n  const { theme, setTheme } = useTheme();\n\n  return (\n    <Button\n      variant=\"ghost\"\n      size=\"icon\"\n      onClick={() => setTheme(theme === \"light\" ? \"dark\" : \"light\")}\n      data-testid=\"button-theme-toggle\"\n    >\n      <Sun className=\"h-5 w-5 rotate-0 scale-100 transition-all dark:-rotate-90 dark:scale-0\" />\n      <Moon className=\"absolute h-5 w-5 rotate-90 scale-0 transition-all dark:rotate-0 dark:scale-100\" />\n      <span className=\"sr-only\">Toggle theme</span>\n    </Button>\n  );\n}\n","size_bytes":677},"client/src/components/ui/input-otp.tsx":{"content":"import * as React from \"react\"\nimport { OTPInput, OTPInputContext } from \"input-otp\"\nimport { Dot } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst InputOTP = React.forwardRef<\n  React.ElementRef<typeof OTPInput>,\n  React.ComponentPropsWithoutRef<typeof OTPInput>\n>(({ className, containerClassName, ...props }, ref) => (\n  <OTPInput\n    ref={ref}\n    containerClassName={cn(\n      \"flex items-center gap-2 has-[:disabled]:opacity-50\",\n      containerClassName\n    )}\n    className={cn(\"disabled:cursor-not-allowed\", className)}\n    {...props}\n  />\n))\nInputOTP.displayName = \"InputOTP\"\n\nconst InputOTPGroup = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"flex items-center\", className)} {...props} />\n))\nInputOTPGroup.displayName = \"InputOTPGroup\"\n\nconst InputOTPSlot = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\"> & { index: number }\n>(({ index, className, ...props }, ref) => {\n  const inputOTPContext = React.useContext(OTPInputContext)\n  const { char, hasFakeCaret, isActive } = inputOTPContext.slots[index]\n\n  return (\n    <div\n      ref={ref}\n      className={cn(\n        \"relative flex h-10 w-10 items-center justify-center border-y border-r border-input text-sm transition-all first:rounded-l-md first:border-l last:rounded-r-md\",\n        isActive && \"z-10 ring-2 ring-ring ring-offset-background\",\n        className\n      )}\n      {...props}\n    >\n      {char}\n      {hasFakeCaret && (\n        <div className=\"pointer-events-none absolute inset-0 flex items-center justify-center\">\n          <div className=\"h-4 w-px animate-caret-blink bg-foreground duration-1000\" />\n        </div>\n      )}\n    </div>\n  )\n})\nInputOTPSlot.displayName = \"InputOTPSlot\"\n\nconst InputOTPSeparator = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ ...props }, ref) => (\n  <div ref={ref} role=\"separator\" {...props}>\n    <Dot />\n  </div>\n))\nInputOTPSeparator.displayName = \"InputOTPSeparator\"\n\nexport { InputOTP, InputOTPGroup, InputOTPSlot, InputOTPSeparator }\n","size_bytes":2154},"client/src/pages/admin/residents.tsx":{"content":"import { useEffect, useState } from \"react\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Link } from \"wouter\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Search, Plus, CheckCircle, XCircle, Clock, Eye, User, Home, Car, Phone, Users } from \"lucide-react\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { isUnauthorizedError } from \"@/lib/authUtils\";\nimport { formatNaira } from \"@/lib/currency\";\nimport type { Resident } from \"@shared/schema\";\n\nexport default function AdminResidents() {\n  const { toast } = useToast();\n  const { isAuthenticated, isLoading, user } = useAuth();\n  const [searchTerm, setSearchTerm] = useState(\"\");\n  const [open, setOpen] = useState(false);\n  const [formData, setFormData] = useState({\n    email: \"\",\n    firstName: \"\",\n    lastName: \"\",\n    unitNumber: \"\",\n    phoneNumber: \"\",\n    moveInDate: \"\",\n    occupancyType: \"owner\" as \"owner\" | \"tenant\",\n    numberOfOccupants: \"\",\n    propertySize: \"\",\n    bedrooms: \"\",\n    parkingSpaces: \"0\",\n    emergencyContactName: \"\",\n    emergencyContactPhone: \"\",\n    emergencyContactRelationship: \"\",\n    vehicles: \"\",\n    specialNotes: \"\",\n    serviceCharge: \"\",\n    startDate: \"\",\n    endDate: \"\",\n  });\n  const [selectedResident, setSelectedResident] = useState<(Resident & { user: { email: string; firstName: string; lastName: string } }) | null>(null);\n  const [detailsOpen, setDetailsOpen] = useState(false);\n\n  useEffect(() => {\n    if (!isLoading && (!isAuthenticated || user?.role !== \"admin\")) {\n      toast({\n        title: \"Unauthorized\",\n        description: \"Admin access required\",\n        variant: \"destructive\",\n      });\n      setTimeout(() => {\n        window.location.href = \"/\";\n      }, 500);\n      return;\n    }\n  }, [isAuthenticated, isLoading, user, toast]);\n\n  const { data: residents = [] } = useQuery<(Resident & { user: { email: string; firstName: string; lastName: string } })[]>({\n    queryKey: [\"/api/admin/residents\"],\n    enabled: isAuthenticated && user?.role === \"admin\",\n  });\n\n  const createResidentMutation = useMutation({\n    mutationFn: async (data: typeof formData) => {\n      await apiRequest(\"POST\", \"/api/admin/residents\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/residents\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/stats\"] });\n      toast({\n        title: \"Success\",\n        description: \"Resident added successfully\",\n      });\n      setOpen(false);\n      setFormData({\n        email: \"\",\n        firstName: \"\",\n        lastName: \"\",\n        unitNumber: \"\",\n        phoneNumber: \"\",\n        moveInDate: \"\",\n        occupancyType: \"owner\",\n        numberOfOccupants: \"\",\n        propertySize: \"\",\n        bedrooms: \"\",\n        parkingSpaces: \"0\",\n        emergencyContactName: \"\",\n        emergencyContactPhone: \"\",\n        emergencyContactRelationship: \"\",\n        vehicles: \"\",\n        specialNotes: \"\",\n        serviceCharge: \"\",\n        startDate: \"\",\n        endDate: \"\",\n      });\n    },\n    onError: (error: Error) => {\n      if (isUnauthorizedError(error)) {\n        toast({\n          title: \"Unauthorized\",\n          description: \"You are logged out. Logging in again...\",\n          variant: \"destructive\",\n        });\n        setTimeout(() => {\n          window.location.href = \"/api/login\";\n        }, 500);\n        return;\n      }\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to add resident\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  if (isLoading || !isAuthenticated || user?.role !== \"admin\") {\n    return (\n      <div className=\"flex h-screen items-center justify-center\">\n        <div className=\"animate-spin w-8 h-8 border-4 border-primary border-t-transparent rounded-full\" />\n      </div>\n    );\n  }\n\n  const filteredResidents = residents.filter(r =>\n    r.user?.firstName?.toLowerCase().includes(searchTerm.toLowerCase()) ||\n    r.user?.lastName?.toLowerCase().includes(searchTerm.toLowerCase()) ||\n    r.user?.email?.toLowerCase().includes(searchTerm.toLowerCase()) ||\n    r.unitNumber?.toLowerCase().includes(searchTerm.toLowerCase())\n  );\n\n  const getStatusBadge = (status: string) => {\n    const variants = {\n      active: { variant: \"default\" as const, icon: CheckCircle, className: \"bg-green-500 hover:bg-green-600\" },\n      inactive: { variant: \"secondary\" as const, icon: Clock, className: \"\" },\n      delinquent: { variant: \"destructive\" as const, icon: XCircle, className: \"\" },\n    };\n    const config = variants[status as keyof typeof variants] || variants.active;\n    const Icon = config.icon;\n    \n    return (\n      <Badge variant={config.variant} className={config.className}>\n        <Icon className=\"h-3 w-3 mr-1\" />\n        {status}\n      </Badge>\n    );\n  };\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    createResidentMutation.mutate(formData);\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-semibold\">Residents Management</h1>\n          <p className=\"text-muted-foreground mt-1\">Manage resident accounts and profiles</p>\n        </div>\n        <div className=\"flex items-center gap-2\">\n          <Link href=\"/admin/residents/list\">\n            <Button variant=\"outline\" data-testid=\"button-view-directory\">\n              <Users className=\"h-4 w-4 mr-2\" />\n              View Residents Directory\n            </Button>\n          </Link>\n          <Dialog open={open} onOpenChange={setOpen}>\n            <DialogTrigger asChild>\n              <Button data-testid=\"button-add-resident\">\n                <Plus className=\"h-4 w-4 mr-2\" />\n                Add Resident\n              </Button>\n            </DialogTrigger>\n          <DialogContent className=\"sm:max-w-[700px] max-h-[90vh] overflow-y-auto\">\n            <form onSubmit={handleSubmit}>\n              <DialogHeader>\n                <DialogTitle>Add New Resident</DialogTitle>\n                <DialogDescription>\n                  Create a comprehensive resident profile\n                </DialogDescription>\n              </DialogHeader>\n              \n              <Tabs defaultValue=\"basic\" className=\"py-4\">\n                <TabsList className=\"grid w-full grid-cols-4\">\n                  <TabsTrigger value=\"basic\" data-testid=\"tab-basic\">\n                    <User className=\"h-4 w-4 mr-2\" />\n                    Basic\n                  </TabsTrigger>\n                  <TabsTrigger value=\"property\" data-testid=\"tab-property\">\n                    <Home className=\"h-4 w-4 mr-2\" />\n                    Property\n                  </TabsTrigger>\n                  <TabsTrigger value=\"emergency\" data-testid=\"tab-emergency\">\n                    <Phone className=\"h-4 w-4 mr-2\" />\n                    Emergency\n                  </TabsTrigger>\n                  <TabsTrigger value=\"other\" data-testid=\"tab-other\">\n                    <Car className=\"h-4 w-4 mr-2\" />\n                    Other\n                  </TabsTrigger>\n                </TabsList>\n\n                <TabsContent value=\"basic\" className=\"space-y-4 mt-4\">\n                  <div className=\"grid gap-2\">\n                    <Label htmlFor=\"email\">Email Address *</Label>\n                    <Input\n                      id=\"email\"\n                      type=\"email\"\n                      value={formData.email}\n                      onChange={(e) => setFormData({ ...formData, email: e.target.value })}\n                      required\n                      data-testid=\"input-email\"\n                    />\n                  </div>\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div className=\"grid gap-2\">\n                      <Label htmlFor=\"firstName\">First Name *</Label>\n                      <Input\n                        id=\"firstName\"\n                        value={formData.firstName}\n                        onChange={(e) => setFormData({ ...formData, firstName: e.target.value })}\n                        required\n                        data-testid=\"input-first-name\"\n                      />\n                    </div>\n                    <div className=\"grid gap-2\">\n                      <Label htmlFor=\"lastName\">Last Name *</Label>\n                      <Input\n                        id=\"lastName\"\n                        value={formData.lastName}\n                        onChange={(e) => setFormData({ ...formData, lastName: e.target.value })}\n                        required\n                        data-testid=\"input-last-name\"\n                      />\n                    </div>\n                  </div>\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div className=\"grid gap-2\">\n                      <Label htmlFor=\"unitNumber\">Unit Number *</Label>\n                      <Input\n                        id=\"unitNumber\"\n                        value={formData.unitNumber}\n                        onChange={(e) => setFormData({ ...formData, unitNumber: e.target.value })}\n                        required\n                        data-testid=\"input-unit-number\"\n                      />\n                    </div>\n                    <div className=\"grid gap-2\">\n                      <Label htmlFor=\"phoneNumber\">Phone Number</Label>\n                      <Input\n                        id=\"phoneNumber\"\n                        type=\"tel\"\n                        value={formData.phoneNumber}\n                        onChange={(e) => setFormData({ ...formData, phoneNumber: e.target.value })}\n                        data-testid=\"input-phone\"\n                      />\n                    </div>\n                  </div>\n                </TabsContent>\n\n                <TabsContent value=\"property\" className=\"space-y-4 mt-4\">\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div className=\"grid gap-2\">\n                      <Label htmlFor=\"moveInDate\">Move-In Date</Label>\n                      <Input\n                        id=\"moveInDate\"\n                        type=\"date\"\n                        value={formData.moveInDate}\n                        onChange={(e) => setFormData({ ...formData, moveInDate: e.target.value })}\n                        data-testid=\"input-move-in-date\"\n                      />\n                    </div>\n                    <div className=\"grid gap-2\">\n                      <Label htmlFor=\"occupancyType\">Occupancy Type</Label>\n                      <Select\n                        value={formData.occupancyType}\n                        onValueChange={(value: \"owner\" | \"tenant\") => setFormData({ ...formData, occupancyType: value })}\n                      >\n                        <SelectTrigger data-testid=\"select-occupancy-type\">\n                          <SelectValue />\n                        </SelectTrigger>\n                        <SelectContent>\n                          <SelectItem value=\"owner\">Owner</SelectItem>\n                          <SelectItem value=\"tenant\">Tenant</SelectItem>\n                        </SelectContent>\n                      </Select>\n                    </div>\n                  </div>\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div className=\"grid gap-2\">\n                      <Label htmlFor=\"numberOfOccupants\">Number of Occupants</Label>\n                      <Input\n                        id=\"numberOfOccupants\"\n                        type=\"number\"\n                        min=\"0\"\n                        value={formData.numberOfOccupants}\n                        onChange={(e) => setFormData({ ...formData, numberOfOccupants: e.target.value })}\n                        data-testid=\"input-occupants\"\n                      />\n                    </div>\n                    <div className=\"grid gap-2\">\n                      <Label htmlFor=\"bedrooms\">Bedrooms</Label>\n                      <Input\n                        id=\"bedrooms\"\n                        type=\"number\"\n                        min=\"0\"\n                        value={formData.bedrooms}\n                        onChange={(e) => setFormData({ ...formData, bedrooms: e.target.value })}\n                        data-testid=\"input-bedrooms\"\n                      />\n                    </div>\n                  </div>\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div className=\"grid gap-2\">\n                      <Label htmlFor=\"propertySize\">Property Size</Label>\n                      <Input\n                        id=\"propertySize\"\n                        placeholder=\"e.g., 2000 sq ft\"\n                        value={formData.propertySize}\n                        onChange={(e) => setFormData({ ...formData, propertySize: e.target.value })}\n                        data-testid=\"input-property-size\"\n                      />\n                    </div>\n                    <div className=\"grid gap-2\">\n                      <Label htmlFor=\"parkingSpaces\">Parking Spaces</Label>\n                      <Input\n                        id=\"parkingSpaces\"\n                        type=\"number\"\n                        min=\"0\"\n                        value={formData.parkingSpaces}\n                        onChange={(e) => setFormData({ ...formData, parkingSpaces: e.target.value })}\n                        data-testid=\"input-parking\"\n                      />\n                    </div>\n                  </div>\n                  <div className=\"grid gap-2\">\n                    <Label htmlFor=\"serviceCharge\">Service Charge (₦)</Label>\n                    <Input\n                      id=\"serviceCharge\"\n                      type=\"number\"\n                      min=\"0\"\n                      step=\"0.01\"\n                      placeholder=\"e.g., 50000\"\n                      value={formData.serviceCharge}\n                      onChange={(e) => setFormData({ ...formData, serviceCharge: e.target.value })}\n                      data-testid=\"input-service-charge\"\n                    />\n                  </div>\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div className=\"grid gap-2\">\n                      <Label htmlFor=\"startDate\">Start Date</Label>\n                      <Input\n                        id=\"startDate\"\n                        type=\"date\"\n                        value={formData.startDate}\n                        onChange={(e) => {\n                          const startDate = e.target.value;\n                          let endDate = \"\";\n                          \n                          if (startDate) {\n                            const start = new Date(startDate);\n                            const end = new Date(start);\n                            end.setMonth(end.getMonth() + 12);\n                            endDate = end.toISOString().split('T')[0];\n                          }\n                          \n                          setFormData({ ...formData, startDate, endDate });\n                        }}\n                        data-testid=\"input-start-date\"\n                      />\n                    </div>\n                    <div className=\"grid gap-2\">\n                      <Label htmlFor=\"endDate\">End Date (Auto-calculated)</Label>\n                      <Input\n                        id=\"endDate\"\n                        type=\"date\"\n                        value={formData.endDate}\n                        onChange={(e) => setFormData({ ...formData, endDate: e.target.value })}\n                        data-testid=\"input-end-date\"\n                        disabled\n                        className=\"bg-muted\"\n                      />\n                    </div>\n                  </div>\n                </TabsContent>\n\n                <TabsContent value=\"emergency\" className=\"space-y-4 mt-4\">\n                  <div className=\"grid gap-2\">\n                    <Label htmlFor=\"emergencyContactName\">Emergency Contact Name</Label>\n                    <Input\n                      id=\"emergencyContactName\"\n                      value={formData.emergencyContactName}\n                      onChange={(e) => setFormData({ ...formData, emergencyContactName: e.target.value })}\n                      data-testid=\"input-emergency-name\"\n                    />\n                  </div>\n                  <div className=\"grid gap-2\">\n                    <Label htmlFor=\"emergencyContactPhone\">Emergency Contact Phone</Label>\n                    <Input\n                      id=\"emergencyContactPhone\"\n                      type=\"tel\"\n                      value={formData.emergencyContactPhone}\n                      onChange={(e) => setFormData({ ...formData, emergencyContactPhone: e.target.value })}\n                      data-testid=\"input-emergency-phone\"\n                    />\n                  </div>\n                  <div className=\"grid gap-2\">\n                    <Label htmlFor=\"emergencyContactRelationship\">Relationship</Label>\n                    <Input\n                      id=\"emergencyContactRelationship\"\n                      placeholder=\"e.g., Spouse, Parent, Sibling\"\n                      value={formData.emergencyContactRelationship}\n                      onChange={(e) => setFormData({ ...formData, emergencyContactRelationship: e.target.value })}\n                      data-testid=\"input-emergency-relationship\"\n                    />\n                  </div>\n                </TabsContent>\n\n                <TabsContent value=\"other\" className=\"space-y-4 mt-4\">\n                  <div className=\"grid gap-2\">\n                    <Label htmlFor=\"vehicles\">Vehicles (one per line)</Label>\n                    <Textarea\n                      id=\"vehicles\"\n                      placeholder=\"e.g., &#10;Toyota Camry - ABC123XY&#10;Honda CR-V - XYZ789AB\"\n                      value={formData.vehicles}\n                      onChange={(e) => setFormData({ ...formData, vehicles: e.target.value })}\n                      rows={4}\n                      data-testid=\"input-vehicles\"\n                    />\n                    <p className=\"text-xs text-muted-foreground\">Enter vehicle details, one per line</p>\n                  </div>\n                  <div className=\"grid gap-2\">\n                    <Label htmlFor=\"specialNotes\">Special Notes</Label>\n                    <Textarea\n                      id=\"specialNotes\"\n                      placeholder=\"Any additional information about this resident...\"\n                      value={formData.specialNotes}\n                      onChange={(e) => setFormData({ ...formData, specialNotes: e.target.value })}\n                      rows={4}\n                      data-testid=\"input-notes\"\n                    />\n                  </div>\n                </TabsContent>\n              </Tabs>\n\n              <DialogFooter>\n                <Button type=\"button\" variant=\"outline\" onClick={() => setOpen(false)}>\n                  Cancel\n                </Button>\n                <Button type=\"submit\" disabled={createResidentMutation.isPending} data-testid=\"button-submit-resident\">\n                  {createResidentMutation.isPending ? \"Adding...\" : \"Add Resident\"}\n                </Button>\n              </DialogFooter>\n            </form>\n          </DialogContent>\n        </Dialog>\n        </div>\n      </div>\n\n      {/* Residents List */}\n      <Card>\n        <CardHeader>\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <CardTitle>All Residents ({filteredResidents.length})</CardTitle>\n              <CardDescription>Manage resident accounts and status</CardDescription>\n            </div>\n            <div className=\"relative w-64\">\n              <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n              <Input\n                placeholder=\"Search residents...\"\n                value={searchTerm}\n                onChange={(e) => setSearchTerm(e.target.value)}\n                className=\"pl-10\"\n                data-testid=\"input-search\"\n              />\n            </div>\n          </div>\n        </CardHeader>\n        <CardContent>\n          <div className=\"space-y-3\">\n            {filteredResidents.map((resident) => (\n              <div\n                key={resident.id}\n                className=\"flex items-center justify-between p-4 rounded-lg border hover-elevate\"\n                data-testid={`resident-${resident.id}`}\n              >\n                <div className=\"flex-1\">\n                  <div className=\"flex items-center gap-3 mb-1\">\n                    <h4 className=\"font-medium\">\n                      {resident.user.firstName} {resident.user.lastName}\n                    </h4>\n                    {getStatusBadge(resident.accountStatus)}\n                  </div>\n                  <div className=\"flex items-center gap-4 text-sm text-muted-foreground\">\n                    <span>Unit {resident.unitNumber}</span>\n                    <span>•</span>\n                    <span>{resident.user.email}</span>\n                    {resident.phoneNumber && (\n                      <>\n                        <span>•</span>\n                        <span>{resident.phoneNumber}</span>\n                      </>\n                    )}\n                  </div>\n                </div>\n                <div className=\"flex items-center gap-4\">\n                  <div className=\"text-right mr-4\">\n                    <p className=\"text-sm text-muted-foreground\">Balance</p>\n                    <p className=\"text-lg font-semibold\">\n                      {formatNaira(resident.totalBalance)}\n                    </p>\n                  </div>\n                  <Button\n                    variant=\"outline\"\n                    size=\"sm\"\n                    onClick={() => {\n                      setSelectedResident(resident);\n                      setDetailsOpen(true);\n                    }}\n                    data-testid={`button-view-details-${resident.id}`}\n                  >\n                    <Eye className=\"h-4 w-4 mr-2\" />\n                    View Details\n                  </Button>\n                </div>\n              </div>\n            ))}\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Resident Details Dialog */}\n      <Dialog open={detailsOpen} onOpenChange={setDetailsOpen}>\n        <DialogContent className=\"sm:max-w-[700px] max-h-[90vh] overflow-y-auto\">\n          {selectedResident && (\n            <>\n              <DialogHeader>\n                <DialogTitle>\n                  {selectedResident.user.firstName} {selectedResident.user.lastName}\n                </DialogTitle>\n                <DialogDescription>\n                  Unit {selectedResident.unitNumber} • {selectedResident.accountStatus}\n                </DialogDescription>\n              </DialogHeader>\n\n              <div className=\"space-y-6 py-4\">\n                {/* Basic Information */}\n                <div>\n                  <h3 className=\"text-sm font-semibold mb-3 flex items-center gap-2\">\n                    <User className=\"h-4 w-4\" />\n                    Basic Information\n                  </h3>\n                  <div className=\"grid grid-cols-2 gap-4 text-sm\">\n                    <div>\n                      <p className=\"text-muted-foreground\">Email</p>\n                      <p className=\"font-medium\">{selectedResident.user.email}</p>\n                    </div>\n                    <div>\n                      <p className=\"text-muted-foreground\">Phone</p>\n                      <p className=\"font-medium\">{selectedResident.phoneNumber || \"Not provided\"}</p>\n                    </div>\n                    <div>\n                      <p className=\"text-muted-foreground\">Account Status</p>\n                      <div className=\"mt-1\">{getStatusBadge(selectedResident.accountStatus)}</div>\n                    </div>\n                    <div>\n                      <p className=\"text-muted-foreground\">Balance</p>\n                      <p className=\"font-semibold\">{formatNaira(selectedResident.totalBalance)}</p>\n                    </div>\n                  </div>\n                </div>\n\n                {/* Property Information */}\n                <div>\n                  <h3 className=\"text-sm font-semibold mb-3 flex items-center gap-2\">\n                    <Home className=\"h-4 w-4\" />\n                    Property Information\n                  </h3>\n                  <div className=\"grid grid-cols-2 gap-4 text-sm\">\n                    <div>\n                      <p className=\"text-muted-foreground\">Move-In Date</p>\n                      <p className=\"font-medium\">\n                        {selectedResident.moveInDate \n                          ? new Date(selectedResident.moveInDate).toLocaleDateString()\n                          : \"Not provided\"}\n                      </p>\n                    </div>\n                    <div>\n                      <p className=\"text-muted-foreground\">Occupancy Type</p>\n                      <p className=\"font-medium capitalize\">{selectedResident.occupancyType || \"Not provided\"}</p>\n                    </div>\n                    <div>\n                      <p className=\"text-muted-foreground\">Number of Occupants</p>\n                      <p className=\"font-medium\">{selectedResident.numberOfOccupants || \"Not provided\"}</p>\n                    </div>\n                    <div>\n                      <p className=\"text-muted-foreground\">Bedrooms</p>\n                      <p className=\"font-medium\">{selectedResident.bedrooms || \"Not provided\"}</p>\n                    </div>\n                    <div>\n                      <p className=\"text-muted-foreground\">Property Size</p>\n                      <p className=\"font-medium\">{selectedResident.propertySize || \"Not provided\"}</p>\n                    </div>\n                    <div>\n                      <p className=\"text-muted-foreground\">Parking Spaces</p>\n                      <p className=\"font-medium\">{selectedResident.parkingSpaces || 0}</p>\n                    </div>\n                  </div>\n                </div>\n\n                {/* Emergency Contact */}\n                {(selectedResident.emergencyContactName || selectedResident.emergencyContactPhone) && (\n                  <div>\n                    <h3 className=\"text-sm font-semibold mb-3 flex items-center gap-2\">\n                      <Phone className=\"h-4 w-4\" />\n                      Emergency Contact\n                    </h3>\n                    <div className=\"grid grid-cols-2 gap-4 text-sm\">\n                      <div>\n                        <p className=\"text-muted-foreground\">Name</p>\n                        <p className=\"font-medium\">{selectedResident.emergencyContactName || \"Not provided\"}</p>\n                      </div>\n                      <div>\n                        <p className=\"text-muted-foreground\">Phone</p>\n                        <p className=\"font-medium\">{selectedResident.emergencyContactPhone || \"Not provided\"}</p>\n                      </div>\n                      <div>\n                        <p className=\"text-muted-foreground\">Relationship</p>\n                        <p className=\"font-medium\">{selectedResident.emergencyContactRelationship || \"Not provided\"}</p>\n                      </div>\n                    </div>\n                  </div>\n                )}\n\n                {/* Vehicles */}\n                {selectedResident.vehicles && selectedResident.vehicles.length > 0 && (\n                  <div>\n                    <h3 className=\"text-sm font-semibold mb-3 flex items-center gap-2\">\n                      <Car className=\"h-4 w-4\" />\n                      Vehicles\n                    </h3>\n                    <div className=\"space-y-2\">\n                      {selectedResident.vehicles.map((vehicle, index) => (\n                        <div key={index} className=\"p-3 rounded-lg bg-muted text-sm\">\n                          {vehicle}\n                        </div>\n                      ))}\n                    </div>\n                  </div>\n                )}\n\n                {/* Special Notes */}\n                {selectedResident.specialNotes && (\n                  <div>\n                    <h3 className=\"text-sm font-semibold mb-3\">Special Notes</h3>\n                    <div className=\"p-3 rounded-lg bg-muted text-sm whitespace-pre-wrap\">\n                      {selectedResident.specialNotes}\n                    </div>\n                  </div>\n                )}\n\n                {/* Timestamps */}\n                <div className=\"pt-4 border-t\">\n                  <div className=\"grid grid-cols-2 gap-4 text-xs text-muted-foreground\">\n                    <div>\n                      <p>Created</p>\n                      <p>{new Date(selectedResident.createdAt!).toLocaleString()}</p>\n                    </div>\n                    <div>\n                      <p>Last Updated</p>\n                      <p>{new Date(selectedResident.updatedAt!).toLocaleString()}</p>\n                    </div>\n                  </div>\n                </div>\n              </div>\n\n              <DialogFooter>\n                <Button variant=\"outline\" onClick={() => setDetailsOpen(false)}>\n                  Close\n                </Button>\n              </DialogFooter>\n            </>\n          )}\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","size_bytes":30075},"client/src/components/ui/accordion.tsx":{"content":"import * as React from \"react\"\nimport * as AccordionPrimitive from \"@radix-ui/react-accordion\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Accordion = AccordionPrimitive.Root\n\nconst AccordionItem = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <AccordionPrimitive.Item\n    ref={ref}\n    className={cn(\"border-b\", className)}\n    {...props}\n  />\n))\nAccordionItem.displayName = \"AccordionItem\"\n\nconst AccordionTrigger = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Header className=\"flex\">\n    <AccordionPrimitive.Trigger\n      ref={ref}\n      className={cn(\n        \"flex flex-1 items-center justify-between py-4 font-medium transition-all hover:underline [&[data-state=open]>svg]:rotate-180\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <ChevronDown className=\"h-4 w-4 shrink-0 transition-transform duration-200\" />\n    </AccordionPrimitive.Trigger>\n  </AccordionPrimitive.Header>\n))\nAccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName\n\nconst AccordionContent = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Content\n    ref={ref}\n    className=\"overflow-hidden text-sm transition-all data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down\"\n    {...props}\n  >\n    <div className={cn(\"pb-4 pt-0\", className)}>{children}</div>\n  </AccordionPrimitive.Content>\n))\n\nAccordionContent.displayName = AccordionPrimitive.Content.displayName\n\nexport { Accordion, AccordionItem, AccordionTrigger, AccordionContent }\n","size_bytes":1977},"client/src/components/ui/toggle-group.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ToggleGroupPrimitive from \"@radix-ui/react-toggle-group\"\nimport { type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { toggleVariants } from \"@/components/ui/toggle\"\n\nconst ToggleGroupContext = React.createContext<\n  VariantProps<typeof toggleVariants>\n>({\n  size: \"default\",\n  variant: \"default\",\n})\n\nconst ToggleGroup = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, children, ...props }, ref) => (\n  <ToggleGroupPrimitive.Root\n    ref={ref}\n    className={cn(\"flex items-center justify-center gap-1\", className)}\n    {...props}\n  >\n    <ToggleGroupContext.Provider value={{ variant, size }}>\n      {children}\n    </ToggleGroupContext.Provider>\n  </ToggleGroupPrimitive.Root>\n))\n\nToggleGroup.displayName = ToggleGroupPrimitive.Root.displayName\n\nconst ToggleGroupItem = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Item> &\n    VariantProps<typeof toggleVariants>\n>(({ className, children, variant, size, ...props }, ref) => {\n  const context = React.useContext(ToggleGroupContext)\n\n  return (\n    <ToggleGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        toggleVariants({\n          variant: context.variant || variant,\n          size: context.size || size,\n        }),\n        className\n      )}\n      {...props}\n    >\n      {children}\n    </ToggleGroupPrimitive.Item>\n  )\n})\n\nToggleGroupItem.displayName = ToggleGroupPrimitive.Item.displayName\n\nexport { ToggleGroup, ToggleGroupItem }\n","size_bytes":1753},"client/src/components/ui/progress.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ProgressPrimitive from \"@radix-ui/react-progress\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Progress = React.forwardRef<\n  React.ElementRef<typeof ProgressPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root>\n>(({ className, value, ...props }, ref) => (\n  <ProgressPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative h-4 w-full overflow-hidden rounded-full bg-secondary\",\n      className\n    )}\n    {...props}\n  >\n    <ProgressPrimitive.Indicator\n      className=\"h-full w-full flex-1 bg-primary transition-all\"\n      style={{ transform: `translateX(-${100 - (value || 0)}%)` }}\n    />\n  </ProgressPrimitive.Root>\n))\nProgress.displayName = ProgressPrimitive.Root.displayName\n\nexport { Progress }\n","size_bytes":791},"client/src/components/ui/aspect-ratio.tsx":{"content":"import * as AspectRatioPrimitive from \"@radix-ui/react-aspect-ratio\"\n\nconst AspectRatio = AspectRatioPrimitive.Root\n\nexport { AspectRatio }\n","size_bytes":140},"client/src/components/ui/sidebar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, VariantProps } from \"class-variance-authority\"\nimport { PanelLeftIcon } from \"lucide-react\"\n\nimport { useIsMobile } from \"@/hooks/use-mobile\"\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Separator } from \"@/components/ui/separator\"\nimport {\n  Sheet,\n  SheetContent,\n  SheetDescription,\n  SheetHeader,\n  SheetTitle,\n} from \"@/components/ui/sheet\"\nimport { Skeleton } from \"@/components/ui/skeleton\"\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\"\n\nconst SIDEBAR_COOKIE_NAME = \"sidebar_state\"\nconst SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7\nconst SIDEBAR_WIDTH = \"16rem\"\nconst SIDEBAR_WIDTH_MOBILE = \"18rem\"\nconst SIDEBAR_WIDTH_ICON = \"3rem\"\nconst SIDEBAR_KEYBOARD_SHORTCUT = \"b\"\n\ntype SidebarContextProps = {\n  state: \"expanded\" | \"collapsed\"\n  open: boolean\n  setOpen: (open: boolean) => void\n  openMobile: boolean\n  setOpenMobile: (open: boolean) => void\n  isMobile: boolean\n  toggleSidebar: () => void\n}\n\nconst SidebarContext = React.createContext<SidebarContextProps | null>(null)\n\nfunction useSidebar() {\n  const context = React.useContext(SidebarContext)\n  if (!context) {\n    throw new Error(\"useSidebar must be used within a SidebarProvider.\")\n  }\n\n  return context\n}\n\nfunction SidebarProvider({\n  defaultOpen = true,\n  open: openProp,\n  onOpenChange: setOpenProp,\n  className,\n  style,\n  children,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  defaultOpen?: boolean\n  open?: boolean\n  onOpenChange?: (open: boolean) => void\n}) {\n  const isMobile = useIsMobile()\n  const [openMobile, setOpenMobile] = React.useState(false)\n\n  // This is the internal state of the sidebar.\n  // We use openProp and setOpenProp for control from outside the component.\n  const [_open, _setOpen] = React.useState(defaultOpen)\n  const open = openProp ?? _open\n  const setOpen = React.useCallback(\n    (value: boolean | ((value: boolean) => boolean)) => {\n      const openState = typeof value === \"function\" ? value(open) : value\n      if (setOpenProp) {\n        setOpenProp(openState)\n      } else {\n        _setOpen(openState)\n      }\n\n      // This sets the cookie to keep the sidebar state.\n      document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`\n    },\n    [setOpenProp, open]\n  )\n\n  // Helper to toggle the sidebar.\n  const toggleSidebar = React.useCallback(() => {\n    return isMobile ? setOpenMobile((open) => !open) : setOpen((open) => !open)\n  }, [isMobile, setOpen, setOpenMobile])\n\n  // Adds a keyboard shortcut to toggle the sidebar.\n  React.useEffect(() => {\n    const handleKeyDown = (event: KeyboardEvent) => {\n      if (\n        event.key === SIDEBAR_KEYBOARD_SHORTCUT &&\n        (event.metaKey || event.ctrlKey)\n      ) {\n        event.preventDefault()\n        toggleSidebar()\n      }\n    }\n\n    window.addEventListener(\"keydown\", handleKeyDown)\n    return () => window.removeEventListener(\"keydown\", handleKeyDown)\n  }, [toggleSidebar])\n\n  // We add a state so that we can do data-state=\"expanded\" or \"collapsed\".\n  // This makes it easier to style the sidebar with Tailwind classes.\n  const state = open ? \"expanded\" : \"collapsed\"\n\n  const contextValue = React.useMemo<SidebarContextProps>(\n    () => ({\n      state,\n      open,\n      setOpen,\n      isMobile,\n      openMobile,\n      setOpenMobile,\n      toggleSidebar,\n    }),\n    [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar]\n  )\n\n  return (\n    <SidebarContext.Provider value={contextValue}>\n      <TooltipProvider delayDuration={0}>\n        <div\n          data-slot=\"sidebar-wrapper\"\n          style={\n            {\n              \"--sidebar-width\": SIDEBAR_WIDTH,\n              \"--sidebar-width-icon\": SIDEBAR_WIDTH_ICON,\n              ...style,\n            } as React.CSSProperties\n          }\n          className={cn(\n            \"group/sidebar-wrapper has-data-[variant=inset]:bg-sidebar flex min-h-svh w-full\",\n            className\n          )}\n          {...props}\n        >\n          {children}\n        </div>\n      </TooltipProvider>\n    </SidebarContext.Provider>\n  )\n}\n\nfunction Sidebar({\n  side = \"left\",\n  variant = \"sidebar\",\n  collapsible = \"offcanvas\",\n  className,\n  children,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  side?: \"left\" | \"right\"\n  variant?: \"sidebar\" | \"floating\" | \"inset\"\n  collapsible?: \"offcanvas\" | \"icon\" | \"none\"\n}) {\n  const { isMobile, state, openMobile, setOpenMobile } = useSidebar()\n\n  if (collapsible === \"none\") {\n    return (\n      <div\n        data-slot=\"sidebar\"\n        className={cn(\n          \"bg-sidebar text-sidebar-foreground flex h-full w-[var(--sidebar-width)] flex-col\",\n          className\n        )}\n        {...props}\n      >\n        {children}\n      </div>\n    )\n  }\n\n  if (isMobile) {\n    return (\n      <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>\n        <SheetContent\n          data-sidebar=\"sidebar\"\n          data-slot=\"sidebar\"\n          data-mobile=\"true\"\n          className=\"bg-sidebar text-sidebar-foreground w-[var(--sidebar-width)] p-0 [&>button]:hidden\"\n          style={\n            {\n              \"--sidebar-width\": SIDEBAR_WIDTH_MOBILE,\n            } as React.CSSProperties\n          }\n          side={side}\n        >\n          <SheetHeader className=\"sr-only\">\n            <SheetTitle>Sidebar</SheetTitle>\n            <SheetDescription>Displays the mobile sidebar.</SheetDescription>\n          </SheetHeader>\n          <div className=\"flex h-full w-full flex-col\">{children}</div>\n        </SheetContent>\n      </Sheet>\n    )\n  }\n\n  return (\n    <div\n      className=\"group peer text-sidebar-foreground hidden md:block\"\n      data-state={state}\n      data-collapsible={state === \"collapsed\" ? collapsible : \"\"}\n      data-variant={variant}\n      data-side={side}\n      data-slot=\"sidebar\"\n    >\n      {/* This is what handles the sidebar gap on desktop */}\n      <div\n        data-slot=\"sidebar-gap\"\n        className={cn(\n          \"relative w-[var(--sidebar-width)] bg-transparent transition-[width] duration-200 ease-linear\",\n          \"group-data-[collapsible=offcanvas]:w-0\",\n          \"group-data-[side=right]:rotate-180\",\n          variant === \"floating\" || variant === \"inset\"\n            ? \"group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+var(--spacing-4))]\"\n            : \"group-data-[collapsible=icon]:w-[var(--sidebar-width-icon)]\"\n        )}\n      />\n      <div\n        data-slot=\"sidebar-container\"\n        className={cn(\n          \"fixed inset-y-0 z-10 hidden h-svh w-[var(--sidebar-width)] transition-[left,right,width] duration-200 ease-linear md:flex\",\n          side === \"left\"\n            ? \"left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]\"\n            : \"right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]\",\n          // Adjust the padding for floating and inset variants.\n          variant === \"floating\" || variant === \"inset\"\n            ? \"p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+var(--spacing-4)+2px)]\"\n            : \"group-data-[collapsible=icon]:w-[var(--sidebar-width-icon)] group-data-[side=left]:border-r group-data-[side=right]:border-l\",\n          className\n        )}\n        {...props}\n      >\n        <div\n          data-sidebar=\"sidebar\"\n          data-slot=\"sidebar-inner\"\n          className=\"bg-sidebar group-data-[variant=floating]:border-sidebar-border flex h-full w-full flex-col group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:shadow-sm\"\n        >\n          {children}\n        </div>\n      </div>\n    </div>\n  )\n}\n\nfunction SidebarTrigger({\n  className,\n  onClick,\n  ...props\n}: React.ComponentProps<typeof Button>) {\n  const { toggleSidebar } = useSidebar()\n\n  return (\n    <Button\n      data-sidebar=\"trigger\"\n      data-slot=\"sidebar-trigger\"\n      variant=\"ghost\"\n      size=\"icon\"\n      className={cn(\"h-7 w-7\", className)}\n      onClick={(event) => {\n        onClick?.(event)\n        toggleSidebar()\n      }}\n      {...props}\n    >\n      <PanelLeftIcon />\n      <span className=\"sr-only\">Toggle Sidebar</span>\n    </Button>\n  )\n}\n\nfunction SidebarRail({ className, ...props }: React.ComponentProps<\"button\">) {\n  const { toggleSidebar } = useSidebar()\n\n  // Note: Tailwind v3.4 doesn't support \"in-\" selectors. So the rail won't work perfectly.\n  return (\n    <button\n      data-sidebar=\"rail\"\n      data-slot=\"sidebar-rail\"\n      aria-label=\"Toggle Sidebar\"\n      tabIndex={-1}\n      onClick={toggleSidebar}\n      title=\"Toggle Sidebar\"\n      className={cn(\n        \"hover:after:bg-sidebar-border absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear group-data-[side=left]:-right-4 group-data-[side=right]:left-0 after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] sm:flex\",\n        \"in-data-[side=left]:cursor-w-resize in-data-[side=right]:cursor-e-resize\",\n        \"[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize\",\n        \"hover:group-data-[collapsible=offcanvas]:bg-sidebar group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full\",\n        \"[[data-side=left][data-collapsible=offcanvas]_&]:-right-2\",\n        \"[[data-side=right][data-collapsible=offcanvas]_&]:-left-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarInset({ className, ...props }: React.ComponentProps<\"main\">) {\n  return (\n    <main\n      data-slot=\"sidebar-inset\"\n      className={cn(\n        \"bg-background relative flex w-full flex-1 flex-col\",\n        \"md:peer-data-[variant=inset]:m-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow-sm md:peer-data-[variant=inset]:peer-data-[state=collapsed]:ml-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarInput({\n  className,\n  ...props\n}: React.ComponentProps<typeof Input>) {\n  return (\n    <Input\n      data-slot=\"sidebar-input\"\n      data-sidebar=\"input\"\n      className={cn(\"bg-background h-8 w-full shadow-none\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarHeader({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-header\"\n      data-sidebar=\"header\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarFooter({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-footer\"\n      data-sidebar=\"footer\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarSeparator({\n  className,\n  ...props\n}: React.ComponentProps<typeof Separator>) {\n  return (\n    <Separator\n      data-slot=\"sidebar-separator\"\n      data-sidebar=\"separator\"\n      className={cn(\"bg-sidebar-border mx-2 w-auto\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarContent({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-content\"\n      data-sidebar=\"content\"\n      className={cn(\n        \"flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroup({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-group\"\n      data-sidebar=\"group\"\n      className={cn(\"relative flex w-full min-w-0 flex-col p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupLabel({\n  className,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"div\"> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"div\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-group-label\"\n      data-sidebar=\"group-label\"\n      className={cn(\n        \"text-sidebar-foreground/70 ring-sidebar-ring flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium outline-hidden transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&>svg]:h-4 [&>svg]:w-4 [&>svg]:shrink-0\",\n        \"group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupAction({\n  className,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"button\"> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-group-action\"\n      data-sidebar=\"group-action\"\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground absolute top-3.5 right-3 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 md:after:hidden\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupContent({\n  className,\n  ...props\n}: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-group-content\"\n      data-sidebar=\"group-content\"\n      className={cn(\"w-full text-sm\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenu({ className, ...props }: React.ComponentProps<\"ul\">) {\n  return (\n    <ul\n      data-slot=\"sidebar-menu\"\n      data-sidebar=\"menu\"\n      className={cn(\"flex w-full min-w-0 flex-col gap-1\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuItem({ className, ...props }: React.ComponentProps<\"li\">) {\n  return (\n    <li\n      data-slot=\"sidebar-menu-item\"\n      data-sidebar=\"menu-item\"\n      className={cn(\"group/menu-item relative\", className)}\n      {...props}\n    />\n  )\n}\n\nconst sidebarMenuButtonVariants = cva(\n  \"peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-hidden ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:w-8! group-data-[collapsible=icon]:h-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"hover:bg-sidebar-accent hover:text-sidebar-accent-foreground\",\n        outline:\n          \"bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]\",\n      },\n      size: {\n        default: \"h-8 text-sm\",\n        sm: \"h-7 text-xs\",\n        lg: \"h-12 text-sm group-data-[collapsible=icon]:p-0!\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nfunction SidebarMenuButton({\n  asChild = false,\n  isActive = false,\n  variant = \"default\",\n  size = \"default\",\n  tooltip,\n  className,\n  ...props\n}: React.ComponentProps<\"button\"> & {\n  asChild?: boolean\n  isActive?: boolean\n  tooltip?: string | React.ComponentProps<typeof TooltipContent>\n} & VariantProps<typeof sidebarMenuButtonVariants>) {\n  const Comp = asChild ? Slot : \"button\"\n  const { isMobile, state } = useSidebar()\n\n  const button = (\n    <Comp\n      data-slot=\"sidebar-menu-button\"\n      data-sidebar=\"menu-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(sidebarMenuButtonVariants({ variant, size }), className)}\n      {...props}\n    />\n  )\n\n  if (!tooltip) {\n    return button\n  }\n\n  if (typeof tooltip === \"string\") {\n    tooltip = {\n      children: tooltip,\n    }\n  }\n\n  return (\n    <Tooltip>\n      <TooltipTrigger asChild>{button}</TooltipTrigger>\n      <TooltipContent\n        side=\"right\"\n        align=\"center\"\n        hidden={state !== \"collapsed\" || isMobile}\n        {...tooltip}\n      />\n    </Tooltip>\n  )\n}\n\nfunction SidebarMenuAction({\n  className,\n  asChild = false,\n  showOnHover = false,\n  ...props\n}: React.ComponentProps<\"button\"> & {\n  asChild?: boolean\n  showOnHover?: boolean\n}) {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-menu-action\"\n      data-sidebar=\"menu-action\"\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer-hover/menu-button:text-sidebar-accent-foreground absolute top-1.5 right-1 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 md:after:hidden\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        showOnHover &&\n          \"peer-data-[active=true]/menu-button:text-sidebar-accent-foreground group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 md:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuBadge({\n  className,\n  ...props\n}: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-menu-badge\"\n      data-sidebar=\"menu-badge\"\n      className={cn(\n        \"text-sidebar-foreground pointer-events-none absolute right-1 flex h-5 min-w-5 items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums select-none\",\n        \"peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSkeleton({\n  className,\n  showIcon = false,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  showIcon?: boolean\n}) {\n  // Random width between 50 to 90%.\n  const width = React.useMemo(() => {\n    return `${Math.floor(Math.random() * 40) + 50}%`\n  }, [])\n\n  return (\n    <div\n      data-slot=\"sidebar-menu-skeleton\"\n      data-sidebar=\"menu-skeleton\"\n      className={cn(\"flex h-8 items-center gap-2 rounded-md px-2\", className)}\n      {...props}\n    >\n      {showIcon && (\n        <Skeleton\n          className=\"size-4 rounded-md\"\n          data-sidebar=\"menu-skeleton-icon\"\n        />\n      )}\n      <Skeleton\n        className=\"h-4 max-w-[var(--skeleton-width)] flex-1\"\n        data-sidebar=\"menu-skeleton-text\"\n        style={\n          {\n            \"--skeleton-width\": width,\n          } as React.CSSProperties\n        }\n      />\n    </div>\n  )\n}\n\nfunction SidebarMenuSub({ className, ...props }: React.ComponentProps<\"ul\">) {\n  return (\n    <ul\n      data-slot=\"sidebar-menu-sub\"\n      data-sidebar=\"menu-sub\"\n      className={cn(\n        \"border-sidebar-border mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l px-2.5 py-0.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSubItem({\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) {\n  return (\n    <li\n      data-slot=\"sidebar-menu-sub-item\"\n      data-sidebar=\"menu-sub-item\"\n      className={cn(\"group/menu-sub-item relative\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSubButton({\n  asChild = false,\n  size = \"md\",\n  isActive = false,\n  className,\n  ...props\n}: React.ComponentProps<\"a\"> & {\n  asChild?: boolean\n  size?: \"sm\" | \"md\"\n  isActive?: boolean\n}) {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-menu-sub-button\"\n      data-sidebar=\"menu-sub-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground active:bg-sidebar-accent active:text-sidebar-accent-foreground [&>svg]:text-sidebar-accent-foreground flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 outline outline-2 outline-transparent outline-offset-2 focus-visible:ring-2 disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n        \"data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground\",\n        size === \"sm\" && \"text-xs\",\n        size === \"md\" && \"text-sm\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nexport {\n  Sidebar,\n  SidebarContent,\n  SidebarFooter,\n  SidebarGroup,\n  SidebarGroupAction,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarHeader,\n  SidebarInput,\n  SidebarInset,\n  SidebarMenu,\n  SidebarMenuAction,\n  SidebarMenuBadge,\n  SidebarMenuButton,\n  SidebarMenuItem,\n  SidebarMenuSkeleton,\n  SidebarMenuSub,\n  SidebarMenuSubButton,\n  SidebarMenuSubItem,\n  SidebarProvider,\n  SidebarRail,\n  SidebarSeparator,\n  SidebarTrigger,\n  useSidebar,\n}\n","size_bytes":21846},"client/src/components/ui/context-menu.tsx":{"content":"import * as React from \"react\"\nimport * as ContextMenuPrimitive from \"@radix-ui/react-context-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ContextMenu = ContextMenuPrimitive.Root\n\nconst ContextMenuTrigger = ContextMenuPrimitive.Trigger\n\nconst ContextMenuGroup = ContextMenuPrimitive.Group\n\nconst ContextMenuPortal = ContextMenuPrimitive.Portal\n\nconst ContextMenuSub = ContextMenuPrimitive.Sub\n\nconst ContextMenuRadioGroup = ContextMenuPrimitive.RadioGroup\n\nconst ContextMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <ContextMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </ContextMenuPrimitive.SubTrigger>\n))\nContextMenuSubTrigger.displayName = ContextMenuPrimitive.SubTrigger.displayName\n\nconst ContextMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuSubContent.displayName = ContextMenuPrimitive.SubContent.displayName\n\nconst ContextMenuContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Portal>\n    <ContextMenuPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"z-50 max-h-[--radix-context-menu-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md animate-in fade-in-80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </ContextMenuPrimitive.Portal>\n))\nContextMenuContent.displayName = ContextMenuPrimitive.Content.displayName\n\nconst ContextMenuItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuItem.displayName = ContextMenuPrimitive.Item.displayName\n\nconst ContextMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <ContextMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.CheckboxItem>\n))\nContextMenuCheckboxItem.displayName =\n  ContextMenuPrimitive.CheckboxItem.displayName\n\nconst ContextMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <ContextMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.RadioItem>\n))\nContextMenuRadioItem.displayName = ContextMenuPrimitive.RadioItem.displayName\n\nconst ContextMenuLabel = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold text-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuLabel.displayName = ContextMenuPrimitive.Label.displayName\n\nconst ContextMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nContextMenuSeparator.displayName = ContextMenuPrimitive.Separator.displayName\n\nconst ContextMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nContextMenuShortcut.displayName = \"ContextMenuShortcut\"\n\nexport {\n  ContextMenu,\n  ContextMenuTrigger,\n  ContextMenuContent,\n  ContextMenuItem,\n  ContextMenuCheckboxItem,\n  ContextMenuRadioItem,\n  ContextMenuLabel,\n  ContextMenuSeparator,\n  ContextMenuShortcut,\n  ContextMenuGroup,\n  ContextMenuPortal,\n  ContextMenuSub,\n  ContextMenuSubContent,\n  ContextMenuSubTrigger,\n  ContextMenuRadioGroup,\n}\n","size_bytes":7428},"client/src/pages/admin/billing.tsx":{"content":"import { useEffect } from \"react\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { DollarSign, FileText } from \"lucide-react\";\n\nexport default function AdminBilling() {\n  const { toast } = useToast();\n  const { isAuthenticated, isLoading, user } = useAuth();\n\n  useEffect(() => {\n    if (!isLoading && (!isAuthenticated || user?.role !== \"admin\")) {\n      toast({\n        title: \"Unauthorized\",\n        description: \"Admin access required\",\n        variant: \"destructive\",\n      });\n      setTimeout(() => {\n        window.location.href = \"/\";\n      }, 500);\n      return;\n    }\n  }, [isAuthenticated, isLoading, user, toast]);\n\n  if (isLoading || !isAuthenticated || user?.role !== \"admin\") {\n    return (\n      <div className=\"flex h-screen items-center justify-center\">\n        <div className=\"animate-spin w-8 h-8 border-4 border-primary border-t-transparent rounded-full\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <div>\n        <h1 className=\"text-3xl font-semibold\">Billing Operations</h1>\n        <p className=\"text-muted-foreground mt-1\">Issue bills and manage collections</p>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <DollarSign className=\"h-6 w-6\" />\n            Billing Management\n          </CardTitle>\n          <CardDescription>Comprehensive billing operations coming soon</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"text-center py-12\">\n            <FileText className=\"h-16 w-16 mx-auto mb-4 text-muted-foreground opacity-50\" />\n            <p className=\"text-lg font-medium mb-2\">Billing Features</p>\n            <p className=\"text-muted-foreground mb-6\">\n              Issue monthly levies, track payments, and manage collections\n            </p>\n            <Button disabled data-testid=\"button-issue-bills\">\n              Coming Soon\n            </Button>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":2200},"client/src/components/ui/badge.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst badgeVariants = cva(\n  // Whitespace-nowrap: Badges should never wrap.\n  \"whitespace-nowrap inline-flex items-center rounded-md border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2\" +\n  \" hover-elevate \" ,\n  {\n    variants: {\n      variant: {\n        default:\n          \"border-transparent bg-primary text-primary-foreground shadow-xs\",\n        secondary: \"border-transparent bg-secondary text-secondary-foreground\",\n        destructive:\n          \"border-transparent bg-destructive text-destructive-foreground shadow-xs\",\n\n        outline: \" border [border-color:var(--badge-outline)] shadow-xs\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  },\n)\n\nexport interface BadgeProps\n  extends React.HTMLAttributes<HTMLDivElement>,\n    VariantProps<typeof badgeVariants> {}\n\nfunction Badge({ className, variant, ...props }: BadgeProps) {\n  return (\n    <div className={cn(badgeVariants({ variant }), className)} {...props} />\n  );\n}\n\nexport { Badge, badgeVariants }\n","size_bytes":1202},"client/src/pages/visitors.tsx":{"content":"import { useEffect, useState } from \"react\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Plus, QrCode, CheckCircle, XCircle, Clock } from \"lucide-react\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { isUnauthorizedError } from \"@/lib/authUtils\";\nimport type { Visitor, Resident } from \"@shared/schema\";\nimport QRCodeDisplay from \"@/components/qr-code-display\";\n\nexport default function Visitors() {\n  const { toast } = useToast();\n  const { isAuthenticated, isLoading } = useAuth();\n  const [open, setOpen] = useState(false);\n  const [selectedVisitor, setSelectedVisitor] = useState<Visitor | null>(null);\n  const [formData, setFormData] = useState({\n    visitorName: \"\",\n    visitorPhone: \"\",\n    purpose: \"\",\n    validFrom: new Date().toISOString().slice(0, 16),\n    validUntil: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString().slice(0, 16),\n  });\n\n  useEffect(() => {\n    if (!isLoading && !isAuthenticated) {\n      toast({\n        title: \"Unauthorized\",\n        description: \"You are logged out. Logging in again...\",\n        variant: \"destructive\",\n      });\n      setTimeout(() => {\n        window.location.href = \"/api/login\";\n      }, 500);\n      return;\n    }\n  }, [isAuthenticated, isLoading, toast]);\n\n  const { data: resident } = useQuery<Resident>({\n    queryKey: [\"/api/resident/profile\"],\n    enabled: isAuthenticated,\n  });\n\n  const { data: visitors = [] } = useQuery<Visitor[]>({\n    queryKey: [\"/api/resident/visitors\"],\n    enabled: isAuthenticated,\n  });\n\n  const createVisitorMutation = useMutation({\n    mutationFn: async (data: typeof formData) => {\n      await apiRequest(\"POST\", \"/api/resident/visitors\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/resident/visitors\"] });\n      toast({\n        title: \"Success\",\n        description: \"Visitor access code generated successfully\",\n      });\n      setOpen(false);\n      setFormData({\n        visitorName: \"\",\n        visitorPhone: \"\",\n        purpose: \"\",\n        validFrom: new Date().toISOString().slice(0, 16),\n        validUntil: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString().slice(0, 16),\n      });\n    },\n    onError: (error: Error) => {\n      if (isUnauthorizedError(error)) {\n        toast({\n          title: \"Unauthorized\",\n          description: \"You are logged out. Logging in again...\",\n          variant: \"destructive\",\n        });\n        setTimeout(() => {\n          window.location.href = \"/api/login\";\n        }, 500);\n        return;\n      }\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to create visitor access\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  if (isLoading || !isAuthenticated) {\n    return (\n      <div className=\"flex h-screen items-center justify-center\">\n        <div className=\"animate-spin w-8 h-8 border-4 border-primary border-t-transparent rounded-full\" />\n      </div>\n    );\n  }\n\n  const canAddVisitor = resident?.accountStatus === \"active\";\n\n  const getStatusBadge = (visitor: Visitor) => {\n    if (visitor.status === \"used\") {\n      return <Badge variant=\"secondary\"><CheckCircle className=\"h-3 w-3 mr-1\" />Used</Badge>;\n    }\n    if (visitor.status === \"expired\") {\n      return <Badge variant=\"secondary\"><Clock className=\"h-3 w-3 mr-1\" />Expired</Badge>;\n    }\n    if (visitor.status === \"denied\") {\n      return <Badge variant=\"destructive\"><XCircle className=\"h-3 w-3 mr-1\" />Denied</Badge>;\n    }\n    if (new Date(visitor.validUntil) < new Date()) {\n      return <Badge variant=\"secondary\"><Clock className=\"h-3 w-3 mr-1\" />Expired</Badge>;\n    }\n    return <Badge className=\"bg-green-500 hover:bg-green-600\"><CheckCircle className=\"h-3 w-3 mr-1\" />Active</Badge>;\n  };\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    createVisitorMutation.mutate(formData);\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-semibold\">Visitor Management</h1>\n          <p className=\"text-muted-foreground mt-1\">Pre-approve visitors and manage access</p>\n        </div>\n        <Dialog open={open} onOpenChange={setOpen}>\n          <DialogTrigger asChild>\n            <Button disabled={!canAddVisitor} data-testid=\"button-add-visitor\">\n              <Plus className=\"h-4 w-4 mr-2\" />\n              Pre-approve Visitor\n            </Button>\n          </DialogTrigger>\n          <DialogContent className=\"sm:max-w-[500px]\">\n            <form onSubmit={handleSubmit}>\n              <DialogHeader>\n                <DialogTitle>Pre-approve Visitor</DialogTitle>\n                <DialogDescription>\n                  Generate a secure QR code for your visitor. They can use this at the gate.\n                </DialogDescription>\n              </DialogHeader>\n              <div className=\"grid gap-4 py-4\">\n                <div className=\"grid gap-2\">\n                  <Label htmlFor=\"visitorName\">Visitor Name *</Label>\n                  <Input\n                    id=\"visitorName\"\n                    value={formData.visitorName}\n                    onChange={(e) => setFormData({ ...formData, visitorName: e.target.value })}\n                    required\n                    data-testid=\"input-visitor-name\"\n                  />\n                </div>\n                <div className=\"grid gap-2\">\n                  <Label htmlFor=\"visitorPhone\">Phone Number</Label>\n                  <Input\n                    id=\"visitorPhone\"\n                    type=\"tel\"\n                    value={formData.visitorPhone}\n                    onChange={(e) => setFormData({ ...formData, visitorPhone: e.target.value })}\n                    data-testid=\"input-visitor-phone\"\n                  />\n                </div>\n                <div className=\"grid gap-2\">\n                  <Label htmlFor=\"purpose\">Purpose of Visit</Label>\n                  <Textarea\n                    id=\"purpose\"\n                    value={formData.purpose}\n                    onChange={(e) => setFormData({ ...formData, purpose: e.target.value })}\n                    data-testid=\"input-purpose\"\n                  />\n                </div>\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div className=\"grid gap-2\">\n                    <Label htmlFor=\"validFrom\">Valid From</Label>\n                    <Input\n                      id=\"validFrom\"\n                      type=\"datetime-local\"\n                      value={formData.validFrom}\n                      onChange={(e) => setFormData({ ...formData, validFrom: e.target.value })}\n                      required\n                      data-testid=\"input-valid-from\"\n                    />\n                  </div>\n                  <div className=\"grid gap-2\">\n                    <Label htmlFor=\"validUntil\">Valid Until</Label>\n                    <Input\n                      id=\"validUntil\"\n                      type=\"datetime-local\"\n                      value={formData.validUntil}\n                      onChange={(e) => setFormData({ ...formData, validUntil: e.target.value })}\n                      required\n                      data-testid=\"input-valid-until\"\n                    />\n                  </div>\n                </div>\n              </div>\n              <DialogFooter>\n                <Button type=\"button\" variant=\"outline\" onClick={() => setOpen(false)}>\n                  Cancel\n                </Button>\n                <Button type=\"submit\" disabled={createVisitorMutation.isPending} data-testid=\"button-submit-visitor\">\n                  {createVisitorMutation.isPending ? \"Generating...\" : \"Generate Access Code\"}\n                </Button>\n              </DialogFooter>\n            </form>\n          </DialogContent>\n        </Dialog>\n      </div>\n\n      {!canAddVisitor && (\n        <Card className=\"border-destructive\">\n          <CardContent className=\"pt-6\">\n            <div className=\"flex items-center gap-3\">\n              <XCircle className=\"h-5 w-5 text-destructive\" />\n              <div>\n                <p className=\"font-medium\">Visitor access temporarily restricted</p>\n                <p className=\"text-sm text-muted-foreground\">\n                  Please settle your outstanding balance to pre-approve visitors.\n                </p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      )}\n\n      {/* Visitors List */}\n      <Card>\n        <CardHeader>\n          <CardTitle>My Visitors</CardTitle>\n          <CardDescription>All pre-approved visitor access codes</CardDescription>\n        </CardHeader>\n        <CardContent>\n          {visitors.length === 0 ? (\n            <div className=\"text-center py-12 text-muted-foreground\">\n              <QrCode className=\"h-16 w-16 mx-auto mb-4 opacity-50\" />\n              <p className=\"text-lg\">No visitors yet</p>\n              <p className=\"text-sm mt-1\">Pre-approve visitors to generate QR access codes</p>\n            </div>\n          ) : (\n            <div className=\"space-y-4\">\n              {visitors.map((visitor) => (\n                <div\n                  key={visitor.id}\n                  className=\"flex flex-col md:flex-row md:items-center justify-between p-6 rounded-lg border hover-elevate gap-4\"\n                  data-testid={`visitor-${visitor.id}`}\n                >\n                  <div className=\"flex-1\">\n                    <div className=\"flex items-center gap-3 mb-2\">\n                      <QrCode className=\"h-5 w-5 text-muted-foreground\" />\n                      <h3 className=\"font-semibold text-lg\">{visitor.visitorName}</h3>\n                      {getStatusBadge(visitor)}\n                    </div>\n                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-2 text-sm text-muted-foreground\">\n                      {visitor.visitorPhone && <p>Phone: {visitor.visitorPhone}</p>}\n                      {visitor.purpose && <p>Purpose: {visitor.purpose}</p>}\n                      <p>Valid: {new Date(visitor.validFrom).toLocaleString()}</p>\n                      <p>Until: {new Date(visitor.validUntil).toLocaleString()}</p>\n                    </div>\n                  </div>\n                  <div className=\"flex gap-2\">\n                    <Button\n                      size=\"sm\"\n                      variant=\"outline\"\n                      onClick={() => setSelectedVisitor(visitor)}\n                      data-testid={`button-view-qr-${visitor.id}`}\n                    >\n                      <QrCode className=\"h-4 w-4 mr-1\" />\n                      View QR\n                    </Button>\n                  </div>\n                </div>\n              ))}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* QR Code Display Dialog */}\n      {selectedVisitor && (\n        <QRCodeDisplay\n          visitor={selectedVisitor}\n          open={!!selectedVisitor}\n          onClose={() => setSelectedVisitor(null)}\n        />\n      )}\n    </div>\n  );\n}\n","size_bytes":11605},"client/src/components/ui/command.tsx":{"content":"import * as React from \"react\"\nimport { type DialogProps } from \"@radix-ui/react-dialog\"\nimport { Command as CommandPrimitive } from \"cmdk\"\nimport { Search } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Dialog, DialogContent } from \"@/components/ui/dialog\"\n\nconst Command = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nCommand.displayName = CommandPrimitive.displayName\n\nconst CommandDialog = ({ children, ...props }: DialogProps) => {\n  return (\n    <Dialog {...props}>\n      <DialogContent className=\"overflow-hidden p-0 shadow-lg\">\n        <Command className=\"[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5\">\n          {children}\n        </Command>\n      </DialogContent>\n    </Dialog>\n  )\n}\n\nconst CommandInput = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Input>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>\n>(({ className, ...props }, ref) => (\n  <div className=\"flex items-center border-b px-3\" cmdk-input-wrapper=\"\">\n    <Search className=\"mr-2 h-4 w-4 shrink-0 opacity-50\" />\n    <CommandPrimitive.Input\n      ref={ref}\n      className={cn(\n        \"flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    />\n  </div>\n))\n\nCommandInput.displayName = CommandPrimitive.Input.displayName\n\nconst CommandList = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.List\n    ref={ref}\n    className={cn(\"max-h-[300px] overflow-y-auto overflow-x-hidden\", className)}\n    {...props}\n  />\n))\n\nCommandList.displayName = CommandPrimitive.List.displayName\n\nconst CommandEmpty = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Empty>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>\n>((props, ref) => (\n  <CommandPrimitive.Empty\n    ref={ref}\n    className=\"py-6 text-center text-sm\"\n    {...props}\n  />\n))\n\nCommandEmpty.displayName = CommandPrimitive.Empty.displayName\n\nconst CommandGroup = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Group>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Group\n    ref={ref}\n    className={cn(\n      \"overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandGroup.displayName = CommandPrimitive.Group.displayName\n\nconst CommandSeparator = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nCommandSeparator.displayName = CommandPrimitive.Separator.displayName\n\nconst CommandItem = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected='true']:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandItem.displayName = CommandPrimitive.Item.displayName\n\nconst CommandShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nCommandShortcut.displayName = \"CommandShortcut\"\n\nexport {\n  Command,\n  CommandDialog,\n  CommandInput,\n  CommandList,\n  CommandEmpty,\n  CommandGroup,\n  CommandItem,\n  CommandShortcut,\n  CommandSeparator,\n}\n","size_bytes":4885},"client/src/components/ui/select.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SelectPrimitive from \"@radix-ui/react-select\"\nimport { Check, ChevronDown, ChevronUp } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Select = SelectPrimitive.Root\n\nconst SelectGroup = SelectPrimitive.Group\n\nconst SelectValue = SelectPrimitive.Value\n\nconst SelectTrigger = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex h-9 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background data-[placeholder]:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <SelectPrimitive.Icon asChild>\n      <ChevronDown className=\"h-4 w-4 opacity-50\" />\n    </SelectPrimitive.Icon>\n  </SelectPrimitive.Trigger>\n))\nSelectTrigger.displayName = SelectPrimitive.Trigger.displayName\n\nconst SelectScrollUpButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollUpButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronUp className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollUpButton>\n))\nSelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName\n\nconst SelectScrollDownButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollDownButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronDown className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollDownButton>\n))\nSelectScrollDownButton.displayName =\n  SelectPrimitive.ScrollDownButton.displayName\n\nconst SelectContent = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>\n>(({ className, children, position = \"popper\", ...props }, ref) => (\n  <SelectPrimitive.Portal>\n    <SelectPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"relative z-50 max-h-[--radix-select-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-select-content-transform-origin]\",\n        position === \"popper\" &&\n          \"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1\",\n        className\n      )}\n      position={position}\n      {...props}\n    >\n      <SelectScrollUpButton />\n      <SelectPrimitive.Viewport\n        className={cn(\n          \"p-1\",\n          position === \"popper\" &&\n            \"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]\"\n        )}\n      >\n        {children}\n      </SelectPrimitive.Viewport>\n      <SelectScrollDownButton />\n    </SelectPrimitive.Content>\n  </SelectPrimitive.Portal>\n))\nSelectContent.displayName = SelectPrimitive.Content.displayName\n\nconst SelectLabel = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Label\n    ref={ref}\n    className={cn(\"py-1.5 pl-8 pr-2 text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nSelectLabel.displayName = SelectPrimitive.Label.displayName\n\nconst SelectItem = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <SelectPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </SelectPrimitive.ItemIndicator>\n    </span>\n\n    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>\n  </SelectPrimitive.Item>\n))\nSelectItem.displayName = SelectPrimitive.Item.displayName\n\nconst SelectSeparator = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nSelectSeparator.displayName = SelectPrimitive.Separator.displayName\n\nexport {\n  Select,\n  SelectGroup,\n  SelectValue,\n  SelectTrigger,\n  SelectContent,\n  SelectLabel,\n  SelectItem,\n  SelectSeparator,\n  SelectScrollUpButton,\n  SelectScrollDownButton,\n}\n","size_bytes":5741},"client/src/pages/qr-scanner.tsx":{"content":"import { useEffect, useState } from \"react\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { QrCode, CheckCircle, XCircle, AlertCircle } from \"lucide-react\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { isUnauthorizedError } from \"@/lib/authUtils\";\n\nexport default function QRScanner() {\n  const { toast } = useToast();\n  const { isAuthenticated, isLoading, user } = useAuth();\n  const [accessCode, setAccessCode] = useState(\"\");\n  const [verificationResult, setVerificationResult] = useState<any>(null);\n\n  useEffect(() => {\n    if (!isLoading && (!isAuthenticated || user?.role !== \"security\")) {\n      toast({\n        title: \"Unauthorized\",\n        description: \"Security access required\",\n        variant: \"destructive\",\n      });\n      setTimeout(() => {\n        window.location.href = \"/\";\n      }, 500);\n      return;\n    }\n  }, [isAuthenticated, isLoading, user, toast]);\n\n  const verifyMutation = useMutation({\n    mutationFn: async (code: string) => {\n      const response = await apiRequest(\"POST\", \"/api/security/verify\", { accessCode: code });\n      return response.json();\n    },\n    onSuccess: (data) => {\n      setVerificationResult(data);\n      queryClient.invalidateQueries({ queryKey: [\"/api/security/logs/recent\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/security/visitors/today\"] });\n      \n      if (data.valid) {\n        toast({\n          title: \"Access Granted\",\n          description: `${data.visitor.visitorName} verified successfully`,\n        });\n      } else {\n        toast({\n          title: \"Access Denied\",\n          description: data.reason || \"Invalid or expired access code\",\n          variant: \"destructive\",\n        });\n      }\n    },\n    onError: (error: Error) => {\n      if (isUnauthorizedError(error)) {\n        toast({\n          title: \"Unauthorized\",\n          description: \"You are logged out. Logging in again...\",\n          variant: \"destructive\",\n        });\n        setTimeout(() => {\n          window.location.href = \"/api/login\";\n        }, 500);\n        return;\n      }\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to verify access code\",\n        variant: \"destructive\",\n      });\n      setVerificationResult({ valid: false, reason: \"Verification failed\" });\n    },\n  });\n\n  if (isLoading || !isAuthenticated || user?.role !== \"security\") {\n    return (\n      <div className=\"flex h-screen items-center justify-center\">\n        <div className=\"animate-spin w-8 h-8 border-4 border-primary border-t-transparent rounded-full\" />\n      </div>\n    );\n  }\n\n  const handleVerify = (e: React.FormEvent) => {\n    e.preventDefault();\n    if (accessCode.trim()) {\n      verifyMutation.mutate(accessCode.trim());\n    }\n  };\n\n  const handleReset = () => {\n    setAccessCode(\"\");\n    setVerificationResult(null);\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Header */}\n      <div>\n        <h1 className=\"text-3xl font-semibold\">QR Code Scanner</h1>\n        <p className=\"text-muted-foreground mt-1\">Verify visitor access codes at the gate</p>\n      </div>\n\n      {/* Scanner Card */}\n      <Card className=\"max-w-2xl mx-auto\">\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <QrCode className=\"h-6 w-6\" />\n            Access Code Verification\n          </CardTitle>\n          <CardDescription>\n            Scan the visitor's QR code or enter the access code manually\n          </CardDescription>\n        </CardHeader>\n        <CardContent className=\"space-y-6\">\n          {/* Manual Input Form */}\n          <form onSubmit={handleVerify} className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"accessCode\">Access Code</Label>\n              <Input\n                id=\"accessCode\"\n                value={accessCode}\n                onChange={(e) => setAccessCode(e.target.value.toUpperCase())}\n                placeholder=\"Enter access code...\"\n                className=\"text-lg font-mono\"\n                autoFocus\n                data-testid=\"input-access-code\"\n              />\n            </div>\n            <Button\n              type=\"submit\"\n              className=\"w-full\"\n              size=\"lg\"\n              disabled={!accessCode.trim() || verifyMutation.isPending}\n              data-testid=\"button-verify\"\n            >\n              {verifyMutation.isPending ? \"Verifying...\" : \"Verify Access Code\"}\n            </Button>\n          </form>\n\n          {/* Verification Result */}\n          {verificationResult && (\n            <div className={`p-6 rounded-lg border-2 ${\n              verificationResult.valid \n                ? \"border-green-500 bg-green-50 dark:bg-green-950\" \n                : \"border-red-500 bg-red-50 dark:bg-red-950\"\n            }`}>\n              <div className=\"flex items-center gap-3 mb-4\">\n                {verificationResult.valid ? (\n                  <>\n                    <CheckCircle className=\"h-8 w-8 text-green-600 dark:text-green-400\" />\n                    <div>\n                      <h3 className=\"text-xl font-semibold text-green-900 dark:text-green-100\">\n                        Access Granted\n                      </h3>\n                      <p className=\"text-sm text-green-700 dark:text-green-300\">\n                        Visitor verified successfully\n                      </p>\n                    </div>\n                  </>\n                ) : (\n                  <>\n                    <XCircle className=\"h-8 w-8 text-red-600 dark:text-red-400\" />\n                    <div>\n                      <h3 className=\"text-xl font-semibold text-red-900 dark:text-red-100\">\n                        Access Denied\n                      </h3>\n                      <p className=\"text-sm text-red-700 dark:text-red-300\">\n                        {verificationResult.reason || \"Invalid access code\"}\n                      </p>\n                    </div>\n                  </>\n                )}\n              </div>\n\n              {verificationResult.valid && verificationResult.visitor && (\n                <div className=\"space-y-3 mt-4 p-4 bg-white dark:bg-gray-900 rounded-lg\">\n                  <div className=\"grid grid-cols-2 gap-3 text-sm\">\n                    <div>\n                      <p className=\"text-muted-foreground\">Visitor Name</p>\n                      <p className=\"font-semibold\" data-testid=\"text-visitor-name\">\n                        {verificationResult.visitor.visitorName}\n                      </p>\n                    </div>\n                    {verificationResult.visitor.visitorPhone && (\n                      <div>\n                        <p className=\"text-muted-foreground\">Phone</p>\n                        <p className=\"font-semibold\">{verificationResult.visitor.visitorPhone}</p>\n                      </div>\n                    )}\n                    <div>\n                      <p className=\"text-muted-foreground\">Visiting Unit</p>\n                      <p className=\"font-semibold\" data-testid=\"text-unit-number\">\n                        {verificationResult.unitNumber || \"—\"}\n                      </p>\n                    </div>\n                    <div>\n                      <p className=\"text-muted-foreground\">Valid Until</p>\n                      <p className=\"font-semibold\">\n                        {new Date(verificationResult.visitor.validUntil).toLocaleString()}\n                      </p>\n                    </div>\n                    {verificationResult.visitor.purpose && (\n                      <div className=\"col-span-2\">\n                        <p className=\"text-muted-foreground\">Purpose</p>\n                        <p className=\"font-semibold\">{verificationResult.visitor.purpose}</p>\n                      </div>\n                    )}\n                  </div>\n                </div>\n              )}\n\n              <Button\n                onClick={handleReset}\n                className=\"w-full mt-4\"\n                variant=\"outline\"\n                data-testid=\"button-reset\"\n              >\n                Scan Another Code\n              </Button>\n            </div>\n          )}\n\n          {/* Instructions */}\n          <div className=\"p-4 bg-muted rounded-lg\">\n            <div className=\"flex items-start gap-3\">\n              <AlertCircle className=\"h-5 w-5 text-muted-foreground mt-0.5\" />\n              <div className=\"text-sm space-y-1\">\n                <p className=\"font-medium\">Verification Instructions</p>\n                <ul className=\"list-disc list-inside space-y-1 text-muted-foreground\">\n                  <li>Ask the visitor to show their QR code</li>\n                  <li>Scan the code or enter the access code manually</li>\n                  <li>Verify the visitor's identity matches the displayed information</li>\n                  <li>Grant entry if all details are correct and code is valid</li>\n                </ul>\n              </div>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":9386},"client/src/components/ui/avatar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as AvatarPrimitive from \"@radix-ui/react-avatar\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Avatar = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Root\n    ref={ref}\n    className={cn(`\n      after:content-[''] after:block after:absolute after:inset-0 after:rounded-full after:pointer-events-none after:border after:border-black/10 dark:after:border-white/10\n      relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full`,\n      className\n    )}\n    {...props}\n  />\n))\nAvatar.displayName = AvatarPrimitive.Root.displayName\n\nconst AvatarImage = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Image>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Image\n    ref={ref}\n    className={cn(\"aspect-square h-full w-full\", className)}\n    {...props}\n  />\n))\nAvatarImage.displayName = AvatarPrimitive.Image.displayName\n\nconst AvatarFallback = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Fallback>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Fallback\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full items-center justify-center rounded-full bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatarFallback.displayName = AvatarPrimitive.Fallback.displayName\n\nexport { Avatar, AvatarImage, AvatarFallback }\n","size_bytes":1592},"client/src/components/ui/resizable.tsx":{"content":"\"use client\"\n\nimport { GripVertical } from \"lucide-react\"\nimport * as ResizablePrimitive from \"react-resizable-panels\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ResizablePanelGroup = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) => (\n  <ResizablePrimitive.PanelGroup\n    className={cn(\n      \"flex h-full w-full data-[panel-group-direction=vertical]:flex-col\",\n      className\n    )}\n    {...props}\n  />\n)\n\nconst ResizablePanel = ResizablePrimitive.Panel\n\nconst ResizableHandle = ({\n  withHandle,\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {\n  withHandle?: boolean\n}) => (\n  <ResizablePrimitive.PanelResizeHandle\n    className={cn(\n      \"relative flex w-px items-center justify-center bg-border after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0 [&[data-panel-group-direction=vertical]>div]:rotate-90\",\n      className\n    )}\n    {...props}\n  >\n    {withHandle && (\n      <div className=\"z-10 flex h-4 w-3 items-center justify-center rounded-sm border bg-border\">\n        <GripVertical className=\"h-2.5 w-2.5\" />\n      </div>\n    )}\n  </ResizablePrimitive.PanelResizeHandle>\n)\n\nexport { ResizablePanelGroup, ResizablePanel, ResizableHandle }\n","size_bytes":1723},"design_guidelines.md":{"content":"# Estate Management System - Design Guidelines\n\n## Design Approach\n**System-Based Approach**: Material Design principles with Tailwind UI patterns\n**Rationale**: Information-dense management application requiring clear hierarchy, consistent patterns, and efficient data display across three distinct user roles.\n\n## Typography\n- **Font Family**: Inter (primary), system-ui fallback\n- **Scale**: \n  - Headers: text-2xl to text-4xl, font-semibold\n  - Body: text-base, font-normal\n  - Labels/Meta: text-sm, font-medium\n  - Data/Numbers: text-lg, font-semibold (for financial figures)\n\n## Layout System\n**Spacing Primitives**: Use Tailwind units of 2, 4, 6, 8, 12, and 16 consistently\n- Component padding: p-4 to p-6\n- Section spacing: gap-6 to gap-8\n- Page margins: px-4 md:px-8\n- Card spacing: p-6\n\n**Grid Structure**:\n- Dashboard cards: grid-cols-1 md:grid-cols-2 lg:grid-cols-3\n- Data tables: Full-width with horizontal scroll on mobile\n- Forms: Single column on mobile, 2-column on desktop (grid-cols-1 md:grid-cols-2)\n\n## Core Components\n\n### Navigation\n- **Sidebar Navigation** (Desktop): Fixed left sidebar (w-64) with role-based menu items, user profile at bottom, estate logo at top\n- **Mobile**: Bottom tab bar with 4-5 primary actions, hamburger menu for secondary items\n- Active states with subtle background fill and border accent\n\n### Dashboard Cards\n- Elevated cards with rounded corners (rounded-lg)\n- Header with icon + title + action button\n- Key metrics displayed prominently (text-3xl for numbers)\n- Trend indicators (up/down arrows with percentage)\n- Quick action buttons at card footer\n\n### Data Tables\n- Sticky header row\n- Alternating row backgrounds for readability\n- Status badges (paid/pending/overdue) with distinct visual treatments\n- Row actions menu (three-dot overflow)\n- Pagination at bottom with results counter\n- Mobile: Convert to stacked cards with key info visible\n\n### Forms\n- Clear section grouping with headings\n- Floating labels or top-aligned labels\n- Input fields with consistent height (h-10 to h-12)\n- Helper text below fields\n- Validation states with inline error messages\n- Primary action buttons at bottom right\n\n### Status Indicators\n- **Payment Status**: \n  - Paid: Green badge with checkmark\n  - Pending: Yellow/amber badge with clock icon\n  - Overdue: Red badge with alert icon\n- **Account Status**: Colored dots or badges (Active: green, Inactive: gray, Delinquent: red)\n- **Visitor Access**: QR code display in modal with expiry timer\n\n### Modals & Overlays\n- Centered modals (max-w-lg to max-w-2xl)\n- Semi-transparent backdrop\n- Header with title + close button\n- Scrollable content area\n- Sticky footer with actions\n\n### Notifications\n- Toast notifications: Top-right corner, auto-dismiss after 5s\n- In-app notification center: Bell icon with badge counter\n- Notification list: Avatar + message + timestamp, unread indicator\n\n### QR Code Generation\n- Large, centered QR code display (256x256 or larger)\n- Visitor details card above code (name, purpose, validity period)\n- Download/share buttons below\n- Countdown timer for expiring codes\n\n## Role-Specific Dashboards\n\n### Resident Dashboard\n- Welcome card with account status and outstanding balance\n- Quick pay button prominently displayed if balance due\n- Recent bills table (last 3-5 entries)\n- Visitor management section with \"Pre-approve Visitor\" CTA\n- Announcement/notification feed\n\n### Admin Dashboard\n- Key metrics row: Total residents, collection rate, pending payments, active visitors\n- Recent activities timeline\n- Quick actions: Issue bills, Send announcement, Add resident\n- Delinquency report table with action buttons\n- Charts: Payment trends, occupancy rate\n\n### Security Dashboard\n- Visitor verification scanner (camera or manual code entry)\n- Today's approved visitors list with search/filter\n- Resident lookup tool with access status indicator\n- Recent gate activity log\n- Quick actions: Log entry, Report incident\n\n## Interactive Elements\n- **Buttons**: \n  - Primary: Solid fill, medium weight\n  - Secondary: Outlined\n  - Text: No border, underline on hover\n  - Sizes: h-10 (default), h-12 (prominent CTAs)\n- **Links**: Underline on hover, medium font weight\n- **Hover States**: Subtle background lightening, no dramatic transitions\n- **Loading States**: Spinner or skeleton screens for data-heavy sections\n\n## Responsive Behavior\n- Breakpoints: sm (640px), md (768px), lg (1024px), xl (1280px)\n- Mobile-first approach: Stack layouts vertically, full-width cards\n- Hide secondary navigation on mobile, prioritize core actions\n- Touch-friendly targets: min 44x44px for buttons and interactive elements\n\n## Accessibility\n- ARIA labels for all interactive elements\n- Keyboard navigation support (focus states visible)\n- Form inputs with proper labels and error associations\n- Sufficient color contrast (WCAG AA minimum)\n- Screen reader announcements for dynamic content updates\n\n## Special Features\n- **Payment Integration**: Stripe elements styled to match application theme\n- **QR Scanner**: Full-screen camera overlay with targeting guide\n- **Real-time Updates**: Subtle pulse animation for new notifications\n- **Print Receipts**: Clean, printer-friendly CSS for payment receipts and statements\n\n## Content Density\nThis is a data-rich application - embrace information density:\n- Tables can show 10-15 rows per page\n- Dashboard cards display multiple metrics\n- Use progressive disclosure: summary view → detailed view on click\n- Filters and search always visible for large datasets","size_bytes":5509},"TESTING.md":{"content":"# Testing Guide - Estate Management System\n\n## Test Credentials Created\n\nThree test user accounts have been created in your database:\n\n### 1. Admin Account\n- **Email:** admin@estatetest.com\n- **Role:** Estate Administrator\n- **Access:** Full system access, resident management, billing, reports\n\n### 2. Resident Account  \n- **Email:** resident@estatetest.com\n- **Role:** Resident\n- **Unit:** A-101\n- **Access:** Personal bills, visitor management, notifications\n- **Test Data:** Has 1 pending bill for ₦5,000.00 due in 30 days\n\n### 3. Security Account\n- **Email:** security@estatetest.com\n- **Role:** Security Personnel\n- **Access:** QR scanner, visitor verification, access logs\n\n---\n\n## How to Test (Important!)\n\nSince this application uses **Replit Auth (OIDC)**, you cannot simply \"login\" with username/password. Here's how to test:\n\n### Option 1: Quick Testing with Your Account\n\n1. **Sign in** with your Replit account (Click \"Sign In\" on landing page)\n2. Your account will be created automatically with the **\"resident\" role**\n3. **Manually update your role** in the database to test other roles:\n\n   ```bash\n   # Open the database console in Replit\n   # Run this SQL to make yourself an admin:\n   UPDATE users SET role = 'admin' WHERE email = 'your-replit-email@example.com';\n   \n   # Or make yourself security:\n   UPDATE users SET role = 'security' WHERE email = 'your-replit-email@example.com';\n   \n   # To go back to resident:\n   UPDATE users SET role = 'resident' WHERE email = 'your-replit-email@example.com';\n   ```\n\n4. **Refresh the page** after changing your role\n\n### Option 2: Testing with Replit Accounts Matching Test Emails\n\nIf you have Replit accounts with emails matching the test accounts:\n- admin@estatetest.com\n- resident@estatetest.com  \n- security@estatetest.com\n\nYou can sign in with Replit Auth and your account will automatically match these test users.\n\n---\n\n## Testing Different Roles\n\n### Testing as Admin\n1. Update your role to `admin` (see above)\n2. Refresh the page\n3. You'll see:\n   - Admin Dashboard with estate statistics\n   - Resident Management (add, edit residents)\n   - Billing Operations (create bills, track payments)\n   - Reports & Analytics\n   - Announcements\n\n### Testing as Resident\n1. Update your role to `resident` (see above)\n2. Create a resident profile if needed:\n   ```sql\n   INSERT INTO residents (user_id, unit_number, phone_number, account_status, total_balance)\n   VALUES ('your-user-id', 'B-202', '+234-800-000-0002', 'active', '0');\n   ```\n3. Refresh the page\n4. You'll see:\n   - Resident Dashboard with your bills and balance\n   - Bills page (view and pay bills)\n   - Visitors page (pre-approve visitors with QR codes)\n   - Notifications\n\n### Testing as Security\n1. Update your role to `security` (see above)\n2. Refresh the page  \n3. You'll see:\n   - Security Dashboard with recent activities\n   - QR Scanner (scan visitor QR codes)\n   - Access Logs\n   - Manual entry logging\n\n---\n\n## Quick Database Commands\n\n### Check your current user info:\n```sql\nSELECT * FROM users WHERE email = 'your-email@example.com';\n```\n\n### View all test users:\n```sql\nSELECT id, email, first_name, last_name, role FROM users;\n```\n\n### View resident profiles:\n```sql\nSELECT r.*, u.email, u.first_name, u.last_name \nFROM residents r \nJOIN users u ON r.user_id = u.id;\n```\n\n### View all bills:\n```sql\nSELECT b.*, r.unit_number \nFROM bills b \nJOIN residents r ON b.resident_id = r.id;\n```\n\n---\n\n## Re-seeding Test Data\n\nIf you need to recreate the test accounts, run:\n\n```bash\ntsx server/seed.ts\n```\n\nThis will create the test users if they don't already exist, or skip if they do.\n\n---\n\n## Testing Scenarios\n\n### Test Delinquency Flow\n1. Sign in as admin\n2. Create a bill for a resident with a past due date\n3. The resident's status will automatically change to \"delinquent\"\n4. Sign in as that resident  \n5. Try to pre-approve a visitor - it should be blocked\n6. Sign in as admin and mark the bill as paid\n7. The resident's status returns to \"active\"\n8. They can now pre-approve visitors again\n\n### Test Visitor QR Flow\n1. Sign in as resident\n2. Pre-approve a visitor (get QR code)\n3. Sign in as security\n4. Go to QR Scanner\n5. Scan/verify the QR code\n6. Log the visitor entry\n\n### Test Payment Processing\n1. Sign in as resident\n2. View pending bills\n3. Click \"Pay Now\" (requires Stripe integration - coming soon)\n4. Complete payment\n5. Bill status updates to \"paid\"\n\n---\n\n## Need Help?\n\nIf you encounter issues:\n1. Check browser console for errors\n2. Check server logs in the Replit console\n3. Verify your role is set correctly in the database\n4. Make sure you've refreshed the page after role changes\n","size_bytes":4645},"server/seed.ts":{"content":"import { db } from \"./db\";\nimport { users, residents, bills } from \"@shared/schema\";\nimport { eq } from \"drizzle-orm\";\n\nasync function seed() {\n  console.log(\"🌱 Starting database seed...\");\n\n  // Check if seed users already exist\n  const existingAdmin = await db.select().from(users).where(eq(users.email, \"admin@estatetest.com\"));\n  const existingResident = await db.select().from(users).where(eq(users.email, \"resident@estatetest.com\"));\n  const existingSecurity = await db.select().from(users).where(eq(users.email, \"security@estatetest.com\"));\n\n  // Create Admin User\n  let adminUser;\n  if (existingAdmin.length === 0) {\n    const [admin] = await db.insert(users).values({\n      email: \"admin@estatetest.com\",\n      firstName: \"Test\",\n      lastName: \"Admin\",\n      role: \"admin\",\n    }).returning();\n    adminUser = admin;\n    console.log(\"✅ Admin user created: admin@estatetest.com\");\n  } else {\n    adminUser = existingAdmin[0];\n    console.log(\"ℹ️  Admin user already exists: admin@estatetest.com\");\n  }\n\n  // Create Resident User\n  let residentUser;\n  if (existingResident.length === 0) {\n    const [resident] = await db.insert(users).values({\n      email: \"resident@estatetest.com\",\n      firstName: \"Test\",\n      lastName: \"Resident\",\n      role: \"resident\",\n    }).returning();\n    residentUser = resident;\n    console.log(\"✅ Resident user created: resident@estatetest.com\");\n\n    // Create resident profile\n    const [residentProfile] = await db.insert(residents).values({\n      userId: resident.id,\n      unitNumber: \"A-101\",\n      phoneNumber: \"+234-800-000-0001\",\n      accountStatus: \"active\",\n      totalBalance: \"0\",\n    }).returning();\n    console.log(\"✅ Resident profile created for unit A-101\");\n\n    // Create a sample bill for the resident\n    const dueDate = new Date();\n    dueDate.setDate(dueDate.getDate() + 30); // 30 days from now\n    \n    const periodStart = new Date();\n    const periodEnd = new Date();\n    periodEnd.setMonth(periodEnd.getMonth() + 1); // 1 month period\n\n    await db.insert(bills).values({\n      residentId: residentProfile.id,\n      amount: \"5000.00\",\n      dueDate: dueDate,\n      status: \"pending\",\n      description: \"Monthly Levy - December 2024\",\n      periodStart: periodStart,\n      periodEnd: periodEnd,\n    });\n    console.log(\"✅ Sample bill created for resident\");\n  } else {\n    residentUser = existingResident[0];\n    console.log(\"ℹ️  Resident user already exists: resident@estatetest.com\");\n  }\n\n  // Create Security User\n  let securityUser;\n  if (existingSecurity.length === 0) {\n    const [security] = await db.insert(users).values({\n      email: \"security@estatetest.com\",\n      firstName: \"Test\",\n      lastName: \"Security\",\n      role: \"security\",\n    }).returning();\n    securityUser = security;\n    console.log(\"✅ Security user created: security@estatetest.com\");\n  } else {\n    securityUser = existingSecurity[0];\n    console.log(\"ℹ️  Security user already exists: security@estatetest.com\");\n  }\n\n  console.log(\"\\n📋 Test Credentials Summary:\");\n  console.log(\"━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\");\n  console.log(\"Admin Account:\");\n  console.log(\"  Email: admin@estatetest.com\");\n  console.log(\"  Role: Estate Administrator\");\n  console.log(\"\");\n  console.log(\"Resident Account:\");\n  console.log(\"  Email: resident@estatetest.com\");\n  console.log(\"  Role: Resident\");\n  console.log(\"  Unit: A-101\");\n  console.log(\"\");\n  console.log(\"Security Account:\");\n  console.log(\"  Email: security@estatetest.com\");\n  console.log(\"  Role: Security Personnel\");\n  console.log(\"━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\");\n  console.log(\"\\n⚠️  IMPORTANT: To use these test accounts:\");\n  console.log(\"   1. Go to your Estate Management System\");\n  console.log(\"   2. Click 'Sign In'\");  \n  console.log(\"   3. Sign in with Replit Auth using the emails above\");\n  console.log(\"   4. Your account will be automatically matched to these test users\");\n  console.log(\"\\n✅ Seed completed successfully!\");\n}\n\nseed()\n  .catch((error) => {\n    console.error(\"❌ Error seeding database:\", error);\n    process.exit(1);\n  })\n  .finally(() => {\n    process.exit(0);\n  });\n","size_bytes":4330},"client/src/lib/currency.ts":{"content":"/**\n * Format a number as Nigerian Naira currency\n * @param amount - The amount to format\n * @param showSymbol - Whether to show the ₦ symbol (default: true)\n * @returns Formatted currency string\n */\nexport function formatNaira(amount: number | string, showSymbol: boolean = true): string {\n  const numAmount = typeof amount === 'string' ? parseFloat(amount) : amount;\n  const formatted = numAmount.toLocaleString('en-NG', {\n    minimumFractionDigits: 2,\n    maximumFractionDigits: 2,\n  });\n  \n  return showSymbol ? `₦${formatted}` : formatted;\n}\n\n/**\n * Parse a Naira amount string to a number\n * @param amount - The amount string to parse\n * @returns Parsed number\n */\nexport function parseNaira(amount: string): number {\n  return parseFloat(amount.replace(/[₦,]/g, ''));\n}\n","size_bytes":782},"client/src/pages/signup.tsx":{"content":"import { useState } from \"react\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Users } from \"lucide-react\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useLocation } from \"wouter\";\n\nexport default function Signup() {\n  const { toast } = useToast();\n  const { user, isLoading: authLoading } = useAuth();\n  const [, setLocation] = useLocation();\n  const [formData, setFormData] = useState({\n    unitNumber: \"\",\n    phoneNumber: \"\",\n    serviceCharge: \"\",\n  });\n\n  const signupMutation = useMutation({\n    mutationFn: async (data: { unitNumber: string; phoneNumber?: string; serviceCharge?: string }) => {\n      await apiRequest(\"POST\", \"/api/signup/complete\", data);\n    },\n    onSuccess: () => {\n      // Invalidate profile query so App.tsx can detect the new profile\n      queryClient.invalidateQueries({ queryKey: [\"/api/resident/profile\"] });\n      \n      toast({\n        title: \"Success\",\n        description: \"Your resident account has been set up successfully\",\n      });\n      // Redirect to resident dashboard\n      setLocation(\"/\");\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to complete signup\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  if (authLoading) {\n    return (\n      <div className=\"flex h-screen items-center justify-center\">\n        <div className=\"animate-spin w-8 h-8 border-4 border-primary border-t-transparent rounded-full\" />\n      </div>\n    );\n  }\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n\n    if (!formData.unitNumber.trim()) {\n      toast({\n        title: \"Validation Error\",\n        description: \"Please enter your unit number\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    signupMutation.mutate({\n      unitNumber: formData.unitNumber,\n      phoneNumber: formData.phoneNumber,\n      serviceCharge: formData.serviceCharge,\n    });\n  };\n\n  return (\n    <div className=\"flex min-h-screen items-center justify-center bg-background p-4\">\n      <Card className=\"w-full max-w-lg\">\n        <CardHeader className=\"text-center\">\n          <div className=\"mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-primary/10\">\n            <Users className=\"h-8 w-8 text-primary\" />\n          </div>\n          <CardTitle className=\"text-2xl\">Welcome to Estate Management</CardTitle>\n          <CardDescription>\n            Hi {user?.firstName}! Please complete your resident profile to get started.\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <form onSubmit={handleSubmit} className=\"space-y-6\">\n            {/* Resident Information */}\n            <div className=\"space-y-4\">\n              <div className=\"grid gap-2\">\n                <Label htmlFor=\"unitNumber\">\n                  Unit Number <span className=\"text-destructive\">*</span>\n                </Label>\n                <Input\n                  id=\"unitNumber\"\n                  placeholder=\"e.g., A-101, Unit No 2, B-205\"\n                  value={formData.unitNumber}\n                  onChange={(e) =>\n                    setFormData({ ...formData, unitNumber: e.target.value })\n                  }\n                  data-testid=\"input-unit-number\"\n                  required\n                  autoFocus\n                />\n                <p className=\"text-xs text-muted-foreground\">\n                  Enter your assigned unit number in the estate\n                </p>\n              </div>\n              <div className=\"grid gap-2\">\n                <Label htmlFor=\"phoneNumber\">Phone Number</Label>\n                <Input\n                  id=\"phoneNumber\"\n                  type=\"tel\"\n                  placeholder=\"e.g., +234 801 234 5678\"\n                  value={formData.phoneNumber}\n                  onChange={(e) =>\n                    setFormData({ ...formData, phoneNumber: e.target.value })\n                  }\n                  data-testid=\"input-phone-number\"\n                />\n                <p className=\"text-xs text-muted-foreground\">\n                  Optional: For notifications and contact purposes\n                </p>\n              </div>\n              <div className=\"grid gap-2\">\n                <Label htmlFor=\"serviceCharge\">Monthly Service Charge (₦)</Label>\n                <Input\n                  id=\"serviceCharge\"\n                  type=\"number\"\n                  placeholder=\"e.g., 50000\"\n                  value={formData.serviceCharge}\n                  onChange={(e) =>\n                    setFormData({ ...formData, serviceCharge: e.target.value })\n                  }\n                  data-testid=\"input-service-charge\"\n                  min=\"0\"\n                  step=\"0.01\"\n                />\n                <p className=\"text-xs text-muted-foreground\">\n                  Optional: Your monthly estate maintenance fee. Can be updated by admin later.\n                </p>\n              </div>\n            </div>\n\n            {/* Submit Button */}\n            <Button\n              type=\"submit\"\n              className=\"w-full\"\n              disabled={signupMutation.isPending}\n              data-testid=\"button-complete-signup\"\n            >\n              {signupMutation.isPending ? \"Setting up...\" : \"Complete Setup\"}\n            </Button>\n          </form>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":5722},"client/src/pages/admin/residents-list.tsx":{"content":"import { useEffect, useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useLocation } from \"wouter\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogFooter, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent, AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle } from \"@/components/ui/alert-dialog\";\nimport { Search, Eye, Edit, UserX, FileText, Calendar, Home, Phone, Mail, Users, Car, MapPin, User, AlertTriangle, Plus, Download } from \"lucide-react\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { isUnauthorizedError } from \"@/lib/authUtils\";\nimport type { Resident, Bill, Payment } from \"@shared/schema\";\n\ntype ResidentWithUser = Resident & { user: { id: string; email: string; firstName: string; lastName: string } };\n\nexport default function ResidentsListPage() {\n  const { user, isLoading: authLoading, isAuthenticated } = useAuth();\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  \n  const [addDialogOpen, setAddDialogOpen] = useState(false);\n  const [viewDialogOpen, setViewDialogOpen] = useState(false);\n  const [editDialogOpen, setEditDialogOpen] = useState(false);\n  const [deactivateDialogOpen, setDeactivateDialogOpen] = useState(false);\n  const [statementDialogOpen, setStatementDialogOpen] = useState(false);\n  const [invoicesDialogOpen, setInvoicesDialogOpen] = useState(false);\n  const [selectedResident, setSelectedResident] = useState<ResidentWithUser | null>(null);\n  \n  const [addFormData, setAddFormData] = useState({\n    email: \"\",\n    firstName: \"\",\n    lastName: \"\",\n    unitNumber: \"\",\n    streetName: \"\",\n    phoneNumber: \"\",\n    moveInDate: \"\",\n    occupancyType: \"owner\" as \"owner\" | \"tenant\",\n    numberOfOccupants: \"\",\n    propertySize: \"\",\n    bedrooms: \"\",\n    parkingSpaces: \"0\",\n    emergencyContactName: \"\",\n    emergencyContactPhone: \"\",\n    emergencyContactRelationship: \"\",\n    vehicles: \"\",\n    specialNotes: \"\",\n    serviceCharge: \"\",\n    startDate: \"\",\n  });\n\n  const [editForm, setEditForm] = useState({\n    unitNumber: \"\",\n    streetName: \"\",\n    phoneNumber: \"\",\n    occupancyType: \"\",\n    numberOfOccupants: \"\",\n    bedrooms: \"\",\n    parkingSpaces: \"\",\n    propertySize: \"\",\n    emergencyContactName: \"\",\n    emergencyContactPhone: \"\",\n    emergencyContactRelationship: \"\",\n    vehicles: \"\",\n    specialNotes: \"\",\n    serviceCharge: \"\",\n    startDate: \"\",\n  });\n\n  useEffect(() => {\n    if (!authLoading && (!isAuthenticated || user?.role !== \"admin\")) {\n      toast({\n        variant: \"destructive\",\n        title: \"Access Denied\",\n        description: \"Admin access required\",\n      });\n      setLocation(\"/\");\n    }\n  }, [authLoading, isAuthenticated, user, setLocation, toast]);\n\n  const { data: residentsData = [], isLoading } = useQuery<\n    Array<{ residents: Resident; users: { id: string; email: string; firstName: string; lastName: string } | null }>\n  >({\n    queryKey: [\"/api/admin/residents\"],\n    enabled: isAuthenticated && user?.role === \"admin\",\n  });\n\n  const residents = residentsData.map(item => ({\n    ...item.residents,\n    user: item.users || { id: '', email: '', firstName: '', lastName: '' }\n  }));\n\n  const filteredResidents = residents.filter(resident => {\n    const query = searchQuery.toLowerCase();\n    const fullName = `${resident.user.firstName} ${resident.user.lastName}`.toLowerCase();\n    const email = resident.user.email.toLowerCase();\n    const unitNumber = (resident.unitNumber ?? \"\").toLowerCase();\n    const phoneNumber = (resident.phoneNumber ?? \"\").toLowerCase();\n    \n    return fullName.includes(query) || \n           email.includes(query) || \n           unitNumber.includes(query) ||\n           phoneNumber.includes(query);\n  });\n\n  const createResidentMutation = useMutation({\n    mutationFn: async (data: typeof addFormData) => {\n      await apiRequest(\"POST\", \"/api/admin/residents\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/residents\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/stats\"] });\n      toast({ title: \"Success\", description: \"Resident added successfully\" });\n      setAddDialogOpen(false);\n      setAddFormData({\n        email: \"\",\n        firstName: \"\",\n        lastName: \"\",\n        unitNumber: \"\",\n        streetName: \"\",\n        phoneNumber: \"\",\n        moveInDate: \"\",\n        occupancyType: \"owner\",\n        numberOfOccupants: \"\",\n        propertySize: \"\",\n        bedrooms: \"\",\n        parkingSpaces: \"0\",\n        emergencyContactName: \"\",\n        emergencyContactPhone: \"\",\n        emergencyContactRelationship: \"\",\n        vehicles: \"\",\n        specialNotes: \"\",\n        serviceCharge: \"\",\n        startDate: \"\",\n      });\n    },\n    onError: (error: Error) => {\n      if (isUnauthorizedError(error)) {\n        toast({\n          title: \"Unauthorized\",\n          description: \"You are logged out. Logging in again...\",\n          variant: \"destructive\",\n        });\n        setTimeout(() => {\n          window.location.href = \"/api/login\";\n        }, 500);\n        return;\n      }\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to add resident\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const updateResidentMutation = useMutation({\n    mutationFn: async (data: { id: string; updates: any }) => {\n      return await apiRequest(\"PATCH\", `/api/admin/residents/${data.id}`, data.updates);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/residents\"] });\n      toast({ title: \"Success\", description: \"Resident updated successfully\" });\n      setEditDialogOpen(false);\n    },\n    onError: () => {\n      toast({ variant: \"destructive\", title: \"Error\", description: \"Failed to update resident\" });\n    },\n  });\n\n  const toggleStatusMutation = useMutation({\n    mutationFn: async (data: { id: string; status: string }) => {\n      return await apiRequest(\"PATCH\", `/api/admin/residents/${data.id}/status`, { status: data.status });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/residents\"] });\n      toast({ title: \"Success\", description: \"Resident status updated successfully\" });\n      setDeactivateDialogOpen(false);\n    },\n    onError: () => {\n      toast({ variant: \"destructive\", title: \"Error\", description: \"Failed to update status\" });\n    },\n  });\n\n  const handleView = (resident: ResidentWithUser) => {\n    setSelectedResident(resident);\n    setViewDialogOpen(true);\n  };\n\n  const handleEdit = (resident: ResidentWithUser) => {\n    setSelectedResident(resident);\n    setEditForm({\n      unitNumber: resident.unitNumber || \"\",\n      streetName: resident.streetName || \"\",\n      phoneNumber: resident.phoneNumber || \"\",\n      occupancyType: resident.occupancyType || \"\",\n      numberOfOccupants: resident.numberOfOccupants?.toString() || \"\",\n      bedrooms: resident.bedrooms?.toString() || \"\",\n      parkingSpaces: resident.parkingSpaces?.toString() || \"\",\n      propertySize: resident.propertySize || \"\",\n      emergencyContactName: resident.emergencyContactName || \"\",\n      emergencyContactPhone: resident.emergencyContactPhone || \"\",\n      emergencyContactRelationship: resident.emergencyContactRelationship || \"\",\n      vehicles: resident.vehicles?.join('\\n') || \"\",\n      specialNotes: resident.specialNotes || \"\",\n      serviceCharge: resident.serviceCharge || \"\",\n      startDate: resident.startDate ? new Date(resident.startDate).toISOString().split('T')[0] : \"\",\n    });\n    setEditDialogOpen(true);\n  };\n\n  const handleDeactivate = (resident: ResidentWithUser) => {\n    setSelectedResident(resident);\n    setDeactivateDialogOpen(true);\n  };\n\n  const handleStatement = (resident: ResidentWithUser) => {\n    setSelectedResident(resident);\n    setStatementDialogOpen(true);\n  };\n\n  const handleInvoices = (resident: ResidentWithUser) => {\n    setSelectedResident(resident);\n    setInvoicesDialogOpen(true);\n  };\n\n  const handleEditSubmit = () => {\n    if (!selectedResident) return;\n\n    updateResidentMutation.mutate({\n      id: selectedResident.id,\n      updates: {\n        unitNumber: editForm.unitNumber,\n        streetName: editForm.streetName || null,\n        phoneNumber: editForm.phoneNumber || null,\n        occupancyType: editForm.occupancyType || null,\n        numberOfOccupants: editForm.numberOfOccupants || null,\n        bedrooms: editForm.bedrooms || null,\n        parkingSpaces: editForm.parkingSpaces || null,\n        propertySize: editForm.propertySize || null,\n        emergencyContactName: editForm.emergencyContactName || null,\n        emergencyContactPhone: editForm.emergencyContactPhone || null,\n        emergencyContactRelationship: editForm.emergencyContactRelationship || null,\n        vehicles: editForm.vehicles || null,\n        specialNotes: editForm.specialNotes || null,\n        serviceCharge: editForm.serviceCharge || null,\n        startDate: editForm.startDate || null,\n      },\n    });\n  };\n\n  const handleStatusToggle = () => {\n    if (!selectedResident) return;\n\n    const newStatus = selectedResident.accountStatus === \"active\" ? \"inactive\" : \"active\";\n    toggleStatusMutation.mutate({\n      id: selectedResident.id,\n      status: newStatus,\n    });\n  };\n\n  if (authLoading || isLoading) {\n    return (\n      <div className=\"container mx-auto p-6 space-y-6\">\n        <Skeleton className=\"h-12 w-64\" />\n        <Skeleton className=\"h-10 w-full\" />\n        <Skeleton className=\"h-96 w-full\" />\n      </div>\n    );\n  }\n\n  const handleAddSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    createResidentMutation.mutate(addFormData);\n  };\n\n  return (\n    <div className=\"container mx-auto p-6 space-y-6\">\n      <div className=\"flex items-center justify-between gap-4\">\n        <div>\n          <h1 className=\"text-3xl font-bold\">Registered Residents</h1>\n          <p className=\"text-muted-foreground\">\n            Complete directory of all estate residents\n          </p>\n        </div>\n        <div className=\"flex items-center gap-2\">\n          <Badge variant=\"secondary\" data-testid=\"badge-count\">\n            {residents.length} {residents.length === 1 ? \"Resident\" : \"Residents\"}\n          </Badge>\n          <Dialog open={addDialogOpen} onOpenChange={setAddDialogOpen}>\n            <DialogTrigger asChild>\n              <Button data-testid=\"button-add-resident\">\n                <Plus className=\"h-4 w-4 mr-2\" />\n                Add Resident\n              </Button>\n            </DialogTrigger>\n            <DialogContent className=\"sm:max-w-[700px] max-h-[90vh] overflow-y-auto\">\n              <form onSubmit={handleAddSubmit}>\n                <DialogHeader>\n                  <DialogTitle>Add New Resident</DialogTitle>\n                  <DialogDescription>\n                    Create a comprehensive resident profile\n                  </DialogDescription>\n                </DialogHeader>\n                \n                <Tabs defaultValue=\"basic\" className=\"py-4\">\n                  <TabsList className=\"grid w-full grid-cols-4\">\n                    <TabsTrigger value=\"basic\" data-testid=\"tab-basic\">\n                      <User className=\"h-4 w-4 mr-2\" />\n                      Basic\n                    </TabsTrigger>\n                    <TabsTrigger value=\"property\" data-testid=\"tab-property\">\n                      <Home className=\"h-4 w-4 mr-2\" />\n                      Property\n                    </TabsTrigger>\n                    <TabsTrigger value=\"emergency\" data-testid=\"tab-emergency\">\n                      <Phone className=\"h-4 w-4 mr-2\" />\n                      Emergency\n                    </TabsTrigger>\n                    <TabsTrigger value=\"other\" data-testid=\"tab-other\">\n                      <Car className=\"h-4 w-4 mr-2\" />\n                      Other\n                    </TabsTrigger>\n                  </TabsList>\n\n                  <TabsContent value=\"basic\" className=\"space-y-4 mt-4\">\n                    <div className=\"grid gap-2\">\n                      <Label htmlFor=\"email\">Email Address *</Label>\n                      <Input\n                        id=\"email\"\n                        type=\"email\"\n                        value={addFormData.email}\n                        onChange={(e) => setAddFormData({ ...addFormData, email: e.target.value })}\n                        required\n                        data-testid=\"input-email\"\n                      />\n                    </div>\n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <div className=\"grid gap-2\">\n                        <Label htmlFor=\"firstName\">First Name *</Label>\n                        <Input\n                          id=\"firstName\"\n                          value={addFormData.firstName}\n                          onChange={(e) => setAddFormData({ ...addFormData, firstName: e.target.value })}\n                          required\n                          data-testid=\"input-first-name\"\n                        />\n                      </div>\n                      <div className=\"grid gap-2\">\n                        <Label htmlFor=\"lastName\">Last Name *</Label>\n                        <Input\n                          id=\"lastName\"\n                          value={addFormData.lastName}\n                          onChange={(e) => setAddFormData({ ...addFormData, lastName: e.target.value })}\n                          required\n                          data-testid=\"input-last-name\"\n                        />\n                      </div>\n                    </div>\n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <div className=\"grid gap-2\">\n                        <Label htmlFor=\"unitNumber\">Unit Number *</Label>\n                        <Input\n                          id=\"unitNumber\"\n                          value={addFormData.unitNumber}\n                          onChange={(e) => setAddFormData({ ...addFormData, unitNumber: e.target.value })}\n                          required\n                          data-testid=\"input-unit-number\"\n                        />\n                      </div>\n                      <div className=\"grid gap-2\">\n                        <Label htmlFor=\"phoneNumber\">Phone Number</Label>\n                        <Input\n                          id=\"phoneNumber\"\n                          type=\"tel\"\n                          value={addFormData.phoneNumber}\n                          onChange={(e) => setAddFormData({ ...addFormData, phoneNumber: e.target.value })}\n                          data-testid=\"input-phone\"\n                        />\n                      </div>\n                    </div>\n                    <div className=\"grid gap-2\">\n                      <Label htmlFor=\"streetName\">Street Name</Label>\n                      <Input\n                        id=\"streetName\"\n                        value={addFormData.streetName}\n                        onChange={(e) => setAddFormData({ ...addFormData, streetName: e.target.value })}\n                        placeholder=\"e.g., Magodo Street\"\n                        data-testid=\"input-street-name\"\n                      />\n                    </div>\n                  </TabsContent>\n\n                  <TabsContent value=\"property\" className=\"space-y-4 mt-4\">\n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <div className=\"grid gap-2\">\n                        <Label htmlFor=\"moveInDate\">Move-In Date</Label>\n                        <Input\n                          id=\"moveInDate\"\n                          type=\"date\"\n                          value={addFormData.moveInDate}\n                          onChange={(e) => setAddFormData({ ...addFormData, moveInDate: e.target.value })}\n                          data-testid=\"input-move-in-date\"\n                        />\n                      </div>\n                      <div className=\"grid gap-2\">\n                        <Label htmlFor=\"occupancyType\">Occupancy Type</Label>\n                        <Select\n                          value={addFormData.occupancyType}\n                          onValueChange={(value: \"owner\" | \"tenant\") => setAddFormData({ ...addFormData, occupancyType: value })}\n                        >\n                          <SelectTrigger data-testid=\"select-occupancy-type\">\n                            <SelectValue />\n                          </SelectTrigger>\n                          <SelectContent>\n                            <SelectItem value=\"owner\">Owner</SelectItem>\n                            <SelectItem value=\"tenant\">Tenant</SelectItem>\n                          </SelectContent>\n                        </Select>\n                      </div>\n                    </div>\n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <div className=\"grid gap-2\">\n                        <Label htmlFor=\"numberOfOccupants\">Number of Occupants</Label>\n                        <Input\n                          id=\"numberOfOccupants\"\n                          type=\"number\"\n                          min=\"0\"\n                          value={addFormData.numberOfOccupants}\n                          onChange={(e) => setAddFormData({ ...addFormData, numberOfOccupants: e.target.value })}\n                          data-testid=\"input-occupants\"\n                        />\n                      </div>\n                      <div className=\"grid gap-2\">\n                        <Label htmlFor=\"bedrooms\">Bedrooms</Label>\n                        <Input\n                          id=\"bedrooms\"\n                          type=\"number\"\n                          min=\"0\"\n                          value={addFormData.bedrooms}\n                          onChange={(e) => setAddFormData({ ...addFormData, bedrooms: e.target.value })}\n                          data-testid=\"input-bedrooms\"\n                        />\n                      </div>\n                    </div>\n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <div className=\"grid gap-2\">\n                        <Label htmlFor=\"propertySize\">Property Size</Label>\n                        <Input\n                          id=\"propertySize\"\n                          placeholder=\"e.g., 2000 sq ft\"\n                          value={addFormData.propertySize}\n                          onChange={(e) => setAddFormData({ ...addFormData, propertySize: e.target.value })}\n                          data-testid=\"input-property-size\"\n                        />\n                      </div>\n                      <div className=\"grid gap-2\">\n                        <Label htmlFor=\"parkingSpaces\">Parking Spaces</Label>\n                        <Input\n                          id=\"parkingSpaces\"\n                          type=\"number\"\n                          min=\"0\"\n                          value={addFormData.parkingSpaces}\n                          onChange={(e) => setAddFormData({ ...addFormData, parkingSpaces: e.target.value })}\n                          data-testid=\"input-parking\"\n                        />\n                      </div>\n                    </div>\n                    <div className=\"grid gap-2\">\n                      <Label htmlFor=\"serviceCharge\">Service Charge (₦)</Label>\n                      <Input\n                        id=\"serviceCharge\"\n                        type=\"number\"\n                        min=\"0\"\n                        step=\"0.01\"\n                        placeholder=\"e.g., 50000\"\n                        value={addFormData.serviceCharge}\n                        onChange={(e) => setAddFormData({ ...addFormData, serviceCharge: e.target.value })}\n                        data-testid=\"input-service-charge\"\n                      />\n                    </div>\n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <div className=\"grid gap-2\">\n                        <Label htmlFor=\"startDate\">Start Date</Label>\n                        <Input\n                          id=\"startDate\"\n                          type=\"date\"\n                          value={addFormData.startDate}\n                          onChange={(e) => setAddFormData({ ...addFormData, startDate: e.target.value })}\n                          data-testid=\"input-start-date\"\n                        />\n                        <p className=\"text-sm text-muted-foreground mt-1\">\n                          Billing period starts from this date. System will auto-generate 12-month bills.\n                        </p>\n                      </div>\n                    </div>\n                  </TabsContent>\n\n                  <TabsContent value=\"emergency\" className=\"space-y-4 mt-4\">\n                    <div className=\"grid gap-2\">\n                      <Label htmlFor=\"emergencyContactName\">Emergency Contact Name</Label>\n                      <Input\n                        id=\"emergencyContactName\"\n                        value={addFormData.emergencyContactName}\n                        onChange={(e) => setAddFormData({ ...addFormData, emergencyContactName: e.target.value })}\n                        data-testid=\"input-emergency-name\"\n                      />\n                    </div>\n                    <div className=\"grid gap-2\">\n                      <Label htmlFor=\"emergencyContactPhone\">Emergency Contact Phone</Label>\n                      <Input\n                        id=\"emergencyContactPhone\"\n                        type=\"tel\"\n                        value={addFormData.emergencyContactPhone}\n                        onChange={(e) => setAddFormData({ ...addFormData, emergencyContactPhone: e.target.value })}\n                        data-testid=\"input-emergency-phone\"\n                      />\n                    </div>\n                    <div className=\"grid gap-2\">\n                      <Label htmlFor=\"emergencyContactRelationship\">Relationship</Label>\n                      <Input\n                        id=\"emergencyContactRelationship\"\n                        placeholder=\"e.g., Spouse, Parent, Sibling\"\n                        value={addFormData.emergencyContactRelationship}\n                        onChange={(e) => setAddFormData({ ...addFormData, emergencyContactRelationship: e.target.value })}\n                        data-testid=\"input-emergency-relationship\"\n                      />\n                    </div>\n                  </TabsContent>\n\n                  <TabsContent value=\"other\" className=\"space-y-4 mt-4\">\n                    <div className=\"grid gap-2\">\n                      <Label htmlFor=\"vehicles\">Vehicles (one per line)</Label>\n                      <Textarea\n                        id=\"vehicles\"\n                        placeholder=\"e.g., &#10;Toyota Camry - ABC123XY&#10;Honda CR-V - XYZ789AB\"\n                        value={addFormData.vehicles}\n                        onChange={(e) => setAddFormData({ ...addFormData, vehicles: e.target.value })}\n                        rows={4}\n                        data-testid=\"input-vehicles\"\n                      />\n                      <p className=\"text-xs text-muted-foreground\">Enter vehicle details, one per line</p>\n                    </div>\n                    <div className=\"grid gap-2\">\n                      <Label htmlFor=\"specialNotes\">Special Notes</Label>\n                      <Textarea\n                        id=\"specialNotes\"\n                        placeholder=\"Any additional information about this resident...\"\n                        value={addFormData.specialNotes}\n                        onChange={(e) => setAddFormData({ ...addFormData, specialNotes: e.target.value })}\n                        rows={4}\n                        data-testid=\"input-notes\"\n                      />\n                    </div>\n                  </TabsContent>\n                </Tabs>\n\n                <DialogFooter>\n                  <Button type=\"button\" variant=\"outline\" onClick={() => setAddDialogOpen(false)}>\n                    Cancel\n                  </Button>\n                  <Button type=\"submit\" disabled={createResidentMutation.isPending} data-testid=\"button-submit-resident\">\n                    {createResidentMutation.isPending ? \"Adding...\" : \"Add Resident\"}\n                  </Button>\n                </DialogFooter>\n              </form>\n            </DialogContent>\n          </Dialog>\n        </div>\n      </div>\n\n      <div className=\"flex items-center gap-4\">\n        <div className=\"relative flex-1\">\n          <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n          <Input\n            placeholder=\"Search by name, email, unit number, or phone...\"\n            value={searchQuery}\n            onChange={(e) => setSearchQuery(e.target.value)}\n            className=\"pl-9\"\n            data-testid=\"input-search\"\n          />\n        </div>\n      </div>\n\n      {filteredResidents.length === 0 ? (\n        <Card>\n          <CardContent className=\"flex flex-col items-center justify-center py-12\">\n            <Search className=\"h-12 w-12 text-muted-foreground mb-4\" />\n            <p className=\"text-muted-foreground\">\n              {searchQuery ? \"No residents found matching your search\" : \"No residents registered yet\"}\n            </p>\n          </CardContent>\n        </Card>\n      ) : (\n        <Card>\n          <Table>\n            <TableHeader>\n              <TableRow>\n                <TableHead>Name</TableHead>\n                <TableHead>Unit</TableHead>\n                <TableHead>Email</TableHead>\n                <TableHead>Phone</TableHead>\n                <TableHead>Status</TableHead>\n                <TableHead>Balance</TableHead>\n                <TableHead className=\"text-right\">Actions</TableHead>\n              </TableRow>\n            </TableHeader>\n            <TableBody>\n              {filteredResidents.map((resident) => (\n                <TableRow key={resident.id} data-testid={`row-resident-${resident.id}`}>\n                  <TableCell className=\"font-medium\" data-testid={`text-name-${resident.id}`}>\n                    {resident.user.firstName} {resident.user.lastName}\n                  </TableCell>\n                  <TableCell data-testid={`text-unit-${resident.id}`}>\n                    {resident.unitNumber}\n                  </TableCell>\n                  <TableCell data-testid={`text-email-${resident.id}`}>\n                    {resident.user.email}\n                  </TableCell>\n                  <TableCell data-testid={`text-phone-${resident.id}`}>\n                    {resident.phoneNumber || \"—\"}\n                  </TableCell>\n                  <TableCell>\n                    <Badge\n                      variant={resident.accountStatus === \"active\" ? \"default\" : \"destructive\"}\n                      data-testid={`badge-status-${resident.id}`}\n                    >\n                      {resident.accountStatus}\n                    </Badge>\n                  </TableCell>\n                  <TableCell data-testid={`text-balance-${resident.id}`}>\n                    {resident.totalBalance && parseFloat(resident.totalBalance) > 0 ? (\n                      <span className=\"font-semibold text-destructive\">\n                        ₦{parseFloat(resident.totalBalance).toLocaleString()}\n                      </span>\n                    ) : (\n                      <span className=\"text-muted-foreground\">₦0</span>\n                    )}\n                  </TableCell>\n                  <TableCell className=\"text-right\">\n                    <div className=\"flex items-center justify-end gap-2\">\n                      <Button\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        onClick={() => handleView(resident)}\n                        data-testid={`button-view-${resident.id}`}\n                      >\n                        <Eye className=\"h-4 w-4\" />\n                        View\n                      </Button>\n                      <Button\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        onClick={() => handleEdit(resident)}\n                        data-testid={`button-edit-${resident.id}`}\n                      >\n                        <Edit className=\"h-4 w-4\" />\n                        Edit\n                      </Button>\n                      <Button\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        onClick={() => handleDeactivate(resident)}\n                        data-testid={`button-deactivate-${resident.id}`}\n                      >\n                        <UserX className=\"h-4 w-4\" />\n                        {resident.accountStatus === \"active\" ? \"Deactivate\" : \"Activate\"}\n                      </Button>\n                      <Button\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        onClick={() => handleStatement(resident)}\n                        data-testid={`button-statement-${resident.id}`}\n                      >\n                        <FileText className=\"h-4 w-4\" />\n                        Statement\n                      </Button>\n                      <Button\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        onClick={() => handleInvoices(resident)}\n                        data-testid={`button-invoices-${resident.id}`}\n                      >\n                        <Download className=\"h-4 w-4\" />\n                        Invoices\n                      </Button>\n                    </div>\n                  </TableCell>\n                </TableRow>\n              ))}\n            </TableBody>\n          </Table>\n        </Card>\n      )}\n\n      {/* View Dialog */}\n      <ViewResidentDialog\n        open={viewDialogOpen}\n        onOpenChange={setViewDialogOpen}\n        resident={selectedResident}\n      />\n\n      {/* Edit Dialog */}\n      <EditResidentDialog\n        open={editDialogOpen}\n        onOpenChange={setEditDialogOpen}\n        resident={selectedResident}\n        editForm={editForm}\n        setEditForm={setEditForm}\n        onSubmit={handleEditSubmit}\n        isPending={updateResidentMutation.isPending}\n      />\n\n      {/* Deactivate Dialog */}\n      <AlertDialog open={deactivateDialogOpen} onOpenChange={setDeactivateDialogOpen}>\n        <AlertDialogContent data-testid=\"dialog-deactivate\">\n          <AlertDialogHeader>\n            <AlertDialogTitle>\n              {selectedResident?.accountStatus === \"active\" ? \"Deactivate\" : \"Activate\"} Resident?\n            </AlertDialogTitle>\n            <AlertDialogDescription>\n              {selectedResident?.accountStatus === \"active\" \n                ? `Are you sure you want to deactivate ${selectedResident?.user.firstName} ${selectedResident?.user.lastName}? They will not be able to approve visitors or access resident features.`\n                : `Are you sure you want to activate ${selectedResident?.user.firstName} ${selectedResident?.user.lastName}? They will regain access to all resident features.`\n              }\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel data-testid=\"button-cancel-deactivate\">Cancel</AlertDialogCancel>\n            <AlertDialogAction\n              onClick={handleStatusToggle}\n              disabled={toggleStatusMutation.isPending}\n              data-testid=\"button-confirm-deactivate\"\n            >\n              {toggleStatusMutation.isPending ? \"Processing...\" : selectedResident?.accountStatus === \"active\" ? \"Deactivate\" : \"Activate\"}\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n\n      {/* Statement Dialog */}\n      <StatementDialog\n        open={statementDialogOpen}\n        onOpenChange={setStatementDialogOpen}\n        resident={selectedResident}\n      />\n\n      {/* Invoices Dialog */}\n      <InvoicesDialog\n        open={invoicesDialogOpen}\n        onOpenChange={setInvoicesDialogOpen}\n        resident={selectedResident}\n      />\n    </div>\n  );\n}\n\nfunction ViewResidentDialog({ open, onOpenChange, resident }: { open: boolean; onOpenChange: (open: boolean) => void; resident: ResidentWithUser | null }) {\n  if (!resident) return null;\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\" data-testid=\"dialog-view\">\n        <DialogHeader>\n          <DialogTitle>Resident Details</DialogTitle>\n          <DialogDescription>\n            Complete information for {resident.user.firstName} {resident.user.lastName}\n          </DialogDescription>\n        </DialogHeader>\n\n        <Tabs defaultValue=\"basic\" className=\"w-full\">\n          <TabsList className=\"grid w-full grid-cols-4\">\n            <TabsTrigger value=\"basic\">Basic</TabsTrigger>\n            <TabsTrigger value=\"property\">Property</TabsTrigger>\n            <TabsTrigger value=\"emergency\">Emergency</TabsTrigger>\n            <TabsTrigger value=\"other\">Other</TabsTrigger>\n          </TabsList>\n\n          <TabsContent value=\"basic\" className=\"space-y-4\">\n            <div className=\"grid gap-4\">\n              <div className=\"flex items-center gap-3\">\n                <User className=\"h-5 w-5 text-muted-foreground\" />\n                <div>\n                  <Label className=\"text-muted-foreground\">Full Name</Label>\n                  <p className=\"font-medium\">{resident.user.firstName} {resident.user.lastName}</p>\n                </div>\n              </div>\n              <div className=\"flex items-center gap-3\">\n                <Mail className=\"h-5 w-5 text-muted-foreground\" />\n                <div>\n                  <Label className=\"text-muted-foreground\">Email</Label>\n                  <p className=\"font-medium\">{resident.user.email}</p>\n                </div>\n              </div>\n              <div className=\"flex items-center gap-3\">\n                <Home className=\"h-5 w-5 text-muted-foreground\" />\n                <div>\n                  <Label className=\"text-muted-foreground\">Unit Number</Label>\n                  <p className=\"font-medium\">{resident.unitNumber}</p>\n                </div>\n              </div>\n              <div className=\"flex items-center gap-3\">\n                <Phone className=\"h-5 w-5 text-muted-foreground\" />\n                <div>\n                  <Label className=\"text-muted-foreground\">Phone Number</Label>\n                  <p className=\"font-medium\">{resident.phoneNumber || \"Not provided\"}</p>\n                </div>\n              </div>\n              <div className=\"flex items-center gap-3\">\n                <Calendar className=\"h-5 w-5 text-muted-foreground\" />\n                <div>\n                  <Label className=\"text-muted-foreground\">Account Status</Label>\n                  <div className=\"mt-1\">\n                    <Badge variant={resident.accountStatus === \"active\" ? \"default\" : \"destructive\"}>\n                      {resident.accountStatus}\n                    </Badge>\n                  </div>\n                </div>\n              </div>\n            </div>\n          </TabsContent>\n\n          <TabsContent value=\"property\" className=\"space-y-4\">\n            <div className=\"grid gap-4\">\n              {resident.moveInDate && (\n                <div>\n                  <Label className=\"text-muted-foreground\">Move-in Date</Label>\n                  <p className=\"font-medium\">{new Date(resident.moveInDate).toLocaleDateString()}</p>\n                </div>\n              )}\n              {resident.occupancyType && (\n                <div>\n                  <Label className=\"text-muted-foreground\">Occupancy Type</Label>\n                  <p className=\"font-medium capitalize\">{resident.occupancyType}</p>\n                </div>\n              )}\n              {resident.numberOfOccupants && (\n                <div>\n                  <Label className=\"text-muted-foreground\">Number of Occupants</Label>\n                  <p className=\"font-medium\">{resident.numberOfOccupants}</p>\n                </div>\n              )}\n              {resident.bedrooms && (\n                <div>\n                  <Label className=\"text-muted-foreground\">Bedrooms</Label>\n                  <p className=\"font-medium\">{resident.bedrooms}</p>\n                </div>\n              )}\n              {resident.propertySize && (\n                <div>\n                  <Label className=\"text-muted-foreground\">Property Size</Label>\n                  <p className=\"font-medium\">{resident.propertySize}</p>\n                </div>\n              )}\n              {resident.parkingSpaces !== null && resident.parkingSpaces !== undefined && (\n                <div>\n                  <Label className=\"text-muted-foreground\">Parking Spaces</Label>\n                  <p className=\"font-medium\">{resident.parkingSpaces}</p>\n                </div>\n              )}\n              {resident.serviceCharge && (\n                <div>\n                  <Label className=\"text-muted-foreground\">Service Charge</Label>\n                  <p className=\"font-medium\">₦{parseFloat(resident.serviceCharge).toLocaleString()}</p>\n                </div>\n              )}\n              {resident.startDate && (\n                <div>\n                  <Label className=\"text-muted-foreground\">Billing Start Date</Label>\n                  <p className=\"font-medium\">{new Date(resident.startDate).toLocaleDateString()}</p>\n                </div>\n              )}\n              {resident.endDate && (\n                <div>\n                  <Label className=\"text-muted-foreground\">Last Bill End Date (System-Managed)</Label>\n                  <p className=\"font-medium\">{new Date(resident.endDate).toLocaleDateString()}</p>\n                </div>\n              )}\n            </div>\n          </TabsContent>\n\n          <TabsContent value=\"emergency\" className=\"space-y-4\">\n            <div className=\"grid gap-4\">\n              {resident.emergencyContactName && (\n                <div>\n                  <Label className=\"text-muted-foreground\">Contact Name</Label>\n                  <p className=\"font-medium\">{resident.emergencyContactName}</p>\n                </div>\n              )}\n              {resident.emergencyContactPhone && (\n                <div>\n                  <Label className=\"text-muted-foreground\">Contact Phone</Label>\n                  <p className=\"font-medium\">{resident.emergencyContactPhone}</p>\n                </div>\n              )}\n              {resident.emergencyContactRelationship && (\n                <div>\n                  <Label className=\"text-muted-foreground\">Relationship</Label>\n                  <p className=\"font-medium capitalize\">{resident.emergencyContactRelationship}</p>\n                </div>\n              )}\n              {!resident.emergencyContactName && (\n                <p className=\"text-muted-foreground\">No emergency contact information provided</p>\n              )}\n            </div>\n          </TabsContent>\n\n          <TabsContent value=\"other\" className=\"space-y-4\">\n            <div className=\"grid gap-4\">\n              {resident.vehicles && resident.vehicles.length > 0 && (\n                <div>\n                  <Label className=\"text-muted-foreground\">Vehicles</Label>\n                  <ul className=\"mt-2 space-y-1\">\n                    {resident.vehicles.map((vehicle, idx) => (\n                      <li key={idx} className=\"flex items-center gap-2\">\n                        <Car className=\"h-4 w-4\" />\n                        <span>{vehicle}</span>\n                      </li>\n                    ))}\n                  </ul>\n                </div>\n              )}\n              {resident.specialNotes && (\n                <div>\n                  <Label className=\"text-muted-foreground\">Special Notes</Label>\n                  <p className=\"mt-1 text-sm\">{resident.specialNotes}</p>\n                </div>\n              )}\n            </div>\n          </TabsContent>\n        </Tabs>\n      </DialogContent>\n    </Dialog>\n  );\n}\n\nfunction EditResidentDialog({ \n  open, \n  onOpenChange, \n  resident, \n  editForm, \n  setEditForm, \n  onSubmit, \n  isPending \n}: { \n  open: boolean; \n  onOpenChange: (open: boolean) => void; \n  resident: ResidentWithUser | null;\n  editForm: any;\n  setEditForm: (form: any) => void;\n  onSubmit: () => void;\n  isPending: boolean;\n}) {\n  if (!resident) return null;\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\" data-testid=\"dialog-edit\">\n        <DialogHeader>\n          <DialogTitle>Edit Resident</DialogTitle>\n          <DialogDescription>\n            Update information for {resident.user.firstName} {resident.user.lastName}\n          </DialogDescription>\n        </DialogHeader>\n\n        <Tabs defaultValue=\"basic\" className=\"w-full\">\n          <TabsList className=\"grid w-full grid-cols-4\">\n            <TabsTrigger value=\"basic\">Basic</TabsTrigger>\n            <TabsTrigger value=\"property\">Property</TabsTrigger>\n            <TabsTrigger value=\"emergency\">Emergency</TabsTrigger>\n            <TabsTrigger value=\"other\">Other</TabsTrigger>\n          </TabsList>\n\n          <TabsContent value=\"basic\" className=\"space-y-4\">\n            <div className=\"grid gap-4\">\n              <div>\n                <Label htmlFor=\"unitNumber\">Unit Number *</Label>\n                <Input\n                  id=\"unitNumber\"\n                  value={editForm.unitNumber}\n                  onChange={(e) => setEditForm({ ...editForm, unitNumber: e.target.value })}\n                  placeholder=\"e.g., A101\"\n                  data-testid=\"input-edit-unit\"\n                />\n              </div>\n              <div>\n                <Label htmlFor=\"streetName\">Street Name</Label>\n                <Input\n                  id=\"streetName\"\n                  value={editForm.streetName}\n                  onChange={(e) => setEditForm({ ...editForm, streetName: e.target.value })}\n                  placeholder=\"e.g., Magodo Street\"\n                  data-testid=\"input-edit-street-name\"\n                />\n              </div>\n              <div>\n                <Label htmlFor=\"phoneNumber\">Phone Number</Label>\n                <Input\n                  id=\"phoneNumber\"\n                  value={editForm.phoneNumber}\n                  onChange={(e) => setEditForm({ ...editForm, phoneNumber: e.target.value })}\n                  placeholder=\"e.g., +234 123 456 7890\"\n                  data-testid=\"input-edit-phone\"\n                />\n              </div>\n            </div>\n          </TabsContent>\n\n          <TabsContent value=\"property\" className=\"space-y-4\">\n            <div className=\"grid gap-4\">\n              <div>\n                <Label htmlFor=\"occupancyType\">Occupancy Type</Label>\n                <Select\n                  value={editForm.occupancyType}\n                  onValueChange={(value) => setEditForm({ ...editForm, occupancyType: value })}\n                >\n                  <SelectTrigger data-testid=\"select-edit-occupancy\">\n                    <SelectValue placeholder=\"Select type\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"owner\">Owner</SelectItem>\n                    <SelectItem value=\"tenant\">Tenant</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n              <div>\n                <Label htmlFor=\"numberOfOccupants\">Number of Occupants</Label>\n                <Input\n                  id=\"numberOfOccupants\"\n                  type=\"number\"\n                  value={editForm.numberOfOccupants}\n                  onChange={(e) => setEditForm({ ...editForm, numberOfOccupants: e.target.value })}\n                  placeholder=\"e.g., 4\"\n                  data-testid=\"input-edit-occupants\"\n                />\n              </div>\n              <div>\n                <Label htmlFor=\"bedrooms\">Bedrooms</Label>\n                <Input\n                  id=\"bedrooms\"\n                  type=\"number\"\n                  value={editForm.bedrooms}\n                  onChange={(e) => setEditForm({ ...editForm, bedrooms: e.target.value })}\n                  placeholder=\"e.g., 3\"\n                  data-testid=\"input-edit-bedrooms\"\n                />\n              </div>\n              <div>\n                <Label htmlFor=\"propertySize\">Property Size</Label>\n                <Input\n                  id=\"propertySize\"\n                  value={editForm.propertySize}\n                  onChange={(e) => setEditForm({ ...editForm, propertySize: e.target.value })}\n                  placeholder=\"e.g., 150 sqm\"\n                  data-testid=\"input-edit-property-size\"\n                />\n              </div>\n              <div>\n                <Label htmlFor=\"parkingSpaces\">Parking Spaces</Label>\n                <Input\n                  id=\"parkingSpaces\"\n                  type=\"number\"\n                  value={editForm.parkingSpaces}\n                  onChange={(e) => setEditForm({ ...editForm, parkingSpaces: e.target.value })}\n                  placeholder=\"e.g., 2\"\n                  data-testid=\"input-edit-parking\"\n                />\n              </div>\n              <div>\n                <Label htmlFor=\"serviceCharge\">Service Charge (₦)</Label>\n                <Input\n                  id=\"serviceCharge\"\n                  type=\"number\"\n                  step=\"0.01\"\n                  value={editForm.serviceCharge}\n                  onChange={(e) => setEditForm({ ...editForm, serviceCharge: e.target.value })}\n                  placeholder=\"e.g., 50000\"\n                  data-testid=\"input-edit-service-charge\"\n                />\n              </div>\n              <div>\n                <Label htmlFor=\"startDate\">Billing Start Date</Label>\n                <Input\n                  id=\"startDate\"\n                  type=\"date\"\n                  value={editForm.startDate}\n                  onChange={(e) => setEditForm({ ...editForm, startDate: e.target.value })}\n                  data-testid=\"input-edit-start-date\"\n                />\n                <p className=\"text-sm text-muted-foreground mt-1\">\n                  Note: End date is system-managed and updated automatically when bills are generated\n                </p>\n              </div>\n            </div>\n          </TabsContent>\n\n          <TabsContent value=\"emergency\" className=\"space-y-4\">\n            <div className=\"grid gap-4\">\n              <div>\n                <Label htmlFor=\"emergencyContactName\">Contact Name</Label>\n                <Input\n                  id=\"emergencyContactName\"\n                  value={editForm.emergencyContactName}\n                  onChange={(e) => setEditForm({ ...editForm, emergencyContactName: e.target.value })}\n                  placeholder=\"e.g., John Doe\"\n                  data-testid=\"input-edit-emergency-name\"\n                />\n              </div>\n              <div>\n                <Label htmlFor=\"emergencyContactPhone\">Contact Phone</Label>\n                <Input\n                  id=\"emergencyContactPhone\"\n                  value={editForm.emergencyContactPhone}\n                  onChange={(e) => setEditForm({ ...editForm, emergencyContactPhone: e.target.value })}\n                  placeholder=\"e.g., +234 123 456 7890\"\n                  data-testid=\"input-edit-emergency-phone\"\n                />\n              </div>\n              <div>\n                <Label htmlFor=\"emergencyContactRelationship\">Relationship</Label>\n                <Input\n                  id=\"emergencyContactRelationship\"\n                  value={editForm.emergencyContactRelationship}\n                  onChange={(e) => setEditForm({ ...editForm, emergencyContactRelationship: e.target.value })}\n                  placeholder=\"e.g., Spouse, Parent, Sibling\"\n                  data-testid=\"input-edit-emergency-relationship\"\n                />\n              </div>\n            </div>\n          </TabsContent>\n\n          <TabsContent value=\"other\" className=\"space-y-4\">\n            <div className=\"grid gap-4\">\n              <div>\n                <Label htmlFor=\"vehicles\">Vehicles (one per line)</Label>\n                <Textarea\n                  id=\"vehicles\"\n                  value={editForm.vehicles}\n                  onChange={(e) => setEditForm({ ...editForm, vehicles: e.target.value })}\n                  placeholder=\"e.g.,&#10;Toyota Camry - ABC123XY&#10;Honda Civic - DEF456ZW\"\n                  rows={4}\n                  data-testid=\"textarea-edit-vehicles\"\n                />\n              </div>\n              <div>\n                <Label htmlFor=\"specialNotes\">Special Notes</Label>\n                <Textarea\n                  id=\"specialNotes\"\n                  value={editForm.specialNotes}\n                  onChange={(e) => setEditForm({ ...editForm, specialNotes: e.target.value })}\n                  placeholder=\"Any additional notes about the resident\"\n                  rows={3}\n                  data-testid=\"textarea-edit-notes\"\n                />\n              </div>\n            </div>\n          </TabsContent>\n        </Tabs>\n\n        <DialogFooter>\n          <Button variant=\"outline\" onClick={() => onOpenChange(false)} data-testid=\"button-cancel-edit\">\n            Cancel\n          </Button>\n          <Button onClick={onSubmit} disabled={isPending || !editForm.unitNumber} data-testid=\"button-save-edit\">\n            {isPending ? \"Saving...\" : \"Save Changes\"}\n          </Button>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  );\n}\n\nfunction StatementDialog({ open, onOpenChange, resident }: { open: boolean; onOpenChange: (open: boolean) => void; resident: ResidentWithUser | null }) {\n  const { data: bills = [], isLoading: billsLoading } = useQuery<Bill[]>({\n    queryKey: [\"/api/admin/residents\", resident?.id, \"bills\"],\n    enabled: open && !!resident,\n  });\n\n  const { data: payments = [], isLoading: paymentsLoading } = useQuery<Payment[]>({\n    queryKey: [\"/api/admin/residents\", resident?.id, \"payments\"],\n    enabled: open && !!resident,\n  });\n\n  if (!resident) return null;\n\n  const totalBills = bills.reduce((sum, bill) => sum + parseFloat(bill.amount), 0);\n  const totalPaid = payments.reduce((sum, payment) => sum + parseFloat(payment.amount), 0);\n  const balance = totalBills - totalPaid;\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-y-auto\" data-testid=\"dialog-statement\">\n        <DialogHeader>\n          <DialogTitle>Financial Statement</DialogTitle>\n          <DialogDescription>\n            Billing and payment history for {resident.user.firstName} {resident.user.lastName}\n          </DialogDescription>\n        </DialogHeader>\n\n        <div className=\"space-y-6\">\n          <div className=\"grid gap-4 md:grid-cols-3\">\n            <Card>\n              <CardHeader className=\"pb-3\">\n                <CardTitle className=\"text-sm font-medium text-muted-foreground\">Total Billed</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <p className=\"text-2xl font-bold\">₦{totalBills.toLocaleString()}</p>\n              </CardContent>\n            </Card>\n            <Card>\n              <CardHeader className=\"pb-3\">\n                <CardTitle className=\"text-sm font-medium text-muted-foreground\">Total Paid</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <p className=\"text-2xl font-bold text-green-600\">₦{totalPaid.toLocaleString()}</p>\n              </CardContent>\n            </Card>\n            <Card>\n              <CardHeader className=\"pb-3\">\n                <CardTitle className=\"text-sm font-medium text-muted-foreground\">Outstanding Balance</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <p className={`text-2xl font-bold ${balance > 0 ? 'text-destructive' : 'text-green-600'}`}>\n                  ₦{balance.toLocaleString()}\n                </p>\n              </CardContent>\n            </Card>\n          </div>\n\n          <Tabs defaultValue=\"bills\" className=\"w-full\">\n            <TabsList>\n              <TabsTrigger value=\"bills\">Bills ({bills.length})</TabsTrigger>\n              <TabsTrigger value=\"payments\">Payments ({payments.length})</TabsTrigger>\n            </TabsList>\n\n            <TabsContent value=\"bills\" className=\"space-y-4\">\n              {billsLoading ? (\n                <div className=\"text-center py-8\">Loading bills...</div>\n              ) : bills.length === 0 ? (\n                <div className=\"text-center py-8 text-muted-foreground\">No bills found</div>\n              ) : (\n                <Table>\n                  <TableHeader>\n                    <TableRow>\n                      <TableHead>Description</TableHead>\n                      <TableHead>Amount</TableHead>\n                      <TableHead>Due Date</TableHead>\n                      <TableHead>Status</TableHead>\n                    </TableRow>\n                  </TableHeader>\n                  <TableBody>\n                    {bills.map((bill) => (\n                      <TableRow key={bill.id}>\n                        <TableCell>{bill.description}</TableCell>\n                        <TableCell className=\"font-medium\">₦{parseFloat(bill.amount).toLocaleString()}</TableCell>\n                        <TableCell>{new Date(bill.dueDate).toLocaleDateString()}</TableCell>\n                        <TableCell>\n                          <Badge variant={bill.status === \"paid\" ? \"default\" : bill.status === \"overdue\" ? \"destructive\" : \"secondary\"}>\n                            {bill.status}\n                          </Badge>\n                        </TableCell>\n                      </TableRow>\n                    ))}\n                  </TableBody>\n                </Table>\n              )}\n            </TabsContent>\n\n            <TabsContent value=\"payments\" className=\"space-y-4\">\n              {paymentsLoading ? (\n                <div className=\"text-center py-8\">Loading payments...</div>\n              ) : payments.length === 0 ? (\n                <div className=\"text-center py-8 text-muted-foreground\">No payments found</div>\n              ) : (\n                <Table>\n                  <TableHeader>\n                    <TableRow>\n                      <TableHead>Date</TableHead>\n                      <TableHead>Amount</TableHead>\n                      <TableHead>Method</TableHead>\n                      <TableHead>Reference</TableHead>\n                    </TableRow>\n                  </TableHeader>\n                  <TableBody>\n                    {payments.map((payment) => (\n                      <TableRow key={payment.id}>\n                        <TableCell>{payment.createdAt ? new Date(payment.createdAt).toLocaleDateString() : \"—\"}</TableCell>\n                        <TableCell className=\"font-medium text-green-600\">₦{parseFloat(payment.amount).toLocaleString()}</TableCell>\n                        <TableCell className=\"capitalize\">{payment.paymentMethod}</TableCell>\n                        <TableCell className=\"text-muted-foreground\">{payment.transactionId || \"—\"}</TableCell>\n                      </TableRow>\n                    ))}\n                  </TableBody>\n                </Table>\n              )}\n            </TabsContent>\n          </Tabs>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}\n\nfunction InvoicesDialog({ open, onOpenChange, resident }: { open: boolean; onOpenChange: (open: boolean) => void; resident: ResidentWithUser | null }) {\n  const { toast } = useToast();\n  const [downloadingBillId, setDownloadingBillId] = useState<string | null>(null);\n\n  const { data: bills = [], isLoading: billsLoading } = useQuery<Bill[]>({\n    queryKey: [\"/api/admin/residents\", resident?.id, \"bills\"],\n    enabled: open && !!resident,\n  });\n\n  if (!resident) return null;\n\n  const handleDownloadInvoice = async (billId: string, invoiceNumber: string) => {\n    try {\n      setDownloadingBillId(billId);\n\n      const response = await fetch(`/api/admin/residents/${resident.id}/bills/${billId}/pdf`, {\n        credentials: 'include',\n      });\n\n      if (!response.ok) {\n        throw new Error('Failed to download invoice');\n      }\n\n      const blob = await response.blob();\n      const url = window.URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      a.href = url;\n      a.download = `Invoice-${invoiceNumber || billId}.pdf`;\n      document.body.appendChild(a);\n      a.click();\n      window.URL.revokeObjectURL(url);\n      document.body.removeChild(a);\n\n      toast({\n        title: \"Success\",\n        description: \"Invoice downloaded successfully\",\n      });\n    } catch (error) {\n      console.error(\"Error downloading invoice:\", error);\n      toast({\n        title: \"Error\",\n        description: \"Failed to download invoice. Please try again.\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setDownloadingBillId(null);\n    }\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-y-auto\" data-testid=\"dialog-invoices\">\n        <DialogHeader>\n          <DialogTitle>Invoice PDFs</DialogTitle>\n          <DialogDescription>\n            Download invoice PDFs for {resident.user.firstName} {resident.user.lastName} - Unit {resident.unitNumber}\n          </DialogDescription>\n        </DialogHeader>\n\n        <div className=\"space-y-4\">\n          {billsLoading ? (\n            <div className=\"text-center py-8\">\n              <div className=\"animate-spin w-8 h-8 border-4 border-primary border-t-transparent rounded-full mx-auto\" />\n              <p className=\"mt-4 text-muted-foreground\">Loading invoices...</p>\n            </div>\n          ) : bills.length === 0 ? (\n            <div className=\"text-center py-12 text-muted-foreground\">\n              <FileText className=\"h-16 w-16 mx-auto mb-4 opacity-50\" />\n              <p className=\"text-lg\">No invoices found</p>\n              <p className=\"text-sm mt-1\">This resident has no bills yet</p>\n            </div>\n          ) : (\n            <Table>\n              <TableHeader>\n                <TableRow>\n                  <TableHead>Invoice #</TableHead>\n                  <TableHead>Description</TableHead>\n                  <TableHead>Amount</TableHead>\n                  <TableHead>Due Date</TableHead>\n                  <TableHead>Status</TableHead>\n                  <TableHead className=\"text-right\">Action</TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>\n                {bills.map((bill) => (\n                  <TableRow key={bill.id} data-testid={`invoice-row-${bill.id}`}>\n                    <TableCell className=\"font-medium\">\n                      {bill.invoiceNumber || `INV-${bill.id.slice(0, 8)}`}\n                    </TableCell>\n                    <TableCell>{bill.description}</TableCell>\n                    <TableCell className=\"font-semibold\">\n                      ₦{parseFloat(bill.amount).toLocaleString('en-NG', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                    </TableCell>\n                    <TableCell>{new Date(bill.dueDate).toLocaleDateString()}</TableCell>\n                    <TableCell>\n                      <Badge variant={bill.status === \"paid\" ? \"default\" : bill.status === \"overdue\" ? \"destructive\" : \"secondary\"}>\n                        {bill.status}\n                      </Badge>\n                    </TableCell>\n                    <TableCell className=\"text-right\">\n                      <Button\n                        size=\"sm\"\n                        variant=\"outline\"\n                        onClick={() => handleDownloadInvoice(bill.id, bill.invoiceNumber || '')}\n                        disabled={downloadingBillId === bill.id}\n                        data-testid={`button-download-invoice-${bill.id}`}\n                      >\n                        <Download className=\"h-4 w-4 mr-2\" />\n                        {downloadingBillId === bill.id ? 'Downloading...' : 'Download PDF'}\n                      </Button>\n                    </TableCell>\n                  </TableRow>\n                ))}\n              </TableBody>\n            </Table>\n          )}\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","size_bytes":61145},"client/src/pages/admin/account-status.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { useLocation } from \"wouter\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from \"recharts\";\nimport { Users, DollarSign, TrendingUp, AlertCircle } from \"lucide-react\";\n\ninterface AccountStatusData {\n  summary: {\n    totalResidents: number;\n    totalBilled: number;\n    totalCollected: number;\n    totalOutstanding: number;\n  };\n  aging: {\n    current: number;\n    '1-30': number;\n    '31-60': number;\n    '61-90': number;\n    '90+': number;\n  };\n}\n\ninterface ResidentWithUser {\n  residents: {\n    id: string;\n    unitNumber: string;\n  };\n  users: {\n    firstName: string | null;\n    lastName: string | null;\n  };\n}\n\nexport default function AccountStatus() {\n  const { toast } = useToast();\n  const { isAuthenticated, isLoading, user } = useAuth();\n  const [, setLocation] = useLocation();\n  \n  const [startDate, setStartDate] = useState(\"\");\n  const [endDate, setEndDate] = useState(\"\");\n  const [residentId, setResidentId] = useState(\"__all__\");\n  \n  const [appliedFilters, setAppliedFilters] = useState({\n    startDate: \"\",\n    endDate: \"\",\n    residentId: \"\",\n  });\n\n  useEffect(() => {\n    if (!isLoading && (!isAuthenticated || user?.role !== \"admin\")) {\n      toast({\n        title: \"Unauthorized\",\n        description: \"Admin access required\",\n        variant: \"destructive\",\n      });\n      setTimeout(() => {\n        setLocation(\"/\");\n      }, 500);\n      return;\n    }\n  }, [isAuthenticated, isLoading, user, toast, setLocation]);\n\n  const buildQueryKey = () => {\n    const params = new URLSearchParams();\n    if (appliedFilters.startDate) params.append('startDate', appliedFilters.startDate);\n    if (appliedFilters.endDate) params.append('endDate', appliedFilters.endDate);\n    if (appliedFilters.residentId) params.append('residentId', appliedFilters.residentId);\n    const queryString = params.toString();\n    return `/api/admin/account-status${queryString ? `?${queryString}` : ''}`;\n  };\n\n  const { data, isLoading: isDataLoading } = useQuery<AccountStatusData>({\n    queryKey: [buildQueryKey()],\n    enabled: isAuthenticated && user?.role === \"admin\",\n  });\n\n  const { data: residents } = useQuery<ResidentWithUser[]>({\n    queryKey: ['/api/admin/residents'],\n    enabled: isAuthenticated && user?.role === \"admin\",\n  });\n\n  const handleApplyFilters = () => {\n    setAppliedFilters({\n      startDate,\n      endDate,\n      residentId: residentId === \"__all__\" ? \"\" : residentId,\n    });\n  };\n\n  const handleResetFilters = () => {\n    setStartDate(\"\");\n    setEndDate(\"\");\n    setResidentId(\"__all__\");\n    setAppliedFilters({\n      startDate: \"\",\n      endDate: \"\",\n      residentId: \"\",\n    });\n  };\n\n  if (isLoading || !isAuthenticated || user?.role !== \"admin\") {\n    return (\n      <div className=\"flex h-screen items-center justify-center\">\n        <div className=\"animate-spin w-8 h-8 border-4 border-primary border-t-transparent rounded-full\" />\n      </div>\n    );\n  }\n\n  const agingChartData = data ? [\n    { name: 'Current', amount: data.aging.current, fill: 'hsl(var(--chart-1))' },\n    { name: '1-30 Days', amount: data.aging['1-30'], fill: 'hsl(var(--chart-2))' },\n    { name: '31-60 Days', amount: data.aging['31-60'], fill: 'hsl(var(--chart-3))' },\n    { name: '61-90 Days', amount: data.aging['61-90'], fill: 'hsl(var(--chart-4))' },\n    { name: '90+ Days', amount: data.aging['90+'], fill: 'hsl(var(--chart-5))' },\n  ] : [];\n\n  const formatCurrency = (amount: number) => {\n    return new Intl.NumberFormat('en-NG', {\n      style: 'currency',\n      currency: 'NGN',\n      minimumFractionDigits: 2,\n    }).format(amount);\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      <div>\n        <h1 className=\"text-3xl font-semibold\">Residents account status</h1>\n        <p className=\"text-muted-foreground mt-1\">Resident billing and collection analysis</p>\n      </div>\n\n      {/* Filters Card */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Filters</CardTitle>\n          <CardDescription>Filter data by date range and resident name</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"filter-start-date\">Start Date</Label>\n              <Input\n                id=\"filter-start-date\"\n                type=\"date\"\n                value={startDate}\n                onChange={(e) => setStartDate(e.target.value)}\n                data-testid=\"input-start-date\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"filter-end-date\">End Date</Label>\n              <Input\n                id=\"filter-end-date\"\n                type=\"date\"\n                value={endDate}\n                onChange={(e) => setEndDate(e.target.value)}\n                data-testid=\"input-end-date\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"filter-resident-name\">Resident Name</Label>\n              <Select\n                value={residentId}\n                onValueChange={setResidentId}\n              >\n                <SelectTrigger id=\"filter-resident-name\" data-testid=\"select-resident-name\">\n                  <SelectValue placeholder=\"Select a resident\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"__all__\" data-testid=\"select-resident-all\">All Residents</SelectItem>\n                  {residents?.map((row) => {\n                    if (!row.users || !row.residents) return null;\n                    const displayName = `${row.users.firstName || ''} ${row.users.lastName || ''} - Unit ${row.residents.unitNumber}`.trim();\n                    return (\n                      <SelectItem \n                        key={row.residents.id} \n                        value={row.residents.id}\n                        data-testid={`select-resident-${row.residents.id}`}\n                      >\n                        {displayName}\n                      </SelectItem>\n                    );\n                  })}\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"space-y-2 flex items-end gap-2\">\n              <Button onClick={handleApplyFilters} className=\"flex-1\" data-testid=\"button-apply-filters\">\n                Apply Filters\n              </Button>\n              <Button onClick={handleResetFilters} variant=\"outline\" data-testid=\"button-reset-filters\">\n                Reset\n              </Button>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Summary Cards */}\n      {isDataLoading ? (\n        <div className=\"flex justify-center py-12\">\n          <div className=\"animate-spin w-8 h-8 border-4 border-primary border-t-transparent rounded-full\" />\n        </div>\n      ) : data ? (\n        <>\n          <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-4\">\n            <Card>\n              <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n                <CardTitle className=\"text-sm font-medium\">Total Residents</CardTitle>\n                <Users className=\"h-4 w-4 text-muted-foreground\" />\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-2xl font-bold\" data-testid=\"text-total-residents\">\n                  {data.summary.totalResidents}\n                </div>\n                <p className=\"text-xs text-muted-foreground mt-1\">\n                  Active resident accounts\n                </p>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n                <CardTitle className=\"text-sm font-medium\">Total Service Charge Billed</CardTitle>\n                <DollarSign className=\"h-4 w-4 text-muted-foreground\" />\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-2xl font-bold\" data-testid=\"text-total-billed\">\n                  {formatCurrency(data.summary.totalBilled)}\n                </div>\n                <p className=\"text-xs text-muted-foreground mt-1\">\n                  All invoiced amounts\n                </p>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n                <CardTitle className=\"text-sm font-medium\">Total Collected</CardTitle>\n                <TrendingUp className=\"h-4 w-4 text-muted-foreground\" />\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-2xl font-bold\" data-testid=\"text-total-collected\">\n                  {formatCurrency(data.summary.totalCollected)}\n                </div>\n                <p className=\"text-xs text-muted-foreground mt-1\">\n                  Payments received\n                </p>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n                <CardTitle className=\"text-sm font-medium\">Total Outstanding</CardTitle>\n                <AlertCircle className=\"h-4 w-4 text-muted-foreground\" />\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-2xl font-bold text-destructive\" data-testid=\"text-total-outstanding\">\n                  {formatCurrency(data.summary.totalOutstanding)}\n                </div>\n                <p className=\"text-xs text-muted-foreground mt-1\">\n                  Unpaid balances\n                </p>\n              </CardContent>\n            </Card>\n          </div>\n\n          {/* Aging Analysis Chart */}\n          <Card>\n            <CardHeader>\n              <CardTitle>Aging Analysis</CardTitle>\n              <CardDescription>Outstanding bills categorized by days overdue</CardDescription>\n            </CardHeader>\n            <CardContent>\n              <ResponsiveContainer width=\"100%\" height={350}>\n                <BarChart data={agingChartData}>\n                  <CartesianGrid strokeDasharray=\"3 3\" />\n                  <XAxis dataKey=\"name\" />\n                  <YAxis \n                    tickFormatter={(value) => `₦${(value / 1000).toFixed(0)}k`}\n                  />\n                  <Tooltip \n                    formatter={(value: number) => formatCurrency(value)}\n                    labelStyle={{ color: 'hsl(var(--foreground))' }}\n                    contentStyle={{\n                      backgroundColor: 'hsl(var(--popover))',\n                      border: '1px solid hsl(var(--border))',\n                      borderRadius: '8px',\n                    }}\n                  />\n                  <Legend />\n                  <Bar \n                    dataKey=\"amount\" \n                    name=\"Amount (₦)\"\n                    radius={[4, 4, 0, 0]}\n                  />\n                </BarChart>\n              </ResponsiveContainer>\n            </CardContent>\n          </Card>\n        </>\n      ) : (\n        <Card>\n          <CardContent className=\"py-12\">\n            <p className=\"text-center text-muted-foreground\">No data available</p>\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  );\n}\n","size_bytes":11804},"server/seed-accounting.ts":{"content":"import { storage } from \"./storage\";\n\n/**\n * Seed Chart of Accounts and Transaction Templates\n * for Estate/Residents' Association Accounting System\n * \n * Structure tailored for estate management with focus on:\n * - Service charge collection and tracking\n * - Operational expenses (security, cleaning, utilities, maintenance)\n * - Minimal revenue accounts (associations typically operate at break-even)\n */\n\nasync function seedAccounting() {\n  console.log(\"Starting estate association accounting system seed...\");\n\n  try {\n    const existingAccounts = await storage.getAllAccounts();\n    if (existingAccounts.length > 0) {\n      console.log(\"Accounts already exist. Skipping seed.\");\n      return;\n    }\n\n    console.log(\"Creating Chart of Accounts...\");\n\n    // ==================== ASSET ACCOUNTS (1000-1999) ====================\n    \n    const bankAccount = await storage.createAccount({\n      accountNumber: \"1010\",\n      accountName: \"Bank Account\",\n      accountType: \"asset\",\n      category: \"Cash and Bank\",\n      description: \"Main estate bank account for all operations\",\n      normalBalance: \"debit\",\n      isSystemAccount: true,\n    });\n\n    const accountsReceivableAccount = await storage.createAccount({\n      accountNumber: \"1020\",\n      accountName: \"Accounts Receivable – Residents\",\n      accountType: \"asset\",\n      category: \"Receivables\",\n      description: \"Outstanding service charges and fees owed by residents\",\n      normalBalance: \"debit\",\n      isSystemAccount: true,\n    });\n\n    const prepaidExpensesAccount = await storage.createAccount({\n      accountNumber: \"1030\",\n      accountName: \"Prepaid Expenses\",\n      accountType: \"asset\",\n      category: \"Prepayments\",\n      description: \"Insurance, contracts, and other expenses paid in advance\",\n      normalBalance: \"debit\",\n      isSystemAccount: false,\n    });\n\n    // ==================== LIABILITY ACCOUNTS (2000-2999) ====================\n    \n    const maintenanceFundAccount = await storage.createAccount({\n      accountNumber: \"2010\",\n      accountName: \"Estate Maintenance Fund\",\n      accountType: \"liability\",\n      category: \"Funds\",\n      description: \"Service charge collections held for estate maintenance\",\n      normalBalance: \"credit\",\n      isSystemAccount: true,\n    });\n\n    const sinkingFundAccount = await storage.createAccount({\n      accountNumber: \"2020\",\n      accountName: \"Sinking Fund\",\n      accountType: \"liability\",\n      category: \"Funds\",\n      description: \"Long-term capital project reserves\",\n      normalBalance: \"credit\",\n      isSystemAccount: false,\n    });\n\n    const accountsPayableAccount = await storage.createAccount({\n      accountNumber: \"2030\",\n      accountName: \"Accounts Payable\",\n      accountType: \"liability\",\n      category: \"Payables\",\n      description: \"Amounts owed to vendors and service providers\",\n      normalBalance: \"credit\",\n      isSystemAccount: false,\n    });\n\n    const accruedExpensesAccount = await storage.createAccount({\n      accountNumber: \"2040\",\n      accountName: \"Accrued Expenses\",\n      accountType: \"liability\",\n      category: \"Accruals\",\n      description: \"Expenses incurred but not yet paid\",\n      normalBalance: \"credit\",\n      isSystemAccount: false,\n    });\n\n    const whtPayableAccount = await storage.createAccount({\n      accountNumber: \"2300\",\n      accountName: \"WHT Payable\",\n      accountType: \"liability\",\n      category: \"Tax Liabilities\",\n      description: \"Withholding tax deducted from vendor payments, payable to tax authority\",\n      normalBalance: \"credit\",\n      isSystemAccount: true,\n    });\n\n    // ==================== EQUITY ACCOUNTS (3000-3999) ====================\n    \n    const retainedEarningsAccount = await storage.createAccount({\n      accountNumber: \"3010\",\n      accountName: \"Retained Earnings\",\n      accountType: \"equity\",\n      category: \"Equity\",\n      description: \"Accumulated surplus from prior years\",\n      normalBalance: \"credit\",\n      isSystemAccount: true,\n    });\n\n    // ==================== REVENUE/INCOME ACCOUNTS (4000-4999) ====================\n    \n    const administrativeChargesAccount = await storage.createAccount({\n      accountNumber: \"4010\",\n      accountName: \"Administrative Charges\",\n      accountType: \"revenue\",\n      category: \"Revenue\",\n      description: \"Administrative fees charged to residents (if any)\",\n      normalBalance: \"credit\",\n      isSystemAccount: false,\n    });\n\n    const penaltiesAccount = await storage.createAccount({\n      accountNumber: \"4020\",\n      accountName: \"Penalties / Late Payment Fees\",\n      accountType: \"revenue\",\n      category: \"Revenue\",\n      description: \"Late payment penalties and other fines\",\n      normalBalance: \"credit\",\n      isSystemAccount: false,\n    });\n\n    // ==================== EXPENSE ACCOUNTS (5000-5999) ====================\n    \n    const securityExpenseAccount = await storage.createAccount({\n      accountNumber: \"5010\",\n      accountName: \"Security & Guards\",\n      accountType: \"expense\",\n      category: \"Security\",\n      description: \"Security personnel salaries and equipment\",\n      normalBalance: \"debit\",\n      isSystemAccount: false,\n    });\n\n    const cleaningExpenseAccount = await storage.createAccount({\n      accountNumber: \"5020\",\n      accountName: \"Cleaning & Janitorial\",\n      accountType: \"expense\",\n      category: \"Maintenance\",\n      description: \"Cleaning services and janitorial supplies\",\n      normalBalance: \"debit\",\n      isSystemAccount: false,\n    });\n\n    const wasteManagementAccount = await storage.createAccount({\n      accountNumber: \"5030\",\n      accountName: \"Waste Management\",\n      accountType: \"expense\",\n      category: \"Utilities\",\n      description: \"Waste collection and disposal services\",\n      normalBalance: \"debit\",\n      isSystemAccount: false,\n    });\n\n    const dieselGeneratorAccount = await storage.createAccount({\n      accountNumber: \"5040\",\n      accountName: \"Diesel / Generator\",\n      accountType: \"expense\",\n      category: \"Utilities\",\n      description: \"Generator fuel and maintenance costs\",\n      normalBalance: \"debit\",\n      isSystemAccount: false,\n    });\n\n    const electricalRepairsAccount = await storage.createAccount({\n      accountNumber: \"5050\",\n      accountName: \"Electrical Repairs\",\n      accountType: \"expense\",\n      category: \"Repairs\",\n      description: \"Electrical system repairs and maintenance\",\n      normalBalance: \"debit\",\n      isSystemAccount: false,\n    });\n\n    const plumbingRepairsAccount = await storage.createAccount({\n      accountNumber: \"5060\",\n      accountName: \"Plumbing Repairs\",\n      accountType: \"expense\",\n      category: \"Repairs\",\n      description: \"Plumbing system repairs and maintenance\",\n      normalBalance: \"debit\",\n      isSystemAccount: false,\n    });\n\n    const landscapingAccount = await storage.createAccount({\n      accountNumber: \"5070\",\n      accountName: \"Landscaping\",\n      accountType: \"expense\",\n      category: \"Maintenance\",\n      description: \"Lawn care, gardening, and landscaping services\",\n      normalBalance: \"debit\",\n      isSystemAccount: false,\n    });\n\n    const generalMaintenanceAccount = await storage.createAccount({\n      accountNumber: \"5080\",\n      accountName: \"General Maintenance\",\n      accountType: \"expense\",\n      category: \"Maintenance\",\n      description: \"General repairs and maintenance not covered elsewhere\",\n      normalBalance: \"debit\",\n      isSystemAccount: false,\n    });\n\n    const officeAdminExpenseAccount = await storage.createAccount({\n      accountNumber: \"5090\",\n      accountName: \"Office/Admin Expenses\",\n      accountType: \"expense\",\n      category: \"Administrative\",\n      description: \"Office supplies, stationery, and admin costs\",\n      normalBalance: \"debit\",\n      isSystemAccount: false,\n    });\n\n    console.log(\"Chart of Accounts created successfully!\");\n\n    // ==================== TRANSACTION TEMPLATES ====================\n    \n    console.log(\"Creating Transaction Templates...\");\n\n    await storage.createTransactionTemplate({\n      name: \"Collect Service Charge\",\n      description: \"Record service charge payment received from resident\",\n      transactionType: \"service_charge_collection\",\n      debitAccountId: bankAccount.id,\n      creditAccountId: maintenanceFundAccount.id,\n      isSystemTemplate: true,\n    });\n\n    await storage.createTransactionTemplate({\n      name: \"Record Receivable\",\n      description: \"Bill resident for service charge (create receivable)\",\n      transactionType: \"service_charge_billing\",\n      debitAccountId: accountsReceivableAccount.id,\n      creditAccountId: maintenanceFundAccount.id,\n      isSystemTemplate: true,\n    });\n\n    await storage.createTransactionTemplate({\n      name: \"Receive Payment on Account\",\n      description: \"Resident pays outstanding receivable\",\n      transactionType: \"payment_received\",\n      debitAccountId: bankAccount.id,\n      creditAccountId: accountsReceivableAccount.id,\n      isSystemTemplate: false,\n    });\n\n    await storage.createTransactionTemplate({\n      name: \"Pay Security Services\",\n      description: \"Pay security guards and security expenses\",\n      transactionType: \"pay_security\",\n      debitAccountId: securityExpenseAccount.id,\n      creditAccountId: bankAccount.id,\n      isSystemTemplate: false,\n    });\n\n    await storage.createTransactionTemplate({\n      name: \"Pay Cleaning Services\",\n      description: \"Pay for cleaning and janitorial services\",\n      transactionType: \"pay_cleaning\",\n      debitAccountId: cleaningExpenseAccount.id,\n      creditAccountId: bankAccount.id,\n      isSystemTemplate: false,\n    });\n\n    await storage.createTransactionTemplate({\n      name: \"Pay Waste Management\",\n      description: \"Pay for waste collection and disposal\",\n      transactionType: \"pay_waste\",\n      debitAccountId: wasteManagementAccount.id,\n      creditAccountId: bankAccount.id,\n      isSystemTemplate: false,\n    });\n\n    await storage.createTransactionTemplate({\n      name: \"Pay Diesel/Generator\",\n      description: \"Pay for diesel fuel and generator maintenance\",\n      transactionType: \"pay_diesel\",\n      debitAccountId: dieselGeneratorAccount.id,\n      creditAccountId: bankAccount.id,\n      isSystemTemplate: false,\n    });\n\n    await storage.createTransactionTemplate({\n      name: \"Pay General Maintenance\",\n      description: \"Pay for general estate maintenance and repairs\",\n      transactionType: \"pay_maintenance\",\n      debitAccountId: generalMaintenanceAccount.id,\n      creditAccountId: bankAccount.id,\n      isSystemTemplate: false,\n    });\n\n    await storage.createTransactionTemplate({\n      name: \"Record Late Payment Fee\",\n      description: \"Charge late payment penalty to resident\",\n      transactionType: \"late_fee\",\n      debitAccountId: accountsReceivableAccount.id,\n      creditAccountId: penaltiesAccount.id,\n      isSystemTemplate: false,\n    });\n\n    console.log(\"Transaction Templates created successfully!\");\n\n    console.log(\"\\n=== ESTATE ASSOCIATION ACCOUNTING SYSTEM SEED COMPLETE ===\");\n    console.log(\"\\nChart of Accounts Summary:\");\n    console.log(\"  Assets:      3 accounts\");\n    console.log(\"  Liabilities: 4 accounts\");\n    console.log(\"  Equity:      1 account\");\n    console.log(\"  Revenue:     2 accounts\");\n    console.log(\"  Expenses:    9 accounts\");\n    console.log(\"  TOTAL:       19 accounts\");\n    console.log(\"\\nTransaction Templates: 9 templates\");\n    console.log(\"\\nThe accountant can now manage the estate's financial records.\");\n\n  } catch (error) {\n    console.error(\"Error seeding accounting system:\", error);\n    throw error;\n  }\n}\n\nexport { seedAccounting };\n","size_bytes":11626},"server/run-seed.ts":{"content":"import { seedAccounting } from \"./seed-accounting\";\n\nseedAccounting()\n  .then(() => {\n    console.log(\"✓ Seed completed successfully\");\n    process.exit(0);\n  })\n  .catch((error) => {\n    console.error(\"✗ Seed failed:\", error);\n    process.exit(1);\n  });\n","size_bytes":259},"client/src/pages/accountant-dashboard.tsx":{"content":"import { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { BookOpen, FileText, LayoutList } from \"lucide-react\";\nimport { Link } from \"wouter\";\n\nexport default function AccountantDashboard() {\n  return (\n    <div className=\"space-y-8\">\n      <div>\n        <h1 className=\"text-3xl font-bold tracking-tight\">Accounting Dashboard</h1>\n        <p className=\"text-muted-foreground mt-2\">\n          Manage the estate's financial records and accounting system\n        </p>\n      </div>\n\n      <div className=\"grid gap-6 md:grid-cols-3\">\n        <Link href=\"/accountant/accounts\">\n          <Card className=\"hover-elevate cursor-pointer\" data-testid=\"card-chart-of-accounts\">\n            <CardHeader>\n              <div className=\"flex items-center gap-2\">\n                <BookOpen className=\"w-5 h-5 text-primary\" />\n                <CardTitle>Chart of Accounts</CardTitle>\n              </div>\n              <CardDescription>\n                Manage the estate's chart of accounts\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              <p className=\"text-2xl font-bold\">View Accounts</p>\n            </CardContent>\n          </Card>\n        </Link>\n\n        <Link href=\"/accountant/templates\">\n          <Card className=\"hover-elevate cursor-pointer\" data-testid=\"card-transaction-templates\">\n            <CardHeader>\n              <div className=\"flex items-center gap-2\">\n                <LayoutList className=\"w-5 h-5 text-primary\" />\n                <CardTitle>Transaction Templates</CardTitle>\n              </div>\n              <CardDescription>\n                Configure debit-credit pairs for transactions\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              <p className=\"text-2xl font-bold\">Manage Templates</p>\n            </CardContent>\n          </Card>\n        </Link>\n\n        <Link href=\"/accountant/entries\">\n          <Card className=\"hover-elevate cursor-pointer\" data-testid=\"card-journal-entries\">\n            <CardHeader>\n              <div className=\"flex items-center gap-2\">\n                <FileText className=\"w-5 h-5 text-primary\" />\n                <CardTitle>Journal Entries</CardTitle>\n              </div>\n              <CardDescription>\n                Record and view journal entries\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              <p className=\"text-2xl font-bold\">View Entries</p>\n            </CardContent>\n          </Card>\n        </Link>\n      </div>\n    </div>\n  );\n}\n","size_bytes":2592},"client/src/pages/accountant/transaction-templates.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from \"@/components/ui/dialog\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n} from \"@/components/ui/alert-dialog\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Plus, Pencil, Trash2, ArrowRight } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport type { TransactionTemplate, Account } from \"@shared/schema\";\n\nexport default function TransactionTemplates() {\n  const { toast } = useToast();\n  const [createDialogOpen, setCreateDialogOpen] = useState(false);\n  const [editDialogOpen, setEditDialogOpen] = useState(false);\n  const [deleteDialogOpen, setDeleteDialogOpen] = useState(false);\n  const [selectedTemplate, setSelectedTemplate] = useState<TransactionTemplate | null>(null);\n  \n  const [formData, setFormData] = useState({\n    name: \"\",\n    description: \"\",\n    transactionType: \"\",\n    debitAccountId: \"\",\n    creditAccountId: \"\",\n  });\n\n  const { data: templates, isLoading: templatesLoading } = useQuery<TransactionTemplate[]>({\n    queryKey: ['/api/accountant/templates'],\n  });\n\n  const { data: accounts } = useQuery<Account[]>({\n    queryKey: ['/api/accountant/accounts'],\n  });\n\n  const createMutation = useMutation({\n    mutationFn: async (data: { \n      name: string; \n      description: string; \n      transactionType: string;\n      debitAccountId: string; \n      creditAccountId: string;\n    }) => {\n      return await apiRequest('POST', '/api/accountant/templates', data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/accountant/templates'] });\n      setCreateDialogOpen(false);\n      resetForm();\n      toast({\n        title: \"Template created\",\n        description: \"The transaction template has been created\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Failed to create template\",\n        description: error.message || \"An error occurred\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: Partial<TransactionTemplate> }) => {\n      return await apiRequest('PATCH', `/api/accountant/templates/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/accountant/templates'] });\n      setEditDialogOpen(false);\n      setSelectedTemplate(null);\n      resetForm();\n      toast({\n        title: \"Template updated\",\n        description: \"The transaction template has been updated successfully\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Failed to update template\",\n        description: error.message || \"An error occurred\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return await apiRequest('DELETE', `/api/accountant/templates/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/accountant/templates'] });\n      setDeleteDialogOpen(false);\n      setSelectedTemplate(null);\n      toast({\n        title: \"Template deleted\",\n        description: \"The transaction template has been removed\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Failed to delete template\",\n        description: error.message || \"An error occurred\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const resetForm = () => {\n    setFormData({\n      name: \"\",\n      description: \"\",\n      transactionType: \"\",\n      debitAccountId: \"\",\n      creditAccountId: \"\",\n    });\n  };\n\n  const handleCreate = () => {\n    createMutation.mutate(formData);\n  };\n\n  const handleEdit = (template: TransactionTemplate) => {\n    setSelectedTemplate(template);\n    setFormData({\n      name: template.name,\n      description: template.description || \"\",\n      transactionType: template.transactionType,\n      debitAccountId: template.debitAccountId,\n      creditAccountId: template.creditAccountId,\n    });\n    setEditDialogOpen(true);\n  };\n\n  const handleUpdate = () => {\n    if (!selectedTemplate) return;\n    updateMutation.mutate({\n      id: selectedTemplate.id,\n      data: formData,\n    });\n  };\n\n  const handleDelete = (template: TransactionTemplate) => {\n    setSelectedTemplate(template);\n    setDeleteDialogOpen(true);\n  };\n\n  const confirmDelete = () => {\n    if (!selectedTemplate) return;\n    deleteMutation.mutate(selectedTemplate.id);\n  };\n\n  const getAccountName = (accountId: string) => {\n    const account = accounts?.find((a) => a.id === accountId);\n    return account ? `${account.accountNumber} - ${account.accountName}` : accountId;\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-bold\">Transaction Templates</h1>\n          <p className=\"text-muted-foreground mt-1\">\n            Create reusable templates for common accounting transactions\n          </p>\n        </div>\n        <Dialog open={createDialogOpen} onOpenChange={setCreateDialogOpen}>\n          <DialogTrigger asChild>\n            <Button data-testid=\"button-create-template\">\n              <Plus className=\"h-4 w-4 mr-2\" />\n              New Template\n            </Button>\n          </DialogTrigger>\n          <DialogContent className=\"max-w-2xl\" data-testid=\"dialog-create-template\">\n            <DialogHeader>\n              <DialogTitle>Create Transaction Template</DialogTitle>\n              <DialogDescription>\n                Define a reusable template for accounting transactions\n              </DialogDescription>\n            </DialogHeader>\n            <div className=\"space-y-4\">\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"col-span-2\">\n                  <Label htmlFor=\"name\">Template Name *</Label>\n                  <Input\n                    id=\"name\"\n                    value={formData.name}\n                    onChange={(e) => setFormData({ ...formData, name: e.target.value })}\n                    placeholder=\"e.g., Service Charge Billing\"\n                    data-testid=\"input-template-name\"\n                  />\n                </div>\n                <div className=\"col-span-2\">\n                  <Label htmlFor=\"description\">Description</Label>\n                  <Textarea\n                    id=\"description\"\n                    value={formData.description}\n                    onChange={(e) => setFormData({ ...formData, description: e.target.value })}\n                    placeholder=\"Describe what this template is used for\"\n                    data-testid=\"input-template-description\"\n                  />\n                </div>\n                <div className=\"col-span-2\">\n                  <Label htmlFor=\"transactionType\">Transaction Type *</Label>\n                  <Input\n                    id=\"transactionType\"\n                    value={formData.transactionType}\n                    onChange={(e) => setFormData({ ...formData, transactionType: e.target.value })}\n                    placeholder=\"e.g., service_charge, payment_received\"\n                    data-testid=\"input-transaction-type\"\n                  />\n                </div>\n              </div>\n\n              <div className=\"space-y-4\">\n                <div>\n                  <Label>Debit Account *</Label>\n                  <Select\n                    value={formData.debitAccountId}\n                    onValueChange={(value) => setFormData({ ...formData, debitAccountId: value })}\n                  >\n                    <SelectTrigger data-testid=\"select-debit-account\">\n                      <SelectValue placeholder=\"Select debit account\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      {accounts?.map((account) => (\n                        <SelectItem key={account.id} value={account.id}>\n                          {account.accountNumber} - {account.accountName}\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                </div>\n\n                <div>\n                  <Label>Credit Account *</Label>\n                  <Select\n                    value={formData.creditAccountId}\n                    onValueChange={(value) => setFormData({ ...formData, creditAccountId: value })}\n                  >\n                    <SelectTrigger data-testid=\"select-credit-account\">\n                      <SelectValue placeholder=\"Select credit account\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      {accounts?.map((account) => (\n                        <SelectItem key={account.id} value={account.id}>\n                          {account.accountNumber} - {account.accountName}\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                </div>\n              </div>\n            </div>\n            <DialogFooter>\n              <Button\n                variant=\"outline\"\n                onClick={() => setCreateDialogOpen(false)}\n                data-testid=\"button-cancel-create\"\n              >\n                Cancel\n              </Button>\n              <Button\n                onClick={handleCreate}\n                disabled={\n                  !formData.name ||\n                  !formData.transactionType ||\n                  !formData.debitAccountId ||\n                  !formData.creditAccountId ||\n                  createMutation.isPending\n                }\n                data-testid=\"button-submit-create\"\n              >\n                {createMutation.isPending ? \"Creating...\" : \"Create Template\"}\n              </Button>\n            </DialogFooter>\n          </DialogContent>\n        </Dialog>\n      </div>\n\n      {templatesLoading ? (\n        <div className=\"text-center py-8\">Loading templates...</div>\n      ) : !templates || templates.length === 0 ? (\n        <div className=\"text-center py-8 text-muted-foreground\">\n          No templates found. Create your first template to get started.\n        </div>\n      ) : (\n        <div className=\"border rounded-lg\">\n          <Table>\n            <TableHeader>\n              <TableRow>\n                <TableHead>Template Name</TableHead>\n                <TableHead>Type</TableHead>\n                <TableHead>Description</TableHead>\n                <TableHead>Debit → Credit</TableHead>\n                <TableHead className=\"w-32\">Actions</TableHead>\n              </TableRow>\n            </TableHeader>\n            <TableBody>\n              {templates.map((template) => (\n                <TableRow key={template.id} data-testid={`row-template-${template.id}`}>\n                  <TableCell className=\"font-medium\">{template.name}</TableCell>\n                  <TableCell>\n                    <Badge variant=\"outline\" className=\"text-xs\">\n                      {template.transactionType}\n                    </Badge>\n                  </TableCell>\n                  <TableCell className=\"text-muted-foreground\">\n                    {template.description || \"-\"}\n                  </TableCell>\n                  <TableCell>\n                    <div className=\"flex items-center gap-2\">\n                      <Badge variant=\"secondary\" className=\"text-xs\">\n                        DR: {getAccountName(template.debitAccountId).split(\" - \")[0]}\n                      </Badge>\n                      <ArrowRight className=\"h-4 w-4 text-muted-foreground\" />\n                      <Badge variant=\"secondary\" className=\"text-xs\">\n                        CR: {getAccountName(template.creditAccountId).split(\" - \")[0]}\n                      </Badge>\n                    </div>\n                  </TableCell>\n                  <TableCell>\n                    <div className=\"flex items-center gap-2\">\n                      <Button\n                        variant=\"ghost\"\n                        size=\"icon\"\n                        onClick={() => handleEdit(template)}\n                        data-testid={`button-edit-${template.id}`}\n                      >\n                        <Pencil className=\"h-4 w-4\" />\n                      </Button>\n                      <Button\n                        variant=\"ghost\"\n                        size=\"icon\"\n                        onClick={() => handleDelete(template)}\n                        disabled={template.isSystemTemplate}\n                        data-testid={`button-delete-${template.id}`}\n                      >\n                        <Trash2 className=\"h-4 w-4\" />\n                      </Button>\n                    </div>\n                  </TableCell>\n                </TableRow>\n              ))}\n            </TableBody>\n          </Table>\n        </div>\n      )}\n\n      <Dialog open={editDialogOpen} onOpenChange={setEditDialogOpen}>\n        <DialogContent className=\"max-w-2xl\" data-testid=\"dialog-edit-template\">\n          <DialogHeader>\n            <DialogTitle>Edit Transaction Template</DialogTitle>\n            <DialogDescription>\n              Update template configuration\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"col-span-2\">\n                <Label htmlFor=\"edit-name\">Template Name *</Label>\n                <Input\n                  id=\"edit-name\"\n                  value={formData.name}\n                  onChange={(e) => setFormData({ ...formData, name: e.target.value })}\n                  data-testid=\"input-edit-name\"\n                />\n              </div>\n              <div className=\"col-span-2\">\n                <Label htmlFor=\"edit-description\">Description</Label>\n                <Textarea\n                  id=\"edit-description\"\n                  value={formData.description}\n                  onChange={(e) => setFormData({ ...formData, description: e.target.value })}\n                  data-testid=\"input-edit-description\"\n                />\n              </div>\n              <div className=\"col-span-2\">\n                <Label htmlFor=\"edit-transactionType\">Transaction Type *</Label>\n                <Input\n                  id=\"edit-transactionType\"\n                  value={formData.transactionType}\n                  onChange={(e) => setFormData({ ...formData, transactionType: e.target.value })}\n                  data-testid=\"input-edit-transaction-type\"\n                />\n              </div>\n            </div>\n\n            <div className=\"space-y-4\">\n              <div>\n                <Label>Debit Account *</Label>\n                <Select\n                  value={formData.debitAccountId}\n                  onValueChange={(value) => setFormData({ ...formData, debitAccountId: value })}\n                >\n                  <SelectTrigger data-testid=\"select-edit-debit-account\">\n                    <SelectValue placeholder=\"Select debit account\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {accounts?.map((account) => (\n                      <SelectItem key={account.id} value={account.id}>\n                        {account.accountNumber} - {account.accountName}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n\n              <div>\n                <Label>Credit Account *</Label>\n                <Select\n                  value={formData.creditAccountId}\n                  onValueChange={(value) => setFormData({ ...formData, creditAccountId: value })}\n                >\n                  <SelectTrigger data-testid=\"select-edit-credit-account\">\n                    <SelectValue placeholder=\"Select credit account\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {accounts?.map((account) => (\n                      <SelectItem key={account.id} value={account.id}>\n                        {account.accountNumber} - {account.accountName}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n            </div>\n          </div>\n          <DialogFooter>\n            <Button\n              variant=\"outline\"\n              onClick={() => setEditDialogOpen(false)}\n              data-testid=\"button-cancel-edit\"\n            >\n              Cancel\n            </Button>\n            <Button\n              onClick={handleUpdate}\n              disabled={\n                !formData.name ||\n                !formData.transactionType ||\n                !formData.debitAccountId ||\n                !formData.creditAccountId ||\n                updateMutation.isPending\n              }\n              data-testid=\"button-submit-edit\"\n            >\n              {updateMutation.isPending ? \"Updating...\" : \"Update Template\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      <AlertDialog open={deleteDialogOpen} onOpenChange={setDeleteDialogOpen}>\n        <AlertDialogContent data-testid=\"dialog-delete-template\">\n          <AlertDialogHeader>\n            <AlertDialogTitle>Delete Template</AlertDialogTitle>\n            <AlertDialogDescription>\n              Are you sure you want to delete \"{selectedTemplate?.name}\"? This action cannot be undone.\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel data-testid=\"button-cancel-delete\">Cancel</AlertDialogCancel>\n            <AlertDialogAction\n              onClick={confirmDelete}\n              className=\"bg-destructive text-destructive-foreground hover:bg-destructive/90\"\n              data-testid=\"button-confirm-delete\"\n            >\n              {deleteMutation.isPending ? \"Deleting...\" : \"Delete\"}\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n    </div>\n  );\n}\n","size_bytes":18756},"client/src/pages/accountant/chart-of-accounts.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from \"@/components/ui/dialog\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n} from \"@/components/ui/alert-dialog\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Plus, Pencil, Trash2 } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport type { Account } from \"@shared/schema\";\n\ntype AccountType = \"Asset\" | \"Liability\" | \"Equity\" | \"Revenue\" | \"Expense\";\n\nconst accountTypeBadgeVariants: Record<AccountType, string> = {\n  Asset: \"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200\",\n  Liability: \"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200\",\n  Equity: \"bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200\",\n  Revenue: \"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200\",\n  Expense: \"bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200\",\n};\n\nexport default function ChartOfAccounts() {\n  const { toast } = useToast();\n  const [filterType, setFilterType] = useState<string>(\"all\");\n  const [createDialogOpen, setCreateDialogOpen] = useState(false);\n  const [editDialogOpen, setEditDialogOpen] = useState(false);\n  const [deleteDialogOpen, setDeleteDialogOpen] = useState(false);\n  const [selectedAccount, setSelectedAccount] = useState<Account | null>(null);\n  \n  const [formData, setFormData] = useState({\n    accountNumber: \"\",\n    accountName: \"\",\n    accountType: \"\" as AccountType | \"\",\n  });\n\n  const { data: accounts, isLoading } = useQuery<Account[]>({\n    queryKey: ['/api/accountant/accounts'],\n  });\n\n  const createMutation = useMutation({\n    mutationFn: async (data: { accountNumber: string; accountName: string; accountType: string; normalBalance: \"debit\" | \"credit\" }) => {\n      return await apiRequest('POST', '/api/accountant/accounts', data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/accountant/accounts'] });\n      setCreateDialogOpen(false);\n      resetForm();\n      toast({\n        title: \"Account created\",\n        description: \"The account has been added to the chart of accounts\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Failed to create account\",\n        description: error.message || \"An error occurred\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: Partial<Account> }) => {\n      return await apiRequest('PATCH', `/api/accountant/accounts/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/accountant/accounts'] });\n      setEditDialogOpen(false);\n      setSelectedAccount(null);\n      resetForm();\n      toast({\n        title: \"Account updated\",\n        description: \"The account has been updated successfully\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Failed to update account\",\n        description: error.message || \"An error occurred\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return await apiRequest('DELETE', `/api/accountant/accounts/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/accountant/accounts'] });\n      setDeleteDialogOpen(false);\n      setSelectedAccount(null);\n      toast({\n        title: \"Account deleted\",\n        description: \"The account has been removed from the chart of accounts\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Failed to delete account\",\n        description: error.message || \"An error occurred\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const resetForm = () => {\n    setFormData({\n      accountNumber: \"\",\n      accountName: \"\",\n      accountType: \"\",\n    });\n  };\n\n  const getNormalBalance = (accountType: string): \"debit\" | \"credit\" => {\n    const type = accountType.toLowerCase();\n    // Asset and Expense accounts have debit normal balance\n    // Liability, Equity, and Revenue accounts have credit normal balance\n    return (type === \"asset\" || type === \"expense\") ? \"debit\" : \"credit\";\n  };\n\n  const handleCreate = () => {\n    if (!formData.accountType) return;\n    const accountType = formData.accountType.toLowerCase();\n    createMutation.mutate({\n      accountNumber: formData.accountNumber,\n      accountName: formData.accountName,\n      accountType: accountType as any,\n      normalBalance: getNormalBalance(accountType),\n    });\n  };\n\n  const handleEdit = (account: Account) => {\n    setSelectedAccount(account);\n    setFormData({\n      accountNumber: account.accountNumber,\n      accountName: account.accountName,\n      accountType: (account.accountType.charAt(0).toUpperCase() + account.accountType.slice(1)) as AccountType,\n    });\n    setEditDialogOpen(true);\n  };\n\n  const handleUpdate = () => {\n    if (!selectedAccount || !formData.accountType) return;\n    const accountType = formData.accountType.toLowerCase();\n    updateMutation.mutate({\n      id: selectedAccount.id,\n      data: {\n        accountNumber: formData.accountNumber,\n        accountName: formData.accountName,\n        accountType: accountType as any,\n        normalBalance: getNormalBalance(accountType),\n      },\n    });\n  };\n\n  const handleDelete = (account: Account) => {\n    setSelectedAccount(account);\n    setDeleteDialogOpen(true);\n  };\n\n  const confirmDelete = () => {\n    if (!selectedAccount) return;\n    deleteMutation.mutate(selectedAccount.id);\n  };\n\n  const filteredAccounts = accounts?.filter(\n    (account) => filterType === \"all\" || account.accountType === filterType\n  ) || [];\n\n  const groupedAccounts = filteredAccounts.reduce((acc, account) => {\n    const type = account.accountType;\n    if (!acc[type]) {\n      acc[type] = [];\n    }\n    acc[type].push(account);\n    return acc;\n  }, {} as Record<string, Account[]>);\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-bold tracking-tight\">Chart of Accounts</h1>\n          <p className=\"text-muted-foreground mt-2\">\n            Manage the estate's accounting chart of accounts\n          </p>\n        </div>\n        <Dialog open={createDialogOpen} onOpenChange={setCreateDialogOpen}>\n          <DialogTrigger asChild>\n            <Button data-testid=\"button-create-account\">\n              <Plus className=\"mr-2 h-4 w-4\" />\n              New Account\n            </Button>\n          </DialogTrigger>\n          <DialogContent data-testid=\"dialog-create-account\">\n            <DialogHeader>\n              <DialogTitle>Create New Account</DialogTitle>\n              <DialogDescription>\n                Add a new account to the chart of accounts\n              </DialogDescription>\n            </DialogHeader>\n            <div className=\"space-y-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"accountNumber\">Account Number</Label>\n                <Input\n                  id=\"accountNumber\"\n                  data-testid=\"input-account-number\"\n                  placeholder=\"e.g., 1010\"\n                  value={formData.accountNumber}\n                  onChange={(e) =>\n                    setFormData({ ...formData, accountNumber: e.target.value })\n                  }\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"accountName\">Account Name</Label>\n                <Input\n                  id=\"accountName\"\n                  data-testid=\"input-account-name\"\n                  placeholder=\"e.g., Cash in Bank\"\n                  value={formData.accountName}\n                  onChange={(e) =>\n                    setFormData({ ...formData, accountName: e.target.value })\n                  }\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"accountType\">Account Type</Label>\n                <Select\n                  value={formData.accountType}\n                  onValueChange={(value) =>\n                    setFormData({ ...formData, accountType: value as AccountType })\n                  }\n                >\n                  <SelectTrigger id=\"accountType\" data-testid=\"select-account-type\">\n                    <SelectValue placeholder=\"Select account type\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"Asset\">Asset</SelectItem>\n                    <SelectItem value=\"Liability\">Liability</SelectItem>\n                    <SelectItem value=\"Equity\">Equity</SelectItem>\n                    <SelectItem value=\"Revenue\">Revenue</SelectItem>\n                    <SelectItem value=\"Expense\">Expense</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n            </div>\n            <DialogFooter>\n              <Button\n                variant=\"outline\"\n                onClick={() => {\n                  setCreateDialogOpen(false);\n                  resetForm();\n                }}\n                data-testid=\"button-cancel-create\"\n              >\n                Cancel\n              </Button>\n              <Button\n                onClick={handleCreate}\n                disabled={\n                  !formData.accountNumber ||\n                  !formData.accountName ||\n                  !formData.accountType ||\n                  createMutation.isPending\n                }\n                data-testid=\"button-submit-create\"\n              >\n                {createMutation.isPending ? \"Creating...\" : \"Create Account\"}\n              </Button>\n            </DialogFooter>\n          </DialogContent>\n        </Dialog>\n      </div>\n\n      <div className=\"flex items-center gap-4\">\n        <Label htmlFor=\"filter\">Filter by Type:</Label>\n        <Select value={filterType} onValueChange={setFilterType}>\n          <SelectTrigger className=\"w-48\" id=\"filter\" data-testid=\"select-filter-type\">\n            <SelectValue />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"all\">All Types</SelectItem>\n            <SelectItem value=\"Asset\">Asset</SelectItem>\n            <SelectItem value=\"Liability\">Liability</SelectItem>\n            <SelectItem value=\"Equity\">Equity</SelectItem>\n            <SelectItem value=\"Revenue\">Revenue</SelectItem>\n            <SelectItem value=\"Expense\">Expense</SelectItem>\n          </SelectContent>\n        </Select>\n      </div>\n\n      {isLoading ? (\n        <div className=\"text-center py-8\">Loading accounts...</div>\n      ) : filteredAccounts.length === 0 ? (\n        <div className=\"text-center py-8 text-muted-foreground\">\n          No accounts found. Create your first account to get started.\n        </div>\n      ) : (\n        <div className=\"space-y-8\">\n          {Object.entries(groupedAccounts).map(([type, typeAccounts]) => (\n            <div key={type} className=\"space-y-4\">\n              <h2 className=\"text-xl font-semibold flex items-center gap-2\">\n                {type}\n                <Badge className={accountTypeBadgeVariants[type as AccountType]}>\n                  {typeAccounts.length}\n                </Badge>\n              </h2>\n              <div className=\"border rounded-lg\">\n                <Table>\n                  <TableHeader>\n                    <TableRow>\n                      <TableHead>Account Number</TableHead>\n                      <TableHead>Account Name</TableHead>\n                      <TableHead className=\"w-32\">Actions</TableHead>\n                    </TableRow>\n                  </TableHeader>\n                  <TableBody>\n                    {typeAccounts.map((account) => (\n                      <TableRow key={account.id} data-testid={`row-account-${account.id}`}>\n                        <TableCell className=\"font-mono\">\n                          {account.accountNumber}\n                        </TableCell>\n                        <TableCell>{account.accountName}</TableCell>\n                        <TableCell>\n                          <div className=\"flex items-center gap-2\">\n                            <Button\n                              variant=\"ghost\"\n                              size=\"icon\"\n                              onClick={() => handleEdit(account)}\n                              data-testid={`button-edit-${account.id}`}\n                            >\n                              <Pencil className=\"h-4 w-4\" />\n                            </Button>\n                            <Button\n                              variant=\"ghost\"\n                              size=\"icon\"\n                              onClick={() => handleDelete(account)}\n                              data-testid={`button-delete-${account.id}`}\n                            >\n                              <Trash2 className=\"h-4 w-4\" />\n                            </Button>\n                          </div>\n                        </TableCell>\n                      </TableRow>\n                    ))}\n                  </TableBody>\n                </Table>\n              </div>\n            </div>\n          ))}\n        </div>\n      )}\n\n      <Dialog open={editDialogOpen} onOpenChange={setEditDialogOpen}>\n        <DialogContent data-testid=\"dialog-edit-account\">\n          <DialogHeader>\n            <DialogTitle>Edit Account</DialogTitle>\n            <DialogDescription>\n              Update account information\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"edit-accountNumber\">Account Number</Label>\n              <Input\n                id=\"edit-accountNumber\"\n                data-testid=\"input-edit-account-number\"\n                value={formData.accountNumber}\n                onChange={(e) =>\n                  setFormData({ ...formData, accountNumber: e.target.value })\n                }\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"edit-accountName\">Account Name</Label>\n              <Input\n                id=\"edit-accountName\"\n                data-testid=\"input-edit-account-name\"\n                value={formData.accountName}\n                onChange={(e) =>\n                  setFormData({ ...formData, accountName: e.target.value })\n                }\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"edit-accountType\">Account Type</Label>\n              <Select\n                value={formData.accountType}\n                onValueChange={(value) =>\n                  setFormData({ ...formData, accountType: value as AccountType })\n                }\n              >\n                <SelectTrigger id=\"edit-accountType\" data-testid=\"select-edit-account-type\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"Asset\">Asset</SelectItem>\n                  <SelectItem value=\"Liability\">Liability</SelectItem>\n                  <SelectItem value=\"Equity\">Equity</SelectItem>\n                  <SelectItem value=\"Revenue\">Revenue</SelectItem>\n                  <SelectItem value=\"Expense\">Expense</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n          <DialogFooter>\n            <Button\n              variant=\"outline\"\n              onClick={() => {\n                setEditDialogOpen(false);\n                setSelectedAccount(null);\n                resetForm();\n              }}\n              data-testid=\"button-cancel-edit\"\n            >\n              Cancel\n            </Button>\n            <Button\n              onClick={handleUpdate}\n              disabled={\n                !formData.accountNumber ||\n                !formData.accountName ||\n                !formData.accountType ||\n                updateMutation.isPending\n              }\n              data-testid=\"button-submit-edit\"\n            >\n              {updateMutation.isPending ? \"Updating...\" : \"Update Account\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      <AlertDialog open={deleteDialogOpen} onOpenChange={setDeleteDialogOpen}>\n        <AlertDialogContent data-testid=\"dialog-delete-account\">\n          <AlertDialogHeader>\n            <AlertDialogTitle>Are you sure?</AlertDialogTitle>\n            <AlertDialogDescription>\n              This will permanently delete the account \"{selectedAccount?.accountName}\n              \" (#{selectedAccount?.accountNumber}). This action cannot be undone.\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel data-testid=\"button-cancel-delete\">\n              Cancel\n            </AlertDialogCancel>\n            <AlertDialogAction\n              onClick={confirmDelete}\n              className=\"bg-destructive text-destructive-foreground hover:bg-destructive/90\"\n              data-testid=\"button-confirm-delete\"\n            >\n              {deleteMutation.isPending ? \"Deleting...\" : \"Delete\"}\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n    </div>\n  );\n}\n","size_bytes":18032},"client/src/pages/accountant/journal-entries.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from \"@/components/ui/dialog\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n} from \"@/components/ui/alert-dialog\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Plus, Eye, Ban, Trash2, RotateCcw } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { format } from \"date-fns\";\nimport type { JournalEntry, Account, TransactionTemplate } from \"@shared/schema\";\n\ntype JournalEntryLine = {\n  accountId: string;\n  lineType: \"debit\" | \"credit\";\n  amount: string;\n  description: string;\n};\n\nexport default function JournalEntries() {\n  const { toast } = useToast();\n  const [createDialogOpen, setCreateDialogOpen] = useState(false);\n  const [viewDialogOpen, setViewDialogOpen] = useState(false);\n  const [voidDialogOpen, setVoidDialogOpen] = useState(false);\n  const [reversalDialogOpen, setReversalDialogOpen] = useState(false);\n  const [selectedEntry, setSelectedEntry] = useState<any | null>(null);\n  \n  const [formData, setFormData] = useState({\n    date: format(new Date(), \"yyyy-MM-dd\"),\n    description: \"\",\n    reference: \"\",\n  });\n\n  const [lines, setLines] = useState<JournalEntryLine[]>([]);\n  const [newLine, setNewLine] = useState<JournalEntryLine>({\n    accountId: \"\",\n    lineType: \"debit\",\n    amount: \"\",\n    description: \"\",\n  });\n\n  // Helper function to validate amount input (strict currency format)\n  const isValidAmount = (value: string): boolean => {\n    if (!value || value.trim() === \"\") return false;\n    \n    // Strict regex: optional digits, optional decimal with max 2 decimal places\n    // Matches: \"123\", \"123.45\", \"0.50\", but NOT \"123.\", \"123.456\", \"12..3\", \".50\"\n    const currencyRegex = /^\\d+(\\.\\d{1,2})?$/;\n    if (!currencyRegex.test(value.trim())) {\n      return false;\n    }\n    \n    const num = parseFloat(value);\n    return !isNaN(num) && isFinite(num) && num > 0;\n  };\n\n  // Helper function to sanitize amount input (allow only digits and single decimal point)\n  const sanitizeAmount = (value: string): string => {\n    // Step 1: Remove all non-numeric characters except decimal point\n    let sanitized = value.replace(/[^0-9.]/g, '');\n    \n    // Step 2: Ensure only one decimal point exists\n    const parts = sanitized.split('.');\n    if (parts.length > 2) {\n      // Multiple decimals: keep first decimal and join remaining digits\n      sanitized = parts[0] + '.' + parts.slice(1).join('');\n    }\n    \n    // Step 3: Re-split and limit to 2 decimal places\n    const finalParts = sanitized.split('.');\n    if (finalParts.length === 2 && finalParts[1].length > 2) {\n      sanitized = finalParts[0] + '.' + finalParts[1].substring(0, 2);\n    }\n    \n    return sanitized;\n  };\n\n  const { data: entries, isLoading: entriesLoading } = useQuery<JournalEntry[]>({\n    queryKey: ['/api/accountant/entries'],\n  });\n\n  const { data: accounts } = useQuery<Account[]>({\n    queryKey: ['/api/accountant/accounts'],\n  });\n\n  const { data: templates } = useQuery<TransactionTemplate[]>({\n    queryKey: ['/api/accountant/templates'],\n  });\n\n  const createMutation = useMutation({\n    mutationFn: async (data: { entry: any; lines: Array<{ accountId: string; lineType: \"debit\" | \"credit\"; amount: number; description: string; }> }) => {\n      return await apiRequest('POST', '/api/accountant/entries', data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/accountant/entries'] });\n      setCreateDialogOpen(false);\n      resetForm();\n      toast({\n        title: \"Journal entry created\",\n        description: \"The journal entry has been posted successfully\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Failed to create entry\",\n        description: error.message || \"An error occurred\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const voidMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return await apiRequest('PATCH', `/api/accountant/entries/${id}/void`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/accountant/entries'] });\n      setVoidDialogOpen(false);\n      setSelectedEntry(null);\n      toast({\n        title: \"Entry voided\",\n        description: \"The journal entry has been voided\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Failed to void entry\",\n        description: error.message || \"An error occurred\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const reversalMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return await apiRequest('POST', `/api/accountant/entries/${id}/reverse`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/accountant/entries'] });\n      setReversalDialogOpen(false);\n      setSelectedEntry(null);\n      toast({\n        title: \"Entry reversed\",\n        description: \"A reversing journal entry has been created successfully\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Failed to reverse entry\",\n        description: error.message || \"An error occurred\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const resetForm = () => {\n    setFormData({\n      date: format(new Date(), \"yyyy-MM-dd\"),\n      description: \"\",\n      reference: \"\",\n    });\n    setLines([]);\n    setNewLine({\n      accountId: \"\",\n      lineType: \"debit\",\n      amount: \"\",\n      description: \"\",\n    });\n  };\n\n  const addLine = () => {\n    if (!newLine.accountId) {\n      toast({\n        title: \"Account required\",\n        description: \"Please select an account\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    if (!isValidAmount(newLine.amount)) {\n      toast({\n        title: \"Invalid amount\",\n        description: \"Please enter a valid positive amount\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setLines([...lines, newLine]);\n    setNewLine({\n      accountId: \"\",\n      lineType: \"debit\",\n      amount: \"\",\n      description: \"\",\n    });\n  };\n\n  const updateLineAmount = (index: number, value: string) => {\n    const sanitized = sanitizeAmount(value);\n    const newLines = [...lines];\n    newLines[index].amount = sanitized;\n    setLines(newLines);\n  };\n\n  const removeLine = (index: number) => {\n    setLines(lines.filter((_, i) => i !== index));\n  };\n\n  const applyTemplate = (templateId: string) => {\n    const template = templates?.find((t) => t.id === templateId);\n    if (!template) return;\n\n    const newLines: JournalEntryLine[] = [];\n    \n    // Add debit line\n    newLines.push({\n      accountId: template.debitAccountId,\n      lineType: \"debit\",\n      amount: \"\",\n      description: \"\",\n    });\n\n    // Add credit line\n    newLines.push({\n      accountId: template.creditAccountId,\n      lineType: \"credit\",\n      amount: \"\",\n      description: \"\",\n    });\n\n    setLines(newLines);\n    setFormData({\n      ...formData,\n      description: template.name,\n    });\n  };\n\n  const calculateTotals = () => {\n    let totalDebit = 0;\n    let totalCredit = 0;\n\n    // Calculate totals only if ALL lines have valid amounts (fail fast)\n    for (const line of lines) {\n      if (!isValidAmount(line.amount)) {\n        // Any invalid line → return unbalanced totals\n        return { totalDebit: 0, totalCredit: 0, balanced: false };\n      }\n      \n      const num = parseFloat(line.amount);\n      if (line.lineType === \"debit\") {\n        totalDebit += num;\n      } else {\n        totalCredit += num;\n      }\n    }\n\n    return { totalDebit, totalCredit, balanced: Math.abs(totalDebit - totalCredit) < 0.01 };\n  };\n\n  const handleCreate = () => {\n    // Validate all lines have valid amounts\n    const invalidLines = lines.filter((line) => !isValidAmount(line.amount));\n    if (invalidLines.length > 0) {\n      toast({\n        title: \"Invalid line amounts\",\n        description: \"All lines must have valid positive amounts\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    // Validate all lines have accounts\n    const linesWithoutAccount = lines.filter((line) => !line.accountId);\n    if (linesWithoutAccount.length > 0) {\n      toast({\n        title: \"Missing accounts\",\n        description: \"All lines must have an account selected\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    const { balanced } = calculateTotals();\n    if (!balanced) {\n      toast({\n        title: \"Entry not balanced\",\n        description: \"Debits and credits must be equal\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    // Send numeric amounts to backend\n    createMutation.mutate({\n      entry: {\n        date: formData.date,\n        description: formData.description,\n        reference: formData.reference || undefined,\n        status: \"posted\",\n      },\n      lines: lines.map((line) => ({\n        accountId: line.accountId,\n        lineType: line.lineType,\n        amount: parseFloat(line.amount),\n        description: line.description,\n      })),\n    });\n  };\n\n  const handleView = async (entry: JournalEntry) => {\n    try {\n      const res = await apiRequest('GET', `/api/accountant/entries/${entry.id}`);\n      const fullEntry = await res.json();\n      console.log(\"Full entry loaded:\", fullEntry);\n      setSelectedEntry(fullEntry);\n      setViewDialogOpen(true);\n    } catch (error) {\n      console.error(\"Error loading entry details:\", error);\n      toast({\n        title: \"Error loading entry\",\n        description: \"Failed to load journal entry details\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const handleVoid = (entry: JournalEntry) => {\n    setSelectedEntry(entry);\n    setVoidDialogOpen(true);\n  };\n\n  const confirmVoid = () => {\n    if (!selectedEntry) return;\n    voidMutation.mutate(selectedEntry.id);\n  };\n\n  const handleReverse = (entry: JournalEntry) => {\n    setSelectedEntry(entry);\n    setReversalDialogOpen(true);\n  };\n\n  const confirmReverse = () => {\n    if (!selectedEntry) return;\n    reversalMutation.mutate(selectedEntry.id);\n  };\n\n  const getAccountName = (accountId: string) => {\n    const account = accounts?.find((a) => a.id === accountId);\n    return account ? `${account.accountNumber} - ${account.accountName}` : accountId;\n  };\n\n  const { totalDebit, totalCredit, balanced } = calculateTotals();\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-bold tracking-tight\">Journal Entries</h1>\n          <p className=\"text-muted-foreground mt-2\">\n            Record and view double-entry journal entries\n          </p>\n        </div>\n        <Dialog open={createDialogOpen} onOpenChange={setCreateDialogOpen}>\n          <DialogTrigger asChild>\n            <Button data-testid=\"button-create-entry\">\n              <Plus className=\"mr-2 h-4 w-4\" />\n              New Journal Entry\n            </Button>\n          </DialogTrigger>\n          <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-y-auto\" data-testid=\"dialog-create-entry\">\n            <DialogHeader>\n              <DialogTitle>Create Journal Entry</DialogTitle>\n              <DialogDescription>\n                Create a new double-entry journal entry\n              </DialogDescription>\n            </DialogHeader>\n            <div className=\"space-y-4\">\n              <div className=\"grid grid-cols-3 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"date\">Date</Label>\n                  <Input\n                    id=\"date\"\n                    type=\"date\"\n                    data-testid=\"input-entry-date\"\n                    value={formData.date}\n                    onChange={(e) =>\n                      setFormData({ ...formData, date: e.target.value })\n                    }\n                  />\n                </div>\n                <div className=\"space-y-2 col-span-2\">\n                  <Label htmlFor=\"reference\">Reference (Optional)</Label>\n                  <Input\n                    id=\"reference\"\n                    data-testid=\"input-entry-reference\"\n                    placeholder=\"e.g., Invoice #123\"\n                    value={formData.reference}\n                    onChange={(e) =>\n                      setFormData({ ...formData, reference: e.target.value })\n                    }\n                  />\n                </div>\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"description\">Description</Label>\n                <Textarea\n                  id=\"description\"\n                  data-testid=\"input-entry-description\"\n                  placeholder=\"Brief description of this transaction\"\n                  value={formData.description}\n                  onChange={(e) =>\n                    setFormData({ ...formData, description: e.target.value })\n                  }\n                />\n              </div>\n              \n              <div className=\"space-y-2\">\n                <Label>Use Template (Optional)</Label>\n                <Select onValueChange={applyTemplate}>\n                  <SelectTrigger data-testid=\"select-template\">\n                    <SelectValue placeholder=\"Select a template\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {templates?.map((template) => (\n                      <SelectItem key={template.id} value={template.id}>\n                        {template.name}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n\n              <div className=\"border-t pt-4\">\n                <h3 className=\"font-semibold mb-4\">Journal Entry Lines</h3>\n                \n                <div className=\"space-y-4 mb-4\">\n                  {lines.map((line, index) => (\n                    <div\n                      key={index}\n                      className=\"grid grid-cols-12 gap-2 items-end\"\n                      data-testid={`line-item-${index}`}\n                    >\n                      <div className=\"col-span-4\">\n                        <Label className=\"text-xs\">Account</Label>\n                        <Input\n                          value={getAccountName(line.accountId)}\n                          disabled\n                          className=\"text-sm\"\n                        />\n                      </div>\n                      <div className=\"col-span-2\">\n                        <Label className=\"text-xs\">Type</Label>\n                        <Badge\n                          variant={line.lineType === \"debit\" ? \"default\" : \"secondary\"}\n                          className=\"w-full justify-center\"\n                        >\n                          {line.lineType === \"debit\" ? \"DR\" : \"CR\"}\n                        </Badge>\n                      </div>\n                      <div className=\"col-span-2\">\n                        <Label className=\"text-xs\">Amount</Label>\n                        <Input\n                          type=\"text\"\n                          value={line.amount}\n                          onChange={(e) => updateLineAmount(index, e.target.value)}\n                          className=\"text-sm\"\n                          placeholder=\"0.00\"\n                        />\n                      </div>\n                      <div className=\"col-span-3\">\n                        <Label className=\"text-xs\">Description</Label>\n                        <Input\n                          value={line.description}\n                          onChange={(e) => {\n                            const newLines = [...lines];\n                            newLines[index].description = e.target.value;\n                            setLines(newLines);\n                          }}\n                          className=\"text-sm\"\n                        />\n                      </div>\n                      <div className=\"col-span-1\">\n                        <Button\n                          type=\"button\"\n                          variant=\"ghost\"\n                          size=\"icon\"\n                          onClick={() => removeLine(index)}\n                          data-testid={`button-remove-line-${index}`}\n                        >\n                          <Trash2 className=\"h-4 w-4\" />\n                        </Button>\n                      </div>\n                    </div>\n                  ))}\n                </div>\n\n                <div className=\"grid grid-cols-12 gap-2 items-end border-t pt-4\">\n                  <div className=\"col-span-4\">\n                    <Label htmlFor=\"newAccount\">Account</Label>\n                    <Select\n                      value={newLine.accountId}\n                      onValueChange={(value) =>\n                        setNewLine({ ...newLine, accountId: value })\n                      }\n                    >\n                      <SelectTrigger id=\"newAccount\" data-testid=\"select-line-account\">\n                        <SelectValue placeholder=\"Select account\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        {accounts?.map((account) => (\n                          <SelectItem key={account.id} value={account.id}>\n                            {account.accountNumber} - {account.accountName}\n                          </SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                  </div>\n                  <div className=\"col-span-2\">\n                    <Label htmlFor=\"newType\">Type</Label>\n                    <Select\n                      value={newLine.lineType}\n                      onValueChange={(value: \"debit\" | \"credit\") =>\n                        setNewLine({ ...newLine, lineType: value })\n                      }\n                    >\n                      <SelectTrigger id=\"newType\" data-testid=\"select-line-type\">\n                        <SelectValue />\n                      </SelectTrigger>\n                      <SelectContent>\n                        <SelectItem value=\"debit\">Debit (DR)</SelectItem>\n                        <SelectItem value=\"credit\">Credit (CR)</SelectItem>\n                      </SelectContent>\n                    </Select>\n                  </div>\n                  <div className=\"col-span-2\">\n                    <Label htmlFor=\"newAmount\">Amount</Label>\n                    <Input\n                      id=\"newAmount\"\n                      type=\"text\"\n                      data-testid=\"input-line-amount\"\n                      placeholder=\"0.00\"\n                      value={newLine.amount}\n                      onChange={(e) =>\n                        setNewLine({ ...newLine, amount: sanitizeAmount(e.target.value) })\n                      }\n                    />\n                  </div>\n                  <div className=\"col-span-3\">\n                    <Label htmlFor=\"newDescription\">Description</Label>\n                    <Input\n                      id=\"newDescription\"\n                      data-testid=\"input-line-description\"\n                      placeholder=\"Line description\"\n                      value={newLine.description}\n                      onChange={(e) =>\n                        setNewLine({ ...newLine, description: e.target.value })\n                      }\n                    />\n                  </div>\n                  <div className=\"col-span-1\">\n                    <Button\n                      type=\"button\"\n                      size=\"icon\"\n                      onClick={addLine}\n                      disabled={!newLine.accountId || !newLine.amount}\n                      data-testid=\"button-add-line\"\n                    >\n                      <Plus className=\"h-4 w-4\" />\n                    </Button>\n                  </div>\n                </div>\n\n                <div className=\"mt-4 p-4 bg-muted rounded-lg\">\n                  <div className=\"grid grid-cols-3 gap-4 text-sm\">\n                    <div>\n                      <span className=\"text-muted-foreground\">Total Debits:</span>\n                      <span className=\"ml-2 font-semibold\" data-testid=\"text-total-debits\">\n                        ₦{totalDebit.toFixed(2)}\n                      </span>\n                    </div>\n                    <div>\n                      <span className=\"text-muted-foreground\">Total Credits:</span>\n                      <span className=\"ml-2 font-semibold\" data-testid=\"text-total-credits\">\n                        ₦{totalCredit.toFixed(2)}\n                      </span>\n                    </div>\n                    <div>\n                      <span className=\"text-muted-foreground\">Status:</span>\n                      <Badge\n                        variant={balanced ? \"default\" : \"destructive\"}\n                        className=\"ml-2\"\n                        data-testid=\"badge-balance-status\"\n                      >\n                        {balanced ? \"Balanced\" : \"Not Balanced\"}\n                      </Badge>\n                    </div>\n                  </div>\n                </div>\n              </div>\n            </div>\n            <DialogFooter>\n              <Button\n                variant=\"outline\"\n                onClick={() => {\n                  setCreateDialogOpen(false);\n                  resetForm();\n                }}\n                data-testid=\"button-cancel-create\"\n              >\n                Cancel\n              </Button>\n              <Button\n                onClick={handleCreate}\n                disabled={\n                  !formData.description ||\n                  lines.length === 0 ||\n                  !balanced ||\n                  createMutation.isPending\n                }\n                data-testid=\"button-submit-create\"\n              >\n                {createMutation.isPending ? \"Posting...\" : \"Post Entry\"}\n              </Button>\n            </DialogFooter>\n          </DialogContent>\n        </Dialog>\n      </div>\n\n      {entriesLoading ? (\n        <div className=\"text-center py-8\">Loading journal entries...</div>\n      ) : !entries || entries.length === 0 ? (\n        <div className=\"text-center py-8 text-muted-foreground\">\n          No journal entries found. Create your first entry to get started.\n        </div>\n      ) : (\n        <div className=\"border rounded-lg\">\n          <Table>\n            <TableHeader>\n              <TableRow>\n                <TableHead>Entry Number</TableHead>\n                <TableHead>Date</TableHead>\n                <TableHead>Description</TableHead>\n                <TableHead>Total</TableHead>\n                <TableHead>Status</TableHead>\n                <TableHead className=\"w-32\">Actions</TableHead>\n              </TableRow>\n            </TableHeader>\n            <TableBody>\n              {entries.map((entry) => (\n                <TableRow key={entry.id} data-testid={`row-entry-${entry.id}`}>\n                  <TableCell className=\"font-mono text-sm\">\n                    {entry.entryNumber}\n                  </TableCell>\n                  <TableCell>\n                    {entry.entryDate && !isNaN(new Date(entry.entryDate).getTime())\n                      ? format(new Date(entry.entryDate), \"MMM dd, yyyy\")\n                      : \"N/A\"}\n                  </TableCell>\n                  <TableCell>{entry.description}</TableCell>\n                  <TableCell className=\"font-semibold\">\n                    ₦{(parseFloat(entry.totalDebit) || 0).toFixed(2)}\n                  </TableCell>\n                  <TableCell>\n                    <Badge\n                      variant={\n                        entry.status === \"posted\"\n                          ? \"default\"\n                          : entry.status === \"void\"\n                          ? \"destructive\"\n                          : \"secondary\"\n                      }\n                    >\n                      {entry.status}\n                    </Badge>\n                  </TableCell>\n                  <TableCell>\n                    <div className=\"flex items-center gap-2\">\n                      <Button\n                        variant=\"ghost\"\n                        size=\"icon\"\n                        onClick={() => handleView(entry)}\n                        data-testid={`button-view-${entry.id}`}\n                      >\n                        <Eye className=\"h-4 w-4\" />\n                      </Button>\n                      {entry.status === \"posted\" && (\n                        <>\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            onClick={() => handleReverse(entry)}\n                            data-testid={`button-reverse-${entry.id}`}\n                          >\n                            <RotateCcw className=\"h-4 w-4\" />\n                          </Button>\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            onClick={() => handleVoid(entry)}\n                            data-testid={`button-void-${entry.id}`}\n                          >\n                            <Ban className=\"h-4 w-4\" />\n                          </Button>\n                        </>\n                      )}\n                    </div>\n                  </TableCell>\n                </TableRow>\n              ))}\n            </TableBody>\n          </Table>\n        </div>\n      )}\n\n      <Dialog open={viewDialogOpen} onOpenChange={setViewDialogOpen}>\n        <DialogContent className=\"max-w-3xl\" data-testid=\"dialog-view-entry\">\n          <DialogHeader>\n            <DialogTitle>Journal Entry Details</DialogTitle>\n            <DialogDescription>\n              Entry #{selectedEntry?.entryNumber}\n            </DialogDescription>\n          </DialogHeader>\n          {selectedEntry && (\n            <div className=\"space-y-4\">\n              <div className=\"grid grid-cols-2 gap-4 text-sm\">\n                <div>\n                  <span className=\"text-muted-foreground\">Date:</span>\n                  <span className=\"ml-2 font-medium\">\n                    {selectedEntry.entryDate && !isNaN(new Date(selectedEntry.entryDate).getTime())\n                      ? format(new Date(selectedEntry.entryDate), \"MMM dd, yyyy\")\n                      : \"N/A\"}\n                  </span>\n                </div>\n                <div>\n                  <span className=\"text-muted-foreground\">Status:</span>\n                  <Badge className=\"ml-2\" variant={selectedEntry.status === \"posted\" ? \"default\" : \"destructive\"}>\n                    {selectedEntry.status}\n                  </Badge>\n                </div>\n                <div className=\"col-span-2\">\n                  <span className=\"text-muted-foreground\">Description:</span>\n                  <p className=\"mt-1\">{selectedEntry.description}</p>\n                </div>\n                {selectedEntry.reference && (\n                  <div className=\"col-span-2\">\n                    <span className=\"text-muted-foreground\">Reference:</span>\n                    <span className=\"ml-2 font-medium\">{selectedEntry.reference}</span>\n                  </div>\n                )}\n              </div>\n\n              <div className=\"border-t pt-4\">\n                <h4 className=\"font-semibold mb-2\">Lines</h4>\n                <Table>\n                  <TableHeader>\n                    <TableRow>\n                      <TableHead>Account</TableHead>\n                      <TableHead>Description</TableHead>\n                      <TableHead className=\"text-right\">Debit</TableHead>\n                      <TableHead className=\"text-right\">Credit</TableHead>\n                    </TableRow>\n                  </TableHeader>\n                  <TableBody>\n                    {selectedEntry.lines?.map((line: any) => (\n                      <TableRow key={line.id}>\n                        <TableCell>{getAccountName(line.accountId)}</TableCell>\n                        <TableCell className=\"text-muted-foreground\">\n                          {line.description || \"-\"}\n                        </TableCell>\n                        <TableCell className=\"text-right font-mono\">\n                          {line.lineType === \"debit\"\n                            ? `₦${(parseFloat(line.amount) || 0).toFixed(2)}`\n                            : \"-\"}\n                        </TableCell>\n                        <TableCell className=\"text-right font-mono\">\n                          {line.lineType === \"credit\"\n                            ? `₦${(parseFloat(line.amount) || 0).toFixed(2)}`\n                            : \"-\"}\n                        </TableCell>\n                      </TableRow>\n                    ))}\n                    <TableRow className=\"font-semibold\">\n                      <TableCell colSpan={2}>Total</TableCell>\n                      <TableCell className=\"text-right\">\n                        ₦{(parseFloat(selectedEntry.totalDebit) || 0).toFixed(2)}\n                      </TableCell>\n                      <TableCell className=\"text-right\">\n                        ₦{(parseFloat(selectedEntry.totalCredit) || 0).toFixed(2)}\n                      </TableCell>\n                    </TableRow>\n                  </TableBody>\n                </Table>\n              </div>\n            </div>\n          )}\n          <DialogFooter>\n            <Button onClick={() => setViewDialogOpen(false)} data-testid=\"button-close-view\">\n              Close\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      <AlertDialog open={voidDialogOpen} onOpenChange={setVoidDialogOpen}>\n        <AlertDialogContent data-testid=\"dialog-void-entry\">\n          <AlertDialogHeader>\n            <AlertDialogTitle>Void Journal Entry?</AlertDialogTitle>\n            <AlertDialogDescription>\n              This will void journal entry \"{selectedEntry?.entryNumber}\". \n              Voided entries cannot be modified and will be marked as void in the system.\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel data-testid=\"button-cancel-void\">\n              Cancel\n            </AlertDialogCancel>\n            <AlertDialogAction\n              onClick={confirmVoid}\n              className=\"bg-destructive text-destructive-foreground hover:bg-destructive/90\"\n              data-testid=\"button-confirm-void\"\n            >\n              {voidMutation.isPending ? \"Voiding...\" : \"Void Entry\"}\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n\n      <AlertDialog open={reversalDialogOpen} onOpenChange={setReversalDialogOpen}>\n        <AlertDialogContent data-testid=\"dialog-reverse-entry\">\n          <AlertDialogHeader>\n            <AlertDialogTitle>Reverse Journal Entry?</AlertDialogTitle>\n            <AlertDialogDescription>\n              This will create a new journal entry with opposite debits and credits to reverse the effects of \"{selectedEntry?.entryNumber}\". The original entry will remain posted.\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel data-testid=\"button-cancel-reverse\">\n              Cancel\n            </AlertDialogCancel>\n            <AlertDialogAction\n              onClick={confirmReverse}\n              data-testid=\"button-confirm-reverse\"\n            >\n              {reversalMutation.isPending ? \"Creating Reversal...\" : \"Create Reversal\"}\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n    </div>\n  );\n}\n","size_bytes":32328},"client/src/pages/accountant/balance-sheet.tsx":{"content":"import { useState, useMemo } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Download, FileJson } from \"lucide-react\";\nimport { convertToCSV, downloadCSV, formatCurrencyForCSV } from \"@/lib/csv-export\";\n\nexport default function BalanceSheet() {\n  const [formAsOf, setFormAsOf] = useState(new Date().toISOString().split('T')[0]);\n  const [appliedParams, setAppliedParams] = useState<{ asOf: string } | null>(null);\n\n  const queryKey = useMemo(() => \n    appliedParams \n      ? ['api', 'accountant', 'reports', 'balance-sheet', { asOf: appliedParams.asOf }]\n      : null,\n    [appliedParams]\n  );\n\n  const { data, isLoading, isFetching } = useQuery<any>({\n    queryKey: queryKey ?? ['__disabled__'],\n    enabled: Boolean(queryKey),\n  });\n\n  const handleGenerate = () => {\n    setAppliedParams({ asOf: formAsOf });\n  };\n\n  const handleExportJSON = () => {\n    if (!data || !appliedParams || isFetching) return;\n    const json = JSON.stringify(data, null, 2);\n    const blob = new Blob([json], { type: 'application/json' });\n    const url = URL.createObjectURL(blob);\n    const link = document.createElement('a');\n    link.href = url;\n    link.download = `balance-sheet-${appliedParams.asOf}.json`;\n    document.body.appendChild(link);\n    link.click();\n    document.body.removeChild(link);\n    URL.revokeObjectURL(url);\n  };\n\n  const handleExportPDF = () => {\n    if (!data || isFetching) return;\n    window.print();\n  };\n\n  const handleExportCSV = () => {\n    if (!data || isFetching) return;\n    \n    // Combine assets, liabilities, and equity into one CSV\n    const csvData = [\n      // Assets section\n      ...data.assets.map((asset: any) => ({\n        'Section': 'Assets',\n        'Account Number': asset.accountNumber,\n        'Account Name': asset.accountName,\n        'Amount': formatCurrencyForCSV(asset.amount)\n      })),\n      // Assets total\n      {\n        'Section': 'Assets',\n        'Account Number': '',\n        'Account Name': 'Total Assets',\n        'Amount': formatCurrencyForCSV(data.totalAssets)\n      },\n      // Liabilities section\n      ...data.liabilities.map((liability: any) => ({\n        'Section': 'Liabilities',\n        'Account Number': liability.accountNumber,\n        'Account Name': liability.accountName,\n        'Amount': formatCurrencyForCSV(liability.amount)\n      })),\n      // Liabilities total\n      {\n        'Section': 'Liabilities',\n        'Account Number': '',\n        'Account Name': 'Total Liabilities',\n        'Amount': formatCurrencyForCSV(data.totalLiabilities)\n      },\n      // Equity section\n      ...data.equity.map((eq: any) => ({\n        'Section': 'Equity',\n        'Account Number': eq.accountNumber,\n        'Account Name': eq.accountName,\n        'Amount': formatCurrencyForCSV(eq.amount)\n      })),\n      // Equity total\n      {\n        'Section': 'Equity',\n        'Account Number': '',\n        'Account Name': 'Total Equity',\n        'Amount': formatCurrencyForCSV(data.totalEquity)\n      },\n      // Total Liabilities + Equity\n      {\n        'Section': 'Summary',\n        'Account Number': '',\n        'Account Name': 'Total Liabilities & Equity',\n        'Amount': formatCurrencyForCSV(data.totalLiabilitiesAndEquity)\n      }\n    ];\n    \n    const csv = convertToCSV(csvData);\n    downloadCSV(csv, `balance-sheet-${data.asOf}.csv`);\n  };\n\n  const formatCurrency = (amount: number) => {\n    return new Intl.NumberFormat('en-NG', {\n      style: 'currency',\n      currency: 'NGN',\n      minimumFractionDigits: 2,\n    }).format(amount);\n  };\n\n  const balanced = data && Math.abs(data.totalAssets - data.totalLiabilitiesAndEquity) < 0.01;\n\n  return (\n    <div className=\"space-y-6\">\n      <div>\n        <h1 className=\"text-3xl font-semibold\">Balance Sheet</h1>\n        <p className=\"text-muted-foreground mt-1\">\n          Statement of financial position showing assets, liabilities, and equity\n        </p>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Generate Balance Sheet</CardTitle>\n          <CardDescription>Select a date to generate the balance sheet as of that date</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"flex gap-4 items-end\">\n            <div className=\"flex-1 max-w-sm space-y-2\">\n              <Label htmlFor=\"asOf\">As Of Date</Label>\n              <Input\n                id=\"asOf\"\n                type=\"date\"\n                value={formAsOf}\n                onChange={(e) => setFormAsOf(e.target.value)}\n                data-testid=\"input-asof-date\"\n              />\n            </div>\n            <Button \n              onClick={handleGenerate} \n              disabled={isLoading || isFetching}\n              data-testid=\"button-generate-report\"\n            >\n              {isFetching ? 'Generating...' : 'Generate Report'}\n            </Button>\n          </div>\n        </CardContent>\n      </Card>\n\n      {data && (\n        <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n          {/* Assets */}\n          <Card>\n            <CardHeader>\n              <CardTitle>Assets</CardTitle>\n              <CardDescription>\n                As of {new Date(data.asOf).toLocaleDateString('en-NG', { \n                  year: 'numeric', \n                  month: 'long', \n                  day: 'numeric' \n                })}\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead>Account</TableHead>\n                    <TableHead className=\"text-right\">Amount</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {data.assets.map((asset: any, index: number) => (\n                    <TableRow key={index}>\n                      <TableCell>\n                        <div className=\"flex flex-col\">\n                          <span className=\"font-medium\">{asset.accountName}</span>\n                          <span className=\"text-xs text-muted-foreground font-mono\">\n                            {asset.accountNumber}\n                          </span>\n                        </div>\n                      </TableCell>\n                      <TableCell className=\"text-right font-mono\">\n                        {formatCurrency(asset.amount)}\n                      </TableCell>\n                    </TableRow>\n                  ))}\n                  <TableRow className=\"bg-muted font-semibold\">\n                    <TableCell>Total Assets</TableCell>\n                    <TableCell className=\"text-right font-mono\" data-testid=\"text-total-assets\">\n                      {formatCurrency(data.totalAssets)}\n                    </TableCell>\n                  </TableRow>\n                </TableBody>\n              </Table>\n            </CardContent>\n          </Card>\n\n          {/* Liabilities and Equity */}\n          <Card>\n            <CardHeader>\n              <CardTitle>Liabilities & Equity</CardTitle>\n              <CardDescription>\n                As of {new Date(data.asOf).toLocaleDateString('en-NG', { \n                  year: 'numeric', \n                  month: 'long', \n                  day: 'numeric' \n                })}\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              <div className=\"space-y-4\">\n                {/* Liabilities Section */}\n                <div>\n                  <h4 className=\"text-sm font-semibold mb-2\">Liabilities</h4>\n                  <Table>\n                    <TableBody>\n                      {data.liabilities.map((liability: any, index: number) => (\n                        <TableRow key={index}>\n                          <TableCell>\n                            <div className=\"flex flex-col\">\n                              <span className=\"font-medium\">{liability.accountName}</span>\n                              <span className=\"text-xs text-muted-foreground font-mono\">\n                                {liability.accountNumber}\n                              </span>\n                            </div>\n                          </TableCell>\n                          <TableCell className=\"text-right font-mono\">\n                            {formatCurrency(liability.amount)}\n                          </TableCell>\n                        </TableRow>\n                      ))}\n                      <TableRow className=\"bg-muted font-semibold\">\n                        <TableCell>Total Liabilities</TableCell>\n                        <TableCell className=\"text-right font-mono\" data-testid=\"text-total-liabilities\">\n                          {formatCurrency(data.totalLiabilities)}\n                        </TableCell>\n                      </TableRow>\n                    </TableBody>\n                  </Table>\n                </div>\n\n                {/* Equity Section */}\n                <div>\n                  <h4 className=\"text-sm font-semibold mb-2\">Equity</h4>\n                  <Table>\n                    <TableBody>\n                      {data.equity.map((eq: any, index: number) => (\n                        <TableRow key={index}>\n                          <TableCell>\n                            <div className=\"flex flex-col\">\n                              <span className=\"font-medium\">{eq.accountName}</span>\n                              <span className=\"text-xs text-muted-foreground font-mono\">\n                                {eq.accountNumber}\n                              </span>\n                            </div>\n                          </TableCell>\n                          <TableCell className=\"text-right font-mono\">\n                            {formatCurrency(eq.amount)}\n                          </TableCell>\n                        </TableRow>\n                      ))}\n                      <TableRow className=\"bg-muted font-semibold\">\n                        <TableCell>Total Equity</TableCell>\n                        <TableCell className=\"text-right font-mono\" data-testid=\"text-total-equity\">\n                          {formatCurrency(data.totalEquity)}\n                        </TableCell>\n                      </TableRow>\n                    </TableBody>\n                  </Table>\n                </div>\n\n                {/* Total Liabilities + Equity */}\n                <div className=\"border-t-2 border-primary pt-2\">\n                  <Table>\n                    <TableBody>\n                      <TableRow className=\"bg-primary/10 font-bold\">\n                        <TableCell>Total Liabilities & Equity</TableCell>\n                        <TableCell className=\"text-right font-mono\" data-testid=\"text-total-liabilities-equity\">\n                          {formatCurrency(data.totalLiabilitiesAndEquity)}\n                        </TableCell>\n                      </TableRow>\n                    </TableBody>\n                  </Table>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* Balance Verification */}\n          <Card className=\"lg:col-span-2\">\n            <CardHeader className=\"flex flex-row items-center justify-between gap-4 space-y-0\">\n              <CardTitle>Balance Verification</CardTitle>\n              <div className=\"flex items-center gap-2\">\n                {balanced ? (\n                  <Badge variant=\"default\" className=\"bg-green-600\" data-testid=\"badge-balanced\">\n                    Balanced\n                  </Badge>\n                ) : (\n                  <Badge variant=\"destructive\" data-testid=\"badge-unbalanced\">\n                    Unbalanced\n                  </Badge>\n                )}\n                <Button \n                  variant=\"outline\" \n                  size=\"sm\" \n                  onClick={handleExportCSV}\n                  disabled={isFetching || !data}\n                  data-testid=\"button-export-csv\"\n                >\n                  <Download className=\"w-4 h-4 mr-2\" />\n                  CSV\n                </Button>\n                <Button \n                  variant=\"outline\" \n                  size=\"sm\" \n                  onClick={handleExportJSON}\n                  disabled={isFetching || !data}\n                  data-testid=\"button-export-json\"\n                >\n                  <FileJson className=\"w-4 h-4 mr-2\" />\n                  JSON\n                </Button>\n                <Button \n                  variant=\"outline\" \n                  size=\"sm\" \n                  onClick={handleExportPDF}\n                  disabled={isFetching || !data}\n                  data-testid=\"button-export-pdf\"\n                >\n                  <Download className=\"w-4 h-4 mr-2\" />\n                  PDF\n                </Button>\n              </div>\n            </CardHeader>\n            <CardContent>\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"p-4 bg-muted rounded-lg\">\n                  <p className=\"text-sm text-muted-foreground\">Total Assets</p>\n                  <p className=\"text-2xl font-bold font-mono\">{formatCurrency(data.totalAssets)}</p>\n                </div>\n                <div className=\"p-4 bg-muted rounded-lg\">\n                  <p className=\"text-sm text-muted-foreground\">Total Liabilities & Equity</p>\n                  <p className=\"text-2xl font-bold font-mono\">\n                    {formatCurrency(data.totalLiabilitiesAndEquity)}\n                  </p>\n                </div>\n              </div>\n\n              {!balanced && (\n                <div className=\"mt-4 p-4 bg-destructive/10 border border-destructive rounded-lg\">\n                  <p className=\"text-sm text-destructive font-medium\">\n                    ⚠️ Balance Sheet is unbalanced! Assets do not equal Liabilities + Equity.\n                  </p>\n                  <p className=\"text-sm text-muted-foreground mt-1\">\n                    Difference: {formatCurrency(Math.abs(data.totalAssets - data.totalLiabilitiesAndEquity))}\n                  </p>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </div>\n      )}\n    </div>\n  );\n}\n","size_bytes":14473},"client/src/pages/accountant/income-statement.tsx":{"content":"import { useState, useMemo } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Download, FileJson } from \"lucide-react\";\nimport { convertToCSV, downloadCSV, formatCurrencyForCSV } from \"@/lib/csv-export\";\n\nexport default function IncomeStatement() {\n  const currentYear = new Date().getFullYear();\n  const [formStartDate, setFormStartDate] = useState(`${currentYear}-01-01`);\n  const [formEndDate, setFormEndDate] = useState(new Date().toISOString().split('T')[0]);\n  const [appliedParams, setAppliedParams] = useState<{ startDate: string; endDate: string } | null>(null);\n\n  const queryKey = useMemo(() => \n    appliedParams \n      ? ['api', 'accountant', 'reports', 'income-statement', { \n          startDate: appliedParams.startDate, \n          endDate: appliedParams.endDate \n        }]\n      : null,\n    [appliedParams]\n  );\n\n  const { data, isLoading, isFetching } = useQuery<any>({\n    queryKey: queryKey ?? ['__disabled__'],\n    enabled: Boolean(queryKey),\n  });\n\n  const handleGenerate = () => {\n    setAppliedParams({ startDate: formStartDate, endDate: formEndDate });\n  };\n\n  const handleExportJSON = () => {\n    if (!data || !appliedParams || isFetching) return;\n    const json = JSON.stringify(data, null, 2);\n    const blob = new Blob([json], { type: 'application/json' });\n    const url = URL.createObjectURL(blob);\n    const link = document.createElement('a');\n    link.href = url;\n    link.download = `income-statement-${appliedParams.startDate}-to-${appliedParams.endDate}.json`;\n    document.body.appendChild(link);\n    link.click();\n    document.body.removeChild(link);\n    URL.revokeObjectURL(url);\n  };\n\n  const handleExportPDF = () => {\n    if (!data || isFetching) return;\n    window.print();\n  };\n\n  const handleExportCSV = () => {\n    if (!data || isFetching) return;\n    \n    // Combine revenues and expenses into one CSV\n    const csvData = [\n      // Revenue section\n      ...data.revenues.map((revenue: any) => ({\n        'Section': 'Revenue',\n        'Account Number': revenue.accountNumber,\n        'Account Name': revenue.accountName,\n        'Amount': formatCurrencyForCSV(revenue.amount)\n      })),\n      // Revenue total\n      {\n        'Section': 'Revenue',\n        'Account Number': '',\n        'Account Name': 'Total Revenue',\n        'Amount': formatCurrencyForCSV(data.totalRevenue)\n      },\n      // Expense section\n      ...data.expenses.map((expense: any) => ({\n        'Section': 'Expense',\n        'Account Number': expense.accountNumber,\n        'Account Name': expense.accountName,\n        'Amount': formatCurrencyForCSV(expense.amount)\n      })),\n      // Expense total\n      {\n        'Section': 'Expense',\n        'Account Number': '',\n        'Account Name': 'Total Expenses',\n        'Amount': formatCurrencyForCSV(data.totalExpenses)\n      },\n      // Net income\n      {\n        'Section': 'Summary',\n        'Account Number': '',\n        'Account Name': 'Net Income',\n        'Amount': formatCurrencyForCSV(data.netIncome)\n      }\n    ];\n    \n    const csv = convertToCSV(csvData);\n    downloadCSV(csv, `income-statement-${data.startDate}-to-${data.endDate}.csv`);\n  };\n\n  const formatCurrency = (amount: number) => {\n    return new Intl.NumberFormat('en-NG', {\n      style: 'currency',\n      currency: 'NGN',\n      minimumFractionDigits: 2,\n    }).format(amount);\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      <div>\n        <h1 className=\"text-3xl font-semibold\">Income Statement</h1>\n        <p className=\"text-muted-foreground mt-1\">\n          Statement of revenues and expenses for a period\n        </p>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Generate Income Statement</CardTitle>\n          <CardDescription>Select a date range to generate the income statement</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"flex gap-4 items-end flex-wrap\">\n            <div className=\"flex-1 min-w-[200px] space-y-2\">\n              <Label htmlFor=\"startDate\">Start Date</Label>\n              <Input\n                id=\"startDate\"\n                type=\"date\"\n                value={formStartDate}\n                onChange={(e) => setFormStartDate(e.target.value)}\n                data-testid=\"input-start-date\"\n              />\n            </div>\n            <div className=\"flex-1 min-w-[200px] space-y-2\">\n              <Label htmlFor=\"endDate\">End Date</Label>\n              <Input\n                id=\"endDate\"\n                type=\"date\"\n                value={formEndDate}\n                onChange={(e) => setFormEndDate(e.target.value)}\n                data-testid=\"input-end-date\"\n              />\n            </div>\n            <Button \n              onClick={handleGenerate} \n              disabled={isLoading || isFetching}\n              data-testid=\"button-generate-report\"\n            >\n              {isFetching ? 'Generating...' : 'Generate Report'}\n            </Button>\n          </div>\n        </CardContent>\n      </Card>\n\n      {data && (\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-4 space-y-0 pb-2\">\n            <div>\n              <CardTitle>Income Statement</CardTitle>\n              <CardDescription>\n                For the period from {new Date(data.startDate).toLocaleDateString('en-NG')} to{' '}\n                {new Date(data.endDate).toLocaleDateString('en-NG')}\n              </CardDescription>\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <Button \n                variant=\"outline\" \n                size=\"sm\" \n                onClick={handleExportCSV}\n                disabled={isFetching || !data}\n                data-testid=\"button-export-csv\"\n              >\n                <Download className=\"w-4 h-4 mr-2\" />\n                CSV\n              </Button>\n              <Button \n                variant=\"outline\" \n                size=\"sm\" \n                onClick={handleExportJSON}\n                disabled={isFetching || !data}\n                data-testid=\"button-export-json\"\n              >\n                <FileJson className=\"w-4 h-4 mr-2\" />\n                JSON\n              </Button>\n              <Button \n                variant=\"outline\" \n                size=\"sm\" \n                onClick={handleExportPDF}\n                disabled={isFetching || !data}\n                data-testid=\"button-export-pdf\"\n              >\n                <Download className=\"w-4 h-4 mr-2\" />\n                PDF\n              </Button>\n            </div>\n          </CardHeader>\n          <CardContent>\n            <div className=\"space-y-6\">\n              {/* Revenue Section */}\n              <div>\n                <h3 className=\"text-lg font-semibold mb-3\">Revenue</h3>\n                <Table>\n                  <TableHeader>\n                    <TableRow>\n                      <TableHead>Account #</TableHead>\n                      <TableHead>Account Name</TableHead>\n                      <TableHead className=\"text-right\">Amount</TableHead>\n                    </TableRow>\n                  </TableHeader>\n                  <TableBody>\n                    {data.revenues.map((revenue: any, index: number) => (\n                      <TableRow key={index}>\n                        <TableCell className=\"font-mono\">{revenue.accountNumber}</TableCell>\n                        <TableCell>{revenue.accountName}</TableCell>\n                        <TableCell className=\"text-right font-mono\">\n                          {formatCurrency(revenue.amount)}\n                        </TableCell>\n                      </TableRow>\n                    ))}\n                    <TableRow className=\"bg-muted font-semibold\">\n                      <TableCell colSpan={2} className=\"text-right\">Total Revenue:</TableCell>\n                      <TableCell className=\"text-right font-mono\" data-testid=\"text-total-revenue\">\n                        {formatCurrency(data.totalRevenue)}\n                      </TableCell>\n                    </TableRow>\n                  </TableBody>\n                </Table>\n              </div>\n\n              {/* Expenses Section */}\n              <div>\n                <h3 className=\"text-lg font-semibold mb-3\">Expenses</h3>\n                <Table>\n                  <TableHeader>\n                    <TableRow>\n                      <TableHead>Account #</TableHead>\n                      <TableHead>Account Name</TableHead>\n                      <TableHead className=\"text-right\">Amount</TableHead>\n                    </TableRow>\n                  </TableHeader>\n                  <TableBody>\n                    {data.expenses.map((expense: any, index: number) => (\n                      <TableRow key={index}>\n                        <TableCell className=\"font-mono\">{expense.accountNumber}</TableCell>\n                        <TableCell>{expense.accountName}</TableCell>\n                        <TableCell className=\"text-right font-mono\">\n                          {formatCurrency(expense.amount)}\n                        </TableCell>\n                      </TableRow>\n                    ))}\n                    <TableRow className=\"bg-muted font-semibold\">\n                      <TableCell colSpan={2} className=\"text-right\">Total Expenses:</TableCell>\n                      <TableCell className=\"text-right font-mono\" data-testid=\"text-total-expenses\">\n                        {formatCurrency(data.totalExpenses)}\n                      </TableCell>\n                    </TableRow>\n                  </TableBody>\n                </Table>\n              </div>\n\n              {/* Net Income */}\n              <div className=\"border-t-2 border-primary pt-4\">\n                <div className=\"flex justify-between items-center p-4 bg-muted rounded-lg\">\n                  <div className=\"flex items-center gap-3\">\n                    <span className=\"text-lg font-bold\">Net Income</span>\n                    {data.netIncome >= 0 ? (\n                      <Badge variant=\"default\" className=\"bg-green-600\">Profit</Badge>\n                    ) : (\n                      <Badge variant=\"destructive\">Loss</Badge>\n                    )}\n                  </div>\n                  <span \n                    className={`text-2xl font-bold font-mono ${data.netIncome >= 0 ? 'text-green-600' : 'text-destructive'}`}\n                    data-testid=\"text-net-income\"\n                  >\n                    {formatCurrency(data.netIncome)}\n                  </span>\n                </div>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  );\n}\n","size_bytes":10985},"client/src/pages/accountant/trial-balance.tsx":{"content":"import { useState, useMemo } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Download, FileJson } from \"lucide-react\";\nimport { convertToCSV, downloadCSV, formatCurrencyForCSV } from \"@/lib/csv-export\";\n\nexport default function TrialBalance() {\n  const [formAsOf, setFormAsOf] = useState(new Date().toISOString().split('T')[0]);\n  const [appliedParams, setAppliedParams] = useState<{ asOf: string } | null>(null);\n\n  const queryKey = useMemo(() => \n    appliedParams \n      ? ['api', 'accountant', 'reports', 'trial-balance', { asOf: appliedParams.asOf }]\n      : null,\n    [appliedParams]\n  );\n\n  const { data, isLoading, isFetching } = useQuery<any>({\n    queryKey: queryKey ?? ['__disabled__'],\n    enabled: Boolean(queryKey),\n  });\n\n  const handleGenerate = () => {\n    setAppliedParams({ asOf: formAsOf });\n  };\n\n  const handleExportJSON = () => {\n    if (!data || !appliedParams || isFetching) return;\n    const json = JSON.stringify(data, null, 2);\n    const blob = new Blob([json], { type: 'application/json' });\n    const url = URL.createObjectURL(blob);\n    const link = document.createElement('a');\n    link.href = url;\n    link.download = `trial-balance-${appliedParams.asOf}.json`;\n    document.body.appendChild(link);\n    link.click();\n    document.body.removeChild(link);\n    URL.revokeObjectURL(url);\n  };\n\n  const handleExportPDF = () => {\n    if (!data || isFetching) return;\n    window.print();\n  };\n\n  const handleExportCSV = () => {\n    if (!data || isFetching) return;\n    \n    // Map trial balance data to CSV format\n    const csvData = data.accounts.map((account: any) => ({\n      'Account Number': account.accountNumber,\n      'Account Name': account.accountName,\n      'Type': account.accountType,\n      'Debit': account.debitBalance > 0 ? formatCurrencyForCSV(account.debitBalance) : '',\n      'Credit': account.creditBalance > 0 ? formatCurrencyForCSV(account.creditBalance) : ''\n    }));\n    \n    // Add totals row\n    csvData.push({\n      'Account Number': '',\n      'Account Name': 'Total',\n      'Type': '',\n      'Debit': formatCurrencyForCSV(data.totalDebits),\n      'Credit': formatCurrencyForCSV(data.totalCredits)\n    });\n    \n    const csv = convertToCSV(csvData);\n    downloadCSV(csv, `trial-balance-${data.asOf}.csv`);\n  };\n\n  const formatCurrency = (amount: number) => {\n    return new Intl.NumberFormat('en-NG', {\n      style: 'currency',\n      currency: 'NGN',\n      minimumFractionDigits: 2,\n    }).format(amount);\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      <div>\n        <h1 className=\"text-3xl font-semibold\">Trial Balance</h1>\n        <p className=\"text-muted-foreground mt-1\">\n          List of all accounts with debit and credit balances\n        </p>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Generate Trial Balance</CardTitle>\n          <CardDescription>Select a date to generate the trial balance as of that date</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"flex gap-4 items-end\">\n            <div className=\"flex-1 max-w-sm space-y-2\">\n              <Label htmlFor=\"asOf\">As Of Date</Label>\n              <Input\n                id=\"asOf\"\n                type=\"date\"\n                value={formAsOf}\n                onChange={(e) => setFormAsOf(e.target.value)}\n                data-testid=\"input-asof-date\"\n              />\n            </div>\n            <Button \n              onClick={handleGenerate} \n              disabled={isLoading || isFetching}\n              data-testid=\"button-generate-report\"\n            >\n              {isFetching ? 'Generating...' : 'Generate Report'}\n            </Button>\n          </div>\n        </CardContent>\n      </Card>\n\n      {data && (\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-4 space-y-0 pb-2\">\n            <div>\n              <CardTitle>Trial Balance</CardTitle>\n              <CardDescription>\n                As of {new Date(data.asOf).toLocaleDateString('en-NG', { \n                  year: 'numeric', \n                  month: 'long', \n                  day: 'numeric' \n                })}\n              </CardDescription>\n            </div>\n            <div className=\"flex items-center gap-2\">\n              {data.balanced ? (\n                <Badge variant=\"default\" className=\"bg-green-600\" data-testid=\"badge-balanced\">\n                  Balanced\n                </Badge>\n              ) : (\n                <Badge variant=\"destructive\" data-testid=\"badge-unbalanced\">\n                  Unbalanced\n                </Badge>\n              )}\n              <Button \n                variant=\"outline\" \n                size=\"sm\" \n                onClick={handleExportCSV}\n                disabled={isFetching || !data}\n                data-testid=\"button-export-csv\"\n              >\n                <Download className=\"w-4 h-4 mr-2\" />\n                CSV\n              </Button>\n              <Button \n                variant=\"outline\" \n                size=\"sm\" \n                onClick={handleExportJSON}\n                disabled={isFetching || !data}\n                data-testid=\"button-export-json\"\n              >\n                <FileJson className=\"w-4 h-4 mr-2\" />\n                JSON\n              </Button>\n              <Button \n                variant=\"outline\" \n                size=\"sm\" \n                onClick={handleExportPDF}\n                disabled={isFetching || !data}\n                data-testid=\"button-export-pdf\"\n              >\n                <Download className=\"w-4 h-4 mr-2\" />\n                PDF\n              </Button>\n            </div>\n          </CardHeader>\n          <CardContent>\n            <Table>\n              <TableHeader>\n                <TableRow>\n                  <TableHead>Account #</TableHead>\n                  <TableHead>Account Name</TableHead>\n                  <TableHead>Type</TableHead>\n                  <TableHead className=\"text-right\">Debit</TableHead>\n                  <TableHead className=\"text-right\">Credit</TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>\n                {data.accounts.map((account: any) => (\n                  <TableRow key={account.accountId} data-testid={`row-account-${account.accountId}`}>\n                    <TableCell className=\"font-mono\">{account.accountNumber}</TableCell>\n                    <TableCell>{account.accountName}</TableCell>\n                    <TableCell>\n                      <Badge variant=\"outline\">{account.accountType}</Badge>\n                    </TableCell>\n                    <TableCell className=\"text-right font-mono\">\n                      {account.debitBalance > 0 ? formatCurrency(account.debitBalance) : '—'}\n                    </TableCell>\n                    <TableCell className=\"text-right font-mono\">\n                      {account.creditBalance > 0 ? formatCurrency(account.creditBalance) : '—'}\n                    </TableCell>\n                  </TableRow>\n                ))}\n                <TableRow className=\"bg-muted font-semibold\">\n                  <TableCell colSpan={3} className=\"text-right\">Total:</TableCell>\n                  <TableCell className=\"text-right font-mono\" data-testid=\"text-total-debits\">\n                    {formatCurrency(data.totalDebits)}\n                  </TableCell>\n                  <TableCell className=\"text-right font-mono\" data-testid=\"text-total-credits\">\n                    {formatCurrency(data.totalCredits)}\n                  </TableCell>\n                </TableRow>\n              </TableBody>\n            </Table>\n\n            {!data.balanced && (\n              <div className=\"mt-4 p-4 bg-destructive/10 border border-destructive rounded-lg\">\n                <p className=\"text-sm text-destructive font-medium\">\n                  ⚠️ Trial Balance is unbalanced! Total debits and credits do not match.\n                </p>\n                <p className=\"text-sm text-muted-foreground mt-1\">\n                  Difference: {formatCurrency(Math.abs(data.totalDebits - data.totalCredits))}\n                </p>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  );\n}\n","size_bytes":8614},"client/src/pages/accountant/vendor-registration.tsx":{"content":"import { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { z } from \"zod\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Button } from \"@/components/ui/button\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { insertVendorSchema } from \"@shared/schema\";\n\nconst formSchema = insertVendorSchema.extend({\n  status: z.string().default(\"pending\").optional(),\n});\n\ntype FormValues = z.infer<typeof formSchema>;\n\nexport default function VendorRegistration() {\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  const form = useForm<FormValues>({\n    resolver: zodResolver(formSchema),\n    defaultValues: {\n      name: \"\",\n      tinNumber: \"\",\n      email: \"\",\n      phoneNumber: \"\",\n      address: \"\",\n      contactPerson: \"\",\n      bankName: \"\",\n      bankAccountNumber: \"\",\n      bankAccountName: \"\",\n      notes: \"\",\n      status: \"pending\",\n    },\n  });\n\n  const createVendorMutation = useMutation({\n    mutationFn: async (data: FormValues) => {\n      // Sanitize optional fields - convert empty strings to undefined\n      const sanitizedData = {\n        ...data,\n        email: data.email?.trim() || undefined,\n        phoneNumber: data.phoneNumber?.trim() || undefined,\n        address: data.address?.trim() || undefined,\n        contactPerson: data.contactPerson?.trim() || undefined,\n        bankName: data.bankName?.trim() || undefined,\n        bankAccountNumber: data.bankAccountNumber?.trim() || undefined,\n        bankAccountName: data.bankAccountName?.trim() || undefined,\n        notes: data.notes?.trim() || undefined,\n      };\n      return await apiRequest(\"POST\", \"/api/accountant/vendors\", sanitizedData);\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Success\",\n        description: \"Vendor registered successfully. Awaiting approval.\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/accountant/vendors\"] });\n      form.reset();\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to register vendor\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const onSubmit = (data: FormValues) => {\n    createVendorMutation.mutate(data);\n  };\n\n  return (\n    <div className=\"container mx-auto p-6 max-w-4xl\">\n      <Card>\n        <CardHeader>\n          <CardTitle data-testid=\"text-title\">Vendor Registration</CardTitle>\n          <CardDescription>\n            Register a new vendor for the estate. All vendor registrations require approval.\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <Form {...form}>\n            <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-6\">\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                <FormField\n                  control={form.control}\n                  name=\"name\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Vendor Name *</FormLabel>\n                      <FormControl>\n                        <Input \n                          placeholder=\"ABC Company Ltd\" \n                          data-testid=\"input-vendor-name\"\n                          {...field} \n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"tinNumber\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>TIN Number *</FormLabel>\n                      <FormControl>\n                        <Input \n                          placeholder=\"12345678-0001\" \n                          data-testid=\"input-tin-number\"\n                          {...field} \n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"email\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Email</FormLabel>\n                      <FormControl>\n                        <Input \n                          type=\"email\" \n                          placeholder=\"vendor@example.com\" \n                          data-testid=\"input-email\"\n                          {...field} \n                          value={field.value || \"\"}\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"phoneNumber\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Phone Number</FormLabel>\n                      <FormControl>\n                        <Input \n                          placeholder=\"+234 xxx xxx xxxx\" \n                          data-testid=\"input-phone\"\n                          {...field} \n                          value={field.value || \"\"}\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"contactPerson\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Contact Person</FormLabel>\n                      <FormControl>\n                        <Input \n                          placeholder=\"John Doe\" \n                          data-testid=\"input-contact-person\"\n                          {...field} \n                          value={field.value || \"\"}\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n              </div>\n\n              <FormField\n                control={form.control}\n                name=\"address\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Address</FormLabel>\n                    <FormControl>\n                      <Textarea \n                        placeholder=\"123 Business Street, Lagos, Nigeria\" \n                        data-testid=\"input-address\"\n                        {...field} \n                        value={field.value || \"\"}\n                        rows={2}\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <div className=\"space-y-4\">\n                <h3 className=\"text-lg font-medium\">Banking Information</h3>\n                <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                  <FormField\n                    control={form.control}\n                    name=\"bankName\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Bank Name</FormLabel>\n                        <FormControl>\n                          <Input \n                            placeholder=\"First Bank\" \n                            data-testid=\"input-bank-name\"\n                            {...field} \n                            value={field.value || \"\"}\n                          />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <FormField\n                    control={form.control}\n                    name=\"bankAccountNumber\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Account Number</FormLabel>\n                        <FormControl>\n                          <Input \n                            placeholder=\"0123456789\" \n                            data-testid=\"input-account-number\"\n                            {...field} \n                            value={field.value || \"\"}\n                          />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <FormField\n                    control={form.control}\n                    name=\"bankAccountName\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Account Name</FormLabel>\n                        <FormControl>\n                          <Input \n                            placeholder=\"ABC Company Ltd\" \n                            data-testid=\"input-account-name\"\n                            {...field} \n                            value={field.value || \"\"}\n                          />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                </div>\n              </div>\n\n              <FormField\n                control={form.control}\n                name=\"notes\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Notes</FormLabel>\n                    <FormControl>\n                      <Textarea \n                        placeholder=\"Additional information about the vendor...\" \n                        data-testid=\"input-notes\"\n                        {...field} \n                        value={field.value || \"\"}\n                        rows={3}\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <div className=\"flex justify-end gap-3\">\n                <Button\n                  type=\"button\"\n                  variant=\"outline\"\n                  onClick={() => form.reset()}\n                  data-testid=\"button-reset\"\n                >\n                  Reset\n                </Button>\n                <Button \n                  type=\"submit\" \n                  disabled={createVendorMutation.isPending}\n                  data-testid=\"button-submit\"\n                >\n                  {createVendorMutation.isPending ? \"Registering...\" : \"Register Vendor\"}\n                </Button>\n              </div>\n            </form>\n          </Form>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":11017},"client/src/pages/accountant/vendor-approval.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Label } from \"@/components/ui/label\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { CheckCircle2, XCircle, Clock, Building2 } from \"lucide-react\";\nimport type { Vendor } from \"@shared/schema\";\n\nexport default function VendorApproval() {\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  const [selectedVendor, setSelectedVendor] = useState<Vendor | null>(null);\n  const [showApproveDialog, setShowApproveDialog] = useState(false);\n  const [showRejectDialog, setShowRejectDialog] = useState(false);\n  const [rejectionReason, setRejectionReason] = useState(\"\");\n\n  const { data: vendors, isLoading } = useQuery<Vendor[]>({\n    queryKey: [\"/api/accountant/vendors\"],\n  });\n\n  const approveMutation = useMutation({\n    mutationFn: async (vendorId: string) => {\n      return await apiRequest(\"POST\", `/api/accountant/vendors/${vendorId}/approve`);\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Success\",\n        description: \"Vendor approved successfully\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/accountant/vendors\"] });\n      setShowApproveDialog(false);\n      setSelectedVendor(null);\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to approve vendor\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const rejectMutation = useMutation({\n    mutationFn: async ({ vendorId, reason }: { vendorId: string; reason: string }) => {\n      return await apiRequest(\"POST\", `/api/accountant/vendors/${vendorId}/reject`, { reason });\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Success\",\n        description: \"Vendor rejected successfully\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/accountant/vendors\"] });\n      setShowRejectDialog(false);\n      setSelectedVendor(null);\n      setRejectionReason(\"\");\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to reject vendor\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleApprove = () => {\n    if (selectedVendor) {\n      approveMutation.mutate(selectedVendor.id);\n    }\n  };\n\n  const handleReject = () => {\n    if (selectedVendor && rejectionReason.trim()) {\n      rejectMutation.mutate({ vendorId: selectedVendor.id, reason: rejectionReason });\n    }\n  };\n\n  const pendingVendors = vendors?.filter(v => v.status === \"pending\") || [];\n  const approvedVendors = vendors?.filter(v => v.status === \"approved\") || [];\n  const rejectedVendors = vendors?.filter(v => v.status === \"rejected\") || [];\n\n  const VendorCard = ({ vendor }: { vendor: Vendor }) => (\n    <Card key={vendor.id} className=\"hover-elevate\" data-testid={`card-vendor-${vendor.id}`}>\n      <CardHeader>\n        <div className=\"flex items-start justify-between gap-2\">\n          <div>\n            <CardTitle className=\"text-lg flex items-center gap-2\" data-testid={`text-vendor-name-${vendor.id}`}>\n              <Building2 className=\"h-4 w-4\" />\n              {vendor.name}\n            </CardTitle>\n            <CardDescription data-testid={`text-vendor-tin-${vendor.id}`}>\n              TIN: {vendor.tinNumber}\n            </CardDescription>\n          </div>\n          <Badge \n            variant={\n              vendor.status === \"approved\" ? \"default\" :\n              vendor.status === \"rejected\" ? \"destructive\" :\n              \"secondary\"\n            }\n            data-testid={`badge-status-${vendor.id}`}\n          >\n            {vendor.status === \"approved\" && <CheckCircle2 className=\"h-3 w-3 mr-1\" />}\n            {vendor.status === \"rejected\" && <XCircle className=\"h-3 w-3 mr-1\" />}\n            {vendor.status === \"pending\" && <Clock className=\"h-3 w-3 mr-1\" />}\n            {vendor.status}\n          </Badge>\n        </div>\n      </CardHeader>\n      <CardContent>\n        <div className=\"space-y-2 text-sm\">\n          {vendor.contactPerson && (\n            <div>\n              <span className=\"font-medium\">Contact Person:</span> {vendor.contactPerson}\n            </div>\n          )}\n          {vendor.phoneNumber && (\n            <div>\n              <span className=\"font-medium\">Phone:</span> {vendor.phoneNumber}\n            </div>\n          )}\n          {vendor.email && (\n            <div>\n              <span className=\"font-medium\">Email:</span> {vendor.email}\n            </div>\n          )}\n          {vendor.address && (\n            <div>\n              <span className=\"font-medium\">Address:</span> {vendor.address}\n            </div>\n          )}\n          {vendor.bankName && (\n            <div>\n              <span className=\"font-medium\">Bank:</span> {vendor.bankName} - {vendor.bankAccountNumber}\n            </div>\n          )}\n          {vendor.rejectionReason && (\n            <div className=\"mt-3 p-2 bg-destructive/10 rounded\">\n              <span className=\"font-medium\">Rejection Reason:</span> {vendor.rejectionReason}\n            </div>\n          )}\n        </div>\n\n        {vendor.status === \"pending\" && (\n          <div className=\"flex justify-end gap-2 mt-4\">\n            <Button\n              variant=\"outline\"\n              size=\"sm\"\n              onClick={() => {\n                setSelectedVendor(vendor);\n                setShowRejectDialog(true);\n              }}\n              data-testid={`button-reject-${vendor.id}`}\n            >\n              <XCircle className=\"h-4 w-4 mr-1\" />\n              Reject\n            </Button>\n            <Button\n              size=\"sm\"\n              onClick={() => {\n                setSelectedVendor(vendor);\n                setShowApproveDialog(true);\n              }}\n              data-testid={`button-approve-${vendor.id}`}\n            >\n              <CheckCircle2 className=\"h-4 w-4 mr-1\" />\n              Approve\n            </Button>\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  );\n\n  if (isLoading) {\n    return (\n      <div className=\"container mx-auto p-6\">\n        <div className=\"text-center\">Loading vendors...</div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"container mx-auto p-6\">\n      <div className=\"mb-6\">\n        <h1 className=\"text-3xl font-bold\" data-testid=\"text-title\">Vendor Approval</h1>\n        <p className=\"text-muted-foreground\">Review and approve vendor registrations</p>\n      </div>\n\n      <Tabs defaultValue=\"pending\" className=\"space-y-4\">\n        <TabsList>\n          <TabsTrigger value=\"pending\" data-testid=\"tab-pending\">\n            Pending ({pendingVendors.length})\n          </TabsTrigger>\n          <TabsTrigger value=\"approved\" data-testid=\"tab-approved\">\n            Approved ({approvedVendors.length})\n          </TabsTrigger>\n          <TabsTrigger value=\"rejected\" data-testid=\"tab-rejected\">\n            Rejected ({rejectedVendors.length})\n          </TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"pending\" className=\"space-y-4\">\n          {pendingVendors.length === 0 ? (\n            <Card>\n              <CardContent className=\"py-8 text-center text-muted-foreground\">\n                No pending vendors for approval\n              </CardContent>\n            </Card>\n          ) : (\n            <div className=\"grid gap-4 md:grid-cols-2\">\n              {pendingVendors.map(vendor => (\n                <VendorCard key={vendor.id} vendor={vendor} />\n              ))}\n            </div>\n          )}\n        </TabsContent>\n\n        <TabsContent value=\"approved\" className=\"space-y-4\">\n          {approvedVendors.length === 0 ? (\n            <Card>\n              <CardContent className=\"py-8 text-center text-muted-foreground\">\n                No approved vendors yet\n              </CardContent>\n            </Card>\n          ) : (\n            <div className=\"grid gap-4 md:grid-cols-2\">\n              {approvedVendors.map(vendor => (\n                <VendorCard key={vendor.id} vendor={vendor} />\n              ))}\n            </div>\n          )}\n        </TabsContent>\n\n        <TabsContent value=\"rejected\" className=\"space-y-4\">\n          {rejectedVendors.length === 0 ? (\n            <Card>\n              <CardContent className=\"py-8 text-center text-muted-foreground\">\n                No rejected vendors\n              </CardContent>\n            </Card>\n          ) : (\n            <div className=\"grid gap-4 md:grid-cols-2\">\n              {rejectedVendors.map(vendor => (\n                <VendorCard key={vendor.id} vendor={vendor} />\n              ))}\n            </div>\n          )}\n        </TabsContent>\n      </Tabs>\n\n      <Dialog open={showApproveDialog} onOpenChange={setShowApproveDialog}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Approve Vendor</DialogTitle>\n            <DialogDescription>\n              Are you sure you want to approve <strong>{selectedVendor?.name}</strong>?\n              This will allow them to be used in transactions.\n            </DialogDescription>\n          </DialogHeader>\n          <DialogFooter>\n            <Button\n              variant=\"outline\"\n              onClick={() => setShowApproveDialog(false)}\n              data-testid=\"button-cancel-approve\"\n            >\n              Cancel\n            </Button>\n            <Button\n              onClick={handleApprove}\n              disabled={approveMutation.isPending}\n              data-testid=\"button-confirm-approve\"\n            >\n              {approveMutation.isPending ? \"Approving...\" : \"Approve Vendor\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={showRejectDialog} onOpenChange={setShowRejectDialog}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Reject Vendor</DialogTitle>\n            <DialogDescription>\n              Please provide a reason for rejecting <strong>{selectedVendor?.name}</strong>.\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"py-4\">\n            <Label htmlFor=\"rejection-reason\">Rejection Reason *</Label>\n            <Textarea\n              id=\"rejection-reason\"\n              value={rejectionReason}\n              onChange={(e) => setRejectionReason(e.target.value)}\n              placeholder=\"Enter reason for rejection...\"\n              data-testid=\"input-rejection-reason\"\n              rows={4}\n              className=\"mt-2\"\n            />\n          </div>\n          <DialogFooter>\n            <Button\n              variant=\"outline\"\n              onClick={() => {\n                setShowRejectDialog(false);\n                setRejectionReason(\"\");\n              }}\n              data-testid=\"button-cancel-reject\"\n            >\n              Cancel\n            </Button>\n            <Button\n              variant=\"destructive\"\n              onClick={handleReject}\n              disabled={!rejectionReason.trim() || rejectMutation.isPending}\n              data-testid=\"button-confirm-reject\"\n            >\n              {rejectMutation.isPending ? \"Rejecting...\" : \"Reject Vendor\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","size_bytes":11696},"client/src/pages/accountant/vendor-statement.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { useLocation } from \"wouter\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Label } from \"@/components/ui/label\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Input } from \"@/components/ui/input\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport { Download, FileText } from \"lucide-react\";\nimport { format } from \"date-fns\";\nimport type { Vendor } from \"@shared/schema\";\n\nexport default function VendorStatement() {\n  const [location] = useLocation();\n  const urlParams = new URLSearchParams(location.split('?')[1] || '');\n  const vendorIdFromUrl = urlParams.get('vendorId') || \"\";\n\n  const [selectedVendorId, setSelectedVendorId] = useState<string>(vendorIdFromUrl);\n  const [startDate, setStartDate] = useState<string>(\"\");\n  const [endDate, setEndDate] = useState<string>(\"\");\n  const [appliedParams, setAppliedParams] = useState<{\n    vendorId: string;\n    startDate?: string;\n    endDate?: string;\n  } | null>(null);\n\n  // Auto-generate statement if vendorId is in URL\n  useEffect(() => {\n    if (vendorIdFromUrl && !appliedParams) {\n      setAppliedParams({\n        vendorId: vendorIdFromUrl,\n        startDate: undefined,\n        endDate: undefined,\n      });\n    }\n  }, [vendorIdFromUrl, appliedParams]);\n\n  const { data: vendors } = useQuery<Vendor[]>({\n    queryKey: [\"/api/accountant/vendors\"],\n  });\n\n  const approvedVendors = vendors?.filter(v => v.status === \"approved\") || [];\n\n  const { data: statement, isLoading, isFetching } = useQuery({\n    queryKey: appliedParams ? [\n      \"/api/accountant/vendors\",\n      appliedParams.vendorId,\n      \"statement\",\n      {\n        ...(appliedParams.startDate && { startDate: appliedParams.startDate }),\n        ...(appliedParams.endDate && { endDate: appliedParams.endDate }),\n      }\n    ] : ['__disabled__'],\n    enabled: Boolean(appliedParams),\n  });\n\n  const handleGenerateStatement = () => {\n    if (selectedVendorId) {\n      setAppliedParams({\n        vendorId: selectedVendorId,\n        startDate: startDate || undefined,\n        endDate: endDate || undefined,\n      });\n    }\n  };\n\n  const handleDownloadJSON = () => {\n    if (isFetching || !statement) return;\n\n    const dataStr = JSON.stringify(statement, null, 2);\n    const dataBlob = new Blob([dataStr], { type: \"application/json\" });\n    const url = URL.createObjectURL(dataBlob);\n    const link = document.createElement(\"a\");\n    link.href = url;\n    link.download = `vendor-statement-${statement.vendor.name.replace(/\\s+/g, \"-\")}-${appliedParams?.startDate || \"all\"}.json`;\n    document.body.appendChild(link);\n    link.click();\n    document.body.removeChild(link);\n    URL.revokeObjectURL(url);\n  };\n\n  const handlePrintPDF = () => {\n    if (isFetching || !statement) return;\n    window.print();\n  };\n\n  const formatCurrency = (amount: number) => {\n    return new Intl.NumberFormat(\"en-NG\", {\n      style: \"currency\",\n      currency: \"NGN\",\n    }).format(amount);\n  };\n\n  return (\n    <div className=\"container mx-auto p-6 max-w-7xl\">\n      <div className=\"mb-6 print:hidden\">\n        <h1 className=\"text-3xl font-bold\" data-testid=\"text-title\">Vendor Account Statement</h1>\n        <p className=\"text-muted-foreground\">Generate account statements for vendors</p>\n      </div>\n\n      <Card className=\"mb-6 print:hidden\">\n        <CardHeader>\n          <CardTitle>Statement Parameters</CardTitle>\n          <CardDescription>Select a vendor and optional date range</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid gap-4\">\n            <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n              <div>\n                <Label htmlFor=\"vendor\">Vendor *</Label>\n                <Select \n                  value={selectedVendorId} \n                  onValueChange={setSelectedVendorId}\n                >\n                  <SelectTrigger id=\"vendor\" data-testid=\"select-vendor\">\n                    <SelectValue placeholder=\"Select vendor\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {approvedVendors.map((vendor) => (\n                      <SelectItem key={vendor.id} value={vendor.id} data-testid={`option-vendor-${vendor.id}`}>\n                        {vendor.name} ({vendor.tinNumber})\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n\n              <div>\n                <Label htmlFor=\"start-date\">Start Date (Optional)</Label>\n                <Input\n                  id=\"start-date\"\n                  type=\"date\"\n                  value={startDate}\n                  onChange={(e) => setStartDate(e.target.value)}\n                  data-testid=\"input-start-date\"\n                />\n              </div>\n\n              <div>\n                <Label htmlFor=\"end-date\">End Date (Optional)</Label>\n                <Input\n                  id=\"end-date\"\n                  type=\"date\"\n                  value={endDate}\n                  onChange={(e) => setEndDate(e.target.value)}\n                  data-testid=\"input-end-date\"\n                />\n              </div>\n            </div>\n\n            <div className=\"flex justify-end gap-2\">\n              <Button\n                onClick={handleGenerateStatement}\n                disabled={!selectedVendorId || isLoading || isFetching}\n                data-testid=\"button-generate\"\n              >\n                <FileText className=\"h-4 w-4 mr-2\" />\n                {isFetching ? \"Generating...\" : \"Generate Statement\"}\n              </Button>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {statement && (\n        <>\n          <div className=\"mb-4 flex justify-end gap-2 print:hidden\">\n            <Button\n              variant=\"outline\"\n              onClick={handleDownloadJSON}\n              disabled={isFetching}\n              data-testid=\"button-download-json\"\n            >\n              <Download className=\"h-4 w-4 mr-2\" />\n              Download JSON\n            </Button>\n            <Button\n              variant=\"outline\"\n              onClick={handlePrintPDF}\n              disabled={isFetching}\n              data-testid=\"button-print-pdf\"\n            >\n              <FileText className=\"h-4 w-4 mr-2\" />\n              Print / PDF\n            </Button>\n          </div>\n\n          <Card className=\"print:shadow-none\">\n            <CardHeader className=\"print:pb-2\">\n              <div className=\"text-center\">\n                <CardTitle className=\"text-2xl mb-2\">Vendor Account Statement</CardTitle>\n                <CardDescription className=\"text-base\">\n                  <div className=\"font-semibold text-lg\" data-testid=\"text-vendor-name\">\n                    {statement.vendor.name}\n                  </div>\n                  <div data-testid=\"text-vendor-tin\">TIN: {statement.vendor.tinNumber}</div>\n                  {statement.startDate && statement.endDate && (\n                    <div className=\"mt-2\">\n                      Period: {format(new Date(statement.startDate), \"MMM dd, yyyy\")} -{\" \"}\n                      {format(new Date(statement.endDate), \"MMM dd, yyyy\")}\n                    </div>\n                  )}\n                  {!statement.startDate && !statement.endDate && (\n                    <div className=\"mt-2\">All Transactions</div>\n                  )}\n                </CardDescription>\n              </div>\n            </CardHeader>\n            <CardContent>\n              {statement.transactions.length === 0 ? (\n                <div className=\"text-center py-8 text-muted-foreground\">\n                  No transactions found for this vendor in the selected period.\n                </div>\n              ) : (\n                <>\n                  <Table>\n                    <TableHeader>\n                      <TableRow>\n                        <TableHead>Date</TableHead>\n                        <TableHead>Entry Number</TableHead>\n                        <TableHead>Description</TableHead>\n                        <TableHead className=\"text-right\">Debit</TableHead>\n                        <TableHead className=\"text-right\">Credit</TableHead>\n                        <TableHead className=\"text-right\">Balance</TableHead>\n                      </TableRow>\n                    </TableHeader>\n                    <TableBody>\n                      {statement.transactions.map((transaction: any) => (\n                        <TableRow key={transaction.id} data-testid={`row-transaction-${transaction.id}`}>\n                          <TableCell>\n                            {format(new Date(transaction.entryDate), \"MMM dd, yyyy\")}\n                          </TableCell>\n                          <TableCell>{transaction.entryNumber}</TableCell>\n                          <TableCell>{transaction.description}</TableCell>\n                          <TableCell className=\"text-right\">\n                            {transaction.amount > 0 ? formatCurrency(transaction.amount) : \"-\"}\n                          </TableCell>\n                          <TableCell className=\"text-right\">\n                            {transaction.amount < 0 ? formatCurrency(Math.abs(transaction.amount)) : \"-\"}\n                          </TableCell>\n                          <TableCell className=\"text-right font-medium\">\n                            {formatCurrency(transaction.runningBalance)}\n                          </TableCell>\n                        </TableRow>\n                      ))}\n                    </TableBody>\n                  </Table>\n\n                  <div className=\"mt-6 border-t pt-4\">\n                    <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n                      <div>\n                        <div className=\"text-sm text-muted-foreground\">Opening Balance</div>\n                        <div className=\"text-lg font-semibold\" data-testid=\"text-opening-balance\">\n                          {formatCurrency(statement.openingBalance)}\n                        </div>\n                      </div>\n                      <div>\n                        <div className=\"text-sm text-muted-foreground\">Total Debits</div>\n                        <div className=\"text-lg font-semibold\" data-testid=\"text-total-debits\">\n                          {formatCurrency(statement.totalDebits)}\n                        </div>\n                      </div>\n                      <div>\n                        <div className=\"text-sm text-muted-foreground\">Total Credits</div>\n                        <div className=\"text-lg font-semibold\" data-testid=\"text-total-credits\">\n                          {formatCurrency(statement.totalCredits)}\n                        </div>\n                      </div>\n                      <div>\n                        <div className=\"text-sm text-muted-foreground\">Closing Balance</div>\n                        <div className=\"text-lg font-semibold\" data-testid=\"text-closing-balance\">\n                          {formatCurrency(statement.closingBalance)}\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n                </>\n              )}\n            </CardContent>\n          </Card>\n        </>\n      )}\n\n      {!appliedParams && (\n        <Card>\n          <CardContent className=\"py-12 text-center text-muted-foreground\">\n            Select a vendor and click \"Generate Statement\" to view transactions\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  );\n}\n","size_bytes":11774},"client/src/pages/my-expenses.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Loader2, ExternalLink, Plus } from \"lucide-react\";\nimport { format } from \"date-fns\";\nimport { Link } from \"wouter\";\n\nexport default function MyExpenses() {\n  const { data: expenses = [], isLoading } = useQuery<any[]>({\n    queryKey: ['/api/expenses/my-expenses'],\n  });\n\n  const getStatusBadge = (status: string) => {\n    switch (status) {\n      case 'pending':\n        return <Badge variant=\"secondary\" data-testid={`status-pending`}>Pending</Badge>;\n      case 'approved':\n        return <Badge className=\"bg-green-600 hover:bg-green-700\" data-testid={`status-approved`}>Approved</Badge>;\n      case 'rejected':\n        return <Badge variant=\"destructive\" data-testid={`status-rejected`}>Rejected</Badge>;\n      default:\n        return <Badge variant=\"outline\" data-testid={`status-${status}`}>{status}</Badge>;\n    }\n  };\n\n  const calculateTotal = (expense: any) => {\n    const amount = parseFloat(expense.expenseAmount) || 0;\n    const serviceCharge = parseFloat(expense.serviceCharge) || 0;\n    return amount + serviceCharge;\n  };\n\n  const renderExpenseTable = (filteredExpenses: any[]) => (\n    <Table>\n      <TableHeader>\n        <TableRow>\n          <TableHead>Date</TableHead>\n          <TableHead>Type</TableHead>\n          <TableHead>Description</TableHead>\n          <TableHead>Vendor</TableHead>\n          <TableHead>Amount</TableHead>\n          <TableHead>Service Charge</TableHead>\n          <TableHead>Total</TableHead>\n          <TableHead>Status</TableHead>\n          <TableHead>Receipt</TableHead>\n        </TableRow>\n      </TableHeader>\n      <TableBody>\n        {filteredExpenses.length === 0 ? (\n          <TableRow>\n            <TableCell colSpan={9} className=\"text-center text-muted-foreground\">\n              No expenses found\n            </TableCell>\n          </TableRow>\n        ) : (\n          filteredExpenses.map((expense) => (\n            <TableRow key={expense.id} data-testid={`row-expense-${expense.id}`}>\n              <TableCell data-testid={`text-date-${expense.id}`}>\n                {format(new Date(expense.createdAt), \"MMM dd, yyyy\")}\n              </TableCell>\n              <TableCell data-testid={`text-type-${expense.id}`}>\n                {expense.expenseType}\n              </TableCell>\n              <TableCell data-testid={`text-description-${expense.id}`}>\n                <div className=\"max-w-xs truncate\" title={expense.description}>\n                  {expense.description}\n                </div>\n              </TableCell>\n              <TableCell data-testid={`text-vendor-${expense.id}`}>\n                {expense.vendorName || \"-\"}\n              </TableCell>\n              <TableCell data-testid={`text-amount-${expense.id}`}>\n                ₦{parseFloat(expense.expenseAmount).toLocaleString()}\n              </TableCell>\n              <TableCell data-testid={`text-service-charge-${expense.id}`}>\n                {expense.serviceCharge ? `₦${parseFloat(expense.serviceCharge).toLocaleString()}` : \"-\"}\n              </TableCell>\n              <TableCell data-testid={`text-total-${expense.id}`}>\n                ₦{calculateTotal(expense).toLocaleString()}\n              </TableCell>\n              <TableCell>\n                {getStatusBadge(expense.status)}\n              </TableCell>\n              <TableCell>\n                {expense.receiptPath && (\n                  <Button\n                    size=\"sm\"\n                    variant=\"outline\"\n                    onClick={() => window.open(expense.receiptPath, '_blank')}\n                    data-testid={`button-receipt-${expense.id}`}\n                  >\n                    <ExternalLink className=\"h-4 w-4\" />\n                  </Button>\n                )}\n              </TableCell>\n            </TableRow>\n          ))\n        )}\n      </TableBody>\n    </Table>\n  );\n\n  const pendingExpenses = expenses.filter(e => e.status === 'pending');\n  const approvedExpenses = expenses.filter(e => e.status === 'approved');\n  const rejectedExpenses = expenses.filter(e => e.status === 'rejected');\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center min-h-[400px]\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-primary\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"container mx-auto p-6\">\n      <Card>\n        <CardHeader>\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <CardTitle data-testid=\"text-page-title\">My Expense Requests</CardTitle>\n              <CardDescription>\n                View and track your submitted expense requests\n              </CardDescription>\n            </div>\n            <Link href=\"/accountant/expenses/request\">\n              <Button data-testid=\"button-new-expense\">\n                <Plus className=\"h-4 w-4 mr-2\" />\n                New Expense\n              </Button>\n            </Link>\n          </div>\n        </CardHeader>\n        <CardContent>\n          <Tabs defaultValue=\"all\" className=\"w-full\">\n            <TabsList className=\"mb-4\">\n              <TabsTrigger value=\"all\" data-testid=\"tab-all\">\n                All ({expenses.length})\n              </TabsTrigger>\n              <TabsTrigger value=\"pending\" data-testid=\"tab-pending\">\n                Pending ({pendingExpenses.length})\n              </TabsTrigger>\n              <TabsTrigger value=\"approved\" data-testid=\"tab-approved\">\n                Approved ({approvedExpenses.length})\n              </TabsTrigger>\n              <TabsTrigger value=\"rejected\" data-testid=\"tab-rejected\">\n                Rejected ({rejectedExpenses.length})\n              </TabsTrigger>\n            </TabsList>\n\n            <TabsContent value=\"all\">\n              {renderExpenseTable(expenses)}\n            </TabsContent>\n\n            <TabsContent value=\"pending\">\n              {renderExpenseTable(pendingExpenses)}\n            </TabsContent>\n\n            <TabsContent value=\"approved\">\n              {renderExpenseTable(approvedExpenses)}\n            </TabsContent>\n\n            <TabsContent value=\"rejected\">\n              {renderExpenseTable(rejectedExpenses)}\n              {rejectedExpenses.length > 0 && rejectedExpenses.some(e => e.rejectionReason) && (\n                <div className=\"mt-4 p-4 bg-muted rounded-md\">\n                  <h4 className=\"font-semibold mb-2\">Rejection Reasons:</h4>\n                  {rejectedExpenses.filter(e => e.rejectionReason).map((expense) => (\n                    <div key={expense.id} className=\"mb-2\">\n                      <span className=\"font-medium\">{format(new Date(expense.createdAt), \"MMM dd, yyyy\")}:</span>{\" \"}\n                      {expense.rejectionReason}\n                    </div>\n                  ))}\n                </div>\n              )}\n            </TabsContent>\n          </Tabs>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":7248},"client/src/pages/accountant/expense-approval.tsx":{"content":"import { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Label } from \"@/components/ui/label\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { CheckCircle, XCircle, Loader2, ExternalLink, AlertTriangle, TrendingUp, Receipt } from \"lucide-react\";\nimport { useState } from \"react\";\nimport { format } from \"date-fns\";\n\n// Component to display budget information for an expense account\nfunction BudgetInfo({ accountId }: { accountId: string | null }) {\n  const { data: budgetInfo, isLoading } = useQuery<any>({\n    queryKey: ['/api/accountant/budgets/account', accountId],\n    enabled: !!accountId,\n  });\n\n  if (!accountId) {\n    return (\n      <div className=\"text-sm text-muted-foreground\">\n        No active budget\n      </div>\n    );\n  }\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n        <Loader2 className=\"h-3 w-3 animate-spin\" />\n        <span>Loading budget information...</span>\n      </div>\n    );\n  }\n\n  if (!budgetInfo) {\n    return (\n      <div className=\"text-sm text-muted-foreground\">\n        No active budget for this account\n      </div>\n    );\n  }\n\n  const allocated = parseFloat(budgetInfo.allocatedAmount || '0');\n  const consumed = parseFloat(budgetInfo.consumedAmount || '0');\n  const remaining = parseFloat(budgetInfo.remainingAmount || '0');\n  const percentUsed = (consumed / allocated) * 100;\n\n  return (\n    <div className=\"space-y-1\">\n      <div className=\"flex items-center gap-2\">\n        <TrendingUp className=\"h-3 w-3 text-muted-foreground\" />\n        <span className=\"text-xs font-medium\">{budgetInfo.budgetName}</span>\n      </div>\n      <div className=\"text-xs space-y-0.5\">\n        <div className=\"flex justify-between\">\n          <span className=\"text-muted-foreground\">Allocated:</span>\n          <span className=\"font-mono\">₦{allocated.toLocaleString('en-NG', { minimumFractionDigits: 2 })}</span>\n        </div>\n        <div className=\"flex justify-between\">\n          <span className=\"text-muted-foreground\">Consumed:</span>\n          <span className=\"font-mono\">₦{consumed.toLocaleString('en-NG', { minimumFractionDigits: 2 })}</span>\n        </div>\n        <div className=\"flex justify-between\">\n          <span className=\"text-muted-foreground\">Remaining:</span>\n          <span className={`font-mono ${percentUsed > 90 ? 'text-red-600 font-semibold' : ''}`}>\n            ₦{remaining.toLocaleString('en-NG', { minimumFractionDigits: 2 })}\n          </span>\n        </div>\n        <div className=\"flex justify-between\">\n          <span className=\"text-muted-foreground\">Used:</span>\n          <span className={`font-semibold ${percentUsed > 90 ? 'text-red-600' : percentUsed > 75 ? 'text-orange-600' : 'text-green-600'}`}>\n            {percentUsed.toFixed(1)}%\n          </span>\n        </div>\n      </div>\n    </div>\n  );\n}\n\n// Component to check if expense will exceed budget\nfunction BudgetWarning({ accountId, expenseAmount }: { accountId: string | null; expenseAmount: number }) {\n  const { data: budgetInfo, isLoading } = useQuery<any>({\n    queryKey: ['/api/accountant/budgets/account', accountId],\n    enabled: !!accountId,\n  });\n\n  if (!accountId || isLoading || !budgetInfo) {\n    return null;\n  }\n\n  const remaining = parseFloat(budgetInfo.remainingAmount || '0');\n  const willExceed = expenseAmount > remaining;\n\n  if (!willExceed) {\n    return null;\n  }\n\n  const overage = expenseAmount - remaining;\n\n  return (\n    <Alert variant=\"destructive\" className=\"mt-2\">\n      <AlertTriangle className=\"h-4 w-4\" />\n      <AlertDescription>\n        This expense (₦{expenseAmount.toLocaleString()}) exceeds the remaining budget by ₦{overage.toLocaleString()}\n      </AlertDescription>\n    </Alert>\n  );\n}\n\nexport default function ExpenseApproval() {\n  const { toast } = useToast();\n  const [selectedExpense, setSelectedExpense] = useState<any>(null);\n  const [showRejectDialog, setShowRejectDialog] = useState(false);\n  const [showApprovalDialog, setShowApprovalDialog] = useState(false);\n  const [showReceiptDialog, setShowReceiptDialog] = useState(false);\n  const [receiptToView, setReceiptToView] = useState<string>(\"\");\n  const [expenseToApprove, setExpenseToApprove] = useState<any>(null);\n  const [rejectionReason, setRejectionReason] = useState(\"\");\n\n  const { data: expenses = [], isLoading } = useQuery<any[]>({\n    queryKey: ['/api/accountant/expenses'],\n  });\n\n  const approveMutation = useMutation({\n    mutationFn: async (expenseId: string) => {\n      return await apiRequest('POST', `/api/accountant/expenses/${expenseId}/approve`, {});\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Success\",\n        description: \"Expense approved successfully\",\n      });\n      setShowApprovalDialog(false);\n      setExpenseToApprove(null);\n      queryClient.invalidateQueries({ queryKey: ['/api/accountant/expenses'] });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to approve expense\",\n        variant: \"destructive\",\n      });\n      // Keep dialog open on error so user can retry\n    },\n  });\n\n  const rejectMutation = useMutation({\n    mutationFn: async ({ expenseId, reason }: { expenseId: string; reason: string }) => {\n      return await apiRequest('POST', `/api/accountant/expenses/${expenseId}/reject`, { reason });\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Success\",\n        description: \"Expense rejected successfully\",\n      });\n      setShowRejectDialog(false);\n      setSelectedExpense(null);\n      setRejectionReason(\"\");\n      queryClient.invalidateQueries({ queryKey: ['/api/accountant/expenses'] });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to reject expense\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleApprove = (expense: any) => {\n    setExpenseToApprove(expense);\n    setShowApprovalDialog(true);\n  };\n\n  const confirmApprove = () => {\n    if (expenseToApprove) {\n      approveMutation.mutate(expenseToApprove.id);\n    }\n  };\n\n  const handleReject = (expense: any) => {\n    setSelectedExpense(expense);\n    setShowRejectDialog(true);\n  };\n\n  const confirmReject = () => {\n    if (!rejectionReason.trim()) {\n      toast({\n        title: \"Error\",\n        description: \"Please provide a rejection reason\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    rejectMutation.mutate({\n      expenseId: selectedExpense.id,\n      reason: rejectionReason,\n    });\n  };\n\n  const getStatusBadge = (status: string) => {\n    switch (status) {\n      case 'pending':\n        return <Badge variant=\"secondary\" data-testid={`status-pending`}>Pending</Badge>;\n      case 'approved':\n        return <Badge className=\"bg-green-600 hover:bg-green-700\" data-testid={`status-approved`}>Approved</Badge>;\n      case 'rejected':\n        return <Badge variant=\"destructive\" data-testid={`status-rejected`}>Rejected</Badge>;\n      default:\n        return <Badge variant=\"outline\" data-testid={`status-${status}`}>{status}</Badge>;\n    }\n  };\n\n  const calculateTotal = (expense: any) => {\n    const amount = parseFloat(expense.expenseAmount) || 0;\n    const serviceCharge = parseFloat(expense.serviceCharge) || 0;\n    return amount + serviceCharge;\n  };\n\n  const renderExpenseTable = (filteredExpenses: any[]) => (\n    <Table>\n      <TableHeader>\n        <TableRow>\n          <TableHead>Date</TableHead>\n          <TableHead>Type</TableHead>\n          <TableHead>Description</TableHead>\n          <TableHead>Vendor</TableHead>\n          <TableHead>Amount</TableHead>\n          <TableHead>Service Charge</TableHead>\n          <TableHead>Total</TableHead>\n          <TableHead>Status</TableHead>\n          <TableHead>Actions</TableHead>\n        </TableRow>\n      </TableHeader>\n      <TableBody>\n        {filteredExpenses.length === 0 ? (\n          <TableRow>\n            <TableCell colSpan={9} className=\"text-center text-muted-foreground\">\n              No expenses found\n            </TableCell>\n          </TableRow>\n        ) : (\n          filteredExpenses.map((expense) => (\n            <TableRow key={expense.id} data-testid={`row-expense-${expense.id}`}>\n              <TableCell data-testid={`text-date-${expense.id}`}>\n                {format(new Date(expense.createdAt), \"MMM dd, yyyy\")}\n              </TableCell>\n              <TableCell data-testid={`text-type-${expense.id}`}>\n                {expense.expenseType}\n              </TableCell>\n              <TableCell data-testid={`text-description-${expense.id}`}>\n                <div className=\"max-w-xs truncate\" title={expense.description}>\n                  {expense.description}\n                </div>\n              </TableCell>\n              <TableCell data-testid={`text-vendor-${expense.id}`}>\n                {expense.vendorName || \"-\"}\n              </TableCell>\n              <TableCell data-testid={`text-amount-${expense.id}`}>\n                ₦{parseFloat(expense.expenseAmount).toLocaleString()}\n              </TableCell>\n              <TableCell data-testid={`text-service-charge-${expense.id}`}>\n                {expense.serviceCharge ? `₦${parseFloat(expense.serviceCharge).toLocaleString()}` : \"-\"}\n              </TableCell>\n              <TableCell data-testid={`text-total-${expense.id}`}>\n                ₦{calculateTotal(expense).toLocaleString()}\n              </TableCell>\n              <TableCell>\n                {getStatusBadge(expense.status)}\n              </TableCell>\n              <TableCell>\n                <div className=\"flex gap-2\">\n                  {expense.status === 'pending' && (\n                    <>\n                      <Button\n                        size=\"sm\"\n                        variant=\"default\"\n                        onClick={() => handleApprove(expense)}\n                        disabled={approveMutation.isPending}\n                        data-testid={`button-approve-${expense.id}`}\n                      >\n                        <CheckCircle className=\"h-4 w-4\" />\n                      </Button>\n                      <Button\n                        size=\"sm\"\n                        variant=\"destructive\"\n                        onClick={() => handleReject(expense)}\n                        disabled={rejectMutation.isPending}\n                        data-testid={`button-reject-${expense.id}`}\n                      >\n                        <XCircle className=\"h-4 w-4\" />\n                      </Button>\n                    </>\n                  )}\n                  {expense.receiptPath && (\n                    <Button\n                      size=\"sm\"\n                      variant=\"outline\"\n                      onClick={() => {\n                        setReceiptToView(expense.receiptPath);\n                        setShowReceiptDialog(true);\n                      }}\n                      data-testid={`button-receipt-${expense.id}`}\n                    >\n                      <Receipt className=\"h-4 w-4\" />\n                    </Button>\n                  )}\n                </div>\n              </TableCell>\n            </TableRow>\n          ))\n        )}\n      </TableBody>\n    </Table>\n  );\n\n  const pendingExpenses = expenses.filter(e => e.status === 'pending');\n  const approvedExpenses = expenses.filter(e => e.status === 'approved');\n  const rejectedExpenses = expenses.filter(e => e.status === 'rejected');\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center min-h-[400px]\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-primary\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"container mx-auto p-6\">\n      <Card>\n        <CardHeader>\n          <CardTitle data-testid=\"text-page-title\">Expense Approval</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <Tabs defaultValue=\"pending\" className=\"w-full\">\n            <TabsList className=\"mb-4\">\n              <TabsTrigger value=\"pending\" data-testid=\"tab-pending\">\n                Pending ({pendingExpenses.length})\n              </TabsTrigger>\n              <TabsTrigger value=\"approved\" data-testid=\"tab-approved\">\n                Approved ({approvedExpenses.length})\n              </TabsTrigger>\n              <TabsTrigger value=\"rejected\" data-testid=\"tab-rejected\">\n                Rejected ({rejectedExpenses.length})\n              </TabsTrigger>\n              <TabsTrigger value=\"all\" data-testid=\"tab-all\">\n                All ({expenses.length})\n              </TabsTrigger>\n            </TabsList>\n\n            <TabsContent value=\"pending\">\n              {renderExpenseTable(pendingExpenses)}\n            </TabsContent>\n\n            <TabsContent value=\"approved\">\n              {renderExpenseTable(approvedExpenses)}\n            </TabsContent>\n\n            <TabsContent value=\"rejected\">\n              {renderExpenseTable(rejectedExpenses)}\n            </TabsContent>\n\n            <TabsContent value=\"all\">\n              {renderExpenseTable(expenses)}\n            </TabsContent>\n          </Tabs>\n        </CardContent>\n      </Card>\n\n      <Dialog open={showApprovalDialog} onOpenChange={setShowApprovalDialog}>\n        <DialogContent className=\"max-w-2xl\" data-testid=\"dialog-approve\">\n          <DialogHeader>\n            <DialogTitle>Approve Expense</DialogTitle>\n            <DialogDescription>\n              Review budget utilization before approving this expense\n            </DialogDescription>\n          </DialogHeader>\n          {expenseToApprove && (\n            <div className=\"space-y-4 py-4\">\n              <div className=\"space-y-2\">\n                <h3 className=\"font-semibold text-sm\">Expense Details</h3>\n                <div className=\"grid grid-cols-2 gap-3 text-sm border rounded-md p-4 bg-muted/30\">\n                  <div>\n                    <span className=\"text-muted-foreground\">Type:</span>\n                    <div className=\"font-medium\">{expenseToApprove.expenseType}</div>\n                  </div>\n                  <div>\n                    <span className=\"text-muted-foreground\">Vendor:</span>\n                    <div className=\"font-medium\">{expenseToApprove.vendorName || \"N/A\"}</div>\n                  </div>\n                  <div>\n                    <span className=\"text-muted-foreground\">Amount:</span>\n                    <div className=\"font-medium\">₦{parseFloat(expenseToApprove.expenseAmount).toLocaleString('en-NG', { minimumFractionDigits: 2 })}</div>\n                  </div>\n                  {expenseToApprove.serviceCharge && (\n                    <div>\n                      <span className=\"text-muted-foreground\">Service Charge:</span>\n                      <div className=\"font-medium\">₦{parseFloat(expenseToApprove.serviceCharge).toLocaleString('en-NG', { minimumFractionDigits: 2 })}</div>\n                    </div>\n                  )}\n                  <div className=\"col-span-2\">\n                    <span className=\"text-muted-foreground\">Description:</span>\n                    <div className=\"font-medium\">{expenseToApprove.description}</div>\n                  </div>\n                  <div className=\"col-span-2\">\n                    <span className=\"text-muted-foreground\">Total Amount:</span>\n                    <div className=\"text-lg font-bold\">₦{calculateTotal(expenseToApprove).toLocaleString('en-NG', { minimumFractionDigits: 2 })}</div>\n                  </div>\n                </div>\n              </div>\n\n              {expenseToApprove.accountId && (\n                <div className=\"space-y-2\">\n                  <h3 className=\"font-semibold text-sm\">Budget Information</h3>\n                  <div className=\"border rounded-md p-4 bg-muted/30\">\n                    <BudgetInfo accountId={expenseToApprove.accountId} />\n                  </div>\n                  <BudgetWarning \n                    accountId={expenseToApprove.accountId} \n                    expenseAmount={calculateTotal(expenseToApprove)} \n                  />\n                </div>\n              )}\n\n              {!expenseToApprove.accountId && (\n                <Alert>\n                  <AlertTriangle className=\"h-4 w-4\" />\n                  <AlertDescription>\n                    This expense is not linked to any budget account. Budget tracking will not be available.\n                  </AlertDescription>\n                </Alert>\n              )}\n            </div>\n          )}\n          <DialogFooter>\n            <Button\n              variant=\"outline\"\n              onClick={() => {\n                setShowApprovalDialog(false);\n                setExpenseToApprove(null);\n              }}\n              data-testid=\"button-cancel-approval\"\n            >\n              Cancel\n            </Button>\n            <Button\n              onClick={confirmApprove}\n              disabled={approveMutation.isPending}\n              data-testid=\"button-confirm-approve\"\n            >\n              {approveMutation.isPending && (\n                <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n              )}\n              Approve Expense\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={showRejectDialog} onOpenChange={setShowRejectDialog}>\n        <DialogContent data-testid=\"dialog-reject\">\n          <DialogHeader>\n            <DialogTitle>Reject Expense</DialogTitle>\n            <DialogDescription>\n              Please provide a reason for rejecting this expense request.\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"py-4\">\n            <Label htmlFor=\"rejection-reason\">Rejection Reason</Label>\n            <Textarea\n              id=\"rejection-reason\"\n              value={rejectionReason}\n              onChange={(e) => setRejectionReason(e.target.value)}\n              placeholder=\"Enter reason for rejection...\"\n              rows={4}\n              className=\"mt-2\"\n              data-testid=\"input-rejection-reason\"\n            />\n          </div>\n          <DialogFooter>\n            <Button\n              variant=\"outline\"\n              onClick={() => {\n                setShowRejectDialog(false);\n                setSelectedExpense(null);\n                setRejectionReason(\"\");\n              }}\n              data-testid=\"button-cancel\"\n            >\n              Cancel\n            </Button>\n            <Button\n              variant=\"destructive\"\n              onClick={confirmReject}\n              disabled={rejectMutation.isPending}\n              data-testid=\"button-confirm-reject\"\n            >\n              {rejectMutation.isPending && (\n                <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n              )}\n              Reject Expense\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={showReceiptDialog} onOpenChange={setShowReceiptDialog}>\n        <DialogContent className=\"max-w-3xl\" data-testid=\"dialog-receipt\">\n          <DialogHeader>\n            <DialogTitle>Receipt Image</DialogTitle>\n            <DialogDescription>\n              View uploaded receipt\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"py-4\">\n            {receiptToView && (\n              <img\n                src={receiptToView}\n                alt=\"Receipt\"\n                className=\"w-full h-auto rounded-md border\"\n                data-testid=\"img-receipt-view\"\n              />\n            )}\n          </div>\n          <DialogFooter>\n            <Button\n              variant=\"outline\"\n              onClick={() => {\n                setShowReceiptDialog(false);\n                setReceiptToView(\"\");\n              }}\n              data-testid=\"button-close-receipt\"\n            >\n              Close\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","size_bytes":20504},"client/src/pages/accountant/expense-request.tsx":{"content":"import { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { useMutation, useQuery } from \"@tanstack/react-query\";\nimport { insertExpenseSchema } from \"@shared/schema\";\nimport { z } from \"zod\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage, FormDescription } from \"@/components/ui/form\";\nimport { Input } from \"@/components/ui/input\";\nimport { Button } from \"@/components/ui/button\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Loader2, Upload, Camera, X } from \"lucide-react\";\nimport { useState, useEffect, useRef } from \"react\";\nimport { useLocation } from \"wouter\";\n\nconst expenseFormSchema = insertExpenseSchema.extend({\n  expenseAmount: z.string().min(1, \"Expense amount is required\").regex(/^\\d+(\\.\\d{1,2})?$/, \"Invalid amount format\"),\n  serviceCharge: z.string().optional().refine((val) => {\n    if (!val || val === \"\") return true;\n    return /^\\d+(\\.\\d{1,2})?$/.test(val);\n  }, \"Invalid service charge format\"),\n});\n\ntype ExpenseFormValues = z.infer<typeof expenseFormSchema>;\n\nexport default function ExpenseRequest() {\n  const { toast } = useToast();\n  const [location] = useLocation();\n  const urlParams = new URLSearchParams(location.split('?')[1] || '');\n  const vendorIdFromUrl = urlParams.get('vendorId') || \"\";\n  const [selectedExpenseType, setSelectedExpenseType] = useState<string>(\"\");\n  const [receiptPreview, setReceiptPreview] = useState<string>(\"\");\n  const fileInputRef = useRef<HTMLInputElement>(null);\n  const cameraInputRef = useRef<HTMLInputElement>(null);\n\n  const form = useForm<ExpenseFormValues>({\n    resolver: zodResolver(expenseFormSchema),\n    defaultValues: {\n      vendorId: vendorIdFromUrl,\n      expenseType: \"Retail Expense\",\n      expenseClassification: undefined,\n      description: \"\",\n      expenseAmount: \"\",\n      serviceCharge: \"\",\n      receiptPath: \"\",\n      accountId: \"\",\n      status: \"pending\",\n      submittedBy: \"\",\n    },\n  });\n\n  // Update vendorId when URL changes\n  useEffect(() => {\n    if (vendorIdFromUrl) {\n      form.setValue(\"vendorId\", vendorIdFromUrl);\n    }\n  }, [vendorIdFromUrl, form]);\n\n  const { data: vendors = [], isLoading: loadingVendors } = useQuery<any[]>({\n    queryKey: ['/api/accountant/vendors'],\n  });\n\n  const { data: accounts = [], isLoading: loadingAccounts } = useQuery<any[]>({\n    queryKey: ['/api/accountant/accounts'],\n  });\n\n  const approvedVendors = vendors.filter(v => v.status === 'approved');\n  const activeAccounts = accounts.filter((acc: any) => acc.isActive === true);\n\n  const compressImage = (file: File): Promise<string> => {\n    return new Promise((resolve, reject) => {\n      const reader = new FileReader();\n      reader.onload = (e) => {\n        const img = new Image();\n        img.onload = () => {\n          // Create canvas\n          const canvas = document.createElement('canvas');\n          const ctx = canvas.getContext('2d');\n          if (!ctx) {\n            reject(new Error('Failed to get canvas context'));\n            return;\n          }\n\n          // Calculate new dimensions (max 800px width/height for faster processing)\n          const MAX_SIZE = 800;\n          let width = img.width;\n          let height = img.height;\n\n          if (width > height) {\n            if (width > MAX_SIZE) {\n              height *= MAX_SIZE / width;\n              width = MAX_SIZE;\n            }\n          } else {\n            if (height > MAX_SIZE) {\n              width *= MAX_SIZE / height;\n              height = MAX_SIZE;\n            }\n          }\n\n          canvas.width = width;\n          canvas.height = height;\n\n          // Draw and compress\n          ctx.drawImage(img, 0, 0, width, height);\n          \n          // Convert to base64 with optimized compression (0.5 quality for faster processing)\n          const compressedBase64 = canvas.toDataURL('image/jpeg', 0.5);\n          resolve(compressedBase64);\n        };\n        img.onerror = () => reject(new Error('Failed to load image'));\n        img.src = e.target?.result as string;\n      };\n      reader.onerror = () => reject(new Error('Failed to read file'));\n      reader.readAsDataURL(file);\n    });\n  };\n\n  const handleFileUpload = async (event: React.ChangeEvent<HTMLInputElement>) => {\n    const file = event.target.files?.[0];\n    if (!file) return;\n\n    if (file.size > 10 * 1024 * 1024) {\n      toast({\n        title: \"Error\",\n        description: \"File size must be less than 10MB\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    if (!file.type.startsWith('image/')) {\n      toast({\n        title: \"Error\",\n        description: \"Only image files are allowed\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    try {\n      toast({\n        title: \"Processing\",\n        description: \"Compressing image...\",\n      });\n      \n      const compressedBase64 = await compressImage(file);\n      setReceiptPreview(compressedBase64);\n      form.setValue(\"receiptPath\", compressedBase64);\n      \n      toast({\n        title: \"Success\",\n        description: \"Receipt uploaded successfully\",\n      });\n    } catch (error) {\n      toast({\n        title: \"Error\",\n        description: \"Failed to process image\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const removeReceipt = () => {\n    setReceiptPreview(\"\");\n    form.setValue(\"receiptPath\", \"\");\n    if (fileInputRef.current) fileInputRef.current.value = \"\";\n    if (cameraInputRef.current) cameraInputRef.current.value = \"\";\n  };\n\n  const createExpenseMutation = useMutation({\n    mutationFn: async (data: ExpenseFormValues) => {\n      return await apiRequest('POST', '/api/expenses', data);\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Success\",\n        description: \"Expense request submitted successfully\",\n      });\n      form.reset();\n      setSelectedExpenseType(\"\");\n      setReceiptPreview(\"\");\n      queryClient.invalidateQueries({ queryKey: ['/api/expenses/my-expenses'] });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to submit expense request\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const onSubmit = (data: ExpenseFormValues) => {\n    // Remove vendorId if empty\n    if (!data.vendorId) {\n      delete data.vendorId;\n    }\n    // Remove accountId if empty\n    if (!data.accountId) {\n      delete data.accountId;\n    }\n    // Remove serviceCharge if not a Service Payment\n    if (data.expenseType !== \"Service Payment\" || !data.serviceCharge) {\n      delete data.serviceCharge;\n    }\n    // Remove receiptPath if empty\n    if (!data.receiptPath) {\n      delete data.receiptPath;\n    }\n    createExpenseMutation.mutate(data);\n  };\n\n  return (\n    <div className=\"container mx-auto p-6 max-w-3xl\">\n      <Card>\n        <CardHeader>\n          <CardTitle data-testid=\"text-page-title\">Submit Expense Request</CardTitle>\n          <CardDescription>\n            Create a new expense request for accountant approval\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <Form {...form}>\n            <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-6\">\n              <FormField\n                control={form.control}\n                name=\"vendorId\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Vendor (Optional)</FormLabel>\n                    <Select\n                      onValueChange={field.onChange}\n                      value={field.value || \"\"}\n                      disabled={loadingVendors}\n                    >\n                      <FormControl>\n                        <SelectTrigger data-testid=\"select-vendor\">\n                          <SelectValue placeholder=\"Select a vendor (optional)\" />\n                        </SelectTrigger>\n                      </FormControl>\n                      <SelectContent>\n                        {approvedVendors.map((vendor) => (\n                          <SelectItem key={vendor.id} value={vendor.id}>\n                            {vendor.name} (TIN: {vendor.tinNumber})\n                          </SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"expenseType\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Expense Type</FormLabel>\n                    <Select\n                      onValueChange={(value) => {\n                        field.onChange(value);\n                        setSelectedExpenseType(value);\n                      }}\n                      value={field.value}\n                    >\n                      <FormControl>\n                        <SelectTrigger data-testid=\"select-expense-type\">\n                          <SelectValue placeholder=\"Select expense type\" />\n                        </SelectTrigger>\n                      </FormControl>\n                      <SelectContent>\n                        <SelectItem value=\"Retail Expense\">Retail Expense</SelectItem>\n                        <SelectItem value=\"Service Payment\">Service Payment</SelectItem>\n                      </SelectContent>\n                    </Select>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"expenseClassification\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Expense Classification (Optional)</FormLabel>\n                    <Select\n                      onValueChange={field.onChange}\n                      value={field.value || \"\"}\n                    >\n                      <FormControl>\n                        <SelectTrigger data-testid=\"select-expense-classification\">\n                          <SelectValue placeholder=\"Select expense category\" />\n                        </SelectTrigger>\n                      </FormControl>\n                      <SelectContent>\n                        <SelectItem value=\"Security & Guards\">Security & Guards</SelectItem>\n                        <SelectItem value=\"Cleaning & Janitorial\">Cleaning & Janitorial</SelectItem>\n                        <SelectItem value=\"Waste Management\">Waste Management</SelectItem>\n                        <SelectItem value=\"Diesel / Generator\">Diesel / Generator</SelectItem>\n                        <SelectItem value=\"Electrical Repairs\">Electrical Repairs</SelectItem>\n                        <SelectItem value=\"Plumbing Repairs\">Plumbing Repairs</SelectItem>\n                        <SelectItem value=\"Landscaping\">Landscaping</SelectItem>\n                        <SelectItem value=\"General Maintenance\">General Maintenance</SelectItem>\n                        <SelectItem value=\"Office/Admin Expenses\">Office/Admin Expenses</SelectItem>\n                      </SelectContent>\n                    </Select>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"accountId\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Link to Account (Optional)</FormLabel>\n                    <Select\n                      onValueChange={field.onChange}\n                      value={field.value || \"\"}\n                      disabled={loadingAccounts}\n                    >\n                      <FormControl>\n                        <SelectTrigger data-testid=\"select-link-account\">\n                          <SelectValue placeholder=\"Select an account from chart of accounts\" />\n                        </SelectTrigger>\n                      </FormControl>\n                      <SelectContent>\n                        {activeAccounts.map((account: any) => (\n                          <SelectItem key={account.id} value={account.id}>\n                            {account.accountNumber} - {account.accountName}\n                          </SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                    <FormDescription>\n                      Link this expense to a specific account for budget tracking\n                    </FormDescription>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"description\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Description</FormLabel>\n                    <FormControl>\n                      <Textarea\n                        {...field}\n                        placeholder=\"Describe the expense...\"\n                        rows={4}\n                        data-testid=\"input-description\"\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"expenseAmount\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Expense Amount (₦)</FormLabel>\n                    <FormControl>\n                      <Input\n                        {...field}\n                        type=\"text\"\n                        placeholder=\"0.00\"\n                        data-testid=\"input-expense-amount\"\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              {(selectedExpenseType === \"Service Payment\" || form.watch(\"expenseType\") === \"Service Payment\") && (\n                <FormField\n                  control={form.control}\n                  name=\"serviceCharge\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Service Charge (₦)</FormLabel>\n                      <FormControl>\n                        <Input\n                          {...field}\n                          type=\"text\"\n                          placeholder=\"0.00\"\n                          data-testid=\"input-service-charge\"\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n              )}\n\n              <FormField\n                control={form.control}\n                name=\"receiptPath\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Upload Receipt (Optional)</FormLabel>\n                    <FormDescription>\n                      Upload a photo of your receipt (max 5MB)\n                    </FormDescription>\n                    <div className=\"space-y-4\">\n                      {!receiptPreview ? (\n                        <div className=\"flex gap-2\">\n                          <input\n                            ref={fileInputRef}\n                            type=\"file\"\n                            accept=\"image/*\"\n                            onChange={handleFileUpload}\n                            className=\"hidden\"\n                            data-testid=\"input-file-upload\"\n                          />\n                          <input\n                            ref={cameraInputRef}\n                            type=\"file\"\n                            accept=\"image/*\"\n                            capture=\"environment\"\n                            onChange={handleFileUpload}\n                            className=\"hidden\"\n                            data-testid=\"input-camera-capture\"\n                          />\n                          <Button\n                            type=\"button\"\n                            variant=\"outline\"\n                            onClick={() => fileInputRef.current?.click()}\n                            className=\"flex-1\"\n                            data-testid=\"button-choose-file\"\n                          >\n                            <Upload className=\"mr-2 h-4 w-4\" />\n                            Choose File\n                          </Button>\n                          <Button\n                            type=\"button\"\n                            variant=\"outline\"\n                            onClick={() => cameraInputRef.current?.click()}\n                            className=\"flex-1\"\n                            data-testid=\"button-take-photo\"\n                          >\n                            <Camera className=\"mr-2 h-4 w-4\" />\n                            Take Photo\n                          </Button>\n                        </div>\n                      ) : (\n                        <div className=\"space-y-2\">\n                          <div className=\"relative border rounded-md p-2 bg-muted\">\n                            <img\n                              src={receiptPreview}\n                              alt=\"Receipt preview\"\n                              className=\"max-h-64 mx-auto rounded\"\n                              data-testid=\"img-receipt-preview\"\n                            />\n                            <Button\n                              type=\"button\"\n                              variant=\"destructive\"\n                              size=\"icon\"\n                              className=\"absolute top-2 right-2\"\n                              onClick={removeReceipt}\n                              data-testid=\"button-remove-receipt\"\n                            >\n                              <X className=\"h-4 w-4\" />\n                            </Button>\n                          </div>\n                        </div>\n                      )}\n                    </div>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <div className=\"flex gap-3\">\n                <Button\n                  type=\"submit\"\n                  disabled={createExpenseMutation.isPending}\n                  data-testid=\"button-submit\"\n                  className=\"flex-1\"\n                >\n                  {createExpenseMutation.isPending && (\n                    <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                  )}\n                  Submit Expense Request\n                </Button>\n                <Button\n                  type=\"button\"\n                  variant=\"outline\"\n                  onClick={() => {\n                    form.reset();\n                    setSelectedExpenseType(\"\");\n                  }}\n                  data-testid=\"button-reset\"\n                >\n                  Reset\n                </Button>\n              </div>\n            </form>\n          </Form>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":19344},"client/src/pages/admin/automated-billing.tsx":{"content":"import { useState } from \"react\";\nimport { useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Alert, AlertDescription, AlertTitle } from \"@/components/ui/alert\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Calendar, CheckCircle2, XCircle, AlertCircle, Loader2 } from \"lucide-react\";\n\ninterface BillingResult {\n  success: number;\n  failed: number;\n  skipped: number;\n  message: string;\n  details?: Array<{\n    residentId: string;\n    status: 'success' | 'failed' | 'skipped';\n    reason?: string;\n  }>;\n}\n\nexport default function AutomatedBillingPage() {\n  const [lastResult, setLastResult] = useState<BillingResult | null>(null);\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  const generateBillsMutation = useMutation({\n    mutationFn: async (): Promise<BillingResult> => {\n      const response = await apiRequest(\"POST\", \"/api/admin/billing/generate-service-charges\");\n      const data = await response.json();\n      return data as BillingResult;\n    },\n    onSuccess: (data) => {\n      setLastResult(data);\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/stats\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/residents\"] });\n      \n      toast({\n        title: \"Billing Generation Complete\",\n        description: data.message,\n        variant: data.failed > 0 ? \"default\" : \"default\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to generate automated bills\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleGenerateBills = () => {\n    if (generateBillsMutation.isPending) return;\n    \n    if (confirm(\"This will generate service charge bills for all eligible residents. Continue?\")) {\n      generateBillsMutation.mutate();\n    }\n  };\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div>\n        <h1 className=\"text-3xl font-bold\">Automated Billing</h1>\n        <p className=\"text-muted-foreground mt-1\">\n          Generate recurring service charge bills for registered residents\n        </p>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Calendar className=\"w-5 h-5\" />\n            Service Charge Billing\n          </CardTitle>\n          <CardDescription>\n            This tool automatically generates 12-month service charge bills for all eligible residents.\n            Bills are created based on each resident's registration start date and billing cycle.\n          </CardDescription>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <Alert>\n            <AlertCircle className=\"h-4 w-4\" />\n            <AlertTitle>How it works</AlertTitle>\n            <AlertDescription className=\"space-y-2 mt-2\">\n              <ul className=\"list-disc pl-5 space-y-1 text-sm\">\n                <li>First bill: Generated from registration start date to 12 months later</li>\n                <li>Subsequent bills: Generated from previous bill end date to 12 months later</li>\n                <li>Each bill automatically creates a journal entry (Debit: AR, Credit: Estate Management Fund)</li>\n                <li>In-app notifications are sent to residents</li>\n                <li>Residents with no service charge amount or without registration dates are skipped</li>\n                <li>Only active residents are eligible for automated billing</li>\n              </ul>\n            </AlertDescription>\n          </Alert>\n\n          <div className=\"flex items-center gap-4\">\n            <Button\n              onClick={handleGenerateBills}\n              disabled={generateBillsMutation.isPending}\n              size=\"lg\"\n              data-testid=\"button-generate-bills\"\n            >\n              {generateBillsMutation.isPending ? (\n                <>\n                  <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n                  Generating Bills...\n                </>\n              ) : (\n                <>\n                  <Calendar className=\"w-4 h-4 mr-2\" />\n                  Generate Service Charge Bills\n                </>\n              )}\n            </Button>\n          </div>\n\n          {lastResult && (\n            <div className=\"mt-6 space-y-3\">\n              <h3 className=\"font-semibold text-lg\">Last Generation Result</h3>\n              \n              <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                <Card className=\"bg-green-50 dark:bg-green-950/20 border-green-200 dark:border-green-900\">\n                  <CardContent className=\"pt-6\">\n                    <div className=\"flex items-center gap-3\">\n                      <CheckCircle2 className=\"w-8 h-8 text-green-600 dark:text-green-400\" />\n                      <div>\n                        <p className=\"text-2xl font-bold text-green-700 dark:text-green-300\" data-testid=\"text-success-count\">\n                          {lastResult.success}\n                        </p>\n                        <p className=\"text-sm text-green-600 dark:text-green-400\">Bills Generated</p>\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n\n                <Card className=\"bg-yellow-50 dark:bg-yellow-950/20 border-yellow-200 dark:border-yellow-900\">\n                  <CardContent className=\"pt-6\">\n                    <div className=\"flex items-center gap-3\">\n                      <AlertCircle className=\"w-8 h-8 text-yellow-600 dark:text-yellow-400\" />\n                      <div>\n                        <p className=\"text-2xl font-bold text-yellow-700 dark:text-yellow-300\" data-testid=\"text-skipped-count\">\n                          {lastResult.skipped}\n                        </p>\n                        <p className=\"text-sm text-yellow-600 dark:text-yellow-400\">Skipped</p>\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n\n                <Card className=\"bg-red-50 dark:bg-red-950/20 border-red-200 dark:border-red-900\">\n                  <CardContent className=\"pt-6\">\n                    <div className=\"flex items-center gap-3\">\n                      <XCircle className=\"w-8 h-8 text-red-600 dark:text-red-400\" />\n                      <div>\n                        <p className=\"text-2xl font-bold text-red-700 dark:text-red-300\" data-testid=\"text-failed-count\">\n                          {lastResult.failed}\n                        </p>\n                        <p className=\"text-sm text-red-600 dark:text-red-400\">Failed</p>\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n              </div>\n\n              <Alert>\n                <AlertDescription className=\"text-sm\">\n                  {lastResult.message}\n                </AlertDescription>\n              </Alert>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Requirements</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <p className=\"text-sm text-muted-foreground mb-3\">\n            The following accounts must exist in the Chart of Accounts for automated billing to work:\n          </p>\n          <ul className=\"list-disc pl-5 space-y-1 text-sm\">\n            <li>\n              <strong>Accounts Receivable (AR)</strong> - Asset account type\n            </li>\n            <li>\n              <strong>Estate Management Fund</strong> - Liability account type\n            </li>\n          </ul>\n          <p className=\"text-sm text-muted-foreground mt-3\">\n            If these accounts do not exist, billing generation will fail. Please create them in the Chart of Accounts page.\n          </p>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":7990},"client/src/pages/accountant/budget-planning.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from \"@/components/ui/dialog\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n} from \"@/components/ui/alert-dialog\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Plus, Eye, Play, X, Trash2, TrendingUp } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { format } from \"date-fns\";\nimport type { Account } from \"@shared/schema\";\n\ntype BudgetStatus = \"draft\" | \"active\" | \"closed\";\ntype PeriodType = \"monthly\" | \"quarterly\" | \"annual\";\n\ninterface Budget {\n  id: string;\n  name: string;\n  description: string | null;\n  fiscalYear: number;\n  periodType: PeriodType;\n  startDate: Date;\n  endDate: Date;\n  status: BudgetStatus;\n  totalBudgetAmount: string;\n  totalConsumedAmount: string;\n  totalRemainingAmount: string;\n  projectedCollections: string;\n  actualCollections: string;\n  createdBy: string;\n  creatorName?: string;\n  createdAt: Date;\n  updatedAt: Date;\n}\n\ninterface BudgetLine {\n  id?: string;\n  accountId: string;\n  accountNumber?: string;\n  accountName?: string;\n  accountType?: string;\n  allocatedAmount: string;\n  consumedAmount?: string;\n  remainingAmount?: string;\n  notes?: string;\n}\n\ninterface BudgetWithLines extends Budget {\n  budgetLines: BudgetLine[];\n}\n\nconst statusBadgeVariants: Record<BudgetStatus, string> = {\n  draft: \"bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-200\",\n  active: \"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200\",\n  closed: \"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200\",\n};\n\nconst periodTypeLabels: Record<PeriodType, string> = {\n  monthly: \"Monthly\",\n  quarterly: \"Quarterly\",\n  annual: \"Annual\",\n};\n\nexport default function BudgetPlanning() {\n  const { toast } = useToast();\n  const [createDialogOpen, setCreateDialogOpen] = useState(false);\n  const [viewDialogOpen, setViewDialogOpen] = useState(false);\n  const [activateDialogOpen, setActivateDialogOpen] = useState(false);\n  const [closeDialogOpen, setCloseDialogOpen] = useState(false);\n  const [deleteDialogOpen, setDeleteDialogOpen] = useState(false);\n  const [selectedBudget, setSelectedBudget] = useState<Budget | null>(null);\n  const [selectedBudgetWithLines, setSelectedBudgetWithLines] = useState<BudgetWithLines | null>(null);\n  \n  const [formData, setFormData] = useState({\n    name: \"\",\n    description: \"\",\n    fiscalYear: new Date().getFullYear(),\n    periodType: \"annual\" as PeriodType,\n    startDate: \"\",\n    endDate: \"\",\n    projectedCollections: \"\",\n  });\n\n  const [budgetLines, setBudgetLines] = useState<BudgetLine[]>([]);\n  const [newLine, setNewLine] = useState({\n    accountId: \"\",\n    allocatedAmount: \"\",\n    notes: \"\",\n  });\n\n  const { data: budgets, isLoading } = useQuery<Budget[]>({\n    queryKey: ['/api/accountant/budgets'],\n  });\n\n  const { data: accounts } = useQuery<Account[]>({\n    queryKey: ['/api/accountant/accounts'],\n  });\n\n  const createMutation = useMutation({\n    mutationFn: async (data: { budget: any; lines: BudgetLine[] }) => {\n      return await apiRequest('POST', '/api/accountant/budgets', data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/accountant/budgets'] });\n      setCreateDialogOpen(false);\n      resetForm();\n      toast({\n        title: \"Budget created\",\n        description: \"The budget has been created successfully\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Failed to create budget\",\n        description: error.message || \"An error occurred\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const activateMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return await apiRequest('POST', `/api/accountant/budgets/${id}/activate`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/accountant/budgets'] });\n      setActivateDialogOpen(false);\n      setSelectedBudget(null);\n      toast({\n        title: \"Budget activated\",\n        description: \"The budget is now active\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Failed to activate budget\",\n        description: error.message || \"An error occurred\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const closeMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return await apiRequest('POST', `/api/accountant/budgets/${id}/close`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/accountant/budgets'] });\n      setCloseDialogOpen(false);\n      setSelectedBudget(null);\n      toast({\n        title: \"Budget closed\",\n        description: \"The budget has been closed\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Failed to close budget\",\n        description: error.message || \"An error occurred\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return await apiRequest('DELETE', `/api/accountant/budgets/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/accountant/budgets'] });\n      setDeleteDialogOpen(false);\n      setSelectedBudget(null);\n      toast({\n        title: \"Budget deleted\",\n        description: \"The budget has been deleted\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Failed to delete budget\",\n        description: error.message || \"An error occurred\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const resetForm = () => {\n    setFormData({\n      name: \"\",\n      description: \"\",\n      fiscalYear: new Date().getFullYear(),\n      periodType: \"annual\",\n      startDate: \"\",\n      endDate: \"\",\n      projectedCollections: \"\",\n    });\n    setBudgetLines([]);\n    setNewLine({\n      accountId: \"\",\n      allocatedAmount: \"\",\n      notes: \"\",\n    });\n  };\n\n  const addBudgetLine = () => {\n    if (!newLine.accountId || !newLine.allocatedAmount) {\n      toast({\n        title: \"Missing information\",\n        description: \"Please select an account and enter an amount\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    const account = accounts?.find(a => a.id === newLine.accountId);\n    if (!account) return;\n\n    setBudgetLines([\n      ...budgetLines,\n      {\n        accountId: newLine.accountId,\n        accountNumber: account.accountNumber,\n        accountName: account.accountName,\n        accountType: account.accountType,\n        allocatedAmount: parseFloat(newLine.allocatedAmount).toFixed(2),\n        notes: newLine.notes,\n      },\n    ]);\n\n    setNewLine({\n      accountId: \"\",\n      allocatedAmount: \"\",\n      notes: \"\",\n    });\n  };\n\n  const removeBudgetLine = (index: number) => {\n    setBudgetLines(budgetLines.filter((_, i) => i !== index));\n  };\n\n  const handleCreateBudget = () => {\n    // Validate required fields\n    if (!formData.name || !formData.startDate || !formData.endDate) {\n      toast({\n        title: \"Missing information\",\n        description: \"Please fill in Budget Name, Start Date, and End Date\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    \n    // Check if we have budget lines\n    if (budgetLines.length === 0) {\n      // Check if user has filled in line details but forgot to click \"Add Line\"\n      if (newLine.accountId && newLine.allocatedAmount) {\n        toast({\n          title: \"Don't forget to add the budget line\",\n          description: \"Click the 'Add Line' button to add your budget line before creating the budget\",\n          variant: \"destructive\",\n        });\n      } else {\n        toast({\n          title: \"Missing budget lines\",\n          description: \"Please add at least one budget line (select an account, enter an amount, and click 'Add Line')\",\n          variant: \"destructive\",\n        });\n      }\n      return;\n    }\n\n    const budgetData = {\n      name: formData.name,\n      description: formData.description || null,\n      fiscalYear: formData.fiscalYear,\n      periodType: formData.periodType,\n      startDate: new Date(formData.startDate),\n      endDate: new Date(formData.endDate),\n      status: \"draft\" as const,\n      projectedCollections: formData.projectedCollections || \"0\",\n    };\n\n    createMutation.mutate({ budget: budgetData, lines: budgetLines });\n  };\n\n  const handleViewBudget = async (budget: Budget) => {\n    try {\n      const budgetWithLines = await queryClient.fetchQuery<BudgetWithLines>({\n        queryKey: ['/api/accountant/budgets', budget.id],\n      });\n      setSelectedBudgetWithLines(budgetWithLines);\n      setViewDialogOpen(true);\n    } catch (error) {\n      toast({\n        title: \"Failed to load budget details\",\n        description: \"An error occurred while loading the budget\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const totalBudgetAmount = budgetLines.reduce((sum, line) => sum + parseFloat(line.allocatedAmount), 0);\n\n  // Calculate active budget summary\n  const activeBudgets = budgets?.filter(b => b.status === 'active') || [];\n  const totalActiveBudget = activeBudgets.reduce((sum, b) => sum + parseFloat(b.totalBudgetAmount), 0);\n  const totalActiveConsumed = activeBudgets.reduce((sum, b) => sum + parseFloat(b.totalConsumedAmount), 0);\n  const totalActiveRemaining = activeBudgets.reduce((sum, b) => sum + parseFloat(b.totalRemainingAmount), 0);\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center h-full\">\n        <p className=\"text-muted-foreground\">Loading budgets...</p>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6 p-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-bold\">Budget & Planning</h1>\n          <p className=\"text-muted-foreground\">Create and manage budget projections for the estate</p>\n        </div>\n        <Dialog open={createDialogOpen} onOpenChange={setCreateDialogOpen}>\n          <DialogTrigger asChild>\n            <Button data-testid=\"button-create-budget\">\n              <Plus className=\"h-4 w-4 mr-2\" />\n              Create Budget\n            </Button>\n          </DialogTrigger>\n          <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-y-auto\">\n            <DialogHeader>\n              <DialogTitle>Create New Budget</DialogTitle>\n              <DialogDescription>\n                Set up a new budget plan with account allocations\n              </DialogDescription>\n            </DialogHeader>\n            <div className=\"space-y-4 py-4\">\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"name\">Budget Name *</Label>\n                  <Input\n                    id=\"name\"\n                    data-testid=\"input-budget-name\"\n                    placeholder=\"e.g., 2025 Annual Budget\"\n                    value={formData.name}\n                    onChange={(e) => setFormData({ ...formData, name: e.target.value })}\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"fiscalYear\">Fiscal Year</Label>\n                  <Input\n                    id=\"fiscalYear\"\n                    type=\"number\"\n                    data-testid=\"input-fiscal-year\"\n                    value={formData.fiscalYear}\n                    onChange={(e) => setFormData({ ...formData, fiscalYear: parseInt(e.target.value) })}\n                  />\n                </div>\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"description\">Description</Label>\n                <Textarea\n                  id=\"description\"\n                  data-testid=\"input-budget-description\"\n                  placeholder=\"Optional description of this budget\"\n                  value={formData.description}\n                  onChange={(e) => setFormData({ ...formData, description: e.target.value })}\n                />\n              </div>\n\n              <div className=\"grid grid-cols-3 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"periodType\">Period Type</Label>\n                  <Select\n                    value={formData.periodType}\n                    onValueChange={(value) => setFormData({ ...formData, periodType: value as PeriodType })}\n                  >\n                    <SelectTrigger data-testid=\"select-period-type\">\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"monthly\">Monthly</SelectItem>\n                      <SelectItem value=\"quarterly\">Quarterly</SelectItem>\n                      <SelectItem value=\"annual\">Annual</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"startDate\">Start Date *</Label>\n                  <Input\n                    id=\"startDate\"\n                    type=\"date\"\n                    data-testid=\"input-start-date\"\n                    value={formData.startDate}\n                    onChange={(e) => setFormData({ ...formData, startDate: e.target.value })}\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"endDate\">End Date *</Label>\n                  <Input\n                    id=\"endDate\"\n                    type=\"date\"\n                    data-testid=\"input-end-date\"\n                    value={formData.endDate}\n                    onChange={(e) => setFormData({ ...formData, endDate: e.target.value })}\n                  />\n                </div>\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"projectedCollections\">Projected Collections (₦)</Label>\n                <Input\n                  id=\"projectedCollections\"\n                  type=\"number\"\n                  step=\"0.01\"\n                  data-testid=\"input-projected-collections\"\n                  placeholder=\"0.00\"\n                  value={formData.projectedCollections}\n                  onChange={(e) => setFormData({ ...formData, projectedCollections: e.target.value })}\n                />\n              </div>\n\n              <div className=\"border-t pt-4 space-y-4\">\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <h3 className=\"text-lg font-semibold\">Budget Line Items</h3>\n                    <p className=\"text-sm text-muted-foreground\">\n                      {budgetLines.length > 0 \n                        ? `${budgetLines.length} line${budgetLines.length > 1 ? 's' : ''} added` \n                        : \"Add accounts and allocate budget amounts\"}\n                    </p>\n                  </div>\n                  {budgetLines.length > 0 && (\n                    <Badge variant=\"secondary\" className=\"font-mono\">\n                      Total: ₦{budgetLines.reduce((sum, line) => sum + parseFloat(line.allocatedAmount), 0).toLocaleString('en-NG', {\n                        minimumFractionDigits: 2,\n                        maximumFractionDigits: 2,\n                      })}\n                    </Badge>\n                  )}\n                </div>\n                \n                <div className=\"grid grid-cols-12 gap-2 items-end\">\n                  <div className=\"col-span-5\">\n                    <Label>Account</Label>\n                    <Select\n                      value={newLine.accountId}\n                      onValueChange={(value) => setNewLine({ ...newLine, accountId: value })}\n                    >\n                      <SelectTrigger data-testid=\"select-account\">\n                        <SelectValue placeholder=\"Select account\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        {accounts\n                          ?.filter(a => a.accountType === \"expense\")\n                          .map((account) => (\n                            <SelectItem key={account.id} value={account.id}>\n                              {account.accountNumber} - {account.accountName}\n                            </SelectItem>\n                          ))}\n                      </SelectContent>\n                    </Select>\n                  </div>\n                  <div className=\"col-span-2\">\n                    <Label>Amount (₦)</Label>\n                    <Input\n                      type=\"number\"\n                      step=\"0.01\"\n                      data-testid=\"input-line-amount\"\n                      placeholder=\"0.00\"\n                      value={newLine.allocatedAmount}\n                      onChange={(e) => setNewLine({ ...newLine, allocatedAmount: e.target.value })}\n                    />\n                  </div>\n                  <div className=\"col-span-3\">\n                    <Label>Notes</Label>\n                    <Input\n                      data-testid=\"input-line-notes\"\n                      placeholder=\"Optional\"\n                      value={newLine.notes}\n                      onChange={(e) => setNewLine({ ...newLine, notes: e.target.value })}\n                    />\n                  </div>\n                  <div className=\"col-span-2\">\n                    <Button\n                      type=\"button\"\n                      className=\"w-full\"\n                      data-testid=\"button-add-line\"\n                      onClick={addBudgetLine}\n                    >\n                      <Plus className=\"h-4 w-4 mr-2\" />\n                      Add Line\n                    </Button>\n                  </div>\n                </div>\n\n                {budgetLines.length > 0 && (\n                  <div className=\"border rounded-md\">\n                    <Table>\n                      <TableHeader>\n                        <TableRow>\n                          <TableHead>Account</TableHead>\n                          <TableHead className=\"text-right\">Amount (₦)</TableHead>\n                          <TableHead>Notes</TableHead>\n                          <TableHead className=\"w-[50px]\"></TableHead>\n                        </TableRow>\n                      </TableHeader>\n                      <TableBody>\n                        {budgetLines.map((line, index) => (\n                          <TableRow key={index}>\n                            <TableCell>\n                              {line.accountNumber} - {line.accountName}\n                            </TableCell>\n                            <TableCell className=\"text-right font-mono\">\n                              {parseFloat(line.allocatedAmount).toLocaleString('en-NG', {\n                                minimumFractionDigits: 2,\n                                maximumFractionDigits: 2,\n                              })}\n                            </TableCell>\n                            <TableCell className=\"text-sm text-muted-foreground\">\n                              {line.notes || \"-\"}\n                            </TableCell>\n                            <TableCell>\n                              <Button\n                                variant=\"ghost\"\n                                size=\"icon\"\n                                onClick={() => removeBudgetLine(index)}\n                              >\n                                <X className=\"h-4 w-4\" />\n                              </Button>\n                            </TableCell>\n                          </TableRow>\n                        ))}\n                        <TableRow className=\"font-semibold\">\n                          <TableCell>Total Budget</TableCell>\n                          <TableCell className=\"text-right font-mono\">\n                            ₦{totalBudgetAmount.toLocaleString('en-NG', {\n                              minimumFractionDigits: 2,\n                              maximumFractionDigits: 2,\n                            })}\n                          </TableCell>\n                          <TableCell colSpan={2}></TableCell>\n                        </TableRow>\n                      </TableBody>\n                    </Table>\n                  </div>\n                )}\n              </div>\n            </div>\n            <DialogFooter>\n              <Button\n                variant=\"outline\"\n                onClick={() => {\n                  setCreateDialogOpen(false);\n                  resetForm();\n                }}\n                data-testid=\"button-cancel-create\"\n              >\n                Cancel\n              </Button>\n              <Button\n                onClick={handleCreateBudget}\n                disabled={createMutation.isPending}\n                data-testid=\"button-submit-budget\"\n              >\n                {createMutation.isPending ? \"Creating...\" : \"Create Budget\"}\n              </Button>\n            </DialogFooter>\n          </DialogContent>\n        </Dialog>\n      </div>\n\n      {/* Active Budget Summary */}\n      {activeBudgets.length > 0 && (\n        <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n          <Card>\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">Total Active Budget</CardTitle>\n              <TrendingUp className=\"h-4 w-4 text-muted-foreground\" />\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\">\n                ₦{totalActiveBudget.toLocaleString('en-NG', {\n                  minimumFractionDigits: 2,\n                  maximumFractionDigits: 2,\n                })}\n              </div>\n              <p className=\"text-xs text-muted-foreground mt-1\">\n                Across {activeBudgets.length} active budget{activeBudgets.length !== 1 ? 's' : ''}\n              </p>\n            </CardContent>\n          </Card>\n          <Card>\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">Consumed Amount</CardTitle>\n              <TrendingUp className=\"h-4 w-4 text-muted-foreground\" />\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\">\n                ₦{totalActiveConsumed.toLocaleString('en-NG', {\n                  minimumFractionDigits: 2,\n                  maximumFractionDigits: 2,\n                })}\n              </div>\n              <p className=\"text-xs text-muted-foreground mt-1\">\n                {((totalActiveConsumed / totalActiveBudget) * 100).toFixed(1)}% of total budget\n              </p>\n            </CardContent>\n          </Card>\n          <Card>\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">Remaining Budget</CardTitle>\n              <TrendingUp className=\"h-4 w-4 text-muted-foreground\" />\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\">\n                ₦{totalActiveRemaining.toLocaleString('en-NG', {\n                  minimumFractionDigits: 2,\n                  maximumFractionDigits: 2,\n                })}\n              </div>\n              <p className=\"text-xs text-muted-foreground mt-1\">\n                Available for spending\n              </p>\n            </CardContent>\n          </Card>\n        </div>\n      )}\n\n      {/* Budgets Table */}\n      <Card>\n        <CardHeader>\n          <CardTitle>All Budgets</CardTitle>\n          <CardDescription>View and manage budget projections</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <Table>\n            <TableHeader>\n              <TableRow>\n                <TableHead>Budget Name</TableHead>\n                <TableHead>Fiscal Year</TableHead>\n                <TableHead>Period</TableHead>\n                <TableHead>Date Range</TableHead>\n                <TableHead className=\"text-right\">Total Budget</TableHead>\n                <TableHead className=\"text-right\">Consumed</TableHead>\n                <TableHead className=\"text-right\">Remaining</TableHead>\n                <TableHead>Status</TableHead>\n                <TableHead className=\"text-right\">Actions</TableHead>\n              </TableRow>\n            </TableHeader>\n            <TableBody>\n              {budgets?.length === 0 ? (\n                <TableRow>\n                  <TableCell colSpan={9} className=\"text-center text-muted-foreground\">\n                    No budgets created yet\n                  </TableCell>\n                </TableRow>\n              ) : (\n                budgets?.map((budget) => (\n                  <TableRow key={budget.id}>\n                    <TableCell className=\"font-medium\" data-testid={`text-budget-name-${budget.id}`}>\n                      {budget.name}\n                    </TableCell>\n                    <TableCell>{budget.fiscalYear}</TableCell>\n                    <TableCell>{periodTypeLabels[budget.periodType]}</TableCell>\n                    <TableCell className=\"text-sm\">\n                      {format(new Date(budget.startDate), 'MMM d, yyyy')} - {format(new Date(budget.endDate), 'MMM d, yyyy')}\n                    </TableCell>\n                    <TableCell className=\"text-right font-mono\">\n                      ₦{parseFloat(budget.totalBudgetAmount).toLocaleString('en-NG', {\n                        minimumFractionDigits: 2,\n                        maximumFractionDigits: 2,\n                      })}\n                    </TableCell>\n                    <TableCell className=\"text-right font-mono\">\n                      ₦{parseFloat(budget.totalConsumedAmount).toLocaleString('en-NG', {\n                        minimumFractionDigits: 2,\n                        maximumFractionDigits: 2,\n                      })}\n                    </TableCell>\n                    <TableCell className=\"text-right font-mono\">\n                      ₦{parseFloat(budget.totalRemainingAmount).toLocaleString('en-NG', {\n                        minimumFractionDigits: 2,\n                        maximumFractionDigits: 2,\n                      })}\n                    </TableCell>\n                    <TableCell>\n                      <Badge className={statusBadgeVariants[budget.status]} data-testid={`badge-status-${budget.id}`}>\n                        {budget.status}\n                      </Badge>\n                    </TableCell>\n                    <TableCell className=\"text-right\">\n                      <div className=\"flex justify-end gap-1\">\n                        <Button\n                          variant=\"ghost\"\n                          size=\"icon\"\n                          onClick={() => handleViewBudget(budget)}\n                          data-testid={`button-view-${budget.id}`}\n                        >\n                          <Eye className=\"h-4 w-4\" />\n                        </Button>\n                        {budget.status === 'draft' && (\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            onClick={() => {\n                              setSelectedBudget(budget);\n                              setActivateDialogOpen(true);\n                            }}\n                            data-testid={`button-activate-${budget.id}`}\n                          >\n                            <Play className=\"h-4 w-4\" />\n                          </Button>\n                        )}\n                        {budget.status === 'active' && (\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            onClick={() => {\n                              setSelectedBudget(budget);\n                              setCloseDialogOpen(true);\n                            }}\n                            data-testid={`button-close-${budget.id}`}\n                          >\n                            <X className=\"h-4 w-4\" />\n                          </Button>\n                        )}\n                        {budget.status === 'draft' && (\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            onClick={() => {\n                              setSelectedBudget(budget);\n                              setDeleteDialogOpen(true);\n                            }}\n                            data-testid={`button-delete-${budget.id}`}\n                          >\n                            <Trash2 className=\"h-4 w-4\" />\n                          </Button>\n                        )}\n                      </div>\n                    </TableCell>\n                  </TableRow>\n                ))\n              )}\n            </TableBody>\n          </Table>\n        </CardContent>\n      </Card>\n\n      {/* View Budget Dialog */}\n      <Dialog open={viewDialogOpen} onOpenChange={setViewDialogOpen}>\n        <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle>{selectedBudgetWithLines?.name}</DialogTitle>\n            <DialogDescription>\n              Budget details and line items\n            </DialogDescription>\n          </DialogHeader>\n          {selectedBudgetWithLines && (\n            <div className=\"space-y-4 py-4\">\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Fiscal Year</p>\n                  <p className=\"font-medium\">{selectedBudgetWithLines.fiscalYear}</p>\n                </div>\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Period Type</p>\n                  <p className=\"font-medium\">{periodTypeLabels[selectedBudgetWithLines.periodType]}</p>\n                </div>\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Start Date</p>\n                  <p className=\"font-medium\">{format(new Date(selectedBudgetWithLines.startDate), 'MMM d, yyyy')}</p>\n                </div>\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">End Date</p>\n                  <p className=\"font-medium\">{format(new Date(selectedBudgetWithLines.endDate), 'MMM d, yyyy')}</p>\n                </div>\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Status</p>\n                  <Badge className={statusBadgeVariants[selectedBudgetWithLines.status]}>\n                    {selectedBudgetWithLines.status}\n                  </Badge>\n                </div>\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Created By</p>\n                  <p className=\"font-medium\">{selectedBudgetWithLines.creatorName || \"Unknown\"}</p>\n                </div>\n              </div>\n\n              {selectedBudgetWithLines.description && (\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Description</p>\n                  <p className=\"font-medium\">{selectedBudgetWithLines.description}</p>\n                </div>\n              )}\n\n              <div className=\"grid grid-cols-3 gap-4\">\n                <Card>\n                  <CardHeader className=\"pb-2\">\n                    <CardTitle className=\"text-sm font-medium\">Total Budget</CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <p className=\"text-2xl font-bold\">\n                      ₦{parseFloat(selectedBudgetWithLines.totalBudgetAmount).toLocaleString('en-NG', {\n                        minimumFractionDigits: 2,\n                        maximumFractionDigits: 2,\n                      })}\n                    </p>\n                  </CardContent>\n                </Card>\n                <Card>\n                  <CardHeader className=\"pb-2\">\n                    <CardTitle className=\"text-sm font-medium\">Consumed</CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <p className=\"text-2xl font-bold\">\n                      ₦{parseFloat(selectedBudgetWithLines.totalConsumedAmount).toLocaleString('en-NG', {\n                        minimumFractionDigits: 2,\n                        maximumFractionDigits: 2,\n                      })}\n                    </p>\n                  </CardContent>\n                </Card>\n                <Card>\n                  <CardHeader className=\"pb-2\">\n                    <CardTitle className=\"text-sm font-medium\">Remaining</CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <p className=\"text-2xl font-bold\">\n                      ₦{parseFloat(selectedBudgetWithLines.totalRemainingAmount).toLocaleString('en-NG', {\n                        minimumFractionDigits: 2,\n                        maximumFractionDigits: 2,\n                      })}\n                    </p>\n                  </CardContent>\n                </Card>\n              </div>\n\n              <div className=\"border-t pt-4\">\n                <h3 className=\"text-lg font-semibold mb-4\">Budget Line Items</h3>\n                <Table>\n                  <TableHeader>\n                    <TableRow>\n                      <TableHead>Account</TableHead>\n                      <TableHead className=\"text-right\">Allocated</TableHead>\n                      <TableHead className=\"text-right\">Consumed</TableHead>\n                      <TableHead className=\"text-right\">Remaining</TableHead>\n                      <TableHead className=\"text-right\">% Used</TableHead>\n                      <TableHead>Notes</TableHead>\n                    </TableRow>\n                  </TableHeader>\n                  <TableBody>\n                    {selectedBudgetWithLines.budgetLines.map((line) => {\n                      const percentUsed = (parseFloat(line.consumedAmount || '0') / parseFloat(line.allocatedAmount)) * 100;\n                      return (\n                        <TableRow key={line.id}>\n                          <TableCell>\n                            <div>\n                              <p className=\"font-medium\">{line.accountNumber} - {line.accountName}</p>\n                              <p className=\"text-sm text-muted-foreground\">{line.accountType}</p>\n                            </div>\n                          </TableCell>\n                          <TableCell className=\"text-right font-mono\">\n                            ₦{parseFloat(line.allocatedAmount).toLocaleString('en-NG', {\n                              minimumFractionDigits: 2,\n                              maximumFractionDigits: 2,\n                            })}\n                          </TableCell>\n                          <TableCell className=\"text-right font-mono\">\n                            ₦{parseFloat(line.consumedAmount || '0').toLocaleString('en-NG', {\n                              minimumFractionDigits: 2,\n                              maximumFractionDigits: 2,\n                            })}\n                          </TableCell>\n                          <TableCell className=\"text-right font-mono\">\n                            ₦{parseFloat(line.remainingAmount || line.allocatedAmount).toLocaleString('en-NG', {\n                              minimumFractionDigits: 2,\n                              maximumFractionDigits: 2,\n                            })}\n                          </TableCell>\n                          <TableCell className=\"text-right\">\n                            <span className={percentUsed > 90 ? \"text-red-600 font-semibold\" : \"\"}>\n                              {percentUsed.toFixed(1)}%\n                            </span>\n                          </TableCell>\n                          <TableCell className=\"text-sm text-muted-foreground\">\n                            {line.notes || \"-\"}\n                          </TableCell>\n                        </TableRow>\n                      );\n                    })}\n                  </TableBody>\n                </Table>\n              </div>\n            </div>\n          )}\n        </DialogContent>\n      </Dialog>\n\n      {/* Activate Budget Dialog */}\n      <AlertDialog open={activateDialogOpen} onOpenChange={setActivateDialogOpen}>\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>Activate Budget</AlertDialogTitle>\n            <AlertDialogDescription>\n              Are you sure you want to activate \"{selectedBudget?.name}\"? This will make the budget active and ready to track expenses.\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel data-testid=\"button-cancel-activate\">Cancel</AlertDialogCancel>\n            <AlertDialogAction\n              onClick={() => selectedBudget && activateMutation.mutate(selectedBudget.id)}\n              data-testid=\"button-confirm-activate\"\n            >\n              Activate\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n\n      {/* Close Budget Dialog */}\n      <AlertDialog open={closeDialogOpen} onOpenChange={setCloseDialogOpen}>\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>Close Budget</AlertDialogTitle>\n            <AlertDialogDescription>\n              Are you sure you want to close \"{selectedBudget?.name}\"? This will prevent further expense tracking against this budget.\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel data-testid=\"button-cancel-close\">Cancel</AlertDialogCancel>\n            <AlertDialogAction\n              onClick={() => selectedBudget && closeMutation.mutate(selectedBudget.id)}\n              data-testid=\"button-confirm-close\"\n            >\n              Close Budget\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n\n      {/* Delete Budget Dialog */}\n      <AlertDialog open={deleteDialogOpen} onOpenChange={setDeleteDialogOpen}>\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>Delete Budget</AlertDialogTitle>\n            <AlertDialogDescription>\n              Are you sure you want to delete \"{selectedBudget?.name}\"? This action cannot be undone.\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel data-testid=\"button-cancel-delete\">Cancel</AlertDialogCancel>\n            <AlertDialogAction\n              onClick={() => selectedBudget && deleteMutation.mutate(selectedBudget.id)}\n              className=\"bg-destructive text-destructive-foreground hover-elevate active-elevate-2\"\n              data-testid=\"button-confirm-delete\"\n            >\n              Delete\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n    </div>\n  );\n}\n","size_bytes":39766},"client/src/pages/accountant/vendor-management.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useLocation } from \"wouter\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { \n  Edit, \n  FileText, \n  DollarSign, \n  Ban,\n  Search,\n} from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport type { Vendor } from \"@shared/schema\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\n\nexport default function VendorManagement() {\n  const [, navigate] = useLocation();\n  const { toast } = useToast();\n  const [searchTerm, setSearchTerm] = useState(\"\");\n  const [editDialogOpen, setEditDialogOpen] = useState(false);\n  const [deactivateDialogOpen, setDeactivateDialogOpen] = useState(false);\n  const [payBillDialogOpen, setPayBillDialogOpen] = useState(false);\n  const [selectedVendor, setSelectedVendor] = useState<Vendor | null>(null);\n  const [editFormData, setEditFormData] = useState({\n    name: \"\",\n    tinNumber: \"\",\n    email: \"\",\n    phoneNumber: \"\",\n    address: \"\",\n    contactPerson: \"\",\n    bankName: \"\",\n    bankAccountNumber: \"\",\n    bankAccountName: \"\",\n    notes: \"\",\n  });\n  const [deactivateReason, setDeactivateReason] = useState(\"\");\n\n  const { data: vendors, isLoading } = useQuery<Vendor[]>({\n    queryKey: [\"/api/accountant/vendors\"],\n  });\n\n  const { data: outstandingBills } = useQuery<Record<string, number>>({\n    queryKey: [\"/api/accountant/vendors/outstanding-bills\"],\n  });\n\n  const updateVendorMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: any }) => {\n      return apiRequest(\"PATCH\", `/api/accountant/vendors/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/accountant/vendors\"] });\n      toast({\n        title: \"Success\",\n        description: \"Vendor updated successfully\",\n      });\n      setEditDialogOpen(false);\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to update vendor\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const deactivateVendorMutation = useMutation({\n    mutationFn: async ({ id, reason }: { id: string; reason: string }) => {\n      return apiRequest(\"POST\", `/api/accountant/vendors/${id}/reject`, { reason });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/accountant/vendors\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/accountant/vendors/outstanding-bills\"] });\n      toast({\n        title: \"Success\",\n        description: \"Vendor deactivated successfully\",\n      });\n      setDeactivateDialogOpen(false);\n      setDeactivateReason(\"\");\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to deactivate vendor\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleEditClick = (vendor: Vendor) => {\n    setSelectedVendor(vendor);\n    setEditFormData({\n      name: vendor.name,\n      tinNumber: vendor.tinNumber,\n      email: vendor.email || \"\",\n      phoneNumber: vendor.phoneNumber || \"\",\n      address: vendor.address || \"\",\n      contactPerson: vendor.contactPerson || \"\",\n      bankName: vendor.bankName || \"\",\n      bankAccountNumber: vendor.bankAccountNumber || \"\",\n      bankAccountName: vendor.bankAccountName || \"\",\n      notes: vendor.notes || \"\",\n    });\n    setEditDialogOpen(true);\n  };\n\n  const handleViewStatement = (vendor: Vendor) => {\n    navigate(`/accountant/vendor-statement?vendorId=${vendor.id}`);\n  };\n\n  const handlePayBillClick = (vendor: Vendor) => {\n    setSelectedVendor(vendor);\n    setPayBillDialogOpen(true);\n  };\n\n  const handleDeactivateClick = (vendor: Vendor) => {\n    setSelectedVendor(vendor);\n    setDeactivateDialogOpen(true);\n  };\n\n  const handleEditSubmit = () => {\n    if (!selectedVendor) return;\n    updateVendorMutation.mutate({\n      id: selectedVendor.id,\n      data: editFormData,\n    });\n  };\n\n  const handleDeactivateSubmit = () => {\n    if (!selectedVendor) return;\n    if (!deactivateReason.trim()) {\n      toast({\n        title: \"Error\",\n        description: \"Please provide a reason for deactivation\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    deactivateVendorMutation.mutate({\n      id: selectedVendor.id,\n      reason: deactivateReason,\n    });\n  };\n\n  const handlePayBill = () => {\n    if (!selectedVendor) return;\n    navigate(`/accountant/expense-request?vendorId=${selectedVendor.id}&action=pay`);\n    setPayBillDialogOpen(false);\n  };\n\n  const formatCurrency = (amount: number) => {\n    return new Intl.NumberFormat(\"en-NG\", {\n      style: \"currency\",\n      currency: \"NGN\",\n    }).format(amount);\n  };\n\n  const filteredVendors = vendors?.filter((vendor) => {\n    const search = searchTerm.toLowerCase();\n    return (\n      vendor.name.toLowerCase().includes(search) ||\n      vendor.tinNumber.toLowerCase().includes(search) ||\n      vendor.email?.toLowerCase().includes(search) ||\n      vendor.phoneNumber?.toLowerCase().includes(search)\n    );\n  });\n\n  const approvedVendors = filteredVendors?.filter(v => v.status === \"approved\");\n\n  return (\n    <div className=\"container mx-auto p-6 max-w-7xl\">\n      <div className=\"mb-6\">\n        <h1 className=\"text-3xl font-bold\" data-testid=\"text-title\">Vendor Management</h1>\n        <p className=\"text-muted-foreground\">Manage vendor accounts and payments</p>\n      </div>\n\n      <Card className=\"mb-6\">\n        <CardHeader>\n          <CardTitle>Search Vendors</CardTitle>\n          <CardDescription>Filter vendors by name, TIN, email, or phone</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"flex gap-2\">\n            <div className=\"relative flex-1\">\n              <Search className=\"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground\" />\n              <Input\n                placeholder=\"Search vendors...\"\n                value={searchTerm}\n                onChange={(e) => setSearchTerm(e.target.value)}\n                className=\"pl-9\"\n                data-testid=\"input-search\"\n              />\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      <Card>\n        <CardHeader>\n          <div className=\"flex justify-between items-center flex-wrap gap-2\">\n            <div>\n              <CardTitle>Registered Vendors</CardTitle>\n              <CardDescription>\n                {approvedVendors?.length || 0} approved vendor{approvedVendors?.length !== 1 ? 's' : ''}\n              </CardDescription>\n            </div>\n          </div>\n        </CardHeader>\n        <CardContent>\n          {isLoading ? (\n            <div className=\"text-center py-8\">Loading vendors...</div>\n          ) : approvedVendors?.length === 0 ? (\n            <div className=\"text-center py-8 text-muted-foreground\">\n              No approved vendors found\n            </div>\n          ) : (\n            <div className=\"overflow-x-auto\">\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead>Name</TableHead>\n                    <TableHead>TIN</TableHead>\n                    <TableHead>Contact</TableHead>\n                    <TableHead>Bank Details</TableHead>\n                    <TableHead>Status</TableHead>\n                    <TableHead>Outstanding</TableHead>\n                    <TableHead className=\"text-right\">Actions</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {approvedVendors?.map((vendor) => (\n                    <TableRow key={vendor.id} data-testid={`row-vendor-${vendor.id}`}>\n                      <TableCell className=\"font-medium\">\n                        <div>\n                          <div data-testid={`text-vendor-name-${vendor.id}`}>{vendor.name}</div>\n                          {vendor.contactPerson && (\n                            <div className=\"text-sm text-muted-foreground\">\n                              Contact: {vendor.contactPerson}\n                            </div>\n                          )}\n                        </div>\n                      </TableCell>\n                      <TableCell data-testid={`text-vendor-tin-${vendor.id}`}>\n                        {vendor.tinNumber}\n                      </TableCell>\n                      <TableCell>\n                        <div className=\"text-sm\">\n                          {vendor.email && <div>{vendor.email}</div>}\n                          {vendor.phoneNumber && <div>{vendor.phoneNumber}</div>}\n                        </div>\n                      </TableCell>\n                      <TableCell>\n                        {vendor.bankName ? (\n                          <div className=\"text-sm\">\n                            <div>{vendor.bankName}</div>\n                            {vendor.bankAccountNumber && (\n                              <div className=\"text-muted-foreground\">\n                                {vendor.bankAccountNumber}\n                              </div>\n                            )}\n                          </div>\n                        ) : (\n                          <span className=\"text-muted-foreground text-sm\">-</span>\n                        )}\n                      </TableCell>\n                      <TableCell>\n                        <Badge\n                          variant={\n                            vendor.status === \"approved\"\n                              ? \"default\"\n                              : vendor.status === \"pending\"\n                              ? \"secondary\"\n                              : \"destructive\"\n                          }\n                          data-testid={`badge-status-${vendor.id}`}\n                        >\n                          {vendor.status}\n                        </Badge>\n                      </TableCell>\n                      <TableCell data-testid={`text-outstanding-${vendor.id}`}>\n                        {outstandingBills?.[vendor.id] ? (\n                          <span className=\"font-medium text-destructive\">\n                            {formatCurrency(outstandingBills[vendor.id])}\n                          </span>\n                        ) : (\n                          <span className=\"text-muted-foreground\">₦0.00</span>\n                        )}\n                      </TableCell>\n                      <TableCell>\n                        <div className=\"flex justify-end gap-2 flex-wrap\">\n                          <Button\n                            variant=\"outline\"\n                            size=\"sm\"\n                            onClick={() => handleEditClick(vendor)}\n                            data-testid={`button-edit-${vendor.id}`}\n                          >\n                            <Edit className=\"h-4 w-4 mr-1\" />\n                            Edit\n                          </Button>\n                          <Button\n                            variant=\"outline\"\n                            size=\"sm\"\n                            onClick={() => handleViewStatement(vendor)}\n                            data-testid={`button-statement-${vendor.id}`}\n                          >\n                            <FileText className=\"h-4 w-4 mr-1\" />\n                            Statement\n                          </Button>\n                          {outstandingBills?.[vendor.id] ? (\n                            <Button\n                              variant=\"outline\"\n                              size=\"sm\"\n                              onClick={() => handlePayBillClick(vendor)}\n                              data-testid={`button-pay-${vendor.id}`}\n                            >\n                              <DollarSign className=\"h-4 w-4 mr-1\" />\n                              Pay Bill\n                            </Button>\n                          ) : null}\n                          <Button\n                            variant=\"destructive\"\n                            size=\"sm\"\n                            onClick={() => handleDeactivateClick(vendor)}\n                            data-testid={`button-deactivate-${vendor.id}`}\n                          >\n                            <Ban className=\"h-4 w-4 mr-1\" />\n                            Deactivate\n                          </Button>\n                        </div>\n                      </TableCell>\n                    </TableRow>\n                  ))}\n                </TableBody>\n              </Table>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Edit Vendor Dialog */}\n      <Dialog open={editDialogOpen} onOpenChange={setEditDialogOpen}>\n        <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle>Edit Vendor</DialogTitle>\n            <DialogDescription>\n              Update vendor information\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"grid gap-4 py-4\">\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div>\n                <Label htmlFor=\"edit-name\">Name *</Label>\n                <Input\n                  id=\"edit-name\"\n                  value={editFormData.name}\n                  onChange={(e) => setEditFormData({ ...editFormData, name: e.target.value })}\n                  data-testid=\"input-edit-name\"\n                />\n              </div>\n              <div>\n                <Label htmlFor=\"edit-tin\">TIN Number *</Label>\n                <Input\n                  id=\"edit-tin\"\n                  value={editFormData.tinNumber}\n                  onChange={(e) => setEditFormData({ ...editFormData, tinNumber: e.target.value })}\n                  data-testid=\"input-edit-tin\"\n                />\n              </div>\n            </div>\n\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div>\n                <Label htmlFor=\"edit-email\">Email</Label>\n                <Input\n                  id=\"edit-email\"\n                  type=\"email\"\n                  value={editFormData.email}\n                  onChange={(e) => setEditFormData({ ...editFormData, email: e.target.value })}\n                  data-testid=\"input-edit-email\"\n                />\n              </div>\n              <div>\n                <Label htmlFor=\"edit-phone\">Phone Number</Label>\n                <Input\n                  id=\"edit-phone\"\n                  value={editFormData.phoneNumber}\n                  onChange={(e) => setEditFormData({ ...editFormData, phoneNumber: e.target.value })}\n                  data-testid=\"input-edit-phone\"\n                />\n              </div>\n            </div>\n\n            <div>\n              <Label htmlFor=\"edit-address\">Address</Label>\n              <Textarea\n                id=\"edit-address\"\n                value={editFormData.address}\n                onChange={(e) => setEditFormData({ ...editFormData, address: e.target.value })}\n                data-testid=\"input-edit-address\"\n              />\n            </div>\n\n            <div>\n              <Label htmlFor=\"edit-contact-person\">Contact Person</Label>\n              <Input\n                id=\"edit-contact-person\"\n                value={editFormData.contactPerson}\n                onChange={(e) => setEditFormData({ ...editFormData, contactPerson: e.target.value })}\n                data-testid=\"input-edit-contact-person\"\n              />\n            </div>\n\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div>\n                <Label htmlFor=\"edit-bank-name\">Bank Name</Label>\n                <Input\n                  id=\"edit-bank-name\"\n                  value={editFormData.bankName}\n                  onChange={(e) => setEditFormData({ ...editFormData, bankName: e.target.value })}\n                  data-testid=\"input-edit-bank-name\"\n                />\n              </div>\n              <div>\n                <Label htmlFor=\"edit-account-number\">Account Number</Label>\n                <Input\n                  id=\"edit-account-number\"\n                  value={editFormData.bankAccountNumber}\n                  onChange={(e) => setEditFormData({ ...editFormData, bankAccountNumber: e.target.value })}\n                  data-testid=\"input-edit-account-number\"\n                />\n              </div>\n            </div>\n\n            <div>\n              <Label htmlFor=\"edit-account-name\">Account Name</Label>\n              <Input\n                id=\"edit-account-name\"\n                value={editFormData.bankAccountName}\n                onChange={(e) => setEditFormData({ ...editFormData, bankAccountName: e.target.value })}\n                data-testid=\"input-edit-account-name\"\n              />\n            </div>\n\n            <div>\n              <Label htmlFor=\"edit-notes\">Notes</Label>\n              <Textarea\n                id=\"edit-notes\"\n                value={editFormData.notes}\n                onChange={(e) => setEditFormData({ ...editFormData, notes: e.target.value })}\n                data-testid=\"input-edit-notes\"\n              />\n            </div>\n          </div>\n          <DialogFooter>\n            <Button\n              variant=\"outline\"\n              onClick={() => setEditDialogOpen(false)}\n              data-testid=\"button-cancel-edit\"\n            >\n              Cancel\n            </Button>\n            <Button\n              onClick={handleEditSubmit}\n              disabled={updateVendorMutation.isPending}\n              data-testid=\"button-save-edit\"\n            >\n              {updateVendorMutation.isPending ? \"Saving...\" : \"Save Changes\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Deactivate Vendor Dialog */}\n      <Dialog open={deactivateDialogOpen} onOpenChange={setDeactivateDialogOpen}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Deactivate Vendor</DialogTitle>\n            <DialogDescription>\n              Are you sure you want to deactivate {selectedVendor?.name}?\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"py-4\">\n            <Label htmlFor=\"deactivate-reason\">Reason for Deactivation *</Label>\n            <Textarea\n              id=\"deactivate-reason\"\n              placeholder=\"Enter reason for deactivation...\"\n              value={deactivateReason}\n              onChange={(e) => setDeactivateReason(e.target.value)}\n              className=\"mt-2\"\n              data-testid=\"input-deactivate-reason\"\n            />\n          </div>\n          <DialogFooter>\n            <Button\n              variant=\"outline\"\n              onClick={() => {\n                setDeactivateDialogOpen(false);\n                setDeactivateReason(\"\");\n              }}\n              data-testid=\"button-cancel-deactivate\"\n            >\n              Cancel\n            </Button>\n            <Button\n              variant=\"destructive\"\n              onClick={handleDeactivateSubmit}\n              disabled={deactivateVendorMutation.isPending}\n              data-testid=\"button-confirm-deactivate\"\n            >\n              {deactivateVendorMutation.isPending ? \"Deactivating...\" : \"Deactivate\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Pay Bill Dialog */}\n      <Dialog open={payBillDialogOpen} onOpenChange={setPayBillDialogOpen}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Pay Outstanding Bill</DialogTitle>\n            <DialogDescription>\n              Process payment for {selectedVendor?.name}\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"py-4\">\n            <div className=\"space-y-4\">\n              <div>\n                <Label>Outstanding Amount</Label>\n                <div className=\"text-2xl font-bold text-destructive\" data-testid=\"text-outstanding-amount\">\n                  {selectedVendor && outstandingBills?.[selectedVendor.id]\n                    ? formatCurrency(outstandingBills[selectedVendor.id])\n                    : \"₦0.00\"}\n                </div>\n              </div>\n              <p className=\"text-sm text-muted-foreground\">\n                You will be redirected to create an expense request to pay this vendor's outstanding bills.\n              </p>\n            </div>\n          </div>\n          <DialogFooter>\n            <Button\n              variant=\"outline\"\n              onClick={() => setPayBillDialogOpen(false)}\n              data-testid=\"button-cancel-pay\"\n            >\n              Cancel\n            </Button>\n            <Button\n              onClick={handlePayBill}\n              data-testid=\"button-proceed-pay\"\n            >\n              Proceed to Payment\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","size_bytes":21219},"client/src/pages/accountant/accounts-payable.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Loader2, Eye, CreditCard, Clock, XCircle, FileText } from \"lucide-react\";\n\ninterface Expense {\n  id: string;\n  vendorId: string;\n  vendorName: string;\n  vendorBankName: string;\n  vendorBankAccountNumber: string;\n  vendorBankAccountName: string;\n  accountId: string;\n  accountNumber: string;\n  accountName: string;\n  expenseType: string;\n  description: string;\n  expenseAmount: string;\n  serviceCharge: string | null;\n  receiptPath: string | null;\n  status: string;\n  paymentStatus: string;\n  whtRate: string | null;\n  whtAmount: string | null;\n  netPayment: string | null;\n  paidDate: string | null;\n  paidFromAccountId: string | null;\n  reviewedBy: string;\n  reviewedAt: string;\n  createdAt: string;\n  submittedBy: string;\n  submitterName: string;\n}\n\ninterface BankAccount {\n  id: string;\n  accountNumber: string;\n  accountName: string;\n  accountType: string;\n  balance: string;\n}\n\nexport default function AccountsPayable() {\n  const { toast } = useToast();\n  const [selectedExpense, setSelectedExpense] = useState<Expense | null>(null);\n  const [showPayNowDialog, setShowPayNowDialog] = useState(false);\n  const [showPayLaterDialog, setShowPayLaterDialog] = useState(false);\n  const [showDeclineDialog, setShowDeclineDialog] = useState(false);\n  const [showViewDialog, setShowViewDialog] = useState(false);\n  const [showReceiptDialog, setShowReceiptDialog] = useState(false);\n  const [receiptToView, setReceiptToView] = useState<string>(\"\");\n  \n  const [selectedBankAccount, setSelectedBankAccount] = useState(\"\");\n  const [whtRate, setWhtRate] = useState(\"5.00\");\n  const [declineReason, setDeclineReason] = useState(\"\");\n\n  // Fetch approved expenses\n  const { data: expenses = [], isLoading } = useQuery<Expense[]>({\n    queryKey: ['/api/accountant/accounts-payable'],\n  });\n\n  // Fetch bank accounts\n  const { data: bankAccounts = [] } = useQuery<BankAccount[]>({\n    queryKey: ['/api/accountant/bank-accounts'],\n  });\n\n  // Pay now mutation\n  const payNowMutation = useMutation({\n    mutationFn: async (data: { id: string; paidFromAccountId: string; whtRate: string }) => {\n      return await apiRequest('POST', `/api/accountant/accounts-payable/${data.id}/pay-now`, {\n        paidFromAccountId: data.paidFromAccountId,\n        whtRate: data.whtRate\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/accountant/accounts-payable'] });\n      toast({\n        title: \"Payment Processed\",\n        description: \"The expense has been paid and posted to the general ledger\",\n      });\n      setShowPayNowDialog(false);\n      setSelectedExpense(null);\n      setSelectedBankAccount(\"\");\n      setWhtRate(\"5.00\");\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Payment Failed\",\n        description: error.message || \"Failed to process payment\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Pay later mutation\n  const payLaterMutation = useMutation({\n    mutationFn: async (data: { id: string; whtRate: string }) => {\n      return await apiRequest('POST', `/api/accountant/accounts-payable/${data.id}/pay-later`, {\n        whtRate: data.whtRate\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/accountant/accounts-payable'] });\n      toast({\n        title: \"Approved for Payment\",\n        description: \"The expense has been approved for payment later\",\n      });\n      setShowPayLaterDialog(false);\n      setSelectedExpense(null);\n      setWhtRate(\"5.00\");\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Approval Failed\",\n        description: error.message || \"Failed to approve for payment\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Decline mutation\n  const declineMutation = useMutation({\n    mutationFn: async (data: { id: string; reason: string }) => {\n      return await apiRequest('POST', `/api/accountant/expenses/${data.id}/reject`, {\n        reason: data.reason\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/accountant/accounts-payable'] });\n      toast({\n        title: \"Expense Declined\",\n        description: \"The expense has been rejected\",\n      });\n      setShowDeclineDialog(false);\n      setSelectedExpense(null);\n      setDeclineReason(\"\");\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Decline Failed\",\n        description: error.message || \"Failed to decline expense\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const calculatePaymentDetails = (expense: Expense, whtRateValue: string) => {\n    const expenseAmount = parseFloat(expense.expenseAmount);\n    const serviceCharge = parseFloat(expense.serviceCharge || '0');\n    const whtRateNum = parseFloat(whtRateValue);\n    const whtAmount = (serviceCharge * whtRateNum) / 100;\n    const totalAmount = expenseAmount + serviceCharge;\n    const netPayment = totalAmount - whtAmount;\n\n    return {\n      expenseAmount,\n      serviceCharge,\n      whtAmount,\n      totalAmount,\n      netPayment,\n    };\n  };\n\n  const handlePayNow = () => {\n    if (!selectedExpense || !selectedBankAccount || !whtRate) {\n      toast({\n        title: \"Validation Error\",\n        description: \"Please select a bank account and enter WHT rate\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    payNowMutation.mutate({\n      id: selectedExpense.id,\n      paidFromAccountId: selectedBankAccount,\n      whtRate,\n    });\n  };\n\n  const handlePayLater = () => {\n    if (!selectedExpense || !whtRate) {\n      toast({\n        title: \"Validation Error\",\n        description: \"Please enter WHT rate\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    payLaterMutation.mutate({\n      id: selectedExpense.id,\n      whtRate,\n    });\n  };\n\n  const handleDecline = () => {\n    if (!selectedExpense || !declineReason.trim()) {\n      toast({\n        title: \"Validation Error\",\n        description: \"Please enter a decline reason\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    declineMutation.mutate({\n      id: selectedExpense.id,\n      reason: declineReason,\n    });\n  };\n\n  const getPaymentStatusBadge = (status: string) => {\n    switch (status) {\n      case 'paid':\n        return <Badge variant=\"default\" data-testid={`badge-payment-status-paid`}>Paid</Badge>;\n      case 'approved_for_payment':\n        return <Badge variant=\"secondary\" data-testid={`badge-payment-status-approved`}>Approved for Payment</Badge>;\n      default:\n        return <Badge variant=\"outline\" data-testid={`badge-payment-status-unpaid`}>Unpaid</Badge>;\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center h-full\">\n        <Loader2 className=\"h-8 w-8 animate-spin\" data-testid=\"loader-accounts-payable\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div>\n        <h1 className=\"text-3xl font-bold\" data-testid=\"heading-accounts-payable\">Accounts Payable</h1>\n        <p className=\"text-muted-foreground\" data-testid=\"text-description\">\n          Manage and process payments for approved expenses\n        </p>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle data-testid=\"heading-approved-expenses\">Approved Expenses</CardTitle>\n          <CardDescription data-testid=\"text-card-description\">\n            View and process approved expenses for payment\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          {expenses.length === 0 ? (\n            <div className=\"text-center py-8 text-muted-foreground\" data-testid=\"text-no-expenses\">\n              No approved expenses for payment\n            </div>\n          ) : (\n            <div className=\"overflow-x-auto\">\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead data-testid=\"th-vendor\">Vendor</TableHead>\n                    <TableHead data-testid=\"th-description\">Description</TableHead>\n                    <TableHead data-testid=\"th-type\">Type</TableHead>\n                    <TableHead data-testid=\"th-expense-amount\">Expense Amount</TableHead>\n                    <TableHead data-testid=\"th-service-charge\">Service Charge</TableHead>\n                    <TableHead data-testid=\"th-total\">Total</TableHead>\n                    <TableHead data-testid=\"th-payment-status\">Payment Status</TableHead>\n                    <TableHead data-testid=\"th-actions\">Actions</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {expenses.map((expense) => {\n                    const totalAmount = parseFloat(expense.expenseAmount) + parseFloat(expense.serviceCharge || '0');\n                    return (\n                      <TableRow key={expense.id} data-testid={`row-expense-${expense.id}`}>\n                        <TableCell data-testid={`cell-vendor-${expense.id}`}>{expense.vendorName || 'N/A'}</TableCell>\n                        <TableCell data-testid={`cell-description-${expense.id}`} className=\"max-w-xs truncate\">\n                          {expense.description}\n                        </TableCell>\n                        <TableCell data-testid={`cell-type-${expense.id}`}>{expense.expenseType}</TableCell>\n                        <TableCell data-testid={`cell-expense-amount-${expense.id}`}>\n                          ₦{parseFloat(expense.expenseAmount).toLocaleString('en-NG', { minimumFractionDigits: 2 })}\n                        </TableCell>\n                        <TableCell data-testid={`cell-service-charge-${expense.id}`}>\n                          {expense.serviceCharge ? `₦${parseFloat(expense.serviceCharge).toLocaleString('en-NG', { minimumFractionDigits: 2 })}` : 'N/A'}\n                        </TableCell>\n                        <TableCell data-testid={`cell-total-${expense.id}`} className=\"font-semibold\">\n                          ₦{totalAmount.toLocaleString('en-NG', { minimumFractionDigits: 2 })}\n                        </TableCell>\n                        <TableCell data-testid={`cell-payment-status-${expense.id}`}>\n                          {getPaymentStatusBadge(expense.paymentStatus)}\n                        </TableCell>\n                        <TableCell data-testid={`cell-actions-${expense.id}`}>\n                          <div className=\"flex gap-2\">\n                            <Button\n                              size=\"sm\"\n                              variant=\"outline\"\n                              onClick={() => {\n                                setSelectedExpense(expense);\n                                setShowViewDialog(true);\n                              }}\n                              data-testid={`button-view-${expense.id}`}\n                            >\n                              <Eye className=\"h-4 w-4 mr-1\" />\n                              View\n                            </Button>\n                            {expense.paymentStatus === 'unpaid' && (\n                              <>\n                                <Button\n                                  size=\"sm\"\n                                  onClick={() => {\n                                    setSelectedExpense(expense);\n                                    setWhtRate(\"5.00\");\n                                    setShowPayNowDialog(true);\n                                  }}\n                                  data-testid={`button-pay-now-${expense.id}`}\n                                >\n                                  <CreditCard className=\"h-4 w-4 mr-1\" />\n                                  Pay Now\n                                </Button>\n                                <Button\n                                  size=\"sm\"\n                                  variant=\"secondary\"\n                                  onClick={() => {\n                                    setSelectedExpense(expense);\n                                    setWhtRate(\"5.00\");\n                                    setShowPayLaterDialog(true);\n                                  }}\n                                  data-testid={`button-pay-later-${expense.id}`}\n                                >\n                                  <Clock className=\"h-4 w-4 mr-1\" />\n                                  Pay Later\n                                </Button>\n                                <Button\n                                  size=\"sm\"\n                                  variant=\"destructive\"\n                                  onClick={() => {\n                                    setSelectedExpense(expense);\n                                    setShowDeclineDialog(true);\n                                  }}\n                                  data-testid={`button-decline-${expense.id}`}\n                                >\n                                  <XCircle className=\"h-4 w-4 mr-1\" />\n                                  Decline\n                                </Button>\n                              </>\n                            )}\n                          </div>\n                        </TableCell>\n                      </TableRow>\n                    );\n                  })}\n                </TableBody>\n              </Table>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* View Dialog */}\n      <Dialog open={showViewDialog} onOpenChange={setShowViewDialog}>\n        <DialogContent className=\"max-w-2xl\" data-testid=\"dialog-view-expense\">\n          <DialogHeader>\n            <DialogTitle data-testid=\"heading-expense-details\">Expense Details</DialogTitle>\n            <DialogDescription data-testid=\"text-dialog-description\">\n              Complete details of the selected expense\n            </DialogDescription>\n          </DialogHeader>\n          {selectedExpense && (\n            <div className=\"space-y-4\">\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <Label className=\"text-muted-foreground\">Vendor</Label>\n                  <p className=\"font-semibold\" data-testid=\"text-vendor-name\">{selectedExpense.vendorName || 'N/A'}</p>\n                </div>\n                <div>\n                  <Label className=\"text-muted-foreground\">Expense Type</Label>\n                  <p className=\"font-semibold\" data-testid=\"text-expense-type\">{selectedExpense.expenseType}</p>\n                </div>\n                <div>\n                  <Label className=\"text-muted-foreground\">Expense Amount</Label>\n                  <p className=\"font-semibold\" data-testid=\"text-expense-amount\">\n                    ₦{parseFloat(selectedExpense.expenseAmount).toLocaleString('en-NG', { minimumFractionDigits: 2 })}\n                  </p>\n                </div>\n                <div>\n                  <Label className=\"text-muted-foreground\">Service Charge</Label>\n                  <p className=\"font-semibold\" data-testid=\"text-service-charge\">\n                    {selectedExpense.serviceCharge ? `₦${parseFloat(selectedExpense.serviceCharge).toLocaleString('en-NG', { minimumFractionDigits: 2 })}` : 'N/A'}\n                  </p>\n                </div>\n                {selectedExpense.accountNumber && (\n                  <div>\n                    <Label className=\"text-muted-foreground\">Expense Classification</Label>\n                    <p className=\"font-semibold\" data-testid=\"text-account\">\n                      {selectedExpense.accountNumber} - {selectedExpense.accountName}\n                    </p>\n                  </div>\n                )}\n                <div>\n                  <Label className=\"text-muted-foreground\">Payment Status</Label>\n                  <div data-testid=\"text-payment-status\">{getPaymentStatusBadge(selectedExpense.paymentStatus)}</div>\n                </div>\n              </div>\n              <div>\n                <Label className=\"text-muted-foreground\">Description</Label>\n                <p className=\"text-sm\" data-testid=\"text-description-detail\">{selectedExpense.description}</p>\n              </div>\n              {selectedExpense.vendorBankName && (\n                <div className=\"border-t pt-4\">\n                  <h3 className=\"font-semibold mb-2\">Vendor Banking Details</h3>\n                  <div className=\"grid grid-cols-2 gap-4 text-sm\">\n                    <div>\n                      <Label className=\"text-muted-foreground\">Bank Name</Label>\n                      <p data-testid=\"text-bank-name\">{selectedExpense.vendorBankName}</p>\n                    </div>\n                    <div>\n                      <Label className=\"text-muted-foreground\">Account Number</Label>\n                      <p data-testid=\"text-account-number\">{selectedExpense.vendorBankAccountNumber}</p>\n                    </div>\n                    <div className=\"col-span-2\">\n                      <Label className=\"text-muted-foreground\">Account Name</Label>\n                      <p data-testid=\"text-account-name\">{selectedExpense.vendorBankAccountName}</p>\n                    </div>\n                  </div>\n                </div>\n              )}\n              {selectedExpense.receiptPath && (\n                <Button\n                  variant=\"outline\"\n                  onClick={() => {\n                    setReceiptToView(selectedExpense.receiptPath!);\n                    setShowReceiptDialog(true);\n                  }}\n                  data-testid=\"button-view-receipt\"\n                >\n                  <FileText className=\"h-4 w-4 mr-2\" />\n                  View Receipt\n                </Button>\n              )}\n            </div>\n          )}\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowViewDialog(false)} data-testid=\"button-close-view\">\n              Close\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Pay Now Dialog */}\n      <Dialog open={showPayNowDialog} onOpenChange={setShowPayNowDialog}>\n        <DialogContent data-testid=\"dialog-pay-now\">\n          <DialogHeader>\n            <DialogTitle data-testid=\"heading-pay-now\">Process Payment</DialogTitle>\n            <DialogDescription data-testid=\"text-pay-now-description\">\n              Select bank account and confirm payment details\n            </DialogDescription>\n          </DialogHeader>\n          {selectedExpense && (\n            <div className=\"space-y-4\">\n              <div className=\"grid grid-cols-2 gap-4 p-4 bg-muted rounded-md\">\n                <div>\n                  <Label className=\"text-muted-foreground\">Vendor</Label>\n                  <p className=\"font-semibold\" data-testid=\"text-pay-vendor\">{selectedExpense.vendorName}</p>\n                </div>\n                <div>\n                  <Label className=\"text-muted-foreground\">Description</Label>\n                  <p className=\"text-sm\" data-testid=\"text-pay-description\">{selectedExpense.description}</p>\n                </div>\n              </div>\n\n              <div>\n                <Label htmlFor=\"bank-account\">Pay from Bank Account *</Label>\n                <Select value={selectedBankAccount} onValueChange={setSelectedBankAccount}>\n                  <SelectTrigger data-testid=\"select-bank-account\">\n                    <SelectValue placeholder=\"Select bank account\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {bankAccounts.map((account) => (\n                      <SelectItem key={account.id} value={account.id} data-testid={`option-bank-${account.id}`}>\n                        {account.accountNumber} - {account.accountName} (Balance: ₦{parseFloat(account.balance).toLocaleString('en-NG')})\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n\n              <div>\n                <Label htmlFor=\"wht-rate\">WHT Rate (%) *</Label>\n                <Input\n                  id=\"wht-rate\"\n                  type=\"number\"\n                  step=\"0.01\"\n                  value={whtRate}\n                  onChange={(e) => setWhtRate(e.target.value)}\n                  data-testid=\"input-wht-rate\"\n                />\n                <p className=\"text-xs text-muted-foreground mt-1\">\n                  Withholding tax is calculated on the service charge only\n                </p>\n              </div>\n\n              {whtRate && (\n                <div className=\"border-t pt-4 space-y-2\">\n                  <h3 className=\"font-semibold\">Payment Summary</h3>\n                  {(() => {\n                    const details = calculatePaymentDetails(selectedExpense, whtRate);\n                    return (\n                      <div className=\"space-y-1 text-sm\">\n                        <div className=\"flex justify-between\">\n                          <span>Expense Amount:</span>\n                          <span data-testid=\"text-summary-expense\">₦{details.expenseAmount.toLocaleString('en-NG', { minimumFractionDigits: 2 })}</span>\n                        </div>\n                        <div className=\"flex justify-between\">\n                          <span>Service Charge:</span>\n                          <span data-testid=\"text-summary-service\">₦{details.serviceCharge.toLocaleString('en-NG', { minimumFractionDigits: 2 })}</span>\n                        </div>\n                        <div className=\"flex justify-between\">\n                          <span>Total Amount:</span>\n                          <span data-testid=\"text-summary-total\">₦{details.totalAmount.toLocaleString('en-NG', { minimumFractionDigits: 2 })}</span>\n                        </div>\n                        <div className=\"flex justify-between text-destructive\">\n                          <span>WHT ({whtRate}%):</span>\n                          <span data-testid=\"text-summary-wht\">-₦{details.whtAmount.toLocaleString('en-NG', { minimumFractionDigits: 2 })}</span>\n                        </div>\n                        <div className=\"flex justify-between font-semibold text-base border-t pt-2\">\n                          <span>Net Payment:</span>\n                          <span data-testid=\"text-summary-net\">₦{details.netPayment.toLocaleString('en-NG', { minimumFractionDigits: 2 })}</span>\n                        </div>\n                      </div>\n                    );\n                  })()}\n                </div>\n              )}\n            </div>\n          )}\n          <DialogFooter>\n            <Button\n              variant=\"outline\"\n              onClick={() => {\n                setShowPayNowDialog(false);\n                setSelectedBankAccount(\"\");\n                setWhtRate(\"5.00\");\n              }}\n              data-testid=\"button-cancel-pay\"\n            >\n              Cancel\n            </Button>\n            <Button\n              onClick={handlePayNow}\n              disabled={payNowMutation.isPending || !selectedBankAccount}\n              data-testid=\"button-confirm-pay\"\n            >\n              {payNowMutation.isPending && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\n              Confirm Payment\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Pay Later Dialog */}\n      <Dialog open={showPayLaterDialog} onOpenChange={setShowPayLaterDialog}>\n        <DialogContent data-testid=\"dialog-pay-later\">\n          <DialogHeader>\n            <DialogTitle data-testid=\"heading-pay-later\">Approve for Payment Later</DialogTitle>\n            <DialogDescription data-testid=\"text-pay-later-description\">\n              Set WHT rate and approve expense for future payment\n            </DialogDescription>\n          </DialogHeader>\n          {selectedExpense && (\n            <div className=\"space-y-4\">\n              <div className=\"grid grid-cols-2 gap-4 p-4 bg-muted rounded-md\">\n                <div>\n                  <Label className=\"text-muted-foreground\">Vendor</Label>\n                  <p className=\"font-semibold\" data-testid=\"text-later-vendor\">{selectedExpense.vendorName}</p>\n                </div>\n                <div>\n                  <Label className=\"text-muted-foreground\">Description</Label>\n                  <p className=\"text-sm\" data-testid=\"text-later-description\">{selectedExpense.description}</p>\n                </div>\n              </div>\n\n              <div>\n                <Label htmlFor=\"wht-rate-later\">WHT Rate (%) *</Label>\n                <Input\n                  id=\"wht-rate-later\"\n                  type=\"number\"\n                  step=\"0.01\"\n                  value={whtRate}\n                  onChange={(e) => setWhtRate(e.target.value)}\n                  data-testid=\"input-wht-rate-later\"\n                />\n                <p className=\"text-xs text-muted-foreground mt-1\">\n                  Withholding tax is calculated on the service charge only\n                </p>\n              </div>\n\n              {whtRate && (\n                <div className=\"border-t pt-4 space-y-2\">\n                  <h3 className=\"font-semibold\">Payment Summary (for future payment)</h3>\n                  {(() => {\n                    const details = calculatePaymentDetails(selectedExpense, whtRate);\n                    return (\n                      <div className=\"space-y-1 text-sm\">\n                        <div className=\"flex justify-between\">\n                          <span>Expense Amount:</span>\n                          <span data-testid=\"text-later-expense\">₦{details.expenseAmount.toLocaleString('en-NG', { minimumFractionDigits: 2 })}</span>\n                        </div>\n                        <div className=\"flex justify-between\">\n                          <span>Service Charge:</span>\n                          <span data-testid=\"text-later-service\">₦{details.serviceCharge.toLocaleString('en-NG', { minimumFractionDigits: 2 })}</span>\n                        </div>\n                        <div className=\"flex justify-between\">\n                          <span>Total Amount:</span>\n                          <span data-testid=\"text-later-total\">₦{details.totalAmount.toLocaleString('en-NG', { minimumFractionDigits: 2 })}</span>\n                        </div>\n                        <div className=\"flex justify-between text-destructive\">\n                          <span>WHT ({whtRate}%):</span>\n                          <span data-testid=\"text-later-wht\">-₦{details.whtAmount.toLocaleString('en-NG', { minimumFractionDigits: 2 })}</span>\n                        </div>\n                        <div className=\"flex justify-between font-semibold text-base border-t pt-2\">\n                          <span>Net Payment:</span>\n                          <span data-testid=\"text-later-net\">₦{details.netPayment.toLocaleString('en-NG', { minimumFractionDigits: 2 })}</span>\n                        </div>\n                      </div>\n                    );\n                  })()}\n                </div>\n              )}\n            </div>\n          )}\n          <DialogFooter>\n            <Button\n              variant=\"outline\"\n              onClick={() => {\n                setShowPayLaterDialog(false);\n                setWhtRate(\"5.00\");\n              }}\n              data-testid=\"button-cancel-later\"\n            >\n              Cancel\n            </Button>\n            <Button\n              onClick={handlePayLater}\n              disabled={payLaterMutation.isPending}\n              data-testid=\"button-confirm-later\"\n            >\n              {payLaterMutation.isPending && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\n              Approve for Payment\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Decline Dialog */}\n      <Dialog open={showDeclineDialog} onOpenChange={setShowDeclineDialog}>\n        <DialogContent data-testid=\"dialog-decline\">\n          <DialogHeader>\n            <DialogTitle data-testid=\"heading-decline\">Decline Expense</DialogTitle>\n            <DialogDescription data-testid=\"text-decline-description\">\n              Provide a reason for declining this expense\n            </DialogDescription>\n          </DialogHeader>\n          {selectedExpense && (\n            <div className=\"space-y-4\">\n              <div className=\"p-4 bg-muted rounded-md\">\n                <p className=\"font-semibold\" data-testid=\"text-decline-vendor\">\n                  {selectedExpense.vendorName} - {selectedExpense.description}\n                </p>\n                <p className=\"text-sm text-muted-foreground\" data-testid=\"text-decline-amount\">\n                  Amount: ₦{(parseFloat(selectedExpense.expenseAmount) + parseFloat(selectedExpense.serviceCharge || '0')).toLocaleString('en-NG', { minimumFractionDigits: 2 })}\n                </p>\n              </div>\n\n              <div>\n                <Label htmlFor=\"decline-reason\">Decline Reason *</Label>\n                <Textarea\n                  id=\"decline-reason\"\n                  placeholder=\"Enter reason for declining this expense...\"\n                  value={declineReason}\n                  onChange={(e) => setDeclineReason(e.target.value)}\n                  rows={4}\n                  data-testid=\"textarea-decline-reason\"\n                />\n              </div>\n            </div>\n          )}\n          <DialogFooter>\n            <Button\n              variant=\"outline\"\n              onClick={() => {\n                setShowDeclineDialog(false);\n                setDeclineReason(\"\");\n              }}\n              data-testid=\"button-cancel-decline\"\n            >\n              Cancel\n            </Button>\n            <Button\n              variant=\"destructive\"\n              onClick={handleDecline}\n              disabled={declineMutation.isPending || !declineReason.trim()}\n              data-testid=\"button-confirm-decline\"\n            >\n              {declineMutation.isPending && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\n              Decline Expense\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Receipt Dialog */}\n      <Dialog open={showReceiptDialog} onOpenChange={setShowReceiptDialog}>\n        <DialogContent className=\"max-w-3xl\" data-testid=\"dialog-receipt\">\n          <DialogHeader>\n            <DialogTitle data-testid=\"heading-receipt\">Receipt Image</DialogTitle>\n            <DialogDescription data-testid=\"text-receipt-description\">\n              View uploaded receipt\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"py-4\">\n            {receiptToView && (\n              <img\n                src={receiptToView}\n                alt=\"Receipt\"\n                className=\"w-full h-auto rounded-md border\"\n                data-testid=\"img-receipt-view\"\n              />\n            )}\n          </div>\n          <DialogFooter>\n            <Button\n              variant=\"outline\"\n              onClick={() => {\n                setShowReceiptDialog(false);\n                setReceiptToView(\"\");\n              }}\n              data-testid=\"button-close-receipt\"\n            >\n              Close\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","size_bytes":31979},"client/src/pages/accountant/accounts-receivable.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Loader2, Eye, CreditCard } from \"lucide-react\";\nimport { format } from \"date-fns\";\n\ninterface AREntry {\n  id: string;\n  residentId: string;\n  residentName: string;\n  unitNumber: string;\n  invoiceNumber: string;\n  description: string;\n  amount: string;\n  totalPaid: string;\n  balance: string;\n  paymentStatus: string;\n  status: string;\n  dueDate: string;\n  createdAt: string;\n}\n\nexport default function AccountsReceivable() {\n  const { toast } = useToast();\n  const [selectedEntry, setSelectedEntry] = useState<AREntry | null>(null);\n  const [showMarkPaidDialog, setShowMarkPaidDialog] = useState(false);\n  const [showViewDialog, setShowViewDialog] = useState(false);\n  \n  const [amountApplied, setAmountApplied] = useState(\"\");\n  const [bankName, setBankName] = useState(\"\");\n  const [accountNumber, setAccountNumber] = useState(\"\");\n  const [paymentDate, setPaymentDate] = useState(format(new Date(), \"yyyy-MM-dd\"));\n  const [notes, setNotes] = useState(\"\");\n\n  // Fetch AR entries\n  const { data: arEntries = [], isLoading } = useQuery<AREntry[]>({\n    queryKey: ['/api/accountant/accounts-receivable'],\n  });\n\n  // Mark as paid mutation\n  const markPaidMutation = useMutation({\n    mutationFn: async (data: { \n      id: string; \n      amountApplied: string; \n      bankName: string; \n      accountNumber: string; \n      paymentDate: string; \n      notes?: string; \n    }) => {\n      const { id, ...paymentData } = data;\n      return await apiRequest('POST', `/api/accountant/accounts-receivable/${id}/mark-paid`, paymentData);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/accountant/accounts-receivable'] });\n      toast({\n        title: \"Payment Applied\",\n        description: \"The payment has been applied and posted to the general ledger\",\n      });\n      setShowMarkPaidDialog(false);\n      resetForm();\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Payment Failed\",\n        description: error.message || \"Failed to apply payment\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const resetForm = () => {\n    setSelectedEntry(null);\n    setAmountApplied(\"\");\n    setBankName(\"\");\n    setAccountNumber(\"\");\n    setPaymentDate(format(new Date(), \"yyyy-MM-dd\"));\n    setNotes(\"\");\n  };\n\n  const handleMarkPaidClick = (entry: AREntry) => {\n    setSelectedEntry(entry);\n    setAmountApplied(entry.balance);\n    setShowMarkPaidDialog(true);\n  };\n\n  const handleMarkPaidSubmit = () => {\n    if (!selectedEntry) return;\n\n    if (!amountApplied || !bankName || !accountNumber || !paymentDate) {\n      toast({\n        title: \"Validation Error\",\n        description: \"Please fill in all required fields\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    const amount = parseFloat(amountApplied);\n    const balance = parseFloat(selectedEntry.balance);\n\n    if (amount <= 0 || amount > balance) {\n      toast({\n        title: \"Invalid Amount\",\n        description: `Amount must be between ₦0 and ₦${balance.toLocaleString()}`,\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    markPaidMutation.mutate({\n      id: selectedEntry.id,\n      amountApplied,\n      bankName,\n      accountNumber,\n      paymentDate,\n      notes,\n    });\n  };\n\n  const getPaymentStatusBadge = (status: string) => {\n    const statusConfig: Record<string, { label: string; variant: \"default\" | \"secondary\" | \"destructive\" | \"outline\" }> = {\n      unpaid: { label: \"Unpaid\", variant: \"destructive\" },\n      partial: { label: \"Partially Paid\", variant: \"secondary\" },\n      paid: { label: \"Paid\", variant: \"default\" },\n    };\n\n    const config = statusConfig[status] || { label: status, variant: \"outline\" };\n    return <Badge variant={config.variant} data-testid={`status-payment-${status}`}>{config.label}</Badge>;\n  };\n\n  const formatCurrency = (amount: string | number) => {\n    const numAmount = typeof amount === 'string' ? parseFloat(amount) : amount;\n    return `₦${numAmount.toLocaleString('en-NG', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center min-h-screen\">\n        <Loader2 className=\"h-8 w-8 animate-spin\" data-testid=\"loader-loading\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"container mx-auto py-6 space-y-6\">\n      <Card>\n        <CardHeader>\n          <CardTitle data-testid=\"text-page-title\">Accounts Receivable</CardTitle>\n          <CardDescription data-testid=\"text-page-description\">\n            Manage resident bills and track payments\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          {arEntries.length === 0 ? (\n            <div className=\"text-center py-8 text-muted-foreground\" data-testid=\"text-no-entries\">\n              No accounts receivable entries found\n            </div>\n          ) : (\n            <div className=\"rounded-md border\">\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead data-testid=\"header-invoice\">Invoice #</TableHead>\n                    <TableHead data-testid=\"header-resident\">Resident</TableHead>\n                    <TableHead data-testid=\"header-unit\">Unit</TableHead>\n                    <TableHead data-testid=\"header-description\">Description</TableHead>\n                    <TableHead data-testid=\"header-amount\">Amount</TableHead>\n                    <TableHead data-testid=\"header-paid\">Total Paid</TableHead>\n                    <TableHead data-testid=\"header-balance\">Balance</TableHead>\n                    <TableHead data-testid=\"header-status\">Status</TableHead>\n                    <TableHead data-testid=\"header-due-date\">Due Date</TableHead>\n                    <TableHead data-testid=\"header-actions\">Actions</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {arEntries.map((entry) => (\n                    <TableRow key={entry.id} data-testid={`row-entry-${entry.id}`}>\n                      <TableCell className=\"font-medium\" data-testid={`text-invoice-${entry.id}`}>\n                        {entry.invoiceNumber}\n                      </TableCell>\n                      <TableCell data-testid={`text-resident-${entry.id}`}>\n                        {entry.residentName}\n                      </TableCell>\n                      <TableCell data-testid={`text-unit-${entry.id}`}>\n                        {entry.unitNumber}\n                      </TableCell>\n                      <TableCell data-testid={`text-description-${entry.id}`}>\n                        {entry.description}\n                      </TableCell>\n                      <TableCell data-testid={`text-amount-${entry.id}`}>\n                        {formatCurrency(entry.amount)}\n                      </TableCell>\n                      <TableCell data-testid={`text-total-paid-${entry.id}`}>\n                        {formatCurrency(entry.totalPaid)}\n                      </TableCell>\n                      <TableCell className=\"font-semibold\" data-testid={`text-balance-${entry.id}`}>\n                        {formatCurrency(entry.balance)}\n                      </TableCell>\n                      <TableCell data-testid={`cell-status-${entry.id}`}>\n                        {getPaymentStatusBadge(entry.paymentStatus)}\n                      </TableCell>\n                      <TableCell data-testid={`text-due-date-${entry.id}`}>\n                        {format(new Date(entry.dueDate), \"MMM dd, yyyy\")}\n                      </TableCell>\n                      <TableCell>\n                        <div className=\"flex gap-2\">\n                          <Button\n                            size=\"sm\"\n                            variant=\"outline\"\n                            onClick={() => {\n                              setSelectedEntry(entry);\n                              setShowViewDialog(true);\n                            }}\n                            data-testid={`button-view-${entry.id}`}\n                          >\n                            <Eye className=\"h-4 w-4 mr-1\" />\n                            View\n                          </Button>\n                          {entry.paymentStatus !== \"paid\" && (\n                            <Button\n                              size=\"sm\"\n                              onClick={() => handleMarkPaidClick(entry)}\n                              data-testid={`button-mark-paid-${entry.id}`}\n                            >\n                              <CreditCard className=\"h-4 w-4 mr-1\" />\n                              Mark as Paid\n                            </Button>\n                          )}\n                        </div>\n                      </TableCell>\n                    </TableRow>\n                  ))}\n                </TableBody>\n              </Table>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* View Dialog */}\n      <Dialog open={showViewDialog} onOpenChange={setShowViewDialog}>\n        <DialogContent data-testid=\"dialog-view-entry\">\n          <DialogHeader>\n            <DialogTitle data-testid=\"text-dialog-title\">AR Entry Details</DialogTitle>\n            <DialogDescription data-testid=\"text-dialog-description\">\n              Full details of the accounts receivable entry\n            </DialogDescription>\n          </DialogHeader>\n          {selectedEntry && (\n            <div className=\"space-y-4\">\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <Label className=\"text-muted-foreground\">Invoice Number</Label>\n                  <p className=\"font-medium\" data-testid=\"text-detail-invoice\">{selectedEntry.invoiceNumber}</p>\n                </div>\n                <div>\n                  <Label className=\"text-muted-foreground\">Payment Status</Label>\n                  <div data-testid=\"badge-detail-status\">{getPaymentStatusBadge(selectedEntry.paymentStatus)}</div>\n                </div>\n                <div>\n                  <Label className=\"text-muted-foreground\">Resident</Label>\n                  <p className=\"font-medium\" data-testid=\"text-detail-resident\">{selectedEntry.residentName}</p>\n                </div>\n                <div>\n                  <Label className=\"text-muted-foreground\">Unit Number</Label>\n                  <p className=\"font-medium\" data-testid=\"text-detail-unit\">{selectedEntry.unitNumber}</p>\n                </div>\n                <div>\n                  <Label className=\"text-muted-foreground\">Bill Amount</Label>\n                  <p className=\"font-medium\" data-testid=\"text-detail-amount\">{formatCurrency(selectedEntry.amount)}</p>\n                </div>\n                <div>\n                  <Label className=\"text-muted-foreground\">Total Paid</Label>\n                  <p className=\"font-medium\" data-testid=\"text-detail-total-paid\">{formatCurrency(selectedEntry.totalPaid)}</p>\n                </div>\n                <div>\n                  <Label className=\"text-muted-foreground\">Balance Due</Label>\n                  <p className=\"font-semibold text-lg\" data-testid=\"text-detail-balance\">{formatCurrency(selectedEntry.balance)}</p>\n                </div>\n                <div>\n                  <Label className=\"text-muted-foreground\">Due Date</Label>\n                  <p className=\"font-medium\" data-testid=\"text-detail-due-date\">{format(new Date(selectedEntry.dueDate), \"MMM dd, yyyy\")}</p>\n                </div>\n              </div>\n              <div>\n                <Label className=\"text-muted-foreground\">Description</Label>\n                <p className=\"mt-1\" data-testid=\"text-detail-description\">{selectedEntry.description}</p>\n              </div>\n            </div>\n          )}\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowViewDialog(false)} data-testid=\"button-close-view\">\n              Close\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Mark as Paid Dialog */}\n      <Dialog open={showMarkPaidDialog} onOpenChange={setShowMarkPaidDialog}>\n        <DialogContent data-testid=\"dialog-mark-paid\">\n          <DialogHeader>\n            <DialogTitle data-testid=\"text-mark-paid-title\">Apply Payment</DialogTitle>\n            <DialogDescription data-testid=\"text-mark-paid-description\">\n              Record payment received for invoice {selectedEntry?.invoiceNumber}\n            </DialogDescription>\n          </DialogHeader>\n          {selectedEntry && (\n            <div className=\"space-y-4\">\n              <div className=\"p-4 bg-muted rounded-lg\">\n                <div className=\"grid grid-cols-2 gap-2 text-sm\">\n                  <div>\n                    <span className=\"text-muted-foreground\">Resident:</span>\n                    <span className=\"ml-2 font-medium\" data-testid=\"text-payment-resident\">{selectedEntry.residentName}</span>\n                  </div>\n                  <div>\n                    <span className=\"text-muted-foreground\">Outstanding Balance:</span>\n                    <span className=\"ml-2 font-semibold\" data-testid=\"text-payment-balance\">{formatCurrency(selectedEntry.balance)}</span>\n                  </div>\n                </div>\n              </div>\n\n              <div>\n                <Label htmlFor=\"amountApplied\">\n                  Amount Received <span className=\"text-destructive\">*</span>\n                </Label>\n                <Input\n                  id=\"amountApplied\"\n                  type=\"number\"\n                  step=\"0.01\"\n                  value={amountApplied}\n                  onChange={(e) => setAmountApplied(e.target.value)}\n                  placeholder=\"Enter amount received\"\n                  data-testid=\"input-amount-applied\"\n                />\n              </div>\n\n              <div>\n                <Label htmlFor=\"bankName\">\n                  Bank Name <span className=\"text-destructive\">*</span>\n                </Label>\n                <Input\n                  id=\"bankName\"\n                  value={bankName}\n                  onChange={(e) => setBankName(e.target.value)}\n                  placeholder=\"Enter bank name\"\n                  data-testid=\"input-bank-name\"\n                />\n              </div>\n\n              <div>\n                <Label htmlFor=\"accountNumber\">\n                  Account Number <span className=\"text-destructive\">*</span>\n                </Label>\n                <Input\n                  id=\"accountNumber\"\n                  value={accountNumber}\n                  onChange={(e) => setAccountNumber(e.target.value)}\n                  placeholder=\"Enter account number\"\n                  data-testid=\"input-account-number\"\n                />\n              </div>\n\n              <div>\n                <Label htmlFor=\"paymentDate\">\n                  Payment Date <span className=\"text-destructive\">*</span>\n                </Label>\n                <Input\n                  id=\"paymentDate\"\n                  type=\"date\"\n                  value={paymentDate}\n                  onChange={(e) => setPaymentDate(e.target.value)}\n                  data-testid=\"input-payment-date\"\n                />\n              </div>\n\n              <div>\n                <Label htmlFor=\"notes\">Notes (Optional)</Label>\n                <Textarea\n                  id=\"notes\"\n                  value={notes}\n                  onChange={(e) => setNotes(e.target.value)}\n                  placeholder=\"Add any notes about this payment\"\n                  rows={3}\n                  data-testid=\"input-notes\"\n                />\n              </div>\n            </div>\n          )}\n          <DialogFooter>\n            <Button \n              variant=\"outline\" \n              onClick={() => {\n                setShowMarkPaidDialog(false);\n                resetForm();\n              }}\n              data-testid=\"button-cancel-payment\"\n            >\n              Cancel\n            </Button>\n            <Button\n              onClick={handleMarkPaidSubmit}\n              disabled={markPaidMutation.isPending}\n              data-testid=\"button-submit-payment\"\n            >\n              {markPaidMutation.isPending && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\n              Apply Payment\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","size_bytes":17129},"client/src/pages/accountant/bank-statement-upload.tsx":{"content":"import { useState } from \"react\";\nimport { useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport { Loader2, Upload, FileText, Trash2, Download } from \"lucide-react\";\nimport { format } from \"date-fns\";\n\ninterface ParsedEntry {\n  transactionDate: string;\n  description: string;\n  referenceNumber: string;\n  amount: string;\n}\n\nexport default function BankStatementUpload() {\n  const { toast } = useToast();\n  const [file, setFile] = useState<File | null>(null);\n  const [fileData, setFileData] = useState<string>(\"\");\n  const [bankName, setBankName] = useState(\"\");\n  const [accountNumber, setAccountNumber] = useState(\"\");\n  const [statementDate, setStatementDate] = useState(format(new Date(), \"yyyy-MM-dd\"));\n  const [entries, setEntries] = useState<ParsedEntry[]>([]);\n  const [isParsing, setIsParsing] = useState(false);\n\n  // Download CSV template\n  const downloadTemplate = () => {\n    const headers = ['Transaction Date', 'Description', 'Reference Number', 'Amount'];\n    const sampleData = [\n      [format(new Date(), 'yyyy-MM-dd'), 'Payment from resident', 'INV-2025-0001', '50000.00'],\n      [format(new Date(), 'yyyy-MM-dd'), 'Service charge payment', 'INV-2025-0002', '75000.00'],\n      [format(new Date(), 'yyyy-MM-dd'), 'Security levy payment', 'INV-2025-0003', '25000.00'],\n    ];\n\n    const csvContent = [\n      headers.join(','),\n      ...sampleData.map(row => row.join(','))\n    ].join('\\n');\n\n    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });\n    const link = document.createElement('a');\n    const url = URL.createObjectURL(blob);\n    \n    link.setAttribute('href', url);\n    link.setAttribute('download', `bank_statement_template_${format(new Date(), 'yyyyMMdd')}.csv`);\n    link.style.visibility = 'hidden';\n    document.body.appendChild(link);\n    link.click();\n    document.body.removeChild(link);\n\n    toast({\n      title: \"Template Downloaded\",\n      description: \"CSV template downloaded successfully. Fill in your bank statement data and upload.\",\n    });\n  };\n\n  // Upload mutation\n  const uploadMutation = useMutation({\n    mutationFn: async (data: {\n      fileName: string;\n      fileData: string;\n      bankName: string;\n      accountNumber: string;\n      statementDate: string;\n      entries: ParsedEntry[];\n    }) => {\n      const response = await apiRequest('POST', '/api/accountant/bank-statements/upload', data);\n      return await response.json();\n    },\n    onSuccess: (response: any) => {\n      const reconciliation = response.reconciliation;\n      const totalReconciled = reconciliation.matched + reconciliation.partiallyMatched;\n      const hasResiduals = reconciliation.residualAmounts && reconciliation.residualAmounts.length > 0;\n      \n      let description = `Statement uploaded successfully. ${totalReconciled} of ${reconciliation.totalEntries} entries reconciled automatically. Amount: ₦${parseFloat(reconciliation.totalMatched).toLocaleString('en-NG', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;\n      \n      if (hasResiduals) {\n        const totalResidual = reconciliation.residualAmounts.reduce((sum: number, r: any) => sum + r.residualAmount, 0);\n        description += `. ${reconciliation.residualAmounts.length} entries have residual amounts totaling ₦${totalResidual.toLocaleString('en-NG', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} requiring manual review.`;\n      }\n      \n      toast({\n        title: \"Reconciliation Completed\",\n        description,\n      });\n      resetForm();\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Upload Failed\",\n        description: error.message || \"Failed to upload bank statement\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const resetForm = () => {\n    setFile(null);\n    setFileData(\"\");\n    setBankName(\"\");\n    setAccountNumber(\"\");\n    setStatementDate(format(new Date(), \"yyyy-MM-dd\"));\n    setEntries([]);\n  };\n\n  const handleFileSelect = async (e: React.ChangeEvent<HTMLInputElement>) => {\n    const selectedFile = e.target.files?.[0];\n    if (!selectedFile) return;\n\n    // Validate file type\n    const validTypes = ['text/csv', 'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'];\n    if (!validTypes.includes(selectedFile.type) && !selectedFile.name.endsWith('.csv')) {\n      toast({\n        title: \"Invalid File Type\",\n        description: \"Please upload a CSV or Excel file\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    // Validate file size (5MB max)\n    if (selectedFile.size > 5 * 1024 * 1024) {\n      toast({\n        title: \"File Too Large\",\n        description: \"File size must be less than 5MB\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setFile(selectedFile);\n\n    // Read file as base64\n    const reader = new FileReader();\n    reader.onload = (event) => {\n      const base64 = event.target?.result as string;\n      setFileData(base64);\n    };\n    reader.readAsDataURL(selectedFile);\n\n    // Parse CSV\n    if (selectedFile.name.endsWith('.csv') || selectedFile.type === 'text/csv') {\n      parseCSV(selectedFile);\n    }\n  };\n\n  const parseCSV = async (file: File) => {\n    setIsParsing(true);\n    const reader = new FileReader();\n    \n    reader.onload = (event) => {\n      try {\n        const text = event.target?.result as string;\n        const lines = text.split('\\n').filter(line => line.trim());\n        \n        if (lines.length < 2) {\n          toast({\n            title: \"Empty File\",\n            description: \"The CSV file appears to be empty\",\n            variant: \"destructive\",\n          });\n          setIsParsing(false);\n          return;\n        }\n\n        // Skip header row, parse data rows\n        const parsedEntries: ParsedEntry[] = [];\n        \n        for (let i = 1; i < lines.length; i++) {\n          const line = lines[i].trim();\n          if (!line) continue;\n          \n          // Split by comma, handling quoted fields\n          const values = line.split(',').map(v => v.trim().replace(/^\"|\"$/g, ''));\n          \n          if (values.length >= 4) {\n            parsedEntries.push({\n              transactionDate: values[0] || format(new Date(), \"yyyy-MM-dd\"),\n              description: values[1] || '',\n              referenceNumber: values[2] || '',\n              amount: values[3] || '0.00',\n            });\n          }\n        }\n\n        setEntries(parsedEntries);\n        toast({\n          title: \"File Parsed\",\n          description: `Successfully parsed ${parsedEntries.length} entries`,\n        });\n      } catch (error) {\n        toast({\n          title: \"Parse Error\",\n          description: \"Failed to parse CSV file. Please check the format.\",\n          variant: \"destructive\",\n        });\n      } finally {\n        setIsParsing(false);\n      }\n    };\n\n    reader.onerror = () => {\n      toast({\n        title: \"Read Error\",\n        description: \"Failed to read the file\",\n        variant: \"destructive\",\n      });\n      setIsParsing(false);\n    };\n\n    reader.readAsText(file);\n  };\n\n  const handleRemoveFile = () => {\n    setFile(null);\n    setFileData(\"\");\n    setEntries([]);\n  };\n\n  const handleRemoveEntry = (index: number) => {\n    setEntries(entries.filter((_, i) => i !== index));\n  };\n\n  const handleSubmit = () => {\n    // Validate form\n    if (!file || !fileData) {\n      toast({\n        title: \"Validation Error\",\n        description: \"Please select a file to upload\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    if (!bankName || !accountNumber || !statementDate) {\n      toast({\n        title: \"Validation Error\",\n        description: \"Please fill in all bank details\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    if (entries.length === 0) {\n      toast({\n        title: \"Validation Error\",\n        description: \"No entries found in the file. Please check the file format.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    uploadMutation.mutate({\n      fileName: file.name,\n      fileData,\n      bankName,\n      accountNumber,\n      statementDate,\n      entries,\n    });\n  };\n\n  return (\n    <div className=\"container mx-auto py-6 space-y-6\">\n      <Card>\n        <CardHeader>\n          <CardTitle data-testid=\"text-page-title\">Upload Bank Statement</CardTitle>\n          <CardDescription data-testid=\"text-page-description\">\n            Upload and parse bank statements for payment reconciliation\n          </CardDescription>\n        </CardHeader>\n        <CardContent className=\"space-y-6\">\n          {/* Bank Details Section */}\n          <div className=\"space-y-4\">\n            <h3 className=\"text-lg font-semibold\">Bank Details</h3>\n            <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n              <div>\n                <Label htmlFor=\"bankName\">\n                  Bank Name <span className=\"text-destructive\">*</span>\n                </Label>\n                <Input\n                  id=\"bankName\"\n                  value={bankName}\n                  onChange={(e) => setBankName(e.target.value)}\n                  placeholder=\"Enter bank name\"\n                  data-testid=\"input-bank-name\"\n                />\n              </div>\n              <div>\n                <Label htmlFor=\"accountNumber\">\n                  Account Number <span className=\"text-destructive\">*</span>\n                </Label>\n                <Input\n                  id=\"accountNumber\"\n                  value={accountNumber}\n                  onChange={(e) => setAccountNumber(e.target.value)}\n                  placeholder=\"Enter account number\"\n                  data-testid=\"input-account-number\"\n                />\n              </div>\n              <div>\n                <Label htmlFor=\"statementDate\">\n                  Statement Date <span className=\"text-destructive\">*</span>\n                </Label>\n                <Input\n                  id=\"statementDate\"\n                  type=\"date\"\n                  value={statementDate}\n                  onChange={(e) => setStatementDate(e.target.value)}\n                  data-testid=\"input-statement-date\"\n                />\n              </div>\n            </div>\n          </div>\n\n          {/* File Upload Section */}\n          <div className=\"space-y-4\">\n            <div className=\"flex items-center justify-between\">\n              <h3 className=\"text-lg font-semibold\">Statement File</h3>\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={downloadTemplate}\n                data-testid=\"button-download-template\"\n              >\n                <Download className=\"h-4 w-4 mr-2\" />\n                Download Template\n              </Button>\n            </div>\n            <div className=\"border-2 border-dashed rounded-lg p-6\">\n              {!file ? (\n                <div className=\"text-center\">\n                  <Upload className=\"mx-auto h-12 w-12 text-muted-foreground\" />\n                  <div className=\"mt-4\">\n                    <Label\n                      htmlFor=\"file-upload\"\n                      className=\"cursor-pointer inline-flex items-center gap-2 px-4 py-2 bg-primary text-primary-foreground rounded-md hover-elevate active-elevate-2\"\n                      data-testid=\"button-select-file\"\n                    >\n                      <FileText className=\"h-4 w-4\" />\n                      Select File\n                    </Label>\n                    <Input\n                      id=\"file-upload\"\n                      type=\"file\"\n                      accept=\".csv,.xlsx,.xls\"\n                      onChange={handleFileSelect}\n                      className=\"hidden\"\n                      data-testid=\"input-file-upload\"\n                    />\n                  </div>\n                  <p className=\"mt-2 text-sm text-muted-foreground\">\n                    Upload CSV or Excel file (max 5MB)\n                  </p>\n                  <p className=\"mt-1 text-xs text-muted-foreground\">\n                    Expected format: Transaction Date, Description, Reference Number, Amount\n                  </p>\n                  <p className=\"mt-1 text-xs text-primary\">\n                    💡 Download the template above to see the correct format with sample data\n                  </p>\n                </div>\n              ) : (\n                <div className=\"flex items-center justify-between\">\n                  <div className=\"flex items-center gap-3\">\n                    <FileText className=\"h-8 w-8 text-primary\" />\n                    <div>\n                      <p className=\"font-medium\" data-testid=\"text-file-name\">{file.name}</p>\n                      <p className=\"text-sm text-muted-foreground\">\n                        {(file.size / 1024).toFixed(2)} KB\n                      </p>\n                    </div>\n                  </div>\n                  <Button\n                    variant=\"outline\"\n                    size=\"sm\"\n                    onClick={handleRemoveFile}\n                    data-testid=\"button-remove-file\"\n                  >\n                    <Trash2 className=\"h-4 w-4 mr-1\" />\n                    Remove\n                  </Button>\n                </div>\n              )}\n            </div>\n          </div>\n\n          {/* Parsed Entries Preview */}\n          {isParsing ? (\n            <div className=\"flex items-center justify-center py-8\">\n              <Loader2 className=\"h-8 w-8 animate-spin\" data-testid=\"loader-parsing\" />\n              <span className=\"ml-2\">Parsing file...</span>\n            </div>\n          ) : entries.length > 0 ? (\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center justify-between\">\n                <h3 className=\"text-lg font-semibold\">Parsed Entries ({entries.length})</h3>\n                <p className=\"text-sm text-muted-foreground\">\n                  Total: ₦{entries.reduce((sum, e) => sum + parseFloat(e.amount || '0'), 0).toLocaleString('en-NG', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                </p>\n              </div>\n              <div className=\"rounded-md border max-h-96 overflow-auto\">\n                <Table>\n                  <TableHeader>\n                    <TableRow>\n                      <TableHead>Date</TableHead>\n                      <TableHead>Description</TableHead>\n                      <TableHead>Reference</TableHead>\n                      <TableHead>Amount</TableHead>\n                      <TableHead>Action</TableHead>\n                    </TableRow>\n                  </TableHeader>\n                  <TableBody>\n                    {entries.map((entry, index) => (\n                      <TableRow key={index} data-testid={`row-entry-${index}`}>\n                        <TableCell data-testid={`text-date-${index}`}>\n                          {entry.transactionDate}\n                        </TableCell>\n                        <TableCell data-testid={`text-description-${index}`}>\n                          {entry.description}\n                        </TableCell>\n                        <TableCell data-testid={`text-reference-${index}`}>\n                          {entry.referenceNumber}\n                        </TableCell>\n                        <TableCell data-testid={`text-amount-${index}`}>\n                          ₦{parseFloat(entry.amount).toLocaleString('en-NG', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                        </TableCell>\n                        <TableCell>\n                          <Button\n                            variant=\"ghost\"\n                            size=\"sm\"\n                            onClick={() => handleRemoveEntry(index)}\n                            data-testid={`button-remove-entry-${index}`}\n                          >\n                            <Trash2 className=\"h-4 w-4\" />\n                          </Button>\n                        </TableCell>\n                      </TableRow>\n                    ))}\n                  </TableBody>\n                </Table>\n              </div>\n            </div>\n          ) : null}\n\n          {/* Submit Button */}\n          <div className=\"flex gap-3\">\n            <Button\n              onClick={handleSubmit}\n              disabled={uploadMutation.isPending || !file || entries.length === 0}\n              data-testid=\"button-upload-statement\"\n            >\n              {uploadMutation.isPending && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\n              Upload Statement\n            </Button>\n            <Button\n              variant=\"outline\"\n              onClick={resetForm}\n              disabled={uploadMutation.isPending}\n              data-testid=\"button-cancel\"\n            >\n              Cancel\n            </Button>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":17232},"client/src/pages/admin/collections.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Eye, DollarSign, Calendar, User } from \"lucide-react\";\nimport { format } from \"date-fns\";\n\ninterface PaymentApplication {\n  id: string;\n  billId: string;\n  amountApplied: string;\n  applicationType: \"bank_statement\" | \"manual\";\n  bankName: string | null;\n  accountNumber: string | null;\n  paymentDate: Date;\n  appliedBy: string;\n  appliedAt: Date;\n  notes: string | null;\n  bill?: {\n    id: string;\n    invoiceNumber: string;\n    description: string;\n    amount: string;\n    resident?: {\n      id: string;\n      fullName: string;\n      houseNumber: string;\n    };\n  };\n}\n\nconst formatNaira = (amount: string | number) => {\n  const numAmount = typeof amount === 'string' ? parseFloat(amount) : amount;\n  return new Intl.NumberFormat('en-NG', {\n    style: 'currency',\n    currency: 'NGN',\n    minimumFractionDigits: 2,\n  }).format(numAmount);\n};\n\nexport default function Collections() {\n  const { isAuthenticated, isLoading: authLoading, user } = useAuth();\n  const [selectedPayment, setSelectedPayment] = useState<PaymentApplication | null>(null);\n  const [viewDialogOpen, setViewDialogOpen] = useState(false);\n\n  const { data: payments = [], isLoading } = useQuery<PaymentApplication[]>({\n    queryKey: ['/api/admin/collections'],\n    enabled: isAuthenticated && user?.role === \"admin\",\n  });\n\n  if (authLoading || !isAuthenticated || user?.role !== \"admin\") {\n    return (\n      <div className=\"flex h-screen items-center justify-center\">\n        <div className=\"animate-spin w-8 h-8 border-4 border-primary border-t-transparent rounded-full\" />\n      </div>\n    );\n  }\n\n  const handleView = (payment: PaymentApplication) => {\n    setSelectedPayment(payment);\n    setViewDialogOpen(true);\n  };\n\n  const totalCollections = payments.reduce((sum, p) => sum + parseFloat(p.amountApplied), 0);\n\n  return (\n    <div className=\"space-y-6 p-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-bold\" data-testid=\"text-collections-title\">Collections</h1>\n          <p className=\"text-muted-foreground\">View all payments received from residents</p>\n        </div>\n        <Card className=\"w-auto\">\n          <CardContent className=\"pt-6\">\n            <div className=\"flex items-center gap-4\">\n              <DollarSign className=\"h-8 w-8 text-green-600\" />\n              <div>\n                <p className=\"text-sm text-muted-foreground\">Total Collections</p>\n                <p className=\"text-2xl font-bold text-green-600\" data-testid=\"text-total-collections\">\n                  {formatNaira(totalCollections)}\n                </p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Payment History</CardTitle>\n        </CardHeader>\n        <CardContent>\n          {isLoading ? (\n            <div className=\"text-center py-12\">\n              <div className=\"animate-spin w-8 h-8 border-4 border-primary border-t-transparent rounded-full mx-auto\" />\n            </div>\n          ) : payments.length === 0 ? (\n            <div className=\"text-center py-12\">\n              <p className=\"text-muted-foreground\">No collections yet</p>\n            </div>\n          ) : (\n            <Table>\n              <TableHeader>\n                <TableRow>\n                  <TableHead>Date</TableHead>\n                  <TableHead>Resident</TableHead>\n                  <TableHead>Invoice</TableHead>\n                  <TableHead>Description</TableHead>\n                  <TableHead className=\"text-right\">Amount</TableHead>\n                  <TableHead>Type</TableHead>\n                  <TableHead className=\"text-right\">Actions</TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>\n                {payments.map((payment) => (\n                  <TableRow key={payment.id} data-testid={`row-payment-${payment.id}`}>\n                    <TableCell>\n                      <div className=\"flex items-center gap-2\">\n                        <Calendar className=\"h-4 w-4 text-muted-foreground\" />\n                        {format(new Date(payment.paymentDate), 'MMM dd, yyyy')}\n                      </div>\n                    </TableCell>\n                    <TableCell>\n                      <div className=\"flex items-center gap-2\">\n                        <User className=\"h-4 w-4 text-muted-foreground\" />\n                        <div>\n                          <p className=\"font-medium\">{payment.bill?.resident?.fullName || 'N/A'}</p>\n                          <p className=\"text-sm text-muted-foreground\">\n                            {payment.bill?.resident?.houseNumber || ''}\n                          </p>\n                        </div>\n                      </div>\n                    </TableCell>\n                    <TableCell>\n                      <code className=\"text-xs bg-muted px-2 py-1 rounded\">\n                        {payment.bill?.invoiceNumber || 'N/A'}\n                      </code>\n                    </TableCell>\n                    <TableCell className=\"max-w-xs truncate\">\n                      {payment.bill?.description || 'N/A'}\n                    </TableCell>\n                    <TableCell className=\"text-right font-mono font-semibold text-green-600\">\n                      {formatNaira(payment.amountApplied)}\n                    </TableCell>\n                    <TableCell>\n                      <Badge variant={payment.applicationType === 'bank_statement' ? 'default' : 'secondary'}>\n                        {payment.applicationType === 'bank_statement' ? 'Bank Transfer' : 'Manual'}\n                      </Badge>\n                    </TableCell>\n                    <TableCell className=\"text-right\">\n                      <Button\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        onClick={() => handleView(payment)}\n                        data-testid={`button-view-${payment.id}`}\n                      >\n                        <Eye className=\"h-4 w-4 mr-2\" />\n                        View\n                      </Button>\n                    </TableCell>\n                  </TableRow>\n                ))}\n              </TableBody>\n            </Table>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* View Payment Dialog */}\n      <Dialog open={viewDialogOpen} onOpenChange={setViewDialogOpen}>\n        <DialogContent className=\"max-w-2xl\">\n          <DialogHeader>\n            <DialogTitle>Payment Details</DialogTitle>\n            <DialogDescription>\n              Complete information about this payment\n            </DialogDescription>\n          </DialogHeader>\n          \n          {selectedPayment && (\n            <div className=\"space-y-6\">\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Payment Date</p>\n                  <p className=\"font-medium\">\n                    {format(new Date(selectedPayment.paymentDate), 'MMMM dd, yyyy')}\n                  </p>\n                </div>\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Amount Paid</p>\n                  <p className=\"font-medium text-green-600 text-lg\">\n                    {formatNaira(selectedPayment.amountApplied)}\n                  </p>\n                </div>\n              </div>\n\n              <div className=\"border-t pt-4\">\n                <h3 className=\"font-semibold mb-3\">Resident Information</h3>\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\">Name</p>\n                    <p className=\"font-medium\">{selectedPayment.bill?.resident?.fullName || 'N/A'}</p>\n                  </div>\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\">House Number</p>\n                    <p className=\"font-medium\">{selectedPayment.bill?.resident?.houseNumber || 'N/A'}</p>\n                  </div>\n                </div>\n              </div>\n\n              <div className=\"border-t pt-4\">\n                <h3 className=\"font-semibold mb-3\">Bill Information</h3>\n                <div className=\"space-y-3\">\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\">Invoice Number</p>\n                    <code className=\"text-sm bg-muted px-2 py-1 rounded\">\n                      {selectedPayment.bill?.invoiceNumber || 'N/A'}\n                    </code>\n                  </div>\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\">Description</p>\n                    <p className=\"font-medium\">{selectedPayment.bill?.description || 'N/A'}</p>\n                  </div>\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\">Bill Amount</p>\n                    <p className=\"font-medium\">{formatNaira(selectedPayment.bill?.amount || 0)}</p>\n                  </div>\n                </div>\n              </div>\n\n              <div className=\"border-t pt-4\">\n                <h3 className=\"font-semibold mb-3\">Payment Method</h3>\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\">Type</p>\n                    <Badge variant={selectedPayment.applicationType === 'bank_statement' ? 'default' : 'secondary'}>\n                      {selectedPayment.applicationType === 'bank_statement' ? 'Bank Transfer' : 'Manual Payment'}\n                    </Badge>\n                  </div>\n                  {selectedPayment.bankName && (\n                    <div>\n                      <p className=\"text-sm text-muted-foreground\">Bank Name</p>\n                      <p className=\"font-medium\">{selectedPayment.bankName}</p>\n                    </div>\n                  )}\n                </div>\n                {selectedPayment.accountNumber && (\n                  <div className=\"mt-3\">\n                    <p className=\"text-sm text-muted-foreground\">Account Number</p>\n                    <p className=\"font-medium\">{selectedPayment.accountNumber}</p>\n                  </div>\n                )}\n              </div>\n\n              {selectedPayment.notes && (\n                <div className=\"border-t pt-4\">\n                  <h3 className=\"font-semibold mb-3\">Notes</h3>\n                  <p className=\"text-sm\">{selectedPayment.notes}</p>\n                </div>\n              )}\n\n              <div className=\"border-t pt-4\">\n                <p className=\"text-xs text-muted-foreground\">\n                  Applied on {format(new Date(selectedPayment.appliedAt), 'MMMM dd, yyyy')} at {format(new Date(selectedPayment.appliedAt), 'hh:mm a')}\n                </p>\n              </div>\n            </div>\n          )}\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","size_bytes":11421},"shared/subscription-plans.ts":{"content":"// Subscription plan definitions and pricing\n\nexport interface SubscriptionPlanFeatures {\n  maxResidents: number;\n  maxAdmins: number;\n  maxSecurity: number;\n  maxAccountants: number;\n  \n  // Core Features\n  residentManagement: boolean;\n  manualBilling: boolean;\n  paymentTracking: boolean;\n  visitorAccessControl: boolean;\n  securityLogs: boolean;\n  securityLogRetentionDays: number;\n  announcements: boolean;\n  basicNotifications: boolean;\n  \n  // Accounting Features\n  chartOfAccounts: boolean;\n  transactionTemplates: boolean;\n  journalEntries: boolean;\n  financialReports: boolean;\n  \n  // Advanced Features\n  automatedBilling: boolean;\n  vendorManagement: boolean;\n  expenseManagement: boolean;\n  accountsReceivable: boolean;\n  accountsPayable: boolean;\n  whtManagement: boolean;\n  budgetPlanning: boolean;\n  bankReconciliation: boolean;\n  \n  // Analytics\n  basicDashboard: boolean;\n  enhancedAnalytics: boolean;\n  advancedReports: boolean;\n  \n  // Support\n  supportType: 'community' | 'email' | 'priority';\n  supportResponseTime?: string;\n}\n\nexport interface SubscriptionPlan {\n  id: 'starter' | 'professional' | 'enterprise';\n  name: string;\n  description: string;\n  monthlyPrice: number; // in NGN\n  annualPrice: number; // in NGN (with 20% discount)\n  currency: string;\n  features: SubscriptionPlanFeatures;\n  popular?: boolean;\n}\n\nexport const SUBSCRIPTION_PLAN_IDS = ['starter', 'professional', 'enterprise'] as const;\nexport type SubscriptionPlanId = typeof SUBSCRIPTION_PLAN_IDS[number];\n\nexport const SUBSCRIPTION_PLANS: Record<SubscriptionPlanId, SubscriptionPlan> = {\n  starter: {\n    id: 'starter',\n    name: 'Starter',\n    description: 'Best for small estates (1-50 units)',\n    monthlyPrice: 50000,\n    annualPrice: 480000,\n    currency: 'NGN',\n    features: {\n      maxResidents: 50,\n      maxAdmins: 1,\n      maxSecurity: 1,\n      maxAccountants: 0,\n      \n      residentManagement: true,\n      manualBilling: true,\n      paymentTracking: true,\n      visitorAccessControl: true,\n      securityLogs: true,\n      securityLogRetentionDays: 30,\n      announcements: true,\n      basicNotifications: true,\n      \n      chartOfAccounts: false,\n      transactionTemplates: false,\n      journalEntries: false,\n      financialReports: false,\n      \n      automatedBilling: false,\n      vendorManagement: false,\n      expenseManagement: false,\n      accountsReceivable: false,\n      accountsPayable: false,\n      whtManagement: false,\n      budgetPlanning: false,\n      bankReconciliation: false,\n      \n      basicDashboard: true,\n      enhancedAnalytics: false,\n      advancedReports: false,\n      \n      supportType: 'community',\n    },\n  },\n  \n  professional: {\n    id: 'professional',\n    name: 'Professional',\n    description: 'Best for medium estates (51-200 units)',\n    monthlyPrice: 150000,\n    annualPrice: 1440000,\n    currency: 'NGN',\n    popular: true,\n    features: {\n      maxResidents: 200,\n      maxAdmins: 2,\n      maxSecurity: 2,\n      maxAccountants: 1,\n      \n      residentManagement: true,\n      manualBilling: true,\n      paymentTracking: true,\n      visitorAccessControl: true,\n      securityLogs: true,\n      securityLogRetentionDays: 90,\n      announcements: true,\n      basicNotifications: true,\n      \n      chartOfAccounts: true,\n      transactionTemplates: true,\n      journalEntries: true,\n      financialReports: true,\n      \n      automatedBilling: true,\n      vendorManagement: true,\n      expenseManagement: true,\n      accountsReceivable: true,\n      accountsPayable: false,\n      whtManagement: false,\n      budgetPlanning: false,\n      bankReconciliation: false,\n      \n      basicDashboard: true,\n      enhancedAnalytics: true,\n      advancedReports: false,\n      \n      supportType: 'email',\n      supportResponseTime: '48 hours',\n    },\n  },\n  \n  enterprise: {\n    id: 'enterprise',\n    name: 'Enterprise',\n    description: 'Best for large estates (Unlimited units)',\n    monthlyPrice: 350000,\n    annualPrice: 3360000,\n    currency: 'NGN',\n    features: {\n      maxResidents: 999999, // Unlimited\n      maxAdmins: 999999,\n      maxSecurity: 999999,\n      maxAccountants: 999999,\n      \n      residentManagement: true,\n      manualBilling: true,\n      paymentTracking: true,\n      visitorAccessControl: true,\n      securityLogs: true,\n      securityLogRetentionDays: 999999, // Unlimited\n      announcements: true,\n      basicNotifications: true,\n      \n      chartOfAccounts: true,\n      transactionTemplates: true,\n      journalEntries: true,\n      financialReports: true,\n      \n      automatedBilling: true,\n      vendorManagement: true,\n      expenseManagement: true,\n      accountsReceivable: true,\n      accountsPayable: true,\n      whtManagement: true,\n      budgetPlanning: true,\n      bankReconciliation: true,\n      \n      basicDashboard: true,\n      enhancedAnalytics: true,\n      advancedReports: true,\n      \n      supportType: 'priority',\n      supportResponseTime: '12 hours',\n    },\n  },\n};\n\nexport function getPlanPrice(planId: string, billingCycle: 'monthly' | 'annual'): number {\n  const plan = SUBSCRIPTION_PLANS[planId];\n  if (!plan) return 0;\n  return billingCycle === 'monthly' ? plan.monthlyPrice : plan.annualPrice;\n}\n\nexport function hasFeatureAccess(subscription: any, feature: keyof SubscriptionPlanFeatures): boolean {\n  if (!subscription) return false;\n  const plan = SUBSCRIPTION_PLANS[subscription.plan];\n  if (!plan) return false;\n  return plan.features[feature] as boolean;\n}\n\nexport function getUserLimitForRole(subscription: any, role: 'admin' | 'security' | 'accountant'): number {\n  if (!subscription) return 0;\n  const plan = SUBSCRIPTION_PLANS[subscription.plan];\n  if (!plan) return 0;\n  \n  switch (role) {\n    case 'admin':\n      return plan.features.maxAdmins;\n    case 'security':\n      return plan.features.maxSecurity;\n    case 'accountant':\n      return plan.features.maxAccountants;\n    default:\n      return 0;\n  }\n}\n","size_bytes":5921},"SUBSCRIPTION_TIERS.md":{"content":"# Estate Management System - Subscription Tiers\n\n## Overview\nThree tiers designed for estates of different sizes and complexity needs.\n\n---\n\n## 🌱 STARTER PLAN\n**Best for: Small estates (1-50 units)**\n**Price: ₦25,000/month**\n\n### Core Features Included:\n✅ **Resident Management**\n- Up to 50 resident accounts\n- Basic resident profiles\n- Account status tracking\n\n✅ **Billing & Collections**\n- Manual bill creation\n- Payment tracking\n- Basic payment history\n- Collections dashboard\n\n✅ **Visitor Access Control**\n- QR code generation for visitors\n- Security scanning interface\n- Access logs (30 days retention)\n\n✅ **Security Management**\n- Security dashboard\n- Basic access logging\n- 1 security guard account\n\n✅ **Communication**\n- Announcements to residents\n- Basic email notifications\n- In-app notifications\n\n✅ **Users**\n- 1 Admin account\n- 1 Security account\n- 50 Resident accounts\n\n### Limitations:\n❌ No accounting system\n❌ No automated billing\n❌ No vendor management\n❌ No expense management\n❌ No financial reports\n❌ No budget planning\n❌ No bank reconciliation\n❌ No accountant role access\n\n---\n\n## 💼 PROFESSIONAL PLAN\n**Best for: Medium estates (51-200 units)**\n**Price: ₦75,000/month**\n\n### Everything in STARTER, plus:\n\n✅ **Full Accounting System**\n- Chart of Accounts management\n- Transaction Templates\n- Journal Entries\n- Double-entry bookkeeping\n\n✅ **Financial Reports**\n- Trial Balance\n- Income Statement (P&L)\n- Balance Sheet\n- Custom date ranges\n\n✅ **Automated Operations**\n- Automated service charge billing\n- Scheduled bill generation\n- Payment reminders\n\n✅ **Vendor Management**\n- Vendor registration & approval\n- Vendor statements\n- Basic payment tracking\n\n✅ **Expense Management**\n- Expense request workflow\n- Receipt upload (compressed)\n- Approval workflow\n- Expense tracking by category\n\n✅ **Accounts Receivable**\n- Outstanding bills tracking\n- Manual payment application\n- Aging analysis\n- Collections tracking\n\n✅ **Enhanced Analytics**\n- Budget vs Expenses charts\n- Collections trends\n- Delinquency tracking\n\n✅ **Users**\n- 2 Admin accounts\n- 2 Security accounts\n- 1 Accountant account\n- 200 Resident accounts\n\n✅ **Support**\n- Email support (48hr response)\n- Knowledge base access\n\n### Limitations:\n❌ No Budget Planning system\n❌ No Accounts Payable with WHT\n❌ No bank statement reconciliation\n❌ No multi-accountant support\n❌ Limited to 200 residents\n\n---\n\n## 🏢 ENTERPRISE PLAN\n**Best for: Large estates (Unlimited units)**\n**Price: ₦150,000/month**\n\n### Everything in PROFESSIONAL, plus:\n\n✅ **Advanced Financial Management**\n- Budget Planning & Tracking\n- Budget consumption monitoring\n- Automated budget vs actual tracking\n\n✅ **Accounts Payable System**\n- Full AP workflow\n- Withholding Tax (WHT) management\n- Vendor payment processing\n- Payment status tracking\n- Approve & Pay workflow\n\n✅ **Bank Reconciliation**\n- CSV/Excel bank statement upload\n- Automatic invoice matching\n- Manual reconciliation tools\n- Bank transaction history\n\n✅ **Advanced Vendor Management**\n- Vendor statements with full history\n- Multiple payment methods\n- Vendor performance tracking\n\n✅ **Unlimited Scale**\n- Unlimited residents\n- Unlimited admins\n- Unlimited security personnel\n- Multiple accountants\n- Unlimited storage\n\n✅ **Premium Features**\n- Custom financial reports\n- Export to Excel/PDF\n- Advanced analytics dashboard\n- API access (coming soon)\n- Data backup & export\n\n✅ **Priority Support**\n- Priority email support (12hr response)\n- Phone support\n- Dedicated account manager\n- Onboarding assistance\n- Training sessions\n\n---\n\n## Feature Comparison Table\n\n| Feature | Starter | Professional | Enterprise |\n|---------|---------|--------------|------------|\n| **Residents** | Up to 50 | Up to 200 | Unlimited |\n| **Admins** | 1 | 2 | Unlimited |\n| **Security** | 1 | 2 | Unlimited |\n| **Accountants** | 0 | 1 | Unlimited |\n| **Billing & Collections** | ✅ Manual | ✅ Automated | ✅ Advanced |\n| **QR Visitor Access** | ✅ | ✅ | ✅ |\n| **Security Logs** | ✅ 30 days | ✅ 90 days | ✅ Unlimited |\n| **Announcements** | ✅ | ✅ | ✅ |\n| **Notifications** | ✅ Basic | ✅ Enhanced | ✅ Advanced |\n| **Chart of Accounts** | ❌ | ✅ | ✅ |\n| **Journal Entries** | ❌ | ✅ | ✅ |\n| **Financial Reports** | ❌ | ✅ | ✅ Advanced |\n| **Vendor Management** | ❌ | ✅ Basic | ✅ Advanced |\n| **Expense Management** | ❌ | ✅ | ✅ |\n| **Accounts Receivable** | ❌ | ✅ | ✅ + Reconciliation |\n| **Accounts Payable** | ❌ | ❌ | ✅ + WHT |\n| **Budget Planning** | ❌ | ❌ | ✅ |\n| **Bank Reconciliation** | ❌ | ❌ | ✅ |\n| **Dashboard Analytics** | ✅ Basic | ✅ Enhanced | ✅ Advanced |\n| **Support** | Community | Email (48hr) | Priority (12hr) + Phone |\n| **Price** | ₦25,000/mo | ₦75,000/mo | ₦150,000/mo |\n\n---\n\n## Recommended Tier by Estate Size\n\n- **1-50 units**: Starter Plan\n- **51-100 units**: Professional Plan\n- **101-200 units**: Professional Plan\n- **201+ units**: Enterprise Plan\n\n## Annual Billing Discount\n\nSave 20% with annual billing:\n- Starter: ₦240,000/year (₦20,000/month)\n- Professional: ₦720,000/year (₦60,000/month)\n- Enterprise: ₦1,440,000/year (₦120,000/month)\n","size_bytes":5230},"client/src/pages/admin/subscription.tsx":{"content":"import { useAuth } from \"@/hooks/useAuth\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle, CardFooter } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Check, Crown, Sparkles, Zap, ArrowRight } from \"lucide-react\";\nimport { SUBSCRIPTION_PLANS } from \"@shared/subscription-plans\";\nimport { formatNaira } from \"@/lib/currency\";\nimport { useState } from \"react\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\n\nexport default function SubscriptionManagement() {\n  const { user } = useAuth();\n  const { toast } = useToast();\n  const [billingCycle, setBillingCycle] = useState<'monthly' | 'annual'>('monthly');\n\n  const { data: subscription, isLoading } = useQuery<any>({\n    queryKey: ['/api/admin/subscription'],\n    enabled: user?.role === 'admin',\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async (data: { plan: string; billingCycle: string }) => {\n      return await apiRequest('/api/admin/subscription', {\n        method: 'POST',\n        body: JSON.stringify(data),\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/admin/subscription'] });\n      toast({\n        title: \"Subscription Updated\",\n        description: \"Your subscription plan has been updated successfully.\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Update Failed\",\n        description: error.message || \"Failed to update subscription\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleUpgrade = (planId: string) => {\n    updateMutation.mutate({\n      plan: planId,\n      billingCycle: billingCycle,\n    });\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"container mx-auto p-6 space-y-6\">\n        <Skeleton className=\"h-32 w-full\" />\n        <div className=\"grid gap-6 md:grid-cols-3\">\n          <Skeleton className=\"h-96\" />\n          <Skeleton className=\"h-96\" />\n          <Skeleton className=\"h-96\" />\n        </div>\n      </div>\n    );\n  }\n\n  const currentPlan = subscription?.plan || 'starter';\n  const planDetails = SUBSCRIPTION_PLANS[currentPlan];\n\n  const getPlanIcon = (planId: string) => {\n    switch (planId) {\n      case 'starter':\n        return <Sparkles className=\"h-5 w-5\" />;\n      case 'professional':\n        return <Zap className=\"h-5 w-5\" />;\n      case 'enterprise':\n        return <Crown className=\"h-5 w-5\" />;\n      default:\n        return <Sparkles className=\"h-5 w-5\" />;\n    }\n  };\n\n  const getStatusBadge = (status: string) => {\n    switch (status) {\n      case 'active':\n        return <Badge className=\"bg-green-600\">Active</Badge>;\n      case 'trial':\n        return <Badge variant=\"secondary\">Trial</Badge>;\n      case 'cancelled':\n        return <Badge variant=\"destructive\">Cancelled</Badge>;\n      default:\n        return <Badge variant=\"outline\">{status}</Badge>;\n    }\n  };\n\n  return (\n    <div className=\"container mx-auto p-6 space-y-6\">\n      {/* Current Subscription Card */}\n      <Card>\n        <CardHeader>\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <CardTitle className=\"text-2xl\">Your Subscription</CardTitle>\n              <CardDescription>Manage your estate's subscription plan</CardDescription>\n            </div>\n            {getStatusBadge(subscription?.status || 'trial')}\n          </div>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid gap-4 md:grid-cols-4\">\n            <div>\n              <p className=\"text-sm text-muted-foreground\">Current Plan</p>\n              <p className=\"text-2xl font-semibold capitalize\">{currentPlan}</p>\n            </div>\n            <div>\n              <p className=\"text-sm text-muted-foreground\">Estate Name</p>\n              <p className=\"text-lg font-medium\">{subscription?.estateName || 'My Estate'}</p>\n            </div>\n            <div>\n              <p className=\"text-sm text-muted-foreground\">Billing Cycle</p>\n              <p className=\"text-lg font-medium capitalize\">{subscription?.billingCycle || 'Monthly'}</p>\n            </div>\n            <div>\n              <p className=\"text-sm text-muted-foreground\">Next Billing Date</p>\n              <p className=\"text-lg font-medium\">\n                {subscription?.currentPeriodEnd \n                  ? new Date(subscription.currentPeriodEnd).toLocaleDateString()\n                  : 'N/A'}\n              </p>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Billing Cycle Toggle */}\n      <div className=\"flex justify-center\">\n        <Tabs value={billingCycle} onValueChange={(value) => setBillingCycle(value as 'monthly' | 'annual')} className=\"w-auto\">\n          <TabsList>\n            <TabsTrigger value=\"monthly\" data-testid=\"tab-monthly\">Monthly</TabsTrigger>\n            <TabsTrigger value=\"annual\" data-testid=\"tab-annual\">\n              Annual <Badge variant=\"secondary\" className=\"ml-2\">Save 20%</Badge>\n            </TabsTrigger>\n          </TabsList>\n        </Tabs>\n      </div>\n\n      {/* Pricing Cards */}\n      <div className=\"grid gap-6 md:grid-cols-3\">\n        {Object.values(SUBSCRIPTION_PLANS).map((plan) => (\n          <Card \n            key={plan.id} \n            className={`relative ${plan.popular ? 'border-primary shadow-lg' : ''} ${\n              currentPlan === plan.id ? 'ring-2 ring-primary' : ''\n            }`}\n            data-testid={`plan-card-${plan.id}`}\n          >\n            {plan.popular && (\n              <div className=\"absolute -top-3 left-1/2 -translate-x-1/2\">\n                <Badge className=\"bg-primary\">Most Popular</Badge>\n              </div>\n            )}\n            {currentPlan === plan.id && (\n              <div className=\"absolute -top-3 right-4\">\n                <Badge className=\"bg-green-600\">Current Plan</Badge>\n              </div>\n            )}\n            \n            <CardHeader>\n              <div className=\"flex items-center gap-2 mb-2\">\n                {getPlanIcon(plan.id)}\n                <CardTitle className=\"text-2xl capitalize\">{plan.name}</CardTitle>\n              </div>\n              <CardDescription>{plan.description}</CardDescription>\n              <div className=\"mt-4\">\n                <div className=\"flex items-baseline gap-2\">\n                  <span className=\"text-4xl font-bold\">\n                    {formatNaira(billingCycle === 'monthly' ? plan.monthlyPrice : plan.annualPrice)}\n                  </span>\n                  <span className=\"text-muted-foreground\">\n                    /{billingCycle === 'monthly' ? 'mo' : 'yr'}\n                  </span>\n                </div>\n                {billingCycle === 'annual' && (\n                  <p className=\"text-sm text-muted-foreground mt-1\">\n                    {formatNaira(Math.round(plan.annualPrice / 12))}/month billed annually\n                  </p>\n                )}\n              </div>\n            </CardHeader>\n\n            <CardContent className=\"space-y-4\">\n              <div className=\"space-y-2\">\n                <div className=\"flex items-start gap-2\">\n                  <Check className=\"h-5 w-5 text-green-600 mt-0.5 flex-shrink-0\" />\n                  <span className=\"text-sm\">\n                    {plan.features.maxResidents === 999999 ? 'Unlimited' : `Up to ${plan.features.maxResidents}`} residents\n                  </span>\n                </div>\n                <div className=\"flex items-start gap-2\">\n                  <Check className=\"h-5 w-5 text-green-600 mt-0.5 flex-shrink-0\" />\n                  <span className=\"text-sm\">\n                    {plan.features.maxAdmins} Admin{plan.features.maxAdmins > 1 ? 's' : ''}\n                  </span>\n                </div>\n                <div className=\"flex items-start gap-2\">\n                  <Check className=\"h-5 w-5 text-green-600 mt-0.5 flex-shrink-0\" />\n                  <span className=\"text-sm\">\n                    {plan.features.maxSecurity} Security guard{plan.features.maxSecurity > 1 ? 's' : ''}\n                  </span>\n                </div>\n                {plan.features.maxAccountants > 0 && (\n                  <div className=\"flex items-start gap-2\">\n                    <Check className=\"h-5 w-5 text-green-600 mt-0.5 flex-shrink-0\" />\n                    <span className=\"text-sm\">\n                      {plan.features.maxAccountants === 999999 ? 'Unlimited' : plan.features.maxAccountants} Accountant{plan.features.maxAccountants > 1 ? 's' : ''}\n                    </span>\n                  </div>\n                )}\n              </div>\n\n              <div className=\"border-t pt-4 space-y-2\">\n                <p className=\"font-semibold text-sm\">Key Features:</p>\n                {plan.features.manualBilling && (\n                  <div className=\"flex items-start gap-2\">\n                    <Check className=\"h-4 w-4 text-green-600 mt-0.5 flex-shrink-0\" />\n                    <span className=\"text-sm\">Billing & Collections</span>\n                  </div>\n                )}\n                {plan.features.visitorAccessControl && (\n                  <div className=\"flex items-start gap-2\">\n                    <Check className=\"h-4 w-4 text-green-600 mt-0.5 flex-shrink-0\" />\n                    <span className=\"text-sm\">QR Visitor Access</span>\n                  </div>\n                )}\n                {plan.features.chartOfAccounts && (\n                  <div className=\"flex items-start gap-2\">\n                    <Check className=\"h-4 w-4 text-green-600 mt-0.5 flex-shrink-0\" />\n                    <span className=\"text-sm\">Full Accounting System</span>\n                  </div>\n                )}\n                {plan.features.automatedBilling && (\n                  <div className=\"flex items-start gap-2\">\n                    <Check className=\"h-4 w-4 text-green-600 mt-0.5 flex-shrink-0\" />\n                    <span className=\"text-sm\">Automated Billing</span>\n                  </div>\n                )}\n                {plan.features.vendorManagement && (\n                  <div className=\"flex items-start gap-2\">\n                    <Check className=\"h-4 w-4 text-green-600 mt-0.5 flex-shrink-0\" />\n                    <span className=\"text-sm\">Vendor Management</span>\n                  </div>\n                )}\n                {plan.features.budgetPlanning && (\n                  <div className=\"flex items-start gap-2\">\n                    <Check className=\"h-4 w-4 text-green-600 mt-0.5 flex-shrink-0\" />\n                    <span className=\"text-sm\">Budget Planning</span>\n                  </div>\n                )}\n                {plan.features.accountsPayable && (\n                  <div className=\"flex items-start gap-2\">\n                    <Check className=\"h-4 w-4 text-green-600 mt-0.5 flex-shrink-0\" />\n                    <span className=\"text-sm\">Accounts Payable + WHT</span>\n                  </div>\n                )}\n                {plan.features.bankReconciliation && (\n                  <div className=\"flex items-start gap-2\">\n                    <Check className=\"h-4 w-4 text-green-600 mt-0.5 flex-shrink-0\" />\n                    <span className=\"text-sm\">Bank Reconciliation</span>\n                  </div>\n                )}\n                {plan.features.supportType !== 'community' && (\n                  <div className=\"flex items-start gap-2\">\n                    <Check className=\"h-4 w-4 text-green-600 mt-0.5 flex-shrink-0\" />\n                    <span className=\"text-sm capitalize\">\n                      {plan.features.supportType} Support\n                      {plan.features.supportResponseTime && ` (${plan.features.supportResponseTime})`}\n                    </span>\n                  </div>\n                )}\n              </div>\n            </CardContent>\n\n            <CardFooter>\n              {currentPlan === plan.id ? (\n                <Button className=\"w-full\" variant=\"outline\" disabled>\n                  Current Plan\n                </Button>\n              ) : (\n                <Button \n                  className=\"w-full\" \n                  variant={plan.popular ? \"default\" : \"outline\"}\n                  data-testid={`button-upgrade-${plan.id}`}\n                  onClick={() => handleUpgrade(plan.id)}\n                  disabled={updateMutation.isPending}\n                >\n                  {updateMutation.isPending ? 'Processing...' : (\n                    <>\n                      {currentPlan === 'starter' || (currentPlan === 'professional' && plan.id === 'enterprise')\n                        ? 'Upgrade to ' : 'Switch to '} {plan.name}\n                      <ArrowRight className=\"ml-2 h-4 w-4\" />\n                    </>\n                  )}\n                </Button>\n              )}\n            </CardFooter>\n          </Card>\n        ))}\n      </div>\n\n      {/* Feature Comparison Link */}\n      <Card>\n        <CardContent className=\"pt-6\">\n          <div className=\"text-center\">\n            <p className=\"text-muted-foreground mb-4\">\n              Need help choosing? View the detailed feature comparison in SUBSCRIPTION_TIERS.md\n            </p>\n            <Button variant=\"outline\">\n              View Full Feature Comparison\n            </Button>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":13514},"server/email-service.ts":{"content":"import { getUncachableResendClient } from './resend-client';\nimport { generateInvoiceEmailHTML, generateInvoiceEmailText } from './email-templates';\nimport { format, addDays } from 'date-fns';\n\n// Match the actual database schema types\ninterface Bill {\n  id: string;\n  residentId: string;\n  invoiceNumber: string | null;\n  amount: string;\n  createdAt: Date | null;\n  dueDate: Date | null;\n  periodStart: Date | null;\n  periodEnd: Date | null;\n  status: string;\n  description: string | null;\n}\n\ninterface Resident {\n  id: string;\n  userId: string;\n  firstName?: string;\n  lastName?: string;\n  email: string;\n  phoneNumber?: string | null;\n  unitNumber: string | null;\n}\n\ninterface EmailResult {\n  success: boolean;\n  messageId?: string;\n  error?: string;\n}\n\nexport async function sendInvoiceEmail(\n  bill: Bill,\n  resident: Resident\n): Promise<EmailResult> {\n  try {\n    const { client, fromEmail } = await getUncachableResendClient();\n\n    // Use actual period dates from the bill\n    const billingStartDate = bill.periodStart ? new Date(bill.periodStart) : new Date();\n    const billingEndDate = bill.periodEnd ? new Date(bill.periodEnd) : addDays(billingStartDate, 90);\n    const invoiceDate = bill.createdAt ? new Date(bill.createdAt) : new Date();\n    \n    // Calculate billing cycle from period dates\n    const monthsDiff = Math.round((billingEndDate.getTime() - billingStartDate.getTime()) / (1000 * 60 * 60 * 24 * 30));\n    const billingCycle = monthsDiff >= 12 ? 'Annual' : monthsDiff >= 3 ? 'Quarterly' : 'Monthly';\n    const monthsBilled = Math.max(1, monthsDiff);\n\n    // Prepare invoice data\n    const invoiceData = {\n      invoiceNumber: bill.invoiceNumber || 'PENDING',\n      dateIssued: invoiceDate,\n      residentName: resident.firstName && resident.lastName \n        ? `${resident.firstName} ${resident.lastName}` \n        : 'Valued Resident',\n      residentAddress: resident.unitNumber || 'N/A',\n      userId: resident.userId,\n      invoiceDate: invoiceDate,\n      billingCycle: billingCycle,\n      monthsBilled: monthsBilled,\n      billingPeriod: `${format(billingStartDate, 'dd/MM')}-${format(billingEndDate, 'dd/MM/yy')}`,\n      amountDue: parseFloat(bill.amount).toLocaleString('en-NG', {\n        minimumFractionDigits: 2,\n        maximumFractionDigits: 2\n      }),\n      paymentDueDate: bill.dueDate ? new Date(bill.dueDate) : addDays(invoiceDate, 30),\n      periodStart: billingStartDate,\n      periodEnd: billingEndDate,\n    };\n\n    // Generate email content\n    const htmlContent = generateInvoiceEmailHTML(invoiceData);\n    const textContent = generateInvoiceEmailText(invoiceData);\n\n    // Send email\n    console.log(`[Email Service] Attempting to send email to ${resident.email} from ${fromEmail}`);\n    const result = await client.emails.send({\n      from: fromEmail,\n      to: resident.email,\n      subject: `Invoice ${invoiceData.invoiceNumber} - Service Charge Payment Due`,\n      html: htmlContent,\n      text: textContent,\n    });\n\n    console.log(`[Email Service] Resend API response:`, JSON.stringify(result, null, 2));\n    \n    if (result.error) {\n      const errorMsg = result.error.message || 'Unknown Resend error';\n      console.error(`[Email Service] ❌ RESEND API ERROR:`, errorMsg);\n      \n      // Check for domain verification error\n      if (errorMsg.includes('domain is not verified') || errorMsg.includes('verification')) {\n        console.error(`[Email Service] 🔴 DOMAIN VERIFICATION REQUIRED:`);\n        console.error(`   From Email: ${fromEmail}`);\n        console.error(`   Solution 1 (Testing): Update Resend connector to use \"onboarding@resend.dev\"`);\n        console.error(`   Solution 2 (Production): Verify your domain at https://resend.com/domains`);\n      }\n      \n      return {\n        success: false,\n        error: errorMsg,\n      };\n    }\n\n    console.log(`[Email Service] Invoice email sent to ${resident.email} for bill #${bill.id}, Message ID: ${result.data?.id}`);\n\n    return {\n      success: true,\n      messageId: result.data?.id,\n    };\n  } catch (error) {\n    console.error(`[Email Service] Failed to send invoice email for bill #${bill.id}:`, error);\n    return {\n      success: false,\n      error: error instanceof Error ? error.message : 'Unknown error',\n    };\n  }\n}\n\nexport async function sendBulkInvoiceEmails(\n  bills: Bill[],\n  residents: Map<string, Resident>\n): Promise<{ sent: number; failed: number }> {\n  let sent = 0;\n  let failed = 0;\n\n  for (const bill of bills) {\n    const resident = residents.get(bill.residentId);\n    if (!resident) {\n      console.warn(`[Email Service] Resident not found for bill #${bill.id}`);\n      failed++;\n      continue;\n    }\n\n    if (!resident.email) {\n      console.warn(`[Email Service] No email address for resident #${resident.id}`);\n      failed++;\n      continue;\n    }\n\n    const result = await sendInvoiceEmail(bill, resident);\n    if (result.success) {\n      sent++;\n    } else {\n      failed++;\n    }\n\n    // Add small delay between emails to avoid rate limiting\n    await new Promise(resolve => setTimeout(resolve, 100));\n  }\n\n  console.log(`[Email Service] Bulk send completed: ${sent} sent, ${failed} failed`);\n  return { sent, failed };\n}\n","size_bytes":5179},"server/email-templates.ts":{"content":"import { format } from 'date-fns';\n\ninterface InvoiceData {\n  invoiceNumber: string;\n  dateIssued: Date;\n  residentName: string;\n  residentAddress: string;\n  userId: string;\n  invoiceDate: Date;\n  billingCycle: string;\n  monthsBilled: number;\n  billingPeriod: string;\n  amountDue: string;\n  paymentDueDate: Date;\n  periodStart: Date;\n  periodEnd: Date;\n}\n\nexport function generateInvoiceEmailHTML(data: InvoiceData): string {\n  return `\n<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"utf-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <title>Invoice ${data.invoiceNumber}</title>\n  <style>\n    body {\n      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;\n      line-height: 1.6;\n      color: #333;\n      max-width: 650px;\n      margin: 0 auto;\n      padding: 20px;\n      background-color: #f5f5f5;\n    }\n    .container {\n      background-color: white;\n      padding: 40px;\n      border-radius: 8px;\n      box-shadow: 0 2px 8px rgba(0,0,0,0.1);\n    }\n    .header {\n      text-align: right;\n      margin-bottom: 30px;\n      color: #2563eb;\n    }\n    .header h1 {\n      margin: 0;\n      font-size: 18px;\n      font-weight: 600;\n    }\n    .header .invoice-number {\n      font-size: 14px;\n      margin-top: 5px;\n    }\n    .header .date {\n      font-size: 14px;\n      color: #666;\n      margin-top: 3px;\n    }\n    .bill-to {\n      margin-bottom: 30px;\n    }\n    .bill-to h3 {\n      color: #2563eb;\n      font-size: 12px;\n      margin: 0 0 8px 0;\n      text-transform: uppercase;\n      letter-spacing: 0.5px;\n    }\n    .bill-to p {\n      margin: 3px 0;\n      font-size: 14px;\n    }\n    .greeting {\n      margin-bottom: 20px;\n      font-size: 14px;\n    }\n    .invoice-table {\n      width: 100%;\n      border-collapse: collapse;\n      margin: 25px 0;\n      background-color: #fafafa;\n    }\n    .invoice-table th {\n      background-color: #e5e7eb;\n      padding: 12px 8px;\n      text-align: left;\n      font-size: 12px;\n      font-weight: 600;\n      color: #374151;\n      border: 1px solid #d1d5db;\n    }\n    .invoice-table td {\n      padding: 12px 8px;\n      font-size: 13px;\n      border: 1px solid #d1d5db;\n    }\n    .period-info {\n      margin: 20px 0;\n      font-size: 14px;\n    }\n    .payment-reminder {\n      margin: 25px 0;\n      padding: 15px;\n      background-color: #fef3c7;\n      border-left: 4px solid #f59e0b;\n      font-size: 14px;\n    }\n    .payment-reminder strong {\n      color: #92400e;\n    }\n    .signature-section {\n      margin-top: 40px;\n      padding-top: 30px;\n      border-top: 2px solid #e5e7eb;\n    }\n    .signature-box {\n      display: inline-block;\n      width: 100px;\n      height: 100px;\n      background-color: #f3f4f6;\n      border: 1px solid #d1d5db;\n      text-align: center;\n      margin-bottom: 10px;\n    }\n    .signature-box svg {\n      width: 60px;\n      height: 60px;\n      margin-top: 20px;\n      fill: #6b7280;\n    }\n    .signature-info p {\n      margin: 3px 0;\n      font-size: 14px;\n    }\n    .bank-details {\n      margin-top: 25px;\n      padding: 15px;\n      background-color: #f9fafb;\n      border-radius: 6px;\n    }\n    .bank-details p {\n      margin: 5px 0;\n      font-size: 14px;\n    }\n    .bank-details strong {\n      display: inline-block;\n      min-width: 130px;\n    }\n    .thank-you {\n      margin-top: 30px;\n      font-size: 14px;\n      color: #666;\n    }\n    .footer {\n      margin-top: 40px;\n      padding-top: 20px;\n      border-top: 1px solid #e5e7eb;\n      text-align: center;\n      font-size: 12px;\n      color: #6b7280;\n    }\n  </style>\n</head>\n<body>\n  <div class=\"container\">\n    <div class=\"header\">\n      <h1>Invoice Number: ${data.invoiceNumber}</h1>\n      <div class=\"date\">Date Issued: ${format(data.dateIssued, 'dd-MM-yyyy')}</div>\n    </div>\n\n    <div class=\"bill-to\">\n      <h3>BILL TO:</h3>\n      <p><strong>${data.residentName}</strong></p>\n      <p>${data.residentAddress}</p>\n    </div>\n\n    <div class=\"greeting\">\n      <p>Dear ${data.residentName.split(' ')[0]},</p>\n      <p>Please find below the details of your service charge billing due for payment.</p>\n    </div>\n\n    <table class=\"invoice-table\">\n      <thead>\n        <tr>\n          <th>User ID</th>\n          <th>Invoice Date</th>\n          <th>Billing Cycle</th>\n          <th>Months Billed</th>\n          <th>Billing Period</th>\n          <th>Amount Due</th>\n          <th>Payment Due Date</th>\n        </tr>\n      </thead>\n      <tbody>\n        <tr>\n          <td>${data.userId}</td>\n          <td>${format(data.invoiceDate, 'dd-MM-yyyy')}</td>\n          <td>${data.billingCycle}</td>\n          <td>${data.monthsBilled}</td>\n          <td>${data.billingPeriod}</td>\n          <td><strong>₦${data.amountDue}</strong></td>\n          <td>${format(data.paymentDueDate, 'dd-MM-yyyy')}</td>\n        </tr>\n      </tbody>\n    </table>\n\n    <div class=\"period-info\">\n      <p>This bill covers the period from <strong>${format(data.periodStart, 'dd-MM-yyyy')}</strong> to <strong>${format(data.periodEnd, 'dd-MM-yyyy')}</strong></p>\n    </div>\n\n    <div class=\"payment-reminder\">\n      <p>Kindly make this payment on/before: <strong>${format(data.paymentDueDate, 'dd-MM-yyyy')}</strong></p>\n      <p style=\"margin-top: 10px;\">Thank you.</p>\n    </div>\n\n    <div class=\"signature-section\">\n      <div class=\"signature-box\">\n        <svg viewBox=\"0 0 24 24\" xmlns=\"http://www.w3.org/2000/svg\">\n          <path d=\"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z\"/>\n        </svg>\n      </div>\n      <div class=\"signature-info\">\n        <p><strong>Signed:</strong></p>\n        <p>Estate Management</p>\n        <p><strong>Magodo Estate</strong></p>\n      </div>\n    </div>\n\n    <div class=\"bank-details\">\n      <p><strong>Bank:</strong> GTB</p>\n      <p><strong>Account Name:</strong> Estate Service Account</p>\n      <p><strong>Account No:</strong> 34572950</p>\n    </div>\n\n    <div class=\"thank-you\">\n      <p>We appreciate your prompt payment. If you have any questions about this invoice, please contact the estate management office.</p>\n    </div>\n\n    <div class=\"footer\">\n      <p>Magodo Estate Management System</p>\n      <p>This is an automated email. Please do not reply directly to this message.</p>\n    </div>\n  </div>\n</body>\n</html>\n`;\n}\n\nexport function generateInvoiceEmailText(data: InvoiceData): string {\n  return `\nINVOICE: ${data.invoiceNumber}\nDate Issued: ${format(data.dateIssued, 'dd-MM-yyyy')}\n\nBILL TO:\n${data.residentName}\n${data.residentAddress}\n\nDear ${data.residentName.split(' ')[0]},\n\nPlease find below the details of your service charge billing due for payment.\n\nInvoice Details:\n- User ID: ${data.userId}\n- Invoice Date: ${format(data.invoiceDate, 'dd-MM-yyyy')}\n- Billing Cycle: ${data.billingCycle}\n- Months Billed: ${data.monthsBilled}\n- Billing Period: ${data.billingPeriod}\n- Amount Due: ₦${data.amountDue}\n- Payment Due Date: ${format(data.paymentDueDate, 'dd-MM-yyyy')}\n\nThis bill covers the period from ${format(data.periodStart, 'dd-MM-yyyy')} to ${format(data.periodEnd, 'dd-MM-yyyy')}\n\nPAYMENT REMINDER:\nKindly make this payment on/before: ${format(data.paymentDueDate, 'dd-MM-yyyy')}\n\nBANK DETAILS:\nBank: GTB\nAccount Name: Estate Service Account\nAccount No: 34572950\n\nThank you for your prompt payment.\n\n---\nSigned:\nEstate Management\nMagodo Estate\n\n---\nMagodo Estate Management System\nThis is an automated email. Please do not reply directly to this message.\n`;\n}\n","size_bytes":7445},"server/resend-client.ts":{"content":"import { Resend } from 'resend';\n\nlet connectionSettings: any;\n\nasync function getCredentials() {\n  const hostname = process.env.REPLIT_CONNECTORS_HOSTNAME;\n  const xReplitToken = process.env.REPL_IDENTITY \n    ? 'repl ' + process.env.REPL_IDENTITY \n    : process.env.WEB_REPL_RENEWAL \n    ? 'depl ' + process.env.WEB_REPL_RENEWAL \n    : null;\n\n  if (!xReplitToken) {\n    throw new Error('X_REPLIT_TOKEN not found for repl/depl');\n  }\n\n  connectionSettings = await fetch(\n    'https://' + hostname + '/api/v2/connection?include_secrets=true&connector_names=resend',\n    {\n      headers: {\n        'Accept': 'application/json',\n        'X_REPLIT_TOKEN': xReplitToken\n      }\n    }\n  ).then(res => res.json()).then(data => data.items?.[0]);\n\n  if (!connectionSettings || (!connectionSettings.settings.api_key)) {\n    throw new Error('Resend not connected');\n  }\n  return {apiKey: connectionSettings.settings.api_key, fromEmail: connectionSettings.settings.from_email};\n}\n\n// WARNING: Never cache this client.\n// Access tokens expire, so a new client must be created each time.\n// Always call this function again to get a fresh client.\nexport async function getUncachableResendClient() {\n  const credentials = await getCredentials();\n  return {\n    client: new Resend(credentials.apiKey),\n    fromEmail: connectionSettings.settings.from_email\n  };\n}\n","size_bytes":1347},"server/pdf-invoice.ts":{"content":"import PDFDocument from 'pdfkit';\nimport { format, addDays } from 'date-fns';\n\ninterface InvoiceData {\n  invoiceNumber: string;\n  invoiceDate: Date;\n  dueDate: Date;\n  residentName: string;\n  unitNumber: string;\n  userId: string;\n  billingPeriod: string;\n  description: string;\n  amount: string;\n  balance?: string;\n  totalPaid?: string;\n}\n\n// Helper function to format date as \"17-Sept-2025\"\nfunction formatInvoiceDate(date: Date): string {\n  return format(date, 'dd-MMM-yyyy');\n}\n\n// Helper function to format currency in Nigerian Naira\nfunction formatNGN(amount: string | number): string {\n  const numAmount = typeof amount === 'string' ? parseFloat(amount) : amount;\n  return `₦${numAmount.toLocaleString('en-NG', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;\n}\n\nexport function generateInvoicePDF(data: InvoiceData): Promise<Buffer> {\n  return new Promise((resolve, reject) => {\n    const doc = new PDFDocument({ size: 'A4', margin: 50 });\n    const buffers: Buffer[] = [];\n\n    doc.on('data', (buffer) => buffers.push(buffer));\n    doc.on('end', () => resolve(Buffer.concat(buffers)));\n    doc.on('error', reject);\n\n    try {\n      // Header - Estate Name\n      doc\n        .fillColor('#1e3a8a')\n        .fontSize(20)\n        .text('Magodo Estate Residents Association', 50, 50)\n        .fontSize(10)\n        .fillColor('#64748b')\n        .text('Estate Management Office', 50, 75)\n        .text('Lagos, Nigeria', 50, 90);\n\n      // Invoice Title\n      doc\n        .fillColor('#1e3a8a')\n        .fontSize(28)\n        .text('INVOICE', 400, 50, { align: 'right' });\n\n      // Invoice Details Box\n      const invoiceBoxTop = 120;\n      doc\n        .fontSize(10)\n        .fillColor('#334155')\n        .text('Invoice Number:', 400, invoiceBoxTop)\n        .font('Helvetica-Bold')\n        .fillColor('#1e3a8a')\n        .text(data.invoiceNumber, 400, invoiceBoxTop + 15)\n        .font('Helvetica')\n        .fillColor('#334155')\n        .text('Date Issued:', 400, invoiceBoxTop + 35)\n        .text(formatInvoiceDate(data.invoiceDate), 400, invoiceBoxTop + 50)\n        .text('Due Date:', 400, invoiceBoxTop + 70)\n        .font('Helvetica-Bold')\n        .fillColor('#dc2626')\n        .text(formatInvoiceDate(data.dueDate), 400, invoiceBoxTop + 85);\n\n      // Bill To Section\n      doc\n        .font('Helvetica')\n        .fillColor('#64748b')\n        .fontSize(9)\n        .text('BILL TO', 50, invoiceBoxTop);\n\n      doc\n        .font('Helvetica-Bold')\n        .fillColor('#0f172a')\n        .fontSize(14)\n        .text(data.residentName, 50, invoiceBoxTop + 15)\n        .font('Helvetica')\n        .fontSize(10)\n        .fillColor('#334155')\n        .text(`Unit ${data.unitNumber}`, 50, invoiceBoxTop + 35)\n        .text(`User ID: ${data.userId}`, 50, invoiceBoxTop + 50);\n\n      // Horizontal line\n      doc\n        .strokeColor('#e2e8f0')\n        .lineWidth(1)\n        .moveTo(50, 230)\n        .lineTo(545, 230)\n        .stroke();\n\n      // Personalized Greeting\n      const greetingTop = 250;\n      doc\n        .font('Helvetica')\n        .fillColor('#0f172a')\n        .fontSize(11)\n        .text(`Dear ${data.residentName},`, 50, greetingTop)\n        .fontSize(10)\n        .fillColor('#334155')\n        .text('Please find below the detail of your service charge billing due for payment:', 50, greetingTop + 20);\n\n      // Invoice Items Table Header\n      const tableTop = 295;\n      doc\n        .fillColor('#64748b')\n        .fontSize(9)\n        .text('DESCRIPTION', 50, tableTop)\n        .text('BILLING PERIOD', 280, tableTop)\n        .text('AMOUNT', 480, tableTop, { align: 'right' });\n\n      // Table header underline\n      doc\n        .strokeColor('#e2e8f0')\n        .lineWidth(1)\n        .moveTo(50, tableTop + 15)\n        .lineTo(545, tableTop + 15)\n        .stroke();\n\n      // Parse billing period to format dates\n      let formattedBillingPeriod = data.billingPeriod;\n      try {\n        // Try to parse the billing period if it's in a standard format\n        const periodMatch = data.billingPeriod.match(/(\\d{1,2}\\/\\d{1,2}\\/\\d{4})\\s*-\\s*(\\d{1,2}\\/\\d{1,2}\\/\\d{4})/);\n        if (periodMatch) {\n          const startDate = new Date(periodMatch[1]);\n          const endDate = new Date(periodMatch[2]);\n          formattedBillingPeriod = `${formatInvoiceDate(startDate)} - ${formatInvoiceDate(endDate)}`;\n        }\n      } catch (e) {\n        // Keep original format if parsing fails\n      }\n\n      // Invoice Item\n      const itemTop = tableTop + 30;\n      doc\n        .font('Helvetica')\n        .fillColor('#0f172a')\n        .fontSize(11)\n        .text(data.description, 50, itemTop, { width: 220 })\n        .text(formattedBillingPeriod, 280, itemTop, { width: 180 })\n        .font('Helvetica-Bold')\n        .fontSize(12)\n        .fillColor('#1e3a8a')\n        .text(formatNGN(data.amount), 445, itemTop, { align: 'right', width: 100 });\n\n      // Totals Section with improved shaded box\n      const totalsTop = itemTop + 80;\n      \n      // Shaded box for totals - increased width for better fit\n      doc\n        .rect(330, totalsTop - 10, 215, 90)\n        .fillAndStroke('#f8fafc', '#e2e8f0');\n\n      // Amount Due\n      doc\n        .font('Helvetica')\n        .fillColor('#64748b')\n        .fontSize(10)\n        .text('Amount Due:', 340, totalsTop)\n        .font('Helvetica-Bold')\n        .fillColor('#0f172a')\n        .fontSize(11)\n        .text(formatNGN(data.amount), 445, totalsTop, { align: 'right', width: 90 });\n\n      // Amount Paid (if any)\n      if (data.totalPaid && parseFloat(data.totalPaid) > 0) {\n        doc\n          .font('Helvetica')\n          .fillColor('#64748b')\n          .fontSize(10)\n          .text('Amount Paid:', 340, totalsTop + 25)\n          .fillColor('#16a34a')\n          .text(formatNGN(data.totalPaid), 445, totalsTop + 25, { align: 'right', width: 90 });\n      }\n\n      // Balance Due (if any)\n      if (data.balance) {\n        doc\n          .strokeColor('#1e3a8a')\n          .lineWidth(1)\n          .moveTo(340, totalsTop + 45)\n          .lineTo(535, totalsTop + 45)\n          .stroke();\n\n        doc\n          .font('Helvetica-Bold')\n          .fillColor('#1e3a8a')\n          .fontSize(11)\n          .text('Balance Due:', 340, totalsTop + 52)\n          .fontSize(13)\n          .text(formatNGN(data.balance), 445, totalsTop + 52, { align: 'right', width: 90 });\n      }\n\n      // Payment Instructions with dynamic due date\n      const paymentInstructionsTop = totalsTop + 120;\n      const paymentDueDate = addDays(data.invoiceDate, 7);\n      \n      doc\n        .font('Helvetica')\n        .fillColor('#0f172a')\n        .fontSize(10)\n        .text(\n          `Kindly make this payment on/before this date: ${formatInvoiceDate(paymentDueDate)}, and make sure to quote your invoice number ${data.invoiceNumber} in the reference section of your payment.`,\n          50,\n          paymentInstructionsTop,\n          { width: 495, align: 'left' }\n        );\n\n      // Bank Details Section\n      const bankDetailsTop = paymentInstructionsTop + 50;\n      doc\n        .fillColor('#64748b')\n        .fontSize(9)\n        .text('PAYMENT INFORMATION', 50, bankDetailsTop)\n        .font('Helvetica')\n        .fillColor('#334155')\n        .fontSize(10)\n        .text('Bank: Access Bank PLC', 50, bankDetailsTop + 20)\n        .text('Account Name: Magodo Estate Residents Association', 50, bankDetailsTop + 35)\n        .text('Account Number: 0123456789', 50, bankDetailsTop + 50);\n\n      // Footer\n      const footerTop = 750;\n      doc\n        .strokeColor('#e2e8f0')\n        .lineWidth(1)\n        .moveTo(50, footerTop)\n        .lineTo(545, footerTop)\n        .stroke();\n\n      doc\n        .fillColor('#64748b')\n        .fontSize(9)\n        .text('Thank you for your prompt payment.', 50, footerTop + 15, { align: 'center', width: 495 })\n        .text('For inquiries, contact: finance@magodoestate.ng | +234 800 000 0000', 50, footerTop + 30, { align: 'center', width: 495 });\n\n      doc.end();\n    } catch (error) {\n      reject(error);\n    }\n  });\n}\n","size_bytes":7990},"client/src/pages/admin/reports-center.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { useLocation } from \"wouter\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { \n  FileText, \n  TrendingUp, \n  Users, \n  DollarSign, \n  Calendar,\n  Download,\n  Eye,\n  BarChart3,\n  PieChart,\n  FileBarChart,\n  Clock,\n  UserCheck,\n  Receipt,\n  Wallet\n} from \"lucide-react\";\nimport { format } from \"date-fns\";\nimport { convertToCSV, downloadCSV, formatCurrencyForCSV, formatDateForCSV } from \"@/lib/csv-export\";\nimport { useToast } from \"@/hooks/use-toast\";\n\ntype ReportCategory = \"operational\" | \"financial\" | \"accounting\";\n\ninterface Report {\n  id: string;\n  title: string;\n  description: string;\n  category: ReportCategory;\n  icon: any;\n  endpoint: string;\n  isExternal?: boolean;\n  externalPath?: string;\n}\n\nconst reports: Report[] = [\n  // Operational Reports\n  {\n    id: \"visitor-activity\",\n    title: \"Visitor Activity Report\",\n    description: \"Summary of visitor entries, approvals, and access patterns\",\n    category: \"operational\",\n    icon: UserCheck,\n    endpoint: \"/api/admin/reports/visitor-activity\"\n  },\n  {\n    id: \"account-status\",\n    title: \"Resident Account Status\",\n    description: \"Overview of all resident accounts and their current status\",\n    category: \"operational\",\n    icon: Users,\n    endpoint: \"/api/admin/reports/account-status\"\n  },\n  {\n    id: \"overdue-bills\",\n    title: \"Overdue Bills Report\",\n    description: \"All bills past their due date with aging analysis\",\n    category: \"operational\",\n    icon: Clock,\n    endpoint: \"/api/admin/reports/overdue-bills\"\n  },\n  \n  // Financial Reports\n  {\n    id: \"collections-summary\",\n    title: \"Collections Summary\",\n    description: \"Total collections by period with payment method breakdown\",\n    category: \"financial\",\n    icon: DollarSign,\n    endpoint: \"/api/admin/reports/collections-summary\"\n  },\n  {\n    id: \"revenue-analysis\",\n    title: \"Revenue Analysis\",\n    description: \"Revenue trends, billing vs collections comparison\",\n    category: \"financial\",\n    icon: TrendingUp,\n    endpoint: \"/api/admin/reports/revenue-analysis\"\n  },\n  {\n    id: \"ar-aging\",\n    title: \"Accounts Receivable Aging\",\n    description: \"Outstanding receivables organized by aging buckets\",\n    category: \"financial\",\n    icon: Receipt,\n    endpoint: \"/api/admin/reports/ar-aging\"\n  },\n  {\n    id: \"cash-flow\",\n    title: \"Cash Flow Report\",\n    description: \"Cash inflows from collections, outflows from expenses, and net cash position\",\n    category: \"financial\",\n    icon: Wallet,\n    endpoint: \"/api/admin/reports/cash-flow\"\n  },\n  {\n    id: \"resident-service-charge-summary\",\n    title: \"Resident Service Charge Summary\",\n    description: \"Comprehensive view of service charges, payments, and outstanding balances per resident\",\n    category: \"financial\",\n    icon: Users,\n    endpoint: \"/api/admin/reports/resident-service-charge-summary\"\n  },\n  \n  // Accounting Reports\n  {\n    id: \"income-statement\",\n    title: \"Income Statement\",\n    description: \"Comprehensive profit & loss statement\",\n    category: \"accounting\",\n    icon: FileBarChart,\n    endpoint: \"\",\n    isExternal: true,\n    externalPath: \"/accountant/income-statement\"\n  },\n  {\n    id: \"balance-sheet\",\n    title: \"Balance Sheet\",\n    description: \"Assets, liabilities, and equity snapshot\",\n    category: \"accounting\",\n    icon: BarChart3,\n    endpoint: \"\",\n    isExternal: true,\n    externalPath: \"/accountant/balance-sheet\"\n  },\n  {\n    id: \"trial-balance\",\n    title: \"Trial Balance\",\n    description: \"List of all accounts with debit and credit balances\",\n    category: \"accounting\",\n    icon: FileText,\n    endpoint: \"\",\n    isExternal: true,\n    externalPath: \"/accountant/trial-balance\"\n  },\n  {\n    id: \"budget-performance\",\n    title: \"Budget Performance\",\n    description: \"Budget vs actual spending with variance analysis\",\n    category: \"accounting\",\n    icon: PieChart,\n    endpoint: \"/api/admin/reports/budget-performance\"\n  },\n  {\n    id: \"expense-report\",\n    title: \"Expense Report\",\n    description: \"Detailed listing of all expenses with vendor, category, approval and payment status\",\n    category: \"accounting\",\n    icon: Receipt,\n    endpoint: \"/api/admin/reports/expense-report\"\n  }\n];\n\nexport default function ReportsCenter() {\n  const [, setLocation] = useLocation();\n  const [selectedReport, setSelectedReport] = useState<Report | null>(null);\n  const [reportDialogOpen, setReportDialogOpen] = useState(false);\n  const [activeCategory, setActiveCategory] = useState<ReportCategory>(\"operational\");\n\n  const handleGenerateReport = (report: Report) => {\n    if (report.isExternal && report.externalPath) {\n      setLocation(report.externalPath);\n    } else {\n      setSelectedReport(report);\n      setReportDialogOpen(true);\n    }\n  };\n\n  const operationalReports = reports.filter(r => r.category === \"operational\");\n  const financialReports = reports.filter(r => r.category === \"financial\");\n  const accountingReports = reports.filter(r => r.category === \"accounting\");\n\n  return (\n    <div className=\"p-8 space-y-6\">\n      <div>\n        <h1 className=\"text-3xl font-bold\">Reports Center</h1>\n        <p className=\"text-muted-foreground mt-2\">\n          Generate operational, financial, and accounting reports for estate management\n        </p>\n      </div>\n\n      <Tabs value={activeCategory} onValueChange={(v) => setActiveCategory(v as ReportCategory)}>\n        <TabsList className=\"grid w-full max-w-md grid-cols-3\">\n          <TabsTrigger value=\"operational\" data-testid=\"tab-operational-reports\">\n            Operational\n            <Badge variant=\"secondary\" className=\"ml-2\">{operationalReports.length}</Badge>\n          </TabsTrigger>\n          <TabsTrigger value=\"financial\" data-testid=\"tab-financial-reports\">\n            Financial\n            <Badge variant=\"secondary\" className=\"ml-2\">{financialReports.length}</Badge>\n          </TabsTrigger>\n          <TabsTrigger value=\"accounting\" data-testid=\"tab-accounting-reports\">\n            Accounting\n            <Badge variant=\"secondary\" className=\"ml-2\">{accountingReports.length}</Badge>\n          </TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"operational\" className=\"space-y-4 mt-6\">\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n            {operationalReports.map((report) => (\n              <ReportCard\n                key={report.id}\n                report={report}\n                onGenerate={() => handleGenerateReport(report)}\n              />\n            ))}\n          </div>\n        </TabsContent>\n\n        <TabsContent value=\"financial\" className=\"space-y-4 mt-6\">\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n            {financialReports.map((report) => (\n              <ReportCard\n                key={report.id}\n                report={report}\n                onGenerate={() => handleGenerateReport(report)}\n              />\n            ))}\n          </div>\n        </TabsContent>\n\n        <TabsContent value=\"accounting\" className=\"space-y-4 mt-6\">\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n            {accountingReports.map((report) => (\n              <ReportCard\n                key={report.id}\n                report={report}\n                onGenerate={() => handleGenerateReport(report)}\n              />\n            ))}\n          </div>\n        </TabsContent>\n      </Tabs>\n\n      {/* Report Viewer Dialog */}\n      {selectedReport && !selectedReport.isExternal && (\n        <ReportViewerDialog\n          open={reportDialogOpen}\n          onOpenChange={setReportDialogOpen}\n          report={selectedReport}\n        />\n      )}\n    </div>\n  );\n}\n\nfunction ReportCard({ report, onGenerate }: { report: Report; onGenerate: () => void }) {\n  const Icon = report.icon;\n  \n  return (\n    <Card className=\"hover-elevate\" data-testid={`card-report-${report.id}`}>\n      <CardHeader>\n        <div className=\"flex items-start justify-between gap-2\">\n          <div className=\"flex items-center gap-3\">\n            <div className=\"p-2 rounded-lg bg-primary/10\">\n              <Icon className=\"h-5 w-5 text-primary\" />\n            </div>\n            <div className=\"flex-1\">\n              <CardTitle className=\"text-base\">{report.title}</CardTitle>\n            </div>\n          </div>\n        </div>\n        <CardDescription className=\"mt-2\">{report.description}</CardDescription>\n      </CardHeader>\n      <CardContent>\n        <Button\n          className=\"w-full\"\n          onClick={onGenerate}\n          data-testid={`button-generate-${report.id}`}\n        >\n          <Eye className=\"h-4 w-4 mr-2\" />\n          {report.isExternal ? \"View Report\" : \"Generate Report\"}\n        </Button>\n      </CardContent>\n    </Card>\n  );\n}\n\nfunction ReportViewerDialog({ \n  open, \n  onOpenChange, \n  report \n}: { \n  open: boolean; \n  onOpenChange: (open: boolean) => void; \n  report: Report;\n}) {\n  const { data, isLoading, error } = useQuery({\n    queryKey: [report.endpoint],\n    enabled: open && !!report.endpoint\n  });\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className=\"max-w-6xl max-h-[90vh] overflow-y-auto\" data-testid={`dialog-report-${report.id}`}>\n        <DialogHeader>\n          <DialogTitle>{report.title}</DialogTitle>\n          <DialogDescription>{report.description}</DialogDescription>\n        </DialogHeader>\n\n        <div className=\"space-y-4\">\n          {isLoading ? (\n            <div className=\"text-center py-12\">\n              <div className=\"animate-spin w-8 h-8 border-4 border-primary border-t-transparent rounded-full mx-auto\" />\n              <p className=\"mt-4 text-muted-foreground\">Generating report...</p>\n            </div>\n          ) : error ? (\n            <div className=\"text-center py-12 text-destructive\">\n              <p className=\"text-lg font-medium\">Error loading report</p>\n              <p className=\"text-sm mt-2\">Please try again later</p>\n            </div>\n          ) : (\n            <ReportRenderer report={report} data={data} />\n          )}\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}\n\nfunction ReportRenderer({ report, data }: { report: Report; data: any }) {\n  if (!data) {\n    return (\n      <div className=\"text-center py-12 text-muted-foreground\">\n        <FileText className=\"h-16 w-16 mx-auto mb-4 opacity-50\" />\n        <p>No data available for this report</p>\n      </div>\n    );\n  }\n\n  // Render different report types based on report ID\n  switch (report.id) {\n    case \"visitor-activity\":\n      return <VisitorActivityReport data={data} reportId={report.id} />;\n    case \"account-status\":\n      return <AccountStatusReport data={data} reportId={report.id} />;\n    case \"overdue-bills\":\n      return <OverdueBillsReport data={data} reportId={report.id} />;\n    case \"collections-summary\":\n      return <CollectionsSummaryReport data={data} reportId={report.id} />;\n    case \"revenue-analysis\":\n      return <RevenueAnalysisReport data={data} reportId={report.id} />;\n    case \"ar-aging\":\n      return <ARAgingReport data={data} reportId={report.id} />;\n    case \"cash-flow\":\n      return <CashFlowReport data={data} reportId={report.id} />;\n    case \"resident-service-charge-summary\":\n      return <ResidentServiceChargeSummaryReport data={data} />;\n    case \"budget-performance\":\n      return <BudgetPerformanceReport data={data} reportId={report.id} />;\n    case \"expense-report\":\n      return <ExpenseReportComponent data={data} />;\n    default:\n      return <GenericReport data={data} />;\n  }\n}\n\n// Individual Report Components\nfunction VisitorActivityReport({ data, reportId }: { data: any; reportId: string }) {\n  const { toast } = useToast();\n  \n  const handleExportCSV = () => {\n    if (!data.visitors || data.visitors.length === 0) {\n      toast({\n        title: \"No data to export\",\n        description: \"There are no visitor records to export.\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n    \n    const csvData = data.visitors.map((visitor: any) => ({\n      'Visitor Name': visitor.visitorName,\n      'Resident': visitor.residentName,\n      'Date': formatDateForCSV(visitor.visitDate),\n      'Status': visitor.status,\n      'Access Code': visitor.accessCode || ''\n    }));\n    \n    const csv = convertToCSV(csvData);\n    downloadCSV(csv, `visitor-activity-report-${new Date().toISOString().split('T')[0]}.csv`);\n  };\n\n  return (\n    <div className=\"space-y-4\">\n      <div className=\"flex justify-end\">\n        <Button onClick={handleExportCSV} variant=\"outline\" size=\"sm\" data-testid=\"button-download-csv\">\n          <Download className=\"h-4 w-4 mr-2\" />\n          Download CSV\n        </Button>\n      </div>\n      \n      <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardDescription>Total Visitors</CardDescription>\n            <CardTitle className=\"text-2xl\">{data.summary?.totalVisitors || 0}</CardTitle>\n          </CardHeader>\n        </Card>\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardDescription>Approved</CardDescription>\n            <CardTitle className=\"text-2xl text-green-600\">{data.summary?.approved || 0}</CardTitle>\n          </CardHeader>\n        </Card>\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardDescription>Pending</CardDescription>\n            <CardTitle className=\"text-2xl text-yellow-600\">{data.summary?.pending || 0}</CardTitle>\n          </CardHeader>\n        </Card>\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardDescription>Rejected</CardDescription>\n            <CardTitle className=\"text-2xl text-red-600\">{data.summary?.rejected || 0}</CardTitle>\n          </CardHeader>\n        </Card>\n      </div>\n\n      {data.visitors && data.visitors.length > 0 && (\n        <Card>\n          <CardHeader>\n            <CardTitle>Recent Visitor Activity</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <Table>\n              <TableHeader>\n                <TableRow>\n                  <TableHead>Visitor Name</TableHead>\n                  <TableHead>Resident</TableHead>\n                  <TableHead>Date</TableHead>\n                  <TableHead>Status</TableHead>\n                  <TableHead>Access Code</TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>\n                {data.visitors.map((visitor: any, idx: number) => (\n                  <TableRow key={idx}>\n                    <TableCell className=\"font-medium\">{visitor.visitorName}</TableCell>\n                    <TableCell>{visitor.residentName}</TableCell>\n                    <TableCell>{format(new Date(visitor.visitDate), 'MMM dd, yyyy')}</TableCell>\n                    <TableCell>\n                      <Badge variant={\n                        visitor.status === \"approved\" ? \"default\" : \n                        visitor.status === \"rejected\" ? \"destructive\" : \"secondary\"\n                      }>\n                        {visitor.status}\n                      </Badge>\n                    </TableCell>\n                    <TableCell className=\"font-mono text-xs\">{visitor.accessCode || \"—\"}</TableCell>\n                  </TableRow>\n                ))}\n              </TableBody>\n            </Table>\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  );\n}\n\nfunction AccountStatusReport({ data, reportId }: { data: any; reportId: string }) {\n  const { toast } = useToast();\n  \n  const handleExportCSV = () => {\n    if (!data.residents || data.residents.length === 0) {\n      toast({\n        title: \"No data to export\",\n        description: \"There are no resident records to export.\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n    \n    const csvData = data.residents.map((resident: any) => ({\n      'Name': resident.name,\n      'Unit': resident.unitNumber,\n      'Status': resident.accountStatus,\n      'Balance': formatCurrencyForCSV(resident.balance || 0),\n      'Overdue Bills': resident.overdueBills || 0\n    }));\n    \n    const csv = convertToCSV(csvData);\n    downloadCSV(csv, `account-status-report-${new Date().toISOString().split('T')[0]}.csv`);\n  };\n\n  return (\n    <div className=\"space-y-4\">\n      <div className=\"flex justify-end\">\n        <Button onClick={handleExportCSV} variant=\"outline\" size=\"sm\" data-testid=\"button-download-csv\">\n          <Download className=\"h-4 w-4 mr-2\" />\n          Download CSV\n        </Button>\n      </div>\n      \n      <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardDescription>Total Residents</CardDescription>\n            <CardTitle className=\"text-2xl\">{data.summary?.totalResidents || 0}</CardTitle>\n          </CardHeader>\n        </Card>\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardDescription>Active</CardDescription>\n            <CardTitle className=\"text-2xl text-green-600\">{data.summary?.active || 0}</CardTitle>\n          </CardHeader>\n        </Card>\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardDescription>Delinquent</CardDescription>\n            <CardTitle className=\"text-2xl text-red-600\">{data.summary?.delinquent || 0}</CardTitle>\n          </CardHeader>\n        </Card>\n      </div>\n\n      {data.residents && data.residents.length > 0 && (\n        <Card>\n          <CardHeader>\n            <CardTitle>Resident Details</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <Table>\n              <TableHeader>\n                <TableRow>\n                  <TableHead>Name</TableHead>\n                  <TableHead>Unit</TableHead>\n                  <TableHead>Status</TableHead>\n                  <TableHead>Balance</TableHead>\n                  <TableHead>Overdue Bills</TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>\n                {data.residents.map((resident: any, idx: number) => (\n                  <TableRow key={idx}>\n                    <TableCell className=\"font-medium\">{resident.name}</TableCell>\n                    <TableCell>{resident.unitNumber}</TableCell>\n                    <TableCell>\n                      <Badge variant={resident.accountStatus === \"active\" ? \"default\" : \"destructive\"}>\n                        {resident.accountStatus}\n                      </Badge>\n                    </TableCell>\n                    <TableCell className={resident.balance > 0 ? \"text-red-600 font-semibold\" : \"\"}>\n                      ₦{parseFloat(resident.balance || 0).toLocaleString('en-NG', { minimumFractionDigits: 2 })}\n                    </TableCell>\n                    <TableCell>{resident.overdueBills || 0}</TableCell>\n                  </TableRow>\n                ))}\n              </TableBody>\n            </Table>\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  );\n}\n\nfunction OverdueBillsReport({ data, reportId }: { data: any; reportId: string }) {\n  const { toast } = useToast();\n  \n  const handleExportCSV = () => {\n    if (!data.bills || data.bills.length === 0) {\n      toast({\n        title: \"No data to export\",\n        description: \"There are no overdue bills to export.\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n    \n    const csvData = data.bills.map((bill: any) => ({\n      'Resident': bill.residentName,\n      'Unit': bill.unitNumber,\n      'Description': bill.description,\n      'Amount': formatCurrencyForCSV(bill.amount),\n      'Due Date': formatDateForCSV(bill.dueDate),\n      'Days Overdue': bill.daysOverdue\n    }));\n    \n    const csv = convertToCSV(csvData);\n    downloadCSV(csv, `overdue-bills-report-${new Date().toISOString().split('T')[0]}.csv`);\n  };\n\n  return (\n    <div className=\"space-y-4\">\n      <div className=\"flex justify-end\">\n        <Button onClick={handleExportCSV} variant=\"outline\" size=\"sm\" data-testid=\"button-download-csv\">\n          <Download className=\"h-4 w-4 mr-2\" />\n          Download CSV\n        </Button>\n      </div>\n      \n      <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardDescription>Total Overdue</CardDescription>\n            <CardTitle className=\"text-2xl text-red-600\">\n              ₦{parseFloat(data.summary?.totalOverdue || 0).toLocaleString('en-NG', { minimumFractionDigits: 2 })}\n            </CardTitle>\n          </CardHeader>\n        </Card>\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardDescription>0-30 Days</CardDescription>\n            <CardTitle className=\"text-xl\">\n              ₦{parseFloat(data.summary?.aging_0_30 || 0).toLocaleString('en-NG', { minimumFractionDigits: 2 })}\n            </CardTitle>\n          </CardHeader>\n        </Card>\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardDescription>31-60 Days</CardDescription>\n            <CardTitle className=\"text-xl\">\n              ₦{parseFloat(data.summary?.aging_31_60 || 0).toLocaleString('en-NG', { minimumFractionDigits: 2 })}\n            </CardTitle>\n          </CardHeader>\n        </Card>\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardDescription>60+ Days</CardDescription>\n            <CardTitle className=\"text-xl\">\n              ₦{parseFloat(data.summary?.aging_60_plus || 0).toLocaleString('en-NG', { minimumFractionDigits: 2 })}\n            </CardTitle>\n          </CardHeader>\n        </Card>\n      </div>\n\n      {data.bills && data.bills.length > 0 && (\n        <Card>\n          <CardHeader>\n            <CardTitle>Overdue Bill Details</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <Table>\n              <TableHeader>\n                <TableRow>\n                  <TableHead>Resident</TableHead>\n                  <TableHead>Unit</TableHead>\n                  <TableHead>Description</TableHead>\n                  <TableHead>Amount</TableHead>\n                  <TableHead>Due Date</TableHead>\n                  <TableHead>Days Overdue</TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>\n                {data.bills.map((bill: any, idx: number) => (\n                  <TableRow key={idx}>\n                    <TableCell className=\"font-medium\">{bill.residentName}</TableCell>\n                    <TableCell>{bill.unitNumber}</TableCell>\n                    <TableCell>{bill.description}</TableCell>\n                    <TableCell className=\"font-semibold\">\n                      ₦{parseFloat(bill.amount).toLocaleString('en-NG', { minimumFractionDigits: 2 })}\n                    </TableCell>\n                    <TableCell>{format(new Date(bill.dueDate), 'MMM dd, yyyy')}</TableCell>\n                    <TableCell>\n                      <Badge variant=\"destructive\">{bill.daysOverdue} days</Badge>\n                    </TableCell>\n                  </TableRow>\n                ))}\n              </TableBody>\n            </Table>\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  );\n}\n\nfunction CollectionsSummaryReport({ data, reportId }: { data: any; reportId: string }) {\n  const { toast } = useToast();\n  \n  const handleExportCSV = () => {\n    if (!data.byMethod || data.byMethod.length === 0) {\n      toast({\n        title: \"No data to export\",\n        description: \"There are no collection records to export.\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n    \n    const csvData = data.byMethod.map((method: any) => ({\n      'Payment Method': method.paymentMethod,\n      'Amount': formatCurrencyForCSV(method.total),\n      'Count': method.count,\n      'Percentage': method.percentage\n    }));\n    \n    const csv = convertToCSV(csvData);\n    downloadCSV(csv, `collections-summary-report-${new Date().toISOString().split('T')[0]}.csv`);\n  };\n\n  return (\n    <div className=\"space-y-4\">\n      <div className=\"flex justify-end\">\n        <Button onClick={handleExportCSV} variant=\"outline\" size=\"sm\" data-testid=\"button-download-csv\">\n          <Download className=\"h-4 w-4 mr-2\" />\n          Download CSV\n        </Button>\n      </div>\n      \n      <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardDescription>Total Collections</CardDescription>\n            <CardTitle className=\"text-2xl text-green-600\">\n              ₦{parseFloat(data.summary?.totalCollections || 0).toLocaleString('en-NG', { minimumFractionDigits: 2 })}\n            </CardTitle>\n          </CardHeader>\n        </Card>\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardDescription>Number of Payments</CardDescription>\n            <CardTitle className=\"text-2xl\">{data.summary?.paymentCount || 0}</CardTitle>\n          </CardHeader>\n        </Card>\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardDescription>Average Payment</CardDescription>\n            <CardTitle className=\"text-2xl\">\n              ₦{parseFloat(data.summary?.averagePayment || 0).toLocaleString('en-NG', { minimumFractionDigits: 2 })}\n            </CardTitle>\n          </CardHeader>\n        </Card>\n      </div>\n\n      {data.byMethod && data.byMethod.length > 0 && (\n        <Card>\n          <CardHeader>\n            <CardTitle>Collections by Payment Method</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <Table>\n              <TableHeader>\n                <TableRow>\n                  <TableHead>Payment Method</TableHead>\n                  <TableHead className=\"text-right\">Amount</TableHead>\n                  <TableHead className=\"text-right\">Count</TableHead>\n                  <TableHead className=\"text-right\">Percentage</TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>\n                {data.byMethod.map((method: any, idx: number) => (\n                  <TableRow key={idx}>\n                    <TableCell className=\"font-medium capitalize\">{method.paymentMethod}</TableCell>\n                    <TableCell className=\"text-right font-semibold\">\n                      ₦{parseFloat(method.total).toLocaleString('en-NG', { minimumFractionDigits: 2 })}\n                    </TableCell>\n                    <TableCell className=\"text-right\">{method.count}</TableCell>\n                    <TableCell className=\"text-right\">{method.percentage}%</TableCell>\n                  </TableRow>\n                ))}\n              </TableBody>\n            </Table>\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  );\n}\n\nfunction RevenueAnalysisReport({ data, reportId }: { data: any; reportId: string }) {\n  const { toast } = useToast();\n  \n  const handleExportCSV = () => {\n    if (!data.monthly || data.monthly.length === 0) {\n      toast({\n        title: \"No data to export\",\n        description: \"There are no monthly revenue records to export.\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n    \n    const csvData = data.monthly.map((month: any) => ({\n      'Month': month.month,\n      'Billed': formatCurrencyForCSV(month.billed),\n      'Collected': formatCurrencyForCSV(month.collected),\n      'Collection Rate (%)': month.collectionRate\n    }));\n    \n    const csv = convertToCSV(csvData);\n    downloadCSV(csv, `revenue-analysis-report-${new Date().toISOString().split('T')[0]}.csv`);\n  };\n\n  return (\n    <div className=\"space-y-4\">\n      <div className=\"flex justify-end\">\n        <Button onClick={handleExportCSV} variant=\"outline\" size=\"sm\" data-testid=\"button-download-csv\">\n          <Download className=\"h-4 w-4 mr-2\" />\n          Download CSV\n        </Button>\n      </div>\n      \n      <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardDescription>Total Billed</CardDescription>\n            <CardTitle className=\"text-2xl\">\n              ₦{parseFloat(data.summary?.totalBilled || 0).toLocaleString('en-NG', { minimumFractionDigits: 2 })}\n            </CardTitle>\n          </CardHeader>\n        </Card>\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardDescription>Total Collected</CardDescription>\n            <CardTitle className=\"text-2xl text-green-600\">\n              ₦{parseFloat(data.summary?.totalCollected || 0).toLocaleString('en-NG', { minimumFractionDigits: 2 })}\n            </CardTitle>\n          </CardHeader>\n        </Card>\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardDescription>Collection Rate</CardDescription>\n            <CardTitle className=\"text-2xl\">{data.summary?.collectionRate || 0}%</CardTitle>\n          </CardHeader>\n        </Card>\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardDescription>Outstanding</CardDescription>\n            <CardTitle className=\"text-2xl text-red-600\">\n              ₦{parseFloat(data.summary?.outstanding || 0).toLocaleString('en-NG', { minimumFractionDigits: 2 })}\n            </CardTitle>\n          </CardHeader>\n        </Card>\n      </div>\n\n      {data.monthly && data.monthly.length > 0 && (\n        <Card>\n          <CardHeader>\n            <CardTitle>Monthly Revenue Trends</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <Table>\n              <TableHeader>\n                <TableRow>\n                  <TableHead>Month</TableHead>\n                  <TableHead className=\"text-right\">Billed</TableHead>\n                  <TableHead className=\"text-right\">Collected</TableHead>\n                  <TableHead className=\"text-right\">Collection %</TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>\n                {data.monthly.map((month: any, idx: number) => (\n                  <TableRow key={idx}>\n                    <TableCell className=\"font-medium\">{month.month}</TableCell>\n                    <TableCell className=\"text-right\">\n                      ₦{parseFloat(month.billed).toLocaleString('en-NG', { minimumFractionDigits: 2 })}\n                    </TableCell>\n                    <TableCell className=\"text-right text-green-600 font-semibold\">\n                      ₦{parseFloat(month.collected).toLocaleString('en-NG', { minimumFractionDigits: 2 })}\n                    </TableCell>\n                    <TableCell className=\"text-right\">{month.collectionRate}%</TableCell>\n                  </TableRow>\n                ))}\n              </TableBody>\n            </Table>\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  );\n}\n\nfunction ARAgingReport({ data, reportId }: { data: any; reportId: string }) {\n  const { toast } = useToast();\n  \n  const handleExportCSV = () => {\n    if (!data.details || data.details.length === 0) {\n      toast({\n        title: \"No data to export\",\n        description: \"There are no aging details to export.\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n    \n    const csvData = data.details.map((detail: any) => ({\n      'Resident': detail.residentName,\n      'Unit': detail.unitNumber,\n      'Current': formatCurrencyForCSV(detail.current || 0),\n      '1-30 Days': formatCurrencyForCSV(detail.days_1_30 || 0),\n      '31-60 Days': formatCurrencyForCSV(detail.days_31_60 || 0),\n      '60+ Days': formatCurrencyForCSV(detail.days_60_plus || 0),\n      'Total': formatCurrencyForCSV(detail.total || 0)\n    }));\n    \n    const csv = convertToCSV(csvData);\n    downloadCSV(csv, `ar-aging-report-${new Date().toISOString().split('T')[0]}.csv`);\n  };\n\n  return (\n    <div className=\"space-y-4\">\n      <div className=\"flex justify-end\">\n        <Button onClick={handleExportCSV} variant=\"outline\" size=\"sm\" data-testid=\"button-download-csv\">\n          <Download className=\"h-4 w-4 mr-2\" />\n          Download CSV\n        </Button>\n      </div>\n      \n      <div className=\"grid grid-cols-1 md:grid-cols-5 gap-4\">\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardDescription>Total AR</CardDescription>\n            <CardTitle className=\"text-xl\">\n              ₦{parseFloat(data.summary?.totalAR || 0).toLocaleString('en-NG', { minimumFractionDigits: 2 })}\n            </CardTitle>\n          </CardHeader>\n        </Card>\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardDescription>Current</CardDescription>\n            <CardTitle className=\"text-xl text-green-600\">\n              ₦{parseFloat(data.summary?.current || 0).toLocaleString('en-NG', { minimumFractionDigits: 2 })}\n            </CardTitle>\n          </CardHeader>\n        </Card>\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardDescription>1-30 Days</CardDescription>\n            <CardTitle className=\"text-xl\">\n              ₦{parseFloat(data.summary?.days_1_30 || 0).toLocaleString('en-NG', { minimumFractionDigits: 2 })}\n            </CardTitle>\n          </CardHeader>\n        </Card>\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardDescription>31-60 Days</CardDescription>\n            <CardTitle className=\"text-xl text-yellow-600\">\n              ₦{parseFloat(data.summary?.days_31_60 || 0).toLocaleString('en-NG', { minimumFractionDigits: 2 })}\n            </CardTitle>\n          </CardHeader>\n        </Card>\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardDescription>60+ Days</CardDescription>\n            <CardTitle className=\"text-xl text-red-600\">\n              ₦{parseFloat(data.summary?.days_60_plus || 0).toLocaleString('en-NG', { minimumFractionDigits: 2 })}\n            </CardTitle>\n          </CardHeader>\n        </Card>\n      </div>\n\n      {data.details && data.details.length > 0 && (\n        <Card>\n          <CardHeader>\n            <CardTitle>Aging Details by Resident</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <Table>\n              <TableHeader>\n                <TableRow>\n                  <TableHead>Resident</TableHead>\n                  <TableHead>Unit</TableHead>\n                  <TableHead className=\"text-right\">Current</TableHead>\n                  <TableHead className=\"text-right\">1-30 Days</TableHead>\n                  <TableHead className=\"text-right\">31-60 Days</TableHead>\n                  <TableHead className=\"text-right\">60+ Days</TableHead>\n                  <TableHead className=\"text-right\">Total</TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>\n                {data.details.map((detail: any, idx: number) => (\n                  <TableRow key={idx}>\n                    <TableCell className=\"font-medium\">{detail.residentName}</TableCell>\n                    <TableCell>{detail.unitNumber}</TableCell>\n                    <TableCell className=\"text-right\">\n                      ₦{parseFloat(detail.current || 0).toLocaleString('en-NG', { minimumFractionDigits: 2 })}\n                    </TableCell>\n                    <TableCell className=\"text-right\">\n                      ₦{parseFloat(detail.days_1_30 || 0).toLocaleString('en-NG', { minimumFractionDigits: 2 })}\n                    </TableCell>\n                    <TableCell className=\"text-right\">\n                      ₦{parseFloat(detail.days_31_60 || 0).toLocaleString('en-NG', { minimumFractionDigits: 2 })}\n                    </TableCell>\n                    <TableCell className=\"text-right\">\n                      ₦{parseFloat(detail.days_60_plus || 0).toLocaleString('en-NG', { minimumFractionDigits: 2 })}\n                    </TableCell>\n                    <TableCell className=\"text-right font-semibold\">\n                      ₦{parseFloat(detail.total || 0).toLocaleString('en-NG', { minimumFractionDigits: 2 })}\n                    </TableCell>\n                  </TableRow>\n                ))}\n              </TableBody>\n            </Table>\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  );\n}\n\nfunction CashFlowReport({ data, reportId }: { data: any; reportId: string }) {\n  const { toast } = useToast();\n  \n  const handleExportCSV = () => {\n    if (!data.monthly || data.monthly.length === 0) {\n      toast({\n        title: \"No data to export\",\n        description: \"There are no monthly cash flow records to export.\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n    \n    const csvData = data.monthly.map((month: any) => ({\n      'Month': month.month,\n      'Inflows': formatCurrencyForCSV(month.inflows),\n      'Outflows': formatCurrencyForCSV(month.outflows),\n      'Net Cash Flow': formatCurrencyForCSV(month.netCashFlow)\n    }));\n    \n    const csv = convertToCSV(csvData);\n    downloadCSV(csv, `cash-flow-report-${new Date().toISOString().split('T')[0]}.csv`);\n  };\n\n  return (\n    <div className=\"space-y-4\">\n      <div className=\"flex justify-end\">\n        <Button onClick={handleExportCSV} variant=\"outline\" size=\"sm\" data-testid=\"button-download-csv\">\n          <Download className=\"h-4 w-4 mr-2\" />\n          Download CSV\n        </Button>\n      </div>\n      \n      <div className=\"grid grid-cols-1 md:grid-cols-5 gap-4\">\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardDescription>Opening Balance</CardDescription>\n            <CardTitle className=\"text-xl\">\n              ₦{parseFloat(data.summary?.openingBalance || 0).toLocaleString('en-NG', { minimumFractionDigits: 2 })}\n            </CardTitle>\n          </CardHeader>\n        </Card>\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardDescription>Cash Inflows</CardDescription>\n            <CardTitle className=\"text-xl text-green-600\">\n              ₦{parseFloat(data.summary?.totalInflows || 0).toLocaleString('en-NG', { minimumFractionDigits: 2 })}\n            </CardTitle>\n          </CardHeader>\n        </Card>\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardDescription>Cash Outflows</CardDescription>\n            <CardTitle className=\"text-xl text-red-600\">\n              ₦{parseFloat(data.summary?.totalOutflows || 0).toLocaleString('en-NG', { minimumFractionDigits: 2 })}\n            </CardTitle>\n          </CardHeader>\n        </Card>\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardDescription>Net Cash Flow</CardDescription>\n            <CardTitle className={`text-xl ${parseFloat(data.summary?.netCashFlow || 0) >= 0 ? 'text-green-600' : 'text-red-600'}`}>\n              ₦{parseFloat(data.summary?.netCashFlow || 0).toLocaleString('en-NG', { minimumFractionDigits: 2 })}\n            </CardTitle>\n          </CardHeader>\n        </Card>\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardDescription>Closing Balance</CardDescription>\n            <CardTitle className=\"text-xl font-bold\">\n              ₦{parseFloat(data.summary?.closingBalance || 0).toLocaleString('en-NG', { minimumFractionDigits: 2 })}\n            </CardTitle>\n          </CardHeader>\n        </Card>\n      </div>\n\n      {data.monthly && data.monthly.length > 0 && (\n        <Card>\n          <CardHeader>\n            <CardTitle>Monthly Cash Flow Trends</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <Table>\n              <TableHeader>\n                <TableRow>\n                  <TableHead>Month</TableHead>\n                  <TableHead className=\"text-right\">Inflows</TableHead>\n                  <TableHead className=\"text-right\">Outflows</TableHead>\n                  <TableHead className=\"text-right\">Net Cash Flow</TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>\n                {data.monthly.map((month: any, idx: number) => (\n                  <TableRow key={idx}>\n                    <TableCell className=\"font-medium\">{month.month}</TableCell>\n                    <TableCell className=\"text-right text-green-600\">\n                      ₦{parseFloat(month.inflows).toLocaleString('en-NG', { minimumFractionDigits: 2 })}\n                    </TableCell>\n                    <TableCell className=\"text-right text-red-600\">\n                      ₦{parseFloat(month.outflows).toLocaleString('en-NG', { minimumFractionDigits: 2 })}\n                    </TableCell>\n                    <TableCell className={`text-right font-semibold ${month.netCashFlow >= 0 ? 'text-green-600' : 'text-red-600'}`}>\n                      ₦{parseFloat(month.netCashFlow).toLocaleString('en-NG', { minimumFractionDigits: 2 })}\n                    </TableCell>\n                  </TableRow>\n                ))}\n              </TableBody>\n            </Table>\n          </CardContent>\n        </Card>\n      )}\n\n      {data.detailedInflows && data.detailedInflows.length > 0 && (\n        <Card>\n          <CardHeader>\n            <CardTitle>Cash Inflows Details (Collections)</CardTitle>\n            <CardDescription>{data.summary?.inflowCount || 0} payment transactions</CardDescription>\n          </CardHeader>\n          <CardContent>\n            <Table>\n              <TableHeader>\n                <TableRow>\n                  <TableHead>Date</TableHead>\n                  <TableHead>Resident</TableHead>\n                  <TableHead>Unit</TableHead>\n                  <TableHead>Description</TableHead>\n                  <TableHead>Payment Method</TableHead>\n                  <TableHead className=\"text-right\">Amount</TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>\n                {data.detailedInflows.slice(0, 20).map((inflow: any, idx: number) => (\n                  <TableRow key={idx}>\n                    <TableCell>{format(new Date(inflow.date), 'dd MMM yyyy')}</TableCell>\n                    <TableCell className=\"font-medium\">{inflow.residentName}</TableCell>\n                    <TableCell>{inflow.unitNumber}</TableCell>\n                    <TableCell>{inflow.description}</TableCell>\n                    <TableCell className=\"text-xs\">{inflow.paymentMethod}</TableCell>\n                    <TableCell className=\"text-right text-green-600 font-semibold\">\n                      ₦{parseFloat(inflow.amount).toLocaleString('en-NG', { minimumFractionDigits: 2 })}\n                    </TableCell>\n                  </TableRow>\n                ))}\n              </TableBody>\n            </Table>\n            {data.detailedInflows.length > 20 && (\n              <p className=\"text-sm text-muted-foreground mt-2 text-center\">\n                Showing first 20 of {data.detailedInflows.length} transactions\n              </p>\n            )}\n          </CardContent>\n        </Card>\n      )}\n\n      {data.detailedOutflows && data.detailedOutflows.length > 0 && (\n        <Card>\n          <CardHeader>\n            <CardTitle>Cash Outflows Details (Expenses)</CardTitle>\n            <CardDescription>{data.summary?.outflowCount || 0} paid expense transactions</CardDescription>\n          </CardHeader>\n          <CardContent>\n            <Table>\n              <TableHeader>\n                <TableRow>\n                  <TableHead>Date</TableHead>\n                  <TableHead>Vendor</TableHead>\n                  <TableHead>Description</TableHead>\n                  <TableHead>Category</TableHead>\n                  <TableHead className=\"text-right\">WHT</TableHead>\n                  <TableHead className=\"text-right\">Net Paid</TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>\n                {data.detailedOutflows.slice(0, 20).map((outflow: any, idx: number) => (\n                  <TableRow key={idx}>\n                    <TableCell>{format(new Date(outflow.date), 'dd MMM yyyy')}</TableCell>\n                    <TableCell className=\"font-medium\">{outflow.vendor}</TableCell>\n                    <TableCell>{outflow.description}</TableCell>\n                    <TableCell className=\"text-xs\">{outflow.category}</TableCell>\n                    <TableCell className=\"text-right text-xs\">\n                      ₦{parseFloat(outflow.whtAmount).toLocaleString('en-NG', { minimumFractionDigits: 2 })}\n                    </TableCell>\n                    <TableCell className=\"text-right text-red-600 font-semibold\">\n                      ₦{parseFloat(outflow.amount).toLocaleString('en-NG', { minimumFractionDigits: 2 })}\n                    </TableCell>\n                  </TableRow>\n                ))}\n              </TableBody>\n            </Table>\n            {data.detailedOutflows.length > 20 && (\n              <p className=\"text-sm text-muted-foreground mt-2 text-center\">\n                Showing first 20 of {data.detailedOutflows.length} transactions\n              </p>\n            )}\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  );\n}\n\nfunction BudgetPerformanceReport({ data, reportId }: { data: any; reportId: string }) {\n  const { toast } = useToast();\n  \n  const handleExportCSV = () => {\n    if (!data.categories || data.categories.length === 0) {\n      toast({\n        title: \"No data to export\",\n        description: \"There are no budget categories to export.\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n    \n    const csvData = data.categories.map((category: any) => ({\n      'Category': category.name,\n      'Budget': formatCurrencyForCSV(category.budget),\n      'Actual': formatCurrencyForCSV(category.actual),\n      'Variance': formatCurrencyForCSV(category.variance),\n      'Percent Used': category.percentUsed\n    }));\n    \n    const csv = convertToCSV(csvData);\n    downloadCSV(csv, `budget-performance-report-${new Date().toISOString().split('T')[0]}.csv`);\n  };\n\n  return (\n    <div className=\"space-y-4\">\n      <div className=\"flex justify-end\">\n        <Button onClick={handleExportCSV} variant=\"outline\" size=\"sm\" data-testid=\"button-download-csv\">\n          <Download className=\"h-4 w-4 mr-2\" />\n          Download CSV\n        </Button>\n      </div>\n      \n      <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardDescription>Total Budget</CardDescription>\n            <CardTitle className=\"text-2xl\">\n              ₦{parseFloat(data.summary?.totalBudget || 0).toLocaleString('en-NG', { minimumFractionDigits: 2 })}\n            </CardTitle>\n          </CardHeader>\n        </Card>\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardDescription>Actual Spent</CardDescription>\n            <CardTitle className=\"text-2xl\">\n              ₦{parseFloat(data.summary?.actualSpent || 0).toLocaleString('en-NG', { minimumFractionDigits: 2 })}\n            </CardTitle>\n          </CardHeader>\n        </Card>\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardDescription>Variance</CardDescription>\n            <CardTitle className={`text-2xl ${(data.summary?.variance || 0) < 0 ? 'text-red-600' : 'text-green-600'}`}>\n              ₦{parseFloat(data.summary?.variance || 0).toLocaleString('en-NG', { minimumFractionDigits: 2 })}\n            </CardTitle>\n          </CardHeader>\n        </Card>\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardDescription>Utilization</CardDescription>\n            <CardTitle className=\"text-2xl\">{data.summary?.utilization || 0}%</CardTitle>\n          </CardHeader>\n        </Card>\n      </div>\n\n      {data.categories && data.categories.length > 0 && (\n        <Card>\n          <CardHeader>\n            <CardTitle>Budget vs Actual by Category</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <Table>\n              <TableHeader>\n                <TableRow>\n                  <TableHead>Category</TableHead>\n                  <TableHead className=\"text-right\">Budget</TableHead>\n                  <TableHead className=\"text-right\">Actual</TableHead>\n                  <TableHead className=\"text-right\">Variance</TableHead>\n                  <TableHead className=\"text-right\">% Used</TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>\n                {data.categories.map((category: any, idx: number) => (\n                  <TableRow key={idx}>\n                    <TableCell className=\"font-medium\">{category.name}</TableCell>\n                    <TableCell className=\"text-right\">\n                      ₦{parseFloat(category.budget).toLocaleString('en-NG', { minimumFractionDigits: 2 })}\n                    </TableCell>\n                    <TableCell className=\"text-right\">\n                      ₦{parseFloat(category.actual).toLocaleString('en-NG', { minimumFractionDigits: 2 })}\n                    </TableCell>\n                    <TableCell className={`text-right font-semibold ${category.variance < 0 ? 'text-red-600' : 'text-green-600'}`}>\n                      ₦{parseFloat(category.variance).toLocaleString('en-NG', { minimumFractionDigits: 2 })}\n                    </TableCell>\n                    <TableCell className=\"text-right\">{category.percentUsed}%</TableCell>\n                  </TableRow>\n                ))}\n              </TableBody>\n            </Table>\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  );\n}\n\nfunction ResidentServiceChargeSummaryReport({ data }: { data: any }) {\n  const handleExportCSV = () => {\n    window.location.href = '/api/admin/reports/resident-service-charge-summary/export';\n  };\n\n  return (\n    <div className=\"space-y-4\">\n      <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardDescription>Total Residents</CardDescription>\n            <CardTitle className=\"text-2xl\">{data.summary?.totalResidents || 0}</CardTitle>\n          </CardHeader>\n        </Card>\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardDescription>Total Service Charge</CardDescription>\n            <CardTitle className=\"text-xl\">\n              ₦{parseFloat(data.summary?.totalServiceCharge || 0).toLocaleString('en-NG', { minimumFractionDigits: 2 })}\n            </CardTitle>\n          </CardHeader>\n        </Card>\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardDescription>Amount Paid</CardDescription>\n            <CardTitle className=\"text-xl text-green-600\">\n              ₦{parseFloat(data.summary?.totalAmountPaid || 0).toLocaleString('en-NG', { minimumFractionDigits: 2 })}\n            </CardTitle>\n          </CardHeader>\n        </Card>\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardDescription>Outstanding Balance</CardDescription>\n            <CardTitle className=\"text-xl text-red-600\">\n              ₦{parseFloat(data.summary?.totalOutstanding || 0).toLocaleString('en-NG', { minimumFractionDigits: 2 })}\n            </CardTitle>\n          </CardHeader>\n        </Card>\n      </div>\n\n      <div className=\"flex justify-end\">\n        <Button onClick={handleExportCSV} variant=\"outline\" data-testid=\"button-export-csv\">\n          <Download className=\"h-4 w-4 mr-2\" />\n          Export to CSV\n        </Button>\n      </div>\n\n      {data.residents && data.residents.length > 0 && (\n        <Card>\n          <CardHeader>\n            <CardTitle>Resident Service Charge Details</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <Table>\n              <TableHeader>\n                <TableRow>\n                  <TableHead>Resident</TableHead>\n                  <TableHead>House No</TableHead>\n                  <TableHead>Phone</TableHead>\n                  <TableHead className=\"text-right\">Total Service Charge</TableHead>\n                  <TableHead className=\"text-right\">Amount Paid</TableHead>\n                  <TableHead className=\"text-right\">Outstanding Balance</TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>\n                {data.residents.map((resident: any, idx: number) => (\n                  <TableRow key={idx}>\n                    <TableCell className=\"font-medium\">{resident.resident}</TableCell>\n                    <TableCell>{resident.houseNo}</TableCell>\n                    <TableCell>{resident.phone}</TableCell>\n                    <TableCell className=\"text-right\">\n                      ₦{parseFloat(resident.totalServiceCharge).toLocaleString('en-NG', { minimumFractionDigits: 2 })}\n                    </TableCell>\n                    <TableCell className=\"text-right text-green-600\">\n                      ₦{parseFloat(resident.amountPaid).toLocaleString('en-NG', { minimumFractionDigits: 2 })}\n                    </TableCell>\n                    <TableCell className=\"text-right font-semibold text-red-600\">\n                      ₦{parseFloat(resident.outstandingBalance).toLocaleString('en-NG', { minimumFractionDigits: 2 })}\n                    </TableCell>\n                  </TableRow>\n                ))}\n              </TableBody>\n            </Table>\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  );\n}\n\nfunction ExpenseReportComponent({ data }: { data: any }) {\n  const handleExportCSV = () => {\n    window.location.href = '/api/admin/reports/expense-report/export';\n  };\n\n  return (\n    <div className=\"space-y-4\">\n      <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardDescription>Total Expenses</CardDescription>\n            <CardTitle className=\"text-2xl\">{data.summary?.totalExpenses || 0}</CardTitle>\n          </CardHeader>\n        </Card>\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardDescription>Total Amount</CardDescription>\n            <CardTitle className=\"text-xl\">\n              ₦{parseFloat(data.summary?.totalAmount || 0).toLocaleString('en-NG', { minimumFractionDigits: 2 })}\n            </CardTitle>\n          </CardHeader>\n        </Card>\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardDescription>Paid Amount</CardDescription>\n            <CardTitle className=\"text-xl text-green-600\">\n              ₦{parseFloat(data.summary?.paidAmount || 0).toLocaleString('en-NG', { minimumFractionDigits: 2 })}\n            </CardTitle>\n          </CardHeader>\n        </Card>\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardDescription>Unpaid Amount</CardDescription>\n            <CardTitle className=\"text-xl text-red-600\">\n              ₦{parseFloat(data.summary?.unpaidAmount || 0).toLocaleString('en-NG', { minimumFractionDigits: 2 })}\n            </CardTitle>\n          </CardHeader>\n        </Card>\n      </div>\n\n      <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardDescription>Approved</CardDescription>\n            <CardTitle className=\"text-2xl text-green-600\">{data.summary?.approvedCount || 0}</CardTitle>\n          </CardHeader>\n        </Card>\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardDescription>Pending</CardDescription>\n            <CardTitle className=\"text-2xl text-yellow-600\">{data.summary?.pendingCount || 0}</CardTitle>\n          </CardHeader>\n        </Card>\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardDescription>Rejected</CardDescription>\n            <CardTitle className=\"text-2xl text-red-600\">{data.summary?.rejectedCount || 0}</CardTitle>\n          </CardHeader>\n        </Card>\n      </div>\n\n      <div className=\"flex justify-end\">\n        <Button onClick={handleExportCSV} variant=\"outline\" data-testid=\"button-export-csv\">\n          <Download className=\"h-4 w-4 mr-2\" />\n          Export to CSV\n        </Button>\n      </div>\n\n      {data.expenses && data.expenses.length > 0 && (\n        <Card>\n          <CardHeader>\n            <CardTitle>Expense Details</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <Table>\n              <TableHeader>\n                <TableRow>\n                  <TableHead>Date</TableHead>\n                  <TableHead>Vendor</TableHead>\n                  <TableHead>Description</TableHead>\n                  <TableHead>Category</TableHead>\n                  <TableHead className=\"text-right\">Amount</TableHead>\n                  <TableHead>Approved</TableHead>\n                  <TableHead>Payment Status</TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>\n                {data.expenses.map((expense: any, idx: number) => (\n                  <TableRow key={idx}>\n                    <TableCell>{expense.date}</TableCell>\n                    <TableCell>{expense.vendor}</TableCell>\n                    <TableCell className=\"max-w-xs truncate\">{expense.description}</TableCell>\n                    <TableCell>{expense.category}</TableCell>\n                    <TableCell className=\"text-right font-medium\">\n                      ₦{parseFloat(expense.amount).toLocaleString('en-NG', { minimumFractionDigits: 2 })}\n                    </TableCell>\n                    <TableCell>\n                      <Badge variant={\n                        expense.approved === \"Yes\" ? \"default\" :\n                        expense.approved === \"No\" ? \"destructive\" : \"secondary\"\n                      }>\n                        {expense.approved}\n                      </Badge>\n                    </TableCell>\n                    <TableCell>\n                      <Badge variant={\n                        expense.paymentStatus === \"paid\" ? \"default\" : \"secondary\"\n                      }>\n                        {expense.paymentStatus}\n                      </Badge>\n                    </TableCell>\n                  </TableRow>\n                ))}\n              </TableBody>\n            </Table>\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  );\n}\n\nfunction GenericReport({ data }: { data: any }) {\n  return (\n    <Card>\n      <CardHeader>\n        <CardTitle>Report Data</CardTitle>\n      </CardHeader>\n      <CardContent>\n        <pre className=\"bg-muted p-4 rounded-lg overflow-auto max-h-96\">\n          {JSON.stringify(data, null, 2)}\n        </pre>\n      </CardContent>\n    </Card>\n  );\n}\n","size_bytes":58327},"client/src/pages/invite-landing.tsx":{"content":"import { useEffect, useState } from \"react\";\nimport { useParams, useLocation } from \"wouter\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { AlertCircle, CheckCircle, UserPlus, LogIn } from \"lucide-react\";\nimport { Alert, AlertDescription, AlertTitle } from \"@/components/ui/alert\";\n\ninterface InviteData {\n  email: string;\n  role: string;\n  firstName?: string;\n  lastName?: string;\n  unitNumber?: string;\n}\n\nexport default function InviteLanding() {\n  const { token } = useParams<{ token: string }>();\n  const [, setLocation] = useLocation();\n  const [error, setError] = useState<string | null>(null);\n\n  const { data: inviteData, isLoading, error: queryError } = useQuery({\n    queryKey: [`/api/invite/${token}`],\n    enabled: !!token,\n    select: (data) => data as InviteData,\n  });\n\n  useEffect(() => {\n    if (queryError) {\n      setError(\"This invite link is invalid, expired, or has already been used.\");\n    }\n  }, [queryError]);\n\n  const handleSignIn = async () => {\n    try {\n      // Store invite token in session storage so it's available after auth redirect\n      if (token) {\n        // First, store the token in the session via API\n        const response = await fetch('/api/store-invite-token', {\n          method: 'POST',\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify({ inviteToken: token }),\n          credentials: 'include',\n        });\n\n        if (response.ok) {\n          // Redirect to Replit Auth login\n          window.location.href = '/api/login';\n        } else {\n          setError('Failed to process invite. Please try again.');\n        }\n      }\n    } catch (err) {\n      console.error('Error processing invite:', err);\n      setError('Failed to process invite. Please try again.');\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center bg-gradient-to-br from-primary/10 via-background to-accent/10\">\n        <Card className=\"w-full max-w-md\">\n          <CardContent className=\"p-8 text-center\">\n            <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto\" />\n            <p className=\"mt-4 text-muted-foreground\">Validating invite...</p>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  if (error || queryError) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center bg-gradient-to-br from-primary/10 via-background to-accent/10 p-4\">\n        <Card className=\"w-full max-w-md\">\n          <CardHeader>\n            <div className=\"flex items-center justify-center w-12 h-12 rounded-full bg-destructive/10 mx-auto mb-4\">\n              <AlertCircle className=\"w-6 h-6 text-destructive\" />\n            </div>\n            <CardTitle className=\"text-center\">Invalid Invite</CardTitle>\n            <CardDescription className=\"text-center\">\n              {error || \"This invite link is invalid, expired, or has already been used.\"}\n            </CardDescription>\n          </CardHeader>\n          <CardContent>\n            <Button\n              className=\"w-full\"\n              onClick={() => setLocation('/')}\n              data-testid=\"button-back-home\"\n            >\n              Return to Home\n            </Button>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  if (!inviteData) {\n    return null;\n  }\n\n  const getRoleName = (role: string) => {\n    switch (role) {\n      case 'admin':\n        return 'Administrator';\n      case 'resident':\n        return 'Resident';\n      case 'security':\n        return 'Security Personnel';\n      case 'accountant':\n        return 'Accountant';\n      default:\n        return role;\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen flex items-center justify-center bg-gradient-to-br from-primary/10 via-background to-accent/10 p-4\">\n      <Card className=\"w-full max-w-md\">\n        <CardHeader>\n          <div className=\"flex items-center justify-center w-12 h-12 rounded-full bg-primary/10 mx-auto mb-4\">\n            <UserPlus className=\"w-6 h-6 text-primary\" />\n          </div>\n          <CardTitle className=\"text-center text-2xl\" data-testid=\"heading-invite-title\">\n            Welcome to Magodo Estate\n          </CardTitle>\n          <CardDescription className=\"text-center\">\n            You've been invited to join the estate management system\n          </CardDescription>\n        </CardHeader>\n        <CardContent className=\"space-y-6\">\n          <Alert>\n            <CheckCircle className=\"h-4 w-4\" />\n            <AlertTitle>Invite Details</AlertTitle>\n            <AlertDescription>\n              <div className=\"mt-2 space-y-2\">\n                <div className=\"flex justify-between items-center\">\n                  <span className=\"text-sm text-muted-foreground\">Email:</span>\n                  <span className=\"text-sm font-medium\" data-testid=\"text-invite-email\">\n                    {inviteData.email}\n                  </span>\n                </div>\n                <div className=\"flex justify-between items-center\">\n                  <span className=\"text-sm text-muted-foreground\">Role:</span>\n                  <Badge variant=\"secondary\" data-testid=\"badge-invite-role\">\n                    {getRoleName(inviteData.role)}\n                  </Badge>\n                </div>\n                {inviteData.firstName && inviteData.lastName && (\n                  <div className=\"flex justify-between items-center\">\n                    <span className=\"text-sm text-muted-foreground\">Name:</span>\n                    <span className=\"text-sm font-medium\" data-testid=\"text-invite-name\">\n                      {inviteData.firstName} {inviteData.lastName}\n                    </span>\n                  </div>\n                )}\n                {inviteData.unitNumber && (\n                  <div className=\"flex justify-between items-center\">\n                    <span className=\"text-sm text-muted-foreground\">Unit:</span>\n                    <span className=\"text-sm font-medium\" data-testid=\"text-invite-unit\">\n                      {inviteData.unitNumber}\n                    </span>\n                  </div>\n                )}\n              </div>\n            </AlertDescription>\n          </Alert>\n\n          <Alert className=\"border-primary/50 bg-primary/5\">\n            <LogIn className=\"h-4 w-4 text-primary\" />\n            <AlertTitle className=\"text-primary\">Sign-In Instructions</AlertTitle>\n            <AlertDescription className=\"text-sm space-y-2\">\n              <p className=\"font-semibold\">This system uses Replit Auth (OAuth)</p>\n              <p>NOT traditional username/password login</p>\n              \n              <div className=\"mt-3 space-y-2\">\n                <p><strong>Step 1:</strong> Click the button below</p>\n                <p><strong>Step 2:</strong> Sign in with ONE of these:</p>\n                <ul className=\"list-disc list-inside pl-2 space-y-1\">\n                  <li>Google (if your email is a Google account)</li>\n                  <li>GitHub</li>\n                  <li>Email (magic link)</li>\n                </ul>\n                <p className=\"pt-2 text-primary font-semibold\">\n                  IMPORTANT: You MUST use an account with email: {inviteData.email}\n                </p>\n                <p className=\"text-xs\">\n                  Don't have a Replit account with this email? Create one at replit.com first\n                </p>\n              </div>\n            </AlertDescription>\n          </Alert>\n\n          <div className=\"space-y-3\">\n            <Button\n              className=\"w-full\"\n              size=\"lg\"\n              onClick={handleSignIn}\n              data-testid=\"button-accept-invite\"\n            >\n              <LogIn className=\"w-4 h-4 mr-2\" />\n              Continue to Replit Sign-In\n            </Button>\n            \n            <p className=\"text-xs text-center text-muted-foreground\">\n              After signing in, you'll receive <strong>{getRoleName(inviteData.role)}</strong> access\n            </p>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":8252},"client/src/pages/admin/user-management.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from \"@/components/ui/dialog\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Alert, AlertDescription, AlertTitle } from \"@/components/ui/alert\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { UserPlus, Copy, CheckCircle2, XCircle, Clock, LogIn, AlertCircle, Edit, UserX, UserCheck } from \"lucide-react\";\nimport { format } from \"date-fns\";\n\ninterface UserInvite {\n  id: string;\n  inviteToken: string;\n  email: string;\n  role: string;\n  firstName?: string;\n  lastName?: string;\n  unitNumber?: string;\n  status: \"pending\" | \"accepted\" | \"expired\";\n  expiresAt: string;\n  acceptedAt?: string;\n  createdAt: string;\n}\n\ninterface User {\n  id: string;\n  email: string | null;\n  firstName: string | null;\n  lastName: string | null;\n  role: string;\n  isActive: boolean;\n  createdAt: string | null;\n  updatedAt: string | null;\n}\n\nexport default function UserManagement() {\n  const { toast } = useToast();\n  const [isDialogOpen, setIsDialogOpen] = useState(false);\n  const [isEditDialogOpen, setIsEditDialogOpen] = useState(false);\n  const [copiedToken, setCopiedToken] = useState<string | null>(null);\n  const [showInstructionsDialog, setShowInstructionsDialog] = useState(false);\n  const [inviteInstructions, setInviteInstructions] = useState<{\n    email: string;\n    role: string;\n    inviteLink: string;\n  } | null>(null);\n  const [selectedUser, setSelectedUser] = useState<User | null>(null);\n  \n  // Invite form state\n  const [email, setEmail] = useState(\"\");\n  const [role, setRole] = useState<string>(\"\");\n  const [firstName, setFirstName] = useState(\"\");\n  const [lastName, setLastName] = useState(\"\");\n  const [unitNumber, setUnitNumber] = useState(\"\");\n\n  // Edit user form state\n  const [editFirstName, setEditFirstName] = useState(\"\");\n  const [editLastName, setEditLastName] = useState(\"\");\n  const [editRole, setEditRole] = useState<string>(\"\");\n\n  const { data: invites = [], isLoading } = useQuery({\n    queryKey: ['/api/admin/user-invites'],\n    select: (data) => data as UserInvite[],\n  });\n\n  const createInviteMutation = useMutation({\n    mutationFn: async (data: any) => {\n      const response = await apiRequest('POST', '/api/admin/user-invites', data);\n      return await response.json();\n    },\n    onSuccess: (response: { success: boolean; invite: UserInvite; inviteLink: string }) => {\n      queryClient.invalidateQueries({ queryKey: ['/api/admin/user-invites'] });\n      \n      // Show instructions dialog\n      setInviteInstructions({\n        email: email,\n        role: role,\n        inviteLink: response.inviteLink,\n      });\n      setShowInstructionsDialog(true);\n      \n      // Reset form\n      setEmail(\"\");\n      setRole(\"\");\n      setFirstName(\"\");\n      setLastName(\"\");\n      setUnitNumber(\"\");\n      setIsDialogOpen(false);\n    },\n    onError: (error: any) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: error.message || \"Failed to create invite\",\n      });\n    },\n  });\n\n  const deleteInviteMutation = useMutation({\n    mutationFn: async (id: string) => {\n      const response = await apiRequest('DELETE', `/api/admin/user-invites/${id}`);\n      return await response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/admin/user-invites'] });\n      toast({\n        title: \"Invite Expired\",\n        description: \"The invite has been expired successfully.\",\n      });\n    },\n  });\n\n  const { data: users = [], isLoading: isLoadingUsers } = useQuery({\n    queryKey: ['/api/admin/users'],\n    select: (data) => data as User[],\n  });\n\n  const updateUserMutation = useMutation({\n    mutationFn: async (data: { id: string; firstName?: string; lastName?: string; role?: string }) => {\n      const { id, ...updateData } = data;\n      const response = await apiRequest('PATCH', `/api/admin/users/${id}`, updateData);\n      return await response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/admin/users'] });\n      toast({\n        title: \"User Updated\",\n        description: \"User has been updated successfully.\",\n      });\n      setIsEditDialogOpen(false);\n      setSelectedUser(null);\n    },\n    onError: (error: any) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: error.message || \"Failed to update user\",\n      });\n    },\n  });\n\n  const toggleUserActiveMutation = useMutation({\n    mutationFn: async (data: { id: string; isActive: boolean }) => {\n      const response = await apiRequest('PATCH', `/api/admin/users/${data.id}/deactivate`, { isActive: data.isActive });\n      return await response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/admin/users'] });\n      toast({\n        title: \"User Status Updated\",\n        description: \"User status has been updated successfully.\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Error\",\n        description: error.message || \"Failed to update user status\",\n      });\n    },\n  });\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    if (!email || !role) {\n      toast({\n        variant: \"destructive\",\n        title: \"Validation Error\",\n        description: \"Email and role are required.\",\n      });\n      return;\n    }\n\n    if (role === 'resident' && !unitNumber) {\n      toast({\n        variant: \"destructive\",\n        title: \"Validation Error\",\n        description: \"Unit number is required for resident invites.\",\n      });\n      return;\n    }\n\n    createInviteMutation.mutate({\n      email,\n      role,\n      firstName: firstName || undefined,\n      lastName: lastName || undefined,\n      unitNumber: role === 'resident' ? unitNumber : undefined,\n    });\n  };\n\n  const copyInviteLink = (invite: UserInvite) => {\n    const inviteLink = `${window.location.origin}/invite/${invite.inviteToken}`;\n    navigator.clipboard.writeText(inviteLink);\n    setCopiedToken(invite.inviteToken);\n    \n    toast({\n      title: \"Copied\",\n      description: \"Invite link copied to clipboard\",\n    });\n\n    setTimeout(() => setCopiedToken(null), 2000);\n  };\n\n  const getStatusBadge = (status: string) => {\n    switch (status) {\n      case \"pending\":\n        return <Badge className=\"bg-yellow-500\"><Clock className=\"w-3 h-3 mr-1\" />Pending</Badge>;\n      case \"accepted\":\n        return <Badge className=\"bg-green-500\"><CheckCircle2 className=\"w-3 h-3 mr-1\" />Accepted</Badge>;\n      case \"expired\":\n        return <Badge variant=\"destructive\"><XCircle className=\"w-3 h-3 mr-1\" />Expired</Badge>;\n      default:\n        return <Badge>{status}</Badge>;\n    }\n  };\n\n  const handleEditUser = (user: User) => {\n    setSelectedUser(user);\n    setEditFirstName(user.firstName || \"\");\n    setEditLastName(user.lastName || \"\");\n    setEditRole(user.role);\n    setIsEditDialogOpen(true);\n  };\n\n  const handleUpdateUser = (e: React.FormEvent) => {\n    e.preventDefault();\n    if (!selectedUser) return;\n\n    updateUserMutation.mutate({\n      id: selectedUser.id,\n      firstName: editFirstName || undefined,\n      lastName: editLastName || undefined,\n      role: editRole as any,\n    });\n  };\n\n  const handleToggleUserActive = (user: User) => {\n    toggleUserActiveMutation.mutate({\n      id: user.id,\n      isActive: !user.isActive,\n    });\n  };\n\n  const getRoleName = (role: string) => {\n    switch (role) {\n      case 'admin':\n        return 'Administrator';\n      case 'resident':\n        return 'Resident';\n      case 'security':\n        return 'Security Personnel';\n      case 'accountant':\n        return 'Accountant';\n      default:\n        return role;\n    }\n  };\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-bold\" data-testid=\"heading-user-management\">User Management</h1>\n          <p className=\"text-muted-foreground\">Create and manage user invites</p>\n        </div>\n\n        <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>\n          <DialogTrigger asChild>\n            <Button data-testid=\"button-create-invite\">\n              <UserPlus className=\"w-4 h-4 mr-2\" />\n              Create Invite\n            </Button>\n          </DialogTrigger>\n          <DialogContent className=\"max-w-md\">\n            <DialogHeader>\n              <DialogTitle>Create User Invite</DialogTitle>\n              <DialogDescription>\n                Generate an invite link for a new user. They'll receive the specified role after signing in.\n              </DialogDescription>\n            </DialogHeader>\n\n            <form onSubmit={handleSubmit} className=\"space-y-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"email\">Email Address *</Label>\n                <Input\n                  id=\"email\"\n                  type=\"email\"\n                  value={email}\n                  onChange={(e) => setEmail(e.target.value)}\n                  placeholder=\"user@example.com\"\n                  required\n                  data-testid=\"input-email\"\n                />\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"role\">Role *</Label>\n                <Select value={role} onValueChange={setRole} required>\n                  <SelectTrigger data-testid=\"select-role\">\n                    <SelectValue placeholder=\"Select role\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"resident\">Resident</SelectItem>\n                    <SelectItem value=\"admin\">Admin</SelectItem>\n                    <SelectItem value=\"security\">Security</SelectItem>\n                    <SelectItem value=\"accountant\">Accountant</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"firstName\">First Name</Label>\n                  <Input\n                    id=\"firstName\"\n                    value={firstName}\n                    onChange={(e) => setFirstName(e.target.value)}\n                    placeholder=\"John\"\n                    data-testid=\"input-first-name\"\n                  />\n                </div>\n\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"lastName\">Last Name</Label>\n                  <Input\n                    id=\"lastName\"\n                    value={lastName}\n                    onChange={(e) => setLastName(e.target.value)}\n                    placeholder=\"Doe\"\n                    data-testid=\"input-last-name\"\n                  />\n                </div>\n              </div>\n\n              {role === 'resident' && (\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"unitNumber\">Unit Number *</Label>\n                  <Input\n                    id=\"unitNumber\"\n                    value={unitNumber}\n                    onChange={(e) => setUnitNumber(e.target.value)}\n                    placeholder=\"A-101\"\n                    required\n                    data-testid=\"input-unit-number\"\n                  />\n                </div>\n              )}\n\n              <div className=\"flex justify-end gap-2 pt-4\">\n                <Button\n                  type=\"button\"\n                  variant=\"outline\"\n                  onClick={() => setIsDialogOpen(false)}\n                  data-testid=\"button-cancel\"\n                >\n                  Cancel\n                </Button>\n                <Button\n                  type=\"submit\"\n                  disabled={createInviteMutation.isPending}\n                  data-testid=\"button-submit-invite\"\n                >\n                  {createInviteMutation.isPending ? \"Creating...\" : \"Create Invite\"}\n                </Button>\n              </div>\n            </form>\n          </DialogContent>\n        </Dialog>\n\n        {/* Sign-in Instructions Dialog */}\n        <Dialog open={showInstructionsDialog} onOpenChange={setShowInstructionsDialog}>\n          <DialogContent className=\"max-w-2xl max-h-[80vh] overflow-y-auto\">\n            <DialogHeader>\n              <DialogTitle className=\"flex items-center gap-2\">\n                <CheckCircle2 className=\"w-5 h-5 text-green-500\" />\n                Invite Created Successfully\n              </DialogTitle>\n              <DialogDescription>\n                Share these instructions with the invited user\n              </DialogDescription>\n            </DialogHeader>\n\n            {inviteInstructions && (\n              <div className=\"space-y-4\">\n                <Alert>\n                  <LogIn className=\"h-4 w-4\" />\n                  <AlertTitle>Important: Replit Auth Sign-In Required</AlertTitle>\n                  <AlertDescription>\n                    This system uses Replit Auth (OAuth), NOT traditional username/password login.\n                  </AlertDescription>\n                </Alert>\n\n                <div className=\"space-y-3 p-4 bg-muted rounded-lg\">\n                  <h3 className=\"font-semibold\">Sign-In Instructions for {inviteInstructions.email}</h3>\n                  \n                  <div className=\"space-y-2 text-sm\">\n                    <p><strong>Step 1:</strong> Click the invite link below</p>\n                    <div className=\"p-3 bg-background rounded border break-all\">\n                      <code className=\"text-xs\">{inviteInstructions.inviteLink}</code>\n                    </div>\n\n                    <p><strong>Step 2:</strong> On the invite page, click \"Continue to Replit Sign-In\"</p>\n                    \n                    <p><strong>Step 3:</strong> You'll be redirected to Replit's secure login page</p>\n                    \n                    <p><strong>Step 4:</strong> Sign in using ONE of these methods:</p>\n                    <ul className=\"list-disc list-inside pl-4 space-y-1\">\n                      <li>Click \"Continue with Google\" if your email is a Google account</li>\n                      <li>Click \"Continue with GitHub\" if you have a GitHub account</li>\n                      <li>Or use the \"Email\" option to receive a magic link</li>\n                    </ul>\n\n                    <Alert className=\"mt-3\">\n                      <AlertCircle className=\"h-4 w-4\" />\n                      <AlertTitle>Critical: Email Must Match</AlertTitle>\n                      <AlertDescription>\n                        You MUST sign in with an account that uses the email: <strong>{inviteInstructions.email}</strong>\n                        <br />\n                        If you don't have a Replit account with this email, create one first at replit.com\n                      </AlertDescription>\n                    </Alert>\n\n                    <p className=\"pt-2\"><strong>Step 5:</strong> After signing in, you'll be automatically assigned the <Badge variant=\"outline\">{inviteInstructions.role}</Badge> role and redirected to your dashboard</p>\n                  </div>\n                </div>\n\n                <div className=\"flex gap-2\">\n                  <Button\n                    onClick={() => {\n                      const instructions = `\nInvitation to Magodo Estate Management System\n\nRole: ${inviteInstructions.role.toUpperCase()}\nEmail: ${inviteInstructions.email}\n\nSIGN-IN INSTRUCTIONS:\n\nThis system uses Replit Auth (OAuth) - NOT username/password login.\n\n1. Click this invite link:\n${inviteInstructions.inviteLink}\n\n2. On the invite page, click \"Continue to Replit Sign-In\"\n\n3. You'll be redirected to Replit's login page\n\n4. Sign in using ONE of these methods:\n   • Continue with Google (if ${inviteInstructions.email} is a Google account)\n   • Continue with GitHub (if you have a GitHub account)\n   • Email (to receive a magic link)\n\nIMPORTANT: You MUST sign in with an account that uses ${inviteInstructions.email}\n\nIf you don't have a Replit account with this email, create one at replit.com first.\n\n5. After signing in, you'll automatically receive ${inviteInstructions.role} access\n\nQuestions? Contact your administrator.\n                      `.trim();\n                      \n                      navigator.clipboard.writeText(instructions);\n                      toast({\n                        title: \"Instructions Copied\",\n                        description: \"Full sign-in instructions copied to clipboard\",\n                      });\n                    }}\n                    className=\"flex-1\"\n                    data-testid=\"button-copy-instructions\"\n                  >\n                    <Copy className=\"w-4 h-4 mr-2\" />\n                    Copy All Instructions\n                  </Button>\n                  \n                  <Button\n                    onClick={() => {\n                      navigator.clipboard.writeText(inviteInstructions.inviteLink);\n                      toast({\n                        title: \"Link Copied\",\n                        description: \"Invite link copied to clipboard\",\n                      });\n                    }}\n                    variant=\"outline\"\n                    data-testid=\"button-copy-link-only\"\n                  >\n                    <Copy className=\"w-4 h-4 mr-2\" />\n                    Copy Link Only\n                  </Button>\n\n                  <Button\n                    onClick={() => setShowInstructionsDialog(false)}\n                    variant=\"outline\"\n                    data-testid=\"button-close-instructions\"\n                  >\n                    Close\n                  </Button>\n                </div>\n              </div>\n            )}\n          </DialogContent>\n        </Dialog>\n      </div>\n\n      <Tabs defaultValue=\"invites\" className=\"w-full\">\n        <TabsList>\n          <TabsTrigger value=\"invites\" data-testid=\"tab-invites\">User Invites</TabsTrigger>\n          <TabsTrigger value=\"users\" data-testid=\"tab-users\">All Users</TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"invites\">\n          <Card>\n            <CardHeader>\n              <CardTitle>User Invites</CardTitle>\n            </CardHeader>\n            <CardContent>\n              {isLoading ? (\n                <div className=\"text-center py-8 text-muted-foreground\">Loading invites...</div>\n              ) : invites.length === 0 ? (\n                <div className=\"text-center py-8 text-muted-foreground\">\n                  No invites created yet. Click \"Create Invite\" to get started.\n                </div>\n              ) : (\n                <Table>\n              <TableHeader>\n                <TableRow>\n                  <TableHead>Email</TableHead>\n                  <TableHead>Role</TableHead>\n                  <TableHead>Name</TableHead>\n                  <TableHead>Unit</TableHead>\n                  <TableHead>Status</TableHead>\n                  <TableHead>Expires</TableHead>\n                  <TableHead>Actions</TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>\n                {invites.map((invite) => (\n                  <TableRow key={invite.id} data-testid={`row-invite-${invite.id}`}>\n                    <TableCell className=\"font-medium\">{invite.email}</TableCell>\n                    <TableCell>\n                      <Badge variant=\"outline\">{invite.role}</Badge>\n                    </TableCell>\n                    <TableCell>\n                      {invite.firstName || invite.lastName\n                        ? `${invite.firstName || \"\"} ${invite.lastName || \"\"}`.trim()\n                        : \"-\"}\n                    </TableCell>\n                    <TableCell>{invite.unitNumber || \"-\"}</TableCell>\n                    <TableCell>{getStatusBadge(invite.status)}</TableCell>\n                    <TableCell className=\"text-sm\">\n                      {invite.status === \"accepted\" && invite.acceptedAt\n                        ? `Accepted ${format(new Date(invite.acceptedAt), \"MMM d, yyyy\")}`\n                        : format(new Date(invite.expiresAt), \"MMM d, yyyy\")}\n                    </TableCell>\n                    <TableCell>\n                      <div className=\"flex gap-2\">\n                        {invite.status === \"pending\" && (\n                          <>\n                            <Button\n                              size=\"sm\"\n                              variant=\"outline\"\n                              onClick={() => copyInviteLink(invite)}\n                              data-testid={`button-copy-${invite.id}`}\n                            >\n                              {copiedToken === invite.inviteToken ? (\n                                <CheckCircle2 className=\"w-4 h-4\" />\n                              ) : (\n                                <Copy className=\"w-4 h-4\" />\n                              )}\n                            </Button>\n                            <Button\n                              size=\"sm\"\n                              variant=\"outline\"\n                              onClick={() => deleteInviteMutation.mutate(invite.id)}\n                              data-testid={`button-expire-${invite.id}`}\n                            >\n                              Expire\n                            </Button>\n                          </>\n                        )}\n                      </div>\n                    </TableCell>\n                  </TableRow>\n                ))}\n              </TableBody>\n            </Table>\n          )}\n        </CardContent>\n      </Card>\n        </TabsContent>\n\n        <TabsContent value=\"users\">\n          <Card>\n            <CardHeader>\n              <CardTitle>All Users</CardTitle>\n            </CardHeader>\n            <CardContent>\n              {isLoadingUsers ? (\n                <div className=\"text-center py-8 text-muted-foreground\">Loading users...</div>\n              ) : users.length === 0 ? (\n                <div className=\"text-center py-8 text-muted-foreground\">\n                  No users found.\n                </div>\n              ) : (\n                <Table>\n                  <TableHeader>\n                    <TableRow>\n                      <TableHead>Email</TableHead>\n                      <TableHead>Name</TableHead>\n                      <TableHead>Role</TableHead>\n                      <TableHead>Status</TableHead>\n                      <TableHead>Created</TableHead>\n                      <TableHead>Actions</TableHead>\n                    </TableRow>\n                  </TableHeader>\n                  <TableBody>\n                    {users.map((user) => (\n                      <TableRow key={user.id} data-testid={`row-user-${user.id}`}>\n                        <TableCell className=\"font-medium\">{user.email || \"-\"}</TableCell>\n                        <TableCell>\n                          {user.firstName || user.lastName\n                            ? `${user.firstName || \"\"} ${user.lastName || \"\"}`.trim()\n                            : \"-\"}\n                        </TableCell>\n                        <TableCell>\n                          <Badge variant=\"outline\">{getRoleName(user.role)}</Badge>\n                        </TableCell>\n                        <TableCell>\n                          {user.isActive ? (\n                            <Badge className=\"bg-green-500\">\n                              <UserCheck className=\"w-3 h-3 mr-1\" />\n                              Active\n                            </Badge>\n                          ) : (\n                            <Badge variant=\"destructive\">\n                              <UserX className=\"w-3 h-3 mr-1\" />\n                              Inactive\n                            </Badge>\n                          )}\n                        </TableCell>\n                        <TableCell className=\"text-sm\">\n                          {user.createdAt ? format(new Date(user.createdAt), \"MMM d, yyyy\") : \"-\"}\n                        </TableCell>\n                        <TableCell>\n                          <div className=\"flex gap-2\">\n                            <Button\n                              size=\"sm\"\n                              variant=\"outline\"\n                              onClick={() => handleEditUser(user)}\n                              data-testid={`button-edit-${user.id}`}\n                            >\n                              <Edit className=\"w-4 h-4 mr-1\" />\n                              Edit\n                            </Button>\n                            <Button\n                              size=\"sm\"\n                              variant={user.isActive ? \"destructive\" : \"default\"}\n                              onClick={() => handleToggleUserActive(user)}\n                              disabled={toggleUserActiveMutation.isPending}\n                              data-testid={`button-toggle-active-${user.id}`}\n                            >\n                              {user.isActive ? (\n                                <>\n                                  <UserX className=\"w-4 h-4 mr-1\" />\n                                  Deactivate\n                                </>\n                              ) : (\n                                <>\n                                  <UserCheck className=\"w-4 h-4 mr-1\" />\n                                  Activate\n                                </>\n                              )}\n                            </Button>\n                          </div>\n                        </TableCell>\n                      </TableRow>\n                    ))}\n                  </TableBody>\n                </Table>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n      </Tabs>\n\n      {/* Edit User Dialog */}\n      <Dialog open={isEditDialogOpen} onOpenChange={setIsEditDialogOpen}>\n        <DialogContent className=\"max-w-md\">\n          <DialogHeader>\n            <DialogTitle>Edit User</DialogTitle>\n            <DialogDescription>\n              Update user information and role\n            </DialogDescription>\n          </DialogHeader>\n\n          <form onSubmit={handleUpdateUser} className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"editEmail\">Email</Label>\n              <Input\n                id=\"editEmail\"\n                type=\"email\"\n                value={selectedUser?.email || \"\"}\n                disabled\n                className=\"bg-muted\"\n              />\n              <p className=\"text-xs text-muted-foreground\">Email cannot be changed</p>\n            </div>\n\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"editFirstName\">First Name</Label>\n                <Input\n                  id=\"editFirstName\"\n                  value={editFirstName}\n                  onChange={(e) => setEditFirstName(e.target.value)}\n                  placeholder=\"John\"\n                  data-testid=\"input-edit-first-name\"\n                />\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"editLastName\">Last Name</Label>\n                <Input\n                  id=\"editLastName\"\n                  value={editLastName}\n                  onChange={(e) => setEditLastName(e.target.value)}\n                  placeholder=\"Doe\"\n                  data-testid=\"input-edit-last-name\"\n                />\n              </div>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"editRole\">Role</Label>\n              <Select value={editRole} onValueChange={setEditRole}>\n                <SelectTrigger data-testid=\"select-edit-role\">\n                  <SelectValue placeholder=\"Select role\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"resident\">Resident</SelectItem>\n                  <SelectItem value=\"admin\">Admin</SelectItem>\n                  <SelectItem value=\"security\">Security</SelectItem>\n                  <SelectItem value=\"accountant\">Accountant</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"flex justify-end gap-2 pt-4\">\n              <Button\n                type=\"button\"\n                variant=\"outline\"\n                onClick={() => setIsEditDialogOpen(false)}\n                data-testid=\"button-cancel-edit\"\n              >\n                Cancel\n              </Button>\n              <Button\n                type=\"submit\"\n                disabled={updateUserMutation.isPending}\n                data-testid=\"button-submit-edit\"\n              >\n                {updateUserMutation.isPending ? \"Updating...\" : \"Update User\"}\n              </Button>\n            </div>\n          </form>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","size_bytes":29506},"client/src/components/ProtectedRoute.tsx":{"content":"import { useAuth } from \"@/hooks/useAuth\";\nimport { useLocation } from \"wouter\";\nimport { useEffect } from \"react\";\n\ninterface ProtectedRouteProps {\n  children: React.ReactNode;\n  allowedRoles: string[];\n  redirectTo?: string;\n}\n\nexport function ProtectedRoute({ children, allowedRoles, redirectTo = \"/\" }: ProtectedRouteProps) {\n  const { user, isLoading } = useAuth();\n  const [, setLocation] = useLocation();\n\n  useEffect(() => {\n    if (!isLoading && user) {\n      // Check if user's role is allowed\n      if (!user.role || !allowedRoles.includes(user.role)) {\n        console.warn(`Access denied: User role '${user.role}' not in allowed roles:`, allowedRoles);\n        setLocation(redirectTo);\n      }\n    }\n  }, [user, isLoading, allowedRoles, redirectTo, setLocation]);\n\n  // Show loading state while checking authentication\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center min-h-screen\">\n        <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-primary\" />\n      </div>\n    );\n  }\n\n  // If user doesn't have the required role, don't render anything\n  // (useEffect will handle redirect)\n  if (!user || !user.role || !allowedRoles.includes(user.role)) {\n    return null;\n  }\n\n  return <>{children}</>;\n}\n","size_bytes":1270},"server/migrate-chart-of-accounts.ts":{"content":"/**\n * Chart of Accounts Migration Script\n * This script updates the Chart of Accounts to the new Modified Cash-Based structure\n * for Magodo Residents Association - South East Zone\n * \n * Run this with: npx tsx server/migrate-chart-of-accounts.ts\n */\n\nimport { neon } from '@neondatabase/serverless';\nimport * as fs from 'fs';\nimport * as path from 'path';\nimport { fileURLToPath } from 'url';\n\nconst __filename = fileURLToPath(import.meta.url);\nconst __dirname = path.dirname(__filename);\n\nconst databaseUrl = process.env.DATABASE_URL;\n\nif (!databaseUrl) {\n  console.error('❌ DATABASE_URL environment variable is not set');\n  process.exit(1);\n}\n\nasync function migrateChartOfAccounts() {\n  console.log('🚀 Starting Chart of Accounts Migration...\\n');\n  \n  const sql = neon(databaseUrl!);\n  \n  try {\n    // Read the SQL migration file\n    const sqlFilePath = path.join(__dirname, 'seed-new-chart-complete.sql');\n    const migrationSQL = fs.readFileSync(sqlFilePath, 'utf-8');\n    \n    // Remove comment-only lines first\n    const cleanedSQL = migrationSQL\n      .split('\\n')\n      .filter(line => !line.trim().startsWith('--') || line.trim().length === 0)\n      .join('\\n');\n    \n    // Split the SQL into individual statements (split by semicolon)\n    const statements = cleanedSQL\n      .split(';')\n      .map(stmt => stmt.trim())\n      .filter(stmt => stmt.length > 0);\n    \n    console.log(`📝 Found ${statements.length} SQL statements to execute\\n`);\n    \n    // Execute each statement\n    let successCount = 0;\n    let skipCount = 0;\n    \n    for (const statement of statements) {\n      // Skip comment-only lines\n      if (statement.trim().startsWith('--')) {\n        continue;\n      }\n      \n      try {\n        // Execute the statement\n        await sql(statement);\n        \n        // Count inserts for reporting\n        if (statement.toUpperCase().includes('INSERT INTO')) {\n          successCount++;\n        }\n        \n      } catch (error: any) {\n        // Handle duplicate key errors gracefully (account already exists)\n        if (error.message?.includes('duplicate key') || error.message?.includes('already exists')) {\n          skipCount++;\n          continue;\n        } else {\n          console.error(`❌ Error executing statement:`, statement.substring(0, 100) + '...');\n          console.error(`Error: ${error.message}\\n`);\n          throw error;\n        }\n      }\n    }\n    \n    console.log('✅ Migration completed successfully!\\n');\n    console.log(`📊 Summary:`);\n    console.log(`   - New accounts created: ${successCount}`);\n    console.log(`   - Accounts skipped (already exist): ${skipCount}`);\n    console.log(`\\n💡 Note: Old accounts have been deactivated to preserve historical data`);\n    console.log(`   You can view them in the Chart of Accounts page (they will be marked as inactive)\\n`);\n    \n  } catch (error: any) {\n    console.error('❌ Migration failed:', error.message);\n    process.exit(1);\n  }\n}\n\n// Run the migration\nmigrateChartOfAccounts()\n  .then(() => {\n    console.log('✨ Migration script finished');\n    process.exit(0);\n  })\n  .catch((error) => {\n    console.error('💥 Fatal error:', error);\n    process.exit(1);\n  });\n","size_bytes":3188},"client/src/lib/csv-export.ts":{"content":"/**\n * CSV Export Utilities\n * Provides functions to convert various data structures to CSV format\n */\n\n/**\n * Converts an array of objects to CSV string\n */\nexport function convertToCSV(data: Record<string, any>[], headers?: string[]): string {\n  if (!data || data.length === 0) {\n    return '';\n  }\n\n  // Extract headers from first object if not provided\n  const csvHeaders = headers || Object.keys(data[0]);\n\n  // Create header row\n  const headerRow = csvHeaders.map(escapeCSVValue).join(',');\n\n  // Create data rows\n  const dataRows = data.map(row => {\n    return csvHeaders.map(header => {\n      const value = row[header];\n      return escapeCSVValue(value);\n    }).join(',');\n  });\n\n  return [headerRow, ...dataRows].join('\\n');\n}\n\n/**\n * Escapes a value for CSV format\n */\nfunction escapeCSVValue(value: any): string {\n  if (value === null || value === undefined) {\n    return '';\n  }\n\n  const stringValue = String(value);\n\n  // If the value contains comma, newline, or quote, wrap it in quotes\n  if (stringValue.includes(',') || stringValue.includes('\\n') || stringValue.includes('\"')) {\n    // Escape quotes by doubling them\n    return `\"${stringValue.replace(/\"/g, '\"\"')}\"`;\n  }\n\n  return stringValue;\n}\n\n/**\n * Downloads a CSV file\n */\nexport function downloadCSV(csvContent: string, filename: string): void {\n  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });\n  const url = URL.createObjectURL(blob);\n  const link = document.createElement('a');\n  link.href = url;\n  link.download = filename;\n  document.body.appendChild(link);\n  link.click();\n  document.body.removeChild(link);\n  URL.revokeObjectURL(url);\n}\n\n/**\n * Format currency amount for CSV (removes currency symbol)\n * Safely handles both number and string inputs\n */\nexport function formatCurrencyForCSV(amount: number | string | null | undefined): string {\n  if (amount === null || amount === undefined) {\n    return '0.00';\n  }\n  \n  const numericAmount = Number(amount);\n  \n  if (isNaN(numericAmount)) {\n    return '0.00';\n  }\n  \n  return numericAmount.toFixed(2);\n}\n\n/**\n * Format date for CSV\n */\nexport function formatDateForCSV(date: string | Date): string {\n  if (!date) return '';\n  const d = new Date(date);\n  return d.toISOString().split('T')[0]; // YYYY-MM-DD format\n}\n","size_bytes":2275}},"version":2}